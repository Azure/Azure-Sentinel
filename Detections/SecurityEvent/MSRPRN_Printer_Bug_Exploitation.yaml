id: c29a03c6-d074-4934-afae-df1aeb30da70
name: Potential Exploitation of MS-RPRN printer bug
description: |
  'This query detects potential attempts to remotely access to the print spooler service on Active Directory Domain Controllers which could indicate an exploitation of MS-RPRN printer bug from a server that is configured with unconstrained delegation.
   This query searches for the event id 5145 on Domain Controllers where the ShareName is "\\\*\IPC$" and the RelativeTargetName is "spoolss".'
severity: High
requiredDataConnectors:
  - connectorId: SecurityEvents
    dataTypes:
      - SecurityEvent
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - PrivilegeEscalation
relevantTechniques:
  - T1134
query: |
 // Enter a reference list of hostnames for your DC servers
 // let DCServersList = dynamic (["DC01.domain.local","DC02.domain.com"]);
 // Enter a reference list of IP addresses for your unconstrained delegation servers
 // let UnconstrainedServersIPList = dynamic (["10.1.0.7","10.1.0.45"]);
 SecurityEvent
 // | where Computer in (DCServersList)
 // | where IpAddress  in (UnconstrainedServersIPList)
 | where EventID == 5145 and ShareName == "\\\\*\\IPC$" and RelativeTargetName == "spoolss"
 | project TimeGenerated, Computer, SubjectUserName, IpAddress, IpPort, ShareName, RelativeTargetName
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: SubjectUserName
  - entityType: Host
    fieldMappings:
      - identifier: FullName
        columnName: Computer
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: IpAddress
version: 1.0.0
kind: Scheduled
