id: 0558155e-4556-447e-9a22-828f2a7de06b
name: Malware attachment delivered
description: |
  'Creates an incident in the event a message containing a malware attachment was delivered.'
severity: Medium
requiredDataConnectors:
  - connectorId: ProofpointTAP
    dataTypes: 
      - ProofpointTAPMessagesDelivered_CL
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitalAccess
relevantTechniques:
  - T1193
query: |

  let timeframe = ago(1h);
  ProofPointTAPMessagesDelivered_CL
  | where TimeGenerated >= timeframe
  | mv-expand todynamic(threatsInfoMap_s)
  | mv-expand todynamic(messageParts_s)
  | extend threatType = tostring(threatsInfoMap_s.threatType), classification = tostring(threatsInfoMap_s.classification)
  | extend filename = tostring(messageParts_s.filename)
  | where threatType =~ "attachment" and classification =~ "malware"
  | summarize filenames = make_set(filename), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), count() by TimeGenerated, Sender = sender_s, SenderIPAddress = senderIP_s, Recipient = recipient_s, threatType, classification,  Subject = subject_s
  | extend timestamp = StartTime, extend AccountCustomEntity = Sender, IPCustomEntity = SenderIPAddress
