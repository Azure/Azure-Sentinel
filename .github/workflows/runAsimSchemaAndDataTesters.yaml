# Each pull request that updates ASIM parsers triggers the script.
# The script runs ASIM Schema and Data testers on the "eco-connector-test" workspace.
name: Run ASIM tests on "ASIM-SchemaDataTester-GithubShared" workspace
on:
  pull_request_target:
    types: [opened, edited, reopened, synchronize, labeled]
    branches:
      - master
      - asim-github-workflow
    paths:
    - 'Parsers/ASimDns/Parsers/**'
    - 'Parsers/ASimNetworkSession/Parsers/**'
    - 'Parsers/ASimWebSession/Parsers/**'
    - 'Parsers/ASimProcessEvent/Parsers/**'
    - 'Parsers/ASimAuditEvent/Parsers/**'
    - 'Parsers/ASimAuthentication/Parsers/**'
    - 'Parsers/ASimFileEvent/Parsers/**'
    - 'Parsers/ASimRegistryEvent/Parsers/**'
    - 'Parsers/ASimUserManagement/Parsers/**'
    - 'Parsers/ASimDhcpEvent/Parsers/**'
    - 'Parsers/ASimAlertEvent/Parsers/**'
    
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: asim-tests-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs: 
  # Security gate: Fork PRs require manual approval via "safe to test" label
  # Internal PRs (same repo) can proceed without labels
  security-gate:
    name: Security approval gate for fork PRs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write
      issues: write
    outputs:
      approved: ${{ steps.check-approval.outputs.approved }}
    steps:
      - name: Check if PR needs approval
        id: check-approval
        run: |
          # Check if this is a fork PR
          if [ "${{ github.event.pull_request.head.repo.fork }}" = "true" ]; then
            echo "Fork PR detected - checking for approval label and commit safety..."
            
            # Check if "safe to test" label is present
            labels='${{ toJson(github.event.pull_request.labels.*.name) }}'
            if echo "$labels" | grep -q "safe to test"; then
              echo "‚úÖ Fork PR has 'safe to test' label - checking for race condition..."
              
              # SECURITY: Check for race condition - commits after label approval
              # Get when the "safe to test" label was added
              echo "Checking label timeline for race condition detection..."
              label_created=$(curl -s -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/timeline" \
                | jq -r '.[] | select(.event == "labeled" and .label.name == "safe to test") | .created_at' \
                | head -1)
              
              if [ -n "$label_created" ]; then
                echo "Label 'safe to test' was added at: $label_created"
                
                # Get the latest commit timestamp
                latest_commit_date="${{ github.event.pull_request.head.repo.pushed_at }}"
                echo "Latest commit in PR was pushed at: $latest_commit_date"
                
                # Convert to epoch time for comparison
                label_epoch=$(date -d "$label_created" +%s 2>/dev/null || echo "0")
                commit_epoch=$(date -d "$latest_commit_date" +%s 2>/dev/null || echo "0")
                
                # Allow 60 second grace period for GitHub timestamp variations
                grace_period=60
                commit_epoch_with_grace=$((commit_epoch + grace_period))
                
                if [ "$commit_epoch_with_grace" -gt "$label_epoch" ]; then
                  echo "‚ö†Ô∏è  SECURITY ALERT: Commits may have been pushed after label approval!"
                  echo "Label added: $label_created (epoch: $label_epoch)"
                  echo "Latest commit: $latest_commit_date (epoch: $commit_epoch)"
                  echo "‚ùå For security, this requires re-approval. Please:"
                  echo "1. Review the latest commits carefully"
                  echo "2. Remove and re-add the 'safe to test' label if commits are safe"
                  echo "approved=false" >> $GITHUB_OUTPUT
                  echo "needs_reapproval=true" >> $GITHUB_OUTPUT
                  exit 1
                else
                  echo "‚úÖ No commits detected after label approval - safe to proceed"
                  echo "approved=true" >> $GITHUB_OUTPUT
                fi
              else
                echo "‚ö†Ô∏è  Could not determine when label was added - manual review recommended"
                echo "For maximum security, please remove and re-add the 'safe to test' label"
                echo "approved=false" >> $GITHUB_OUTPUT
                echo "needs_reapproval=true" >> $GITHUB_OUTPUT
                exit 1
              fi
            else
              echo "‚ùå Fork PR requires 'safe to test' label from a maintainer"
              echo "Fork PRs require manual approval for security. A maintainer must add the 'safe to test' label."
              echo "approved=false" >> $GITHUB_OUTPUT
              echo "needs_approval=true" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "‚úÖ Internal PR from same repository - auto-approved"
            echo "approved=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment on fork PR for approval guidance
        if: github.event.pull_request.head.repo.fork == true && failure()
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Check if we already have a guidance comment to avoid spam
            const existingComment = comments.find(comment => 
              comment.body.includes('üîí **Security Approval Required**') && 
              comment.user.type === 'Bot'
            );
            
            let commentBody = '';
            
            // Check what type of approval is needed based on the step outputs
            if ('${{ steps.check-approval.outputs.needs_reapproval }}' === 'true') {
              commentBody = `üîí **Security Re-approval Required**
            
            ‚ö†Ô∏è **Race condition detected**: New commits were pushed after the \`safe to test\` label was added.
            
            **For security, a maintainer must:**
            1. üìù Review the latest commits carefully for any security concerns
            2. üè∑Ô∏è Remove the \`safe to test\` label
            3. üè∑Ô∏è Re-add the \`safe to test\` label if the new commits are safe
            
            This ensures that all commits have been properly reviewed before testing with repository secrets.
            
            ---
            *This is an automated security check to prevent malicious code execution. Learn more about [GitHub Security Lab recommendations](https://securitylab.github.com/resources/github-actions-preventing-pwn-requests/).*`;
            } else {
              commentBody = `üîí **Security Approval Required**
            
            This fork PR requires manual approval before automated testing can run.
            
            **For security, a maintainer must:**
            1. üìù Review the code changes carefully
            2. üè∑Ô∏è Add the \`safe to test\` label if the changes are safe to execute
            
            This protects against malicious code execution in fork contributions.
            
            ---
            *This is an automated security check to prevent malicious code execution. Learn more about [GitHub Security Lab recommendations](https://securitylab.github.com/resources/github-actions-preventing-pwn-requests/).*`;
            }
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
              console.log('Updated existing security guidance comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              console.log('Created new security guidance comment');
            }

  Run-ASim-TemplateValidation:
    name: Run ASim Template Validation tests
    needs: security-gate
    if: needs.security-gate.outputs.approved == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pull request branch
        uses: actions/checkout@v3
        with:
            ref: ${{github.event.pull_request.head.ref}}
            repository: ${{github.event.pull_request.head.repo.full_name}}
            persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.
            fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
      - name: Setup git config
        run: |
              git config --local user.name "github-actions[bot]"
              git config --local user.email "<>"
      - name: Merge master into pull request branch
        run: |
              git merge origin/master
              Conflicts=$(git ls-files -u | wc -l)
              if [ "$Conflicts" -gt 0 ] ; then
                echo "There is a merge conflict. Aborting"
                git merge --abort
                exit 1
              fi
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
              python -m pip install --upgrade pip
              pip install requests
              pip install PyYAML
              pip install tabulate
      - name: Run ASim parsers template validations python script
        run: |
              filePath=".script/tests/asimParsersTest/VerifyASimParserTemplate.py"
              url="https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/VerifyASimParserTemplate.py" 
              # Check if file exists and delete if it does
              if [ -f "$filePath" ]; then
                rm -f "$filePath"
              fi
              # Download the file
              echo "Downloading script from the master: $url"
              curl -o "$filePath" "$url"
              # Execute the script
              python "$filePath" 
  Run-ASim-Sample-Data-Ingest:
    needs: Run-ASim-TemplateValidation
    name: Run ASim Sample Data Ingestion
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pull request branch
        uses: actions/checkout@v4
        with:
            ref: ${{github.event.pull_request.head.ref}}
            repository: ${{github.event.pull_request.head.repo.full_name}}
            persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.
            fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
      - name: Setup git config
        run: |
              git config --local user.name "github-actions[bot]"
              git config --local user.email "<>"
      - name: Merge master into pull request branch
        run: |
              git merge origin/master
              Conflicts=$(git ls-files -u | wc -l)
              if [ "$Conflicts" -gt 0 ] ; then
                echo "There is a merge conflict. Aborting"
                git merge --abort
                exit 1
              fi
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
              python -m pip install --upgrade pip
              pip install azure-identity
              pip install requests
              pip install PyYAML
              pip install azure-monitor-ingestion
              pip install azure-core
      - name: Login to Azure Public Cloud
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_ASIM_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true
      - name: Asim Sample Log Ingestion
        id: Ingestlogs
        run: |
              filePath=".script/tests/asimParsersTest/ingestASimSampleData.py"
              url="https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/ingestASimSampleData.py" 
              # Check if file exists and delete if it does
              if [ -f "$filePath" ]; then
                rm -f "$filePath"
              fi
              # Download the file
              echo "Downloading script from the master: $url"
              curl -o "$filePath" "$url"
              chmod +x "$filePath"
              # Execute the script
              python "$filePath" "${{ github.event.pull_request.number }}"
  Run-ASim-Schema-Data-tests:
    needs: Run-ASim-Sample-Data-Ingest
    name: Run ASim Schema and Data tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pull request branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          persist-credentials: false
          fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
      
      - name: Login to Azure Public Cloud with AzPowershell
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_ASIM_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          enable-AzPSSession: true
          allow-no-subscriptions: true

      - name: Setup git config
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "<>"

      - name: Merge master into pull request branch
        run: |
          git merge origin/master
          Conflicts=$(git ls-files -u | wc -l)
          if [ "$Conflicts" -gt 0 ] ; then
            echo "There is a merge conflict. Aborting"
            git merge --abort
            exit 1
          fi
      - name: Run ASIM Schema and Data tests PowerShell script
        uses: azure/powershell@v2
        with:
          inlineScript: |
            $filePath = ".script/tests/asimParsersTest/runAsimTesters.ps1"
            $url = "https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/runAsimTesters.ps1"
            # Check if file exists and delete if it does
            if (Test-Path $filePath) {
              Remove-Item $filePath -Force
            }
            # Download the runAsimTesters file
            Write-Host "Downloading script from the master: $url"
            Invoke-WebRequest -Uri $url -OutFile $filePath
            # download the convertYamlToObject.ps1 script form master
            $filePath_convert_yaml = ".script/tests/asimParsersTest/convertYamlToObject.ps1"
            $url_convert_yaml = "https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/convertYamlToObject.ps1"
            # Check if file exists and delete if it does
            if (Test-Path $filePath_convert_yaml) {
              Remove-Item $filePath_convert_yaml -Force
            }
            # Download the convertYamlToObject file
            Write-Host "Downloading script from the master: $url_convert_yaml"
            Invoke-WebRequest -Uri $url_convert_yaml -OutFile $filePath_convert_yaml 
            # Execute the script
            & $filePath
          azPSVersion: "latest"
  Run-ASim-Parser-Filtering-Tests:
    needs: Run-ASim-Sample-Data-Ingest
    name: Run ASim Parser Filtering tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pull request branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.
          fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
      - name: Setup git config
        run: |
              git config --local user.name "github-actions[bot]"
              git config --local user.email "<>"
      - name: Merge master into pull request branch
        run: |
          git merge origin/master
          Conflicts=$(git ls-files -u | wc -l)
          if [ "$Conflicts" -gt 0 ] ; then
            echo "There is a merge conflict. Aborting"
            git merge --abort
            exit 1
          fi
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
              python -m pip install --upgrade pip
              pip install PyYAML
              pip install azure-identity
              pip install azure-monitor-query
      - name: Login to Azure Public Cloud
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_ASIM_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true
      - name: Run ASim parsers filtering tests python script
        run: |
          filePath=".script/tests/asimParsersTest/ASimFilteringTest.py"
          url="https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/ASimFilteringTest.py"
          # Check if file exists and delete if it does
          if [ -f "$filePath" ]; then
            rm -f "$filePath"
          fi
          # Download the file
          echo "Downloading script from the master: $url"
          curl -o "$filePath" "$url"
          # Execute the script
          python "$filePath"