# Each pull request that updates ASIM parsers triggers the script.
# The script runs ASIM Schema and Data testers on the "eco-connector-test" workspace.
name: Run ASIM tests on "ASIM-SchemaDataTester-GithubShared" workspace
on:
  pull_request_target:
    types: [opened, edited, reopened, synchronize]
    branches:
      - fix-pull-request-target-security-issue  # this is for testing only. Remove it once done with testing online.
    paths:
    - 'Parsers/ASimDns/Parsers/**'
    - 'Parsers/ASimNetworkSession/Parsers/**'
    - 'Parsers/ASimWebSession/Parsers/**'
    - 'Parsers/ASimProcessEvent/Parsers/**'
    - 'Parsers/ASimAuditEvent/Parsers/**'
    - 'Parsers/ASimAuthentication/Parsers/**'
    - 'Parsers/ASimFileEvent/Parsers/**'
    - 'Parsers/ASimRegistryEvent/Parsers/**'
    - 'Parsers/ASimUserManagement/Parsers/**'
    - 'Parsers/ASimDhcpEvent/Parsers/**'
    - 'Parsers/ASimAlertEvent/Parsers/**'
    
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs: 
  Run-ASim-TemplateValidation:
    name: Run ASim Template Validation tests
    runs-on: ubuntu-latest
    steps:
      # Free up disk space to avoid error on checkout - No space left on device
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
      
      # Check out the main branch (trusted code with test scripts)
      - name: Checkout main branch (trusted code)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: fix-pull-request-target-security-issue
          persist-credentials: false
          fetch-depth: 1
      
      # Check out PR code to separate folder (untrusted code)
      - name: Checkout PR branch to pr-code folder (untrusted code)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{github.event.pull_request.head.ref}}
          repository: ${{github.event.pull_request.head.repo.full_name}}
          path: pr-code
          persist-credentials: false
          fetch-depth: 100
      
      - name: Setup git config for pr-code
        run: |
          cd pr-code
          git config --local user.name "github-actions[bot]"
          git config --local user.email "<>"
      
      # Merge master into PR code (in the isolated pr-code folder)
      - name: Merge master into PR branch (in pr-code folder)
        run: |
          cd pr-code
          git remote add upstream https://github.com/Azure/Azure-Sentinel.git
          git fetch upstream master
          git merge upstream/master
          Conflicts=$(git ls-files -u | wc -l)
          if [ "$Conflicts" -gt 0 ] ; then
            echo "There is a merge conflict. Aborting"
            git merge --abort
            exit 1
          fi
      
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
              python -m pip install --upgrade pip
              pip install requests
              pip install PyYAML
              pip install tabulate
      
      - name: Run ASim parsers template validations python script
        run: |
              # Use ASim test runner from trusted main branch, analyze merged PR code
              python ".script/tests/asimParsersTest/asim_test_runner.py" VerifyASimParserTemplate --source-path "./pr-code"

  Run-ASim-Sample-Data-Ingest:
    needs: Run-ASim-TemplateValidation
    name: Run ASim Sample Data Ingestion
    runs-on: ubuntu-latest
    steps:
      # Free up disk space
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
      
      # Check out main branch (trusted code)
      - name: Checkout main branch (trusted code)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: fix-pull-request-target-security-issue
          persist-credentials: false
          fetch-depth: 1
      
      # Check out PR code to separate folder
      - name: Checkout PR branch to pr-code folder (untrusted code)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{github.event.pull_request.head.ref}}
          repository: ${{github.event.pull_request.head.repo.full_name}}
          path: pr-code
          persist-credentials: false
          fetch-depth: 100
      
      - name: Setup git config for pr-code
        run: |
          cd pr-code
          git config --local user.name "github-actions[bot]"
          git config --local user.email "<>"
      
      # Merge master into PR code (in the isolated pr-code folder)
      - name: Merge master into PR branch (in pr-code folder)
        run: |
          cd pr-code
          git remote add upstream https://github.com/Azure/Azure-Sentinel.git
          git fetch upstream master
          git merge upstream/master
          Conflicts=$(git ls-files -u | wc -l)
          if [ "$Conflicts" -gt 0 ] ; then
            echo "There is a merge conflict. Aborting"
            git merge --abort
            exit 1
          fi
      
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
              python -m pip install --upgrade pip
              pip install azure-identity
              pip install requests
              pip install PyYAML
              pip install azure-monitor-ingestion
              pip install azure-core
      
      - name: Login to Azure Public Cloud
        uses: azure/login@6c251865b4e6290e7b78be643ea2d005bc51f69a # v2.1.1
        with:
          client-id: ${{ secrets.AZURE_ASIM_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true
      
      - name: Asim Sample Log Ingestion
        id: Ingestlogs
        run: |
              # Use ASim test runner from trusted main branch
              python ".script/tests/asimParsersTest/asim_test_runner.py" ingestASimSampleData --source-path "./pr-code"

  Run-ASim-Schema-Data-tests:
    needs: Run-ASim-Sample-Data-Ingest
    name: Run ASim Schema and Data tests
    runs-on: ubuntu-latest
    steps:
      # Free up disk space
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
      
      # Check out main branch (trusted code)
      - name: Checkout main branch (trusted code)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: fix-pull-request-target-security-issue
          persist-credentials: false
          fetch-depth: 1
      
      # Check out PR code to separate folder
      - name: Checkout PR branch to pr-code folder (untrusted code)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          path: pr-code
          persist-credentials: false
          fetch-depth: 100
      
      - name: Setup git config for pr-code
        run: |
          cd pr-code
          git config --local user.name "github-actions[bot]"
          git config --local user.email "<>"
      
      # Merge master into PR code (in the isolated pr-code folder)
      - name: Merge master into PR branch (in pr-code folder)
        run: |
          cd pr-code
          git remote add upstream https://github.com/Azure/Azure-Sentinel.git
          git fetch upstream master
          git merge upstream/master
          Conflicts=$(git ls-files -u | wc -l)
          if [ "$Conflicts" -gt 0 ] ; then
            echo "There is a merge conflict. Aborting"
            git merge --abort
            exit 1
          fi
      
      - name: Login to Azure Public Cloud with AzPowershell
        uses: azure/login@6c251865b4e6290e7b78be643ea2d005bc51f69a # v2.1.1
        with:
          client-id: ${{ secrets.AZURE_ASIM_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          enable-AzPSSession: true
          allow-no-subscriptions: true

      - name: Run ASIM Schema and Data tests PowerShell script
        uses: azure/powershell@1c23bea6616927f9405ab4a2c61a3999d2b25c83 # v2.0.0
        with:
          inlineScript: |
            # Use secure wrapper script from trusted main branch
            $filePath = ".script/tests/asimParsersTest/asim_path_handler_powershell.ps1"
            $filePath_convert_yaml = ".script/tests/asimParsersTest/convertYamlToObject.ps1"
            
            # Execute trusted wrapper script against merged PR code
            & $filePath -SourcePath "./pr-code"
          azPSVersion: "latest"

  Run-ASim-Parser-Filtering-Tests:
    needs: Run-ASim-Sample-Data-Ingest
    name: Run ASim Parser Filtering tests
    runs-on: ubuntu-latest
    steps:
      # Free up disk space
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
      
      # Check out main branch (trusted code)
      - name: Checkout main branch (trusted code)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: fix-pull-request-target-security-issue
          persist-credentials: false
          fetch-depth: 1
      
      # Check out PR code to separate folder
      - name: Checkout PR branch to pr-code folder (untrusted code)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          path: pr-code
          persist-credentials: false
          fetch-depth: 100
      
      - name: Setup git config for pr-code
        run: |
          cd pr-code
          git config --local user.name "github-actions[bot]"
          git config --local user.email "<>"
      
      # Merge master into PR code (in the isolated pr-code folder)
      - name: Merge master into PR branch (in pr-code folder)
        run: |
          cd pr-code
          git remote add upstream https://github.com/Azure/Azure-Sentinel.git
          git fetch upstream master
          git merge upstream/master
          Conflicts=$(git ls-files -u | wc -l)
          if [ "$Conflicts" -gt 0 ] ; then
            echo "There is a merge conflict. Aborting"
            git merge --abort
            exit 1
          fi
      
      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
              python -m pip install --upgrade pip
              pip install PyYAML
              pip install azure-identity
              pip install azure-monitor-query
      
      - name: Login to Azure Public Cloud
        uses: azure/login@6c251865b4e6290e7b78be643ea2d005bc51f69a # v2.1.1
        with:
          client-id: ${{ secrets.AZURE_ASIM_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true
      
      - name: Run ASim parsers filtering tests python script
        run: |
          # Use ASim test runner from trusted main branch  
          python ".script/tests/asimParsersTest/asim_test_runner.py" ASimFilteringTest --source-path "./pr-code"