# Each pull request that updates ASIM parsers triggers the script.
# The script runs ASIM Schema and Data testers on the "eco-connector-test" workspace.
name: Run ASIM tests on "ASIM-SchemaDataTester-GithubShared" workspace
on:
  pull_request_target:
    types: [opened, edited, reopened, synchronize]
    branches:
      - master
      - asim-github-workflow
    paths:
    - 'Parsers/ASimDns/Parsers/**'
    - 'Parsers/ASimNetworkSession/Parsers/**'
    - 'Parsers/ASimWebSession/Parsers/**'
    - 'Parsers/ASimProcessEvent/Parsers/**'
    - 'Parsers/ASimAuditEvent/Parsers/**'
    - 'Parsers/ASimAuthentication/Parsers/**'
    - 'Parsers/ASimFileEvent/Parsers/**'
    - 'Parsers/ASimRegistryEvent/Parsers/**'
    - 'Parsers/ASimUserManagement/Parsers/**'
    - 'Parsers/ASimDhcpEvent/Parsers/**'
    - 'Parsers/ASimAlertEvent/Parsers/**'
    
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: read
  # id-token only needed in jobs that actually perform Azure login

concurrency:
  group: asim-tests-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

env:
  VERIFY_TEMPLATE_SCRIPT: https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/VerifyASimParserTemplate.py
  INGEST_SAMPLE_SCRIPT: https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/ingestASimSampleData.py
  RUN_TESTERS_SCRIPT: https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/runAsimTesters.ps1
  CONVERT_YAML_SCRIPT: https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/convertYamlToObject.ps1
  FILTERING_TEST_SCRIPT: https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/ASimFilteringTest.py

jobs:
  prepare-parsers:
    name: Prepare sanitized parser content
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Preflight disk usage
        run: |
          echo "Initial disk status:" >&2
          df -h >&2 || true
          echo "Workspace usage (top 20 dirs):" >&2
          du -h -d1 2>/dev/null | sort -hr | head -20 >&2 || true
      - name: Checkout PR head into pr-code (isolated, sparse & shallow)
        # Minimize disk usage: shallow + blobless + sparse filter for Parsers subtree
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
            path: pr-code
            ref: ${{ github.event.pull_request.head.ref }}
            repository: ${{ github.event.pull_request.head.repo.full_name }}
            persist-credentials: false
            fetch-depth: 20            # enough for merge-base while limiting objects
            filter: blob:none          # partial clone without blobs initially
            sparse-checkout: |
              Parsers
            sparse-checkout-cone-mode: false
      - name: Add upstream master (shallow) for merge test
        run: |
          cd pr-code
          git config --local core.autocrlf false
          git config --local filter.lfs.smudge "git-lfs smudge --skip -- %f" || true
          git config --local filter.lfs.process "git-lfs filter-process --skip" || true
          git remote add upstream https://github.com/Azure/Azure-Sentinel.git
          # Fetch only latest master commit (shallow) for merge conflict detection
          git fetch --depth=1 upstream master
      - name: Validate merge (no execution of PR code)
        run: |
          cd pr-code
          set +e
          echo "Attempting dry merge with shallow upstream/master" >&2
          git merge --no-commit --no-ff upstream/master 2>merge.err
          status=$?
          if grep -qi 'refusing to merge unrelated histories' merge.err; then
            echo "Shallow fetch insufficient (unrelated histories warning). Deepening fetch for proper merge base..." >&2
            git merge --abort 2>/dev/null || true
            git fetch --deepen=200 upstream master || git fetch --unshallow upstream master || true
            git merge --no-commit --no-ff upstream/master 2>merge2.err
            status=$?
            if grep -qi 'refusing to merge unrelated histories' merge2.err; then
              echo "Still appears unrelated; proceeding to allow merge check with --allow-unrelated-histories (informational only)." >&2
              git merge --abort 2>/dev/null || true
              git merge --no-commit --no-ff --allow-unrelated-histories upstream/master 2>merge3.err
              status=$?
            fi
          fi
          Conflicts=$(git ls-files -u | wc -l)
          if [ "$Conflicts" -gt 0 ] || [ $status -ne 0 ]; then
            echo "Merge conflict (or merge error) detected between PR and current master. Failing early." >&2
            git merge --abort 2>/dev/null || true
            echo '--- merge.err ---' >&2; cat merge.err 2>/dev/null || true
            echo '--- merge2.err ---' >&2; cat merge2.err 2>/dev/null || true
            echo '--- merge3.err ---' >&2; cat merge3.err 2>/dev/null || true
            exit 1
          fi
          git merge --abort 2>/dev/null || true
      - name: Copy parser assets (sanitized)
        run: |
          mkdir -p sanitized
          rsync -a --prune-empty-dirs --include '*/' --include '*.yaml' --include '*.yml' --include '*.json' --exclude '*' pr-code/Parsers/ sanitized/Parsers/ || true
          # Fallback to full copy if selective copy produced nothing (to preserve behavior)
          if [ ! -d sanitized/Parsers ] || [ "$(find sanitized/Parsers -type f | wc -l)" -eq 0 ]; then
            echo "Selective copy empty; copying entire Parsers directory." >&2
            rsync -a pr-code/Parsers/ sanitized/Parsers/
          fi
          # Detect symlinks (fail if any to avoid traversal attacks)
          if find sanitized/Parsers -type l | grep -q '.'; then
            echo 'Symlinks detected in Parsers directory. Aborting for safety.' >&2
            find sanitized/Parsers -type l -print >&2
            exit 1
          fi
      - name: Upload sanitized artifact
        # Use maintained major version tag instead of obsolete commit SHA (previous SHA returned 404)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: sanitized-parsers
          path: sanitized/Parsers
          if-no-files-found: error
          retention-days: 3
      - name: Free checkout workspace to save disk
        run: |
          echo "Disk usage before cleanup:" >&2
          df -h >&2 || true
          rm -rf pr-code || true
          rm -rf ~/.cache/pip || true
          echo "Disk usage after cleanup:" >&2
          df -h >&2 || true

  Run-ASim-TemplateValidation:
    name: Run ASIM Template Validation tests
    needs: prepare-parsers
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Download sanitized parsers
        # Use stable major tag for download-artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: sanitized-parsers
          path: Parsers
      - name: Write dependency manifest
        # Create a manifest file for cache key generation - this ensures pip cache
        # is invalidated only when dependencies actually change, improving performance
        run: |
          printf "requests\nPyYAML\ntabulate\n" > deps-template.txt
      - name: Restore pip cache
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4.0.2
        with:
          path: ~/.cache/pip
          # Cache key uses hash of dependency manifest - same deps = cache hit, different deps = cache miss
          key: pip-${{ runner.os }}-${{ hashFiles('deps-template.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: '3.x'
      - name: Install dependencies
        # Install the same packages listed in the manifest above
        # With cache: ~5-10 seconds, without cache: ~30-60 seconds
        run: |
          python -m pip install --upgrade pip
          pip install requests PyYAML tabulate
      - name: Run ASim parsers template validations python script
        run: |
          filePath=".script/tests/asimParsersTest/VerifyASimParserTemplate.py"
          url="$VERIFY_TEMPLATE_SCRIPT"
          mkdir -p .script/tests/asimParsersTest
          [ -f "$filePath" ] && rm -f "$filePath"
          echo "Downloading script: $url"
          curl -sSL -o "$filePath" "$url"
          python "$filePath"

  Run-ASim-Sample-Data-Ingest:
    needs: [prepare-parsers, Run-ASim-TemplateValidation]
    name: Run ASim Sample Data Ingestion
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download sanitized parsers
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: sanitized-parsers
          path: Parsers
      - name: Write dependency manifest
        run: |
          printf "azure-identity\nrequests\nPyYAML\nazure-monitor-ingestion\nazure-core\n" > deps-ingest.txt
      - name: Restore pip cache
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('deps-ingest.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install azure-identity requests PyYAML azure-monitor-ingestion azure-core
      - name: Check Azure secrets availability
        id: azure-check
        run: |
          if [ -n "${{ secrets.AZURE_ASIM_CLIENT_ID }}" ] && [ -n "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Azure secrets available - full testing enabled" >> $GITHUB_STEP_SUMMARY
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Azure secrets not available (likely fork PR) - skipping Azure-dependent steps" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Login to Azure Public Cloud
        if: steps.azure-check.outputs.available == 'true'
        uses: azure/login@6c251865b4e6290e7b78be643ea2d005bc51f69a
        with:
          client-id: ${{ secrets.AZURE_ASIM_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true
      - name: Asim Sample Log Ingestion
        if: steps.azure-check.outputs.available == 'true'
        run: |
          filePath=".script/tests/asimParsersTest/ingestASimSampleData.py"
          url="$INGEST_SAMPLE_SCRIPT" 
          mkdir -p .script/tests/asimParsersTest
          [ -f "$filePath" ] && rm -f "$filePath"
          echo "Downloading script: $url"
          curl -sSL -o "$filePath" "$url"
          python "$filePath" "${{ github.event.pull_request.number }}"
      - name: Skip Azure ingestion notice
        if: steps.azure-check.outputs.available == 'false'
        run: |
          echo "‚ö†Ô∏è Skipping Azure log ingestion - secrets not available" >> $GITHUB_STEP_SUMMARY
          echo "This is normal for fork PRs. Template validation was still performed." >> $GITHUB_STEP_SUMMARY

  Run-ASim-Schema-Data-tests:
    needs: Run-ASim-Sample-Data-Ingest
    name: Run ASim Schema and Data tests
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download sanitized parsers
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: sanitized-parsers
          path: Parsers
      - name: Check Azure secrets availability
        id: azure-check
        run: |
          if [ -n "${{ secrets.AZURE_ASIM_CLIENT_ID }}" ] && [ -n "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Skipping Azure schema tests - secrets not available (likely fork PR)" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Login to Azure Public Cloud with AzPowershell
        if: steps.azure-check.outputs.available == 'true'
        uses: azure/login@6c251865b4e6290e7b78be643ea2d005bc51f69a
        with:
          client-id: ${{ secrets.AZURE_ASIM_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          enable-AzPSSession: true
          allow-no-subscriptions: true
      - name: Run ASIM Schema and Data tests PowerShell script
        if: steps.azure-check.outputs.available == 'true'
        uses: azure/powershell@1c23bea6616927f9405ab4a2c61a3999d2b25c83
        with:
          inlineScript: |
            $filePath = ".script/tests/asimParsersTest/runAsimTesters.ps1"
            $url = "$env:RUN_TESTERS_SCRIPT"
            if (Test-Path $filePath) { Remove-Item $filePath -Force }
            Write-Host "Downloading script: $url"
            New-Item -ItemType Directory -Force -Path (Split-Path $filePath) | Out-Null
            Invoke-WebRequest -Uri $url -OutFile $filePath
            $filePath_convert_yaml = ".script/tests/asimParsersTest/convertYamlToObject.ps1"
            $url_convert_yaml = "$env:CONVERT_YAML_SCRIPT"
            if (Test-Path $filePath_convert_yaml) { Remove-Item $filePath_convert_yaml -Force }
            Invoke-WebRequest -Uri $url_convert_yaml -OutFile $filePath_convert_yaml
            & $filePath
          azPSVersion: "latest"

  Run-ASim-Parser-Filtering-Tests:
    needs: Run-ASim-Sample-Data-Ingest
    name: Run ASim Parser Filtering tests
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download sanitized parsers
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: sanitized-parsers
          path: Parsers
      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
        with:
          python-version: '3.x'
      - name: Write dependency manifest
        run: |
          printf "PyYAML\nazure-identity\nazure-monitor-query\n" > deps-filter.txt
      - name: Restore pip cache
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('deps-filter.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML azure-identity azure-monitor-query
      - name: Check Azure secrets availability
        id: azure-check
        run: |
          if [ -n "${{ secrets.AZURE_ASIM_CLIENT_ID }}" ] && [ -n "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Skipping Azure filtering tests - secrets not available (likely fork PR)" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Login to Azure Public Cloud
        if: steps.azure-check.outputs.available == 'true'
        uses: azure/login@6c251865b4e6290e7b78be643ea2d005bc51f69a
        with:
          client-id: ${{ secrets.AZURE_ASIM_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true
      - name: Run ASim parsers filtering tests python script
        if: steps.azure-check.outputs.available == 'true'
        run: |
          filePath=".script/tests/asimParsersTest/ASimFilteringTest.py"
          url="$FILTERING_TEST_SCRIPT"
          mkdir -p .script/tests/asimParsersTest
          [ -f "$filePath" ] && rm -f "$filePath"
          echo "Downloading script: $url"
          curl -sSL -o "$filePath" "$url"
          python "$filePath"

  # Comment on fork PRs to notify contributors
  fork-pr-comment:
    name: Fork PR Notification
    runs-on: ubuntu-latest
    needs: [prepare-parsers, Run-ASim-TemplateValidation, Run-ASim-Sample-Data-Ingest, Run-ASim-Schema-Data-tests, Run-ASim-Parser-Filtering-Tests]
    if: always() && github.event.pull_request.head.repo.fork == true
    permissions:
      pull-requests: write
    steps:
      - name: Comment on Fork PR
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410
        with:
          script: |
            // Check if we already commented on this PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            // Look for our bot comment (identified by unique text)
            const botCommentExists = comments.some(comment => 
              comment.body.includes('Fork PR Detected') && 
              comment.body.includes('automatically generated for fork PR contributions')
            );
            
            if (botCommentExists) {
              console.log('Fork PR comment already exists - skipping duplicate');
              return;
            }
            
            // Get job results
            const templateResult = '${{ needs.Run-ASim-TemplateValidation.result }}';
            const prepareResult = '${{ needs.prepare-parsers.result }}';
            
            // Determine status icons and messages
            const getStatusIcon = (result) => {
              switch(result) {
                case 'success': return '‚úÖ';
                case 'failure': return '‚ùå';
                case 'cancelled': return '‚èπÔ∏è';
                case 'skipped': return '‚è≠Ô∏è';
                default: return '‚ö†Ô∏è';
              }
            };
            
            const templateIcon = getStatusIcon(templateResult);
            const templateText = templateResult === 'success' ? 'PASSED' : 
                                templateResult === 'failure' ? 'FAILED' : 
                                templateResult.toUpperCase();
            
            const overallSuccess = templateResult === 'success' && prepareResult === 'success';
            const headerIcon = overallSuccess ? '‚úÖ' : '‚ùå';
            
            // Post the comment since it doesn't exist yet
            const comment = `## ${headerIcon} Fork PR Validation Results
            
            Thank you for your contribution to Azure Sentinel ASIM parsers! 
            
            ### ÔøΩ Test Results:
            - **${templateIcon} Template Validation**: ${templateText}
            - **‚ö†Ô∏è Azure Sample Data Ingestion**: SKIPPED (requires Azure secrets)
            - **‚ö†Ô∏è Azure Schema Data Tests**: SKIPPED (requires Azure secrets) 
            - **‚ö†Ô∏è Azure Parser Filtering Tests**: SKIPPED (requires Azure secrets)
            
            ### üìã Summary:
            ${overallSuccess ? 
              'üéâ **Your changes have passed validation!** The Azure-dependent tests will be run by maintainers before merge.' : 
              '‚ö†Ô∏è **Please review and fix the validation errors** before your PR can be reviewed. Check the workflow logs above for details.'}
            
            ### üõ°Ô∏è Security Note:
            This workflow runs with repository privileges for testing purposes. Our security measures ensure safe execution of external contributions.
            
            ### ‚ùì Need Help?
            - Check the [ASIM documentation](https://docs.microsoft.com/azure/sentinel/normalization) for parser guidelines
            - Review existing parsers in the \`Parsers/\` directory for examples
            - Comment on this PR if you have questions
            
            ---
            *This comment was automatically generated for fork PR contributions.*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            console.log('Fork PR welcome comment posted successfully');
