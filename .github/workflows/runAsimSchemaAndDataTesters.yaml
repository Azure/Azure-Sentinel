# Each pull request that updates ASIM parsers triggers the script.
# The script runs ASIM Schema and Data testers on the "eco-connector-test" workspace.
name: Run ASIM tests on "ASIM-SchemaDataTester-GithubShared" workspace
on:
  pull_request_target:
    types: [opened, edited, reopened, synchronize, labeled]
    branches:
      - master
    paths:
    - 'Parsers/ASimDns/Parsers/**'
    - 'Parsers/ASimNetworkSession/Parsers/**'
    - 'Parsers/ASimWebSession/Parsers/**'
    - 'Parsers/ASimProcessEvent/Parsers/**'
    - 'Parsers/ASimAuditEvent/Parsers/**'
    - 'Parsers/ASimAuthentication/Parsers/**'
    - 'Parsers/ASimFileEvent/Parsers/**'
    - 'Parsers/ASimRegistryEvent/Parsers/**'
    - 'Parsers/ASimUserManagement/Parsers/**'
    - 'Parsers/ASimDhcpEvent/Parsers/**'
    - 'Parsers/ASimAlertEvent/Parsers/**'
    
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: asim-tests-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs: 
  # Security gate: Fork PRs require manual approval via "SafeToRun" label
  # Internal PRs (same repo) can proceed without labels
  security-gate:
    name: Security approval gate for fork PRs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write
      issues: write
    outputs:
      approved: ${{ steps.check-approval.outputs.approved }}
    steps:
      - name: Checkout pull request
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0
      
      - name: Security Check - Detect Symlinks and Malicious Directories
        run: |
          echo "üîí Running security checks for symlinks and malicious directories..."
          EXIT_CODE=0
          
          # Check 1: Detect symlinks in the repository
          echo "Check 1: Scanning for symlinks..."
          SYMLINKS=$(git ls-files --stage | grep '^120000' | awk '{print $4}')
          if [ -n "$SYMLINKS" ]; then
            echo "‚ùå ERROR: Symlinks detected in PR! This is not allowed."
            echo "Symlinks found:"
            echo "$SYMLINKS"
            EXIT_CODE=1
          else
            echo "‚úÖ No symlinks detected"
          fi
          
          # Check 2: Detect suspicious *-linked directories
          echo "Check 2: Scanning for suspicious '*-linked' directories..."
          LINKED_DIRS=$(find . -type d -name "*-linked" 2>/dev/null | grep -v '^\\./.git')
          if [ -n "$LINKED_DIRS" ]; then
            echo "‚ùå ERROR: Suspicious '*-linked' directories detected! These may be used to bypass security controls."
            echo "Directories found:"
            echo "$LINKED_DIRS"
            EXIT_CODE=1
          else
            echo "‚úÖ No suspicious '*-linked' directories detected"
          fi
          
          # Check 3: Detect executable scripts outside allowed directories
          echo "Check 3: Scanning for unauthorized executable scripts..."
          # Allow scripts only in .script/tests/asimParsersTest (original directory only)
          ILLEGAL_SCRIPTS=$(find .script/tests -type f \( -name "*.py" -o -name "*.ps1" -o -name "*.sh" \) 2>/dev/null | grep -v '\.script/tests/asimParsersTest/' | grep -v '\.git' || true)
          if [ -n "$ILLEGAL_SCRIPTS" ]; then
            echo "‚ùå ERROR: Executable scripts found outside the allowed directory!"
            echo "Scripts found:"
            echo "$ILLEGAL_SCRIPTS"
            EXIT_CODE=1
          else
            echo "‚úÖ No unauthorized executable scripts detected"
          fi
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "‚ùå Security check failed. The PR contains potential attack vectors."
            exit 1
          else
            echo ""
            echo "‚úÖ All security checks passed"
          fi
      
      - name: Check if PR needs approval
        id: check-approval
        run: |
          # Function to log with consistent formatting
          log_info() { echo "‚ÑπÔ∏è  $1"; }
          log_success() { echo "‚úÖ $1"; }
          
          log_info "Starting PR approval check..."
          
          # Check if this is a fork PR
          is_fork="${{ github.event.pull_request.head.repo.fork }}"
          log_info "Fork PR: $is_fork"
          
          if [ "$is_fork" = "true" ]; then
            log_info "FORK PR DETECTED - Proceeding with security checks"
            
            # Check if "SafeToRun" label is present
            labels='${{ toJson(github.event.pull_request.labels.*.name) }}'
            log_info "Available labels: $labels"
            
            if echo "$labels" | grep -q "SafeToRun"; then
              log_success "'SafeToRun' label found - checking if re-approval needed"
              
              # SECURITY: Only allow 'labeled' event to pass when SafeToRun exists
              # Block ALL other events (synchronize, edited, reopened) to prevent bypass
              trigger_event="${{ github.event.action }}"
              log_info "Workflow triggered by: $trigger_event"
              
              if [ "$trigger_event" = "labeled" ]; then
                log_success "Label approval granted - triggered by adding SafeToRun label"
                echo "approved=true" >> $GITHUB_OUTPUT
                echo "needs_approval=false" >> $GITHUB_OUTPUT
                echo "comment_needed=false" >> $GITHUB_OUTPUT
              else
                log_info "Event '$trigger_event' detected on fork PR with existing 'SafeToRun' label"
                log_info "Maintainer must remove and re-add the 'SafeToRun' label for security"
                echo "approved=false" >> $GITHUB_OUTPUT
                echo "needs_approval=false" >> $GITHUB_OUTPUT
                echo "comment_needed=true" >> $GITHUB_OUTPUT
                exit 1
              fi
            else
              log_info "'SafeToRun' label not found - approval required"
              echo "approved=false" >> $GITHUB_OUTPUT
              echo "needs_approval=true" >> $GITHUB_OUTPUT
              echo "comment_needed=true" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            log_success "Internal PR - auto-approved"
            echo "approved=true" >> $GITHUB_OUTPUT
            echo "needs_approval=false" >> $GITHUB_OUTPUT
            echo "comment_needed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment on fork PR for approval guidance
        if: |
          always() && 
          github.event.pull_request.head.repo.fork == true && 
          steps.check-approval.outputs.comment_needed == 'true'
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410
        with:
          script: |
            // Helper function for consistent logging
            const log = (level, message) => {
              const icons = { info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå' };
              console.log(`${icons[level] || '‚ÑπÔ∏è'} ${message}`);
            };
            
            log('info', 'Comment step triggered for fork PR approval guidance');
            
            try {
              // Fetch existing comments
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              // Look for existing security guidance comments
              const botComments = comments.filter(comment => 
                comment.user.login === 'github-actions[bot]' &&
                (comment.body.includes('üîí **Security Approval Required**') ||
                 comment.body.includes('üîí **Security Re-approval Required**'))
              );
              
              // Create approval message
              const timestamp = new Date().toISOString();
              
              let commentBody;
              if ('${{ steps.check-approval.outputs.needs_approval }}' === 'true') {
                // Initial approval scenario
                commentBody = `üîí **Security Approval Required**
              
              This fork PR requires manual approval before automated testing can run.
              
              **For security, a maintainer must:**
              1. üìù Review the code changes carefully
              2. ‚úÖ **Verify file types** - This PR should only contain \`.yml\`, \`.yaml\`, or \`.json\` files. Check for any executable scripts (.ps1, .py, .sh, .exe, etc.) which are not allowed in this context.
              3. ‚úÖ **No symlinks or suspicious directories** - Ensure no symlinks or \`*-linked\` directories are present
              4. üè∑Ô∏è Add the \`SafeToRun\` label if the changes are safe to execute
              
              **Note**: If new commits are added later, simply remove and re-add the \`SafeToRun\` label.
              
              ---
              *ü§ñ Automated security check ‚Ä¢ Created: ${timestamp}*  
              *Learn more: [GitHub Security Lab - Preventing PWN Requests](https://securitylab.github.com/resources/github-actions-preventing-pwn-requests/)*`;
              } else {
                // Re-approval scenario (new commits with existing label)
                commentBody = `üîí **Security Re-approval Required**
              
              ‚ö†Ô∏è **New commits detected**: This fork PR has been updated with new commits while the \`SafeToRun\` label was present.
              
              **For security, a maintainer must:**
              1. üìù Review the latest commits carefully for any security concerns
              2. ‚úÖ **Verify file types** - Ensure new commits only contain \`.yml\`, \`.yaml\`, or \`.json\` files. Reject if any executable scripts (.ps1, .py, .sh, .exe, etc.) are included.
              3. ‚úÖ **No symlinks or suspicious directories** - Ensure no symlinks or \`*-linked\` directories are present
              4. üè∑Ô∏è Remove the \`SafeToRun\` label
              5. üè∑Ô∏è Re-add the \`SafeToRun\` label if the new commits are safe
              
              This simple process ensures that all commits have been properly reviewed before testing with repository secrets.
              
              ---
              *ü§ñ Automated security check ‚Ä¢ Updated: ${timestamp}*  
              *Learn more: [GitHub Security Lab - Preventing PWN Requests](https://securitylab.github.com/resources/github-actions-preventing-pwn-requests/)*`;
              }
              
              // Always create a new comment for maximum visibility
              // Keep existing comments for audit trail - don't delete them
              log('info', 'Creating new security guidance comment (preserving audit trail)');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              log('success', 'Created new security guidance comment');
              
              log('success', 'Comment operation completed successfully');
              
            } catch (error) {
              log('error', `Failed to post comment: ${error.message}`);
              if (error.response) {
                log('error', `API Response: ${error.response.status} - ${error.response.data?.message || 'Unknown error'}`);
              }
              // Don't fail the step if comment posting fails
              log('warning', 'Comment posting failed, but continuing workflow...');
            }

  Run-ASim-TemplateValidation:
    name: Run ASim Template Validation tests
    needs: security-gate
    if: needs.security-gate.outputs.approved == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pull request branch
        uses: actions/checkout@v3
        with:
            ref: ${{github.event.pull_request.head.sha}}
            repository: ${{github.event.pull_request.head.repo.full_name}}
            persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.
            fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
      - name: Setup git config
        run: |
              git config --local user.name "github-actions[bot]"
              git config --local user.email "<>"
      - name: Merge master into pull request branch
        run: |
              git merge origin/master
              Conflicts=$(git ls-files -u | wc -l)
              if [ "$Conflicts" -gt 0 ] ; then
                echo "There is a merge conflict. Aborting"
                git merge --abort
                exit 1
              fi
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
              python -m pip install --upgrade pip
              pip install requests
              pip install PyYAML
              pip install tabulate
      - name: Run ASim parsers template validations python script
        run: |
              # SECURITY: Execute in isolated environment to prevent import shadowing
              echo "Creating isolated execution environment..."
              TMPDIR=$(mktemp -d) && trap "rm -rf $TMPDIR" EXIT
              echo "Downloading script from master to isolated directory..."
              curl -sSf https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/VerifyASimParserTemplate.py -o "$TMPDIR/script.py"
              echo "Executing script with Python isolation flags..."
              python -I -s "$TMPDIR/script.py" 
  Run-ASim-Sample-Data-Ingest:
    needs: Run-ASim-TemplateValidation
    name: Run ASim Sample Data Ingestion
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout pull request branch
        uses: actions/checkout@v4
        with:
            ref: ${{github.event.pull_request.head.sha}}
            repository: ${{github.event.pull_request.head.repo.full_name}}
            persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.
            fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
      - name: Setup git config
        run: |
              git config --local user.name "github-actions[bot]"
              git config --local user.email "<>"
      - name: Merge master into pull request branch
        run: |
              git merge origin/master
              Conflicts=$(git ls-files -u | wc -l)
              if [ "$Conflicts" -gt 0 ] ; then
                echo "There is a merge conflict. Aborting"
                git merge --abort
                exit 1
              fi
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
              python -m pip install --upgrade pip
              pip install azure-identity
              pip install requests
              pip install PyYAML
              pip install azure-monitor-ingestion
              pip install azure-core
      - name: Login to Azure Public Cloud
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_ASIM_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true
      - name: Asim Sample Log Ingestion
        id: Ingestlogs
        run: |
              # SECURITY: Execute in isolated environment to prevent import shadowing
              echo "Creating isolated execution environment..."
              TMPDIR=$(mktemp -d) && trap "rm -rf $TMPDIR" EXIT
              echo "Downloading script from master to isolated directory..."
              curl -sSf https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/ingestASimSampleData.py -o "$TMPDIR/script.py"
              echo "Executing script with Python isolation flags..."
              python -I -s "$TMPDIR/script.py" "${{ github.event.pull_request.number }}"
  Run-ASim-Schema-Data-tests:
    needs: Run-ASim-Sample-Data-Ingest
    name: Run ASim Schema and Data tests
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout pull request branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          persist-credentials: false
          fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
      
      - name: Login to Azure Public Cloud with AzPowershell
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_ASIM_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          enable-AzPSSession: true
          allow-no-subscriptions: true

      - name: Setup git config
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "<>"

      - name: Merge master into pull request branch
        run: |
          git merge origin/master
          Conflicts=$(git ls-files -u | wc -l)
          if [ "$Conflicts" -gt 0 ] ; then
            echo "There is a merge conflict. Aborting"
            git merge --abort
            exit 1
          fi
      - name: Run ASIM Schema and Data tests PowerShell script
        uses: azure/powershell@v2
        with:
          inlineScript: |
            # SECURITY: Execute in isolated environment to prevent code injection
            Write-Host "Creating isolated execution environment..."
            $tmpDir = New-TemporaryFile | % { Remove-Item $_; New-Item -ItemType Directory -Path $_ }
            try {
              Write-Host "Downloading scripts from master to isolated directory..."
              Invoke-WebRequest https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/runAsimTesters.ps1 -OutFile "$tmpDir/script.ps1"
              Invoke-WebRequest https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/convertYamlToObject.ps1 -OutFile "$tmpDir/helper.ps1"
              Write-Host "Executing script from isolated environment..."
              Push-Location $env:GITHUB_WORKSPACE
              & "$tmpDir/script.ps1"
            } finally { Pop-Location; Remove-Item $tmpDir -Recurse -Force -EA SilentlyContinue }
          azPSVersion: "latest"
  Run-ASim-Parser-Filtering-Tests:
    needs: Run-ASim-Sample-Data-Ingest
    name: Run ASim Parser Filtering tests
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout pull request branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.
          fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
      - name: Setup git config
        run: |
              git config --local user.name "github-actions[bot]"
              git config --local user.email "<>"
      - name: Merge master into pull request branch
        run: |
          git merge origin/master
          Conflicts=$(git ls-files -u | wc -l)
          if [ "$Conflicts" -gt 0 ] ; then
            echo "There is a merge conflict. Aborting"
            git merge --abort
            exit 1
          fi
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
              python -m pip install --upgrade pip
              pip install PyYAML
              pip install azure-identity
              pip install azure-monitor-query
      - name: Login to Azure Public Cloud
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_ASIM_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true
      - name: Run ASim parsers filtering tests python script
        run: |
          # SECURITY: Execute in isolated environment to prevent import shadowing
          echo "Creating isolated execution environment..."
          TMPDIR=$(mktemp -d) && trap "rm -rf $TMPDIR" EXIT
          echo "Downloading script from master to isolated directory..."
          curl -sSf https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/.script/tests/asimParsersTest/ASimFilteringTest.py -o "$TMPDIR/script.py"
          echo "Executing script with Python isolation flags..."
          python -I -s "$TMPDIR/script.py"
