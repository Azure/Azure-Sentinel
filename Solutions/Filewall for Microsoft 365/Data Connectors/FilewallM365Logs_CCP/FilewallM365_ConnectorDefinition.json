{
  "name": "FilewallM365",
  "apiVersion": "2025-06-01",
  "type": "Microsoft.SecurityInsights/dataConnectorDefinitions",
  "location": "{{effectiveWorkspaceLocation}}",
  "kind": "Customizable",
  "variables": {
    "connectorUiConfigId": "FilewallM365"
  },
  "properties": {
    "connectorUiConfig": {
      "id": "FilewallM365",
      "title": "Filewall for Microsoft 365",
      "publisher": "Filewall",
      "descriptionMarkdown": "Ingest events from Filewall into Microsoft Sentinel (Exchange, SharePoint, OneDrive and Teams).",
      "graphQueriesTableName": "FilewallExchange_CL",
      "graphQueries": [
        {
          "metricName": "Total Exchange events received",
          "legend": "Events",
          "baseQuery": "{{graphQueriesTableName}}"
        },
        {
          "metricName": "Total File events received",
          "legend": "Events",
          "baseQuery": "FilewallFile_CL"
        }
      ],
      "sampleQueries": [
        {
          "description": "Latest Filewall Exchange logs",
          "query": "{{graphQueriesTableName}} | sort by TimeGenerated desc"
        },
        {
          "description": "Latest Filewall File logs",
          "query": "FilewallFile_CL | sort by TimeGenerated desc"
        },
        {
          "description": "Blocked Filewall attachments (Exchange)",
          "query": "{{graphQueriesTableName}} | where event_type == \"email_log\" | mv-expand attachment = attachments | where tostring(attachment.status) == \"blocked\" | project TimeGenerated, sender, recipient, subject, attachment_name = tostring(attachment.name), attachment_mime_type = tostring(attachment.type), attachment_block_reason = tostring(attachment.block_reason), attachment_summary = tostring(attachment.summary)"
        }
      ],
      "dataTypes": [
        {
          "name": "{{graphQueriesTableName}}",
          "lastDataReceivedQuery": "{{graphQueriesTableName}}|summarize Time=max(TimeGenerated)|where isnotempty(Time)"
        },
        {
          "name": "FilewallFile_CL",
          "lastDataReceivedQuery": "FilewallFile_CL | summarize Time=max(TimeGenerated)|where isnotempty(Time)"
        }
      ],
      "connectivityCriteria": [
        {
          "type": "HasDataConnectors"
        }
      ],
      "availability": {
        "isPreview": false
      },
      "permissions": {
        "resourceProvider": [
          {
            "provider": "Microsoft.OperationalInsights/workspaces",
            "permissionsDisplayText": "Read and Write permissions are required.",
            "providerDisplayName": "Workspace",
            "scope": "Workspace",
            "requiredPermissions": {
              "write": true,
              "read": true,
              "delete": true
            }
          }
        ],
        "customs": [
          {
            "name": "Filewall API access",
            "description": "A Filewall API key is required."
          }
        ]
      },
      "instructionSteps": [
        {
          "description": "Click **Add connection**, paste your Filewall API key, and click **Connect**. This will create 4 polling connections (Exchange, SharePoint, OneDrive, Teams).",
          "instructions": [
            {
              "type": "DataConnectorsGrid",
              "parameters": {
                "mapping": [
                  {
                    "columnName": "Connection",
                    "columnValue": "name"
                  },
                  {
                    "columnName": "API Endpoint",
                    "columnValue": "properties.request.apiEndpoint"
                  }
                ],
                "menuItems": [
                  "DeleteConnector"
                ]
              }
            },
            {
              "type": "ContextPane",
              "parameters": {
                "isPrimary": true,
                "label": "Add connection",
                "title": "Add connection",
                "subtitle": "Connect Filewall to Microsoft Sentinel",
                "contextPaneType": "DataConnectorsContextPane",
                "instructionSteps": [
                  {
                    "instructions": [
                      {
                        "type": "Textbox",
                        "parameters": {
                          "label": "API Endpoint URL",
                          "tooltip": "Enter the Filewall API endpoint.",
                          "placeholder": "API Endpoint URL",
                          "type": "text",
                          "name": "apiEndpoint",
                          "defaultValue": "https://api.filewall.com/api/v1/logs"
                        }
                      },
                      {
                        "type": "Textbox",
                        "parameters": {
                          "label": "Filewall API Key",
                          "tooltip": "Paste the Filewall API key from the Filewall admin console.",
                          "placeholder": "Paste your Filewall API key",
                          "type": "password",
                          "name": "apiKey"
                        }
                      }
                    ]
                  }
                ]
              }
            }
          ]
        }
      ]
    }
  }
}