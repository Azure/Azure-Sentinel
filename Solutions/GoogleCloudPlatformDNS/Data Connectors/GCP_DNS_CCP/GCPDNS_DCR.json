[
    {
        "name": "GCPDNSDCR",
        "apiVersion": "2021-09-01-preview",
        "type": "Microsoft.Insights/dataCollectionRules",
        "location": "{{location}}",
        "properties": {
            "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
            "streamDeclarations": {
                "Custom-GCPDNS": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "protoPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        },
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "jsonPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "TimeGenerated",
                            "type": "datetime"
                        }
                    ]
                }
            },
            "destinations": {
                "logAnalytics": [
                    {
                        "workspaceResourceId": "{{workspaceResourceId}}",
                        "name": "clv2ws1"
                    }
                ]
            },
            "dataFlows": [
                {
                    "streams": [
                        "Custom-GCPDNS"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source 
                    | extend protoPayloadDynamic = parse_json(protoPayload)
                    | extend resourceDynamic = parse_json(resource)
                    | extend jsonPayloadDynamic = parse_json(jsonPayload)
                    | extend insert_id = insertId 
                    | extend log_name = logName 
                    | extend payload__type = tostring(protoPayloadDynamic['@type']) 
                    | extend payload_authenticationInfo_principalEmail = tostring(protoPayloadDynamic['authenticationInfo']['principalEmail']) 
                    | extend payload_authenticationInfo_principalSubject = tostring(protoPayloadDynamic['authenticationInfo']['principalSubject']) 
                    | extend payload_authorizationInfo = tostring(protoPayloadDynamic['authorizationInfo']) 
                    | extend payload_methodName = tostring(protoPayloadDynamic['methodName']) 
                    | extend payload_request__type = tostring(protoPayloadDynamic['request']['@type']) 
                    | extend payload_request_change_additions = tostring(protoPayloadDynamic['request']['change']['additions']) 
                    | extend payload_request_change_deletions = tostring(protoPayloadDynamic['request']['change']['deletions']) 
                    | extend payload_request_managedZone_description = tostring(protoPayloadDynamic['request']['managedZone']['description']) 
                    | extend payload_request_managedZone_dnsName = tostring(protoPayloadDynamic['request']['managedZone']['dnsName']) 
                    | extend payload_request_managedZone_name = tostring(protoPayloadDynamic['request']['managedZone']['name']) 
                    | extend payload_request_managedZone = tostring(protoPayloadDynamic['request']['managedZone']) 
                    | extend payload_request_managedZone_visibility = tostring(protoPayloadDynamic['request']['managedZone']['visibility']) 
                    | extend payload_req_manZone_privVisibConfig_networks = tostring(protoPayloadDynamic['request']['managedZoneResource']['privateVisibilityConfig']['networks']) 
                    | extend payload_request_name = tostring(protoPayloadDynamic['request']['name']) 
                    | extend payload_request_project = tostring(protoPayloadDynamic['request']['project']) 
                    | extend payload_request_type = tostring(protoPayloadDynamic['request']['@type']) 
                    | extend payload_requestMetadata_callerIp = tostring(protoPayloadDynamic['requestMetadata']['callerIp']) 
                    | extend payload_reqmeta_callerSuppliedUserAgent = tostring(protoPayloadDynamic['requestMetadata']['callerSuppliedUserAgent']) 
                    | extend payload_reqmeta_requestAttributes_time = todatetime(protoPayloadDynamic['requestMetadata']['requestAttributes']['time']) 
                    | extend payload_resourceName = tostring(protoPayloadDynamic['resourceName']) 
                    | extend payload_response__type = tostring(protoPayloadDynamic['response']['@type']) 
                    | extend payload_response_change_deletions = tostring(protoPayloadDynamic['response']['change']['deletions']) 
                    | extend payload_response_change_id = tostring(protoPayloadDynamic['response']['change']['id']) 
                    | extend payload_response_change_startTime = todatetime(protoPayloadDynamic['response']['change']['startTime']) 
                    | extend payload_response_change_status = tostring(protoPayloadDynamic['response']['change']['status']) 
                    | extend payload_response_managedZone_creationTime = todatetime(protoPayloadDynamic['response']['managedZone']['creationTime']) 
                    | extend payload_response_managedZone_description = tostring(protoPayloadDynamic['response']['managedZone']['description']) 
                    | extend payload_response_managedZone_dnsName = tostring(protoPayloadDynamic['response']['managedZone']['dnsName']) 
                    | extend payload_response_managedZone_fingerprint = toguid(protoPayloadDynamic['response']['managedZone']['fingerprint']) 
                    | extend payload_response_managedZone_id = tostring(protoPayloadDynamic['response']['managedZone']['id']) 
                    | extend payload_response_managedZone_name = tostring(protoPayloadDynamic['response']['managedZone']['name']) 
                    | extend payload_response_managedZone_nameServers = tostring(protoPayloadDynamic['response']['managedZone']['nameServers']) 
                    | extend payload_resp_manZone_privVisibConfig_networks = tostring(protoPayloadDynamic['response']['managedZone']['privateVisibilityConfig']['networks']) 
                    | extend payload_response_managedZone_rrsetCount = todouble(protoPayloadDynamic['response']['managedZone']['rrsetCount']) 
                    | extend payload_response_managedZone_visibility = tostring(protoPayloadDynamic['response']['managedZone']['visibility']) 
                    | extend payload_response_operation_id = toguid(protoPayloadDynamic['response']['operation']['id']) 
                    | extend payload_response_operation_startTime = todatetime(protoPayloadDynamic['response']['operation']['startTime']) 
                    | extend payload_response_operation_status = tostring(protoPayloadDynamic['response']['operation']['status']) 
                    | extend payload_response_operation_type = tostring(protoPayloadDynamic['response']['operation']['type']) 
                    | extend payload_response_operation_user = tostring(protoPayloadDynamic['response']['operation']['user']) 
                    | extend payload_response_op_zoneContext_newValue = tostring(protoPayloadDynamic['response']['operation']['zoneContext']['newValue']) 
                    | extend payload_response_op_zoneContext_oldValue = tostring(protoPayloadDynamic['response']['operation']['zoneContext']['oldValue']) 
                    | extend payload_serviceName = tostring(protoPayloadDynamic['serviceName']) 
                    | extend payload_status_code = todouble(protoPayloadDynamic['status']['code']) 
                    | extend resource_labels_location = tostring(resourceDynamic['labels']['location']) 
                    | extend resource_labels_project_id = tostring(resourceDynamic['labels']['project_id']) 
                    | extend resource_labels_zone_name = tostring(resourceDynamic['labels']['zone_name']) 
                    | extend resource_type = tostring(resourceDynamic['type']) 
                    | extend payload_response_change_additions = tostring(protoPayloadDynamic['response']['change']['additions'])
                    | extend payload_req_manZone_cloudLogConfig_enableLogging = tobool(protoPayloadDynamic['request']['managedZone']['cloudLoggingConfig']['enableLogging'])
                    | extend payload_res_manZone_cloudLogConfig_enableLogging = tobool(protoPayloadDynamic['response']['managedZone']['cloudLoggingConfig']['enableLogging'])
                    | extend resource_labels_policy_name = tostring(resourceDynamic['labels']['policy_name'])
                    | extend resource_labels_target_type = tostring(resourceDynamic['labels']['target_type'])
                    | extend resource_labels_source_type = tostring(resourceDynamic['labels']['source_type'])
                    | extend resource_labels_target_name = tostring(resourceDynamic['labels']['target_name'])
                    | extend payload_vmProjectId = tostring(jsonPayloadDynamic['vmProjectId'])
                    | extend payload_protocol = tostring(jsonPayloadDynamic['protocol'])
                    | extend payload_queryType = tostring(jsonPayloadDynamic['queryType'])
                    | extend payload_rdata = tostring(jsonPayloadDynamic['rdata'])
                    | extend payload_vmInstanceId = todouble(jsonPayloadDynamic['vmInstanceId'])
                    | extend payload_vmInstanceIdString = tostring(jsonPayloadDynamic['vmInstanceIdString'])
                    | extend payload_vmInstanceName = tostring(jsonPayloadDynamic['vmInstanceName'])
                    | extend payload_responseCode = tostring(jsonPayloadDynamic['responseCode'])
                    | extend payload_authAnswer = tobool(jsonPayloadDynamic['authAnswer'])
                    | extend payload_queryName = tostring(jsonPayloadDynamic['queryName'])
                    | extend payload_vmZoneName = tostring(jsonPayloadDynamic['vmZoneName'])
                    | extend payload_sourceNetwork = tostring(jsonPayloadDynamic['sourceNetwork'])
                    | extend payload_serverLatency = todouble(jsonPayloadDynamic['serverLatency'])
                    | extend payload_sourceIP = tostring(jsonPayloadDynamic['sourceIP'])
                    | extend payload_destinationIP = tostring(jsonPayloadDynamic['destinationIP'])
                    | project-away insertId, logName, protoPayload, resource, jsonPayload",
                    "outputStream": "Custom-GCP_DNSV2_CL"
                }
            ]
        }
    }
]