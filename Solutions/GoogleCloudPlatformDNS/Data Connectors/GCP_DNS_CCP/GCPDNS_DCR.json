[
    {
        "name": "GCPDNSDCR",
        "apiVersion": "2021-09-01-preview",
        "type": "Microsoft.Insights/dataCollectionRules",
        "location": "{{location}}",
        "properties": {
            "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
            "streamDeclarations": {
                "Custom-GCPDNS": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "protoPayload",
                            "type": "string"
                        },
                        {
                            "name": "receiveTimestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "resource",
                            "type": "string"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        },
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "payload_type",
                            "type": "string"
                        },
                        {
                            "name": "payload_request_type",
                            "type": "string"
                        }
                    ]
                }
            },
            "destinations": {
                "logAnalytics": [
                    {
                        "workspaceResourceId": "{{workspaceResourceId}}",
                        "name": "clv2ws1"
                    }
                ]
            },
            "dataFlows": [
                {
                    "streams": [
                        "Custom-GCPDNS"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source| extend protoPayloadDynamic = parse_json(protoPayload)  | extend resourceDynamic = parse_json(resource) | extend payload_authenticationInfo_principalEmail = tostring(protoPayloadDynamic['authenticationInfo']['principalEmail'])| extend payload_method_name = tostring(protoPayloadDynamic['methodName'])| extend payload_service_name = tostring(protoPayloadDynamic['serviceName'])| extend resource_labels_location = tostring(resourceDynamic['labels']['location'])| extend resource_labels_project_id = tostring(resourceDynamic['labels']['project_id'])| extend resource_labels_zone_name = tostring(resourceDynamic['labels']['zone_name'])| extend TimeGenerated = receiveTimestamp| extend SourceSystem = tostring('CloudDNSAPI')| extend resource_type = tostring(resourceDynamic['type'])| extend payload_type = tostring(protoPayloadDynamic['@type'])| extend payload_requestMetadata_callerIp = tostring(protoPayloadDynamic['requestMetadata']['callerIp'])| extend payload_authorizationInfo = tostring(protoPayloadDynamic['authorizationInfo'])| extend payload_resourceName = tostring(protoPayloadDynamic['resourceName'])| extend payload_request_type = tostring(protoPayloadDynamic['request']['@type'])| extend payload_request_project = tostring(protoPayloadDynamic['request']['project']) | extend payload_request_managedZone = tostring(protoPayloadDynamic['request']['managedZone'])| project insertId, timestamp, TimeGenerated, logName, severity, payload_authenticationInfo_principalEmail, payload_method_name, payload_service_name, resource_labels_location, resource_labels_project_id, resource_labels_zone_name, SourceSystem, resource_type, payload__type, payload_requestMetadata_callerIp, payload_authorizationInfo, payload_resourceName, payload_request_type, payload_request_project, payload_request_managedZone",
                    "outputStream": "Custom-GCP_DNS_CL"
                }
            ]
        }
    }
]
