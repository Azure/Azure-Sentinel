[
    {
        "name": "GCPDNSDCR",
        "apiVersion": "2021-09-01-preview",
        "type": "Microsoft.Insights/dataCollectionRules",
        "location": "{{location}}",
        "properties": {
            "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
            "streamDeclarations": {
                "Custom-GCPDNS": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "protoPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        },
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "jsonPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "TimeGenerated",
                            "type": "datetime"
                        }
                    ]
                }
            },
            "destinations": {
                "logAnalytics": [
                    {
                        "workspaceResourceId": "{{workspaceResourceId}}",
                        "name": "clv2ws1"
                    }
                ]
            },
            "dataFlows": [
                {
                    "streams": [
                        "Custom-GCPDNS"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source | extend ProtoPayloadDynamic = parse_json(protoPayload) | extend  ResourceDynamic = parse_json(resource) | extend JsonPayloadDynamic = parse_json(jsonPayload) | extend InsertId = insertId, LogName = logName, Severity = severity, Timestamp = timestamp, PayloadType = tostring(ProtoPayloadDynamic['@type']), AuthenticationInfoPrincipalEmail = tostring(ProtoPayloadDynamic['authenticationInfo']['principalEmail']), AuthenticationInfoPrincipalSubject = tostring(ProtoPayloadDynamic['authenticationInfo']['principalSubject']), AuthorizationInfo = tostring(ProtoPayloadDynamic['authorizationInfo']), MethodName = tostring(ProtoPayloadDynamic['methodName']), RequestAPIType = tostring(ProtoPayloadDynamic['request']['@type']), RequestChangeAdditions = tostring(ProtoPayloadDynamic['request']['change']['additions']), RequestChangeDeletions = tostring(ProtoPayloadDynamic['request']['change']['deletions']), RequestManagedZoneDescription = tostring(ProtoPayloadDynamic['request']['managedZone']['description']), RequestManagedZoneDnsName = tostring(ProtoPayloadDynamic['request']['managedZone']['dnsName']), RequestManagedZoneName = tostring(ProtoPayloadDynamic['request']['managedZone']['name']), RequestManagedZone = tostring(ProtoPayloadDynamic['request']['managedZone']), RequestManagedZoneVisibility = tostring(ProtoPayloadDynamic['request']['managedZone']['visibility']), ReqManZonePrivVisibConfigNetworks = tostring(ProtoPayloadDynamic['request']['managedZoneResource']['privateVisibilityConfig']['networks']), RequestName = tostring(ProtoPayloadDynamic['request']['name']), RequestProject = tostring(ProtoPayloadDynamic['request']['project']), RequestType = tostring(ProtoPayloadDynamic['request']['type']), RequestMetadataCallerIp = tostring(ProtoPayloadDynamic['requestMetadata']['callerIp']), ReqmetaCallerSuppliedUserAgent = tostring(ProtoPayloadDynamic['requestMetadata']['callerSuppliedUserAgent']), ReqmetaRequestAttributesTime = todatetime(ProtoPayloadDynamic['requestMetadata']['requestAttributes']['time']), ResourceName = tostring(ProtoPayloadDynamic['resourceName']), ResponseType = tostring(ProtoPayloadDynamic['response']['@type']), ResponseChangeDeletions = tostring(ProtoPayloadDynamic['response']['change']['deletions']), ResponseChangeId = tostring(ProtoPayloadDynamic['response']['change']['id']), ResponseChangeStartTime = todatetime(ProtoPayloadDynamic['response']['change']['startTime']), ResponseChangeStatus = tostring(ProtoPayloadDynamic['response']['change']['status']), ResponseManagedZoneCreationTime = todatetime(ProtoPayloadDynamic['response']['managedZone']['creationTime']), ResponseManagedZoneDescription = tostring(ProtoPayloadDynamic['response']['managedZone']['description']), ResponseManagedZoneDnsName = tostring(ProtoPayloadDynamic['response']['managedZone']['dnsName']), ResponseManagedZoneFingerprint = toguid(ProtoPayloadDynamic['response']['managedZone']['fingerprint']), ResponseManagedZoneId = tostring(ProtoPayloadDynamic['response']['managedZone']['id']), ResponseManagedZoneName = tostring(ProtoPayloadDynamic['response']['managedZone']['name']), ResponseManagedZoneNameServers = tostring(ProtoPayloadDynamic['response']['managedZone']['nameServers']), RespManZonePrivVisibConfigNetworks = tostring(ProtoPayloadDynamic['response']['managedZone']['privateVisibilityConfig']['networks']), ResponseManagedZoneRrsetCount = todouble(ProtoPayloadDynamic['response']['managedZone']['rrsetCount']), ResponseManagedZoneVisibility = tostring(ProtoPayloadDynamic['response']['managedZone']['visibility']), ResponseOperationId = toguid(ProtoPayloadDynamic['response']['operation']['id']), ResponseOperationStartTime = todatetime(ProtoPayloadDynamic['response']['operation']['startTime']), ResponseOperationStatus = tostring(ProtoPayloadDynamic['response']['operation']['status']), ResponseOperationType = tostring(ProtoPayloadDynamic['response']['operation']['type']), ResponseOperationUser = tostring(ProtoPayloadDynamic['response']['operation']['user']), ResponseOpZoneContextNewValue = tostring(ProtoPayloadDynamic['response']['operation']['zoneContext']['newValue']), ResponseOpZoneContextOldValue = tostring(ProtoPayloadDynamic['response']['operation']['zoneContext']['oldValue']), ServiceName = tostring(ProtoPayloadDynamic['serviceName']), StatusCode = todouble(ProtoPayloadDynamic['status']['code']), ResourceLabelsLocation = tostring(ResourceDynamic['labels']['location']), ResourceLabelsProjectId = tostring(ResourceDynamic['labels']['project_id']), ResourceLabelsZoneName = tostring(ResourceDynamic['labels']['zone_name']), ResourceType = tostring(ResourceDynamic['type']), ResponseChangeAdditions = tostring(ProtoPayloadDynamic['response']['change']['additions']), ReqManZoneCloudLogConfigEnableLogging = tobool(ProtoPayloadDynamic['request']['managedZone']['cloudLoggingConfig']['enableLogging']), ResManZoneCloudLogConfigEnableLogging = tobool(ProtoPayloadDynamic['response']['managedZone']['cloudLoggingConfig']['enableLogging']), ResourceLabelsPolicyName = tostring(ResourceDynamic['labels']['policy_name']), ResourceLabelsTargetType = tostring(ResourceDynamic['labels']['target_type']), ResourceLabelsSourceType = tostring(ResourceDynamic['labels']['source_type']), ResourceLabelsTargetName = tostring(ResourceDynamic['labels']['target_name']), VmProjectId = tostring(JsonPayloadDynamic['vmProjectId']), Protocol = tostring(JsonPayloadDynamic['protocol']), QueryType = tostring(JsonPayloadDynamic['queryType']), Rdata = tostring(JsonPayloadDynamic['rdata']), VmInstanceId = todouble(JsonPayloadDynamic['vmInstanceId']), VmInstanceIdString = tostring(JsonPayloadDynamic['vmInstanceIdString']), VmInstanceName = tostring(JsonPayloadDynamic['vmInstanceName']), ResponseCode = tostring(JsonPayloadDynamic['responseCode']), AuthAnswer = tobool(JsonPayloadDynamic['authAnswer']), QueryName = tostring(JsonPayloadDynamic['queryName']), VmZoneName = tostring(JsonPayloadDynamic['vmZoneName']), SourceNetwork = tostring(JsonPayloadDynamic['sourceNetwork']), ServerLatency = todouble(JsonPayloadDynamic['serverLatency']), SourceIP = tostring(JsonPayloadDynamic['sourceIP']), DestinationIP = tostring(JsonPayloadDynamic['destinationIP']) | project-away protoPayload, resource, jsonPayload",
                    "outputStream": "Custom-GCP_DNSV2_CL"
                }
            ]
        }
    }
]