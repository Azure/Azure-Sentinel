{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Pathlock",
    "comments": "Solution template for plc-event-logging-solution"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`. We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "PLC Event Logging Workbook",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "_solutionVersion": "3.0.0",
    "solutionId": "pathlockinc1631410274035.azure-sentinel-solution-plc",
    "_solutionId": "[variables('solutionId')]",
    "_dataConnectorVersion1": "1.0.0",
    "_dataConnectorContentId1": "PLCEventLogging",
    "uiConfigId1": "[guid(resourceGroup().id, 'PLCEventLoggingUiId')]",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1'))))]",
    "_dataConnectorTemplateSpecName1": "[variables('dataConnectorTemplateSpecName1')]",
    "workbookContentId1": "PLCEventLoggingWorkbook",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookTemplateSpecName1": "[variables('workbookTemplateSpecName1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_workspaceResourceId": "[variables('workspaceResourceId')]",
    "solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]",
    "_solutioncontentProductId": "[variables('solutioncontentProductId')]",
    "workbookVersion1": "1.0.0"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('_dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [],
      "properties": {
        "description": "plc-event-logging-solution data connector with template version 3.0.0",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "contentSchemaVersion": "1.0.0",
		"packageId": "[variables('_solutioncontentProductId')]",
		        "packageVersion": "[variables('_solutionVersion')]",
        "version": "3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('_dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "$schema": "https://aka.ms/sentinelConnectorDefinitionSchema",
                  "id": "[variables('_uiConfigId1')]",
                  "connectorId": "PLCEventLogging",
                  "connectorVersion": "1.0.0",
                  "name": "PLC Event Logging",
                  "publisher": "Pathlock Inc.",
                  "descriptionMarkdown": "This connector ingests PLC event logs from Pathlock via Azure Monitor Data Collection Endpoint (DCE) and Data Collection Rule (DCR).",
                  "graphQueriesTableName": "PLCEventLogging_CL",
                  "graphQueries": [
                    {
                      "metricName": "Total events",
                      "legend": "PLC Event Logs",
                      "baseQuery": "PLCEventLogging_CL | count"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('_workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [],
      "properties": {
        "description": "PLCEventLoggingWorkbook Workbook with template version 3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentProductId": "[variables('_solutioncontentProductId')]",
		 "packageId": "[variables('_solutioncontentProductId')]",
		 "packageVersion": "[variables('_solutionVersion')]",
        "contentSchemaVersion": "1.0.0",
        "version": "3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "sourceId": "[variables('_workspaceResourceId')]"
              }
            }
          ]
        }
      }
    },    
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]",
      "properties": {
        "version": "3.0.0",
        "kind": "Solution",
        "displayName": "plc-event-logging-solution",
        "contentId": "[variables('_solutionId')]",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "contentSchemaVersion": "1.0.0",
        "packageId": "[variables('_solutioncontentProductId')]",
        "packageVersion": "[variables('_solutionVersion')]"
      }
    }
  ],
  "outputs": {}
}
