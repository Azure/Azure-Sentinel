// Usage Instruction : 
// Paste below query in log analytics, click on Save button and select as Function from drop down by specifying function name and alias as CiscoDuo.
// Function usually takes 10-15 minutes to activate. You can then use function alias from any other queries (e.g. CiscoDuo | take 10).
// Reference : Using functions in Azure monitor log queries : https://docs.microsoft.com/azure/azure-monitor/log-query/functions
CiscoDuo_CL
| extend EventVendor = 'Cisco'
| extend EventProduct = 'Duo Security'
| extend parse_json(description_s)
| extend SrcDvcType=description_s['device'],
    SrcIpAddr=iff(isnotempty(description_s), description_s['ip_address'], access_device_ip_s),
    DstUserName=iff(isnotempty(username_s), username_s, user_name_s),
    SrcUserName=object_s,
    EventType=iff(isnotempty(eventtype_s), eventtype_s, event_type_s),
    EventEndTime=unixtime_seconds_todatetime(tolong(timestamp_d)),
    HttpUserAgentOriginal = description_s['user_agent']
| extend AccessDvcSecurityAgents=column_ifexists( "access_device_security_agents_s" , "")
	   , TrustedEndpointStatus=column_ifexists( "trusted_endpoint_status_s", "")
	   , SurfacedAuthAccessDeviceSecurityAgents=column_ifexists( "surfaced_auth_access_device_security_agents_s", "")
| project-rename DvcAction=action_s,
    DvcHostname=host_s,
    SrcGeoCountry=access_device_location_country_s,
    SrcGeoCity=access_device_location_city_s,
    SrcDvcOs=access_device_os_s,
    DstGeoRegion=state_s,
    EventResult=result_s,
    EventResultDetails=reason_s,
    AuthDeviceCountry=auth_device_location_country_s,
    AuthFactor=factor_s,
    AccessDvcIpAddr=access_device_ip_s,
    AccessDvcBrowser=access_device_browser_s,
    AccessDvcBrowserVersion=access_device_browser_version_s,
    AccessDvcFlashVersion=access_device_flash_version_s,
    AccessDvcEncryptionEnabled=access_device_is_encryption_enabled_s,
    AccessDvcFirewallEnabled=access_device_is_firewall_enabled_s,
    AccessDvcPasswordSet=access_device_is_password_set_s,
    AccessDvcJavaVersion=access_device_java_version_s,
    AccessDvcLocationState=access_device_location_state_s,
    AccessDvcOsVersion=access_device_os_version_s,
    Alias=alias_s,
    User=email_s,
    SrcAppId=application_key_s,
    SrcAppName=application_name_s,
    DvcIpAddr=auth_device_ip_s,
    AuthDeviceCity=auth_device_location_city_s,
    AuthDeviceState=auth_device_location_state_s,
    SrcHostname=auth_device_name_s,
    TransactionId=txid_g,
    UserGroups=user_groups_s,
    Explanations=explanations_s,
    FromCommonNetblock=from_common_netblock_b,
    FromNewUser=from_new_user_b,
    SrcUserId=user_key_s,
    SrcRiskLevel=low_risk_ip_b,
    PriorityEvent=priority_event_b,
    PriorityReasons=priority_reasons_s,
    Sekey=sekey_s,
    SurfacedAuthAccessDeviceBrowser=surfaced_auth_access_device_browser_s,
    SurfacedAuthAccessDeviceBrowserVersion=surfaced_auth_access_device_browser_version_s,
    SurfacedAuthAccessDeviceIp=surfaced_auth_access_device_ip_s,
    SurfacedAuthAccessDeviceEncryptionEnabled=surfaced_auth_access_device_is_encryption_enabled_s,
    SurfacedAuthAccessDeviceFirewallEnabled=surfaced_auth_access_device_is_firewall_enabled_s,
    SurfacedAuthAccessDevicePasswordSet=surfaced_auth_access_device_is_password_set_s,
    SurfacedAuthAccessDeviceLocationCity=surfaced_auth_access_device_location_city_s,
    SurfacedAuthAccessDeviceLocationCountry=surfaced_auth_access_device_location_country_s,
    SurfacedAuthAccessDeviceLocationState=surfaced_auth_access_device_location_state_s,
    SurfacedAuthAccessDeviceOs=surfaced_auth_access_device_os_s,
    SurfacedAuthAccessDeviceOsVersion_s=surfaced_auth_access_device_os_version_s,
    SurfacedAuthAlias=surfaced_auth_alias_s,
    SurfacedAuthApplicationKey=surfaced_auth_application_key_s,
    SurfacedAuthApplicationName=surfaced_auth_application_name_s,
    SurfacedAuthEmail=surfaced_auth_email_s,
    SurfacedAuthFactor=surfaced_auth_factor_s,
    SurfacedAuthIsotimestamp=surfaced_auth_isotimestamp_t,
    SurfacedAuthOodSoftware_s=surfaced_auth_ood_software_s,
    SurfacedAuthReason=surfaced_auth_reason_s,
    SurfacedAuthResult=surfaced_auth_result_s,
    SurfacedAuthTimestamp=surfaced_auth_timestamp_d,
    SurfacedAuthTransactionId=surfaced_auth_txid_g,
    SurfacedAuthUserGroups=surfaced_auth_user_groups_s,
    SurfacedAuthUserKey=surfaced_auth_user_key_s,
    SurfacedAuthUserName=surfaced_auth_user_name_s,
    SurfacedTimestamp=surfaced_timestamp_d,
    EventUid=triage_event_uri_s,
    TriagedAsInteresting=triaged_as_interesting_b,
    Context=context_s,
    Credits=credits_d,
    IsoTimestamp=isotimestamp_t,
    Phone=phone_s,
    SrcDomainType=type_s
    