{
    "name": "AWSS3VPCFlowLogsDCR",
    "apiVersion": "2023-03-11",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "{{location}}",
    "properties": {
        "streamDeclarations": {
            "Custom-VPCFlowLogsParquet": {
                "columns": [
                    {
                        "name": "version",
                        "type": "dynamic"
                    },
                    {
                        "name": "account-id",
                        "type": "string"
                    },
                    {
                        "name": "account_id",
                        "type": "string"
                    },
                    {
                        "name": "interface-id",
                        "type": "string"
                    },
                    {
                        "name": "interface_id",
                        "type": "string"
                    },
                    {
                        "name": "srcaddr",
                        "type": "string"
                    },
                    {
                        "name": "dstaddr",
                        "type": "string"
                    },
                    {
                        "name": "srcport",
                        "type": "dynamic"
                    },
                    {
                        "name": "dstport",
                        "type": "dynamic"
                    },
                    {
                        "name": "protocol",
                        "type": "dynamic"
                    },
                    {
                        "name": "packets",
                        "type": "dynamic"
                    },
                    {
                        "name": "bytes",
                        "type": "dynamic"
                    },
                    {
                        "name": "start",
                        "type": "dynamic"
                    },
                    {
                        "name": "end",
                        "type": "dynamic"
                    },
                    {
                        "name": "action",
                        "type": "string"
                    },
                    {
                        "name": "log_status",
                        "type": "string"
                    },
                    {
                        "name": "log-status",
                        "type": "string"
                    },
                    {
                        "name": "vpc-id",
                        "type": "string"
                    },
                    {
                        "name": "vpc_id",
                        "type": "string"
                    },
                    {
                        "name": "subnet-id",
                        "type": "string"
                    },
                    {
                        "name": "subnet_id",
                        "type": "string"
                    },
                    {
                        "name": "instance-id",
                        "type": "string"
                    },
                    {
                        "name": "instance_id",
                        "type": "string"
                    },
                    {
                        "name": "tcp-flags",
                        "type": "string"
                    },
                    {
                        "name": "tcp_flags",
                        "type": "string"
                    },
                    {
                        "name": "type",
                        "type": "string"
                    },
                    {
                        "name": "pkt-srcaddr",
                        "type": "string"
                    },
                    {
                        "name": "pkt_srcaddr",
                        "type": "string"
                    },
                    {
                        "name": "pkt-dstaddr",
                        "type": "string"
                    },
                    {
                        "name": "pkt_dstaddr",
                        "type": "string"
                    },
                    {
                        "name": "region",
                        "type": "string"
                    },
                    {
                        "name": "az-id",
                        "type": "string"
                    },
                    {
                        "name": "az_id",
                        "type": "string"
                    },
                    {
                        "name": "sublocation-type",
                        "type": "string"
                    },
                    {
                        "name": "sublocation_type",
                        "type": "string"
                    },
                    {
                        "name": "sublocation-id",
                        "type": "string"
                    },
                    {
                        "name": "sublocation_id",
                        "type": "string"
                    },
                    {
                        "name": "pkt-src-aws-service",
                        "type": "string"
                    },
                    {
                        "name": "pkt_src_aws_service",
                        "type": "string"
                    },
                    {
                        "name": "pkt-dst-aws-service",
                        "type": "string"
                    },
                    {
                        "name": "pkt_dst_aws_service",
                        "type": "string"
                    },
                    {
                        "name": "flow-direction",
                        "type": "string"
                    },
                    {
                        "name": "flow_direction",
                        "type": "string"
                    },
                    {
                        "name": "traffic-path",
                        "type": "string"
                    },
                    {
                        "name": "traffic_path",
                        "type": "string"
                    },
                    {
                        "name": "ecs-cluster-arn",
                        "type": "string"
                    },
                    {
                        "name": "ecs_cluster_arn",
                        "type": "string"
                    },
                    {
                        "name": "ecs-cluster-name",
                        "type": "string"
                    },
                    {
                        "name": "ecs_cluster_name",
                        "type": "string"
                    },
                    {
                        "name": "ecs-container-instance-arn",
                        "type": "string"
                    },
                    {
                        "name": "ecs_container_instance_arn",
                        "type": "string"
                    },
                    {
                        "name": "ecs-container-instance-id",
                        "type": "string"
                    },
                    {
                        "name": "ecs_container_instance_id",
                        "type": "string"
                    },
                    {
                        "name": "ecs-container-id",
                        "type": "string"
                    },
                    {
                        "name": "ecs_container_id",
                        "type": "string"
                    },
                    {
                        "name": "ecs-second-container-id",
                        "type": "string"
                    },
                    {
                        "name": "ecs_second_container_id",
                        "type": "string"
                    },
                    {
                        "name": "ecs-service-name",
                        "type": "string"
                    },
                    {
                        "name": "ecs_service_name",
                        "type": "string"
                    },
                    {
                        "name": "ecs-task-definition-arn",
                        "type": "string"
                    },
                    {
                        "name": "ecs_task_definition_arn",
                        "type": "string"
                    },
                    {
                        "name": "ecs-task-arn",
                        "type": "string"
                    },
                    {
                        "name": "ecs_task_arn",
                        "type": "string"
                    },
                    {
                        "name": "ecs-task-id",
                        "type": "string"
                    },
                    {
                        "name": "ecs_task_id",
                        "type": "string"
                    }
                ]
            }
        },
        "destinations": {
            "logAnalytics": [
                {
                    "workspaceResourceId": "{{workspaceResourceId}}",
                    "name": "clv2ws1"
                }
            ]
        },
        "dataFlows": [
            {
                "streams": [
                    "Custom-VPCFlowLogsParquet"
                ],
                "destinations": [
                    "clv2ws1"
                ],
                "transformKql": "let unixTimeSecondsToDatetime = (unixTime:string) { datetime(1970-01-01) + tolong(unixTime) * 1sec }; source | project TimeGenerated = iff(isnull(tostring(start)), now(), unixTimeSecondsToDatetime(tostring(start))), Version = toint(tostring(version)), AccountId = iff(isnotempty(tostring(account_id)), tostring(account_id), tostring(['account-id'])), InterfaceId = iff(isnotempty(tostring(interface_id)), tostring(interface_id), tostring(['interface-id'])), SrcAddr = tostring(srcaddr), DstAddr = tostring(dstaddr), SrcPort = toint(tostring(srcport)), DstPort = toint(tostring(dstport)), Protocol = toint(tostring(protocol)), Packets = toint(tostring(packets)), Bytes = tolong(tostring(bytes)), End = unixTimeSecondsToDatetime(tostring(end)), Action = tostring(action), LogStatus = iff(isnotempty(tostring(log_status)), tostring(log_status), tostring(['log-status'])), VpcId = iff(isnotempty(tostring(vpc_id)), tostring(vpc_id), tostring(['vpc-id'])), SubnetId = iff(isnotempty(tostring(subnet_id)), tostring(subnet_id), tostring(['subnet-id'])), InstanceId = iff(isnotempty(tostring(instance_id)), tostring(instance_id), tostring(['instance-id'])), TcpFlags = iff(isnotempty(tostring(tcp_flags)), toint(tostring(tcp_flags)), toint(tostring(['tcp-flags']))), TrafficType = tostring(type), PktSrcAddr = iff(isnotempty(tostring(pkt_srcaddr)), tostring(pkt_srcaddr), tostring(['pkt-srcaddr'])), PktDstAddr = iff(isnotempty(tostring(pkt_dstaddr)), tostring(pkt_dstaddr), tostring(['pkt-dstaddr'])), Region = tostring(region), AzId = iff(isnotempty(tostring(az_id)), tostring(az_id), tostring(['az-id'])), SublocationType = iff(isnotempty(tostring(sublocation_type)), tostring(sublocation_type), tostring(['sublocation-type'])), SublocationId = iff(isnotempty(tostring(sublocation_id)), tostring(sublocation_id), tostring(['sublocation-id'])), PktSrcAwsService = iff(isnotempty(tostring(pkt_src_aws_service)), tostring(pkt_src_aws_service), tostring(['pkt-src-aws-service'])), PktDstAwsService = iff(isnotempty(tostring(pkt_dst_aws_service)), tostring(pkt_dst_aws_service), tostring(['pkt-dst-aws-service'])), FlowDirection = iff(isnotempty(tostring(flow_direction)), tostring(flow_direction), tostring(['flow-direction'])), TrafficPath = iff(isnotempty(tostring(traffic_path)), tostring(traffic_path), tostring(['traffic-path'])), EcsClusterArn = iff(isnotempty(tostring(ecs_cluster_arn)), tostring(ecs_cluster_arn), tostring(['ecs-cluster-arn'])), EcsClusterName = iff(isnotempty(tostring(ecs_cluster_name)), tostring(ecs_cluster_name), tostring(['ecs-cluster-name'])), EcsContainerInstanceArn = iff(isnotempty(tostring(ecs_container_instance_arn)), tostring(ecs_container_instance_arn), tostring(['ecs-container-instance-arn'])), EcsContainerInstanceId = iff(isnotempty(tostring(ecs_container_instance_id)), tostring(ecs_container_instance_id), tostring(['ecs-container-instance-id'])), EcsContainerId = iff(isnotempty(tostring(ecs_container_id)), tostring(ecs_container_id), tostring(['ecs-container-id'])), EcsSecondContainerId = iff(isnotempty(tostring(ecs_second_container_id)), tostring(ecs_second_container_id), tostring(['ecs-second-container-id'])), EcsServiceName = iff(isnotempty(tostring(ecs_service_name)), tostring(ecs_service_name), tostring(['ecs-service-name'])), EcsTaskDefinitionArn = iff(isnotempty(tostring(ecs_task_definition_arn)), tostring(ecs_task_definition_arn), tostring(['ecs-task-definition-arn'])), EcsTaskArn = iff(isnotempty(tostring(ecs_task_arn)), tostring(ecs_task_arn), tostring(['ecs-task-arn'])), EcsTaskId = iff(isnotempty(tostring(ecs_task_id)), tostring(ecs_task_id), tostring(['ecs-task-id']))",
                "outputStream": "Microsoft-AWSVPCFlow"
            }
        ],
        "dataCollectionEndpointId": "{{dataCollectionEndpointId}}"
    }
}