{
  "name": "AwsELBLogsDefinition",
  "apiVersion": "2022-09-01-preview",
  "type": "Microsoft.SecurityInsights/dataConnectorDefinitions",
  "location": "{{location}}",
  "kind": "Customizable",
  "properties": {
    "connectorUiConfig": {
      "id": "AwsELBLogsDefinition",
      "title": "AWS ELB Logs",
      "logo": "amazon_web_services_Logo.svg",
      "publisher": "Microsoft",
      "providerDisplayName": "Amazon Web Services",
      "descriptionMarkdown": "This connector allows you to ingest AWS Elastic Load Balancer (ALB and NLB) logs into Microsoft Sentinel. These logs contain detailed records for requests handled by your load balancers, including client IPs, latencies, request paths, and status codes. These logs are useful for monitoring traffic patterns, investigating anomalies, and ensuring security compliance.",
      "graphQueriesTableName": "AWSALBAccessLogs_CL",
      "graphQueries": [
        {
          "metricName": "Total ALB logs received",
          "legend": "AWS ALB Logs",
          "baseQuery": "AWSALBAccessLogs_CL"
        },
        {
          "metricName": "Total NLB Access logs received",
          "legend": "AWS NLB Access Logs",
          "baseQuery": "AWSNLBAccessLogs_CL"
        },
        {
          "metricName": "Total Flow logs received",
          "legend": "AWS Flow Logs",
          "baseQuery": "AWSELBFlowLogs_CL"
        }
      ],
      "sampleQueries": [
        {
          "description": "Get ALB log samples",
          "query": "AWSALBAccessLogs_CL\n | take 10"
        },
        {
          "description": "Get NLB log samples",
          "query": "AWSNLBAccessLogs_CL\n | take 10"
        },
        {
          "description": "Get Flow log samples",
          "query": "AWSELBFlowLogs_CL\n | take 10"
        }
      ],
      "dataTypes": [
        {
          "name": "AWSALBAccessLogs_CL",
          "lastDataReceivedQuery": "AWSALBAccessLogs_CL\n | where TimeGenerated > ago(12h) | summarize LastReceived=max(TimeGenerated)"
        },
        {
          "name": "AWSNLBAccessLogs_CL",
          "lastDataReceivedQuery": "AWSNLBAccessLogs_CL\n | where TimeGenerated > ago(12h) | summarize LastReceived=max(TimeGenerated)"
        },
        {
          "name": "AWSELBFlowLogs_CL",
          "lastDataReceivedQuery": "AWSELBFlowLogs_CL\n | where TimeGenerated > ago(12h) | summarize LastReceived=max(TimeGenerated)"
        }
      ],
      "connectivityCriteria": [
        {
          "type": "HasDataConnectors",
          "value": null
        }
      ],
      "availability": {
        "status": 1,
        "isPreview": false
      },
      "permissions": {
        "resourceProvider": [
          {
            "provider": "Microsoft.OperationalInsights/workspaces",
            "providerDisplayName": "Workspace",
            "permissionsDisplayText": "Read and Write permissions are required.",
            "scope": "Workspace",
            "requiredPermissions": {
              "read": true,
              "write": true,
              "delete": true,
              "action": false
            }
          },
          {
            "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
            "providerDisplayName": "Keys",
            "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
            "scope": "Workspace",
            "requiredPermissions": {
              "read": false,
              "write": false,
              "delete": false,
              "action": true
            }
          }
        ],
        "customs": [
          {
            "name": "Environment",
            "description": "You must have the following AWS resources defined and configured: S3 Bucket, Simple Queue Service (SQS), IAM roles and permissions policies."
          }
        ]
      },
      "instructionSteps": [
        {
          "instructions": [
            {
              "type": "Markdown",
              "parameters": {
                "content": "### 1. AWS CloudFormation Deployment \n To configure access on AWS, use CloudFormation templates to set up the environment to send logs from ALB and NLB to your Log Analytics Workspace."
              }
            },
            {
              "type": "Markdown",
              "parameters": {
                "content": "#### Deployment steps: \n 1. Download the [CloudFormation Templates](https://github.com/Alekhya0824/GithubValidationREPO/tree/main/AWS%20ELB%20Logs/CloudFormationTemplates). \n 2. Go to [AWS CloudFormation Stacks](https://aka.ms/awsCloudFormationLink#/stacks/create). \n 3. Create the stacks using the downloaded templates. \n 4. Note down the Role ARN and SQS Queue URLs."
              }
            },
            {
              "type": "Markdown",
              "parameters": {
                "content": "### 2. Connect new collectors \n To enable the connector, click **Add new collector**, enter the required details, and click **Connect**."
              }
            }
          ]
        },
        {
          "instructions": [
              {
                  "type": "DataConnectorsGrid",
                  "parameters": {
                      "mapping": [
                          {
                              "columnValue": "properties.roleArn",
                              "columnName": "Role ARN"
                          },
                          {
                              "columnValue": "properties.sqsUrls[0]",
                              "columnName": "Queue URL"
                          },
                          {
                              "columnValue": "properties.dcrConfig.streamName",
                              "columnName": "Stream name"
                          }
                      ],
                      "menuItems": [
                          "DeleteConnector"
                      ]
                  }
              },
              {
                  "type": "ContextPane",
                  "parameters": {
                      "contextPaneType": "DataConnectorsContextPane",
                      "title": "Add new controller",
                      "subtitle": "AWS S3 connector",
                      "label": "Add new collector",
                      "instructionSteps": [
                          {
                              "title": "Account details",
                              "instructions": [
                                  {
                                      "type": "Textbox",
                                      "parameters": {
                                          "label": "Role ARN",
                                          "type": "text",
                                          "name": "roleArn",
                                          "validations": {
                                              "required": true
                                          }
                                      }
                                  },
                                  {
                                      "type": "Textbox",
                                      "parameters": {
                                          "label": "Queue URL",
                                          "type": "text",
                                          "name": "queueUrl",
                                          "validations": {
                                              "required": true
                                          }
                                      }
                                  },
                                  {
                                      "type": "Dropdown",
                                      "parameters": {
                                          "label": "Data type",
                                          "type": "text",
                                          "name": "streamName",
                                          "required": true,
                                          "placeholder": "Select a data type",
                                          "options": [
                                            {
                                              "key": "Custom-AWSALBAccessLogsStream",
                                              "text": "ALB Access Logs "
                                          },
                                          {
                                              "key": "Custom-AWSNLBAccessLogsStream",
                                              "text": "NLB Access Logs"
                                          },
                                          {
                                              "key": "Custom-AWSNLBFlowLogsStream",
                                              "text": "NLb Flow Logs"
                                          },
                                          {
                                              "key": "Custom-AWSGLBFlowLogsStream",
                                              "text": "GLB Flow Logs"
                                          }
                                          ]
                                      }
                                  }
                              ]
                          }
                      ]
                  }
              }
          ]
      }
  ]
}
}
}