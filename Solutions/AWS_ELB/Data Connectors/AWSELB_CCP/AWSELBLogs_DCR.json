{
    "name": "ALBLogsDCR",
    "apiVersion": "2021-09-01-preview",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "{{location}}",
    "properties": {
      "streamDeclarations": {
        "Custom-AWSALBAccessLogsStream": {
          "columns": [
            { "name": "Field1", "type": "string" },
            { "name": "Field2", "type": "datetime" },
            { "name": "Field3", "type": "string" },
            { "name": "Field4", "type": "string" },
            { "name": "Field5", "type": "string" },
            { "name": "Field6", "type": "string" },
            { "name": "Field7", "type": "string" },
            { "name": "Field8", "type": "string" },
            { "name": "Field9", "type": "int" },
            { "name": "Field10", "type": "string" },
            { "name": "Field11", "type": "long" },
            { "name": "Field12", "type": "long" },
            { "name": "Field13", "type": "string" },
            { "name": "Field14", "type": "string" },
            { "name": "Field15", "type": "string" },
            { "name": "Field16", "type": "string" },
            { "name": "Field17", "type": "string" },
            { "name": "Field18", "type": "string" },
            { "name": "Field19", "type": "string" },
            { "name": "Field20", "type": "string" },
            { "name": "Field21", "type": "string" },
            { "name": "Field22", "type": "string" },
            { "name": "Field23", "type": "string" },
            { "name": "Field24", "type": "string" },
            { "name": "Field25", "type": "string" },
            { "name": "Field26", "type": "string" },
            { "name": "Field27", "type": "string" },
            { "name": "Field28", "type": "string" },
            { "name": "Field29", "type": "string" },
            { "name": "Field30", "type": "string" },
            { "name": "Field31", "type": "string" },
            { "name": "Field32", "type": "string" },
            { "name": "Field33", "type": "string" },
            { "name": "Field34", "type": "string" }
          ]
        },
        "Custom-AWSNLBAccessLogsStream": {
          "columns": [
            { "name": "Field1", "type": "string" },
            { "name": "Field2", "type": "string" },
            { "name": "Field3", "type": "datetime" },
            { "name": "Field4", "type": "string" },
            { "name": "Field5", "type": "string" },
            { "name": "Field6", "type": "string" },
            { "name": "Field7", "type": "string" },
            { "name": "Field8", "type": "long" },
            { "name": "Field9", "type": "string" },
            { "name": "Field10", "type": "long" },
            { "name": "Field11", "type": "long" },
            { "name": "Field12", "type": "string" },
            { "name": "Field13", "type": "string" },
            { "name": "Field14", "type": "string" },
            { "name": "Field15", "type": "string" },
            { "name": "Field16", "type": "string" },
            { "name": "Field17", "type": "string" },
            { "name": "Field18", "type": "string" },
            { "name": "Field19", "type": "string" },
            { "name": "Field20", "type": "string" },
            { "name": "Field21", "type": "string" },
            { "name": "Field22", "type": "datetime" }
          ]
        },
        "Custom-AWSNLBFlowLogsStream": {
          "columns": [
    { "name": "version", "type": "string" },
    { "name": "account-id", "type": "string" },
    { "name": "interface-id", "type": "string" },
    { "name": "srcaddr", "type": "string" },
    { "name": "dstaddr", "type": "string" },
    { "name": "srcport", "type": "string"},
    { "name": "dstport", "type": "string" },
    { "name": "protocol", "type": "string" },
    { "name": "packets", "type": "string" },
    { "name": "bytes", "type": "string" },
    { "name": "start", "type": "string" },
    { "name": "end", "type": "string" },
    { "name": "action", "type": "string" },
    { "name": "log-status", "type": "string" }
  ]
},
"Custom-AWSGLBFlowLogsStream": {
        "columns": [
          { "name": "version", "type": "string" },
    { "name": "account-id", "type": "string" },
    { "name": "interface-id", "type": "string" },
    { "name": "srcaddr", "type": "string" },
    { "name": "dstaddr", "type": "string" },
    { "name": "srcport", "type": "string"},
    { "name": "dstport", "type": "string" },
    { "name": "protocol", "type": "string" },
    { "name": "packets", "type": "string" },
    { "name": "bytes", "type": "string" },
    { "name": "start", "type": "string" },
    { "name": "end", "type": "string" },
    { "name": "action", "type": "string" },
    { "name": "log-status", "type": "string" }
        ]
      }
      },
      "destinations": {
        "logAnalytics": [
          {
            "workspaceResourceId": "{{workspaceResourceId}}",
            "name": "clv2ws1"
          }
        ]
      },
      "dataFlows": [
        {
          "streams": ["Custom-AWSALBAccessLogsStream"],
          "destinations": ["clv2ws1"],
          "transformKql": "source | extend TimeGenerated= todatetime(Field2),ALBType =Field1, Alb =Field3, ClientIpPort =Field4, TargetIpPort =Field5, RequestProcessingTime = tostring(Field6), TargetProcessingTime = tostring(Field7), ResponseProcessingTime = tostring(Field8), ElbStatusCode = toint(Field9), TargetStatusCode =Field10, ReceivedBytes = tolong(Field11), SentBytes = tolong(Field12), RequestRaw =Field13, UserAgent =Field14, SslCipher =Field15, SslProtocol =Field16, TargetGroupArn =Field17, TraceId =Field18, DomainName =Field19, ChosenCertArn =Field20, MatchedRulePriority =Field21, RequestCreationTime =Field22, ActionsExecuted =Field23, RedirectUrl =Field24, LambdaErrorReason =Field25, TargetPortList =Field26, TargetStatusCodeList =Field27, Classification =Field28, ClassificationReason =Field29, ConnTraceId =Field30 | extend ClientIp = tostring(split(ClientIpPort, ':')[0]), ClientPort = toint(split(ClientIpPort, ':')[1]), TargetIp = tostring(split(TargetIpPort, ':')[0]), TargetPort = toint(split(TargetIpPort, ':')[1]) | project TimeGenerated, ALBType, Alb, ClientIp, ClientPort, TargetIp, TargetPort, RequestProcessingTime, TargetProcessingTime, ResponseProcessingTime, ElbStatusCode, TargetStatusCode, ReceivedBytes, SentBytes, RequestRaw, UserAgent, SslCipher, SslProtocol, TargetGroupArn, TraceId, DomainName, ChosenCertArn, MatchedRulePriority, RequestCreationTime, ActionsExecuted, RedirectUrl,LambdaErrorReason, TargetPortList, TargetStatusCodeList, Classification, ClassificationReason, ConnTraceId",
          "outputStream": "Custom-AWSALBAccessLogs_CL"
        },
        {
          "streams": ["Custom-AWSNLBAccessLogsStream"],
          "destinations": ["clv2ws1"],
          "transformKql": "source | extend TimeGenerated = todatetime(Field3) | project NLBType = tostring(Field1), Version = tostring(Field2), TimeGenerated, Nlb = tostring(Field4), Listener = tostring(Field5), ClientIP_Port = tostring(Field6), TargetIP_Port = tostring(Field7), Connection_Time = tostring(Field8), Tls_Handshake_Time = tostring(Field9), Received_Bytes = tostring(Field10), Sent_Bytes = tostring(Field11), Incoming_TLS_Alert = tostring(Field12), Chosen_Cert_Arn = tostring(Field13), Chosen_Cert_Serial = tostring(Field14), TLS_Cipher = tostring(Field15), TLS_Protocol_Version = tostring(Field16), TLS_Named_Group = tostring(Field17), Domain_Name = tostring(Field18), ALPN_FE_Protocol = tostring(Field19), ALPN_BE_Protocol = tostring(Field20), ALPN_Client_Pref_List = tostring(Field21), TLS_Connection_Creation_Time = tostring(Field22)",
          "outputStream": "Custom-AWSNLBAccessLogs_CL"
        },
        {
          "streams": ["Custom-AWSNLBFlowLogsStream"],
          "destinations": ["clv2ws1"],
          "transformKql": "source | extend TimeGenerated = datetime(1970-01-01) + tolong(start) * 1s | project TimeGenerated, Version = tostring(version), AccountId = tostring(['account-id']), InterfaceId = tostring(['interface-id']), SourceAddress = tostring(srcaddr), DestinationAddress = tostring(dstaddr), SourcePort = tostring(srcport), DestinationPort = tostring(dstport), Protocol = tostring(protocol), Packets = tostring(packets), Bytes = tostring(bytes), SStartTime = datetime(1970-01-01) + tolong(start) * 1s, EndTime = datetime(1970-01-01) + tolong(end) * 1s, Action = tostring(action), LogStatus = tostring(['log-status']),LogType=tostring('NLBFlowLogs'),TimeNow=todatetime(now())",
          "outputStream": "Custom-AWSELBFlowLogs_CL"
        },
        {
          "streams": ["Custom-AWSGLBFlowLogsStream"],
          "destinations": ["clv2ws1"],
          "transformKql": "source | extend TimeGenerated = datetime(1970-01-01) + tolong(start) * 1s | project TimeGenerated, Version = tostring(version), AccountId = tostring(['account-id']), InterfaceId = tostring(['interface-id']), SourceAddress = tostring(srcaddr), DestinationAddress = tostring(dstaddr), SourcePort = tostring(srcport), DestinationPort = tostring(dstport), Protocol = tostring(protocol), Packets = tostring(packets), Bytes = tostring(bytes), SStartTime = datetime(1970-01-01) + tolong(start) * 1s, EndTime = datetime(1970-01-01) + tolong(end) * 1s, Action = tostring(action), LogStatus = tostring(['log-status']),LogType=tostring('GLBFlowLogs'),TimeNow=todatetime(now())",
          "outputStream": "Custom-AWSELBFlowLogs_CL"
        }
      ],
      "dataCollectionEndpointId": "[concat('/subscriptions/', parameters('subscription'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.Insights/dataCollectionEndpoints/', parameters('workspace'))]"
    }
  }
  