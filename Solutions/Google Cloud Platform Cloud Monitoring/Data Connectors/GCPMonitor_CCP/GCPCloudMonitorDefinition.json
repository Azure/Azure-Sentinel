{
    "name": "GCPMonitorCCPDefinition",
    "apiVersion": "2022-09-01-preview",
    "type": "Microsoft.SecurityInsights/dataConnectorDefinitions",
    "location": "{{location}}",
    "kind": "Customizable",
    "properties": {
        "connectorUiConfig": {
            "id": "GCPMonitorCCPDefinition",
            "title": "Google Cloud Platform Cloud Monitoring",
            "publisher": "Microsoft",
            "descriptionMarkdown": "The Google Cloud Platform Cloud Monitoring data connector ingests Monitoring logs from Google Cloud into Microsoft Sentinel using the Google Cloud Monitoring API. Refer to [Cloud Monitoring API](https://cloud.google.com/monitoring/api/v3) documentation for more details.",
            "graphQueriesTableName": "GCP_MONITORINGV2_CL",
            "graphQueries": [
                {
                    "metricName": "Total events received",
                    "legend": "Google Cloud Platform Cloud Monitoring Events",
                    "baseQuery": "{{graphQueriesTableName}}"
                }
            ],
            "sampleQueries": [
                {
                    "description": "Get a sample of Google Cloud Platform Cloud Monitoring logs",
                    "query": "{{graphQueriesTableName}}\n | take 10"
                }
            ],
            "dataTypes": [
                {
                    "name": "{{graphQueriesTableName}}",
                    "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                }
            ],
            "connectivityCriteria": [
                {
                    "type": "HasDataConnectors"
                }
            ],
            "availability": {
                "status": 1,
                "isPreview": false
            },
            "permissions": {
                "resourceProvider": [
                    {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                            "read": true,
                            "write": true,
                            "delete": true,
                            "action": false
                        }
                    }
                ]
            },
            "instructionSteps": [
                {
                    "instructions": [
                        {
                            "type": "Markdown",
                            "parameters": {
                                "content": ">**NOTE:** If both Azure Function and CCP connector are running in parallel, duplicate data may appear in the tables."
                            }
                        },
                        {
                            "type": "Markdown",
                            "parameters": {
                                "content": "#### 1. Setup GCP Monitoring Integration\n Provide the **Project ID** and select the **Metric Type** to collect logs from Google Cloud Monitoring.\n\nFor more details, refer to [Google Cloud Monitoring API](https://cloud.google.com/monitoring/api/v3)."
                            }
                        },
                        {
                            "type": "Textbox",
                            "parameters": {
                                "label": "GCP Project ID",
                                "name": "project_id",
                                "required": true,
                                "description": "Enter your Google Cloud Project ID."
                            }
                        },
                        {
                            "type": "Dropdown",
                            "parameters": {
                                "label": "Metric Type",
                                "type": "text",
                                "name": "metric_type",
                                "required": true,
                                "options": [
                                    {
                                        "key": "compute.googleapis.com/instance/disk/write_bytes_count",
                                        "text": "Compute Instance Disk Write Bytes Count"
                                    },
                                    {
                                        "key": "compute.googleapis.com/instance/network/received_bytes_count",
                                        "text": "Network Received Bytes" 
                                    },
                                    {
                                        "key": "compute.googleapis.com/instance/network/sent_bytes_count",
                                        "text": "Network Sent Bytes"
                                    }
                                ],
                                "description": "Select the metric type you want to collect logs for."
                            }
                        },
                        {
                            "type": "OAuthForm",
                            "parameters": {
                                "clientIdLabel": "Client ID",
                                "clientSecretLabel": "Client Secret",
                                "connectButtonLabel": "Connect",
                                "disconnectButtonLabel": "Disconnect"
                            }
                        },
                        {
                            "type": "Markdown",
                            "parameters": {
                                "content": "#### 2. Enable Monitoring API\n Ensure that **Cloud Monitoring API** is enabled in your GCP project. You can enable it from the [Google Cloud Console](https://console.cloud.google.com/apis/library/monitoring.googleapis.com).\n\nGrant required IAM roles to your service account to allow access to Cloud Monitoring data."
                            }
                        },
                        {
                            "type": "Markdown",
                            "parameters": {
                                "content": "#### 3. Connect to Sentinel\n Click on **Connect** to start pulling monitoring logs from Google Cloud into Microsoft Sentinel."
                            }
                        },
                        {
                            "type": "GCPGrid",
                            "parameters": {}
                        },
                        {
                            "type": "GCPContextPane",
                            "parameters": {}
                        }
                    ],
                    "title": "Connect Google Cloud Platform Cloud Monitoring to Microsoft Sentinel"
                }
            ]
        }
    }
}