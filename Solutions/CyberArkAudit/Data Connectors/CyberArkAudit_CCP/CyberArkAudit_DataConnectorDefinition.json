{
  "name": "CyberArkAuditCCPDefinition",
  "apiVersion": "2022-09-01-preview",
  "type": "Microsoft.SecurityInsights/dataConnectorDefinitions",
  "location": "{{location}}",
  "kind": "Customizable",
  "properties": {
    "connectorUiConfig": {
      "id": "CyberArkAuditCCPDefinition",
      "title": "CyberArk Audit (using REST API)",
      "publisher": "Microsoft",
      "descriptionMarkdown": "The [CyberArk Audit](https://docs.cyberark.com/Audit/Latest/en/Content/Resources/_TopNav/cc_Home.htm) data connector enables Microsoft Sentinel to ingest security event logs and other events from the CyberArk Audit service via REST API. This integration helps you detect potential security risks, monitor user activity, analyze collaboration patterns, troubleshoot configuration issues, and gain deeper insights into your environment.",
      "graphQueriesTableName": "CyberArkAuditV2_CL",
      "graphQueries": [
        {
          "metricName": "Total data received",
          "legend": "CyberArk Audit Events",
          "baseQuery": "{{graphQueriesTableName}}"
        }
      ],
      "sampleQueries": [
        {
          "description": "CyberArk Audit Events - All Activities.",
          "query": "{{graphQueriesTableName}}\n | sort by TimeGenerated desc"
        }
      ],
      "dataTypes": [
        {
          "name": "{{graphQueriesTableName}}",
          "lastDataReceivedQuery": "{{graphQueriesTableName}}\n|summarize Time = max  (TimeGenerated)\n|where isnotempty(Time)"
        }
      ],
      "connectivityCriteria": [
        {
          "type": "HasDataConnectors"
        }
      ],
      "permissions": {
        "resourceProvider": [
          {
            "provider": "Microsoft.OperationalInsights/workspaces",
            "permissionsDisplayText": "Read and Write permissions are required.",
            "providerDisplayName": "Workspace",
            "scope": "Workspace",
            "requiredPermissions": {
              "write": true,
              "read": true,
              "delete": true
            }
          }
        ],
        "customs": [
          {
            "name": "CyberArk Audit Service Platform",
            "description": "Access to perform required configurations in CyberArk Audit platform"
          }
        ]
      },
      "instructionSteps": [
        {
          "description": "Create and configure an OAuth2 server web app in Identity Administration",
          "instructions": [
            {
              "type": "Textbox",
              "parameters": {
                "label": "OAuth2 Server App Name",
                "validations": {
                  "required": true
                },
                "placeholder": "e.g. AuditforMicrosoftSentinel",
                "type": "text",
                "name": "OAuth2ServerAppName"
              }
            },
            {
              "type": "Textbox",
              "parameters": {
                "label": "Audit API Key",
                "validations": {
                  "required": true
                },
                "placeholder": "The API Key can be retrieved from the Audit service",
                "type": "password",
                "name": "AuditAPIKey"
              }
            },
            {
              "type": "Textbox",
              "parameters": {
                "label": "Identity Endpoint",
                "validations": {
                  "required": true
                },
                "placeholder": "e.g. https://kln9281.id.cyberark.cloud",
                "type": "text",
                "name": "CyberArkIdentityEndPoint"
              }
            },
            {
              "type": "Textbox",
              "parameters": {
                "label": "Audit API Base URL",
                "validations": {
                  "required": true
                },
                "placeholder": "e.g. org-test.audit.cyberark.cloud",
                "type": "text",
                "name": "CyberArkAPIBaseURL"
              }
            },
            {
              "type": "Textbox",
              "parameters": {
                "label": "Audit Query Filter Action (Optional)",
                "validations": {
                  "required": false
                },
                "placeholder": "e.g. {\"op\":\"include\",\"params\":[\"cloud.core.login\",\"cloud.core.mfasummary\"]}",
                "description": "The optional filter parameters to filter logs based on specific 'Action' values.",
                "type": "text",
                "name": "AuditQueryFilterAction"
              }
            },
            {
              "type": "Textbox",
              "parameters": {
                "label": "Audit Query Filter Application Code (Optional)",
                "validations": {
                  "required": false
                },
                "placeholder": "e.g. {\"op\":\"include\",\"params\":[\"IDP\",\"CMS\"]}",
                "description": "The optional filter parameters to filter logs based on specific 'ApplicationCode' values.",
                "type": "text",
                "name": "AuditQueryFilterApplicationCode"
              }
            },
            {
              "type": "Textbox",
              "parameters": {
                "label": "Audit Query Filter Audit Type (Optional)",
                "validations": {
                  "required": false
                },
                "placeholder": "e.g. {\"op\":\"include\",\"params\":[\"Failure\"]}",
                "description": "The optional filter parameters to filter logs based on specific 'AuditType' values.",
                "type": "text",
                "name": "AuditQueryFilterAuditType"
              }
            },
            {
              "type": "OAuthForm",
              "parameters": {
                "clientIdLabel": "Oauth Username",
                "clientSecretLabel": "Oauth Password",
                "clientIdPlaceholder": "The service user created in Identity Administration",
                "clientSecretPlaceholder": "The user password created in Identity Administration",
                "connectButtonLabel": "Connect",
                "disconnectButtonLabel": "Disconnect"
              }
            }
          ],
          "title": "Connect to CyberArk Audit API to start collecting event logs in Microsoft Sentinel"
        }
      ]
    }
  }
}