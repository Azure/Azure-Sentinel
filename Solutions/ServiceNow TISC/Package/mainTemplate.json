{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "ServiceNow",
    "comments": "Solution template for ServiceNow TISC"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "_solutionName": "ServiceNow TISC",
    "_solutionVersion": "3.0.0",
    "solutionId": "servicenow1594831756316.sentinel-solution-tisc",
    "_solutionId": "[variables('solutionId')]",
    "ServiceNowTISCCustomConnector": "ServiceNowTISCCustomConnector",
    "_ServiceNowTISCCustomConnector": "[variables('ServiceNowTISCCustomConnector')]",
    "TemplateEmptyArray": "[json('[]')]",
    "blanks": "[replace('b', 'b', '')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "ServiceNowTISCCustomConnector",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-lc-',uniquestring(variables('_playbookContentId1'))))]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','lc','-', uniqueString(concat(variables('_solutionId'),'-','LogicAppsCustomConnector','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
    "ServiceNowTISC-Export_Domain_Entity": "ServiceNowTISC-Export_Domain_Entity",
    "_ServiceNowTISC-Export_Domain_Entity": "[variables('ServiceNowTISC-Export_Domain_Entity')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "ServiceNowTISC-Export_Domain_Entity",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))))]",
    "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
    "ServiceNowTISC-Export_Hash_Entity": "ServiceNowTISC-Export_Hash_Entity",
    "_ServiceNowTISC-Export_Hash_Entity": "[variables('ServiceNowTISC-Export_Hash_Entity')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "ServiceNowTISC-Export_Hash_Entity",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3'))))]",
    "_playbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId3'),'-', variables('playbookVersion3'))))]",
    "ServiceNowTISC-Export_Incident_Entities": "ServiceNowTISC-Export_Incident_Entities",
    "_ServiceNowTISC-Export_Incident_Entities": "[variables('ServiceNowTISC-Export_Incident_Entities')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "ServiceNowTISC-Export_Incident_Entities",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4'))))]",
    "_playbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId4'),'-', variables('playbookVersion4'))))]",
    "ServiceNowTISC-Export_IP_Entity": "ServiceNowTISC-Export_IP_Entity",
    "_ServiceNowTISC-Export_IP_Entity": "[variables('ServiceNowTISC-Export_IP_Entity')]",
    "playbookVersion5": "1.0",
    "playbookContentId5": "ServiceNowTISC-Export_IP_Entity",
    "_playbookContentId5": "[variables('playbookContentId5')]",
    "playbookId5": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId5'))]",
    "playbookTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId5'))))]",
    "_playbookcontentProductId5": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId5'),'-', variables('playbookVersion5'))))]",
    "ServiceNowTISC-Export_URL_Entity": "ServiceNowTISC-Export_URL_Entity",
    "_ServiceNowTISC-Export_URL_Entity": "[variables('ServiceNowTISC-Export_URL_Entity')]",
    "playbookVersion6": "1.0",
    "playbookContentId6": "ServiceNowTISC-Export_URL_Entity",
    "_playbookContentId6": "[variables('playbookContentId6')]",
    "playbookId6": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId6'))]",
    "playbookTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId6'))))]",
    "_playbookcontentProductId6": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId6'),'-', variables('playbookVersion6'))))]",
    "ServiceNowTISC-Batch_Indicator_Uploader": "ServiceNowTISC-Batch_Indicator_Uploader",
    "_ServiceNowTISC-Batch_Indicator_Uploader": "[variables('ServiceNowTISC-Batch_Indicator_Uploader')]",
    "playbookVersion7": "1.0",
    "playbookContentId7": "ServiceNowTISC-Batch_Indicator_Uploader",
    "_playbookContentId7": "[variables('playbookContentId7')]",
    "playbookId7": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId7'))]",
    "playbookTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId7'))))]",
    "_playbookcontentProductId7": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId7'),'-', variables('playbookVersion7'))))]",
    "ServiceNowTISC-Import_Observables_Batch": "ServiceNowTISC-Import_Observables_Batch",
    "_ServiceNowTISC-Import_Observables_Batch": "[variables('ServiceNowTISC-Import_Observables_Batch')]",
    "playbookVersion8": "1.0",
    "playbookContentId8": "ServiceNowTISC-Import_Observables_Batch",
    "_playbookContentId8": "[variables('playbookContentId8')]",
    "playbookId8": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId8'))]",
    "playbookTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId8'))))]",
    "_playbookcontentProductId8": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId8'),'-', variables('playbookVersion8'))))]",
    "ServiceNowTISC-Incident_Enrichment": "ServiceNowTISC-Incident_Enrichment",
    "_ServiceNowTISC-Incident_Enrichment": "[variables('ServiceNowTISC-Incident_Enrichment')]",
    "playbookVersion9": "1.0",
    "playbookContentId9": "ServiceNowTISC-Incident_Enrichment",
    "_playbookContentId9": "[variables('playbookContentId9')]",
    "playbookId9": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId9'))]",
    "playbookTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId9'))))]",
    "_playbookcontentProductId9": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId9'),'-', variables('playbookVersion9'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ServiceNowTISCCustomConnector Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "CustomConnectorName": {
              "defaultValue": "ServiceNowTISCCustomConnector",
              "type": "string",
              "metadata": {
                "description": "Name of the custom connector, if you want to change the default name, make sure to use the same in all ServiceNow TISC playbooks as well"
              }
            },
            "ServicenowHost": {
              "defaultValue": "<ENTER_SERVICENOW_HOST>",
              "type": "string",
              "metadata": {
                "description": "Enter your ServiceNow platform url for example: sn-playground.servicenow.com. Do NOT prefix with https:// or http:// etc"
              }
            }
          },
          "variables": {
            "api_host": "[[replace(replace(parameters('ServiceNowHost'),'https://',''),'http://','')]",
            "ServiceName": "[[concat('https://', variables('api_host'))]",
            "operationId-Observables_Indicator_STIX_Format_API": "Observables_Indicator_STIX_Format_API",
            "_operationId-Observables_Indicator_STIX_Format_API": "[[variables('operationId-Observables_Indicator_STIX_Format_API')]",
            "operationId-Fetch_Observables_API": "Fetch_Observables_API",
            "_operationId-Fetch_Observables_API": "[[variables('operationId-Fetch_Observables_API')]",
            "operationId-Add_Observables_API": "Add_Observables_API",
            "_operationId-Add_Observables_API": "[[variables('operationId-Add_Observables_API')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId1": "ServiceNowTISCCustomConnector",
            "playbookId1": "[[resourceId('Microsoft.Web/customApis', parameters('CustomConnectorName'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('CustomConnectorName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "connectionParameters": {
                  "username": {
                    "type": "securestring"
                  },
                  "password": {
                    "type": "securestring"
                  }
                },
                "brandColor": "#FFFFFF",
                "description": "ServiceNow TISC Connector enables access to data from the Threat Intelligence Security Center on ServiceNow. The connector has dedicated actions for importing TISC Observables (IP, Domain, URL, Hash) and exporting entities from Microsoft Sentinel to TISC.",
                "displayName": "[[parameters('CustomConnectorName')]",
                "iconUri": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMzIiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAxMzIgMjAiPjxwYXRoIGQ9Ik0zMi4wMjIsNi4zOTFhNS42MjYsNS42MjYsMCwwLDAtMy42MSwxLjNWNi41MjNIMjUuMTE5VjE5LjM1aDMuNDI1di04LjJhNC4wNzMsNC4wNzMsMCwwLDEsMy4xMDktMS41ODgsMy40OTQsMy40OTQsMCwwLDEsMS4zNzQuMjA2VjYuNDc5YTUuODUxLDUuODUxLDAsMCwwLTEuMDA1LS4wODgiIGZpbGw9IiMwMDAwMDAiIGZpbGwtcnVsZT0iZXZlbm9kZCIvPjxwYXRoIGQ9Ik0yLjE2LDE1LjQzNmE1LjM2OSw1LjM2OSwwLDAsMCwzLjUsMS4yNjljLjkyMiwwLDEuNjMzLS40NSwxLjYzMy0xLjA4NCwwLTEuOTMxLTYuMTkxLTEuMjQzLTYuMTkxLTUuMzY5LDAtMi40NTksMi4zNzEtMy45OTMsNC45LTMuOTkzYTcuOSw3LjksMCwwLDEsNC4zMiwxLjNMOC43MiwxMC4wNGE0LjMsNC4zLDAsMCwwLTIuNDUtLjg3MmMtLjk0OCwwLTEuNzM5LjM3LTEuNzM5LDEuMDMxLDAsMS42NjYsNi4xOTIsMS4wMDUsNi4xOTIsNS40NDgsMCwyLjQ2LTIuNCwzLjk2Ny01LjA4NSwzLjk2N0E4LjgxNSw4LjgxNSwwLDAsMSwuNSwxNy45WiIgZmlsbD0iIzAwMDAwMCIgZmlsbC1ydWxlPSJldmVub2RkIi8+PHBhdGggZD0iTTIzLjY1NywxMi44MTdjMC0zLjU3LTIuNS02LjU1OC02LjAzNC02LjU1OC0zLjc5NCwwLTYuMjE4LDMuMTItNi4yMTgsNi42OTFBNi40LDYuNCwwLDAsMCwxOC4xLDE5LjYxNGE2LjkxOSw2LjkxOSwwLDAsMCw1LjI0My0yLjNsLTEuOTUtMS45NTdhNC41MTUsNC41MTUsMCwwLDEtMy4yMTQsMS40ODFBMy4zNiwzLjM2LDAsMCwxLDE0LjcyNSwxMy44aDguODUzQTUuNzM1LDUuNzM1LDAsMCwwLDIzLjY1NywxMi44MTdabS04Ljc3NC0xLjUzM2EyLjc3NSwyLjc3NSwwLDAsMSwyLjc0LTIuMjQ4LDIuNTUyLDIuNTUyLDAsMCwxLDIuNTMsMi4yNDhaIiBmaWxsPSIjMDAwMDAwIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiLz48cG9seWdvbiBwb2ludHM9IjQxLjE5IDE0LjM1MSA0NC42OTQgNi41MjMgNDguMjUyIDYuNTIzIDQyLjM3NiAxOS4zNSA0MC4wMDUgMTkuMzUgMzQuMTI5IDYuNTIzIDM3LjY4NiA2LjUyMyA0MS4xOSAxNC4zNTEiIGZpbGw9IiMwMDAwMDAiIGZpbGwtcnVsZT0iZXZlbm9kZCIvPjxwYXRoIGQ9Ik01MS4xMjguNUEyLjIsMi4yLDAsMSwxLDQ4Ljg4OCwyLjcsMi4yLDIuMiwwLDAsMSw1MS4xMjguNSIgZmlsbD0iIzAwMDAwMCIgZmlsbC1ydWxlPSJldmVub2RkIi8+PHJlY3QgeD0iNDkuNDE1IiB5PSI2LjUyMyIgd2lkdGg9IjMuNDI1IiBoZWlnaHQ9IjEyLjgyNyIgZmlsbD0iIzAwMDAwMCIvPjxwYXRoIGQ9Ik02NywxNi43MzFhNi43NjYsNi43NjYsMCwwLDEtNS44LDIuODgzLDYuNjgsNi42OCwwLDEsMSwuMDI2LTEzLjM1NSw2LjgwOCw2LjgwOCwwLDAsMSw1LjM3NSwyLjU2NWwtMi40MjQsMi4xNDJhMy43LDMuNywwLDAsMC0yLjk1MS0xLjUzNEEzLjQzMywzLjQzMywwLDAsMCw1Ny43OCwxMi45NWEzLjM4MywzLjM4MywwLDAsMCwzLjUzMSwzLjQ5LDMuNzQxLDMuNzQxLDAsMCwwLDMuMDU2LTEuNjkyWiIgZmlsbD0iIzAwMDAwMCIgZmlsbC1ydWxlPSJldmVub2RkIi8+PHBhdGggZD0iTTc5LjQ0MiwxNy4zMTNhNi45MTgsNi45MTgsMCwwLDEtNS4yNDMsMi4zLDYuNCw2LjQsMCwwLDEtNi42OTItNi42NjRjMC0zLjU3MSwyLjQyNC02LjY5MSw2LjIxOC02LjY5MSwzLjUzLDAsNi4wMzMsMi45ODgsNi4wMzMsNi41NThhNS42MzUsNS42MzUsMCwwLDEtLjA3OS45NzlINzAuODI2YTMuMzYsMy4zNiwwLDAsMCwzLjQ1MiwzLjA0MSw0LjUyLDQuNTIsMCwwLDAsMy4yMTUtMS40ODFabS0zLjE4OC02LjAyOWEyLjU1MSwyLjU1MSwwLDAsMC0yLjUyOS0yLjI0OCwyLjc3NCwyLjc3NCwwLDAsMC0yLjc0LDIuMjQ4WiIgZmlsbD0iIzAwMDAwMCIgZmlsbC1ydWxlPSJldmVub2RkIi8+PHBhdGggZD0iTTgxLjEyLDE5LjM1VjYuNTIzaDMuMjkzVjcuNTU0YTUuNjI1LDUuNjI1LDAsMCwxLDMuNjA5LTEuMjk1LDUuNzQ3LDUuNzQ3LDAsMCwxLDQuNDI3LDIuMDYzLDYuNDgyLDYuNDgyLDAsMCwxLDEuMzE3LDQuNVYxOS4zNUg5MC4zNDF2LTYuOGEzLjExLDMuMTEsMCwwLDAtLjc2NC0yLjQwNywyLjY5LDIuNjksMCwwLDAtMS45MjMtLjcxNCw0LjA3Niw0LjA3NiwwLDAsMC0zLjEwOSwxLjU4N1YxOS4zNVoiIGZpbGw9IiMwMDAwMDAiIGZpbGwtcnVsZT0iZXZlbm9kZCIvPjxwYXRoIGQ9Ik0xMDIuNTg2LDYuMjU5QTcuNSw3LjUsMCwwLDAsOTcuNDE5LDE5LjIxYTEuNDgxLDEuNDgxLDAsMCwwLDEuOTI2LjEsNS4zNTUsNS4zNTUsMCwwLDEsNi4zOTQsMCwxLjQ4NSwxLjQ4NSwwLDAsMCwxLjkzNy0uMTEzLDcuNSw3LjUsMCwwLDAtNS4wOS0xMi45NE0xMDIuNTQyLDE3LjVhMy42MzcsMy42MzcsMCwwLDEtMy43MzQtMy43MzMsMy43MzQsMy43MzQsMCwxLDEsNy40NjgsMCwzLjYzNywzLjYzNywwLDAsMS0zLjczNCwzLjczMyIgZmlsbD0iIzYyZDg0ZSIgZmlsbC1ydWxlPSJldmVub2RkIi8+PHBvbHlnb24gcG9pbnRzPSIxMTYuNzg4IDE5LjM1IDExNC4yMzcgMTkuMzUgMTA5LjE1IDYuNTIzIDExMi41NyA2LjUyMyAxMTUuMzU5IDEzLjg1MyAxMTguMDk0IDYuNTIzIDEyMC45NTIgNi41MjMgMTIzLjY2MiAxMy44NTMgMTI2LjQ3NSA2LjUyMyAxMjkuODk2IDYuNTIzIDEyNC44MDkgMTkuMzUgMTIyLjI1OCAxOS4zNSAxMTkuNTIzIDEyLjA0NiAxMTYuNzg4IDE5LjM1IiBmaWxsPSIjMDAwMDAwIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiLz48cGF0aCBkPSJNMTI5LjkzNSwxNy45aC0uMjg5di41NDNIMTI5LjRWMTYuOTU3aC42YS40NzYuNDc2LDAsMCwxLC40NzguNDc4LjQ2OS40NjksMCwwLDEtLjI5NS40MzJsLjMzOC41NzloLS4yNjhabS0uMjg5LS4yMTlIMTMwYS4yNDkuMjQ5LDAsMCwwLDAtLjVoLS4zNTFaIiBmaWxsPSIjMDAwMDAwIi8+PHBhdGggZD0iTTEyOS45LDE2LjM0OGExLjM3OSwxLjM3OSwwLDEsMS0xLjM3OCwxLjM3OSwxLjM4MSwxLjM4MSwwLDAsMSwxLjM3OC0xLjM3OW0wLS4yMThhMS42LDEuNiwwLDEsMCwxLjYsMS42LDEuNiwxLjYsMCwwLDAtMS42LTEuNloiIGZpbGw9IiMwMDAwMDAiLz48L3N2Zz4K",
                "backendService": {
                  "serviceUrl": "[[variables('ServiceName')]"
                },
                "apiType": "Rest",
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "title": "Default title",
                    "description": "ServiceNow TISC Connector enables access to the ServiceNow Threat Intelligence data. The connector has dedicated actions for importing TISC Observables (IP, Domain, URL, Hash) and exporting entities from Microsoft Sentinel to TISC.",
                    "version": "1.0"
                  },
                  "host": "[[variables('api_host')]",
                  "basePath": "/",
                  "schemes": [
                    "https"
                  ],
                  "consumes": "[variables('TemplateEmptyArray')]",
                  "produces": "[variables('TemplateEmptyArray')]",
                  "paths": {
                    "/api/sn_sec_tisc/threat_intel_data/observables_indicator_stix_format": {
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "indicators": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "type": {
                                        "type": "string",
                                        "description": "type"
                                      },
                                      "spec_version": {
                                        "type": "string",
                                        "description": "spec_version"
                                      },
                                      "id": {
                                        "type": "string",
                                        "description": "id"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "name"
                                      },
                                      "created": {
                                        "type": "string",
                                        "description": "created"
                                      },
                                      "modified": {
                                        "type": "string",
                                        "description": "modified"
                                      },
                                      "pattern": {
                                        "type": "string",
                                        "description": "pattern"
                                      },
                                      "pattern_type": {
                                        "type": "string",
                                        "description": "pattern_type"
                                      },
                                      "confidence": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "confidence"
                                      },
                                      "description": {
                                        "type": "string",
                                        "description": "description"
                                      },
                                      "valid_from": {
                                        "type": "string",
                                        "description": "valid_from"
                                      },
                                      "valid_util": {
                                        "type": "string",
                                        "description": "valid_from"
                                      }
                                    }
                                  },
                                  "description": "indicators",
                                  "x-ms-visibility": "important"
                                },
                                "next_page_token": {
                                  "type": "string",
                                  "description": "next_page_token"
                                },
                                "page_size": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "page_size"
                                },
                                "is_last_page": {
                                  "type": "boolean",
                                  "description": "is_last_page",
                                  "title": "[variables('blanks')]",
                                  "x-ms-visibility": "important",
                                  "enum": [
                                    "true",
                                    "false"
                                  ]
                                },
                                "status": {
                                  "type": "string",
                                  "description": "status",
                                  "title": "[variables('blanks')]",
                                  "x-ms-visibility": "important",
                                  "enum": [
                                    "success",
                                    "failure"
                                  ]
                                },
                                "error": {
                                  "type": "object",
                                  "properties": {
                                    "message": {
                                      "type": "string",
                                      "description": "message"
                                    },
                                    "detail": {
                                      "type": "string",
                                      "description": "detail"
                                    }
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Import Observables in Indicator STIX format TISC API",
                        "description": "Import Observables in Indicator STIX format TISC API",
                        "operationId": "[[variables('_operationId-Observables_Indicator_STIX_Format_API')]",
                        "x-ms-visibility": "important",
                        "parameters": [
                          {
                            "name": "body",
                            "in": "body",
                            "required": false,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "page_size": {
                                  "type": "integer",
                                  "format": "int64",
                                  "description": "Page size",
                                  "title": "Page size:",
                                  "x-ms-visibility": "important",
                                  "default": 100
                                },
                                "page_token": {
                                  "type": "string",
                                  "description": "Next page token",
                                  "title": "Next page token:",
                                  "x-ms-visibility": "important",
                                  "default": "[variables('blanks')]"
                                },
                                "types": {
                                  "type": "array",
                                  "items": {
                                    "type": "string",
                                    "enum": [
                                      "IPV4",
                                      "IPV6",
                                      "URL",
                                      "Hash",
                                      "Domain"
                                    ]
                                  },
                                  "description": "Types of observables to retrieve",
                                  "title": "Observable Type:",
                                  "x-ms-visibility": "important"
                                },
                                "threat_score_min": {
                                  "type": "integer",
                                  "format": "int64",
                                  "description": "Minimum threat score for observables",
                                  "title": "Threat Score greater than or equal to:",
                                  "x-ms-visibility": "important"
                                },
                                "threat_score_max": {
                                  "type": "integer",
                                  "format": "int64",
                                  "description": "Maximum threat score for observables",
                                  "title": "Threat Score less than or equal to:",
                                  "x-ms-visibility": "important"
                                },
                                "confidence_min": {
                                  "type": "integer",
                                  "format": "int64",
                                  "description": "Minimum confidence score for observables",
                                  "title": "Confidence greater than or equal to:",
                                  "x-ms-visibility": "important"
                                },
                                "confidence_max": {
                                  "type": "integer",
                                  "format": "int64",
                                  "description": "Maximum confidence score for observables",
                                  "title": "Confidence less than or equal to:",
                                  "x-ms-visibility": "important"
                                },
                                "reputation": {
                                  "type": "array",
                                  "items": {
                                    "type": "string",
                                    "enum": [
                                      "Unknown",
                                      "Clean",
                                      "Suspicious",
                                      "Malicious"
                                    ]
                                  },
                                  "description": "Reputations to filter",
                                  "title": "Reputation:",
                                  "x-ms-visibility": "important"
                                },
                                "threat_severity": {
                                  "type": "array",
                                  "items": {
                                    "type": "string",
                                    "enum": [
                                      "Critical",
                                      "High",
                                      "Medium",
                                      "Low"
                                    ]
                                  },
                                  "description": "Threat severities to filter",
                                  "title": "Threat Severity:",
                                  "x-ms-visibility": "important"
                                },
                                "threat_level": {
                                  "type": "array",
                                  "items": {
                                    "type": "string",
                                    "enum": [
                                      "Low",
                                      "Medium",
                                      "High"
                                    ]
                                  },
                                  "description": "Threat levels to filter",
                                  "title": "Threat Level:",
                                  "x-ms-visibility": "important"
                                },
                                "delta_hours": {
                                  "type": "integer",
                                  "format": "int64",
                                  "description": "Last updated delta time in hours for fetching indicators.",
                                  "title": "Last updated delta in hours:",
                                  "x-ms-visibility": "important",
                                  "default": 24
                                }
                              },
                              "x-ms-visibility": "important"
                            },
                            "x-ms-visibility": "important"
                          }
                        ]
                      }
                    },
                    "/api/sn_sec_tisc/threat_intel_data/observables": {
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "status": {
                                  "type": "string",
                                  "description": "status"
                                },
                                "observables": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "type": {
                                        "type": "string",
                                        "description": "type"
                                      },
                                      "value": {
                                        "type": "string",
                                        "description": "value"
                                      },
                                      "sys_id": {
                                        "type": "string",
                                        "description": "sys_id"
                                      },
                                      "number": {
                                        "type": "string",
                                        "description": "number"
                                      },
                                      "notes": {
                                        "type": "string",
                                        "description": "notes"
                                      },
                                      "reputation": {
                                        "type": "string",
                                        "description": "reputation"
                                      },
                                      "threat_level": {
                                        "type": "string",
                                        "description": "threat_level"
                                      },
                                      "tlp": {
                                        "type": "string",
                                        "description": "tlp"
                                      },
                                      "language": {
                                        "type": "string",
                                        "description": "language"
                                      },
                                      "tags": {
                                        "type": "string",
                                        "description": "tags"
                                      },
                                      "source_reported_score": {
                                        "type": "string",
                                        "description": "source_reported_score"
                                      },
                                      "number_of_external_sightings": {
                                        "type": "string",
                                        "description": "number_of_external_sightings"
                                      },
                                      "sources": {
                                        "type": "string",
                                        "description": "sources"
                                      },
                                      "threat_score": {
                                        "type": "string",
                                        "description": "threat_score"
                                      },
                                      "taxonomies": {
                                        "type": "string",
                                        "description": "taxonomies"
                                      },
                                      "prevent_system_updates": {
                                        "type": "boolean",
                                        "description": "prevent_system_updates"
                                      },
                                      "source_count": {
                                        "type": "string",
                                        "description": "source_count"
                                      },
                                      "threat_severity": {
                                        "type": "string",
                                        "description": "threat_severity"
                                      },
                                      "usage_categories": {
                                        "type": "string",
                                        "description": "usage_categories"
                                      },
                                      "extensions": {
                                        "type": "string",
                                        "description": "extensions"
                                      },
                                      "last_seen": {
                                        "type": "string",
                                        "description": "last_seen"
                                      },
                                      "status": {
                                        "type": "string",
                                        "description": "status"
                                      },
                                      "security_type": {
                                        "type": "string",
                                        "description": "security_type"
                                      },
                                      "additional_context": {
                                        "type": "string",
                                        "description": "additional_context"
                                      },
                                      "attack_phases": {
                                        "type": "string",
                                        "description": "attack_phases"
                                      },
                                      "threat_score_rule": {
                                        "type": "string",
                                        "description": "threat_score_rule"
                                      },
                                      "historically_significant": {
                                        "type": "boolean",
                                        "description": "historically_significant"
                                      },
                                      "description": {
                                        "type": "string",
                                        "description": "description"
                                      },
                                      "id": {
                                        "type": "string",
                                        "description": "id"
                                      },
                                      "threat_score_calculated_time": {
                                        "type": "string",
                                        "description": "threat_score_calculated_time"
                                      },
                                      "expiration_time": {
                                        "type": "string",
                                        "description": "expiration_time"
                                      },
                                      "is_defanged": {
                                        "type": "boolean",
                                        "description": "is_defanged"
                                      },
                                      "watch_list": {
                                        "type": "boolean",
                                        "description": "watch_list"
                                      },
                                      "first_observed": {
                                        "type": "string",
                                        "description": "first_observed"
                                      },
                                      "is_false_positive": {
                                        "type": "boolean",
                                        "description": "is_false_positive"
                                      },
                                      "author": {
                                        "type": "string",
                                        "description": "author"
                                      },
                                      "confidence": {
                                        "type": "string",
                                        "description": "confidence"
                                      },
                                      "first_seen": {
                                        "type": "string",
                                        "description": "first_seen"
                                      },
                                      "last_observed": {
                                        "type": "string",
                                        "description": "last_observed"
                                      },
                                      "sys_created_on": {
                                        "type": "string",
                                        "description": "sys_created_on"
                                      },
                                      "sys_updated_on": {
                                        "type": "string",
                                        "description": "sys_updated_on"
                                      }
                                    }
                                  },
                                  "description": "observables"
                                },
                                "page_size": {
                                  "type": "string",
                                  "description": "page_size"
                                },
                                "next_page_token": {
                                  "type": "string",
                                  "description": "next_page_token"
                                },
                                "is_last_page": {
                                  "type": "boolean",
                                  "description": "is_last_page"
                                },
                                "origin": {
                                  "type": "string",
                                  "description": "origin"
                                },
                                "error": {
                                  "type": "object",
                                  "properties": {
                                    "message": {
                                      "type": "string",
                                      "description": "message"
                                    },
                                    "detail": {
                                      "type": "string",
                                      "description": "detail"
                                    }
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Fetch Observables TISC API",
                        "description": "Fetch Observables TISC API",
                        "operationId": "[[variables('_operationId-Fetch_Observables_API')]",
                        "parameters": [
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "x-ms-visibility": "important"
                            },
                            "x-ms-visibility": "important"
                          }
                        ]
                      }
                    },
                    "/api/sn_sec_tisc/threat_intel_data/add_observables": {
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "status": {
                                  "type": "string",
                                  "description": "status"
                                },
                                "metadata": {
                                  "type": "object",
                                  "properties": {
                                    "total_records": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "total_records"
                                    },
                                    "success_records": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "success_records"
                                    },
                                    "error_records": {
                                      "type": "integer",
                                      "format": "int32",
                                      "description": "error_records"
                                    }
                                  },
                                  "description": "metadata"
                                },
                                "success_records": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "value": {
                                        "type": "string",
                                        "description": "value"
                                      },
                                      "type": {
                                        "type": "string",
                                        "description": "type"
                                      },
                                      "sys_id": {
                                        "type": "string",
                                        "description": "sys_id"
                                      }
                                    }
                                  },
                                  "description": "success_records"
                                },
                                "error_records": {
                                  "type": "array",
                                  "description": "error_records"
                                },
                                "error": {
                                  "type": "object",
                                  "properties": {
                                    "message": {
                                      "type": "string",
                                      "description": "message"
                                    },
                                    "detail": {
                                      "type": "string",
                                      "description": "detail"
                                    }
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Add Observables TISC API",
                        "description": "Add Observables TISC API",
                        "operationId": "[[variables('_operationId-Add_Observables_API')]",
                        "parameters": [
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object"
                            }
                          }
                        ]
                      }
                    }
                  },
                  "securityDefinitions": {
                    "basic-auth": {
                      "type": "basic"
                    }
                  },
                  "security": [
                    {
                      "basic-auth": "[variables('TemplateEmptyArray')]"
                    }
                  ],
                  "tags": "[variables('TemplateEmptyArray')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('LogicAppsCustomConnector-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "LogicAppsCustomConnector",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "ServiceNow TISC",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "ServiceNow"
                },
                "support": {
                  "name": "ServiceNow",
                  "tier": "Partner",
                  "link": "https://support.servicenow.com/now"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId1')]",
        "contentKind": "LogicAppsCustomConnector",
        "displayName": "ServiceNowTISCCustomConnector",
        "contentProductId": "[variables('_playbookcontentProductId1')]",
        "id": "[variables('_playbookcontentProductId1')]",
        "version": "[variables('playbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ServiceNowTISC-Export_Domain_Entity Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "ServiceNowTISC-Export_Domain_Entity",
              "type": "string"
            },
            "CustomConnectorName": {
              "defaultValue": "ServiceNowTISCCustomConnector",
              "type": "string",
              "metadata": {
                "description": "Name of the custom connector, if you want to change the default name, make sure to use the same when you were installing ServiceNowTISC custom connector"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "ServiceNowTISC-MicrosoftSentinelConnection",
            "ServicenowTISCCustomConnectorConnectionName": "[[concat('Connection-', parameters('CustomConnectorName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Disabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_entity": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "path": "/entity/@{encodeURIComponent('DNS')}"
                      }
                    }
                  },
                  "actions": {
                    "Parse_DNS_Entity": {
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@triggerBody()?['Entity']",
                        "schema": {
                          "type": "object",
                          "properties": {
                            "type": {
                              "type": "string"
                            },
                            "kind": {
                              "type": "string"
                            },
                            "properties": {
                              "type": "object",
                              "properties": {
                                "domainName": {
                                  "type": "string"
                                },
                                "friendlyName": {
                                  "type": "string"
                                }
                              }
                            }
                          }
                        }
                      }
                    },
                    "Add_Observables_TISC_API_-_Domain": {
                      "runAfter": {
                        "Parse_DNS_Entity": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['ServicenowTISCCustomConnector']['connectionId']"
                          }
                        },
                        "method": "post",
                        "body": {
                          "source": "Microsoft Sentinel",
                          "observables": [
                            {
                              "value": "@{body('Parse_DNS_Entity')?['properties']?['domainName']}",
                              "type": "domain_name"
                            }
                          ]
                        },
                        "path": "/api/sn_sec_tisc/threat_intel_data/add_observables"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "ServicenowTISCCustomConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]",
                        "connectionName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "ServiceNowTISC-Export_Domain_Entity",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "ServiceNow TISC",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "ServiceNow"
                },
                "support": {
                  "name": "ServiceNow",
                  "tier": "Partner",
                  "link": "https://support.servicenow.com/now"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_ServiceNowTISCCustomConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Export Domain Entity to TISC",
            "description": "This playbook leverages the ServiceNow TISC API to export Domain indicators found in Microsoft Sentinel incidents to TISC Workspace.",
            "prerequisites": [
              "ServiceNow TISC Custom Connector needs to be deployed prior to the deployment of this playbook under the same subscription."
            ],
            "postDeployment": [
              "1. Once deployment is complete, you will need to configure/authorize each connection.",
              "2. Navigate to playbook > API Connections > Select connections one by one > configure/authorize each connection > Save"
            ],
            "lastUpdateTime": "2025-01-10T00:00:00Z",
            "entities": [
              "dns"
            ],
            "tags": [
              "Threat Intelligence",
              "ServiceNow TISC"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId2')]",
        "contentKind": "Playbook",
        "displayName": "ServiceNowTISC-Export_Domain_Entity",
        "contentProductId": "[variables('_playbookcontentProductId2')]",
        "id": "[variables('_playbookcontentProductId2')]",
        "version": "[variables('playbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ServiceNowTISC-Export_Hash_Entity Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "ServiceNowTISC-Export_Hash_Entity",
              "type": "string"
            },
            "CustomConnectorName": {
              "defaultValue": "ServiceNowTISCCustomConnector",
              "type": "string",
              "metadata": {
                "description": "Name of the custom connector, if you want to change the default name, make sure to use the same when you were installing ServiceNowTISC custom connector"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "ServiceNowTISC-MicrosoftSentinelConnection",
            "ServicenowTISCCustomConnectorConnectionName": "[[concat('Connection-', parameters('CustomConnectorName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Disabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_entity": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "path": "/entity/@{encodeURIComponent('FileHash')}"
                      }
                    }
                  },
                  "actions": {
                    "Parse_File_hash_Entity": {
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@triggerBody()?['Entity']",
                        "schema": {
                          "type": "object",
                          "properties": {
                            "type": {
                              "type": "string"
                            },
                            "kind": {
                              "type": "string"
                            },
                            "properties": {
                              "type": "object",
                              "properties": {
                                "algorithm": {
                                  "type": "string"
                                },
                                "friendlyName": {
                                  "type": "string"
                                },
                                "Value": {
                                  "type": "string"
                                }
                              }
                            }
                          }
                        }
                      }
                    },
                    "Switch_on_Hash_Algorithm": {
                      "runAfter": {
                        "Parse_File_hash_Entity": [
                          "Succeeded"
                        ]
                      },
                      "cases": {
                        "MD5": {
                          "case": "MD5",
                          "actions": {
                            "Add_Observables_TISC_API_-_MD5": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['ServicenowTISCCustomConnector']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "body": {
                                  "source": "Microsoft Sentinel",
                                  "observables": [
                                    {
                                      "value": "@{body('Parse_File_hash_Entity')?['properties']?['Value']}",
                                      "type": "md5_hash"
                                    }
                                  ]
                                },
                                "path": "/api/sn_sec_tisc/threat_intel_data/add_observables"
                              }
                            }
                          }
                        },
                        "SHA256": {
                          "case": "SHA256",
                          "actions": {
                            "Add_Observables_TISC_API_-_SHA256": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['ServicenowTISCCustomConnector']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "body": {
                                  "source": "Microsoft Sentinel",
                                  "observables": [
                                    {
                                      "value": "@{body('Parse_File_hash_Entity')?['properties']?['Value']}",
                                      "type": "sha256_hash"
                                    }
                                  ]
                                },
                                "path": "/api/sn_sec_tisc/threat_intel_data/add_observables"
                              }
                            }
                          }
                        },
                        "SHA1": {
                          "case": "SHA1",
                          "actions": {
                            "Add_Observables_TISC_API_-_SHA1": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['ServicenowTISCCustomConnector']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "body": {
                                  "source": "Microsoft Sentinel",
                                  "observables": [
                                    {
                                      "value": "@{body('Parse_File_hash_Entity')?['properties']?['Value']}",
                                      "type": "sha1_hash"
                                    }
                                  ]
                                },
                                "path": "/api/sn_sec_tisc/threat_intel_data/add_observables"
                              }
                            }
                          }
                        }
                      },
                      "expression": "@body('Parse_File_hash_Entity')?['properties']?['algorithm']",
                      "type": "Switch"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "ServicenowTISCCustomConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]",
                        "connectionName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "ServiceNowTISC-Export_Hash_Entity",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "ServiceNow TISC",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "ServiceNow"
                },
                "support": {
                  "name": "ServiceNow",
                  "tier": "Partner",
                  "link": "https://support.servicenow.com/now"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_ServiceNowTISCCustomConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Export Hash Entity to TISC",
            "description": "This playbook leverages the ServiceNow TISC API to export Hash indicators found in Microsoft Sentinel incidents to TISC Workspace.",
            "prerequisites": [
              "ServiceNow TISC Custom Connector needs to be deployed prior to the deployment of this playbook under the same subscription."
            ],
            "postDeployment": [
              "1. Once deployment is complete, you will need to configure/authorize each connection.",
              "2. Navigate to playbook > API Connections > Select connections one by one > configure/authorize each connection > Save"
            ],
            "lastUpdateTime": "2025-01-10T00:00:00Z",
            "entities": [
              "filehash"
            ],
            "tags": [
              "Threat Intelligence",
              "ServiceNow TISC"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId3')]",
        "contentKind": "Playbook",
        "displayName": "ServiceNowTISC-Export_Hash_Entity",
        "contentProductId": "[variables('_playbookcontentProductId3')]",
        "id": "[variables('_playbookcontentProductId3')]",
        "version": "[variables('playbookVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ServiceNowTISC-Export_Incident_Entities Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "ServiceNowTISC-Export_Incident_Entities",
              "type": "string"
            },
            "CustomConnectorName": {
              "defaultValue": "ServiceNowTISCCustomConnector",
              "type": "string",
              "metadata": {
                "description": "Name of the custom connector, if you want to change the default name, make sure to use the same when you were installing ServiceNowTISC custom connector"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "ServiceNowTISC-MicrosoftSentinelConnection",
            "ServicenowTISCCustomConnectorConnectionName": "[[concat('Connection-', parameters('CustomConnectorName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Disabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "For_each": {
                      "foreach": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                      "actions": {
                        "Parse_Entity": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('For_each')",
                            "schema": {
                              "properties": {
                                "id": {
                                  "type": "string"
                                },
                                "kind": {
                                  "type": "string"
                                },
                                "properties": {
                                  "type": "object"
                                },
                                "type": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "Switch_on_Entity_Kind": {
                          "runAfter": {
                            "Parse_Entity": [
                              "Succeeded"
                            ]
                          },
                          "cases": {
                            "Domain": {
                              "case": "DnsResolution",
                              "actions": {
                                "Parse_JSON_-_DNS_Resolution": {
                                  "type": "ParseJson",
                                  "inputs": {
                                    "content": "@body('Parse_Entity')?['properties']",
                                    "schema": {
                                      "properties": {
                                        "domainName": {
                                          "type": "string"
                                        },
                                        "friendlyName": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  }
                                },
                                "Append_to_Domain_value_to_array": {
                                  "runAfter": {
                                    "Parse_JSON_-_DNS_Resolution": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "ObservablesArray",
                                    "value": {
                                      "value": "@{body('Parse_JSON_-_DNS_Resolution')?['domainName']}",
                                      "type": "domain_name"
                                    }
                                  }
                                }
                              }
                            },
                            "FileHash": {
                              "case": "FileHash",
                              "actions": {
                                "Parse_JSON_-_File_Hash": {
                                  "type": "ParseJson",
                                  "inputs": {
                                    "content": "@body('Parse_Entity')?['properties']",
                                    "schema": {
                                      "properties": {
                                        "algorithm": {
                                          "type": "string"
                                        },
                                        "friendlyName": {
                                          "type": "string"
                                        },
                                        "hashValue": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  }
                                },
                                "Switch_on_Hash_Algorithm": {
                                  "runAfter": {
                                    "Parse_JSON_-_File_Hash": [
                                      "Succeeded"
                                    ]
                                  },
                                  "cases": {
                                    "MD5": {
                                      "case": "MD5",
                                      "actions": {
                                        "Append_MD5_hash_value_to_array": {
                                          "type": "AppendToArrayVariable",
                                          "inputs": {
                                            "name": "ObservablesArray",
                                            "value": {
                                              "value": "@{body('Parse_JSON_-_File_Hash')?['hashValue']}",
                                              "type": "md5_hash"
                                            }
                                          }
                                        }
                                      }
                                    },
                                    "SHA256": {
                                      "case": "SHA256",
                                      "actions": {
                                        "Apend_SHA256_hash_value_to_array": {
                                          "type": "AppendToArrayVariable",
                                          "inputs": {
                                            "name": "ObservablesArray",
                                            "value": {
                                              "value": "@{body('Parse_JSON_-_File_Hash')?['hashValue']}",
                                              "type": "sha256_hash"
                                            }
                                          }
                                        }
                                      }
                                    }
                                  },
                                  "expression": "@body('Parse_JSON_-_File_Hash')?['algorithm']",
                                  "type": "Switch"
                                }
                              }
                            },
                            "Url": {
                              "case": "Url",
                              "actions": {
                                "Parse_JSON_-_Url": {
                                  "type": "ParseJson",
                                  "inputs": {
                                    "content": "@body('Parse_Entity')?['properties']",
                                    "schema": {
                                      "properties": {
                                        "friendlyName": {
                                          "type": "string"
                                        },
                                        "url": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  }
                                },
                                "Append_URL_value_to_array": {
                                  "runAfter": {
                                    "Parse_JSON_-_Url": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "ObservablesArray",
                                    "value": {
                                      "value": "@{body('Parse_JSON_-_Url')?['url']}",
                                      "type": "url"
                                    }
                                  }
                                }
                              }
                            },
                            "Ip": {
                              "case": "Ip",
                              "actions": {
                                "Parse_JSON_-_Ip": {
                                  "type": "ParseJson",
                                  "inputs": {
                                    "content": "@body('Parse_Entity')?['properties']",
                                    "schema": {
                                      "properties": {
                                        "address": {
                                          "type": "string"
                                        },
                                        "friendlyName": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  }
                                },
                                "Check_if_it_is_IPv6_address_format": {
                                  "actions": {
                                    "Append_IPv6_value_to_array": {
                                      "type": "AppendToArrayVariable",
                                      "inputs": {
                                        "name": "ObservablesArray",
                                        "value": {
                                          "value": "@{body('Parse_JSON_-_Ip')?['address']}",
                                          "type": "ip_v6_address"
                                        }
                                      }
                                    }
                                  },
                                  "runAfter": {
                                    "Parse_JSON_-_Ip": [
                                      "Succeeded"
                                    ]
                                  },
                                  "else": {
                                    "actions": {
                                      "Append_to_IPv4_value_to_array": {
                                        "type": "AppendToArrayVariable",
                                        "inputs": {
                                          "name": "ObservablesArray",
                                          "value": {
                                            "value": "@{body('Parse_JSON_-_Ip')?['address']}",
                                            "type": "ip_v4_address"
                                          }
                                        }
                                      }
                                    }
                                  },
                                  "expression": {
                                    "and": [
                                      {
                                        "equals": [
                                          "@contains(body('Parse_JSON_-_Ip')?['address'],':')",
                                          true
                                        ]
                                      }
                                    ]
                                  },
                                  "type": "If"
                                }
                              }
                            }
                          },
                          "expression": "@body('Parse_Entity')?['kind']",
                          "type": "Switch"
                        }
                      },
                      "runAfter": {
                        "Parameter_Default_Values": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Declare_Observables_Array": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "ObservablesArray",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Condition_-_Have_entities_to_export": {
                      "actions": {
                        "Add_Observables_TISC_API": {
                          "type": "ApiConnection",
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['ServicenowTISCCustomConnector']['connectionId']"
                              }
                            },
                            "method": "post",
                            "body": {
                              "source": "Microsoft Sentinel",
                              "observables": "@variables('ObservablesArray')"
                            },
                            "path": "/api/sn_sec_tisc/threat_intel_data/add_observables"
                          }
                        }
                      },
                      "runAfter": {
                        "For_each": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(variables('ObservablesArray'))",
                              0
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Parameter_Default_Values": {
                      "runAfter": {
                        "Declare_Observables_Array": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": {
                          "type": "domain_name",
                          "reputation": "malicious",
                          "confidence": "90"
                        },
                        "schema": {
                          "type": "object",
                          "properties": {
                            "type": {
                              "type": "string"
                            },
                            "reputation": {
                              "type": "string"
                            },
                            "confidence": {
                              "type": "string"
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "ServicenowTISCCustomConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]",
                        "connectionName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "ServiceNowTISC-Export_Incident_Entities",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "ServiceNow TISC",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "ServiceNow"
                },
                "support": {
                  "name": "ServiceNow",
                  "tier": "Partner",
                  "link": "https://support.servicenow.com/now"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_ServiceNowTISCCustomConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Export all Incident Entities to TISC",
            "description": "This playbook leverages the ServiceNow TISC API to export IP, Domain, URL, and Hash indicators found in Microsoft Sentinel incidents to TISC Workspace.",
            "prerequisites": [
              "ServiceNow TISC Custom Connector needs to be deployed prior to the deployment of this playbook under the same subscription."
            ],
            "postDeployment": [
              "1. Once deployment is complete, you will need to configure/authorize each connection.",
              "2. Navigate to playbook > API Connections > Select connections one by one > configure/authorize each connection > Save"
            ],
            "lastUpdateTime": "2025-01-10T00:00:00Z",
            "entities": [
              "ip",
              "filehash",
              "url",
              "dns"
            ],
            "tags": [
              "Threat Intelligence",
              "ServiceNow TISC"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId4')]",
        "contentKind": "Playbook",
        "displayName": "ServiceNowTISC-Export_Incident_Entities",
        "contentProductId": "[variables('_playbookcontentProductId4')]",
        "id": "[variables('_playbookcontentProductId4')]",
        "version": "[variables('playbookVersion4')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ServiceNowTISC-Export_IP_Entity Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion5')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "ServiceNowTISC-Export_IP_Entity",
              "type": "string"
            },
            "CustomConnectorName": {
              "defaultValue": "ServiceNowTISCCustomConnector",
              "type": "string",
              "metadata": {
                "description": "Name of the custom connector, if you want to change the default name, make sure to use the same when you were installing ServiceNowTISC custom connector"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "ServiceNowTISC-MicrosoftSentinelConnection",
            "ServicenowTISCCustomConnectorConnectionName": "[[concat('Connection-', parameters('CustomConnectorName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Disabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_entity": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "path": "/entity/@{encodeURIComponent('IP')}"
                      }
                    }
                  },
                  "actions": {
                    "Parse_IP_Entity": {
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@triggerBody()?['Entity']",
                        "schema": {
                          "type": "object",
                          "properties": {
                            "type": {
                              "type": "string"
                            },
                            "kind": {
                              "type": "string"
                            },
                            "properties": {
                              "type": "object",
                              "properties": {
                                "address": {
                                  "type": "string"
                                },
                                "friendlyName": {
                                  "type": "string"
                                }
                              }
                            }
                          }
                        }
                      }
                    },
                    "Check_if_it_is_IPv6_address_format": {
                      "actions": {
                        "Add_Observables_TISC_API_-_IPv6": {
                          "type": "ApiConnection",
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['ServicenowTISCCustomConnector']['connectionId']"
                              }
                            },
                            "method": "post",
                            "body": {
                              "source": "Microsoft Sentinel",
                              "observables": [
                                {
                                  "value": "@{body('Parse_IP_Entity')?['properties']?['address']}",
                                  "type": "ip_v6_address"
                                }
                              ]
                            },
                            "path": "/api/sn_sec_tisc/threat_intel_data/add_observables"
                          }
                        }
                      },
                      "runAfter": {
                        "Parse_IP_Entity": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Add_Observables_TISC_API_-_IPv4": {
                            "type": "ApiConnection",
                            "inputs": {
                              "host": {
                                "connection": {
                                  "name": "@parameters('$connections')['ServicenowTISCCustomConnector']['connectionId']"
                                }
                              },
                              "method": "post",
                              "body": {
                                "source": "Microsoft Sentinel",
                                "observables": [
                                  {
                                    "value": "@{body('Parse_IP_Entity')?['properties']?['address']}",
                                    "type": "ip_v4_address"
                                  }
                                ]
                              },
                              "path": "/api/sn_sec_tisc/threat_intel_data/add_observables"
                            }
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "equals": [
                              "@contains(body('Parse_IP_Entity')?['properties']?['address'], ':')",
                              true
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "ServicenowTISCCustomConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]",
                        "connectionName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "ServiceNowTISC-Export_IP_Entity",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId5'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId5')]",
                "contentId": "[variables('_playbookContentId5')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "ServiceNow TISC",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "ServiceNow"
                },
                "support": {
                  "name": "ServiceNow",
                  "tier": "Partner",
                  "link": "https://support.servicenow.com/now"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_ServiceNowTISCCustomConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Export IP Entity to TISC",
            "description": "This playbook leverages the ServiceNow TISC API to export IP indicators found in Microsoft Sentinel incidents to TISC Workspace.",
            "prerequisites": [
              "ServiceNow TISC Custom Connector needs to be deployed prior to the deployment of this playbook under the same subscription."
            ],
            "postDeployment": [
              "1. Once deployment is complete, you will need to configure/authorize each connection.",
              "2. Navigate to playbook > API Connections > Select connections one by one > configure/authorize each connection > Save"
            ],
            "lastUpdateTime": "2025-01-10T00:00:00Z",
            "entities": [
              "ip"
            ],
            "tags": [
              "Threat Intelligence",
              "ServiceNow TISC"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId5')]",
        "contentKind": "Playbook",
        "displayName": "ServiceNowTISC-Export_IP_Entity",
        "contentProductId": "[variables('_playbookcontentProductId5')]",
        "id": "[variables('_playbookcontentProductId5')]",
        "version": "[variables('playbookVersion5')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ServiceNowTISC-Export_URL_Entity Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion6')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "ServiceNowTISC-Export_URL_Entity",
              "type": "string"
            },
            "CustomConnectorName": {
              "defaultValue": "ServiceNowTISCCustomConnector",
              "type": "string",
              "metadata": {
                "description": "Name of the custom connector, if you want to change the default name, make sure to use the same when you were installing ServiceNowTISC custom connector"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "ServiceNowTISC-MicrosoftSentinelConnection",
            "ServicenowTISCCustomConnectorConnectionName": "[[concat('Connection-', parameters('CustomConnectorName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Disabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_entity": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "path": "/entity/@{encodeURIComponent('UrlEntity')}"
                      }
                    }
                  },
                  "actions": {
                    "Parse_URL_Entity": {
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@triggerBody()?['Entity']",
                        "schema": {
                          "type": "object",
                          "properties": {
                            "type": {
                              "type": "string"
                            },
                            "kind": {
                              "type": "string"
                            },
                            "properties": {
                              "type": "object",
                              "properties": {
                                "friendlyName": {
                                  "type": "string"
                                },
                                "url": {
                                  "type": "string"
                                }
                              }
                            }
                          }
                        }
                      }
                    },
                    "Add_Observable_TISC_API_-_URL": {
                      "runAfter": {
                        "Parse_URL_Entity": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['ServicenowTISCCustomConnector']['connectionId']"
                          }
                        },
                        "method": "post",
                        "body": {
                          "source": "Microsoft Sentinel",
                          "observables": [
                            {
                              "value": "@{body('Parse_URL_Entity')?['properties']?['url']}",
                              "type": "url"
                            }
                          ]
                        },
                        "path": "/api/sn_sec_tisc/threat_intel_data/add_observables"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "ServicenowTISCCustomConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]",
                        "connectionName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "ServiceNowTISC-Export_URL_Entity",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId6'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId6')]",
                "contentId": "[variables('_playbookContentId6')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "ServiceNow TISC",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "ServiceNow"
                },
                "support": {
                  "name": "ServiceNow",
                  "tier": "Partner",
                  "link": "https://support.servicenow.com/now"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_ServiceNowTISCCustomConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Export URL Entity to TISC",
            "description": "This playbook leverages the ServiceNow TISC API to export URL indicators found in Microsoft Sentinel incidents to TISC Workspace",
            "prerequisites": [
              "ServiceNow TISC Custom Connector needs to be deployed prior to the deployment of this playbook under the same subscription."
            ],
            "postDeployment": [
              "1. Once deployment is complete, you will need to configure/authorize each connection.",
              "2. Navigate to playbook > API Connections > Select connections one by one > configure/authorize each connection > Save"
            ],
            "lastUpdateTime": "2025-01-10T00:00:00Z",
            "entities": [
              "url"
            ],
            "tags": [
              "Threat Intelligence",
              "ServiceNow TISC"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId6')]",
        "contentKind": "Playbook",
        "displayName": "ServiceNowTISC-Export_URL_Entity",
        "contentProductId": "[variables('_playbookcontentProductId6')]",
        "id": "[variables('_playbookcontentProductId6')]",
        "version": "[variables('playbookVersion6')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName7')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ServiceNowTISC-Batch_Indicator_Uploader Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion7')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "ServiceNowTISC-Batch_Indicator_Uploader",
              "type": "string"
            },
            "WorkspaceID": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Microsoft Sentinel WorkspaceID, guid format (example:85a5bccc-7a5c-4e3f-ad57-36be224c4d2e). WorkspaceID can be found under Log Analytics Workspaces blade. "
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "ServiceNowTISC-MicrosoftSentinelConnection",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Disabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "WorkspaceId": {
                      "defaultValue": "[[parameters('WorkspaceId')]",
                      "type": "String"
                    }
                  },
                  "triggers": {
                    "Batch_Trigger": {
                      "type": "Batch",
                      "inputs": {
                        "mode": "Inline",
                        "configurations": {
                          "ServiceNowImportTISC": {
                            "releaseCriteria": {
                              "messageCount": 100,
                              "recurrence": {
                                "frequency": "Minute",
                                "interval": 1
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "actions": {
                    "Select": {
                      "type": "Select",
                      "inputs": {
                        "from": "@triggerBody()['items']",
                        "select": "@item()['content']"
                      }
                    },
                    "Threat_Intelligence_-_Upload_Indicators_of_Compromise_(V2)_(Preview)": {
                      "runAfter": {
                        "Select": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "body": {
                          "indicators": "@body('Select')",
                          "sourcesystem": "ServiceNow TISC"
                        },
                        "path": "[[concat( '/V2/ThreatIntelligence/',parameters('WorkspaceID'),'/UploadIndicators/')]",
                        "retryPolicy": {
                          "count": 10,
                          "interval": "PT20S",
                          "maximumInterval": "PT1H",
                          "minimumInterval": "PT10S",
                          "type": "exponential"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "ServiceNowTISC-Batch_Indicator_Uploader",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId7'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId7')]",
                "contentId": "[variables('_playbookContentId7')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion7')]",
                "source": {
                  "kind": "Solution",
                  "name": "ServiceNow TISC",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "ServiceNow"
                },
                "support": {
                  "name": "ServiceNow",
                  "tier": "Partner",
                  "link": "https://support.servicenow.com/now"
                }
              }
            }
          ],
          "metadata": {
            "title": "ServiceNow TISC Batch Indicator Uploader",
            "description": "This playbook will write indicators in batch to ThreatIntelligenceIndicator log analytics table. This playbook referenced by **ServiceNowTISC-Import_Observables_Batch** playbook -- which calls the ServiceNow TISC API to get observables and then calls this playbook to write them to ThreatIntelligenceIndicator table.",
            "prerequisites": [
              "Microsoft Sentinel Threat Intelligence is active"
            ],
            "postDeployment": [
              "1. Once deployment is complete, you will need to configure/authorize each connection.",
              "2. Install the dependant playbook **ServiceNowTISC-Import_Observables_Batch** to start importing observables from ServiceNow TISC."
            ],
            "lastUpdateTime": "2025-01-10T00:00:00Z",
            "entities": [
              "ip",
              "filehash",
              "url",
              "dns"
            ],
            "tags": [
              "Threat Intelligence",
              "ServiceNow TISC"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId7')]",
        "contentKind": "Playbook",
        "displayName": "ServiceNowTISC-Batch_Indicator_Uploader",
        "contentProductId": "[variables('_playbookcontentProductId7')]",
        "id": "[variables('_playbookcontentProductId7')]",
        "version": "[variables('playbookVersion7')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName8')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ServiceNowTISC-Import_Observables_Batch Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion8')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "ServiceNowTISC-Import_Observables_Batch",
              "type": "string"
            },
            "CustomConnectorName": {
              "defaultValue": "ServiceNowTISCCustomConnector",
              "type": "string",
              "metadata": {
                "description": "Name of the custom connector, if you want to change the default name, make sure to use the same when you were installing ServiceNowTISC custom connector"
              }
            },
            "IndicatorsUploadBatchingPlaybookname": {
              "defaultValue": "ServiceNowTISC-Batch_Indicator_Uploader",
              "type": "String",
              "metadata": {
                "description": "Name of the Indicators Upload Batching Playbook"
              }
            }
          },
          "variables": {
            "ServicenowTISCCustomConnectorConnectionName": "[[concat('Connection-', parameters('CustomConnectorName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Disabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "interval": 24,
                        "frequency": "Hour",
                        "timeZone": "India Standard Time",
                        "startTime": "2024-11-26T13:00:00Z"
                      },
                      "evaluatedRecurrence": {
                        "interval": 24,
                        "frequency": "Hour",
                        "timeZone": "India Standard Time",
                        "startTime": "2024-11-26T13:00:00Z"
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "Next_page_token": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Next page token",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "Until": {
                      "actions": {
                        "Import_Observables_in_Indicator_STIX_format_TISC_API": {
                          "type": "ApiConnection",
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['ServicenowTISCCustomConnector']['connectionId']"
                              }
                            },
                            "method": "post",
                            "body": {
                              "page_size": 100,
                              "page_token": "@variables('Next page token')",
                              "types": "[variables('TemplateEmptyArray')]",
                              "reputation": "[variables('TemplateEmptyArray')]",
                              "threat_severity": "[variables('TemplateEmptyArray')]",
                              "threat_level": "[variables('TemplateEmptyArray')]",
                              "delta_hours": 24
                            },
                            "path": "/api/sn_sec_tisc/threat_intel_data/observables_indicator_stix_format"
                          }
                        },
                        "For_each": {
                          "foreach": "@body('Import_Observables_in_Indicator_STIX_format_TISC_API')?['indicators']",
                          "actions": {
                            "ServiceNowTISC-Batch_Indicator_Uploader": {
                              "type": "SendToBatch",
                              "inputs": {
                                "batchName": "ServiceNowImportTISC",
                                "content": "@items('For_each')",
                                "host": {
                                  "triggerName": "Batch_Trigger",
                                  "workflow": {
                                    "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('IndicatorsUploadBatchingPlaybookname'))]"
                                  }
                                }
                              }
                            }
                          },
                          "runAfter": {
                            "Import_Observables_in_Indicator_STIX_format_TISC_API": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Set_next_page_token": {
                          "runAfter": {
                            "For_each": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Next page token",
                            "value": "@body('Import_Observables_in_Indicator_STIX_format_TISC_API')?['next_page_token']"
                          }
                        },
                        "Set_last_page_flag": {
                          "runAfter": {
                            "Set_next_page_token": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Last page flag",
                            "value": "@body('Import_Observables_in_Indicator_STIX_format_TISC_API')?['is_last_page']"
                          }
                        }
                      },
                      "runAfter": {
                        "Last_page_flag": [
                          "Succeeded"
                        ]
                      },
                      "expression": "@equals(variables('Last page flag'),true)",
                      "limit": {
                        "count": 1000
                      },
                      "type": "Until"
                    },
                    "Last_page_flag": {
                      "runAfter": {
                        "Next_page_token": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Last page flag",
                            "type": "boolean",
                            "value": true
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "ServicenowTISCCustomConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]",
                        "connectionName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "ServiceNowTISC-Import_Observables_Batch",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId8'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId8')]",
                "contentId": "[variables('_playbookContentId8')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion8')]",
                "source": {
                  "kind": "Solution",
                  "name": "ServiceNow TISC",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "ServiceNow"
                },
                "support": {
                  "name": "ServiceNow",
                  "tier": "Partner",
                  "link": "https://support.servicenow.com/now"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_ServiceNowTISCCustomConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "ServiceNow TISC Import Observables from TISC",
            "description": "This playbook leverages the ServiceNow TISC API to import IP, Domain, URL, and Hash observables from TISC Workspace to Microsoft  ThreatIntelligenceIndicator log analytics table. The imported observables can be seen under the Threat Intelligence tab in Microsoft Sentinel Workspace.",
            "prerequisites": [
              "1. ServiceNow TISC Custom Connector needs to be deployed prior to the deployment of this playbook under the same subscription.",
              "2. **ServiceNowTISC-Batch_Indicator_Uploader** playbook needs to be deployed prior to the deployment of this playbook under the same subscription."
            ],
            "postDeployment": [
              "1. Once deployment is complete, you will need to configure/authorize each API connection.",
              "2. Navigate to playbook > API Connections > Select connections one by one > configure/authorize each connection > Save"
            ],
            "lastUpdateTime": "2025-01-10T00:00:00Z",
            "entities": [
              "ip",
              "filehash",
              "url",
              "dns"
            ],
            "tags": [
              "Threat Intelligence",
              "ServiceNow TISC"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId8')]",
        "contentKind": "Playbook",
        "displayName": "ServiceNowTISC-Import_Observables_Batch",
        "contentProductId": "[variables('_playbookcontentProductId8')]",
        "id": "[variables('_playbookcontentProductId8')]",
        "version": "[variables('playbookVersion8')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName9')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ServiceNowTISC-Incident_Enrichment Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion9')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "ServiceNowTISC-Incident_Enrichment",
              "type": "string"
            },
            "CustomConnectorName": {
              "defaultValue": "ServiceNowTISCCustomConnector",
              "type": "string",
              "metadata": {
                "description": "Name of the custom connector, if you want to change the default name, make sure to use the same when you were installing ServiceNowTISC custom connector"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "ServiceNowTISC-MicrosoftSentinelConnection",
            "ServicenowTISCCustomConnectorConnectionName": "[[concat('Connection-', parameters('CustomConnectorName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Disabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "For_each_entity": {
                      "foreach": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                      "actions": {
                        "Parse_Entity": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('For_each_entity')",
                            "schema": {
                              "properties": {
                                "id": {
                                  "type": "string"
                                },
                                "kind": {
                                  "type": "string"
                                },
                                "properties": {
                                  "type": "object"
                                },
                                "type": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "Switch_on_Entity_Kind": {
                          "runAfter": {
                            "Parse_Entity": [
                              "Succeeded"
                            ]
                          },
                          "cases": {
                            "Domain": {
                              "case": "DnsResolution",
                              "actions": {
                                "Parse_JSON_-_DNS_Resolution": {
                                  "type": "ParseJson",
                                  "inputs": {
                                    "content": "@body('Parse_Entity')?['properties']",
                                    "schema": {
                                      "properties": {
                                        "domainName": {
                                          "type": "string"
                                        },
                                        "friendlyName": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  }
                                },
                                "Append_domain_value_to_Entity_array": {
                                  "runAfter": {
                                    "Parse_JSON_-_DNS_Resolution": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "EntityValues",
                                    "value": {
                                      "field_name": "value",
                                      "operator": "=",
                                      "field_value": "@{body('Parse_JSON_-_DNS_Resolution')?['domainName']}"
                                    }
                                  }
                                }
                              }
                            },
                            "FileHash": {
                              "case": "FileHash",
                              "actions": {
                                "Parse_JSON_-_File_Hash": {
                                  "type": "ParseJson",
                                  "inputs": {
                                    "content": "@body('Parse_Entity')?['properties']",
                                    "schema": {
                                      "properties": {
                                        "algorithm": {
                                          "type": "string"
                                        },
                                        "friendlyName": {
                                          "type": "string"
                                        },
                                        "hashValue": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  }
                                },
                                "Append_Hash_value_to_Entity_array": {
                                  "runAfter": {
                                    "Parse_JSON_-_File_Hash": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "EntityValues",
                                    "value": {
                                      "field_name": "value",
                                      "operator": "=",
                                      "field_value": "@{body('Parse_JSON_-_File_Hash')?['hashValue']}"
                                    }
                                  }
                                }
                              }
                            },
                            "Url": {
                              "case": "Url",
                              "actions": {
                                "Parse_JSON_-_Url": {
                                  "type": "ParseJson",
                                  "inputs": {
                                    "content": "@body('Parse_Entity')?['properties']",
                                    "schema": {
                                      "properties": {
                                        "friendlyName": {
                                          "type": "string"
                                        },
                                        "url": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  }
                                },
                                "Append_URL_value_to_Entity_array": {
                                  "runAfter": {
                                    "Parse_JSON_-_Url": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "EntityValues",
                                    "value": {
                                      "field_name": "value",
                                      "operator": "=",
                                      "field_value": "@{body('Parse_JSON_-_Url')?['url']}"
                                    }
                                  }
                                }
                              }
                            },
                            "Ip": {
                              "case": "Ip",
                              "actions": {
                                "Parse_JSON_-_Ip": {
                                  "type": "ParseJson",
                                  "inputs": {
                                    "content": "@body('Parse_Entity')?['properties']",
                                    "schema": {
                                      "properties": {
                                        "address": {
                                          "type": "string"
                                        },
                                        "friendlyName": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  }
                                },
                                "Append_IP_value_to_Entity_array": {
                                  "runAfter": {
                                    "Parse_JSON_-_Ip": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "EntityValues",
                                    "value": {
                                      "field_name": "value",
                                      "operator": "=",
                                      "field_value": "@{body('Parse_JSON_-_Ip')?['address']}"
                                    }
                                  }
                                }
                              }
                            }
                          },
                          "expression": "@body('Parse_Entity')?['kind']",
                          "type": "Switch"
                        }
                      },
                      "runAfter": {
                        "Initialize_Entity_Values_array": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Initialize_Entity_Values_array": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "EntityValues",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Entity_Value_array_is_not_empty": {
                      "actions": {
                        "Until": {
                          "actions": {
                            "Fetch_Observables_TISC_API": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['ServicenowTISCCustomConnector']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "body": {
                                  "page_size": "100",
                                  "page_token": "@{variables('NextPageToken')}",
                                  "included_fields": {
                                    "observable": {
                                      "common_fields": {
                                        "include_all_fields": true
                                      }
                                    }
                                  },
                                  "observable_filters": {
                                    "boolean_operator": "AND",
                                    "filters": [
                                      {
                                        "field_name": "status",
                                        "operator": "=",
                                        "field_value": "active"
                                      },
                                      {
                                        "boolean_operator": "OR",
                                        "filters": "@variables('EntityValues')"
                                      }
                                    ]
                                  }
                                },
                                "path": "/api/sn_sec_tisc/threat_intel_data/observables"
                              }
                            },
                            "For_each_observable_returned_from_TISC": {
                              "foreach": "@body('Fetch_Observables_TISC_API')?['observables']",
                              "actions": {
                                "Add_comment_to_incident_(V3)": {
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p class=\"editor-paragraph\"><br>Found below information from ServiceNow-TISC for @{item()?['value']} (@{item()?['type']})<br>----------------------------------------------------------------------<br>Reputation: @{item()?['reputation']}<br>Threat Severity: @{item()?['threat_severity']}<br>Confidence: @{item()?['confidence']}<br>Last Update: @{item()?['sys_updated_on']}<br>----------------------------------------------------------------------</p>"
                                    },
                                    "path": "/Incidents/Comment"
                                  }
                                }
                              },
                              "runAfter": {
                                "Fetch_Observables_TISC_API": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Foreach"
                            },
                            "Set_next_page_token": {
                              "runAfter": {
                                "For_each_observable_returned_from_TISC": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "NextPageToken",
                                "value": "@body('Fetch_Observables_TISC_API')?['next_page_token']"
                              }
                            },
                            "Set_last_page_variable": {
                              "runAfter": {
                                "Set_next_page_token": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "IsLastPage",
                                "value": "@body('Fetch_Observables_TISC_API')?['is_last_page']"
                              }
                            }
                          },
                          "expression": "@equals(variables('IsLastPage'),true)",
                          "limit": {
                            "count": 1000,
                            "timeout": "PT1H"
                          },
                          "type": "Until"
                        }
                      },
                      "runAfter": {
                        "IsLastPage_variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "equals": [
                              "@empty(variables('EntityValues'))",
                              false
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "IsLastPage_variable": {
                      "runAfter": {
                        "Next_page_token": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "IsLastPage",
                            "type": "boolean",
                            "value": true
                          }
                        ]
                      }
                    },
                    "Next_page_token": {
                      "runAfter": {
                        "For_each_entity": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "NextPageToken",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "ServicenowTISCCustomConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]",
                        "connectionName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "ServiceNowTISC-Incident_Enrichment",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('ServicenowTISCCustomConnectorConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('ServicenowTISCCustomConnectorConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId9'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId9')]",
                "contentId": "[variables('_playbookContentId9')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion9')]",
                "source": {
                  "kind": "Solution",
                  "name": "ServiceNow TISC",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "ServiceNow"
                },
                "support": {
                  "name": "ServiceNow",
                  "tier": "Partner",
                  "link": "https://support.servicenow.com/now"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_ServiceNowTISCCustomConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "ServiceNow TISC Incident Enrichment",
            "description": "This playbook leverages the ServiceNow TISC API to enrich IP, Domain, URL, and Hash indicators found in Microsoft Sentinel incidents. The enrichment content will be posted as a comment in the Microsoft Sentinel incident.",
            "prerequisites": [
              "ServiceNow TISC Custom Connector needs to be deployed prior to the deployment of this playbook under the same subscription."
            ],
            "postDeployment": [
              "1. Once deployment is complete, you will need to configure/authorize each connection.",
              "2. Navigate to playbook > API Connections > Select connections one by one > configure/authorize each connection > Save"
            ],
            "lastUpdateTime": "2025-01-10T00:00:00Z",
            "entities": [
              "ip",
              "filehash",
              "url",
              "dns"
            ],
            "tags": [
              "Threat Intelligence",
              "ServiceNow TISC"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId9')]",
        "contentKind": "Playbook",
        "displayName": "ServiceNowTISC-Incident_Enrichment",
        "contentProductId": "[variables('_playbookcontentProductId9')]",
        "id": "[variables('_playbookcontentProductId9')]",
        "version": "[variables('playbookVersion9')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "ServiceNow TISC",
        "publisherDisplayName": "ServiceNow",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p> Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/ServiceNow%20TISC/ReleaseNotes.md\">Release Notes</a></p>\n<p> There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>ServiceNow's Threat Intelligence Security Center (TISC) is an advanced security intelligence platform, and this solution integrates with Microsoft Sentinel to provide comprehensive threat detection, analysis, and response capabilities. This integration enables organizations to aggregate threat intelligence from multiple sources, automate security workflows, and enhance their overall security posture. The solution facilitates bi-directional data exchange between TISC and Microsoft Sentinel, allowing security teams to seamlessly share threat indicators and observables across both platforms. The integration supports incident enrichment workflows, enabling security analysts to make more informed decisions based on consolidated threat intelligence. Through custom connectors and playbooks, the solution streamlines security operations by automating threat data correlation, reducing manual effort, and accelerating incident response times.</p>\n<p><strong>Custom Azure Logic Apps Connectors:</strong> 1, <strong>Playbooks:</strong> 8</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/ServiceNow.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "ServiceNow TISC",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "ServiceNow"
        },
        "support": {
          "name": "ServiceNow",
          "tier": "Partner",
          "link": "https://support.servicenow.com/now"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "LogicAppsCustomConnector",
              "contentId": "[variables('_ServiceNowTISCCustomConnector')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_ServiceNowTISC-Export_Domain_Entity')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_ServiceNowTISC-Export_Hash_Entity')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_ServiceNowTISC-Export_Incident_Entities')]",
              "version": "[variables('playbookVersion4')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_ServiceNowTISC-Export_IP_Entity')]",
              "version": "[variables('playbookVersion5')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_ServiceNowTISC-Export_URL_Entity')]",
              "version": "[variables('playbookVersion6')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_ServiceNowTISC-Batch_Indicator_Uploader')]",
              "version": "[variables('playbookVersion7')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_ServiceNowTISC-Import_Observables_Batch')]",
              "version": "[variables('playbookVersion8')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_ServiceNowTISC-Incident_Enrichment')]",
              "version": "[variables('playbookVersion9')]"
            }
          ]
        },
        "firstPublishDate": "2025-01-15",
        "lastPublishDate": "2025-01-15",
        "providers": [
          "ServiceNow"
        ],
        "categories": {
          "domains": [
            "Security - Threat Intelligence"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
