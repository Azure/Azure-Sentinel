[
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2024-09-01",
    "name": "CrowdStrikeVulnerabilitiesPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "OAuth2",
        "ClientId": "[[parameters('clientId')]",
        "ClientSecret": "[[parameters('clientSecret')]",
        "GrantType": "client_credentials",
        "TokenEndpoint": "[[concat(parameters('apiUrl'),'/oauth2/token')]",
        "TokenEndpointHeaders": {
          "Accept": "application/json",
          "Content-Type": "application/x-www-form-urlencoded"
        }
      },
      "request": {
        "apiEndpoint": "[[concat(parameters('apiUrl'),'/spotlight/combined/vulnerabilities/v1')]",
        "httpMethod": "GET",
        "rateLimitQPS": 1,
        "rateLimitConfig": {
          "evaluation": {
            "checkMode": "OnlyWhen429"
          },
          "extraction": {
            "source": "CustomHeaders",
            "headers": {
              "limit": {
                "name": "X-RateLimit-Limit",
                "format": "Integer"
              },
              "remaining": {
                "name": "X-RateLimit-Remaining",
                "format": "Integer"
              },
              "reset": {
                "name": "X-RateLimit-RetryAfter",
                "format": "UnixTimeSeconds"
              }
            }
          },
          "retryStrategy": {
            "useResetOrRetryAfterHeaders": true
          }
        },
        "queryWindowInMin": 15,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 90,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "filter": "updated_timestamp:>'{_QueryWindowStartTime}'+updated_timestamp:<='{_QueryWindowEndTime}'",
          "sort": "updated_timestamp.asc"
        }
      },
      "response": {
        "eventsJsonPaths": [
          "$.resources"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "NextPageToken",
        "nextPageTokenJsonPath": "$.meta.pagination.after",
        "NextPageParaName": "after",
        "pageSize": 500,
        "pageSizeParameterName": "limit"
      },
      "connectorDefinitionName": "CrowdStrikeAPICCPDefinition",
      "dataType": "CrowdStrikeVulnerabilities",
      "dcrConfig": {
        "streamName": "SENTINEL_CROWDSTRIKEVULNERABILITIES",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2024-09-01",
    "name": "CrowdStrikeAlertsPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "OAuth2",
        "ClientId": "[[parameters('clientId')]",
        "ClientSecret": "[[parameters('clientSecret')]",
        "GrantType": "client_credentials",
        "TokenEndpoint": "[[concat(parameters('apiUrl'),'/oauth2/token')]",
        "TokenEndpointHeaders": {
          "Accept": "application/json",
          "Content-Type": "application/x-www-form-urlencoded"
        }
      },
      "request": {
        "apiEndpoint": "[[concat(parameters('apiUrl'),'/alerts/combined/alerts/v1')]",
        "httpMethod": "POST",
        "rateLimitQPS": 1,
        "rateLimitConfig": {
          "evaluation": {
            "checkMode": "OnlyWhen429"
          },
          "extraction": {
            "source": "CustomHeaders",
            "headers": {
              "limit": {
                "name": "X-RateLimit-Limit",
                "format": "Integer"
              },
              "remaining": {
                "name": "X-RateLimit-Remaining",
                "format": "Integer"
              },
              "reset": {
                "name": "X-RateLimit-RetryAfter",
                "format": "UnixTimeSeconds"
              }
            }
          },
          "retryStrategy": {
            "useResetOrRetryAfterHeaders": true
          }
        },
        "queryWindowInMin": 15,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 120,
        "isPostPayloadJson": true,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParametersTemplate": "{\r\n                    \"filter\": \"created_timestamp:>'{_QueryWindowStartTime}'+created_timestamp:<='{_QueryWindowEndTime}'\",\r\n                    \"sort\": \"created_timestamp.asc\"\r\n                }"
      },
      "response": {
        "eventsJsonPaths": [
          "$.resources"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "PersistentToken",
        "nextPageTokenJsonPath": "$.meta.pagination.after",
        "nextPageParaName": "after",
        "pageSize": 500
      },
      "connectorDefinitionName": "CrowdStrikeAPICCPDefinition",
      "dataType": "CrowdStrikeAlerts",
      "dcrConfig": {
        "streamName": "SENTINEL_CROWDSTRIKEALERTS",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2024-09-01",
    "name": "CrowdStrikeIncidentsPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "OAuth2",
        "ClientId": "[[parameters('clientId')]",
        "ClientSecret": "[[parameters('clientSecret')]",
        "GrantType": "client_credentials",
        "TokenEndpoint": "[[concat(parameters('apiUrl'),'/oauth2/token')]",
        "TokenEndpointHeaders": {
          "Accept": "application/json",
          "Content-Type": "application/x-www-form-urlencoded"
        }
      },
      "request": {
        "apiEndpoint": "[[concat(parameters('apiUrl'),'/incidents/queries/incidents/v1')]",
        "httpMethod": "GET",
        "rateLimitQPS": 1,
        "rateLimitConfig": {
          "evaluation": {
            "checkMode": "OnlyWhen429"
          },
          "extraction": {
            "source": "CustomHeaders",
            "headers": {
              "limit": {
                "name": "X-RateLimit-Limit",
                "format": "Integer"
              },
              "remaining": {
                "name": "X-RateLimit-Remaining",
                "format": "Integer"
              },
              "reset": {
                "name": "X-RateLimit-RetryAfter",
                "format": "UnixTimeSeconds"
              }
            }
          },
          "retryStrategy": {
            "useResetOrRetryAfterHeaders": true
          }
        },
        "queryWindowInMin": 15,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 90,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "filter": "modified_timestamp:>'{_QueryWindowStartTime}'+modified_timestamp:<='{_QueryWindowEndTime}'",
          "sort": "modified_timestamp.asc"
        }
      },
      "response": {
        "eventsJsonPaths": [
          ""
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "Offset",
        "offsetParaName": "offset",
        "pageSize": 500,
        "pageSizeParameterName": "limit"
      },
      "stepInfo": {
        "stepType": "Nested",
        "nextSteps": [
          {
            "stepId": "incidents_details",
            "stepPlaceholdersParsingKql": "source | project res = parse_json(data) | project resources = res['resources'] | mvexpand resources | project Url_PlaceHolder = resources"
          }
        ]
      },
      "stepCollectorConfigs": {
        "incidents_details": {
          "shouldJoinNestedData": false,
          "request": {
            "apiEndpoint": "[[concat(parameters('apiUrl'),'/incidents/entities/incidents/GET/v1')]",
            "httpMethod": "POST",
            "rateLimitQPS": 1,
            "queryWindowInMin": 5,
            "retryCount": 5,
            "timeoutInSeconds": 90,
            "logResponseContent": true,
            "isPostPayloadJson": true,
            "headers": {
              "Content-Type": "application/json",
              "Accept": "application/json",
              "User-Agent": "scuba"
            },
            "queryParametersTemplate": "{'ids': ['$Url_PlaceHolder$']}"
          },
          "response": {
            "eventsJsonPaths": [
              "$.resources"
            ],
            "format": "json"
          }
        }
      },
      "connectorDefinitionName": "CrowdStrikeAPICCPDefinition",
      "dataType": "CrowdStrikeIncidents",
      "dcrConfig": {
        "streamName": "SENTINEL_CROWDSTRIKEINCIDENTS",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2024-09-01",
    "name": "CrowdStrikeDetectionsPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "OAuth2",
        "ClientId": "[[parameters('clientId')]",
        "ClientSecret": "[[parameters('clientSecret')]",
        "GrantType": "client_credentials",
        "TokenEndpoint": "[[concat(parameters('apiUrl'),'/oauth2/token')]",
        "TokenEndpointHeaders": {
          "Accept": "application/json",
          "Content-Type": "application/x-www-form-urlencoded"
        }
      },
      "request": {
        "apiEndpoint": "[[concat(parameters('apiUrl'),'/alerts/combined/alerts/v1')]",
        "httpMethod": "POST",
        "rateLimitQPS": 1,
        "rateLimitConfig": {
          "evaluation": {
            "checkMode": "OnlyWhen429"
          },
          "extraction": {
            "source": "CustomHeaders",
            "headers": {
              "limit": {
                "name": "X-RateLimit-Limit",
                "format": "Integer"
              },
              "remaining": {
                "name": "X-RateLimit-Remaining",
                "format": "Integer"
              },
              "reset": {
                "name": "X-RateLimit-RetryAfter",
                "format": "UnixTimeSeconds"
              }
            }
          },
          "retryStrategy": {
            "useResetOrRetryAfterHeaders": true
          }
        },
        "queryWindowInMin": 15,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 120,
        "isPostPayloadJson": true,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParametersTemplate": "{\r\n                    \"filter\": \"product:'epp'+created_timestamp:>'{_QueryWindowStartTime}'+created_timestamp:<='{_QueryWindowEndTime}'+type:'ldt'\",\r\n                    \"sort\": \"created_timestamp.asc\"\r\n                }"
      },
      "response": {
        "eventsJsonPaths": [
          "$.resources"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "PersistentToken",
        "nextPageTokenJsonPath": "$.meta.pagination.after",
        "nextPageParaName": "after",
        "pageSize": 500
      },
      "connectorDefinitionName": "CrowdStrikeAPICCPDefinition",
      "dataType": "CrowdStrikeDetections",
      "dcrConfig": {
        "streamName": "SENTINEL_CROWDSTRIKEDETECTIONS",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2024-09-01",
    "name": "CrowdStrikeHostsPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "OAuth2",
        "ClientId": "[[parameters('clientId')]",
        "ClientSecret": "[[parameters('clientSecret')]",
        "GrantType": "client_credentials",
        "TokenEndpoint": "[[concat(parameters('apiUrl'),'/oauth2/token')]",
        "TokenEndpointHeaders": {
          "Accept": "application/json",
          "Content-Type": "application/x-www-form-urlencoded"
        }
      },
      "request": {
        "apiEndpoint": "[[concat(parameters('apiUrl'),'/devices/combined/devices/v1')]",
        "httpMethod": "GET",
        "rateLimitQPS": 1,
        "rateLimitConfig": {
          "evaluation": {
            "checkMode": "OnlyWhen429"
          },
          "extraction": {
            "source": "CustomHeaders",
            "headers": {
              "limit": {
                "name": "X-RateLimit-Limit",
                "format": "Integer"
              },
              "remaining": {
                "name": "X-RateLimit-Remaining",
                "format": "Integer"
              },
              "reset": {
                "name": "X-RateLimit-RetryAfter",
                "format": "UnixTimeSeconds"
              }
            }
          },
          "retryStrategy": {
            "useResetOrRetryAfterHeaders": true
          }
        },
        "queryWindowInMin": 15,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 90,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "filter": "last_seen:>'{_QueryWindowStartTime}'+last_seen:<='{_QueryWindowEndTime}'",
          "sort": "last_seen.asc"
        }
      },
      "response": {
        "eventsJsonPaths": [
          "$.resources"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "NextPageToken",
        "nextPageTokenJsonPath": "$.meta.pagination.next",
        "NextPageParaName": "offset",
        "pageSize": 500,
        "pageSizeParameterName": "limit"
      },
      "connectorDefinitionName": "CrowdStrikeAPICCPDefinition",
      "dataType": "CrowdStrikeHosts",
      "dcrConfig": {
        "streamName": "SENTINEL_CROWDSTRIKEHOSTS",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      }
    }
  }
]