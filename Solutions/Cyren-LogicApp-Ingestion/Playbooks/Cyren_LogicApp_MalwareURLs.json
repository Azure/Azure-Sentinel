{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "16876669722434431884"
    }
  },
  "parameters": {
    "logicAppName": {
      "type": "string",
      "defaultValue": "logic-cyren-malware-urls",
      "metadata": {
        "description": "Logic App name"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for resources"
      }
    },
    "cyrenMalwareUrlsToken": {
      "type": "securestring"
    },
    "dcrImmutableId": {
      "type": "string"
    },
    "dceEndpoint": {
      "type": "string"
    },
    "dcrResourceId": {
      "type": "string"
    },
    "dceResourceId": {
      "type": "string"
    },
    "streamName": {
      "type": "string",
      "defaultValue": "Custom-Cyren_MalwareUrls_Raw"
    },
    "fetchCount": {
      "type": "int",
      "defaultValue": 100
    },
    "pollingIntervalHours": {
      "type": "int",
      "defaultValue": 6
    }
  },
  "resources": [
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('logicAppName')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "cyrenToken": {
              "type": "securestring",
              "defaultValue": "[parameters('cyrenMalwareUrlsToken')]"
            },
            "fetchCount": {
              "type": "int",
              "defaultValue": "[parameters('fetchCount')]"
            },
            "dcrImmutableId": {
              "type": "string",
              "defaultValue": "[parameters('dcrImmutableId')]"
            },
            "dceEndpoint": {
              "type": "string",
              "defaultValue": "[parameters('dceEndpoint')]"
            },
            "streamName": {
              "type": "string",
              "defaultValue": "[parameters('streamName')]"
            }
          },
          "triggers": {
            "Recurrence": {
              "type": "Recurrence",
              "recurrence": {
                "frequency": "Hour",
                "interval": "[parameters('pollingIntervalHours')]"
              }
            }
          },
          "actions": {
            "Call_Cyren_API": {
              "type": "Http",
              "inputs": {
                "method": "GET",
                "uri": "https://api-feeds.cyren.com/v1/feed/data?feedId=malware_urls&count=@{parameters('fetchCount')}&offset=0&format=jsonl",
                "headers": {
                  "Authorization": "Bearer @{parameters('cyrenToken')}",
                  "Accept": "application/json"
                }
              },
              "runAfter": {}
            },
            "Response_As_String": {
              "type": "Compose",
              "inputs": "@string(body('Call_Cyren_API'))",
              "runAfter": {
                "Call_Cyren_API": [
                  "Succeeded"
                ]
              }
            },
            "Split_Lines": {
              "type": "Compose",
              "inputs": "@split(outputs('Response_As_String'), decodeUriComponent('%0A'))",
              "runAfter": {
                "Response_As_String": [
                  "Succeeded"
                ]
              }
            },
            "Filter_Empty_Lines": {
              "type": "Query",
              "inputs": {
                "from": "@outputs('Split_Lines')",
                "where": "@greater(length(trim(item())), 0)"
              },
              "runAfter": {
                "Split_Lines": [
                  "Succeeded"
                ]
              }
            },
            "Parse_JSON_Lines": {
              "type": "Select",
              "inputs": {
                "from": "@body('Filter_Empty_Lines')",
                "select": "@json(item())"
              },
              "runAfter": {
                "Filter_Empty_Lines": [
                  "Succeeded"
                ]
              }
            },
            "Flatten_Payload": {
              "type": "Select",
              "inputs": {
                "from": "@body('Parse_JSON_Lines')",
                "select": {
                  "url": "@item()?['payload']?['url']",
                  "ip": "@item()?['payload']?['identifier']",
                  "fileHash": "@item()?['payload']?['fileHash']",
                  "domain": "@item()?['payload']?['domain']",
                  "protocol": "@item()?['payload']?['meta']?['protocol']",
                  "port": "@item()?['payload']?['meta']?['port']",
                  "category": "@first(item()?['payload']?['detection']?['category'])",
                  "risk": "@item()?['payload']?['detection']?['risk']",
                  "firstSeen": "@item()?['payload']?['first_seen']",
                  "lastSeen": "@item()?['payload']?['last_seen']",
                  "source": "Cyren Malware URLs",
                  "relationships": "@string(item()?['payload']?['relationships'])",
                  "detection_methods": "@first(item()?['payload']?['detection_methods'])",
                  "action": "@item()?['payload']?['action']",
                  "type": "@item()?['payload']?['type']",
                  "identifier": "@item()?['payload']?['url']",
                  "detection_ts": "@item()?['payload']?['detection']?['detection_ts']",
                  "object_type": "@item()?['payload']?['meta']?['object_type']"
                }
              },
              "runAfter": {
                "Parse_JSON_Lines": [
                  "Succeeded"
                ]
              }
            },
            "Send_to_DCE": {
              "type": "Http",
              "inputs": {
                "method": "POST",
                "uri": "@{parameters('dceEndpoint')}/dataCollectionRules/@{parameters('dcrImmutableId')}/streams/@{parameters('streamName')}?api-version=2023-01-01",
                "headers": {
                  "Content-Type": "application/json"
                },
                "body": "@body('Flatten_Payload')",
                "authentication": {
                  "type": "ManagedServiceIdentity",
                  "audience": "https://monitor.azure.com/"
                },
                "retryPolicy": {
                  "type": "Exponential",
                  "interval": "PT30S",
                  "count": 5
                }
              },
              "runAfter": {
                "Flatten_Payload": [
                  "Succeeded"
                ]
              }
            },
            "Log_Result": {
              "type": "Compose",
              "inputs": {
                "status": "completed",
                "timestamp": "@utcNow()",
                "recordCount": "@length(body('Flatten_Payload'))"
              },
              "runAfter": {
                "Send_to_DCE": [
                  "Succeeded"
                ]
              }
            }
          },
          "outputs": {}
        }
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.Insights/dataCollectionRules/{0}', last(split(parameters('dcrResourceId'), '/')))]",
      "name": "[guid(resourceId('Microsoft.Insights/dataCollectionRules', last(split(parameters('dcrResourceId'), '/'))), resourceId('Microsoft.Logic/workflows', parameters('logicAppName')), '3913510d-42f4-4e42-8a64-420c390055eb')]",
      "properties": {
        "principalId": "[reference(resourceId('Microsoft.Logic/workflows', parameters('logicAppName')), '2019-05-01', 'full').identity.principalId]",
        "principalType": "ServicePrincipal",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '3913510d-42f4-4e42-8a64-420c390055eb')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Logic/workflows', parameters('logicAppName'))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.Insights/dataCollectionEndpoints/{0}', last(split(parameters('dceResourceId'), '/')))]",
      "name": "[guid(resourceId('Microsoft.Insights/dataCollectionEndpoints', last(split(parameters('dceResourceId'), '/'))), resourceId('Microsoft.Logic/workflows', parameters('logicAppName')), '3913510d-42f4-4e42-8a64-420c390055eb')]",
      "properties": {
        "principalId": "[reference(resourceId('Microsoft.Logic/workflows', parameters('logicAppName')), '2019-05-01', 'full').identity.principalId]",
        "principalType": "ServicePrincipal",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '3913510d-42f4-4e42-8a64-420c390055eb')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Logic/workflows', parameters('logicAppName'))]"
      ]
    }
  ],
  "outputs": {
    "logicAppId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Logic/workflows', parameters('logicAppName'))]"
    },
    "logicAppName": {
      "type": "string",
      "value": "[parameters('logicAppName')]"
    },
    "principalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Logic/workflows', parameters('logicAppName')), '2019-05-01', 'full').identity.principalId]"
    }
  }
}