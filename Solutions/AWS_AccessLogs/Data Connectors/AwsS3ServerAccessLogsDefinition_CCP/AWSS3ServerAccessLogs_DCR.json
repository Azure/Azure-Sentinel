{
    "name": "AWSS3AccessLogs",
    "apiVersion": "2021-09-01-preview",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "{{location}}",
    "properties": {
    "streamDeclarations": {
        "Custom-AWSS3ServerAccessLogsStream": {
        "columns": [
            {
                "name": "Field1",
                "type": "string"
            },
            {
                "name": "Field2",
                "type": "string"
            },
            {
                "name": "Field3",
                "type": "string"
            },
            {
                "name": "Field4",
                "type": "string"
            },
            {
                "name": "Field5",
                "type": "string"
            },
            {
                "name": "Field6",
                "type": "string"
            },
            {
                "name": "Field7",
                "type": "string"
            },
            {
                "name": "Field8",
                "type": "string"
            },
            {
                "name": "Field9",
                "type": "string"
            },
            {
                "name": "Field10",
                "type": "string"
            },
            {
                "name": "Field11",
                "type": "int"
            },
            {
                "name": "Field12",
                "type": "string"
            },
            {
                "name": "Field13",
                "type": "int"
            },
            {
                "name": "Field14",
                "type": "int"
            },
            {
                "name": "Field15",
                "type": "int"
            },
            {
                "name": "Field16",
                "type": "int"
            },
            {
                "name": "Field17",
                "type": "string"
            },
            {
                "name": "Field18",
                "type": "string"
            },
            {
                "name": "Field19",
                "type": "string"
            },
            {
                "name": "Field20",
                "type": "string"
            },
            {
                "name": "Field21",
                "type": "string"
            },
            {
                "name": "Field22",
                "type": "string"
            },
            {
                "name": "Field23",
                "type": "string"
            },
            {
                "name": "Field24",
                "type": "string"
            },
            {
                "name": "Field25",
                "type": "string"
            },
            {
                "name": "Field26",
                "type": "string"
            },
            {
                "name": "Field27",
                "type": "string"
            }
        ]
        }
    },
    "destinations": {
				"logAnalytics": [
					{
						"workspaceResourceId": "{{workspaceResourceId}}",
						"name": "clv2ws1"
					}
				]
			},
    "dataFlows": [
				{
					"streams": [
						"Custom-AWSS3ServerAccessLogsStream"
					],
					"destinations": [
						"clv2ws1"
					],
                    "transformKql": "source| extend dateTimeParts = extract_all(@'\\[(?P<date>[^:]+):(?P<time>.*)', Field3)| extend requestTime = strcat_delim(' ', dateTimeParts[0][0], dateTimeParts[0][1], trim_end(@'\\]', Field4))| project TimeGenerated = todatetime(requestTime),BucketOwner = tostring(Field1),Bucket = tostring(Field2),RemoteIp = tostring(Field5),Requester = tostring(Field6),RequestId = tostring(Field7),Operation = tostring(Field8),Key = tostring(Field9),RequestUri = tostring(Field10),HttpStatus = toint(Field11),ErrorCode = tostring(Field12),BytesSent = toint(Field13),ObjectSize = toint(Field14),TotalTime = toint(Field15),TurnAroundTime = toint(Field16),Referer = tostring(Field17),UserAgent = tostring(Field18),VersionId = tostring(Field19),HostId = tostring(Field20),SignatureVersion = tostring(Field21),CipherSuite = tostring(Field22),AuthenticationType = tostring(Field23),HostHeader = tostring(Field24),TLSVersion = tostring(Field25),AccessPointARN = tostring(Field26),ACLRequired = tostring(Field27)",
                    "outputStream": "Custom-AWSS3ServerAccessLogs_CL"
				}
			],
    "dataCollectionEndpointId": "[concat('/subscriptions/', parameters('subscription'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.Insights/dataCollectionEndpoints/', parameters('workspace'))]"
    }
}