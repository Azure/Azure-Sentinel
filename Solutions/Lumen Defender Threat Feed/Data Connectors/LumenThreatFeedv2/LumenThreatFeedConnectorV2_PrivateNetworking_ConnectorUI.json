{

   "id": "LumenThreatFeedConnectorV2PrivateNetworking",
   "title": "Lumen Defender Threat Feed Data Connector V2 (using Azure Functions Flex Consumption Plan with Private Networking)",
   "publisher": "Lumen Technologies, Inc.",
   "descriptionMarkdown": "The [Lumen Defender Threat Feed](https://www.lumen.com/en-us/security/black-lotus-labs.html) connector provides the capability to ingest STIX-formatted threat intelligence indicators from Lumen's Black Lotus Labs research team into Microsoft Sentinel. The connector automatically downloads and uploads threat intelligence indicators including IPv4 addresses and domains to the ThreatIntelIndicators table via the STIX Objects Upload API.\n\n**NOTE:** This data connector uses the [Azure Functions Flex Consumption Plan](https://learn.microsoft.com/azure/azure-functions/flex-consumption-plan) with VNet integration for secure, private network access to storage resources. More pricing details are [here](https://azure.microsoft.com/pricing/details/functions/#pricing).",
   "additionalRequirementBanner": "This connector requires API access to Lumen Defender Threat Feed API service, Microsoft Sentinel STIX Objects API permissions, proper configuration of Azure Entra ID authentication components, and Virtual Network configuration for private access.",
   "graphQueries": [
     {
       "metricName": "Total Threat Intelligence Indicators",
       "legend": "ThreatIntelIndicators",
       "baseQuery": "ThreatIntelIndicators | where SourceSystem == 'Lumen'"
     }
   ],
   "sampleQueries": [
     {
       "description": "All Lumen Threat Intelligence Indicators",
       "query": "ThreatIntelIndicators | where SourceSystem == 'Lumen' | sort by TimeGenerated desc"
     },
     {
       "description": "High Confidence Indicators",
       "query": "ThreatIntelIndicators | where SourceSystem == 'Lumen' and Confidence >= 80 | sort by TimeGenerated desc"
     },
     {
       "description": "Malicious IP Indicators",
       "query": "ThreatIntelIndicators | where SourceSystem == 'Lumen' and ObservableValue != '' and ObservableKey == 'ipv4-addr:value' | sort by TimeGenerated desc"
     },
     {
       "description": "Malicious Domain Indicators",
       "query": "ThreatIntelIndicators | where SourceSystem == 'Lumen' and ObservableValue != '' and ObservableKey == 'domain-name:value' | sort by TimeGenerated desc"
     },
     {
       "description": "Recent Indicators (Last 7 Days)",
       "query": "ThreatIntelIndicators | where SourceSystem == 'Lumen' and TimeGenerated > ago(7d) | summarize count() by bin(TimeGenerated, 1d)"
     }
   ],
   "dataTypes": [
     {
       "name": "ThreatIntelIndicators(Lumen)",
       "lastDataReceivedQuery": "ThreatIntelIndicators | where SourceSystem == 'Lumen' | summarize Time = max(TimeGenerated) | where isnotempty(Time)"
     }
   ],
   "connectivityCriterias": [
     {
       "type": "IsConnectedQuery",
       "value": [
         "ThreatIntelIndicators | where SourceSystem == 'Lumen' | summarize LastLogReceived = max(TimeGenerated) | project IsConnected = LastLogReceived > ago(30d)"
       ]
     }
   ],
   "availability": {
     "status": 1,
     "isPreview": true
   },
   "permissions": {
     "resourceProvider": [
       {
         "provider": "Microsoft.OperationalInsights/workspaces",
         "permissionsDisplayText": "Read and write permissions on the Log Analytics workspace are required.",
         "providerDisplayName": "Log Analytics Workspace",
         "scope": "Workspace",
         "requiredPermissions": {
           "write": true,
           "read": true,
           "delete": false
         }
       }
     ],
     "customs": [
       {
         "name": "Microsoft.Web/sites permissions",
         "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
       },
       {
         "name": "Azure Entra App Registration",
         "description": "An Azure Entra application registration with the Microsoft Sentinel Contributor role assigned is required for STIX Objects API access. [See the documentation to learn more about Azure Entra applications](https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app)."
       },
       {
         "name": "Microsoft Sentinel Contributor Role",
         "description": "Microsoft Sentinel Contributor role is required for the Azure Entra application to upload threat intelligence indicators."
       },
       {
         "name": "Lumen Defender Threat Feed API Key",
         "description": "A Lumen Defender Threat Feed API Key is required for accessing threat intelligence data. [Contact Lumen for API access](mailto:DefenderThreatFeedSales@Lumen.com?subject=API%20Access%20Request)."
       },
       {
         "name": "Virtual Network permissions (for private access)",
         "description": "For private storage account access, **Network Contributor** permissions are required on the Virtual Network and subnets. The Function App subnet must be delegated to **Microsoft.App/environments** for Flex Consumption VNet integration."
       }
     ]
   },
   "instructionSteps": [
     {
       "title": "",
       "description": ">**NOTE:** This connector uses Azure Functions with the Flex Consumption Plan to connect to the Lumen Defender Threat Feed API and upload threat intelligence indicators to Microsoft Sentinel via the STIX Objects API. The Flex Consumption Plan enables VNet integration for secure, private network access to storage resources. This might result in additional data ingestion and compute costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
     },
     {
       "title": "",
       "description": ">**(Optional Step)** Securely store API keys and secrets in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Functions App."
     },
     {
       "title": "Configuration",
       "description": "**STEP 1 - Network Prerequisites for Private Access**\n\n>**IMPORTANT:** When deploying with private storage account access, **you need a Virtual Network with two properly configured subnets.** You can either use an existing VNet or deploy one using the template below.\n\n**Option A: Deploy a New Virtual Network (Recommended for new deployments)**\n\nUse this template to create a properly configured VNet with two subnets:\n- **Function App Subnet**: Delegated to Microsoft.App/environments for Flex Consumption VNet integration\n- **Private Endpoint Subnet**: For storage account private endpoints\n\n[![Deploy VNet to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FAzure-Sentinel%2Fmaster%2FSolutions%2FLumen%2520Defender%2520Threat%2520Feed%2FData%2520Connectors%2FLumenThreatFeedv2%2Fazuredeploy_VNet_for_PrivateEndpoint.json)\n\nAfter deployment, note the following output values for use in STEP 5:\n- **VNet Name** (default: lumen-threatfeed-vnet)\n- **VNet Resource Group**\n- **Function App Subnet Name** (default: functionapp-subnet)\n- **Private Endpoint Subnet Name** (default: privateendpoint-subnet)\n\n**Option B: Use an Existing Virtual Network**\n\nIf using an existing VNet, ensure the following requirements are met:\n> - **Virtual Network**: Must be in the same region where you plan to deploy the Function App\n> - **Function App Subnet**: Must be delegated to **Microsoft.App/environments** (required for Flex Consumption Plan)\n> - **Private Endpoint Subnet**: Must NOT be delegated to any service\n> - **Subnet Size**: Minimum /24 recommended for each subnet\n> - **Subnet Delegation**: Configure using one of the following methods:\n>   - **Azure Portal**: Virtual networks → Select VNet → Subnets → Select subnet → Delegate to **Microsoft.App/environments**\n>   - **Azure CLI**: `az network vnet subnet update --resource-group <rg-name> --vnet-name <vnet-name> --name <subnet-name> --delegations Microsoft.App/environments`\n\n>**Note:** The connector deployment will automatically create private endpoints for storage services (blob, queue, table, file) and configure Private DNS zones."
     },
     {
       "title": "",
       "description": "**STEP 2 - Obtain Lumen Defender Threat Feed API Key**\n\n1. [Contact Lumen](mailto:DefenderThreatFeedSales@Lumen.com?subject=API%20Access%20Request) to obtain API access to our Threat Feed API service\n2. Obtain your API key for authentication."
     },
     {
       "title": "",
       "description": "**STEP 3 - Configure Azure Entra ID Application and gather information**\n\n1. Create a new Entra app registration from the **App registrations** tab in the Entra ID section of the Azure portal. [See the documentation for a guide to registering an application in Microsoft Entra ID.](https://learn.microsoft.com/en-us/entra/identity-platform/quickstart-register-app)\n2. Create a client secret and note the **Application ID**, **Tenant ID**, and **Client Secret**\n3. Assign the **Microsoft Sentinel Contributor** role to the newly registered application in the **Access control (IAM)** menu of your Microsoft Sentinel Log Analytics Workspace\n4. Make note of your **Workspace ID**, which can be obtained from the **overview** page of the Log Analytics Workspace for your Microsoft Sentinel instance.",
       "instructions":[
         {
             "parameters": {
                 "fillWith": [
                     "TenantId"
                 ],
                 "label": "Tenant ID"
             },
             "type": "CopyableLabel"
         },
         {
             "parameters": {
                 "fillWith": [
                     "WorkspaceId"
                 ],
                 "label": "Workspace ID"
             },
             "type": "CopyableLabel"
         }
       ]
     },
     {
       "title": "",
       "description": "**STEP 4 - Enable the **Threat Intelligence Upload Indicators API (Preview)** data connector in Microsoft Sentinel**\n\n1. Deploy the **Threat Intelligence (New) Solution**, which includes the **Threat Intelligence Upload Indicators API (Preview)**\n2. Browse to the Content Hub, find and select the **Threat Intelligence (NEW)** solution.\n3. Select the **Install/Update** button."
     },
     {
       "title": "",
       "description": "**STEP 5 - Deploy the Azure Function with Private Networking**\n\n>**IMPORTANT:** Before deploying the Lumen Defender Threat Feed connector, have the following information readily available:\n> - Tenant ID and Workspace ID\n> - Azure Entra application details (Client ID, Client Secret)\n> - Lumen API key\n> - Virtual Network name and Resource Group\n> - Function App Subnet name (delegated to Microsoft.App/environments)\n> - Private Endpoint Subnet name (non-delegated)\n\n1. Click the Deploy to Azure button.\n\n[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FAzure-Sentinel%2Fmaster%2FSolutions%2FLumen%2520Defender%2520Threat%2520Feed%2FData%2520Connectors%2FLumenThreatFeedv2%2Fazuredeploy_Connector_LumenThreatFeed_AzureFunction_v2_privateendpoint.json)\n\n2. Fill in the appropriate values for each parameter:\n\n**Basic Settings:**\n- **Subscription**: Confirm the correct subscription is selected or use the dropdown to change your selection\n- **Resource Group**: Select the resource group to be used by the Function App and related resources\n- **Function Name**: Enter a globally unique name for the Function App (11-character limit recommended)\n- **App Insights Workspace Resource ID**: The Resource ID of the Log Analytics Workspace for Application Insights (click **JSON View** on the Log Analytics workspace to copy)\n\n**Lumen API Settings:**\n- **Lumen API Key**: Obtain an API key through Lumen support\n- **Lumen Base URL**: Filled in automatically and should generally not be changed\n- **Confidence Threshold** (Optional): Minimum confidence score (60-100) for indicators (default: 60)\n- **Enable IPv4** (Optional): Enable IPv4 address indicators (default: true)\n- **Enable Domain** (Optional): Enable domain name indicators (default: true)\n\n**Azure Entra ID Settings:**\n- **Workspace ID**: Found in the \"Overview\" tab for the Log Analytics Workspace of the Microsoft Sentinel instance\n- **Tenant ID**: Obtained from the Entra App Registration overview page (listed as Directory ID)\n- **Client ID**: Obtained from the Entra App Registration overview page (listed as Application ID)\n- **Client Secret**: Obtained when the secret is created during the app registration process\n\n**Private Networking Settings:**\n- **VNet Resource Group Name**: The resource group containing the Virtual Network (if using the VNet template from STEP 1, this is where you deployed it)\n- **VNet Name**: The name of the Virtual Network (default from VNet template: lumen-threatfeed-vnet)\n- **Function App Subnet Name**: The subnet delegated to Microsoft.App/environments (default from VNet template: functionapp-subnet)\n- **Private Endpoint Subnet Name**: The subnet for private endpoints (default from VNet template: privateendpoint-subnet)\n- **Create Private DNS Zones**: Set to true to create new Private DNS Zones, or false to use existing ones\n\n>**Note:** Ensure the Function App subnet is delegated to Microsoft.App/environments before deployment. The deployment will create private endpoints for storage account services and configure Private DNS zones automatically."
     },
     {
       "title": "",
       "description": "**STEP 6 - Verify Deployment**\n\n1. The connector polls for indicator updates every 15 minutes.\n2. Verify that the Function App is properly integrated with the Virtual Network by checking the Networking settings in the Azure Portal\n3. Confirm that private endpoints were created for the storage account services (blob, file, queue, table)\n4. After the app performs its first run, review the indicators ingested by either viewing the \"Lumen Defender Threat Feed Overview\" workbook or viewing the \"Threat Intelligence\" section in Microsoft Sentinel. In Microsoft Sentinel \"Threat Intelligence\", filter for source \"Lumen\" to display only Lumen generated indicators."
     },
     {
       "title": "",
       "description": "**Troubleshooting Private Networking Issues**\n\nIf the Function App is not receiving data after deployment:\n\n1. **Check VNet Integration**: Navigate to Function App → Networking → VNet integration and verify the Function App subnet is connected\n2. **Verify Private Endpoints**: Navigate to the storage account → Networking → Private endpoint connections and verify all endpoints are in \"Approved\" state\n3. **Check DNS Resolution**: Ensure private DNS zones are properly linked to the VNet for storage account resolution\n4. **Review Function Logs**: Check Application Insights or Function App logs for connection errors\n5. **Subnet Delegation**: Confirm the Function App subnet is delegated to **Microsoft.App/environments** (required for Flex Consumption Plan)"
     }
   ],
   "metadata": {
       "id": "8d7d3b0e-4f6a-4f2a-bc2d-6d9f5a3c7e23",
       "version": "2.0.0",
       "kind": "dataConnector",
       "source": {
           "kind": "solution",
           "name": "Lumen Defender Threat Feed for Microsoft Sentinel"
       },
       "author": {
           "name": "Lumen Technologies, Inc."
       },
       "support": {
           "tier": "developer",
           "name": "Lumen Technologies, Inc."
       }
    }
}
