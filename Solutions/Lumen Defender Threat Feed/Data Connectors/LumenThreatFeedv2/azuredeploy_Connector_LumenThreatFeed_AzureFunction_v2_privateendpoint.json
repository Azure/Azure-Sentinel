{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "title": "Lumen Threat Feed Connector V2 - Private Endpoint Edition",
    "description": "Deploys the Lumen Threat Feed Connector with VNet integration and private endpoints for enterprise environments requiring network isolation.",
    "prerequisites": [
      "An existing Virtual Network with two subnets",
      "Subnet 1: Delegated to Microsoft.App/environments (for Flex Consumption VNet integration)",
      "Subnet 2: Non-delegated (for Private Endpoints)",
      "Private DNS zones can be created by this template or use existing ones"
    ]
  },
  "parameters": {
    "FunctionName": {
      "type": "string",
      "defaultValue": "lumentfv2",
      "minLength": 1,
      "maxLength": 11,
      "metadata": {
        "description": "Name prefix for the Function App (will be lowercased and appended with a unique suffix). Max 11 chars due to storage account naming limits."
      }
    },
    "LumenAPIKey": {
      "type": "securestring",
      "metadata": {
        "description": "Lumen API Key for authenticating with the Threat Feed service."
      }
    },
    "LumenBaseURL": {
      "type": "string",
      "defaultValue": "https://microsoft-sentinel-api.us1.mss.lumen.com",
      "minLength": 1,
      "metadata": {
        "description": "Lumen Threat Feed API base URL."
      }
    },
    "WorkspaceID": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Microsoft Sentinel Workspace ID."
      }
    },
    "TenantID": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Azure Active Directory Tenant ID."
      }
    },
    "ClientID": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Azure App Registration Client ID."
      }
    },
    "ClientSecret": {
      "type": "securestring",
      "minLength": 1,
      "metadata": {
        "description": "Azure App Registration Client Secret."
      }
    },
    "LumenConfidenceThreshold": {
      "type": "string",
      "defaultValue": "60",
      "metadata": {
        "description": "Minimum confidence threshold for threat indicators (60-100)."
      }
    },
    "LumenEnableIPv4": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable ingestion of IPv4 threat indicators."
      }
    },
    "LumenEnableDomain": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable ingestion of domain threat indicators."
      }
    },
    "AppInsightsWorkspaceResourceID": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Log Analytics Workspace Resource ID for Application Insights. Format: /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.OperationalInsights/workspaces/{workspaceName}"
      }
    },
    "VNetResourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Resource Group containing the existing Virtual Network."
      }
    },
    "VNetName": {
      "type": "string",
      "metadata": {
        "description": "Name of the existing Virtual Network."
      }
    },
    "FunctionAppSubnetName": {
      "type": "string",
      "metadata": {
        "description": "Name of the subnet for Function App VNet integration. This subnet MUST be delegated to Microsoft.App/environments (required for Flex Consumption)."
      }
    },
    "PrivateEndpointSubnetName": {
      "type": "string",
      "metadata": {
        "description": "Name of the subnet for Private Endpoints. This subnet must NOT be delegated."
      }
    },
    "CreatePrivateDnsZones": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Set to true to create new Private DNS Zones, or false to use existing ones in the VNet resource group."
      }
    }
  },
  "variables": {
    "FunctionName": "[concat(toLower(parameters('FunctionName')), take(uniqueString(resourceGroup().id), 3))]",
    "StorageAccount": "[concat(variables('FunctionName'), take(uniqueString(resourceGroup().id), 3))]",
    "deploymentStorageContainerName": "lumenthreatfeed-v2",
    "StorageSuffix": "[environment().suffixes.storage]",
    "storageBlobDataOwnerRoleId": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b",
    "Polling": "*/15 * * * *",
    "vnetResourceId": "[resourceId(parameters('VNetResourceGroupName'), 'Microsoft.Network/virtualNetworks', parameters('VNetName'))]",
    "functionAppSubnetResourceId": "[resourceId(parameters('VNetResourceGroupName'), 'Microsoft.Network/virtualNetworks/subnets', parameters('VNetName'), parameters('FunctionAppSubnetName'))]",
    "privateEndpointSubnetResourceId": "[resourceId(parameters('VNetResourceGroupName'), 'Microsoft.Network/virtualNetworks/subnets', parameters('VNetName'), parameters('PrivateEndpointSubnetName'))]",
    "privateEndpointBlobName": "[concat(variables('StorageAccount'), '-pe-blob')]",
    "privateEndpointQueueName": "[concat(variables('StorageAccount'), '-pe-queue')]",
    "privateEndpointTableName": "[concat(variables('StorageAccount'), '-pe-table')]",
    "privateEndpointFileName": "[concat(variables('StorageAccount'), '-pe-file')]",
    "privateDnsZoneBlob": "privatelink.blob.core.windows.net",
    "privateDnsZoneQueue": "privatelink.queue.core.windows.net",
    "privateDnsZoneTable": "privatelink.table.core.windows.net",
    "privateDnsZoneFile": "privatelink.file.core.windows.net"
  },
  "resources": [
    {
      "comments": "Application Insights for monitoring and diagnostics",
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[variables('FunctionName')]",
      "location": "[resourceGroup().location]",
      "kind": "web",
      "properties": {
        "Application_Type": "web",
        "ApplicationId": "[variables('FunctionName')]",
        "WorkspaceResourceId": "[parameters('AppInsightsWorkspaceResourceID')]"
      }
    },
    {
      "comments": "Storage Account with private network access only",
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-05-01",
      "name": "[variables('StorageAccount')]",
      "location": "[resourceGroup().location]",
      "kind": "StorageV2",
      "sku": {
        "name": "Standard_LRS"
      },
      "properties": {
        "supportsHttpsTrafficOnly": true,
        "defaultToOAuthAuthentication": true,
        "allowBlobPublicAccess": false,
        "allowSharedKeyAccess": true,
        "minimumTlsVersion": "TLS1_2",
        "publicNetworkAccess": "Disabled",
        "networkAcls": {
          "bypass": "None",
          "virtualNetworkRules": [],
          "ipRules": [],
          "defaultAction": "Deny"
        },
        "encryption": {
          "services": {
            "file": {
              "keyType": "Account",
              "enabled": true
            },
            "blob": {
              "keyType": "Account",
              "enabled": true
            },
            "table": {
              "keyType": "Account",
              "enabled": true
            },
            "queue": {
              "keyType": "Account",
              "enabled": true
            }
          },
          "keySource": "Microsoft.Storage",
          "requireInfrastructureEncryption": true
        }
      }
    },
    {
      "comments": "Blob Services",
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', variables('StorageAccount'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]"
      ],
      "properties": {
        "deleteRetentionPolicy": {
          "enabled": false
        }
      }
    },
    {
      "comments": "Queue Services",
      "type": "Microsoft.Storage/storageAccounts/queueServices",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', variables('StorageAccount'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]"
      ],
      "properties": {}
    },
    {
      "comments": "Table Services",
      "type": "Microsoft.Storage/storageAccounts/tableServices",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', variables('StorageAccount'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]"
      ],
      "properties": {}
    },
    {
      "comments": "File Services",
      "type": "Microsoft.Storage/storageAccounts/fileServices",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', variables('StorageAccount'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]"
      ],
      "properties": {}
    },
    {
      "comments": "Deployment container for Function App code",
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}/{2}', variables('StorageAccount'), 'default', variables('deploymentStorageContainerName'))]",
      "properties": {
        "publicAccess": "None"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('StorageAccount'), 'default')]"
      ]
    },
    {
      "comments": "Private DNS Zone for Blob Storage",
      "condition": "[parameters('CreatePrivateDnsZones')]",
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2020-06-01",
      "name": "[variables('privateDnsZoneBlob')]",
      "location": "global",
      "properties": {}
    },
    {
      "comments": "Private DNS Zone for Queue Storage",
      "condition": "[parameters('CreatePrivateDnsZones')]",
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2020-06-01",
      "name": "[variables('privateDnsZoneQueue')]",
      "location": "global",
      "properties": {}
    },
    {
      "comments": "Private DNS Zone for Table Storage",
      "condition": "[parameters('CreatePrivateDnsZones')]",
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2020-06-01",
      "name": "[variables('privateDnsZoneTable')]",
      "location": "global",
      "properties": {}
    },
    {
      "comments": "Private DNS Zone for File Storage",
      "condition": "[parameters('CreatePrivateDnsZones')]",
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2020-06-01",
      "name": "[variables('privateDnsZoneFile')]",
      "location": "global",
      "properties": {}
    },
    {
      "comments": "Link Blob DNS Zone to VNet",
      "condition": "[parameters('CreatePrivateDnsZones')]",
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2020-06-01",
      "name": "[concat(variables('privateDnsZoneBlob'), '/blob-vnet-link')]",
      "location": "global",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneBlob'))]"
      ],
      "properties": {
        "virtualNetwork": {
          "id": "[variables('vnetResourceId')]"
        },
        "registrationEnabled": false
      }
    },
    {
      "comments": "Link Queue DNS Zone to VNet",
      "condition": "[parameters('CreatePrivateDnsZones')]",
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2020-06-01",
      "name": "[concat(variables('privateDnsZoneQueue'), '/queue-vnet-link')]",
      "location": "global",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneQueue'))]"
      ],
      "properties": {
        "virtualNetwork": {
          "id": "[variables('vnetResourceId')]"
        },
        "registrationEnabled": false
      }
    },
    {
      "comments": "Link Table DNS Zone to VNet",
      "condition": "[parameters('CreatePrivateDnsZones')]",
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2020-06-01",
      "name": "[concat(variables('privateDnsZoneTable'), '/table-vnet-link')]",
      "location": "global",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneTable'))]"
      ],
      "properties": {
        "virtualNetwork": {
          "id": "[variables('vnetResourceId')]"
        },
        "registrationEnabled": false
      }
    },
    {
      "comments": "Link File DNS Zone to VNet",
      "condition": "[parameters('CreatePrivateDnsZones')]",
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2020-06-01",
      "name": "[concat(variables('privateDnsZoneFile'), '/file-vnet-link')]",
      "location": "global",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneFile'))]"
      ],
      "properties": {
        "virtualNetwork": {
          "id": "[variables('vnetResourceId')]"
        },
        "registrationEnabled": false
      }
    },
    {
      "comments": "Private Endpoint for Blob Storage",
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[variables('privateEndpointBlobName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]"
      ],
      "properties": {
        "subnet": {
          "id": "[variables('privateEndpointSubnetResourceId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "BlobConnection",
            "properties": {
              "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]",
              "groupIds": [
                "blob"
              ]
            }
          }
        ]
      }
    },
    {
      "comments": "DNS Zone Group for Blob Private Endpoint",
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2023-05-01",
      "name": "[concat(variables('privateEndpointBlobName'), '/default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointBlobName'))]",
        "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneBlob'))]"
      ],
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "blob-config",
            "properties": {
              "privateDnsZoneId": "[if(parameters('CreatePrivateDnsZones'), resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneBlob')), resourceId(parameters('VNetResourceGroupName'), 'Microsoft.Network/privateDnsZones', variables('privateDnsZoneBlob')))]"
            }
          }
        ]
      }
    },
    {
      "comments": "Private Endpoint for Queue Storage",
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[variables('privateEndpointQueueName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]"
      ],
      "properties": {
        "subnet": {
          "id": "[variables('privateEndpointSubnetResourceId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "QueueConnection",
            "properties": {
              "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]",
              "groupIds": [
                "queue"
              ]
            }
          }
        ]
      }
    },
    {
      "comments": "DNS Zone Group for Queue Private Endpoint",
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2023-05-01",
      "name": "[concat(variables('privateEndpointQueueName'), '/default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointQueueName'))]",
        "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneQueue'))]"
      ],
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "queue-config",
            "properties": {
              "privateDnsZoneId": "[if(parameters('CreatePrivateDnsZones'), resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneQueue')), resourceId(parameters('VNetResourceGroupName'), 'Microsoft.Network/privateDnsZones', variables('privateDnsZoneQueue')))]"
            }
          }
        ]
      }
    },
    {
      "comments": "Private Endpoint for Table Storage",
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[variables('privateEndpointTableName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]"
      ],
      "properties": {
        "subnet": {
          "id": "[variables('privateEndpointSubnetResourceId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "TableConnection",
            "properties": {
              "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]",
              "groupIds": [
                "table"
              ]
            }
          }
        ]
      }
    },
    {
      "comments": "DNS Zone Group for Table Private Endpoint",
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2023-05-01",
      "name": "[concat(variables('privateEndpointTableName'), '/default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointTableName'))]",
        "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneTable'))]"
      ],
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "table-config",
            "properties": {
              "privateDnsZoneId": "[if(parameters('CreatePrivateDnsZones'), resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneTable')), resourceId(parameters('VNetResourceGroupName'), 'Microsoft.Network/privateDnsZones', variables('privateDnsZoneTable')))]"
            }
          }
        ]
      }
    },
    {
      "comments": "Private Endpoint for File Storage",
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[variables('privateEndpointFileName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]"
      ],
      "properties": {
        "subnet": {
          "id": "[variables('privateEndpointSubnetResourceId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "FileConnection",
            "properties": {
              "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]",
              "groupIds": [
                "file"
              ]
            }
          }
        ]
      }
    },
    {
      "comments": "DNS Zone Group for File Private Endpoint",
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2023-05-01",
      "name": "[concat(variables('privateEndpointFileName'), '/default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointFileName'))]",
        "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneFile'))]"
      ],
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "file-config",
            "properties": {
              "privateDnsZoneId": "[if(parameters('CreatePrivateDnsZones'), resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneFile')), resourceId(parameters('VNetResourceGroupName'), 'Microsoft.Network/privateDnsZones', variables('privateDnsZoneFile')))]"
            }
          }
        ]
      }
    },
    {
      "comments": "Flex Consumption App Service Plan",
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2023-12-01",
      "name": "[variables('FunctionName')]",
      "location": "[resourceGroup().location]",
      "kind": "functionapp",
      "sku": {
        "tier": "FlexConsumption",
        "name": "FC1"
      },
      "properties": {
        "reserved": true
      }
    },
    {
      "comments": "Function App with VNet Integration and System-Assigned Managed Identity",
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-12-01",
      "name": "[variables('FunctionName')]",
      "location": "[resourceGroup().location]",
      "kind": "functionapp,linux",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('FunctionName'))]",
        "httpsOnly": true,
        "virtualNetworkSubnetId": "[variables('functionAppSubnetResourceId')]",
        "vnetRouteAllEnabled": true,
        "functionAppConfig": {
          "deployment": {
            "storage": {
              "type": "blobContainer",
              "value": "[format('https://{0}.blob.{1}/{2}', variables('StorageAccount'), variables('StorageSuffix'), variables('deploymentStorageContainerName'))]",
              "authentication": {
                "type": "SystemAssignedIdentity"
              }
            }
          },
          "scaleAndConcurrency": {
            "maximumInstanceCount": 100,
            "instanceMemoryMB": 2048
          },
          "runtime": {
            "name": "python",
            "version": "3.11"
          }
        },
        "siteConfig": {
          "minTlsVersion": "1.2",
          "ftpsState": "Disabled",
          "vnetRouteAllEnabled": true,
          "appSettings": [
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('FunctionName')), '2020-02-02').InstrumentationKey]"
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('FunctionName')), '2020-02-02').ConnectionString]"
            },
            {
              "name": "AzureWebJobsStorage__accountName",
              "value": "[variables('StorageAccount')]"
            },
            {
              "name": "WEBSITE_CONTENTOVERVNET",
              "value": "1"
            },
            {
              "name": "LUMEN_API_KEY",
              "value": "[parameters('LumenAPIKey')]"
            },
            {
              "name": "LUMEN_BASE_URL",
              "value": "[parameters('LumenBaseURL')]"
            },
            {
              "name": "WORKSPACE_ID",
              "value": "[parameters('WorkspaceID')]"
            },
            {
              "name": "TENANT_ID",
              "value": "[parameters('TenantID')]"
            },
            {
              "name": "CLIENT_ID",
              "value": "[parameters('ClientID')]"
            },
            {
              "name": "CLIENT_SECRET",
              "value": "[parameters('ClientSecret')]"
            },
            {
              "name": "LUMEN_CONFIDENCE_THRESHOLD",
              "value": "[parameters('LumenConfidenceThreshold')]"
            },
            {
              "name": "LUMEN_ENABLE_IPV4",
              "value": "[parameters('LumenEnableIPv4')]"
            },
            {
              "name": "LUMEN_ENABLE_DOMAIN",
              "value": "[parameters('LumenEnableDomain')]"
            },
            {
              "name": "LUMEN_POLL_INTERVAL",
              "value": "5"
            },
            {
              "name": "LUMEN_POLL_TIMEOUT",
              "value": "300"
            },
            {
              "name": "Polling",
              "value": "[variables('Polling')]"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('FunctionName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', variables('StorageAccount'), 'default', variables('deploymentStorageContainerName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts/queueServices', variables('StorageAccount'), 'default')]",
        "[resourceId('Microsoft.Storage/storageAccounts/tableServices', variables('StorageAccount'), 'default')]",
        "[resourceId('Microsoft.Storage/storageAccounts/fileServices', variables('StorageAccount'), 'default')]",
        "[resourceId('Microsoft.Insights/components', variables('FunctionName'))]",
        "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', variables('privateEndpointBlobName'), 'default')]",
        "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', variables('privateEndpointQueueName'), 'default')]",
        "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', variables('privateEndpointTableName'), 'default')]",
        "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', variables('privateEndpointFileName'), 'default')]"
      ]
    },
    {
      "comments": "RBAC: Storage Blob Data Owner - required for deployment storage and runtime",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount')), variables('storageBlobDataOwnerRoleId'), resourceId('Microsoft.Web/sites', variables('FunctionName')))]",
      "scope": "[concat('Microsoft.Storage/storageAccounts', '/', variables('StorageAccount'))]",
      "properties": {
        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataOwnerRoleId'))]",
        "principalId": "[reference(resourceId('Microsoft.Web/sites', variables('FunctionName')), '2023-12-01', 'Full').identity.principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', variables('FunctionName'))]"
      ]
    },
    {
      "comments": "Wait for RBAC propagation before deploying code",
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "WaitForRBACPropagation",
      "location": "[resourceGroup().location]",
      "kind": "AzurePowerShell",
      "properties": {
        "azPowerShellVersion": "9.7",
        "scriptContent": "Write-Output 'Waiting for RBAC propagation...'; Start-Sleep -Seconds 60; Write-Output 'RBAC propagation wait complete.'",
        "cleanupPreference": "Always",
        "retentionInterval": "PT1H",
        "timeout": "PT10M"
      },
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount')), variables('storageBlobDataOwnerRoleId'), resourceId('Microsoft.Web/sites', variables('FunctionName'))))]"
      ]
    },
    {
      "comments": "Deploy Function App code after RBAC and private endpoints are ready",
      "type": "Microsoft.Web/sites/extensions",
      "apiVersion": "2023-12-01",
      "name": "[format('{0}/{1}', variables('FunctionName'), 'onedeploy')]",
      "properties": {
        "packageUri": "https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Lumen%20Defender%20Threat%20Feed/Data%20Connectors/LumenThreatFeedv2/LumenThreatFeedConnectorv2.zip",
        "remoteBuild": true
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deploymentScripts', 'WaitForRBACPropagation')]",
        "[resourceId('Microsoft.Web/sites', variables('FunctionName'))]"
      ]
    }
  ],
  "outputs": {
    "FunctionAppName": {
      "type": "string",
      "value": "[variables('FunctionName')]",
      "metadata": {
        "description": "The name of the deployed Function App"
      }
    },
    "StorageAccountName": {
      "type": "string",
      "value": "[variables('StorageAccount')]",
      "metadata": {
        "description": "The name of the storage account"
      }
    },
    "FunctionAppUrl": {
      "type": "string",
      "value": "[format('https://{0}.azurewebsites.net', variables('FunctionName'))]",
      "metadata": {
        "description": "The URL of the deployed Function App"
      }
    },
    "FunctionAppPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Web/sites', variables('FunctionName')), '2023-12-01', 'Full').identity.principalId]",
      "metadata": {
        "description": "The managed identity principal ID of the Function App"
      }
    },
    "PrivateEndpoints": {
      "type": "object",
      "value": {
        "blob": "[variables('privateEndpointBlobName')]",
        "queue": "[variables('privateEndpointQueueName')]",
        "table": "[variables('privateEndpointTableName')]",
        "file": "[variables('privateEndpointFileName')]"
      },
      "metadata": {
        "description": "Names of the created private endpoints"
      }
    }
  }
}
