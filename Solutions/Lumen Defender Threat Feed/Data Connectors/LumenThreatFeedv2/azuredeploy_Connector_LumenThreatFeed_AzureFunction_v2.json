{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "FunctionName": {
      "type": "string",
      "defaultValue": "lumentfv2",
      "minLength": 1,
      "maxLength": 20,
      "metadata": {
        "description": "Name prefix for the Function App (will be lowercased and appended with a unique suffix)."
      }
    },
    "LumenAPIKey": {
      "type": "securestring",
      "metadata": {
        "description": "Lumen API Key for authenticating with the Threat Feed service."
      }
    },
    "LumenBaseURL": {
      "type": "string",
      "defaultValue": "https://microsoft-sentinel-api.us1.mss.lumen.com",
      "minLength": 1,
      "metadata": {
        "description": "Lumen Threat Feed API base URL."
      }
    },
    "WorkspaceID": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Microsoft Sentinel Workspace ID."
      }
    },
    "TenantID": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Azure Active Directory Tenant ID."
      }
    },
    "ClientID": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Azure App Registration Client ID."
      }
    },
    "ClientSecret": {
      "type": "securestring",
      "minLength": 1,
      "metadata": {
        "description": "Azure App Registration Client Secret."
      }
    },
    "LumenConfidenceThreshold": {
      "type": "string",
      "defaultValue": "60",
      "metadata": {
        "description": "Minimum confidence threshold for threat indicators (60-100)."
      }
    },
    "LumenEnableIPv4": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable ingestion of IPv4 threat indicators."
      }
    },
    "LumenEnableDomain": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable ingestion of domain threat indicators."
      }
    },
    "AppInsightsWorkspaceResourceID": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Log Analytics Workspace Resource ID for Application Insights. Format: /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.OperationalInsights/workspaces/{workspaceName}"
      }
    }
  },
  "variables": {
    "FunctionName": "[concat(toLower(parameters('FunctionName')), take(uniqueString(resourceGroup().id), 3))]",
    "StorageAccount": "[concat(variables('FunctionName'), take(uniqueString(resourceGroup().id), 3))]",
    "deploymentStorageContainerName": "lumenthreatfeed-v2",
    "StorageSuffix": "[environment().suffixes.storage]",
    "storageBlobDataOwnerRoleId": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b",
    "storageQueueDataContributorRoleId": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
    "storageTableDataContributorRoleId": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3",
    "Polling": "*/15 * * * *"
  },
  "resources": [
    {
      "comments": "Application Insights for monitoring and diagnostics",
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[variables('FunctionName')]",
      "location": "[resourceGroup().location]",
      "kind": "web",
      "properties": {
        "Application_Type": "web",
        "ApplicationId": "[variables('FunctionName')]",
        "WorkspaceResourceId": "[parameters('AppInsightsWorkspaceResourceID')]"
      }
    },
    {
      "comments": "Storage Account with enterprise security settings",
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-05-01",
      "name": "[variables('StorageAccount')]",
      "location": "[resourceGroup().location]",
      "kind": "StorageV2",
      "sku": {
        "name": "Standard_LRS"
      },
      "properties": {
        "supportsHttpsTrafficOnly": true,
        "defaultToOAuthAuthentication": true,
        "allowBlobPublicAccess": false,
        "allowSharedKeyAccess": true,
        "minimumTlsVersion": "TLS1_2",
        "networkAcls": {
          "bypass": "AzureServices",
          "defaultAction": "Allow"
        }
      }
    },
    {
      "comments": "Blob Services - explicit definition for reliability",
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', variables('StorageAccount'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]"
      ],
      "properties": {
        "deleteRetentionPolicy": {
          "enabled": false
        }
      }
    },
    {
      "comments": "Queue Services - required for Azure Functions runtime (timer triggers, etc.)",
      "type": "Microsoft.Storage/storageAccounts/queueServices",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', variables('StorageAccount'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]"
      ],
      "properties": {}
    },
    {
      "comments": "Table Services - required for Azure Functions runtime (lease management, etc.)",
      "type": "Microsoft.Storage/storageAccounts/tableServices",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', variables('StorageAccount'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount'))]"
      ],
      "properties": {}
    },
    {
      "comments": "Deployment container for Function App code",
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}/{2}', variables('StorageAccount'), 'default', variables('deploymentStorageContainerName'))]",
      "properties": {
        "publicAccess": "None"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('StorageAccount'), 'default')]"
      ]
    },
    {
      "comments": "Flex Consumption App Service Plan - serverless with managed scaling",
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2023-12-01",
      "name": "[variables('FunctionName')]",
      "location": "[resourceGroup().location]",
      "kind": "functionapp",
      "sku": {
        "tier": "FlexConsumption",
        "name": "FC1"
      },
      "properties": {
        "reserved": true
      }
    },
    {
      "comments": "Function App with System-Assigned Managed Identity",
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-12-01",
      "name": "[variables('FunctionName')]",
      "location": "[resourceGroup().location]",
      "kind": "functionapp,linux",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('FunctionName'))]",
        "httpsOnly": true,
        "functionAppConfig": {
          "deployment": {
            "storage": {
              "type": "blobContainer",
              "value": "[format('https://{0}.blob.{1}/{2}', variables('StorageAccount'), variables('StorageSuffix'), variables('deploymentStorageContainerName'))]",
              "authentication": {
                "type": "SystemAssignedIdentity"
              }
            }
          },
          "scaleAndConcurrency": {
            "maximumInstanceCount": 100,
            "instanceMemoryMB": 2048
          },
          "runtime": {
            "name": "python",
            "version": "3.11"
          }
        },
        "siteConfig": {
          "minTlsVersion": "1.2",
          "ftpsState": "Disabled",
          "appSettings": [
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('FunctionName')), '2020-02-02').InstrumentationKey]"
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('FunctionName')), '2020-02-02').ConnectionString]"
            },
            {
              "name": "AzureWebJobsStorage__accountName",
              "value": "[variables('StorageAccount')]"
            },
            {
              "name": "LUMEN_API_KEY",
              "value": "[parameters('LumenAPIKey')]"
            },
            {
              "name": "LUMEN_BASE_URL",
              "value": "[parameters('LumenBaseURL')]"
            },
            {
              "name": "WORKSPACE_ID",
              "value": "[parameters('WorkspaceID')]"
            },
            {
              "name": "TENANT_ID",
              "value": "[parameters('TenantID')]"
            },
            {
              "name": "CLIENT_ID",
              "value": "[parameters('ClientID')]"
            },
            {
              "name": "CLIENT_SECRET",
              "value": "[parameters('ClientSecret')]"
            },
            {
              "name": "LUMEN_CONFIDENCE_THRESHOLD",
              "value": "[parameters('LumenConfidenceThreshold')]"
            },
            {
              "name": "LUMEN_ENABLE_IPV4",
              "value": "[parameters('LumenEnableIPv4')]"
            },
            {
              "name": "LUMEN_ENABLE_DOMAIN",
              "value": "[parameters('LumenEnableDomain')]"
            },
            {
              "name": "LUMEN_POLL_INTERVAL",
              "value": "5"
            },
            {
              "name": "LUMEN_POLL_TIMEOUT",
              "value": "300"
            },
            {
              "name": "Polling",
              "value": "[variables('Polling')]"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('FunctionName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', variables('StorageAccount'), 'default', variables('deploymentStorageContainerName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts/queueServices', variables('StorageAccount'), 'default')]",
        "[resourceId('Microsoft.Storage/storageAccounts/tableServices', variables('StorageAccount'), 'default')]",
        "[resourceId('Microsoft.Insights/components', variables('FunctionName'))]"
      ]
    },
    {
      "comments": "RBAC: Storage Blob Data Owner - required for deployment storage and runtime",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount')), variables('storageBlobDataOwnerRoleId'), resourceId('Microsoft.Web/sites', variables('FunctionName')))]",
      "scope": "[concat('Microsoft.Storage/storageAccounts', '/', variables('StorageAccount'))]",
      "properties": {
        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataOwnerRoleId'))]",
        "principalId": "[reference(resourceId('Microsoft.Web/sites', variables('FunctionName')), '2023-12-01', 'Full').identity.principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', variables('FunctionName'))]"
      ]
    },
    {
      "comments": "RBAC: Storage Queue Data Contributor - required for timer triggers and internal messaging",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount')), variables('storageQueueDataContributorRoleId'), resourceId('Microsoft.Web/sites', variables('FunctionName')))]",
      "scope": "[concat('Microsoft.Storage/storageAccounts', '/', variables('StorageAccount'))]",
      "properties": {
        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('storageQueueDataContributorRoleId'))]",
        "principalId": "[reference(resourceId('Microsoft.Web/sites', variables('FunctionName')), '2023-12-01', 'Full').identity.principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', variables('FunctionName'))]"
      ]
    },
    {
      "comments": "RBAC: Storage Table Data Contributor - required for lease management and singleton locks",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount')), variables('storageTableDataContributorRoleId'), resourceId('Microsoft.Web/sites', variables('FunctionName')))]",
      "scope": "[concat('Microsoft.Storage/storageAccounts', '/', variables('StorageAccount'))]",
      "properties": {
        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('storageTableDataContributorRoleId'))]",
        "principalId": "[reference(resourceId('Microsoft.Web/sites', variables('FunctionName')), '2023-12-01', 'Full').identity.principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', variables('FunctionName'))]"
      ]
    },
    {
      "comments": "Wait for RBAC propagation before deploying code. Azure RBAC can take up to 5 minutes to propagate.",
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "WaitForRBACPropagation",
      "location": "[resourceGroup().location]",
      "kind": "AzurePowerShell",
      "properties": {
        "azPowerShellVersion": "9.7",
        "scriptContent": "Write-Output 'Waiting for RBAC propagation...'; Start-Sleep -Seconds 120; Write-Output 'RBAC propagation wait complete.'",
        "cleanupPreference": "Always",
        "retentionInterval": "PT1H",
        "timeout": "PT10M"
      },
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount')), variables('storageBlobDataOwnerRoleId'), resourceId('Microsoft.Web/sites', variables('FunctionName'))))]",
        "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount')), variables('storageQueueDataContributorRoleId'), resourceId('Microsoft.Web/sites', variables('FunctionName'))))]",
        "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Storage/storageAccounts', variables('StorageAccount')), variables('storageTableDataContributorRoleId'), resourceId('Microsoft.Web/sites', variables('FunctionName'))))]"
      ]
    },
    {
      "comments": "Deploy Function App code after RBAC is ready",
      "type": "Microsoft.Web/sites/extensions",
      "apiVersion": "2023-12-01",
      "name": "[format('{0}/{1}', variables('FunctionName'), 'onedeploy')]",
      "properties": {
        "packageUri": "https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Lumen%20Defender%20Threat%20Feed/Data%20Connectors/LumenThreatFeedv2/LumenThreatFeedConnectorv2.zip",
        "remoteBuild": true
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deploymentScripts', 'WaitForRBACPropagation')]",
        "[resourceId('Microsoft.Web/sites', variables('FunctionName'))]"
      ]
    }
  ],
  "outputs": {
    "FunctionAppName": {
      "type": "string",
      "value": "[variables('FunctionName')]",
      "metadata": {
        "description": "The name of the deployed Function App"
      }
    },
    "StorageAccountName": {
      "type": "string",
      "value": "[variables('StorageAccount')]",
      "metadata": {
        "description": "The name of the storage account"
      }
    },
    "FunctionAppUrl": {
      "type": "string",
      "value": "[format('https://{0}.azurewebsites.net', variables('FunctionName'))]",
      "metadata": {
        "description": "The URL of the deployed Function App"
      }
    },
    "FunctionAppPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Web/sites', variables('FunctionName')), '2023-12-01', 'Full').identity.principalId]",
      "metadata": {
        "description": "The managed identity principal ID of the Function App"
      }
    }
  }
}
