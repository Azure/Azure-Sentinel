{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "isWizard": false,
      "basics": {
        "description": "<img src=\"https://raw.githubusercontent.com/johnpcmatic/Azure-Sentinel/pcm-sentinel/Solutions/PCMatic%20SuperShield/Logo/pcmatic-green-outline.png\" width=\"200px\" height=\"45px\">\n\n**Important:** _This Microsoft Sentinel Solution is currently in public preview. This feature is provided without a service level agreement, and it's not recommended for production workloads. Certain features might not be supported or might have constrained capabilities. For more information, see [Supplemental Terms of Use for Microsoft Azure Previews](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)._\n\n**Note:** _There may be [known issues](https://aka.ms/sentinelsolutionsknownissues) pertaining to this Solution, please refer to them before installing._\n\nThis PC Matic SuperShield Sentinel solution provides the capability to ingest [PC Matic SuperShield](https://www.pcmatic.com/pro/) process activity events with Microsoft Sentinel. It helps you gain visibility into what applications and processes are being executed on your endpoints, and which of those are blocked by SuperShield.\n\nMicrosoft Sentinel Solutions provide a consolidated way to acquire Microsoft Sentinel content like data connectors, workbooks, analytics, and automations in your workspace with a single deployment step.\n\n**Data Connectors:** 1, **Parsers:** 1, **Analytic Rules:** 3, **Playbooks:** 2\n\n[Learn more about Microsoft Sentinel](https://aka.ms/azuresentinel) | [Learn more about Solutions](https://aka.ms/azuresentinelsolutionsdoc)\n\n**Required:** If you do not have an existing Sentinel Workspace, please create one by going to Microsoft Sentinel and clicking on the \"Create\" tab. Follow the wizard to create a new Sentinel Workspace.",
        "subscription": {
          "resourceProviders": [
            "Microsoft.OperationsManagement/solutions",
            "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "Microsoft.Insights/workbooks",
            "Microsoft.Logic/workflows"
          ]
        },
        "location": {
          "metadata": {
            "hidden": "Hiding location, we get it from the log analytics workspace"
          },
          "visible": false
        },
        "resourceGroup": {
          "allowExisting": true
        }
      }
    },
    "basics": [
      {
        "name": "getLAWorkspace",
        "type": "Microsoft.Solutions.ArmApiControl",
        "toolTip": "This filters by workspaces that exist in the Resource Group selected",
        "condition": "[greater(length(resourceGroup().name),0)]",
        "request": {
          "method": "GET",
          "path": "[concat(subscription().id,'/providers/Microsoft.OperationalInsights/workspaces?api-version=2020-08-01')]"
        }
      },
      {
        "name": "workspace",
        "type": "Microsoft.Common.DropDown",
        "label": "Workspace",
        "placeholder": "Select a workspace",
        "toolTip": "Please select your Sentinel workspace. If you do not see the workspace listed here, please make sure you have selected the correct Resource Group and you have created a Sentinel workspace in that group.",
        "constraints": {
          "allowedValues": "[map(filter(basics('getLAWorkspace').value, (filter) => contains(toLower(filter.id), toLower(resourceGroup().name))), (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
          "required": true
        },
        "visible": true
      }
    ],
    "steps": [
      {
				"name": "apiCredentials",
                "label": "Key Vault & API Credentials",
                "elements": [
					{
						"name": "keyVaultDescription",
						"type": "Microsoft.Common.TextBlock",
						"visible": true,
						"options": {
							"text": "In this section, please create a Key Vault for storing and retrieving the PC Matic API user credentials created in the PC Matic web portal.",
							"link": {
								"label": "Learn more",
								"uri": "https://docs.microsoft.com/en-us/azure/key-vault/general/overview"
							}
						}
					},
					{
						"name": "keyVaultName",
						"type": "Microsoft.Common.TextBox",
						"label": "Key Vault Name",
						"placeholder": "",
						"defaultValue": "pcMaticApiKeyVault",
						"toolTip": "Vault name must only contain alphanumeric characters and dashes and cannot start with a number. The value must be 3-24 characters long and must not contain spaces.",
						"constraints": {
							"required": true,
							"regex": "^[a-z0-9A-Z]{1,30}$",
							"validationMessage": "Vault name must only contain alphanumeric characters and dashes and cannot start with a number. The value must be 3-24 characters long and must not contain spaces."
						},
						"visible": true
					},
					{
						"name": "skuName",
						"type": "Microsoft.Common.DropDown",
						"label": "Pricing Tier",
						"defaultValue": "Standard",
						"toolTip": "Azure Key Vault service is offered in two service tiers: standard and premium [Learn more about pricing tiers.](https://azure.microsoft.com/en-us/pricing/details/key-vault/)",
						"constraints": {
							"allowedValues": [
								{
									"label": "Standard",
									"value": "standard"
								},
								{
									"label": "Premium",
									"value": "premium"
								}
							],
							"required": true
						},
						"visible": true
					},
					{
						"name": "apiText",
						"type": "Microsoft.Common.TextBlock",
						"visible": true,
						"options": {
							"text": "Below, enter the email address and password chosen when the API user was created in the PC Matic web portal. This will be stored in the Azure Key Vault and allow Microsoft Sentinel to connect to the SuperShield API. Please create a unique name for this username/password combination."
						}
					},
					{
						"name": "secretName",
						"type": "Microsoft.Common.TextBox",
						"label": "Unique Name",
						"placeholder": "",
						"defaultValue": "pcMaticApiSecret",
						"toolTip": "Give the username/password combination an identifying name.",
						"constraints": {
							"required": true,
							"regex": "^[a-z0-9A-Z]{1,30}$",
							"validationMessage": "Only alphanumeric characters are allowed. The value must be 3-24 characters long and not start with a number. No spaces."
						},
						"visible": true
					},
					{
						"name": "apiUsername",
						"label": "API Username",
						"type": "Microsoft.Common.TextBox",
						"placeholder": "API username/email address",
						"defaultValue": "",
						"toolTip": "API username/email address entered when user was created in PC Matic Portal",
						"constraints": {
							"required": true,
							"validationMessage": "Please enter a valid email address."
						},
						"visible": true
					},
					{
						"name": "apiPassword",
						"label": {"password": "API Password", "confirmPassword": ""},
						"type": "Microsoft.Common.PasswordBox",
						"toolTip": "API password entered when user was created in PC Matic Portal",
						"constraints": {
							"required": true
						},
						"options": {
							"hideConfirmation": true
						},
						"visible": true
					}
				]
      },
      {
        "name": "dataconnectors",
        "label": "Data Connectors",
        "bladeTitle": "Data Connectors",
        "elements": [
          {
            "name": "dataconnectors1-text",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "PC Matic SuperShield activity can be ingested using the built-in Common Event Format (CEF) log data connector. Configure the CEF connector, then log into your PC Matic Pro/MSP account to configure PC Matic syslog forwarding. Use the IP address for the Linux VM with the Linux agent installed as the Syslog Server Address.",
              "link": {
                "label": "View screenshot",
                "uri": "https://raw.githubusercontent.com/johnpcmatic/Azure-Sentinel/pcm-sentinel/Solutions/PCMatic%20SuperShield/assets/syslog.png"
              }
            }
          },
          {
            "name": "dataconnectors-parser-text",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "These queries and workbooks are dependent on a parser based on a Kusto Function to work as expected. Follow the steps to use this Kusto functions alias **SuperShieldActivity** in queries and workbooks.",
              "link": {
                "label": "Click here for the Kusto function",
                "uri": "https://raw.githubusercontent.com/johnpcmatic/Azure-Sentinel/pcm-sentinel/Solutions/PCMatic%20SuperShield/Parsers/PCMSS.txt"
              }
            }
          },
          {
            "name": "dataconnectors-link1",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "link": {
                "label": "Learn more about normalized format",
                "uri": "https://docs.microsoft.com/azure/sentinel/normalization-schema"
              }
            }
          },
          {
            "name": "dataconnectors-link2",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "link": {
                "label": "Learn more about connecting data sources",
                "uri": "https://docs.microsoft.com/azure/sentinel/connect-data-sources"
              }
            }
          }
        ]
      },
      {
        "name": "analytics",
        "label": "Analytics",
        "subLabel": {
          "preValidation": "Configure the analytics",
          "postValidation": "Done"
        },
        "bladeTitle": "Analytics",
        "elements": [
          {
            "name": "analytics-text",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "This Microsoft Sentinel Solution installs analytic rules for PCMatic SuperShield that you can enable for custom alert generation in Microsoft Sentinel. These analytic rules will be deployed in disabled mode in the analytics rules gallery of your Microsoft Sentinel workspace. Configure and enable these rules in the analytic rules gallery after this Solution deploys.\n\nGo to Microsoft Sentinel -> <Sentinel Workspace> -> Analytics and search for the rules listed below. Enable each to begin creating blocked process incidents.",
              "link": {
                "label": "Learn more",
                "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-detect-threats-custom?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef"
              }
            }
          },
          {
            "name": "analytic1",
            "type": "Microsoft.Common.Section",
            "label": "PCMatic SuperShield Known Bad Processes",
            "elements": [
              {
                "name": "analytic1-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "Identifies processes known to be bad and blocked by SuperShield"
                }
              }
            ]
          },
          {
            "name": "analytic2",
            "type": "Microsoft.Common.Section",
            "label": "PCMatic SuperShield Unknown Process",
            "elements": [
              {
                "name": "analytic2-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "Identifies unknown processes blocked by SuperShield"
                }
              }
            ]
          },
          {
            "name": "analytic3",
            "type": "Microsoft.Common.Section",
            "label": "PCMatic SuperShield Allowed Process",
            "elements": [
              {
                "name": "analytic3-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "Identifies processes allowed by SuperShield"
                }
              }
            ]
          }
        ]
      },
      {
        "name": "playbooks",
        "label": "Playbooks",
        "subLabel": {
          "preValidation": "Configure the playbooks",
          "postValidation": "Done"
        },
        "bladeTitle": "Playbooks",
        "elements": [
          {
            "name": "playbooks-text1",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "This solution installs two Playbooks to communicate with PC Matic Pro. When a process is blocked, an incident will be created. Once you have determined whether the process should be allowed or blocked, you can select \"Actions\" > \"Run Playbook\" and select \"Allow\" to add the process to your local whitelist, or \"Block\" to continue to block an unknown process or to block an allowed process.",
              "link": {
                "label": "Learn more",
                "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-respond-threats-playbook?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef"
              }
            }
          },
          {
            "name": "playbooks-text2",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "A security playbook is a collection of procedures that can be run from Microsoft Sentinel in response to an alert. A security playbook can help automate and orchestrate your response, and can be run manually or set to run automatically when specific alerts are triggered. Security playbooks in Microsoft Sentinel are based on Azure Logic Apps, which means that you get all the power, customizability, and built-in templates of Logic Apps. Each playbook is created for the specific subscription you choose, but when you look at the Playbooks page, you will see all the playbooks across any selected subscriptions.",
              "link": {
                "label": "Learn more",
                "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-respond-threats-playbook?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef"
              }
            }
          },
          {
            "name": "playbook1",
            "type": "Microsoft.Common.Section",
            "label": "Allow",
            "elements": [
              {
                "name": "playbook1-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "Allows adding blocked processes to your local SuperShield whitelist."
                }
              }
            ]
          },
          {
            "name": "playbook2",
            "type": "Microsoft.Common.Section",
            "label": "Block",
            "elements": [
              {
                "name": "playbook2-text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "Blocks processes and adds them to your local SuperShield blacklist."
                }
              }
            ]
          }
        ]
      }
    ],
    "outputs": {
      "workspace-location": "[first(map(filter(basics('getLAWorkspace').value, (filter) => and(contains(toLower(filter.id), toLower(resourceGroup().name)),equals(filter.name,basics('workspace')))), (item) => item.location))]",
      "location": "[location()]",
      "workspace": "[basics('workspace')]"
    }
  }
}
