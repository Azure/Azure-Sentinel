{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "John Farley - john@pcmatic.com",
    "comments": "Solution template for PCMatic SuperShield"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic3-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "playbook1-PlaybookName": {
      "defaultValue": "BlockAllowProcess",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook2-PlaybookName": {
      "defaultValue": "RemoveProcess",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    }
  },
  "variables": {
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "PCMSS_Parser": "PCMSS_Parser",
    "_PCMSS_Parser": "[variables('PCMSS_Parser')]",
    "KnownBadProcess_AnalyticalRules": "KnownBadProcess_AnalyticalRules",
    "_KnownBadProcess_AnalyticalRules": "[variables('KnownBadProcess_AnalyticalRules')]",
    "UnknownProcess_AnalyticalRules": "UnknownProcess_AnalyticalRules",
    "_UnknownProcess_AnalyticalRules": "[variables('UnknownProcess_AnalyticalRules')]",
    "AllowedProcess_AnalyticalRules": "AllowedProcess_AnalyticalRules",
    "_AllowedProcess_AnalyticalRules": "[variables('AllowedProcess_AnalyticalRules')]",
    "playbook1-AllowProcess": "playbook1-AllowProcess",
    "_playbook1-AllowProcess": "[variables('playbook1-AllowProcess')]",
    "playbook1-MicrosoftSentinelConnectionName": "[concat('MicrosoftSentinel-', parameters('playbook1-PlaybookName'))]",
    "playbook-1-connection-2": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/Azuresentinel')]",
    "_playbook-1-connection-2": "[variables('playbook-1-connection-2')]",
    "playbook2-BlockProcess": "playbook2-BlockProcess",
    "_playbook2-BlockProcess": "[variables('playbook2-BlockProcess')]",
    "playbook2-MicrosoftSentinelConnectionName": "[concat('MicrosoftSentinel-', parameters('playbook2-PlaybookName'))]",
    "sourceId": "pcmatic.pcmatic-supershield",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "PCMatic SuperShield Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "PCMatic SuperShield Data Parser",
            "category": "Samples",
            "functionAlias": "PCMSS",
            "query": "\nCommonSecurityLog\n| where DeviceVendor == 'PCMatic'\n| extend Category = extract(@'cat=(.*?);', 1, AdditionalExtensions)\n| extend Severity = extract(@'Severity=(.*?);', 1, AdditionalExtensions, typeof(int))\n| extend Host = extract(@'Host=(.*?);', 1, AdditionalExtensions)\n| extend DeviceExternalID = extract(@'deviceExternalID=(.*?);', 1, AdditionalExtensions)\n| extend GroupName = extract(@'groupName=(.*?);', 1, AdditionalExtensions)\n| extend GroupID = extract(@'groupID=(.*?);', 1, AdditionalExtensions)\n| extend ParentPath = extract(@'parentPath=(.*?);', 1, AdditionalExtensions)\n| extend MD5 = extract(@'md5=(.*?);', 1, AdditionalExtensions)\n| extend FileHash = extract(@'filehash=(.*?);', 1, AdditionalExtensions)\n| extend IsUnknown = extract(@'isUnknown=(.*?);', 1, AdditionalExtensions)\n| extend IsScript = extract(@'isScript=(.*?);', 1, AdditionalExtensions)\n| extend UserDecided = extract(@'userDecided=(.*?);', 1, AdditionalExtensions)\n| extend UserDecidedDesc = extract(@'userDecidedDesc=(.*?);', 1, AdditionalExtensions)\n| extend CmdLineArgs = extract(@'cmdLineArgs=(.*?);', 1, AdditionalExtensions)\n| extend Vendor = extract(@'vendor=(.*?);', 1, AdditionalExtensions)\n| extend Product = extract(@'product=(.*?);', 1, AdditionalExtensions)\n| extend ProductVersion = extract(@'productVersion=(.*?);', 1, AdditionalExtensions)\n| extend FileCopyright = extract(@'fileCopyright=(.*?);', 1, AdditionalExtensions)\n| extend IsSigned = extract(@'isSigned=(.*?);', 1, AdditionalExtensions)\n| extend DigitalSigAuthority = extract(@'digitalSigAuthority=(.*?);', 1, AdditionalExtensions)\n| extend DigitalSigVendor = extract(@'digitalSigVendor=(.*?);', 1, AdditionalExtensions)\n| extend OS = extract(@'os=(.*?);', 1, AdditionalExtensions)\n| extend OSArch = extract(@'osArch=(.*?);', 1, AdditionalExtensions)\n| extend OSPlatform = extract(@'osPlatform=(.*?);', 1, AdditionalExtensions)\n| extend OSRelease = extract(@'osRelease=(.*?);', 1, AdditionalExtensions)\n| extend OSKernel = extract(@'osKernel=(.*?);', 1, AdditionalExtensions)\n| extend ProtectionMode = extract(@'protectionMode=(.*)', 1, AdditionalExtensions)\n| order by TimeGenerated desc\n;",
            "version": 1
          }
        }
      ]
    },

    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "NRT",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Identifies known bad processes blocked by SuperShield",
        "displayName": "PCMatic SuperShield Known Bad Processes",
        "enabled": false,
        "query": "SuperShieldActivity\n| where TimeGenerated >= ago(5m)\n| where Severity == 0\n| where IsUnknown == 0 or IsUnknown == \"false\"\n| summarize by FileHash, FileName, Host, DeviceAddress, ParentPath, CmdLineArgs, TimeGenerated\n",
        "queryFrequency": "PT1M",
        "queryPeriod": "PT5M",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Execution"
        ],
        "entityMappings": [
          {
            "entityType": "FileHash",
            "fieldMappings": [
              {
                "identifier": "Value",
                "columnName": "FileHash"
              }
            ]
          },
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "DeviceAddress"
              }
            ]
          },
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "Host"
              }
            ]
          },
          {
            "entityType": "File",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "FileName"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "NRT",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Identifies unknown processes blocked by SuperShield",
        "displayName": "PCMatic SuperShield Unknown Process",
        "enabled": false,
        "query": "SuperShieldActivity\n| where TimeGenerated >= ago(5m)\n| where Severity == 0\n| where IsUnknown == 1\n| summarize by FileHash, FileName, Host, DeviceAddress, ParentPath, CmdLineArgs, TimeGenerated\n",
        "queryFrequency": "PT1M",
        "queryPeriod": "PT5M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Execution"
        ],
        "entityMappings": [
          {
            "entityType": "FileHash",
            "fieldMappings": [
              {
                "identifier": "Value",
                "columnName": "FileHash"
              }
            ]
          },
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "DeviceAddress"
              }
            ]
          },
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "Host"
              }
            ]
          },
          {
            "entityType": "File",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "FileName"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic3-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "NRT",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Identifies processes allowed by SuperShield",
        "displayName": "PCMatic SuperShield Allowed Process",
        "enabled": false,
        "query": "SuperShieldActivity\n| where TimeGenerated >= ago(5m)\n| where Severity > 1\n| summarize by FileHash, FileName, Host, DeviceAddress, ParentPath, CmdLineArgs, TimeGenerated\n",
        "queryFrequency": "PT1M",
        "queryPeriod": "PT5M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Execution"
        ],
        "entityMappings": [
          {
            "entityType": "FileHash",
            "fieldMappings": [
              {
                "identifier": "Value",
                "columnName": "FileHash"
              }
            ]
          },
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "DeviceAddress"
              }
            ]
          },
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "Host"
              }
            ]
          },
          {
            "entityType": "File",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "FileName"
              }
            ]
          }
        ]
      }
    },
    {
      "properties": {
        "provisioningState": "Succeeded",
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "Microsoft_Sentinel_incident": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel_1']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              }
            }
          },
          "actions": {
            "HTTP": {
              "type": "Http",
              "inputs": {
                "body": {
                  "action": "allow",
                  "data": "@triggerBody()?['object']?['properties']?['relatedEntities']"
                },
                "method": "POST",
                "uri": "https://psmss-test-api.herokuapp.com"
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel_1": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-MicrosoftSentinelConnectionName'))]",
                "connectionName": "[variables('playbook1-MicrosoftSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/Azuresentinel')]"
              }
            }
          }
        }
      },
      "name": "[parameters('playbook1-PlaybookName')]",
      "type": "Microsoft.Logic/workflows",
      "location": "[parameters('workspace-location')]",
      "apiVersion": "2017-07-01",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook1-MicrosoftSentinelConnectionName'))]"
      ]
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook1-MicrosoftSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "kind": "V1",
      "properties": {
        "displayName": "[variables('playbook1-MicrosoftSentinelConnectionName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "properties": {
        "provisioningState": "Succeeded",
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "Microsoft_Sentinel_incident": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel_1']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              }
            }
          },
          "actions": {
            "HTTP": {
              "type": "Http",
              "inputs": {
                "body": {
                  "action": "block",
                  "data": "@triggerBody()?['object']?['properties']?['relatedEntities']"
                },
                "method": "POST",
                "uri": "https://psmss-test-api.herokuapp.com"
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel_1": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook2-MicrosoftSentinelConnectionName'))]",
                "connectionName": "[variables('playbook2-MicrosoftSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/Azuresentinel')]"
              }
            }
          }
        }
      },
      "name": "[parameters('playbook2-PlaybookName')]",
      "type": "Microsoft.Logic/workflows",
      "location": "[parameters('workspace-location')]",
      "apiVersion": "2017-07-01",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook2-MicrosoftSentinelConnectionName'))]"
      ]
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook2-MicrosoftSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "kind": "V1",
      "properties": {
        "displayName": "[variables('playbook2-MicrosoftSentinelConnectionName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "version": "1.0.0",
        "kind": "Solution",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "PCMatic SuperShield",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "John Farley",
          "email": "john@pcmatic.com"
        },
        "support": {
          "name": "PC Matic",
          "email": "support@pcmatic.com",
          "tier": "PC Matic",
          "link": "https://www.pcmatic.com/support/#/business-support-form"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Parser",
              "contentId": "[variables('_PCMSS_Parser')]",
              "version": "1.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_KnownBadProcess_AnalyticalRules')]",
              "version": "1.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_UnknownProcess_AnalyticalRules')]",
              "version": "1.0.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_AllowedProcess_AnalyticalRules')]",
              "version": "1.0.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_playbook1-AllowProcess')]",
              "version": "1.0.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_playbook2-BlockProcess')]",
              "version": "1.0.0"
            }
          ]
        },
        "firstPublishDate": "2022-05-16",
        "lastPublishDate": "2022-05-16",
        "providers": [
          "PC Matic"
        ],
        "categories": {
          "domains": [
            "Security - Vulnerability Management"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
