{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "BeyondTrust - mysupport@beyondtrust.com",
    "comments": "Solution template for BeyondTrustPMCloud"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "BeyondTrust PM Cloud",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "email": "mysupport@beyondtrust.com",
    "_email": "[variables('email')]",
    "_solutionName": "BeyondTrustPMCloud",
    "_solutionVersion": "3.0.0",
    "solutionId": "beyondtrust.beyondtrustpmcloud-sentinel-solution",
    "_solutionId": "[variables('solutionId')]",
    "uiConfigId1": "BeyondTrustPMCloud",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "BeyondTrustPMCloud",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1'))))]",
    "dataConnectorVersion1": "1.0.0",
    "_dataConnectorcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentId1'),'-', variables('dataConnectorVersion1'))))]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "BeyondTrustPMCloudWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BeyondTrustPMCloud data connector with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "BeyondTrust PM Cloud",
                  "publisher": "BeyondTrust",
                  "descriptionMarkdown": "The BeyondTrust Privilege Management Cloud data connector provides the capability to ingest activity audit logs and client event logs from BeyondTrust PM Cloud into Microsoft Sentinel.\n\nThis connector uses Azure Functions to pull data from the BeyondTrust PM Cloud API and ingest it into custom Log Analytics tables.",
                  "graphQueries": [
                    {
                      "metricName": "Total Activity Audits received",
                      "legend": "BeyondTrustPM_ActivityAudits_CL",
                      "baseQuery": "BeyondTrustPM_ActivityAudits_CL"
                    },
                    {
                      "metricName": "Total Client Events received",
                      "legend": "BeyondTrustPM_ClientEvents_CL",
                      "baseQuery": "BeyondTrustPM_ClientEvents_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "All Activity Audits",
                      "query": "BeyondTrustPM_ActivityAudits_CL\n| sort by TimeGenerated desc"
                    },
                    {
                      "description": "All Client Events",
                      "query": "BeyondTrustPM_ClientEvents_CL\n| sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "BeyondTrustPM_ActivityAudits_CL",
                      "lastDataReceivedQuery": "BeyondTrustPM_ActivityAudits_CL\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
                    },
                    {
                      "name": "BeyondTrustPM_ClientEvents_CL",
                      "lastDataReceivedQuery": "BeyondTrustPM_ClientEvents_CL\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "BeyondTrustPM_ActivityAudits_CL\n| summarize LastLogReceived = max(TimeGenerated)\n| project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    },
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "BeyondTrustPM_ClientEvents_CL\n| summarize LastLogReceived = max(TimeGenerated)\n| project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft.Web/sites permissions",
                        "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
                      },
                      {
                        "name": "BeyondTrust PM Cloud API credentials",
                        "description": "BeyondTrust PM Cloud OAuth Client ID and Client Secret are required. Contact BeyondTrust support for API access."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": ">**NOTE:** This connector uses Azure Functions to connect to the BeyondTrust PM Cloud API to pull logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
                    },
                    {
                      "description": ">**NOTE:** This connector uses the OAuth 2.0 client credentials flow to authenticate with the BeyondTrust PM Cloud API."
                    },
                    {
                      "description": "Contact BeyondTrust support to obtain OAuth API credentials (Client ID and Client Secret) for accessing the BeyondTrust PM Cloud API.",
                      "title": "STEP 1 - Obtain BeyondTrust PM Cloud API credentials"
                    },
                    {
                      "description": "Use this method for automated deployment of the BeyondTrust PM Cloud data connector using an ARM Template.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FAzure-Sentinel%2Fmaster%2FSolutions%2FBeyondTrustPMCloud%2FData%2520Connectors%2Fazuredeploy_BeyondTrustPMCloud_API_FunctionApp.json)\n2. Select the preferred **Subscription**, **Resource Group**, and **Location**. \n3. Enter the required parameters:\n   - **Workspace ID**: Your Log Analytics Workspace ID\n   - **Workspace Key**: Your Log Analytics Workspace Key\n   - **BeyondTrust Tenant Name**: Your BeyondTrust PM Cloud tenant name\n   - **BeyondTrust Client ID**: OAuth Client ID from Step 1\n   - **BeyondTrust Client Secret**: OAuth Client Secret from Step 1\n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**.\n5. Click **Purchase** to deploy.",
                      "title": "STEP 2 - Deploy the connector and the associated Azure Function"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2023-04-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "BeyondTrustPMCloud",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "BeyondTrust",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "BeyondTrust",
                  "email": "mysupport@beyondtrust.com",
                  "link": "https://www.beyondtrust.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "contentKind": "DataConnector",
        "displayName": "BeyondTrust PM Cloud",
        "contentProductId": "[variables('_dataConnectorcontentProductId1')]",
        "id": "[variables('_dataConnectorcontentProductId1')]",
        "version": "[variables('dataConnectorVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "BeyondTrustPMCloud",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "BeyondTrust",
          "email": "[variables('_email')]"
        },
        "support": {
          "tier": "Partner",
          "name": "BeyondTrust",
          "email": "mysupport@beyondtrust.com",
          "link": "https://www.beyondtrust.com/"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "BeyondTrust PM Cloud",
          "publisher": "BeyondTrust",
          "descriptionMarkdown": "The BeyondTrust Privilege Management Cloud data connector provides the capability to ingest activity audit logs and client event logs from BeyondTrust PM Cloud into Microsoft Sentinel.\n\nThis connector uses Azure Functions to pull data from the BeyondTrust PM Cloud API and ingest it into custom Log Analytics tables.",
          "graphQueries": [
            {
              "metricName": "Total Activity Audits received",
              "legend": "BeyondTrustPM_ActivityAudits_CL",
              "baseQuery": "BeyondTrustPM_ActivityAudits_CL"
            },
            {
              "metricName": "Total Client Events received",
              "legend": "BeyondTrustPM_ClientEvents_CL",
              "baseQuery": "BeyondTrustPM_ClientEvents_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "BeyondTrustPM_ActivityAudits_CL",
              "lastDataReceivedQuery": "BeyondTrustPM_ActivityAudits_CL\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
            },
            {
              "name": "BeyondTrustPM_ClientEvents_CL",
              "lastDataReceivedQuery": "BeyondTrustPM_ClientEvents_CL\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "BeyondTrustPM_ActivityAudits_CL\n| summarize LastLogReceived = max(TimeGenerated)\n| project IsConnected = LastLogReceived > ago(7d)"
              ]
            },
            {
              "type": "IsConnectedQuery",
              "value": [
                "BeyondTrustPM_ClientEvents_CL\n| summarize LastLogReceived = max(TimeGenerated)\n| project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "All Activity Audits",
              "query": "BeyondTrustPM_ActivityAudits_CL\n| sort by TimeGenerated desc"
            },
            {
              "description": "All Client Events",
              "query": "BeyondTrustPM_ClientEvents_CL\n| sort by TimeGenerated desc"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "BeyondTrust PM Cloud API credentials",
                "description": "BeyondTrust PM Cloud OAuth Client ID and Client Secret are required. Contact BeyondTrust support for API access."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to the BeyondTrust PM Cloud API to pull logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
            },
            {
              "description": ">**NOTE:** This connector uses the OAuth 2.0 client credentials flow to authenticate with the BeyondTrust PM Cloud API."
            },
            {
              "description": "Contact BeyondTrust support to obtain OAuth API credentials (Client ID and Client Secret) for accessing the BeyondTrust PM Cloud API.",
              "title": "STEP 1 - Obtain BeyondTrust PM Cloud API credentials"
            },
            {
              "description": "Use this method for automated deployment of the BeyondTrust PM Cloud data connector using an ARM Template.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FAzure-Sentinel%2Fmaster%2FSolutions%2FBeyondTrustPMCloud%2FData%2520Connectors%2Fazuredeploy_BeyondTrustPMCloud_API_FunctionApp.json)\n2. Select the preferred **Subscription**, **Resource Group**, and **Location**. \n3. Enter the required parameters:\n   - **Workspace ID**: Your Log Analytics Workspace ID\n   - **Workspace Key**: Your Log Analytics Workspace Key\n   - **BeyondTrust Tenant Name**: Your BeyondTrust PM Cloud tenant name\n   - **BeyondTrust Client ID**: OAuth Client ID from Step 1\n   - **BeyondTrust Client Secret**: OAuth Client Secret from Step 1\n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**.\n5. Click **Purchase** to deploy.",
              "title": "STEP 2 - Deploy the connector and the associated Azure Function"
            }
          ],
          "id": "[variables('_uiConfigId1')]"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BeyondTrustPMCloud Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "This workbook provides insights into BeyondTrust Privilege Management Cloud activity audits and client events, helping you monitor and analyze security events in your environment."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"cd8447d9-b096-4673-9613-2a7c1f8f5e3f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":2592000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":2592000000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union BeyondTrustPM_ActivityAudits_CL, BeyondTrustPM_ClientEvents_CL\\n| where TimeGenerated {TimeRange}\\n| summarize Count = count() by Type\\n| extend TableName = case(\\n    Type == \\\"BeyondTrustPM_ActivityAudits_CL\\\", \\\"Activity Audits\\\",\\n    Type == \\\"BeyondTrustPM_ClientEvents_CL\\\", \\\"Client Events\\\",\\n    \\\"Other\\\"\\n  )\\n| project TableName, Count\",\"size\":3,\"title\":\"Event Summary\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"TableName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false}},\"name\":\"event-summary-tiles\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BeyondTrustPM_ActivityAudits_CL\\n| where TimeGenerated {TimeRange}\\n| summarize Count = count() by bin(TimeGenerated, 1h)\\n| render timechart\",\"size\":0,\"title\":\"Activity Audits Over Time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"customWidth\":\"50\",\"name\":\"activity-audits-timechart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BeyondTrustPM_ClientEvents_CL\\n| where TimeGenerated {TimeRange}\\n| summarize Count = count() by bin(TimeGenerated, 1h)\\n| render timechart\",\"size\":0,\"title\":\"Client Events Over Time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"customWidth\":\"50\",\"name\":\"client-events-timechart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BeyondTrustPM_ActivityAudits_CL\\n| where TimeGenerated {TimeRange}\\n| summarize Count = count() by tostring(column_ifexists('ActionType_s', 'Unknown'))\\n| top 10 by Count desc\\n| project ActionType = column1, Count\\n| render barchart\",\"size\":0,\"title\":\"Top Activity Audit Actions\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"top-audit-actions\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BeyondTrustPM_ClientEvents_CL\\n| where TimeGenerated {TimeRange}\\n| summarize Count = count() by tostring(column_ifexists('EventType_s', 'Unknown'))\\n| top 10 by Count desc\\n| project EventType = column1, Count\\n| render barchart\",\"size\":0,\"title\":\"Top Client Event Types\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"top-event-types\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BeyondTrustPM_ActivityAudits_CL\\n| where TimeGenerated {TimeRange}\\n| summarize Count = count() by tostring(column_ifexists('UserName_s', 'Unknown'))\\n| top 10 by Count desc\\n| project User = column1, Activities = Count\",\"size\":0,\"title\":\"Top Users by Activity Audits\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"customWidth\":\"50\",\"name\":\"top-users-audits\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BeyondTrustPM_ClientEvents_CL\\n| where TimeGenerated {TimeRange}\\n| summarize Count = count() by tostring(column_ifexists('HostName_s', 'Unknown'))\\n| top 10 by Count desc\\n| project Host = column1, Events = Count\",\"size\":0,\"title\":\"Top Hosts by Client Events\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"customWidth\":\"50\",\"name\":\"top-hosts-events\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BeyondTrustPM_ActivityAudits_CL\\n| where TimeGenerated {TimeRange}\\n| project TimeGenerated, \\n    ActionType = column_ifexists('ActionType_s', ''),\\n    User = column_ifexists('UserName_s', ''),\\n    Target = column_ifexists('TargetResource_s', ''),\\n    Result = column_ifexists('Result_s', '')\\n| order by TimeGenerated desc\\n| take 50\",\"size\":0,\"title\":\"Recent Activity Audits\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"name\":\"recent-audits-table\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BeyondTrustPM_ClientEvents_CL\\n| where TimeGenerated {TimeRange}\\n| project TimeGenerated,\\n    EventType = column_ifexists('EventType_s', ''),\\n    Host = column_ifexists('HostName_s', ''),\\n    User = column_ifexists('UserName_s', ''),\\n    Process = column_ifexists('ProcessName_s', '')\\n| order by TimeGenerated desc\\n| take 50\",\"size\":0,\"title\":\"Recent Client Events\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"name\":\"recent-events-table\"}],\"fromTemplateId\":\"sentinel-BeyondTrustPMCloudWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=BeyondTrustPMCloudWorkbook; logoFileName=BeyondTrustLogo.svg; description=This workbook provides insights into BeyondTrust Privilege Management Cloud activity audits and client events, helping you monitor and analyze security events in your environment.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=BeyondTrust PM Cloud; templateRelativePath=BeyondTrustPMCloud.json; subtitle=; provider=BeyondTrust}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "BeyondTrustPMCloud",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "BeyondTrust",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "BeyondTrust",
                  "email": "mysupport@beyondtrust.com",
                  "link": "https://www.beyondtrust.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "BeyondTrustPM_ActivityAudits_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "BeyondTrustPM_ClientEvents_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "BeyondTrustPMCloudAPI",
                      "kind": "DataConnector"
                    }
                  ]
                }
              },
              "description": "This workbook provides insights into BeyondTrust Privilege Management Cloud activity audits and client events, helping you monitor and analyze security events in your environment."
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "BeyondTrustPMCloud",
        "publisherDisplayName": "BeyondTrust",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>• Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/BeyondTrustPMCloud/ReleaseNotes.md\">Release Notes</a></p>\n<p>• There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The BeyondTrust PM Cloud solution provides a data connector to ingest activity audit logs and client event logs from BeyondTrust Privilege Management Cloud into Microsoft Sentinel.</p>\n<p><strong>Underlying Microsoft Technologies used:</strong></p>\n<p>This solution takes a dependency on the following technologies, and some of these dependencies either may be in <a href=\"https://azure.microsoft.com/support/legal/preview-supplemental-terms/\">Preview</a> state or might result in additional ingestion or operational costs:</p>\n<ol type=\"a\">\n<li><p><a href=\"https://docs.microsoft.com/azure/azure-monitor/logs/logs-ingestion-api-overview\">Azure Monitor Logs Ingestion API</a></p>\n</li>\n<li><p><a href=\"https://azure.microsoft.com/services/functions/#overview\">Azure Functions</a></p>\n</li>\n</ol>\n<p><strong>Data Connectors:</strong> 1, <strong>Workbooks:</strong> 1</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/jamos-bt/Azure-Sentinel/master/Logos/BeyondTrustLogo.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "BeyondTrustPMCloud",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "BeyondTrust",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "BeyondTrust",
          "email": "mysupport@beyondtrust.com",
          "tier": "Partner",
          "link": "https://www.beyondtrust.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            }
          ]
        },
        "firstPublishDate": "2025-10-31",
        "providers": [
          "BeyondTrust"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection",
            "IT Operations"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
