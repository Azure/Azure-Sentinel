{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
            }
        },
        "workspace-location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Region to deploy solution resources. Defaults to resource group location."
            }
        }
    },
    "variables": {
        "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
        "workspaceName": "[parameters('workspace')]",
        "subscription": "[subscription().subscriptionId]",
        "resourceGroupName": "[resourceGroup().name]",
        "_solutionName": "Microsoft 365 Audit General & DLP",
        "_solutionVersion": "1.0.0",
        "_solutionAuthor": "Marko Lauren",
        "_solutionSupport": "Community",
        "_packageIcon": "\u003cimg src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Microsoft_logo.svg\" width=\"75px\" height=\"75px\"\u003e",
        "_solutionId": "azuresentinel.azure-sentinel-solution-microsoft365auditgeneraldlp",
        "dataConnectorVersionConnectorDefinition": "1.0.0",
        "dataConnectorVersionConnections": "1.0.0",
        "dataConnectorVersionConnectorDefinitionDLP": "1.0.0",
        "dataConnectorVersionConnectionsDLP": "1.0.0",
        "_solutionTier": "Community",
        "_dataConnectorContentIdConnectorDefinition": "M365AuditGeneralCCPDefinition",
        "dataConnectorTemplateNameConnectorDefinition": "[concat(variables('workspaceName'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition')))]",
        "_dataConnectorContentIdConnections": "M365AuditGeneralCCPConnections",
        "dataConnectorTemplateNameConnections": "[concat(variables('workspaceName'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections')))]",
        "_dataConnectorContentIdConnectorDefinitionDLP": "M365AuditDLPCCPDefinition",
        "dataConnectorTemplateNameConnectorDefinitionDLP": "[concat(variables('workspaceName'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinitionDLP')))]",
        "_dataConnectorContentIdConnectionsDLP": "M365AuditDLPCCPConnections",
        "dataConnectorTemplateNameConnectionsDLP": "[concat(variables('workspaceName'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectionsDLP')))]",
        "_logAnalyticsTableId1": "M365AuditGeneral_CL",
        "dataCollectionRuleName": "[concat('dcr-', parameters('workspace'), '-m365auditgeneral')]",
        "dataCollectionEndpointName": "[concat('dce-', parameters('workspace'), '-m365auditgeneral')]"
    },
    "resources": [
        {
            "name": "[variables('dataCollectionEndpointName')]",
            "apiVersion": "2022-06-01",
            "type": "Microsoft.Insights/dataCollectionEndpoints",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "networkAcls": {
                    "publicNetworkAccess": "Enabled"
                }
            }
        },
        {
            "name": "[variables('dataCollectionRuleName')]",
            "apiVersion": "2022-06-01",
            "type": "Microsoft.Insights/dataCollectionRules",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dataCollectionEndpointName'))]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/tables', variables('workspaceName'), variables('_logAnalyticsTableId1'))]"
            ],
            "properties": {
                "dataCollectionEndpointId": "[concat('/subscriptions/',variables('subscription'),'/resourceGroups/',variables('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',variables('dataCollectionEndpointName'))]",
                "streamDeclarations": {
                    "Custom-M365AuditGeneralInput": {
                        "columns": [
                            {
                                "name": "TimeGenerated",
                                "type": "datetime"
                            },
                            {
                                "name": "Id",
                                "type": "string"
                            },
                            {
                                "name": "RecordType",
                                "type": "int"
                            },
                            {
                                "name": "CreationTime",
                                "type": "datetime"
                            },
                            {
                                "name": "Operation",
                                "type": "string"
                            },
                            {
                                "name": "OrganizationId",
                                "type": "string"
                            },
                            {
                                "name": "UserType",
                                "type": "int"
                            },
                            {
                                "name": "UserKey",
                                "type": "string"
                            },
                            {
                                "name": "Workload",
                                "type": "string"
                            },
                            {
                                "name": "ResultStatus",
                                "type": "string"
                            },
                            {
                                "name": "ObjectId",
                                "type": "string"
                            },
                            {
                                "name": "UserId",
                                "type": "string"
                            },
                            {
                                "name": "ClientIP",
                                "type": "string"
                            },
                            {
                                "name": "Scope",
                                "type": "string"
                            },
                            {
                                "name": "CopilotEventData",
                                "type": "dynamic"
                            },
                            {
                                "name": "AgentID",
                                "type": "string"
                            },
                            {
                                "name": "AgentName",
                                "type": "string"
                            },
                            {
                                "name": "AgentType",
                                "type": "int"
                            },
                            {
                                "name": "UserAssignments",
                                "type": "dynamic"
                            },
                            {
                                "name": "ForAllUsers",
                                "type": "boolean"
                            },
                            {
                                "name": "Property",
                                "type": "string"
                            },
                            {
                                "name": "RemovedIdentities",
                                "type": "dynamic"
                            },
                            {
                                "name": "AddedIdentities",
                                "type": "dynamic"
                            },
                            {
                                "name": "NewValue",
                                "type": "string"
                            },
                            {
                                "name": "OldValue",
                                "type": "string"
                            },
                            {
                                "name": "Entity",
                                "type": "string"
                            },
                            {
                                "name": "Action",
                                "type": "string"
                            },
                            {
                                "name": "OnBehalfOfResId",
                                "type": "string"
                            },
                            {
                                "name": "CaseId",
                                "type": "string"
                            },
                            {
                                "name": "CaseName",
                                "type": "string"
                            },
                            {
                                "name": "Object1Id",
                                "type": "string"
                            },
                            {
                                "name": "Object1Name",
                                "type": "string"
                            },
                            {
                                "name": "Object1Type",
                                "type": "string"
                            },
                            {
                                "name": "Object2Id",
                                "type": "string"
                            },
                            {
                                "name": "Object2Name",
                                "type": "string"
                            },
                            {
                                "name": "Object2Type",
                                "type": "string"
                            },
                            {
                                "name": "StartTime",
                                "type": "datetime"
                            },
                            {
                                "name": "EndTime",
                                "type": "datetime"
                            },
                            {
                                "name": "UserCancelled",
                                "type": "boolean"
                            },
                            {
                                "name": "ItemIds",
                                "type": "dynamic"
                            },
                            {
                                "name": "ItemNames",
                                "type": "dynamic"
                            },
                            {
                                "name": "DataSources",
                                "type": "dynamic"
                            },
                            {
                                "name": "QueryId",
                                "type": "string"
                            },
                            {
                                "name": "QueryText",
                                "type": "string"
                            },
                            {
                                "name": "QueryFiles",
                                "type": "dynamic"
                            },
                            {
                                "name": "Settings",
                                "type": "dynamic"
                            },
                            {
                                "name": "ExtendedProperties",
                                "type": "dynamic"
                            },
                            {
                                "name": "ExportName",
                                "type": "string"
                            },
                            {
                                "name": "JobId",
                                "type": "string"
                            },
                            {
                                "name": "RecordNumber",
                                "type": "string"
                            },
                            {
                                "name": "ClientRequestId",
                                "type": "string"
                            },
                            {
                                "name": "CmdletVersion",
                                "type": "string"
                            },
                            {
                                "name": "EffectiveOrganization",
                                "type": "string"
                            },
                            {
                                "name": "UserServicePlan",
                                "type": "string"
                            },
                            {
                                "name": "ClientApplication",
                                "type": "string"
                            },
                            {
                                "name": "Parameters",
                                "type": "string"
                            },
                            {
                                "name": "NonPiiParameters",
                                "type": "string"
                            },
                            {
                                "name": "AlertId",
                                "type": "string"
                            },
                            {
                                "name": "AlertType",
                                "type": "string"
                            },
                            {
                                "name": "Name",
                                "type": "string"
                            },
                            {
                                "name": "PolicyId",
                                "type": "string"
                            },
                            {
                                "name": "Status",
                                "type": "string"
                            },
                            {
                                "name": "Severity",
                                "type": "string"
                            },
                            {
                                "name": "Category",
                                "type": "string"
                            },
                            {
                                "name": "Source",
                                "type": "string"
                            },
                            {
                                "name": "Comments",
                                "type": "string"
                            },
                            {
                                "name": "Data",
                                "type": "string"
                            },
                            {
                                "name": "AlertEntityId",
                                "type": "string"
                            },
                            {
                                "name": "EntityType",
                                "type": "string"
                            },
                            {
                                "name": "ActorUserId",
                                "type": "string"
                            },
                            {
                                "name": "ActorYammerUserId",
                                "type": "long"
                            },
                            {
                                "name": "DataExportType",
                                "type": "string"
                            },
                            {
                                "name": "FileId",
                                "type": "long"
                            },
                            {
                                "name": "FileName",
                                "type": "string"
                            },
                            {
                                "name": "GroupName",
                                "type": "string"
                            },
                            {
                                "name": "IsSoftDelete",
                                "type": "boolean"
                            },
                            {
                                "name": "MeetingId",
                                "type": "string"
                            },
                            {
                                "name": "MessageId",
                                "type": "long"
                            },
                            {
                                "name": "ModifiedProperties",
                                "type": "dynamic"
                            },
                            {
                                "name": "YammerNetworkId",
                                "type": "long"
                            },
                            {
                                "name": "TargetObjectId",
                                "type": "string"
                            },
                            {
                                "name": "TargetUserId",
                                "type": "string"
                            },
                            {
                                "name": "TargetYammerUserId",
                                "type": "long"
                            },
                            {
                                "name": "ThreadId",
                                "type": "long"
                            },
                            {
                                "name": "VersionId",
                                "type": "long"
                            },
                            {
                                "name": "AttachmentData",
                                "type": "dynamic"
                            },
                            {
                                "name": "DetectionType",
                                "type": "string"
                            },
                            {
                                "name": "DetectionMethod",
                                "type": "string"
                            },
                            {
                                "name": "InternetMessageId",
                                "type": "string"
                            },
                            {
                                "name": "NetworkMessageId",
                                "type": "string"
                            },
                            {
                                "name": "P1Sender",
                                "type": "string"
                            },
                            {
                                "name": "P2Sender",
                                "type": "string"
                            },
                            {
                                "name": "Policy",
                                "type": "string"
                            },
                            {
                                "name": "Recipients",
                                "type": "dynamic"
                            },
                            {
                                "name": "SenderIp",
                                "type": "string"
                            },
                            {
                                "name": "Subject",
                                "type": "string"
                            },
                            {
                                "name": "Verdict",
                                "type": "string"
                            },
                            {
                                "name": "MessageTime",
                                "type": "datetime"
                            },
                            {
                                "name": "EventDeepLink",
                                "type": "string"
                            },
                            {
                                "name": "DeliveryAction",
                                "type": "string"
                            },
                            {
                                "name": "OriginalDeliverylocation",
                                "type": "string"
                            },
                            {
                                "name": "LatestDeliverylocation",
                                "type": "string"
                            },
                            {
                                "name": "Directionality",
                                "type": "string"
                            },
                            {
                                "name": "ThreatsAndDetectionTech",
                                "type": "string"
                            },
                            {
                                "name": "AdditionalActionsAndResults",
                                "type": "dynamic"
                            },
                            {
                                "name": "Connectors",
                                "type": "string"
                            },
                            {
                                "name": "AuthDetails",
                                "type": "dynamic"
                            },
                            {
                                "name": "SystemOverrides",
                                "type": "dynamic"
                            },
                            {
                                "name": "PhishConfidenceLevel",
                                "type": "string"
                            },
                            {
                                "name": "BatchID",
                                "type": "string"
                            },
                            {
                                "name": "CampaignID",
                                "type": "string"
                            },
                            {
                                "name": "UserDisplayName",
                                "type": "string"
                            },
                            {
                                "name": "AttackTechnique",
                                "type": "string"
                            },
                            {
                                "name": "CampaignType",
                                "type": "string"
                            },
                            {
                                "name": "TimeData",
                                "type": "datetime"
                            },
                            {
                                "name": "EndTimeData",
                                "type": "datetime"
                            },
                            {
                                "name": "AttackSimEvent",
                                "type": "string"
                            },
                            {
                                "name": "AttackSimAdminEvent",
                                "type": "string"
                            },
                            {
                                "name": "CourseID",
                                "type": "string"
                            },
                            {
                                "name": "UserTrainingEvent",
                                "type": "string"
                            },
                            {
                                "name": "AdminSubmissionRegistered",
                                "type": "string"
                            },
                            {
                                "name": "AdminSubmissionDeliveryCheck",
                                "type": "string"
                            },
                            {
                                "name": "AdminSubmissionSubmitting",
                                "type": "string"
                            },
                            {
                                "name": "AdminSubmissionSubmitted",
                                "type": "string"
                            },
                            {
                                "name": "AdminSubmissionTriage",
                                "type": "string"
                            },
                            {
                                "name": "AdminSubmissionTimeout",
                                "type": "string"
                            },
                            {
                                "name": "UserSubmission",
                                "type": "string"
                            },
                            {
                                "name": "UserSubmissionTriage",
                                "type": "string"
                            },
                            {
                                "name": "CustomSubmission",
                                "type": "string"
                            },
                            {
                                "name": "AttackSimUserSubmission",
                                "type": "string"
                            },
                            {
                                "name": "AdminSubmissionTablAllow",
                                "type": "string"
                            },
                            {
                                "name": "SubmissionNotification",
                                "type": "string"
                            },
                            {
                                "name": "InvestigationId",
                                "type": "string"
                            },
                            {
                                "name": "InvestigationName",
                                "type": "string"
                            },
                            {
                                "name": "InvestigationType",
                                "type": "string"
                            },
                            {
                                "name": "LastUpdateTimeUtc",
                                "type": "datetime"
                            },
                            {
                                "name": "StartTimeUtc",
                                "type": "datetime"
                            },
                            {
                                "name": "DeeplinkURL",
                                "type": "string"
                            },
                            {
                                "name": "Actions",
                                "type": "dynamic"
                            },
                            {
                                "name": "ActionType",
                                "type": "string"
                            },
                            {
                                "name": "ActionStatus",
                                "type": "string"
                            },
                            {
                                "name": "ApprovedBy",
                                "type": "string"
                            },
                            {
                                "name": "TimestampUtc",
                                "type": "datetime"
                            },
                            {
                                "name": "ActionId",
                                "type": "string"
                            },
                            {
                                "name": "RelatedAlertIds",
                                "type": "dynamic"
                            },
                            {
                                "name": "EndTimeUtc",
                                "type": "datetime"
                            },
                            {
                                "name": "ResourceIdentifiers",
                                "type": "string"
                            },
                            {
                                "name": "Entities",
                                "type": "dynamic"
                            },
                            {
                                "name": "Audit",
                                "type": "string"
                            },
                            {
                                "name": "Event",
                                "type": "string"
                            },
                            {
                                "name": "EventId",
                                "type": "long"
                            },
                            {
                                "name": "EventValue",
                                "type": "string"
                            },
                            {
                                "name": "Reason",
                                "type": "string"
                            },
                            {
                                "name": "AppName",
                                "type": "string"
                            },
                            {
                                "name": "DashboardName",
                                "type": "string"
                            },
                            {
                                "name": "DataClassification",
                                "type": "string"
                            },
                            {
                                "name": "DatasetName",
                                "type": "string"
                            },
                            {
                                "name": "MembershipInformation",
                                "type": "dynamic"
                            },
                            {
                                "name": "OrgAppPermission",
                                "type": "string"
                            },
                            {
                                "name": "ReportName",
                                "type": "string"
                            },
                            {
                                "name": "SharingInformation",
                                "type": "dynamic"
                            },
                            {
                                "name": "SwitchState",
                                "type": "string"
                            },
                            {
                                "name": "WorkSpaceName",
                                "type": "string"
                            },
                            {
                                "name": "WpaUserRole",
                                "type": "string"
                            },
                            {
                                "name": "OperationDetails",
                                "type": "dynamic"
                            },
                            {
                                "name": "RequestType",
                                "type": "string"
                            },
                            {
                                "name": "RequestSource",
                                "type": "string"
                            },
                            {
                                "name": "ReleaseTo",
                                "type": "string"
                            },
                            {
                                "name": "FormsUserTypes",
                                "type": "dynamic"
                            },
                            {
                                "name": "SourceApp",
                                "type": "string"
                            },
                            {
                                "name": "FormName",
                                "type": "string"
                            },
                            {
                                "name": "FormId",
                                "type": "string"
                            },
                            {
                                "name": "FormTypes",
                                "type": "dynamic"
                            },
                            {
                                "name": "ActivityParameters",
                                "type": "string"
                            },
                            {
                                "name": "Sender",
                                "type": "string"
                            },
                            {
                                "name": "Receivers",
                                "type": "dynamic"
                            },
                            {
                                "name": "ItemName",
                                "type": "string"
                            },
                            {
                                "name": "LabelId",
                                "type": "string"
                            },
                            {
                                "name": "LabelName",
                                "type": "string"
                            },
                            {
                                "name": "LabelAction",
                                "type": "string"
                            },
                            {
                                "name": "LabelAppliedDateTime",
                                "type": "datetime"
                            },
                            {
                                "name": "ApplicationMode",
                                "type": "string"
                            },
                            {
                                "name": "Recipient",
                                "type": "string"
                            },
                            {
                                "name": "AuthenticationMethod",
                                "type": "string"
                            },
                            {
                                "name": "AuthenticationStatus",
                                "type": "string"
                            },
                            {
                                "name": "OperationStatus",
                                "type": "string"
                            },
                            {
                                "name": "AttachmentName",
                                "type": "string"
                            },
                            {
                                "name": "OperationProperties",
                                "type": "dynamic"
                            },
                            {
                                "name": "TaskId",
                                "type": "string"
                            },
                            {
                                "name": "ItemId",
                                "type": "string"
                            },
                            {
                                "name": "ItemSize",
                                "type": "long"
                            },
                            {
                                "name": "SourceUserId",
                                "type": "string"
                            },
                            {
                                "name": "FailureType",
                                "type": "string"
                            },
                            {
                                "name": "ResultMessage",
                                "type": "string"
                            },
                            {
                                "name": "IsRetry",
                                "type": "boolean"
                            },
                            {
                                "name": "Attachments",
                                "type": "dynamic"
                            },
                            {
                                "name": "DataStoreType",
                                "type": "string"
                            },
                            {
                                "name": "UserAction",
                                "type": "string"
                            },
                            {
                                "name": "ExportTriggeredAt",
                                "type": "datetime"
                            },
                            {
                                "name": "NameOfDownloadedZipFile",
                                "type": "string"
                            },
                            {
                                "name": "Invitation",
                                "type": "string"
                            },
                            {
                                "name": "ClientUUID",
                                "type": "string"
                            },
                            {
                                "name": "ImportType",
                                "type": "string"
                            },
                            {
                                "name": "DataDSRControl",
                                "type": "string"
                            },
                            {
                                "name": "DiscardEmployeeIds",
                                "type": "string"
                            },
                            {
                                "name": "ExtendedCompletionDate",
                                "type": "datetime"
                            },
                            {
                                "name": "FeedBackComponentName",
                                "type": "string"
                            },
                            {
                                "name": "Detail",
                                "type": "string"
                            },
                            {
                                "name": "Username",
                                "type": "string"
                            },
                            {
                                "name": "UserRole",
                                "type": "string"
                            },
                            {
                                "name": "OrganizationName",
                                "type": "string"
                            },
                            {
                                "name": "OrganizationOwner",
                                "type": "string"
                            },
                            {
                                "name": "OrganizationAdmins",
                                "type": "dynamic"
                            },
                            {
                                "name": "UserAgent",
                                "type": "string"
                            },
                            {
                                "name": "ModifiedFields",
                                "type": "dynamic"
                            },
                            {
                                "name": "ItemDetails",
                                "type": "dynamic"
                            },
                            {
                                "name": "EditMethodology",
                                "type": "string"
                            },
                            {
                                "name": "CountOfArtifactsBeingAdded",
                                "type": "int"
                            },
                            {
                                "name": "CountOfArtifactsBeingRemoved",
                                "type": "int"
                            },
                            {
                                "name": "ServiceType",
                                "type": "string"
                            },
                            {
                                "name": "CreationMethodology",
                                "type": "string"
                            },
                            {
                                "name": "RestoreTime",
                                "type": "datetime"
                            },
                            {
                                "name": "RestoreLocationType",
                                "type": "string"
                            },
                            {
                                "name": "RestoreLocation",
                                "type": "string"
                            },
                            {
                                "name": "BackupItemID",
                                "type": "string"
                            },
                            {
                                "name": "ProtectionUnitID",
                                "type": "string"
                            },
                            {
                                "name": "SuccessStatus",
                                "type": "string"
                            },
                            {
                                "name": "BackupItemType",
                                "type": "string"
                            },
                            {
                                "name": "URLPath",
                                "type": "string"
                            },
                            {
                                "name": "DomainURL",
                                "type": "string"
                            },
                            {
                                "name": "ScenarioType",
                                "type": "string"
                            },
                            {
                                "name": "PromptText",
                                "type": "string"
                            },
                            {
                                "name": "AutomationId",
                                "type": "string"
                            },
                            {
                                "name": "TriggerMode",
                                "type": "string"
                            },
                            {
                                "name": "PlaceType",
                                "type": "string"
                            },
                            {
                                "name": "EventTime",
                                "type": "datetime"
                            },
                            {
                                "name": "Compute",
                                "type": "string"
                            },
                            {
                                "name": "DatabaseName",
                                "type": "dynamic"
                            },
                            {
                                "name": "TableName",
                                "type": "string"
                            },
                            {
                                "name": "SessionDurationInSecs",
                                "type": "string"
                            },
                            {
                                "name": "SessionStartTime",
                                "type": "datetime"
                            },
                            {
                                "name": "SessionEndTime",
                                "type": "datetime"
                            },
                            {
                                "name": "KernalId",
                                "type": "string"
                            },
                            {
                                "name": "SessionId",
                                "type": "string"
                            },
                            {
                                "name": "Interface",
                                "type": "string"
                            },
                            {
                                "name": "JobType",
                                "type": "string"
                            },
                            {
                                "name": "JobName",
                                "type": "string"
                            },
                            {
                                "name": "Schedule",
                                "type": "string"
                            },
                            {
                                "name": "RunID",
                                "type": "string"
                            },
                            {
                                "name": "JobRunStatus",
                                "type": "string"
                            },
                            {
                                "name": "Logs",
                                "type": "string"
                            },
                            {
                                "name": "JobExecutionDurationInSecs",
                                "type": "long"
                            },
                            {
                                "name": "JobTotalDurationInSecs",
                                "type": "long"
                            },
                            {
                                "name": "JobStartTime",
                                "type": "datetime"
                            },
                            {
                                "name": "JobEndTime",
                                "type": "datetime"
                            },
                            {
                                "name": "DatabasesRead",
                                "type": "dynamic"
                            },
                            {
                                "name": "DatabasesWrite",
                                "type": "dynamic"
                            },
                            {
                                "name": "TablesRead",
                                "type": "dynamic"
                            },
                            {
                                "name": "TablesWrite",
                                "type": "dynamic"
                            },
                            {
                                "name": "Query",
                                "type": "string"
                            },
                            {
                                "name": "ResultTableCount",
                                "type": "long"
                            },
                            {
                                "name": "QueryResponse",
                                "type": "string"
                            },
                            {
                                "name": "TotalRows",
                                "type": "dynamic"
                            },
                            {
                                "name": "ComponentFault",
                                "type": "string"
                            },
                            {
                                "name": "FailureReason",
                                "type": "string"
                            },
                            {
                                "name": "ExecutionDuration",
                                "type": "long"
                            },
                            {
                                "name": "TotalCPU",
                                "type": "long"
                            },
                            {
                                "name": "MemoryPeak",
                                "type": "long"
                            },
                            {
                                "name": "BillingAzureSubscriptionId",
                                "type": "string"
                            },
                            {
                                "name": "BillingAzureResourceGroupName",
                                "type": "string"
                            },
                            {
                                "name": "ProvisioningStatus",
                                "type": "string"
                            },
                            {
                                "name": "DataOnboardingAtSetup",
                                "type": "string"
                            },
                            {
                                "name": "Tables",
                                "type": "dynamic"
                            },
                            {
                                "name": "SubscriptionsEnabled",
                                "type": "dynamic"
                            },
                            {
                                "name": "DataOnboardingStatus",
                                "type": "string"
                            },
                            {
                                "name": "EventOccurenceTime",
                                "type": "datetime"
                            },
                            {
                                "name": "ToolID",
                                "type": "string"
                            },
                            {
                                "name": "ToolName",
                                "type": "string"
                            },
                            {
                                "name": "InputParameters",
                                "type": "string"
                            },
                            {
                                "name": "APIsCalled",
                                "type": "dynamic"
                            },
                            {
                                "name": "DataScanned",
                                "type": "long"
                            },
                            {
                                "name": "TotalCpuHours",
                                "type": "long"
                            },
                            {
                                "name": "TotalSCUHours",
                                "type": "long"
                            },
                            {
                                "name": "GraphName",
                                "type": "string"
                            },
                            {
                                "name": "OperationInput",
                                "type": "string"
                            },
                            {
                                "name": "GraphQueryStats",
                                "type": "string"
                            },
                            {
                                "name": "GraphQueryStatus",
                                "type": "string"
                            },
                            {
                                "name": "DataCenterSecurityEventType",
                                "type": "string"
                            },
                            {
                                "name": "ElevationTime",
                                "type": "datetime"
                            },
                            {
                                "name": "ElevationApprover",
                                "type": "string"
                            },
                            {
                                "name": "ElevationApprovedTime",
                                "type": "datetime"
                            },
                            {
                                "name": "ElevationRequestId",
                                "type": "string"
                            },
                            {
                                "name": "ElevationRole",
                                "type": "string"
                            },
                            {
                                "name": "ElevationDuration",
                                "type": "int"
                            },
                            {
                                "name": "GenericInfo",
                                "type": "string"
                            },
                            {
                                "name": "EventName",
                                "type": "string"
                            },
                            {
                                "name": "PulseId",
                                "type": "string"
                            },
                            {
                                "name": "EventDetails",
                                "type": "dynamic"
                            },
                            {
                                "name": "SharePointMetaData",
                                "type": "dynamic"
                            },
                            {
                                "name": "ExchangeMetaData",
                                "type": "dynamic"
                            },
                            {
                                "name": "EndpointMetaData",
                                "type": "dynamic"
                            },
                            {
                                "name": "ExceptionInfo",
                                "type": "string"
                            },
                            {
                                "name": "PolicyDetails",
                                "type": "dynamic"
                            },
                            {
                                "name": "SensitiveInfoDetectionIsIncluded",
                                "type": "boolean"
                            }
                        ]
                    }
                },
                "destinations": {
                    "logAnalytics": [
                        {
                            "workspaceResourceId": "[variables('workspaceResourceId')]",
                            "name": "clv2ws1"
                        }
                    ]
                },
                "dataFlows": [
                    {
                        "streams": [
                            "Custom-M365AuditGeneralInput"
                        ],
                        "destinations": [
                            "clv2ws1"
                        ],
                        "transformKql": "source | where RecordType != 21 and RecordType != 278 and RecordType != 25 and RecordType != 71 and RecordType != 72 and RecordType != 75 and RecordType != 82 and RecordType != 83 and RecordType != 84 and RecordType != 93 and RecordType != 94 and RecordType != 95 and RecordType != 96 and RecordType != 97",
                        "outputStream": "Custom-M365AuditGeneral_CL"
                    }
                ]
            }
        },
        {
            "name": "[concat(variables('workspaceName'),'/', variables('_logAnalyticsTableId1'))]",
            "apiVersion": "2022-10-01",
            "type": "Microsoft.OperationalInsights/workspaces/tables",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "schema": {
                    "name": "[variables('_logAnalyticsTableId1')]",
                    "columns": [
                        {
                            "name": "TimeGenerated",
                            "type": "datetime",
                            "description": "The time when the event was generated"
                        },
                        {
                            "name": "Id",
                            "type": "string",
                            "description": "Unique identifier for the audit record"
                        },
                        {
                            "name": "RecordType",
                            "type": "int",
                            "description": "The type of operation indicated by the record"
                        },
                        {
                            "name": "CreationTime",
                            "type": "datetime",
                            "description": "The date and time in UTC when the user performed the activity"
                        },
                        {
                            "name": "Operation",
                            "type": "string",
                            "description": "The name of the user or admin activity"
                        },
                        {
                            "name": "OrganizationId",
                            "type": "string",
                            "description": "The GUID for your organization's Microsoft 365 tenant"
                        },
                        {
                            "name": "UserType",
                            "type": "int",
                            "description": "The type of user that performed the operation"
                        },
                        {
                            "name": "UserKey",
                            "type": "string",
                            "description": "An alternative ID for the user identified in the UserId property"
                        },
                        {
                            "name": "Workload",
                            "type": "string",
                            "description": "The Microsoft 365 service where the activity occurred"
                        },
                        {
                            "name": "ResultStatus",
                            "type": "string",
                            "description": "Indicates whether the action was successful or not"
                        },
                        {
                            "name": "ObjectId",
                            "type": "string",
                            "description": "The name of the object that was modified by the activity"
                        },
                        {
                            "name": "UserId",
                            "type": "string",
                            "description": "The UPN of the user who performed the action"
                        },
                        {
                            "name": "ClientIP",
                            "type": "string",
                            "description": "The IP address of the device that was used when the activity was logged"
                        },
                        {
                            "name": "Scope",
                            "type": "string",
                            "description": "Was this event created by a hosted Microsoft 365 service or an on-premises server"
                        },
                        {
                            "name": "CopilotEventData",
                            "type": "dynamic",
                            "description": "Copilot-specific event data including AI system plugins, accessed resources, messages, and model transparency details"
                        },
                        {
                            "name": "AgentID",
                            "type": "string",
                            "description": "Unique identifier of the Agent"
                        },
                        {
                            "name": "AgentName",
                            "type": "string",
                            "description": "The name of the Agent"
                        },
                        {
                            "name": "AgentType",
                            "type": "int",
                            "description": "The type of the Agent - Microsoft (1P), External (3P), Shared by users (Shared), Built by your org (External)"
                        },
                        {
                            "name": "UserAssignments",
                            "type": "dynamic",
                            "description": "Collection of GUID of Users and Groups associated with the agent activity"
                        },
                        {
                            "name": "ForAllUsers",
                            "type": "boolean",
                            "description": "Whether the activity associated with the agent was captured for the entire organization or not"
                        },
                        {
                            "name": "Property",
                            "type": "string",
                            "description": "The tenant wide setting name that was updated by the admin"
                        },
                        {
                            "name": "RemovedIdentities",
                            "type": "dynamic",
                            "description": "Collection of GUID of Users or Groups that were removed"
                        },
                        {
                            "name": "AddedIdentities",
                            "type": "dynamic",
                            "description": "Collection of GUID of Users or Groups that were added"
                        },
                        {
                            "name": "NewValue",
                            "type": "string",
                            "description": "The new value of the setting"
                        },
                        {
                            "name": "OldValue",
                            "type": "string",
                            "description": "The old value or the new setting"
                        },
                        {
                            "name": "Entity",
                            "type": "string",
                            "description": "ProjectEntity the audit was for"
                        },
                        {
                            "name": "Action",
                            "type": "string",
                            "description": "ProjectAction that was taken"
                        },
                        {
                            "name": "OnBehalfOfResId",
                            "type": "string",
                            "description": "The resource Id the action was taken on behalf of"
                        },
                        {
                            "name": "CaseId",
                            "type": "string",
                            "description": "The identity (GUID) of the eDiscovery case"
                        },
                        {
                            "name": "CaseName",
                            "type": "string",
                            "description": "The name of the eDiscovery case"
                        },
                        {
                            "name": "Object1Id",
                            "type": "string",
                            "description": "The ID of the object (for example, a search, hold, or review set) that was created, accessed, or changed"
                        },
                        {
                            "name": "Object1Name",
                            "type": "string",
                            "description": "The name of the object (for example, a search, hold or review set) that was created, accessed, or changed"
                        },
                        {
                            "name": "Object1Type",
                            "type": "string",
                            "description": "The type of the eDiscovery object that the user created, deleted, or modified"
                        },
                        {
                            "name": "Object2Id",
                            "type": "string",
                            "description": "The ID of the object (for example, a search, hold, or review set) that was created, accessed, or changed"
                        },
                        {
                            "name": "Object2Name",
                            "type": "string",
                            "description": "The name of the object (for example, a search, hold or review set) that was created, accessed, or changed"
                        },
                        {
                            "name": "Object2Type",
                            "type": "string",
                            "description": "The type of the eDiscovery object that the user created, deleted, or modified"
                        },
                        {
                            "name": "StartTime",
                            "type": "datetime",
                            "description": "The date and time in Coordinated Universal Time (UTC) when the eDiscovery activity was started"
                        },
                        {
                            "name": "EndTime",
                            "type": "datetime",
                            "description": "The date and time in Coordinated Universal Time (UTC) when the eDiscovery activity was ended"
                        },
                        {
                            "name": "UserCancelled",
                            "type": "boolean",
                            "description": "Whether the specific activity was cancelled by the user"
                        },
                        {
                            "name": "ItemIds",
                            "type": "dynamic",
                            "description": "Item IDs associated with the activity"
                        },
                        {
                            "name": "ItemNames",
                            "type": "dynamic",
                            "description": "Item names associated with the activity"
                        },
                        {
                            "name": "DataSources",
                            "type": "dynamic",
                            "description": "A list of source IDs, source names and locations associated to the activity"
                        },
                        {
                            "name": "QueryId",
                            "type": "string",
                            "description": "The ID of the query associated with the activity"
                        },
                        {
                            "name": "QueryText",
                            "type": "string",
                            "description": "The query text associated with the activity, such as a search statistic process or add to review process"
                        },
                        {
                            "name": "QueryFiles",
                            "type": "dynamic",
                            "description": "Input file names used to generate the query. This is specific to the search by file gesture"
                        },
                        {
                            "name": "Settings",
                            "type": "dynamic",
                            "description": "Settings applied to the eDiscovery activity"
                        },
                        {
                            "name": "ExtendedProperties",
                            "type": "dynamic",
                            "description": "Additional properties related to the eDiscovery activity"
                        },
                        {
                            "name": "ExportName",
                            "type": "string",
                            "description": "Name of the eDiscovery export"
                        },
                        {
                            "name": "JobId",
                            "type": "string",
                            "description": "The GUID of the eDiscovery process"
                        },
                        {
                            "name": "RecordNumber",
                            "type": "string",
                            "description": "Used when an audit record is divided into multiple parts due to size. It indicates the sequence of each part within the total splits"
                        },
                        {
                            "name": "ClientRequestId",
                            "type": "string",
                            "description": "A GUID that can be used to correlate this cmdlet with portal operations. This information is used only by Microsoft support"
                        },
                        {
                            "name": "CmdletVersion",
                            "type": "string",
                            "description": "The build version of the cmdlet when it was run"
                        },
                        {
                            "name": "EffectiveOrganization",
                            "type": "string",
                            "description": "The GUID for the organization impacted by the cmdlet. (Deprecated: This parameter will eventually stop appearing.)"
                        },
                        {
                            "name": "UserServicePlan",
                            "type": "string",
                            "description": "The service plan assigned to the user who ran the cmdlet"
                        },
                        {
                            "name": "ClientApplication",
                            "type": "string",
                            "description": "If the cmdlet was run by an application, as opposed to remote PowerShell, this field contains the application name"
                        },
                        {
                            "name": "Parameters",
                            "type": "string",
                            "description": "The name and value for parameters that were used with the cmdlet that do not include personal data"
                        },
                        {
                            "name": "NonPiiParameters",
                            "type": "string",
                            "description": "The name and value for parameters that were used with the cmdlet that include personal data. (Deprecated: This field will eventually stop appearing and its content will be merged with the Parameters field.)"
                        },
                        {
                            "name": "AlertId",
                            "type": "string",
                            "description": "The Guid of the alert"
                        },
                        {
                            "name": "AlertType",
                            "type": "string",
                            "description": "Type of the alert. Alert types include: System, Custom"
                        },
                        {
                            "name": "Name",
                            "type": "string",
                            "description": "Name of the alert"
                        },
                        {
                            "name": "PolicyId",
                            "type": "string",
                            "description": "The Guid of the policy that triggered the alert"
                        },
                        {
                            "name": "Status",
                            "type": "string",
                            "description": "Status of the alert. Statuses include: Active, Investigating, Resolved, Dismissed"
                        },
                        {
                            "name": "Severity",
                            "type": "string",
                            "description": "Severity of the alert. Severity levels include: Low, Medium, High"
                        },
                        {
                            "name": "Category",
                            "type": "string",
                            "description": "Category of the alert. Categories include: AccessGovernance, DataGovernance, DataLossPrevention, InsiderRiskManagement, MailFlow, ThreatManagement, Other"
                        },
                        {
                            "name": "Source",
                            "type": "string",
                            "description": "Source of the alert. Sources include: Office 365 Security & Compliance, Cloud App Security"
                        },
                        {
                            "name": "Comments",
                            "type": "string",
                            "description": "Comments left by the users who have viewed the alert. By default, it's 'New alert'"
                        },
                        {
                            "name": "Data",
                            "type": "string",
                            "description": "The detailed data blob of the alert or alert entity"
                        },
                        {
                            "name": "AlertEntityId",
                            "type": "string",
                            "description": "The identifier for the alert entity. This parameter is only applicable to AlertEntityGenerated events"
                        },
                        {
                            "name": "EntityType",
                            "type": "string",
                            "description": "Type of the alert or alert entity. Entity types include: User, Recipients, Sender, MalwareFamily"
                        },
                        {
                            "name": "ActorUserId",
                            "type": "string",
                            "description": "Email of user that performed the operation"
                        },
                        {
                            "name": "ActorYammerUserId",
                            "type": "long",
                            "description": "ID of user that performed the operation"
                        },
                        {
                            "name": "DataExportType",
                            "type": "string",
                            "description": "Returns 'data' if data export includes messages, notes, files, topics, users and groups; returns 'user' if data export includes users only"
                        },
                        {
                            "name": "FileId",
                            "type": "long",
                            "description": "ID of the file in the operation"
                        },
                        {
                            "name": "FileName",
                            "type": "string",
                            "description": "Name of the file in the operation. Appears blank if not relevant to the operation"
                        },
                        {
                            "name": "GroupName",
                            "type": "string",
                            "description": "Name of the group in the operation. Appears blank if not relevant to the operation"
                        },
                        {
                            "name": "IsSoftDelete",
                            "type": "boolean",
                            "description": "Returns 'true' if the network's data retention policy is set to Soft Delete; returns 'false' if the network's data retention policy is set to Hard Delete"
                        },
                        {
                            "name": "MeetingId",
                            "type": "string",
                            "description": "The ID of the event/teams meeting in the operation"
                        },
                        {
                            "name": "MessageId",
                            "type": "long",
                            "description": "ID of the message in the operation"
                        },
                        {
                            "name": "ModifiedProperties",
                            "type": "dynamic",
                            "description": "Includes the name of the property that was modified, the new value of the modified object and the previous value of the modified object"
                        },
                        {
                            "name": "YammerNetworkId",
                            "type": "long",
                            "description": "Network ID of the user that performed the operation"
                        },
                        {
                            "name": "TargetObjectId",
                            "type": "string",
                            "description": "Entra Id of the target user in the operation"
                        },
                        {
                            "name": "TargetUserId",
                            "type": "string",
                            "description": "Email of target user in the operation. Appears blank if not relevant to the operation"
                        },
                        {
                            "name": "TargetYammerUserId",
                            "type": "long",
                            "description": "ID of target user in the operation"
                        },
                        {
                            "name": "ThreadId",
                            "type": "long",
                            "description": "ID of the Message thread in the operation"
                        },
                        {
                            "name": "VersionId",
                            "type": "long",
                            "description": "Version ID of the file in the operation"
                        },
                        {
                            "name": "AttachmentData",
                            "type": "dynamic",
                            "description": "Data about attachments in the email message that triggered the event"
                        },
                        {
                            "name": "DetectionType",
                            "type": "string",
                            "description": "The type of detection. For example: Inline, Detected at delivery, Delayed: Detected after delivery, ZAP: Removed after delivery by zero-hour auto purge (ZAP). Events with ZAP detection type are typically preceded by a message with a Delayed detection type"
                        },
                        {
                            "name": "DetectionMethod",
                            "type": "string",
                            "description": "The detection method or technology used by Defender for Office 365"
                        },
                        {
                            "name": "InternetMessageId",
                            "type": "string",
                            "description": "The Internet Message Id"
                        },
                        {
                            "name": "NetworkMessageId",
                            "type": "string",
                            "description": "The Exchange Online Network Message Id"
                        },
                        {
                            "name": "P1Sender",
                            "type": "string",
                            "description": "The MAIL FROM address used in SMTP transmission of the email message between email servers (also known as the 5321.MailFrom address, P1 sender, or envelope sender)"
                        },
                        {
                            "name": "P2Sender",
                            "type": "string",
                            "description": "The From address (also known as the 5322.From address or P2 sender) that's shown in email clients"
                        },
                        {
                            "name": "Policy",
                            "type": "string",
                            "description": "The type of threat policy (for example, Anti-spam or Anti-phish) and related action type (for example, High Confidence Spam, Spam, or Phish) relevant to the email message"
                        },
                        {
                            "name": "Recipients",
                            "type": "dynamic",
                            "description": "An array of recipients of the email message"
                        },
                        {
                            "name": "SenderIp",
                            "type": "string",
                            "description": "The IPv4 or IPv6 address that submitted the message"
                        },
                        {
                            "name": "Subject",
                            "type": "string",
                            "description": "The subject line of the message"
                        },
                        {
                            "name": "Verdict",
                            "type": "string",
                            "description": "The message verdict"
                        },
                        {
                            "name": "MessageTime",
                            "type": "datetime",
                            "description": "Date and time in Coordinated Universal Time (UTC) the email message was received or sent"
                        },
                        {
                            "name": "EventDeepLink",
                            "type": "string",
                            "description": "Deep-link to the email event in Threat Explorer or Real-time detections"
                        },
                        {
                            "name": "DeliveryAction",
                            "type": "string",
                            "description": "The original delivery action on the email message"
                        },
                        {
                            "name": "OriginalDeliverylocation",
                            "type": "string",
                            "description": "The original delivery location of the email message"
                        },
                        {
                            "name": "LatestDeliverylocation",
                            "type": "string",
                            "description": "The latest delivery location of the email message at the time of the event"
                        },
                        {
                            "name": "Directionality",
                            "type": "string",
                            "description": "Identifies whether an email message was inbound, outbound, or an intra-org message"
                        },
                        {
                            "name": "ThreatsAndDetectionTech",
                            "type": "string",
                            "description": "The threats and the corresponding detection technologies. This field exposes all the threats on an email message, including the latest addition on spam verdict"
                        },
                        {
                            "name": "AdditionalActionsAndResults",
                            "type": "dynamic",
                            "description": "The additional actions that were taken on the email, such as ZAP or Manual Remediation. Also includes the corresponding results"
                        },
                        {
                            "name": "Connectors",
                            "type": "string",
                            "description": "The names and GUIDs of the connectors associated with the email"
                        },
                        {
                            "name": "AuthDetails",
                            "type": "dynamic",
                            "description": "The authentication checks that are done for the email. Also includes the values for SPF, DKIM, DMARC, and CompAuth"
                        },
                        {
                            "name": "SystemOverrides",
                            "type": "dynamic",
                            "description": "Overrides that are applicable to the email. These can be system or user overrides"
                        },
                        {
                            "name": "PhishConfidenceLevel",
                            "type": "string",
                            "description": "Indicates the confidence level associated with Phish verdict. It can be Normal or High"
                        },
                        {
                            "name": "BatchID",
                            "type": "string",
                            "description": "A unique identifier for a group of records that are processed together"
                        },
                        {
                            "name": "CampaignID",
                            "type": "string",
                            "description": "A unique identifier for the attack simulation training campaign"
                        },
                        {
                            "name": "UserDisplayName",
                            "type": "string",
                            "description": "The display name of the user involved in the attack simulation training campaign"
                        },
                        {
                            "name": "AttackTechnique",
                            "type": "string",
                            "description": "The attack technique used in the simulation"
                        },
                        {
                            "name": "CampaignType",
                            "type": "string",
                            "description": "The type of attack simulation campaign. The different types are simulation campaign, training campaign, simulation automation"
                        },
                        {
                            "name": "TimeData",
                            "type": "datetime",
                            "description": "Campaign launch time"
                        },
                        {
                            "name": "EndTimeData",
                            "type": "datetime",
                            "description": "Campaign end time"
                        },
                        {
                            "name": "AttackSimEvent",
                            "type": "string",
                            "description": "Type of event (user activity or message delivery state)"
                        },
                        {
                            "name": "AttackSimAdminEvent",
                            "type": "string",
                            "description": "The type of attack sim admin event"
                        },
                        {
                            "name": "CourseID",
                            "type": "string",
                            "description": "A unique identifier for a training course"
                        },
                        {
                            "name": "UserTrainingEvent",
                            "type": "string",
                            "description": "The type of user training event"
                        },
                        {
                            "name": "AdminSubmissionRegistered",
                            "type": "string",
                            "description": "Admin submission is registered and is pending for processing"
                        },
                        {
                            "name": "AdminSubmissionDeliveryCheck",
                            "type": "string",
                            "description": "Admin submission system checked the email's policy"
                        },
                        {
                            "name": "AdminSubmissionSubmitting",
                            "type": "string",
                            "description": "Admin submission system is submitting the email"
                        },
                        {
                            "name": "AdminSubmissionSubmitted",
                            "type": "string",
                            "description": "Admin submission system submitted the email"
                        },
                        {
                            "name": "AdminSubmissionTriage",
                            "type": "string",
                            "description": "Admin submission triaged by grader"
                        },
                        {
                            "name": "AdminSubmissionTimeout",
                            "type": "string",
                            "description": "Admin submission timed out with no result"
                        },
                        {
                            "name": "UserSubmission",
                            "type": "string",
                            "description": "Submission was first reported by an end user"
                        },
                        {
                            "name": "UserSubmissionTriage",
                            "type": "string",
                            "description": "User submission is triaged by grader"
                        },
                        {
                            "name": "CustomSubmission",
                            "type": "string",
                            "description": "Message reported by a user was sent to the organization's custom mailbox as set in the user reported messages settings"
                        },
                        {
                            "name": "AttackSimUserSubmission",
                            "type": "string",
                            "description": "The user-reported message was actually a phish simulation training message"
                        },
                        {
                            "name": "AdminSubmissionTablAllow",
                            "type": "string",
                            "description": "An allow entry in the Tenant Allow/Block List was created at time of submission to immediately take action on similar messages while it is being rescanned"
                        },
                        {
                            "name": "SubmissionNotification",
                            "type": "string",
                            "description": "Admin feedback is sent to end user"
                        },
                        {
                            "name": "InvestigationId",
                            "type": "string",
                            "description": "Investigation ID/GUID"
                        },
                        {
                            "name": "InvestigationName",
                            "type": "string",
                            "description": "Name of the investigation"
                        },
                        {
                            "name": "InvestigationType",
                            "type": "string",
                            "description": "Type of the investigation. Can take one of the following values: User-Reported Messages, Zapped Malware, Zapped Phish, Url Verdict Change"
                        },
                        {
                            "name": "LastUpdateTimeUtc",
                            "type": "datetime",
                            "description": "UTC time of the last update for an investigation"
                        },
                        {
                            "name": "StartTimeUtc",
                            "type": "datetime",
                            "description": "Start time for an investigation"
                        },
                        {
                            "name": "DeeplinkURL",
                            "type": "string",
                            "description": "Deep link URL to an investigation in the Microsoft Defender portal"
                        },
                        {
                            "name": "Actions",
                            "type": "dynamic",
                            "description": "Collection of actions recommended by an investigation"
                        },
                        {
                            "name": "ActionType",
                            "type": "string",
                            "description": "The type of the action, such as email remediation"
                        },
                        {
                            "name": "ActionStatus",
                            "type": "string",
                            "description": "Values include: Pending, Running, Waiting on resource, Completed, Failed"
                        },
                        {
                            "name": "ApprovedBy",
                            "type": "string",
                            "description": "Null if auto approved; otherwise, the username/id"
                        },
                        {
                            "name": "TimestampUtc",
                            "type": "datetime",
                            "description": "The timestamp of the action status change"
                        },
                        {
                            "name": "ActionId",
                            "type": "string",
                            "description": "Unique identifier for action"
                        },
                        {
                            "name": "RelatedAlertIds",
                            "type": "dynamic",
                            "description": "Alerts related to an investigation"
                        },
                        {
                            "name": "EndTimeUtc",
                            "type": "datetime",
                            "description": "Action final status update timestamp"
                        },
                        {
                            "name": "ResourceIdentifiers",
                            "type": "string",
                            "description": "Consists of the Azure Active Directory tenant ID"
                        },
                        {
                            "name": "Entities",
                            "type": "dynamic",
                            "description": "List of one or more affected entities by action"
                        },
                        {
                            "name": "Audit",
                            "type": "string",
                            "description": "System information related to the hygiene event"
                        },
                        {
                            "name": "Event",
                            "type": "string",
                            "description": "The type of hygiene event. The values for this parameter are Listed or Delisted"
                        },
                        {
                            "name": "EventId",
                            "type": "long",
                            "description": "The ID of the hygiene event type"
                        },
                        {
                            "name": "EventValue",
                            "type": "string",
                            "description": "The user who was impacted"
                        },
                        {
                            "name": "Reason",
                            "type": "string",
                            "description": "Details about the hygiene event"
                        },
                        {
                            "name": "AppName",
                            "type": "string",
                            "description": "The name of the app where the event occurred"
                        },
                        {
                            "name": "DashboardName",
                            "type": "string",
                            "description": "The name of the dashboard where the event occurred"
                        },
                        {
                            "name": "DataClassification",
                            "type": "string",
                            "description": "The data classification, if any, for the dashboard where the event occurred"
                        },
                        {
                            "name": "DatasetName",
                            "type": "string",
                            "description": "The name of the dataset where the event occurred"
                        },
                        {
                            "name": "MembershipInformation",
                            "type": "dynamic",
                            "description": "Membership information about the group"
                        },
                        {
                            "name": "OrgAppPermission",
                            "type": "string",
                            "description": "Permissions list for an organizational app (entire organization, specific users, or specific groups)"
                        },
                        {
                            "name": "ReportName",
                            "type": "string",
                            "description": "The name of the report where the event occurred"
                        },
                        {
                            "name": "SharingInformation",
                            "type": "dynamic",
                            "description": "Information about the person to whom a sharing invitation is sent"
                        },
                        {
                            "name": "SwitchState",
                            "type": "string",
                            "description": "Information about the state of various tenant level switches"
                        },
                        {
                            "name": "WorkSpaceName",
                            "type": "string",
                            "description": "The name of the workspace where the event occurred"
                        },
                        {
                            "name": "WpaUserRole",
                            "type": "string",
                            "description": "The Viva Insights role of the user who performed the action"
                        },
                        {
                            "name": "OperationDetails",
                            "type": "dynamic",
                            "description": "A list of extended properties for the setting that was changed. Each property has a Name and Value"
                        },
                        {
                            "name": "RequestType",
                            "type": "string",
                            "description": "The type of quarantine request performed by a user"
                        },
                        {
                            "name": "RequestSource",
                            "type": "string",
                            "description": "Quarantine request come from the Microsoft Defender portal, a cmdlet, or a URLlink"
                        },
                        {
                            "name": "ReleaseTo",
                            "type": "string",
                            "description": "The recipient of the email message"
                        },
                        {
                            "name": "FormsUserTypes",
                            "type": "dynamic",
                            "description": "The role of the user who performed the action. The values for this parameter are Admin, Owner, Responder, or Coauthor"
                        },
                        {
                            "name": "SourceApp",
                            "type": "string",
                            "description": "Indicates if the action is from Forms website or from another App"
                        },
                        {
                            "name": "FormName",
                            "type": "string",
                            "description": "The name of the current form"
                        },
                        {
                            "name": "FormId",
                            "type": "string",
                            "description": "The Id of the target form"
                        },
                        {
                            "name": "FormTypes",
                            "type": "dynamic",
                            "description": "Indicates whether this is a Form, Quiz, or Survey"
                        },
                        {
                            "name": "ActivityParameters",
                            "type": "string",
                            "description": "JSON string containing activity parameters. For more information, see Microsoft Forms activities"
                        },
                        {
                            "name": "Sender",
                            "type": "string",
                            "description": "The email address in the From field of the email message"
                        },
                        {
                            "name": "Receivers",
                            "type": "dynamic",
                            "description": "All email addresses in the To, CC, and Bcc fields of the email message"
                        },
                        {
                            "name": "ItemName",
                            "type": "string",
                            "description": "The string in the Subject field of the email message"
                        },
                        {
                            "name": "LabelId",
                            "type": "string",
                            "description": "The GUID of the sensitivity label applied to the email message"
                        },
                        {
                            "name": "LabelName",
                            "type": "string",
                            "description": "The name of the sensitivity label applied to the email message"
                        },
                        {
                            "name": "LabelAction",
                            "type": "string",
                            "description": "The actions specified by the sensitivity label that were applied to the email message before the message entered the mail transport pipeline"
                        },
                        {
                            "name": "LabelAppliedDateTime",
                            "type": "datetime",
                            "description": "The date the sensitivity label was applied to the email message"
                        },
                        {
                            "name": "ApplicationMode",
                            "type": "string",
                            "description": "Specifies how the sensitivity label was applied to the email message. The Privileged value indicates the label was manually applied by a user. The Standard value indicates the label was auto-applied by a client-side or service-side labeling process"
                        },
                        {
                            "name": "Recipient",
                            "type": "string",
                            "description": "Recipient email address"
                        },
                        {
                            "name": "AuthenticationMethod",
                            "type": "string",
                            "description": "Authentication method when accessing the message, i.e. OTP, Yahoo, Gmail, Microsoft"
                        },
                        {
                            "name": "AuthenticationStatus",
                            "type": "string",
                            "description": "0: Success, 1: Failure"
                        },
                        {
                            "name": "OperationStatus",
                            "type": "string",
                            "description": "0: Success, 1: Failure"
                        },
                        {
                            "name": "AttachmentName",
                            "type": "string",
                            "description": "Name of the attachment"
                        },
                        {
                            "name": "OperationProperties",
                            "type": "dynamic",
                            "description": "Extra properties, i.e. number of OTP passcode sent, email subject, etc."
                        },
                        {
                            "name": "TaskId",
                            "type": "string",
                            "description": "Unique identifier of the periodic data connector instance. Data connectors import data in periodic intervals"
                        },
                        {
                            "name": "ItemId",
                            "type": "string",
                            "description": "Unique identifier of the item (for example, an email message) being imported"
                        },
                        {
                            "name": "ItemSize",
                            "type": "long",
                            "description": "The size of the item being imported"
                        },
                        {
                            "name": "SourceUserId",
                            "type": "string",
                            "description": "The unique identifier of the user from the third-party data source. For example, for a Slack data connector, this property specifies the user Id in Slack workspace"
                        },
                        {
                            "name": "FailureType",
                            "type": "string",
                            "description": "Indicates the type of data import failure. For example, the value incorrectusermapping indicates the item wasn't imported because no user mapping between the third-party data source and Microsoft 365 could be found"
                        },
                        {
                            "name": "ResultMessage",
                            "type": "string",
                            "description": "Indicates the type of failure, such as Duplicate message"
                        },
                        {
                            "name": "IsRetry",
                            "type": "boolean",
                            "description": "Indicates whether the data connector retried to import the item"
                        },
                        {
                            "name": "Attachments",
                            "type": "dynamic",
                            "description": "A list of attachments received from the third-party data source"
                        },
                        {
                            "name": "DataStoreType",
                            "type": "string",
                            "description": "Indicates which data store the data was downloaded from. Refer DataStoreType for all possible values"
                        },
                        {
                            "name": "UserAction",
                            "type": "string",
                            "description": "Indicates what action user had performed on the data store. Refer DataLakeUserAction for all possible values"
                        },
                        {
                            "name": "ExportTriggeredAt",
                            "type": "datetime",
                            "description": "Indicates when the data export was triggered"
                        },
                        {
                            "name": "NameOfDownloadedZipFile",
                            "type": "string",
                            "description": "The name of the compressed file the admin had downloaded from the Data Lake"
                        },
                        {
                            "name": "Invitation",
                            "type": "string",
                            "description": "Details of the invite sent to the recipient of the Data Share"
                        },
                        {
                            "name": "ClientUUID",
                            "type": "string",
                            "description": "The Client UUID of the Viva Glint instance"
                        },
                        {
                            "name": "ImportType",
                            "type": "string",
                            "description": "The data import source type"
                        },
                        {
                            "name": "DataDSRControl",
                            "type": "string",
                            "description": "This in-platform control determines whether survey data is deleted when a user is removed from the Viva Glint platform"
                        },
                        {
                            "name": "DiscardEmployeeIds",
                            "type": "string",
                            "description": "This in-platform control specifies whether the Employee IDs of previously deleted employees are disregarded or retained in the Viva Glint platform"
                        },
                        {
                            "name": "ExtendedCompletionDate",
                            "type": "datetime",
                            "description": "The new date to which a closed survey cycle has been extended"
                        },
                        {
                            "name": "FeedBackComponentName",
                            "type": "string",
                            "description": "The name of a specific component within the 360 feedback program"
                        },
                        {
                            "name": "Detail",
                            "type": "string",
                            "description": "A description of the event or the activity that occurred in Viva Goals"
                        },
                        {
                            "name": "Username",
                            "type": "string",
                            "description": "The name of the user who triggered the event"
                        },
                        {
                            "name": "UserRole",
                            "type": "string",
                            "description": "The role of the user who triggered this event in Viva Goals. This value mentions if the user is an organization admin or an owner"
                        },
                        {
                            "name": "OrganizationName",
                            "type": "string",
                            "description": "The name of the organization in Viva Goals where the event was triggered"
                        },
                        {
                            "name": "OrganizationOwner",
                            "type": "string",
                            "description": "The owner of the organization in Viva Goals where the event occurred"
                        },
                        {
                            "name": "OrganizationAdmins",
                            "type": "dynamic",
                            "description": "The admin(s) of the organization in Viva Goals where the event occurred. There can be one or more admins in the organization"
                        },
                        {
                            "name": "UserAgent",
                            "type": "string",
                            "description": "The user agent (browser details) of the user who triggered the event. UserAgent might not be present in case of a system generated event"
                        },
                        {
                            "name": "ModifiedFields",
                            "type": "dynamic",
                            "description": "A list of attributes that were modified along with its new and old values output as a JSON"
                        },
                        {
                            "name": "ItemDetails",
                            "type": "dynamic",
                            "description": "Additional properties about the object that was modified"
                        },
                        {
                            "name": "EditMethodology",
                            "type": "string",
                            "description": "How the policy was created / edited"
                        },
                        {
                            "name": "CountOfArtifactsBeingAdded",
                            "type": "int",
                            "description": "Number of artifacts being added"
                        },
                        {
                            "name": "CountOfArtifactsBeingRemoved",
                            "type": "int",
                            "description": "Number of artifacts being removed"
                        },
                        {
                            "name": "ServiceType",
                            "type": "string",
                            "description": "Whether it is a SharePoint, Exchange, or OneDriveForBusiness policy"
                        },
                        {
                            "name": "CreationMethodology",
                            "type": "string",
                            "description": "How the Restore Task was created / edited"
                        },
                        {
                            "name": "RestoreTime",
                            "type": "datetime",
                            "description": "Time which the item is being restored to"
                        },
                        {
                            "name": "RestoreLocationType",
                            "type": "string",
                            "description": "Location type that the item is being restored to"
                        },
                        {
                            "name": "RestoreLocation",
                            "type": "string",
                            "description": "Location that the item is being restored to"
                        },
                        {
                            "name": "BackupItemID",
                            "type": "string",
                            "description": "ID of the Backup Item being restored"
                        },
                        {
                            "name": "ProtectionUnitID",
                            "type": "string",
                            "description": "Protection Unit ID of the item being restored"
                        },
                        {
                            "name": "SuccessStatus",
                            "type": "string",
                            "description": "Whether the restore operation was successful"
                        },
                        {
                            "name": "BackupItemType",
                            "type": "string",
                            "description": "Whether the Backup Item is a Site / Account / Mailbox"
                        },
                        {
                            "name": "URLPath",
                            "type": "string",
                            "description": "The URL that was browsed"
                        },
                        {
                            "name": "DomainURL",
                            "type": "string",
                            "description": "The domain URL that was browsed"
                        },
                        {
                            "name": "ScenarioType",
                            "type": "string",
                            "description": "The name of automation"
                        },
                        {
                            "name": "PromptText",
                            "type": "string",
                            "description": "The Copilot prompt that's run by the LLM"
                        },
                        {
                            "name": "AutomationId",
                            "type": "string",
                            "description": "A unique identifier that correlates all activities related to each run of the Copilot prompt"
                        },
                        {
                            "name": "TriggerMode",
                            "type": "string",
                            "description": "The schedule for when the Copilot prompt runs, shown in cron format"
                        },
                        {
                            "name": "PlaceType",
                            "type": "string",
                            "description": "The type for the place item that is created/updated/deleted by the request. For example, 'Building', 'Room', 'Desk', and so on"
                        },
                        {
                            "name": "EventTime",
                            "type": "datetime",
                            "description": "Timestamp when the Spark Notebook execution was submitted/started"
                        },
                        {
                            "name": "Compute",
                            "type": "string",
                            "description": "Compute selected"
                        },
                        {
                            "name": "DatabaseName",
                            "type": "dynamic",
                            "description": "The workspace the command ran on"
                        },
                        {
                            "name": "TableName",
                            "type": "string",
                            "description": "Name of the table"
                        },
                        {
                            "name": "SessionDurationInSecs",
                            "type": "string",
                            "description": "Total duration of the session"
                        },
                        {
                            "name": "SessionStartTime",
                            "type": "datetime",
                            "description": "Start time for the session"
                        },
                        {
                            "name": "SessionEndTime",
                            "type": "datetime",
                            "description": "End time for the session"
                        },
                        {
                            "name": "KernalId",
                            "type": "string",
                            "description": "Jupyter KernelId, uniquely identifies the Notebook session"
                        },
                        {
                            "name": "SessionId",
                            "type": "string",
                            "description": "Correlation ID for the various code blocks executed with a Spark session"
                        },
                        {
                            "name": "Interface",
                            "type": "string",
                            "description": "Interface from where the notebook was run"
                        },
                        {
                            "name": "JobType",
                            "type": "string",
                            "description": "Type of Job like Notebook, KQL"
                        },
                        {
                            "name": "JobName",
                            "type": "string",
                            "description": "Name of the job"
                        },
                        {
                            "name": "Schedule",
                            "type": "string",
                            "description": "Schedule details, if configured for the job"
                        },
                        {
                            "name": "RunID",
                            "type": "string",
                            "description": "ID of a specific job run instance"
                        },
                        {
                            "name": "JobRunStatus",
                            "type": "string",
                            "description": "Status of the job execution"
                        },
                        {
                            "name": "Logs",
                            "type": "string",
                            "description": "Logs from the notebook run"
                        },
                        {
                            "name": "JobExecutionDurationInSecs",
                            "type": "long",
                            "description": "Time taken for job execution"
                        },
                        {
                            "name": "JobTotalDurationInSecs",
                            "type": "long",
                            "description": "Total Duration of the job operation including session"
                        },
                        {
                            "name": "JobStartTime",
                            "type": "datetime",
                            "description": "Start time of the job"
                        },
                        {
                            "name": "JobEndTime",
                            "type": "datetime",
                            "description": "End time of the job"
                        },
                        {
                            "name": "DatabasesRead",
                            "type": "dynamic",
                            "description": "The list of workspaces read by the job"
                        },
                        {
                            "name": "DatabasesWrite",
                            "type": "dynamic",
                            "description": "The list of workspaces written to by the job"
                        },
                        {
                            "name": "TablesRead",
                            "type": "dynamic",
                            "description": "The list of tables read by the job"
                        },
                        {
                            "name": "TablesWrite",
                            "type": "dynamic",
                            "description": "The list of tables written to by the job"
                        },
                        {
                            "name": "Query",
                            "type": "string",
                            "description": "KQL query or notebook executed in the job"
                        },
                        {
                            "name": "ResultTableCount",
                            "type": "long",
                            "description": "Output Table Count"
                        },
                        {
                            "name": "QueryResponse",
                            "type": "string",
                            "description": "Response from executing the KQL query"
                        },
                        {
                            "name": "TotalRows",
                            "type": "dynamic",
                            "description": "Total Rows returned from query execution. List of values if multiple queries executed at once"
                        },
                        {
                            "name": "ComponentFault",
                            "type": "string",
                            "description": "The entity that caused the query to fail. For example, if the query result is too large, the ComponentFault is 'Client'. If an internal error occurred, the ComponentFault is 'Server'"
                        },
                        {
                            "name": "FailureReason",
                            "type": "string",
                            "description": "If KQL query failed, the reason for failure"
                        },
                        {
                            "name": "ExecutionDuration",
                            "type": "long",
                            "description": "Time taken for query execution, in milliseconds"
                        },
                        {
                            "name": "TotalCPU",
                            "type": "long",
                            "description": "Total CPU Duration of the run"
                        },
                        {
                            "name": "MemoryPeak",
                            "type": "long",
                            "description": "Memory Peak of the KQL query execution"
                        },
                        {
                            "name": "BillingAzureSubscriptionId",
                            "type": "string",
                            "description": "Azure subscription chosen for Sentinel data lake billing"
                        },
                        {
                            "name": "BillingAzureResourceGroupName",
                            "type": "string",
                            "description": "Azure resource group chosen for Sentinel data lake billing"
                        },
                        {
                            "name": "ProvisioningStatus",
                            "type": "string",
                            "description": "Status of provisioning the lake"
                        },
                        {
                            "name": "DataOnboardingAtSetup",
                            "type": "string",
                            "description": "Data sets ingested during Sentinel data lake onboarding"
                        },
                        {
                            "name": "Tables",
                            "type": "dynamic",
                            "description": "List of table names ingested during Sentinel data lake onboarding"
                        },
                        {
                            "name": "SubscriptionsEnabled",
                            "type": "dynamic",
                            "description": "List of subscriptions enabled for ARG ingestion"
                        },
                        {
                            "name": "DataOnboardingStatus",
                            "type": "string",
                            "description": "Status of operation"
                        },
                        {
                            "name": "EventOccurenceTime",
                            "type": "datetime",
                            "description": "Timestamp of the operation"
                        },
                        {
                            "name": "ToolID",
                            "type": "string",
                            "description": "Identifier of the AI Tool"
                        },
                        {
                            "name": "ToolName",
                            "type": "string",
                            "description": "Name of the AI Tool"
                        },
                        {
                            "name": "InputParameters",
                            "type": "string",
                            "description": "Parameters given to the tool"
                        },
                        {
                            "name": "APIsCalled",
                            "type": "dynamic",
                            "description": "APIs called by the AI Tool"
                        },
                        {
                            "name": "DataScanned",
                            "type": "long",
                            "description": "Total GBs Scanned"
                        },
                        {
                            "name": "TotalCpuHours",
                            "type": "long",
                            "description": "Total CPU Duration of the run"
                        },
                        {
                            "name": "TotalSCUHours",
                            "type": "long",
                            "description": "Total SCUs used in the run"
                        },
                        {
                            "name": "GraphName",
                            "type": "string",
                            "description": "Name of the graph instance"
                        },
                        {
                            "name": "OperationInput",
                            "type": "string",
                            "description": "Parameters of graph action"
                        },
                        {
                            "name": "GraphQueryStats",
                            "type": "string",
                            "description": "Collection of response metadata"
                        },
                        {
                            "name": "GraphQueryStatus",
                            "type": "string",
                            "description": "Response of the query or action on graph"
                        },
                        {
                            "name": "DataCenterSecurityEventType",
                            "type": "string",
                            "description": "The type of cmdlet event in lock box"
                        },
                        {
                            "name": "ElevationTime",
                            "type": "datetime",
                            "description": "The start time of the elevation"
                        },
                        {
                            "name": "ElevationApprover",
                            "type": "string",
                            "description": "The name of a Microsoft manager"
                        },
                        {
                            "name": "ElevationApprovedTime",
                            "type": "datetime",
                            "description": "The timestamp for when the elevation was approved"
                        },
                        {
                            "name": "ElevationRequestId",
                            "type": "string",
                            "description": "A unique identifier for the elevation request"
                        },
                        {
                            "name": "ElevationRole",
                            "type": "string",
                            "description": "The role the elevation was requested for"
                        },
                        {
                            "name": "ElevationDuration",
                            "type": "int",
                            "description": "The duration for which the elevation was active"
                        },
                        {
                            "name": "GenericInfo",
                            "type": "string",
                            "description": "Used for comments and other generic information"
                        },
                        {
                            "name": "EventName",
                            "type": "string",
                            "description": "A description of the event or the activity that occurred in Viva Pulse"
                        },
                        {
                            "name": "PulseId",
                            "type": "string",
                            "description": "Id of the pulse survey"
                        },
                        {
                            "name": "EventDetails",
                            "type": "dynamic",
                            "description": "Additional properties about the event"
                        },
                        {
                            "name": "SharePointMetaData",
                            "type": "dynamic",
                            "description": "Describes metadata about the document in SharePoint or OneDrive that contained the sensitive information"
                        },
                        {
                            "name": "ExchangeMetaData",
                            "type": "dynamic",
                            "description": "Describes metadata about the email message that contained the sensitive information"
                        },
                        {
                            "name": "EndpointMetaData",
                            "type": "dynamic",
                            "description": "Describes metadata about the document in endpoint that contained the sensitive information"
                        },
                        {
                            "name": "ExceptionInfo",
                            "type": "string",
                            "description": "Identifies reasons why a policy no longer applies and/or any information about false positive and/or override noted by the end user"
                        },
                        {
                            "name": "PolicyDetails",
                            "type": "dynamic",
                            "description": "Information about 1 or more policies that triggered the DLP event"
                        },
                        {
                            "name": "SensitiveInfoDetectionIsIncluded",
                            "type": "boolean",
                            "description": "Indicates whether the event contains the value of the sensitive data type and surrounding context from the source content"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
            "name": "[concat(variables('workspaceName'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]",
            "location": "[parameters('workspace-location')]",
            "apiVersion": "2023-04-01-preview",
            "properties": {
                "version": "[variables('_solutionVersion')]",
                "kind": "Solution",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_solutionId')]",
                "source": {
                    "kind": "Solution",
                    "name": "[variables('_solutionName')]",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "[variables('_solutionAuthor')]"
                },
                "support": {
                    "name": "[variables('_solutionSupport')]",
                    "tier": "Community"
                },
                "categories": {
                    "domains": ["Cloud Provider"]
                },
                "dependencies": {
                    "operator": "AND",
                    "criteria": [
                        {
                            "kind": "DataConnector",
                            "contentId": "[variables('_dataConnectorContentIdConnectorDefinition')]",
                            "version": "[variables('dataConnectorVersionConnectorDefinition')]"
                        },
                        {
                            "kind": "DataConnector",
                            "contentId": "[variables('_dataConnectorContentIdConnectorDefinitionDLP')]",
                            "version": "[variables('dataConnectorVersionConnectorDefinition')]"
                        }
                    ]
                },
                "firstPublishDate": "2025-12-30",
                "providers": [
                    "[variables('_solutionAuthor')]"
                ],
                "contentKind": "Solution",
                "packageId": "[variables('_solutionId')]",
                "contentProductId": "[concat(substring(variables('_solutionId'), 0, 50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]",
                "displayName": "[variables('_solutionName')]",
                "publisherDisplayName": "[variables('_solutionId')]",
                "descriptionHtml": "Dual-connector solution for ingesting Microsoft 365 audit logs from Office 365 Management Activity API. Includes Audit.General connector (29 specialty workloads) and Audit.DLP connector sharing a 304-column schema with dedicated fields for Copilot, Power BI, Viva suite, Security & Compliance, eDiscovery, Sentinel platform operations, and DLP events.",
                "icon": "[variables('_packageIcon')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(variables('workspaceName'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition'), variables('dataConnectorVersionConnectorDefinition'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition')]",
                "displayName": "[concat(variables('_solutionName'), ' ', variables('dataConnectorTemplateNameConnectorDefinition'))]",
                "contentKind": "DataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('dataConnectorVersionConnectorDefinition')]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[concat(variables('workspaceName'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition')))]",
                            "apiVersion": "2022-01-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition'))]",
                                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition')]",
                                "kind": "DataConnector",
                                "version": "[variables('dataConnectorVersionConnectorDefinition')]",
                                "source": {
                                    "sourceId": "[variables('_solutionId')]",
                                    "name": "[variables('_solutionName')]",
                                    "kind": "Solution"
                                },
                                "author": {
                                    "name": "[variables('_solutionAuthor')]"
                                },
                                "support": {
                                    "name": "[variables('_solutionSupport')]",
                                    "tier": "[variables('_solutionTier')]"
                                },
                                "dependencies": {
                                    "criteria": [
                                        {
                                            "version": "[variables('dataConnectorVersionConnections')]",
                                            "contentId": "[variables('_dataConnectorContentIdConnections')]",
                                            "kind": "ResourcesDataConnector"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(substring(variables('_solutionId'), 0, 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition'),'-', variables('dataConnectorVersionConnectorDefinition'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('_solutionVersion')]"
            }
        },
        {
            "name": "[concat(variables('workspaceName'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition'))]",
            "apiVersion": "2022-09-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
            "location": "[parameters('workspace-location')]",
            "kind": "Customizable",
            "properties": {
                "connectorUiConfig": {
                    "id": "M365AuditGeneralCCP",
                    "title": "Microsoft 365 Audit.General",
                    "publisher": "Marko Lauren",
                    "descriptionMarkdown": "Microsoft 365 Audit.General connector ingests generic audit logs from Microsoft 365 workloads **not covered by dedicated connectors** (such as Exchange, Sharepoint, Teams, Dynamics, Purview). Includes Copilot, Power BI, Viva suite, Defender for Office 365, eDiscovery, Security & Compliance, Sentinel platform operations, and more.\n\nM365AuditGeneral_CL table with **304 columns** captures detailed activity across Microsoft 365.\n\n**Prerequisites:** Entra ID app with Office 365 Management API permissions and Audit.General subscription.",
                    "graphQueriesTableName": "M365AuditGeneral_CL",
                    "graphQueries": [
                        {
                            "metricName": "Total events received",
                            "legend": "M365 Audit General Events",
                            "baseQuery": "M365AuditGeneral_CL"
                        }
                    ],
                    "sampleQueries": [
                        {
                            "description": "All Microsoft 365 Audit Events",
                            "query": "M365AuditGeneral_CL\n| sort by TimeGenerated desc"
                        },
                        {
                            "description": "Events by Workload",
                            "query": "M365AuditGeneral_CL\n| summarize count() by Workload\n| render barchart"
                        }
                    ],
                    "dataTypes": [
                        {
                            "name": "M365AuditGeneral_CL",
                            "lastDataReceivedQuery": "M365AuditGeneral_CL\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
                        }
                    ],
                    "connectivityCriteria": [
                        {
                            "type": "HasDataConnectors"
                        }
                    ],
                    "availability": {
                        "status": 1,
                        "isPreview": false
                    },
                    "permissions": {
                        "resourceProvider": [
                            {
                                "provider": "Microsoft.OperationalInsights/workspaces",
                                "permissionsDisplayText": "read and write permissions are required.",
                                "providerDisplayName": "Workspace",
                                "scope": "Workspace",
                                "requiredPermissions": {
                                    "write": true,
                                    "read": true,
                                    "delete": true
                                }
                            }
                        ],
                        "customs": [
                            {
                                "name": "Office 365 Management API credentials",
                                "description": "An Entra ID application registration with **Client ID** and **Client Secret**. The application must have **Office 365 Management APIs - ActivityFeed.Read** permission and an active subscription to the **Audit.General** content type."
                            }
                        ]
                    },
                    "instructionSteps": [
                        {
                            "title": "1. Register an Entra ID Application",
                            "description": "⚠️ If you already have an app from the Audit.DLP connector, you can **reuse the same app**. Otherwise:\\n\\n1. Go to **Microsoft Entra ID** \u003e **App registrations** \u003e **New registration**\n2. Name: `Sentinel-M365AuditGeneral` (or your preferred name)\n3. **Supported account types**: Accounts in this organizational directory only\n4. Click **Register**\n5. Note the **Application (client) ID** - you'll need this later\n6. Go to **Certificates \u0026 secrets** \u003e **New client secret**\n7. Add a description, set expiration, click **Add**\n8. **Copy the secret Value immediately** - it won't be shown again"
                        },
                        {
                            "title": "2. Configure API Permissions",
                            "description": "⚠️ Audit.General requires **ActivityFeed.Read** permission (different from Audit.DLP which needs ActivityFeed.ReadDlp).\n\n1. In your app registration, go to **API permissions** \u003e **Add a permission**\n2. Select **Office 365 Management APIs**\n3. Choose **Application permissions**\n4. Select **ActivityFeed.Read**\n5. Click **Add permissions**\n6. Click **Grant admin consent** for your tenant\n7. Verify the permission shows as **Granted**"
                        },
                        {
                            "title": "3. Subscribe to Audit.General Content",
                            "description": "Run this PowerShell script to subscribe to the Audit.General content type (required before data flows):\n\n```powershell\n# Replace with your values\n$tenantId = 'YOUR_TENANT_ID'\n$clientId = 'YOUR_CLIENT_ID'\n$clientSecret = 'YOUR_CLIENT_SECRET'\n$publisherId = $tenantId  # Publisher identifier is your tenant ID\n\n# Get OAuth token\n$body = @{\n    grant_type    = 'client_credentials'\n    client_id     = $clientId\n    client_secret = $clientSecret\n    resource      = 'https://manage.office.com'\n}\n$tokenResponse = Invoke-RestMethod -Method Post -Uri \"https://login.microsoftonline.com/$tenantId/oauth2/token\" -Body $body\n$token = $tokenResponse.access_token\n\n# Start subscription\n$headers = @{Authorization = \"Bearer $token\"}\n$subscribeUri = \"https://manage.office.com/api/v1.0/$tenantId/activity/feed/subscriptions/start?contentType=Audit.General\u0026PublisherIdentifier=$publisherId\"\nInvoke-RestMethod -Method Post -Uri $subscribeUri -Headers $headers\n```"
                        },
                        {
                            "title": "4. Connect the Data Connector",
                            "description": "Provide your Entra ID application credentials below. The connector will automatically use your subscription's tenant ID for authentication and API calls.",
                            "instructions": [
                                {
                                    "type": "OAuthForm",
                                    "parameters": {
                                        "clientIdLabel": "Application (Client) ID",
                                        "clientSecretLabel": "Client Secret Value",
                                        "connectButtonLabel": "Connect",
                                        "disconnectButtonLabel": "Disconnect"
                                    }
                                }
                            ]
                        }
                    ]
                }
            }
        },
        {
            "name": "[concat(variables('workspaceName'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition')))]",
            "apiVersion": "2022-01-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersionConnectorDefinition')]",
                "source": {
                    "sourceId": "[variables('_solutionId')]",
                    "name": "[variables('_solutionName')]",
                    "kind": "Solution"
                },
                "author": {
                    "name": "[variables('_solutionAuthor')]"
                },
                "support": {
                    "name": "[variables('_solutionSupport')]",
                    "tier": "[variables('_solutionTier')]"
                },
                "dependencies": {
                    "criteria": [
                        {
                            "version": "[variables('dataConnectorVersionConnections')]",
                            "contentId": "[variables('_dataConnectorContentIdConnections')]",
                            "kind": "ResourcesDataConnector"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(variables('workspaceName'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinitionDLP'), variables('dataConnectorVersionConnectorDefinitionDLP'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinitionDLP')]",
                "displayName": "[concat(variables('_solutionName'), ' ', variables('dataConnectorTemplateNameConnectorDefinitionDLP'))]",
                "contentKind": "DataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('dataConnectorVersionConnectorDefinitionDLP')]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[concat(variables('workspaceName'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinitionDLP')))]",
                            "apiVersion": "2022-01-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinitionDLP'))]",
                                "contentId": "[variables('_dataConnectorContentIdConnectorDefinitionDLP')]",
                                "kind": "DataConnector",
                                "version": "[variables('dataConnectorVersionConnectorDefinitionDLP')]",
                                "source": {
                                    "sourceId": "[variables('_solutionId')]",
                                    "name": "[variables('_solutionName')]",
                                    "kind": "Solution"
                                },
                                "author": {
                                    "name": "[variables('_solutionAuthor')]"
                                },
                                "support": {
                                    "name": "[variables('_solutionSupport')]",
                                    "tier": "[variables('_solutionTier')]"
                                },
                                "dependencies": {
                                    "criteria": [
                                        {
                                            "version": "[variables('dataConnectorVersionConnectionsDLP')]",
                                            "contentId": "[variables('_dataConnectorContentIdConnectionsDLP')]",
                                            "kind": "ResourcesDataConnector"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(substring(variables('_solutionId'), 0, 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinitionDLP'),'-', variables('dataConnectorVersionConnectorDefinitionDLP'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('_solutionVersion')]"
            }
        },
        {
            "name": "[concat(variables('workspaceName'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinitionDLP'))]",
            "apiVersion": "2022-09-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
            "location": "[parameters('workspace-location')]",
            "kind": "Customizable",
            "properties": {
                "connectorUiConfig": {
                    "id": "M365AuditDLPCCP",
                    "title": "Microsoft 365 Audit.DLP",
                    "publisher": "Marko Lauren",
                    "descriptionMarkdown": "Microsoft 365 Audit.DLP connector ingests **DLP events for all workloads** from the Office 365 Management Activity API.\\n\\nData is ingested to the same **M365AuditGeneral_CL** table with **304 columns** including dedicated DLP schema fields (SharePointMetaData, ExchangeMetaData, EndpointMetaData, ExceptionInfo, PolicyDetails, SensitiveInfoDetectionIsIncluded).\\n\\n**Prerequisites:** Entra ID app with Office 365 Management API permissions and DLP.All subscription.",
                    "graphQueriesTableName": "M365AuditGeneral_CL",
                    "graphQueries": [
                        {
                            "metricName": "Total DLP events received",
                            "legend": "M365 DLP Events",
                            "baseQuery": "M365AuditGeneral_CL | where RecordType in (11, 13, 33, 63, 99, 100, 107, 187)"
                        }
                    ],
                    "sampleQueries": [
                        {
                            "description": "All Microsoft 365 DLP Events",
                            "query": "M365AuditGeneral_CL\n| where RecordType in (11, 13, 33, 63, 99, 100, 107, 187)\n| sort by TimeGenerated desc"
                        },
                        {
                            "description": "DLP Events by Workload",
                            "query": "M365AuditGeneral_CL\n| where RecordType in (11, 13, 33, 63, 99, 100, 107, 187)\n| summarize count() by Workload\n| render barchart"
                        },
                        {
                            "description": "DLP Policy Violations",
                            "query": "M365AuditGeneral_CL\n| where RecordType in (11, 13, 33, 63, 99, 100, 107, 187)\n| where Operation == 'DlpRuleMatch'\n| summarize count() by tostring(PolicyDetails)\n| render barchart"
                        }
                    ],
                    "dataTypes": [
                        {
                            "name": "M365AuditGeneral_CL",
                            "lastDataReceivedQuery": "M365AuditGeneral_CL\n| where RecordType in (11, 13, 33, 63, 99, 100, 107, 187)\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
                        }
                    ],
                    "connectivityCriteria": [
                        {
                            "type": "HasDataConnectors"
                        }
                    ],
                    "availability": {
                        "status": 1,
                        "isPreview": false
                    },
                    "permissions": {
                        "resourceProvider": [
                            {
                                "provider": "Microsoft.OperationalInsights/workspaces",
                                "permissionsDisplayText": "read and write permissions are required.",
                                "providerDisplayName": "Workspace",
                                "scope": "Workspace",
                                "requiredPermissions": {
                                    "write": true,
                                    "read": true,
                                    "delete": true
                                }
                            }
                        ],
                        "customs": [
                            {
                                "name": "Office 365 Management API credentials",
                                "description": "An Entra ID application registration with **Client ID** and **Client Secret**. The application must have **Office 365 Management APIs - ActivityFeed.Read** permission and an active subscription to the **DLP.All** content type. You can reuse the same app as the Audit.General connector."
                            }
                        ]
                    },
                    "instructionSteps": [
                        {
                            "title": "1. Register an Entra ID Application",
                            "description": "⚠️ If you already have an app from the Audit.General connector, you can **reuse the same app**. Otherwise:\\n\\n1. Go to **Microsoft Entra ID** \u003e **App registrations** \u003e **New registration**\\n2. Name: `Sentinel-M365Audit` (or your preferred name)\\n3. **Supported account types**: Accounts in this organizational directory only\\n4. Click **Register**\\n5. Note the **Application (client) ID** - you'll need this later\\n6. Go to **Certificates \u0026 secrets** \u003e **New client secret**\\n7. Add a description, set expiration, click **Add**\\n8. **Copy the secret Value immediately** - it won't be shown again"
                        },
                        {
                            "title": "2. Configure API Permissions",
                            "description": "⚠️ Audit.DLP requires **ActivityFeed.ReadDlp** permission (different from Audit.General which needs ActivityFeed.Read).\n\n1. In your app registration, go to **API permissions** > **Add a permission**\n2. Select **Office 365 Management APIs**\n3. Choose **Application permissions**\n4. Select **ActivityFeed.ReadDlp**\n5. Click **Add permissions**\n6. Click **Grant admin consent** for your tenant\n7. Verify the permission shows as **Granted**\n\nNote: If sharing the same app with Audit.General connector, add both ActivityFeed.Read and ActivityFeed.ReadDlp permissions."
                        },
                        {
                            "title": "3. Subscribe to DLP.All Content",
                            "description": "Run this PowerShell script to subscribe to the DLP.All content type (required before data flows):\n\n```powershell\n# Replace with your values\n$tenantId = 'YOUR_TENANT_ID'\n$clientId = 'YOUR_CLIENT_ID'\n$clientSecret = 'YOUR_CLIENT_SECRET'\n$publisherId = $tenantId  # Publisher identifier is your tenant ID\n\n# Get OAuth token\n$body = @{\n    grant_type    = 'client_credentials'\n    client_id     = $clientId\n    client_secret = $clientSecret\n    resource      = 'https://manage.office.com'\n}\n$tokenResponse = Invoke-RestMethod -Method Post -Uri \"https://login.microsoftonline.com/$tenantId/oauth2/token\" -Body $body\n$token = $tokenResponse.access_token\n\n# Start subscription\n$headers = @{Authorization = \"Bearer $token\"}\n$subscribeUri = \"https://manage.office.com/api/v1.0/$tenantId/activity/feed/subscriptions/start?contentType=DLP.All&PublisherIdentifier=$publisherId\"\nInvoke-RestMethod -Method Post -Uri $subscribeUri -Headers $headers\n```"
                        },
                        {
                            "title": "4. Connect the Data Connector",
                            "description": "Provide your Entra ID application credentials below. You can use the **same app credentials** as the Audit.General connector. The connector will automatically use your subscription's tenant ID for authentication and API calls.",
                            "instructions": [
                                {
                                    "type": "OAuthForm",
                                    "parameters": {
                                        "clientIdLabel": "Application (Client) ID",
                                        "clientSecretLabel": "Client Secret Value",
                                        "connectButtonLabel": "Connect",
                                        "disconnectButtonLabel": "Disconnect"
                                    }
                                }
                            ]
                        }
                    ]
                }
            }
        },
        {
            "name": "[concat(variables('workspaceName'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinitionDLP')))]",
            "apiVersion": "2022-01-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinitionDLP'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinitionDLP')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersionConnectorDefinitionDLP')]",
                "source": {
                    "sourceId": "[variables('_solutionId')]",
                    "name": "[variables('_solutionName')]",
                    "kind": "Solution"
                },
                "author": {
                    "name": "[variables('_solutionAuthor')]"
                },
                "support": {
                    "name": "[variables('_solutionSupport')]",
                    "tier": "[variables('_solutionTier')]"
                },
                "dependencies": {
                    "criteria": [
                        {
                            "version": "[variables('dataConnectorVersionConnectionsDLP')]",
                            "contentId": "[variables('_dataConnectorContentIdConnectionsDLP')]",
                            "kind": "ResourcesDataConnector"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(variables('workspaceName'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections'), variables('dataConnectorVersionConnections'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/providers/contentTemplates', variables('workspaceName'), 'Microsoft.SecurityInsights', concat(variables('dataConnectorTemplateNameConnectorDefinition'), variables('dataConnectorVersionConnectorDefinition')))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnections')]",
                "displayName": "[concat(variables('_solutionName'), ' ', variables('dataConnectorTemplateNameConnections'))]",
                "contentKind": "ResourcesDataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0",
                    "parameters": {
                        "guidValue": {
                            "defaultValue": "[[newGuid()]",
                            "type": "securestring"
                        },
                        "innerWorkspace": {
                            "defaultValue": "[variables('workspaceName')]",
                            "type": "securestring"
                        },
                        "connectorDefinitionName": {
                            "defaultValue": "M365AuditGeneralCCPDefinition",
                            "type": "securestring",
                            "minLength": 1
                        },
                        "workspace": {
                            "defaultValue": "[variables('workspaceName')]",
                            "type": "securestring"
                        },
                        "dcrConfig": {
                            "type": "object",
                            "defaultValue": {
                                "dataCollectionEndpoint": "[reference(resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dataCollectionEndpointName')), '2022-06-01').logsIngestion.endpoint]",
                                "dataCollectionRuleImmutableId": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', variables('dataCollectionRuleName')), '2022-06-01').immutableId]"
                            }
                        },
                        "clientId": {
                            "type": "securestring",
                            "defaultValue": "-NA-",
                            "minLength": 1
                        },
                        "clientSecret": {
                            "type": "securestring",
                            "defaultValue": "-NA-",
                            "minLength": 1
                        }
                    },
                    "variables": {
                        "_dataConnectorContentIdConnections": "[variables('_dataConnectorContentIdConnections')]"
                    },
                    "resources": [
                        {
                            "name": "[concat(variables('workspaceName'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections')))]",
                            "apiVersion": "2022-01-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections'))]",
                                "contentId": "[variables('_dataConnectorContentIdConnections')]",
                                "kind": "ResourcesDataConnector",
                                "version": "[variables('dataConnectorVersionConnections')]",
                                "source": {
                                    "sourceId": "[variables('_solutionId')]",
                                    "name": "[variables('_solutionName')]",
                                    "kind": "Solution"
                                },
                                "author": {
                                    "name": "[variables('_solutionAuthor')]"
                                },
                                "support": {
                                    "name": "[variables('_solutionSupport')]",
                                    "tier": "[variables('_solutionTier')]"
                                }
                            }
                        },
                        {
                            "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/','M365AuditGeneralPolling', parameters('guidValue'))]",
                            "apiVersion": "2023-02-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
                            "location": "[parameters('workspace-location')]",
                            "kind": "RestApiPoller",
                            "properties": {
                                "connectorDefinitionName": "M365AuditGeneralCCPDefinition",
                                "dataType": "M365AuditGeneral_CL",
                                "dcrConfig": {
                                    "streamName": "Custom-M365AuditGeneralInput",
                                    "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                                    "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                                },
                                "auth": {
                                    "type": "OAuth2",
                                    "ClientId": "[[parameters('clientId')]",
                                    "ClientSecret": "[[parameters('clientSecret')]",
                                    "GrantType": "client_credentials",
                                    "TokenEndpoint": "[concat(environment().authentication.loginEndpoint, subscription().tenantId, '/oauth2/v2.0/token')]",
                                    "TokenEndpointHeaders": {
                                        "Content-Type": "application/x-www-form-urlencoded"
                                    },
                                    "TokenEndpointQueryParameters": {},
                                    "Scope": "https://manage.office.com/.default"
                                },
                                "request": {
                                    "apiEndpoint": "[concat('https://manage.office.com/api/v1.0/', subscription().tenantId, '/activity/feed/subscriptions/content?contentType=Audit.General&PublisherIdentifier=', subscription().tenantId)]",
                                    "httpMethod": "GET",
                                    "rateLimitQPS": 10,
                                    "queryWindowInMin": 5,
                                    "queryTimeFormat": "yyyy-MM-ddTHH:mm:ss",
                                    "retryCount": 3,
                                    "timeoutInSeconds": 60,
                                    "headers": {
                                        "Accept": "application/json"
                                    },
                                    "queryParameters": {
                                        "startTime": "{_QueryWindowStartTime}",
                                        "endTime": "{_QueryWindowEndTime}"
                                    },
                                    "isPostPayloadJson": false
                                },
                                "response": {
                                    "eventsJsonPaths": [
                                        "$[*]"
                                    ],
                                    "format": "json"
                                },
                                "paging": {
                                    "pagingType": "NextPageUrl",
                                    "nextPageParaName": "NextPageUri",
                                    "nextPageTokenJsonPath": "$.NextPageUri"
                                },
                                "stepInfo": {
                                    "stepType": "Nested",
                                    "nextSteps": [
                                        {
                                            "stepId": "fetchContentData",
                                            "stepPlaceholdersParsingKql": "source | project res = parse_json(data) | project contentUri = replace(@'\\$', '%24', tostring(res.contentUri))"
                                        }
                                    ]
                                },
                                "stepCollectorConfigs": {
                                    "fetchContentData": {
                                        "shouldJoinNestedData": false,
                                        "request": {
                                            "apiEndpoint": "$contentUri$",
                                            "httpMethod": "GET",
                                            "headers": {
                                                "Accept": "application/json"
                                            }
                                        },
                                        "response": {
                                            "eventsJsonPaths": [
                                                "$[*]"
                                            ],
                                            "format": "json"
                                        }
                                    }
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(substring(variables('_solutionId'), 0, 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections'),'-', variables('dataConnectorVersionConnections'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('_solutionVersion')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(variables('workspaceName'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectionsDLP'), variables('dataConnectorVersionConnectionsDLP'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/providers/contentTemplates', variables('workspaceName'), 'Microsoft.SecurityInsights', concat(variables('dataConnectorTemplateNameConnectorDefinitionDLP'), variables('dataConnectorVersionConnectorDefinitionDLP')))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnectionsDLP')]",
                "displayName": "[concat(variables('_solutionName'), ' ', variables('dataConnectorTemplateNameConnectionsDLP'))]",
                "contentKind": "ResourcesDataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0",
                    "parameters": {
                        "guidValue": {
                            "defaultValue": "[[newGuid()]",
                            "type": "securestring"
                        },
                        "innerWorkspace": {
                            "defaultValue": "[variables('workspaceName')]",
                            "type": "securestring"
                        },
                        "connectorDefinitionName": {
                            "defaultValue": "M365AuditDLPCCPDefinition",
                            "type": "securestring",
                            "minLength": 1
                        },
                        "workspace": {
                            "defaultValue": "[variables('workspaceName')]",
                            "type": "securestring"
                        },
                        "dcrConfig": {
                            "type": "object",
                            "defaultValue": {
                                "dataCollectionEndpoint": "[reference(resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dataCollectionEndpointName')), '2022-06-01').logsIngestion.endpoint]",
                                "dataCollectionRuleImmutableId": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', variables('dataCollectionRuleName')), '2022-06-01').immutableId]"
                            }
                        },
                        "clientId": {
                            "type": "securestring",
                            "defaultValue": "-NA-",
                            "minLength": 1
                        },
                        "clientSecret": {
                            "type": "securestring",
                            "defaultValue": "-NA-",
                            "minLength": 1
                        }
                    },
                    "variables": {
                        "_dataConnectorContentIdConnectionsDLP": "[variables('_dataConnectorContentIdConnectionsDLP')]"
                    },
                    "resources": [
                        {
                            "name": "[concat(variables('workspaceName'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectionsDLP')))]",
                            "apiVersion": "2022-01-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnectionsDLP'))]",
                                "contentId": "[variables('_dataConnectorContentIdConnectionsDLP')]",
                                "kind": "ResourcesDataConnector",
                                "version": "[variables('dataConnectorVersionConnectionsDLP')]",
                                "source": {
                                    "sourceId": "[variables('_solutionId')]",
                                    "name": "[variables('_solutionName')]",
                                    "kind": "Solution"
                                },
                                "author": {
                                    "name": "[variables('_solutionAuthor')]"
                                },
                                "support": {
                                    "name": "[variables('_solutionSupport')]",
                                    "tier": "[variables('_solutionTier')]"
                                }
                            }
                        },
                        {
                            "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/','M365AuditDLPPolling', parameters('guidValue'))]",
                            "apiVersion": "2023-02-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
                            "location": "[parameters('workspace-location')]",
                            "kind": "RestApiPoller",
                            "properties": {
                                "connectorDefinitionName": "M365AuditDLPCCPDefinition",
                                "dataType": "M365AuditGeneral_CL",
                                "dcrConfig": {
                                    "streamName": "Custom-M365AuditGeneralInput",
                                    "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                                    "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                                },
                                "auth": {
                                    "type": "OAuth2",
                                    "ClientId": "[[parameters('clientId')]",
                                    "ClientSecret": "[[parameters('clientSecret')]",
                                    "GrantType": "client_credentials",
                                    "TokenEndpoint": "[concat(environment().authentication.loginEndpoint, subscription().tenantId, '/oauth2/v2.0/token')]",
                                    "TokenEndpointHeaders": {
                                        "Content-Type": "application/x-www-form-urlencoded"
                                    },
                                    "TokenEndpointQueryParameters": {},
                                    "Scope": "https://manage.office.com/.default"
                                },
                                "request": {
                                    "apiEndpoint": "[concat('https://manage.office.com/api/v1.0/', subscription().tenantId, '/activity/feed/subscriptions/content?contentType=DLP.All&PublisherIdentifier=', subscription().tenantId)]",
                                    "httpMethod": "GET",
                                    "rateLimitQPS": 10,
                                    "queryWindowInMin": 5,
                                    "queryTimeFormat": "yyyy-MM-ddTHH:mm:ss",
                                    "retryCount": 3,
                                    "timeoutInSeconds": 60,
                                    "headers": {
                                        "Accept": "application/json"
                                    },
                                    "queryParameters": {
                                        "startTime": "{_QueryWindowStartTime}",
                                        "endTime": "{_QueryWindowEndTime}"
                                    },
                                    "isPostPayloadJson": false
                                },
                                "response": {
                                    "eventsJsonPaths": [
                                        "$[*]"
                                    ],
                                    "format": "json"
                                },
                                "paging": {
                                    "pagingType": "NextPageUrl",
                                    "nextPageParaName": "NextPageUri",
                                    "nextPageTokenJsonPath": "$.NextPageUri"
                                },
                                "stepInfo": {
                                    "stepType": "Nested",
                                    "nextSteps": [
                                        {
                                            "stepId": "fetchContentData",
                                            "stepPlaceholdersParsingKql": "source | project res = parse_json(data) | project contentUri = replace(@'\\$', '%24', tostring(res.contentUri))"
                                        }
                                    ]
                                },
                                "stepCollectorConfigs": {
                                    "fetchContentData": {
                                        "shouldJoinNestedData": false,
                                        "request": {
                                            "apiEndpoint": "$contentUri$",
                                            "httpMethod": "GET",
                                            "headers": {
                                                "Accept": "application/json"
                                            }
                                        },
                                        "response": {
                                            "eventsJsonPaths": [
                                                "$[*]"
                                            ],
                                            "format": "json"
                                        }
                                    }
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(substring(variables('_solutionId'), 0, 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnectionsDLP'),'-', variables('dataConnectorVersionConnectionsDLP'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('_solutionVersion')]"
            }
        }
    ]
}
