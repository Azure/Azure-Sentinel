[
    {
        "name": "M365AuditGeneralPolling",
        "apiVersion": "2023-02-01-preview",
        "type": "Microsoft.SecurityInsights/dataConnectors",
        "location": "{{location}}",
        "kind": "RestApiPoller",
        "properties": {
            "connectorDefinitionName": "M365AuditGeneralCCPDefinition",
            "dataType": "M365AuditGeneral_CL",
            "dcrConfig": {
                "streamName": "Custom-M365AuditGeneralInput",
                "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
                "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
            },
            "auth": {
                "type": "OAuth2",
                "ClientId": "{{clientId}}",
                "ClientSecret": "{{clientSecret}}",
                "GrantType": "client_credentials",
                "TokenEndpoint": "{{tokenEndpoint}}",
                "TokenEndpointHeaders": {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                "TokenEndpointQueryParameters": {},
                "Scope": "https://manage.office.com/.default"
            },
            "request": {
                "apiEndpoint": "{{apiEndpoint}}",
                "httpMethod": "GET",
                "rateLimitQPS": 10,
                "queryWindowInMin": 5,
                "queryTimeFormat": "yyyy-MM-ddTHH:mm:ss",
                "retryCount": 3,
                "timeoutInSeconds": 60,
                "headers": {
                    "Accept": "application/json"
                },
                "queryParameters": {
                    "startTime": "{_QueryWindowStartTime}",
                    "endTime": "{_QueryWindowEndTime}"
                },
                "isPostPayloadJson": false
            },
            "response": {
                "eventsJsonPaths": [
                    "$[*]"
                ],
                "format": "json"
            },
            "paging": {
                "pagingType": "NextPageUrl",
                "nextPageParaName": "NextPageUri",
                "nextPageTokenJsonPath": "$.NextPageUri"
            },
            "stepInfo": {
                "stepType": "Nested",
                "nextSteps": [
                    {
                        "stepId": "fetchContentData",
                        "stepPlaceholdersParsingKql": "source | project res = parse_json(data) | project contentUri = replace(@'\\$', '%24', tostring(res.contentUri))"
                    }
                ]
            },
            "stepCollectorConfigs": {
                "fetchContentData": {
                    "shouldJoinNestedData": false,
                    "request": {
                        "apiEndpoint": "$contentUri$",
                        "httpMethod": "GET",
                        "headers": {
                            "Accept": "application/json"
                        }
                    },
                    "response": {
                        "eventsJsonPaths": [
                            "$[*]"
                        ],
                        "format": "json"
                    }
                }
            }
        }
    }
]
