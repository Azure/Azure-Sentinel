{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "author": "SOCRadar - integration@socradar.io",
        "comments": "Solution template for SOCRadar"
    },
    "parameters": {
        "location": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
            }
        },
        "workspace-location": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
            }
        },
        "workspace": {
            "defaultValue": "",
            "type": "string",
            "metadata": {
                "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
            }
        },
        "workbook1-name": {
            "type": "string",
            "defaultValue": "SOCRadar Dashboard",
            "minLength": 1,
            "metadata": {
                "description": "Name for the workbook"
            }
        }
    },
    "variables": {
        "email": "integration@socradar.io",
        "_email": "[variables('email')]",
        "_solutionName": "SOCRadar",
        "_solutionVersion": "3.0.3",
        "solutionId": "socradar.azure-sentinel-solution-socradar",
        "_solutionId": "[variables('solutionId')]",
        "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]",
        "workbookVersion1": "1.0.0",
        "workbookContentId1": "SOCRadarDashboard",
        "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
        "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
        "_workbookContentId1": "[variables('workbookContentId1')]",
        "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
        "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
        "huntingQueryObject1": {
            "huntingQueryVersion1": "1.0.0",
            "_huntingQuerycontentId1": "12a3dfda-ab80-4664-aed9-7f6f9f3b4a23",
            "huntingQueryTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('12a3dfda-ab80-4664-aed9-7f6f9f3b4a23')))]"
        },
        "huntingQueryObject2": {
            "huntingQueryVersion2": "1.0.0",
            "_huntingQuerycontentId2": "ffa80945-44de-4900-bda5-9f1410c60166",
            "huntingQueryTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('ffa80945-44de-4900-bda5-9f1410c60166')))]"
        },
        "huntingQueryObject3": {
            "huntingQueryVersion3": "1.0.0",
            "_huntingQuerycontentId3": "bbafd1c6-8da9-4de3-b100-6964dedd3f3e",
            "huntingQueryTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('bbafd1c6-8da9-4de3-b100-6964dedd3f3e')))]"
        },
        "huntingQueryObject4": {
            "huntingQueryVersion4": "1.0.0",
            "_huntingQuerycontentId4": "3a665ce4-b824-4a79-861b-c9f80ab4daba",
            "huntingQueryTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('3a665ce4-b824-4a79-861b-c9f80ab4daba')))]"
        },
        "huntingQueryObject5": {
            "huntingQueryVersion5": "1.0.0",
            "_huntingQuerycontentId5": "afae44e5-e2e2-4f0e-9535-2aeb3766a847",
            "huntingQueryTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('afae44e5-e2e2-4f0e-9535-2aeb3766a847')))]"
        },
        "SOCRadar-Alarm-Import": "SOCRadar-Alarm-Import",
        "_SOCRadar-Alarm-Import": "[variables('SOCRadar-Alarm-Import')]",
        "TemplateEmptyArray": "[json('[]')]",
        "blanks": "[replace('b', 'b', '')]",
        "playbookVersion1": "1.0",
        "playbookContentId1": "SOCRadar-Alarm-Import",
        "_playbookContentId1": "[variables('playbookContentId1')]",
        "playbookId1": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
        "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId1'))))]",
        "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
        "SOCRadar-Alarm-Sync": "SOCRadar-Alarm-Sync",
        "_SOCRadar-Alarm-Sync": "[variables('SOCRadar-Alarm-Sync')]",
        "playbookVersion2": "1.0",
        "playbookContentId2": "SOCRadar-Alarm-Sync",
        "_playbookContentId2": "[variables('playbookContentId2')]",
        "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
        "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))))]",
        "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
        "SOCRadar-Alarms-Infrastructure": "SOCRadar-Alarms-Infrastructure",
        "_SOCRadar-Alarms-Infrastructure": "[variables('SOCRadar-Alarms-Infrastructure')]",
        "playbookVersion3": "1.0",
        "playbookContentId3": "SOCRadar-Alarms-Infrastructure",
        "_playbookContentId3": "[variables('playbookContentId3')]",
        "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
        "playbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3'))))]",
        "_playbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId3'),'-', variables('playbookVersion3'))))]",
        "SOCRadar-Audit-Infrastructure": "SOCRadar-Audit-Infrastructure",
        "_SOCRadar-Audit-Infrastructure": "[variables('SOCRadar-Audit-Infrastructure')]",
        "playbookVersion4": "1.0",
        "playbookContentId4": "SOCRadar-Audit-Infrastructure",
        "_playbookContentId4": "[variables('playbookContentId4')]",
        "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
        "playbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4'))))]",
        "_playbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId4'),'-', variables('playbookVersion4'))))]"
    },
    "resources": [
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
            "apiVersion": "2023-04-01-preview",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "version": "3.0.3",
                "kind": "Solution",
                "contentSchemaVersion": "3.0.0",
                "displayName": "SOCRadar",
                "publisherDisplayName": "SOCRadar",
                "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>- Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/SOCRadar/ReleaseNotes.md\">Release Notes</a></p>\n<p>- There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href=\"https://socradar.io/\">SOCRadar</a> solution for Microsoft Sentinel provides bidirectional integration between SOCRadar XTI Platform and Microsoft Sentinel. Import alarms as incidents, sync closed incidents back to SOCRadar with classification mapping.</p>\n<p><strong>Workbooks:</strong> 1, <strong>Hunting Queries:</strong> 5, <strong>Playbooks:</strong> 4</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
                "contentKind": "Solution",
                "contentProductId": "[variables('_solutioncontentProductId')]",
                "id": "[variables('_solutioncontentProductId')]",
                "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/socradar.svg\" width=\"75px\" height=\"75px\">",
                "contentId": "[variables('_solutionId')]",
                "parentId": "[variables('_solutionId')]",
                "source": {
                    "kind": "Solution",
                    "name": "SOCRadar",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "SOCRadar",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "name": "SOCRadar",
                    "email": "integration@socradar.io",
                    "tier": "Partner",
                    "link": "https://socradar.io/support"
                },
                "firstPublishDate": "2026-02-08",
                "lastPublishDate": "2026-02-19",
                "providers": [
                    "SOCRadar"
                ],
                "categories": {
                    "domains": [
                        "Security - Threat Intelligence",
                        "Security - Threat Protection"
                    ]
                }
            },
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('workbookTemplateSpecName1')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SOCRadar-Dashboard Workbook with template version 3.0.3",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('workbookVersion1')]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Insights/workbooks",
                            "name": "[variables('workbookContentId1')]",
                            "location": "[parameters('workspace-location')]",
                            "kind": "shared",
                            "apiVersion": "2021-08-01",
                            "metadata": {
                                "description": "Gain insights into SOCRadar alarms imported into Microsoft Sentinel. View alarm trends, severity distribution, top alarm types, and audit logs."
                            },
                            "properties": {
                                "displayName": "[parameters('workbook1-name')]",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# SOCRadar Integration Dashboard\\n\\nMonitor alarm imports, sync status, and analyze trends.\"},\"name\":\"header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SOCRadar_Alarms_CL | summarize Count=count() by Severity | render piechart\",\"size\":1,\"title\":\"Alarms by Severity\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"severity-chart\",\"customWidth\":\"50\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SOCRadar_Alarms_CL | summarize Count=count() by Status | render piechart\",\"size\":1,\"title\":\"Alarms by Status\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"status-chart\",\"customWidth\":\"50\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SOCRadar_Alarms_CL | summarize Count=count() by bin(TimeGenerated, 1h) | render timechart\",\"size\":1,\"title\":\"Alarms Over Time (Hourly)\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"timeline\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SOCRadar_Alarms_CL | summarize Count=count() by AlarmMainType | top 10 by Count | render barchart\",\"size\":1,\"title\":\"Top 10 Alarm Types\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"types-chart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SOCRadar_Alarms_CL | project TimeGenerated, AlarmId, Severity, AlarmMainType, AlarmSubType, Title, Status | order by TimeGenerated desc | take 50\",\"size\":1,\"title\":\"Recent Alarms (Last 50)\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"recent-alarms\"},{\"type\":1,\"content\":{\"json\":\"---\\n### Audit Logs\\nIf audit logging is enabled, you can monitor operations below.\"},\"name\":\"audit-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SOCRadarAuditLog_CL | summarize Count=count() by EventType | render piechart\",\"size\":1,\"title\":\"Audit Events by Type\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"audit-chart\",\"customWidth\":\"50\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SOCRadarAuditLog_CL | project TimeGenerated, EventType, AlarmId, Message | order by TimeGenerated desc | take 20\",\"size\":1,\"title\":\"Recent Audit Events\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"audit-table\",\"customWidth\":\"50\"}],\"fromTemplateId\":\"sentinel-SOCRadarWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\",\"isLocked\":false}\n",
                                "version": "1.0",
                                "sourceId": "[variables('workspaceResourceId')]",
                                "category": "sentinel"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
                            "properties": {
                                "description": "@{workbookKey=SOCRadarDashboard; logoFileName=socradar.svg; description=Gain insights into SOCRadar alarms imported into Microsoft Sentinel. View alarm trends, severity distribution, top alarm types, and audit logs.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=SOCRadar Dashboard; templateRelativePath=SOCRadar-Dashboard.json; subtitle=; provider=SOCRadar}.description",
                                "parentId": "[variables('workbookId1')]",
                                "contentId": "[variables('_workbookContentId1')]",
                                "kind": "Workbook",
                                "version": "[variables('workbookVersion1')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SOCRadar",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "SOCRadar",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "name": "SOCRadar",
                                    "email": "integration@socradar.io",
                                    "tier": "Partner",
                                    "link": "https://socradar.io/support"
                                },
                                "dependencies": {
                                    "operator": "AND",
                                    "criteria": [
                                        {
                                            "contentId": "SOCRadar_Alarms_CL",
                                            "kind": "DataType"
                                        },
                                        {
                                            "contentId": "SOCRadarAuditLog_CL",
                                            "kind": "DataType"
                                        }
                                    ]
                                }
                            },
                            "description": "SOCRadar Dashboard provides visibility into alarms imported from SOCRadar, alarm trends, severity distribution, and audit logs."
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_workbookContentId1')]",
                "contentKind": "Workbook",
                "displayName": "[parameters('workbook1-name')]",
                "contentProductId": "[variables('_workbookcontentProductId1')]",
                "id": "[variables('_workbookcontentProductId1')]",
                "version": "[variables('workbookVersion1')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('huntingQueryObject1').huntingQueryTemplateSpecName1]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SOCRadar-Alarm-Overview_HuntingQueries Hunting Query with template version 3.0.3",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('huntingQueryObject1').huntingQueryVersion1]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.OperationalInsights/savedSearches",
                            "apiVersion": "2022-10-01",
                            "name": "SOCRadar_Hunting_Query_1",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SOCRadar Alarm Overview",
                                "category": "Hunting Queries",
                                "query": "SOCRadar_Alarms_CL\n| summarize Count=count() by AlarmMainType, Severity\n| order by Count desc\n",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "Overview of SOCRadar alarms imported into Microsoft Sentinel, grouped by type and severity."
                                    },
                                    {
                                        "name": "tactics",
                                        "value": "Discovery"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject1')._huntingQuerycontentId1),'/'))))]",
                            "properties": {
                                "description": "SOCRadar Hunting Query 1",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject1')._huntingQuerycontentId1)]",
                                "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject1').huntingQueryVersion1]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SOCRadar",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "SOCRadar",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "name": "SOCRadar",
                                    "email": "integration@socradar.io",
                                    "tier": "Partner",
                                    "link": "https://socradar.io/support"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
                "contentKind": "HuntingQuery",
                "displayName": "SOCRadar Alarm Overview",
                "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject1')._huntingQuerycontentId1,'-', '1.0.0')))]",
                "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject1')._huntingQuerycontentId1,'-', '1.0.0')))]",
                "version": "1.0.0"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('huntingQueryObject2').huntingQueryTemplateSpecName2]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SOCRadar-Critical-Alarms_HuntingQueries Hunting Query with template version 3.0.3",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('huntingQueryObject2').huntingQueryVersion2]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.OperationalInsights/savedSearches",
                            "apiVersion": "2022-10-01",
                            "name": "SOCRadar_Hunting_Query_2",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SOCRadar Critical Alarms",
                                "category": "Hunting Queries",
                                "query": "SOCRadar_Alarms_CL\n| where Severity in (\"High\", \"Critical\")\n| project TimeGenerated, AlarmId, Title, AlarmMainType, AlarmSubType, Severity, Status\n| order by TimeGenerated desc\n",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "Hunt for high and critical severity SOCRadar alarms that may require immediate attention."
                                    },
                                    {
                                        "name": "tactics",
                                        "value": "Impact"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject2')._huntingQuerycontentId2),'/'))))]",
                            "properties": {
                                "description": "SOCRadar Hunting Query 2",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject2')._huntingQuerycontentId2)]",
                                "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject2').huntingQueryVersion2]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SOCRadar",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "SOCRadar",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "name": "SOCRadar",
                                    "email": "integration@socradar.io",
                                    "tier": "Partner",
                                    "link": "https://socradar.io/support"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
                "contentKind": "HuntingQuery",
                "displayName": "SOCRadar Critical Alarms",
                "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject2')._huntingQuerycontentId2,'-', '1.0.0')))]",
                "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject2')._huntingQuerycontentId2,'-', '1.0.0')))]",
                "version": "1.0.0"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('huntingQueryObject3').huntingQueryTemplateSpecName3]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SOCRadar-Alarm-Trends_HuntingQueries Hunting Query with template version 3.0.3",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('huntingQueryObject3').huntingQueryVersion3]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.OperationalInsights/savedSearches",
                            "apiVersion": "2022-10-01",
                            "name": "SOCRadar_Hunting_Query_3",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SOCRadar Alarm Trends",
                                "category": "Hunting Queries",
                                "query": "SOCRadar_Alarms_CL\n| where TimeGenerated > ago(7d)\n| summarize Count=count() by bin(TimeGenerated, 1h), AlarmMainType\n| order by TimeGenerated desc\n",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "Analyze SOCRadar alarm trends over the past 7 days to identify patterns and spikes."
                                    },
                                    {
                                        "name": "tactics",
                                        "value": "Discovery"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject3')._huntingQuerycontentId3),'/'))))]",
                            "properties": {
                                "description": "SOCRadar Hunting Query 3",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject3')._huntingQuerycontentId3)]",
                                "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject3').huntingQueryVersion3]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SOCRadar",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "SOCRadar",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "name": "SOCRadar",
                                    "email": "integration@socradar.io",
                                    "tier": "Partner",
                                    "link": "https://socradar.io/support"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
                "contentKind": "HuntingQuery",
                "displayName": "SOCRadar Alarm Trends",
                "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject3')._huntingQuerycontentId3,'-', '1.0.0')))]",
                "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject3')._huntingQuerycontentId3,'-', '1.0.0')))]",
                "version": "1.0.0"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('huntingQueryObject4').huntingQueryTemplateSpecName4]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SOCRadar-Incident-Correlation_HuntingQueries Hunting Query with template version 3.0.3",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('huntingQueryObject4').huntingQueryVersion4]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.OperationalInsights/savedSearches",
                            "apiVersion": "2022-10-01",
                            "name": "SOCRadar_Hunting_Query_4",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SOCRadar Incident Correlation",
                                "category": "Hunting Queries",
                                "query": "SecurityIncident\n| where Labels has \"SOCRadar\"\n| summarize Count=count() by Status, Classification\n| order by Count desc\n",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "Correlate SOCRadar alarms with Sentinel incidents to track import status and identify gaps."
                                    },
                                    {
                                        "name": "tactics",
                                        "value": "Discovery"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject4')._huntingQuerycontentId4),'/'))))]",
                            "properties": {
                                "description": "SOCRadar Hunting Query 4",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject4')._huntingQuerycontentId4)]",
                                "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject4').huntingQueryVersion4]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SOCRadar",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "SOCRadar",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "name": "SOCRadar",
                                    "email": "integration@socradar.io",
                                    "tier": "Partner",
                                    "link": "https://socradar.io/support"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
                "contentKind": "HuntingQuery",
                "displayName": "SOCRadar Incident Correlation",
                "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject4')._huntingQuerycontentId4,'-', '1.0.0')))]",
                "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject4')._huntingQuerycontentId4,'-', '1.0.0')))]",
                "version": "1.0.0"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('huntingQueryObject5').huntingQueryTemplateSpecName5]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SOCRadar-Audit-Analysis_HuntingQueries Hunting Query with template version 3.0.3",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('huntingQueryObject5').huntingQueryVersion5]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.OperationalInsights/savedSearches",
                            "apiVersion": "2022-10-01",
                            "name": "SOCRadar_Hunting_Query_5",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SOCRadar Audit Analysis",
                                "category": "Hunting Queries",
                                "query": "SOCRadarAuditLog_CL\n| summarize Count=count() by EventType\n| order by Count desc\n",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "Analyze SOCRadar audit logs to monitor import and sync operations."
                                    },
                                    {
                                        "name": "tactics",
                                        "value": "Discovery"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject5')._huntingQuerycontentId5),'/'))))]",
                            "properties": {
                                "description": "SOCRadar Hunting Query 5",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject5')._huntingQuerycontentId5)]",
                                "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject5').huntingQueryVersion5]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SOCRadar",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "SOCRadar",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "name": "SOCRadar",
                                    "email": "integration@socradar.io",
                                    "tier": "Partner",
                                    "link": "https://socradar.io/support"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
                "contentKind": "HuntingQuery",
                "displayName": "SOCRadar Audit Analysis",
                "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject5')._huntingQuerycontentId5,'-', '1.0.0')))]",
                "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject5')._huntingQuerycontentId5,'-', '1.0.0')))]",
                "version": "1.0.0"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('playbookTemplateSpecName1')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SOCRadar-Alarm-Import Playbook with template version 3.0.3",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('playbookVersion1')]",
                    "parameters": {
                        "PlaybookName": {
                            "type": "string",
                            "defaultValue": "SOCRadar-Alarm-Import",
                            "metadata": {
                                "description": "Name of the Logic App"
                            }
                        },
                        "SocradarApiKey": {
                            "type": "securestring",
                            "metadata": {
                                "description": "SOCRadar Platform API Key"
                            }
                        },
                        "CompanyId": {
                            "type": "string",
                            "metadata": {
                                "description": "SOCRadar Company ID"
                            }
                        },
                        "WorkspaceName": {
                            "type": "string",
                            "metadata": {
                                "description": "Microsoft Sentinel Log Analytics Workspace Name"
                            }
                        },
                        "PollingIntervalMinutes": {
                            "type": "int",
                            "defaultValue": 5,
                            "minValue": 1,
                            "maxValue": 60,
                            "metadata": {
                                "description": "Polling interval in minutes (1-60)"
                            }
                        },
                        "InitialLookbackMinutes": {
                            "type": "int",
                            "defaultValue": 600,
                            "minValue": 10,
                            "maxValue": 10080,
                            "metadata": {
                                "description": "Initial lookback in minutes for first run (10-10080, default 600 = 10 hours)"
                            }
                        },
                        "ImportAllStatuses": {
                            "type": "bool",
                            "defaultValue": false,
                            "metadata": {
                                "description": "Import all alarm statuses including resolved/closed. Default: only OPEN alarms"
                            }
                        },
                        "EnableAuditLogging": {
                            "type": "bool",
                            "defaultValue": false,
                            "metadata": {
                                "description": "Enable audit logging to Log Analytics custom table"
                            }
                        },
                        "AuditDcrEndpoint": {
                            "type": "string",
                            "defaultValue": "",
                            "metadata": {
                                "description": "Data Collection Rule logs ingestion endpoint (required if EnableAuditLogging=true)"
                            }
                        },
                        "AuditDcrImmutableId": {
                            "type": "string",
                            "defaultValue": "",
                            "metadata": {
                                "description": "Data Collection Rule immutable ID (required if EnableAuditLogging=true)"
                            }
                        },
                        "EnableAlarmsTable": {
                            "type": "bool",
                            "defaultValue": false,
                            "metadata": {
                                "description": "Enable writing alarms to custom Log Analytics table (SOCRadar_Alarms_CL)"
                            }
                        },
                        "DceEndpoint": {
                            "type": "string",
                            "defaultValue": "",
                            "metadata": {
                                "description": "Data Collection Endpoint URL (required if EnableAlarmsTable=true)"
                            }
                        },
                        "AlarmsDcrImmutableId": {
                            "type": "string",
                            "defaultValue": "",
                            "metadata": {
                                "description": "Alarms DCR immutable ID (required if EnableAlarmsTable=true)"
                            }
                        },
                        "AlarmsStreamName": {
                            "type": "string",
                            "defaultValue": "Custom-SOCRadar_Alarms_CL",
                            "metadata": {
                                "description": "Stream name for alarms DCR"
                            }
                        }
                    },
                    "variables": {
                        "SentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
                        "SentinelContributorRoleId": "ab8e14d6-4a74-4a29-9ba8-549422addade",
                        "LogAnalyticsReaderRoleId": "73c42c96-874c-492b-b04d-ab87d138a893",
                        "MonitoringMetricsPublisherRoleId": "3913510d-42f4-4e42-8a64-420c390055eb",
                        "AuditStreamName": "Custom-SOCRadarAuditLog_CL",
                        "connection-1": "[[subscriptionResourceId('Microsoft.Web/locations/managedApis', variables('workspace-location-inline'), 'azuresentinel')]",
                        "_connection-1": "[[variables('connection-1')]",
                        "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                        "workspace-name": "[parameters('workspace')]",
                        "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('SentinelConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('SentinelConnectionName')]",
                                "api": {
                                    "id": "[[variables('_connection-1')]"
                                },
                                "parameterValueType": "Alternative"
                            }
                        },
                        {
                            "type": "Microsoft.Logic/workflows",
                            "apiVersion": "2019-05-01",
                            "name": "[[parameters('PlaybookName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "identity": {
                                "type": "SystemAssigned"
                            },
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('SentinelConnectionName'))]"
                            ],
                            "properties": {
                                "state": "Enabled",
                                "definition": {
                                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                        "$connections": {
                                            "type": "Object"
                                        },
                                        "SocradarApiKey": {
                                            "type": "SecureString"
                                        },
                                        "EnableAuditLogging": {
                                            "type": "Bool",
                                            "defaultValue": false
                                        },
                                        "AuditDcrEndpoint": {
                                            "type": "String",
                                            "defaultValue": "[variables('blanks')]"
                                        },
                                        "AuditDcrImmutableId": {
                                            "type": "String",
                                            "defaultValue": "[variables('blanks')]"
                                        },
                                        "AuditStreamName": {
                                            "type": "String",
                                            "defaultValue": "Custom-SOCRadarAuditLog_CL"
                                        },
                                        "CompanyId": {
                                            "type": "String"
                                        },
                                        "WorkspaceName": {
                                            "type": "String"
                                        },
                                        "PollingIntervalMinutes": {
                                            "type": "Int"
                                        },
                                        "InitialLookbackMinutes": {
                                            "type": "Int"
                                        },
                                        "ImportAllStatuses": {
                                            "type": "Bool",
                                            "defaultValue": false
                                        },
                                        "EnableAlarmsTable": {
                                            "type": "Bool",
                                            "defaultValue": false
                                        },
                                        "DceEndpoint": {
                                            "type": "String",
                                            "defaultValue": "[variables('blanks')]"
                                        },
                                        "AlarmsDcrImmutableId": {
                                            "type": "String",
                                            "defaultValue": "[variables('blanks')]"
                                        },
                                        "AlarmsStreamName": {
                                            "type": "String",
                                            "defaultValue": "Custom-SOCRadar_Alarms_CL"
                                        },
                                        "SubscriptionId": {
                                            "type": "String"
                                        },
                                        "ResourceGroupName": {
                                            "type": "String"
                                        }
                                    },
                                    "triggers": {
                                        "Recurrence": {
                                            "type": "Recurrence",
                                            "recurrence": {
                                                "frequency": "Minute",
                                                "interval": "[[parameters('PollingIntervalMinutes')]"
                                            },
                                            "operationOptions": "SingleInstance"
                                        }
                                    },
                                    "actions": {
                                        "Query_Existing_SOCRadar_Incidents": {
                                            "type": "Http",
                                            "inputs": {
                                                "method": "GET",
                                                "uri": "[[concat('https://management.azure.com/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.OperationalInsights/workspaces/', parameters('WorkspaceName'), '/providers/Microsoft.SecurityInsights/incidents?api-version=2023-11-01&$top=1&$filter=startswith(properties/title, ''[SOCRadar]'')')]",
                                                "authentication": {
                                                    "type": "ManagedServiceIdentity"
                                                },
                                                "retryPolicy": {
                                                    "type": "exponential",
                                                    "count": 4,
                                                    "interval": "PT10S",
                                                    "maximumInterval": "PT1H"
                                                }
                                            }
                                        },
                                        "Determine_Lookback": {
                                            "type": "Compose",
                                            "inputs": "@if(equals(length(coalesce(body('Query_Existing_SOCRadar_Incidents')?['value'], json('[]'))), 0), parameters('InitialLookbackMinutes'), mul(parameters('PollingIntervalMinutes'), 2))",
                                            "runAfter": {
                                                "Query_Existing_SOCRadar_Incidents": [
                                                    "Succeeded"
                                                ]
                                            }
                                        },
                                        "Calculate_Epoch_Start": {
                                            "type": "Compose",
                                            "inputs": "@div(sub(ticks(addMinutes(utcNow(), mul(-1, outputs('Determine_Lookback')))), 621355968000000000), 10000000)",
                                            "runAfter": {
                                                "Determine_Lookback": [
                                                    "Succeeded"
                                                ]
                                            }
                                        },
                                        "Initialize_Page": {
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "page",
                                                        "type": "integer",
                                                        "value": 1
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Calculate_Epoch_Start": [
                                                    "Succeeded"
                                                ]
                                            }
                                        },
                                        "Initialize_Total_Pages": {
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "total_pages",
                                                        "type": "integer",
                                                        "value": 1
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Initialize_Page": [
                                                    "Succeeded"
                                                ]
                                            }
                                        },
                                        "Initialize_All_Alarms": {
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "all_alarms",
                                                        "type": "array",
                                                        "value": "[variables('TemplateEmptyArray')]"
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Initialize_Total_Pages": [
                                                    "Succeeded"
                                                ]
                                            }
                                        },
                                        "Pagination_Loop": {
                                            "type": "Until",
                                            "expression": "@greater(variables('page'), variables('total_pages'))",
                                            "limit": {
                                                "count": 1000,
                                                "timeout": "PT1H"
                                            },
                                            "actions": {
                                                "Get_SOCRadar_Page": {
                                                    "type": "Http",
                                                    "inputs": {
                                                        "method": "GET",
                                                        "uri": "https://platform.socradar.com/api/company/@{parameters('CompanyId')}/incidents/v4",
                                                        "headers": {
                                                            "API-Key": "@{parameters('SocradarApiKey')}"
                                                        },
                                                        "queries": {
                                                            "page": "@{variables('page')}",
                                                            "limit": "100",
                                                            "start_date": "@{outputs('Calculate_Epoch_Start')}",
                                                            "include_total_records": "true"
                                                        },
                                                        "retryPolicy": {
                                                            "type": "exponential",
                                                            "count": 4,
                                                            "interval": "PT10S",
                                                            "maximumInterval": "PT1H"
                                                        }
                                                    },
                                                    "runtimeConfiguration": {
                                                        "secureData": {
                                                            "properties": [
                                                                "inputs"
                                                            ]
                                                        }
                                                    }
                                                },
                                                "Parse_Page_Response": {
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@body('Get_SOCRadar_Page')",
                                                        "schema": {
                                                            "type": "object",
                                                            "properties": {
                                                                "data": {
                                                                    "type": "object",
                                                                    "properties": {
                                                                        "alarms": {
                                                                            "type": "array"
                                                                        },
                                                                        "total_pages": {
                                                                            "type": "integer"
                                                                        },
                                                                        "total_records": {
                                                                            "type": "integer"
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Get_SOCRadar_Page": [
                                                            "Succeeded"
                                                        ]
                                                    }
                                                },
                                                "Set_Total_Pages": {
                                                    "type": "If",
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "equals": [
                                                                    "@variables('page')",
                                                                    1
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "actions": {
                                                        "Update_Total_Pages": {
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "total_pages",
                                                                "value": "@coalesce(body('Parse_Page_Response')?['data']?['total_pages'], 1)"
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Parse_Page_Response": [
                                                            "Succeeded"
                                                        ]
                                                    }
                                                },
                                                "Append_Alarms": {
                                                    "type": "Compose",
                                                    "inputs": "@union(variables('all_alarms'), coalesce(body('Parse_Page_Response')?['data']?['alarms'], json('[]')))",
                                                    "runAfter": {
                                                        "Set_Total_Pages": [
                                                            "Succeeded"
                                                        ]
                                                    }
                                                },
                                                "Update_All_Alarms": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "all_alarms",
                                                        "value": "@outputs('Append_Alarms')"
                                                    },
                                                    "runAfter": {
                                                        "Append_Alarms": [
                                                            "Succeeded"
                                                        ]
                                                    }
                                                },
                                                "Increment_Page": {
                                                    "type": "IncrementVariable",
                                                    "inputs": {
                                                        "name": "page",
                                                        "value": 1
                                                    },
                                                    "runAfter": {
                                                        "Update_All_Alarms": [
                                                            "Succeeded"
                                                        ]
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Initialize_All_Alarms": [
                                                    "Succeeded"
                                                ]
                                            }
                                        },
                                        "Initialize_Existing_Incidents": {
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "existing_incidents",
                                                        "type": "array",
                                                        "value": "[variables('TemplateEmptyArray')]"
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Pagination_Loop": [
                                                    "Succeeded"
                                                ]
                                            }
                                        },
                                        "Initialize_Incidents_NextLink": {
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "incidents_next_link",
                                                        "type": "string",
                                                        "value": "[[concat('https://management.azure.com/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.OperationalInsights/workspaces/', parameters('WorkspaceName'), '/providers/Microsoft.SecurityInsights/incidents?api-version=2023-11-01&$top=1000&$filter=startswith(properties/title, ''[SOCRadar]'')')]"
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Initialize_Existing_Incidents": [
                                                    "Succeeded"
                                                ]
                                            }
                                        },
                                        "Pagination_Loop_Incidents": {
                                            "type": "Until",
                                            "expression": "@equals(variables('incidents_next_link'), '')",
                                            "limit": {
                                                "count": 100,
                                                "timeout": "PT1H"
                                            },
                                            "actions": {
                                                "Query_Incidents_Page": {
                                                    "type": "Http",
                                                    "inputs": {
                                                        "method": "GET",
                                                        "uri": "@variables('incidents_next_link')",
                                                        "authentication": {
                                                            "type": "ManagedServiceIdentity"
                                                        },
                                                        "retryPolicy": {
                                                            "type": "exponential",
                                                            "count": 4,
                                                            "interval": "PT10S",
                                                            "maximumInterval": "PT1H"
                                                        }
                                                    }
                                                },
                                                "Compose_New_Incidents": {
                                                    "type": "Compose",
                                                    "inputs": "@union(variables('existing_incidents'), coalesce(body('Query_Incidents_Page')?['value'], json('[]')))",
                                                    "runAfter": {
                                                        "Query_Incidents_Page": [
                                                            "Succeeded"
                                                        ]
                                                    }
                                                },
                                                "Set_Existing_Incidents": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "existing_incidents",
                                                        "value": "@outputs('Compose_New_Incidents')"
                                                    },
                                                    "runAfter": {
                                                        "Compose_New_Incidents": [
                                                            "Succeeded"
                                                        ]
                                                    }
                                                },
                                                "Set_Incidents_NextLink": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "incidents_next_link",
                                                        "value": "@coalesce(body('Query_Incidents_Page')?['nextLink'], '')"
                                                    },
                                                    "runAfter": {
                                                        "Set_Existing_Incidents": [
                                                            "Succeeded"
                                                        ]
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Initialize_Incidents_NextLink": [
                                                    "Succeeded"
                                                ]
                                            }
                                        },
                                        "Extract_Existing_IDs": {
                                            "type": "Select",
                                            "inputs": {
                                                "from": "@variables('existing_incidents')",
                                                "select": "@split(split(coalesce(item()?['properties']?['title'], ''), '#')[1], ' ')[0]"
                                            },
                                            "runAfter": {
                                                "Pagination_Loop_Incidents": [
                                                    "Succeeded"
                                                ]
                                            }
                                        },
                                        "For_Each_Alarm": {
                                            "type": "Foreach",
                                            "foreach": "@variables('all_alarms')",
                                            "runtimeConfiguration": {
                                                "concurrency": {
                                                    "repetitions": 5
                                                }
                                            },
                                            "actions": {
                                                "Check_If_Should_Import": {
                                                    "type": "If",
                                                    "expression": {
                                                        "or": [
                                                            {
                                                                "equals": [
                                                                    "@parameters('ImportAllStatuses')",
                                                                    true
                                                                ]
                                                            },
                                                            {
                                                                "equals": [
                                                                    "@coalesce(items('For_Each_Alarm')?['status'], 'OPEN')",
                                                                    "OPEN"
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "actions": {
                                                        "Check_If_Already_Exists": {
                                                            "type": "If",
                                                            "expression": {
                                                                "and": [
                                                                    {
                                                                        "contains": [
                                                                            "@body('Extract_Existing_IDs')",
                                                                            "@string(items('For_Each_Alarm')?['alarm_id'])"
                                                                        ]
                                                                    }
                                                                ]
                                                            },
                                                            "else": {
                                                                "actions": {
                                                                    "Map_Severity": {
                                                                        "type": "Compose",
                                                                        "inputs": "@if(or(equals(items('For_Each_Alarm')?['alarm_risk_level'], 'CRITICAL'), equals(items('For_Each_Alarm')?['alarm_risk_level'], 'HIGH')), 'High', if(equals(items('For_Each_Alarm')?['alarm_risk_level'], 'MEDIUM'), 'Medium', 'Low'))"
                                                                    },
                                                                    "Build_Tags": {
                                                                        "type": "Compose",
                                                                        "inputs": "@json(concat('[{\"Tag\": \"SOCRadar\"}', if(not(or(empty(coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_main_type'], '')), equals(items('For_Each_Alarm')?['alarm_type_details']?['alarm_main_type'], null))), concat(', {\"Tag\": \"', if(greater(length(items('For_Each_Alarm')?['alarm_type_details']?['alarm_main_type']), 100), concat(substring(items('For_Each_Alarm')?['alarm_type_details']?['alarm_main_type'], 0, 97), '...'), items('For_Each_Alarm')?['alarm_type_details']?['alarm_main_type']), '\"}'), ''), if(not(or(empty(coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_sub_type'], '')), equals(items('For_Each_Alarm')?['alarm_type_details']?['alarm_sub_type'], null))), concat(', {\"Tag\": \"', if(greater(length(items('For_Each_Alarm')?['alarm_type_details']?['alarm_sub_type']), 100), concat(substring(items('For_Each_Alarm')?['alarm_type_details']?['alarm_sub_type'], 0, 97), '...'), items('For_Each_Alarm')?['alarm_type_details']?['alarm_sub_type']), '\"}'), ''), ']'))",
                                                                        "runAfter": {
                                                                            "Map_Severity": [
                                                                                "Succeeded"
                                                                            ]
                                                                        }
                                                                    },
                                                                    "Check_If_Open_Status": {
                                                                        "type": "If",
                                                                        "expression": {
                                                                            "and": [
                                                                                {
                                                                                    "equals": [
                                                                                        "@coalesce(items('For_Each_Alarm')?['status'], 'OPEN')",
                                                                                        "OPEN"
                                                                                    ]
                                                                                }
                                                                            ]
                                                                        },
                                                                        "actions": {
                                                                            "Create_New_Incident": {
                                                                                "type": "ApiConnection",
                                                                                "inputs": {
                                                                                    "host": {
                                                                                        "connection": {
                                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                        }
                                                                                    },
                                                                                    "method": "put",
                                                                                    "path": "[[concat('/Incidents/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/workspaces/', parameters('WorkspaceName'))]",
                                                                                    "body": {
                                                                                        "title": "[[SOCRadar] #@{items('For_Each_Alarm')?['alarm_id']} - @{if(greater(length(coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_generic_title'], '')), 200), concat(substring(items('For_Each_Alarm')?['alarm_type_details']?['alarm_generic_title'], 0, 197), '...'), coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_generic_title'], 'N/A'))}",
                                                                                        "description": "@{concat('SOCRadar Alarm', decodeUriComponent('%0A'), decodeUriComponent('%0A'), 'Alarm ID: ', string(items('For_Each_Alarm')?['alarm_id']), decodeUriComponent('%0A'), decodeUriComponent('%0A'), 'Main Type: ', coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_main_type'], 'N/A'), decodeUriComponent('%0A'), decodeUriComponent('%0A'), 'Sub Type: ', coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_sub_type'], 'N/A'), decodeUriComponent('%0A'), decodeUriComponent('%0A'), 'Severity: ', items('For_Each_Alarm')?['alarm_risk_level'], decodeUriComponent('%0A'), decodeUriComponent('%0A'), 'Status: ', coalesce(items('For_Each_Alarm')?['status'], 'OPEN'), decodeUriComponent('%0A'), decodeUriComponent('%0A'), 'Created: ', items('For_Each_Alarm')?['date'], decodeUriComponent('%0A'), decodeUriComponent('%0A'), 'Details:', decodeUriComponent('%0A'), if(greater(length(coalesce(items('For_Each_Alarm')?['alarm_text'], '')), 1500), concat(substring(items('For_Each_Alarm')?['alarm_text'], 0, 1500), '...'), coalesce(items('For_Each_Alarm')?['alarm_text'], 'No details')), decodeUriComponent('%0A'), decodeUriComponent('%0A'), if(not(empty(items('For_Each_Alarm')?['content'])), concat('Content:', decodeUriComponent('%0A'), replace(replace(replace(replace(if(greater(length(string(items('For_Each_Alarm')?['content'])), 2000), concat(substring(string(items('For_Each_Alarm')?['content']), 0, 2000), '... [truncated]'), string(items('For_Each_Alarm')?['content'])), '\"', ''), '{', ''), '}', ''), ',', ' -*- '), decodeUriComponent('%0A'), decodeUriComponent('%0A')), ''), 'View in SOCRadar: https://platform.socradar.com/company/', items('For_Each_Alarm')?['company_id'], '/alarm/', items('For_Each_Alarm')?['alarm_id'])}",
                                                                                        "severity": "@{outputs('Map_Severity')}",
                                                                                        "status": "New",
                                                                                        "providerName": "SOCRadar",
                                                                                        "providerIncidentId": "@{items('For_Each_Alarm')?['alarm_id']}",
                                                                                        "tagsToAdd": {
                                                                                            "TagsToAdd": "@outputs('Build_Tags')"
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        },
                                                                        "else": {
                                                                            "actions": {
                                                                                "Map_Classification": {
                                                                                    "type": "Compose",
                                                                                    "inputs": "@if(equals(items('For_Each_Alarm')?['status'], 'FALSE_POSITIVE'), 'FalsePositive', if(equals(items('For_Each_Alarm')?['status'], 'MITIGATED'), 'BenignPositive', if(equals(items('For_Each_Alarm')?['status'], 'RESOLVED'), 'TruePositive', 'Undetermined')))"
                                                                                },
                                                                                "Map_ClassificationReason": {
                                                                                    "type": "Compose",
                                                                                    "inputs": "@if(equals(outputs('Map_Classification'), 'FalsePositive'), 'InaccurateData', if(equals(outputs('Map_Classification'), 'BenignPositive'), 'SuspiciousButExpected', 'SuspiciousActivity'))",
                                                                                    "runAfter": {
                                                                                        "Map_Classification": [
                                                                                            "Succeeded"
                                                                                        ]
                                                                                    }
                                                                                },
                                                                                "Build_Labels": {
                                                                                    "type": "Compose",
                                                                                    "inputs": "@json(concat('[{\"labelName\": \"SOCRadar\", \"labelType\": \"User\"}', if(not(or(empty(coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_main_type'], '')), equals(items('For_Each_Alarm')?['alarm_type_details']?['alarm_main_type'], null))), concat(', {\"labelName\": \"', replace(coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_main_type'], ''), '\"', ''), '\", \"labelType\": \"User\"}'), ''), if(not(or(empty(coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_sub_type'], '')), equals(items('For_Each_Alarm')?['alarm_type_details']?['alarm_sub_type'], null))), concat(', {\"labelName\": \"', replace(coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_sub_type'], ''), '\"', ''), '\", \"labelType\": \"User\"}'), ''), ']'))",
                                                                                    "runAfter": {
                                                                                        "Map_ClassificationReason": [
                                                                                            "Succeeded"
                                                                                        ]
                                                                                    }
                                                                                },
                                                                                "Build_Base_Properties": {
                                                                                    "type": "Compose",
                                                                                    "inputs": {
                                                                                        "title": "[[SOCRadar] #@{items('For_Each_Alarm')?['alarm_id']} - @{if(greater(length(coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_generic_title'], '')), 200), concat(substring(items('For_Each_Alarm')?['alarm_type_details']?['alarm_generic_title'], 0, 197), '...'), coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_generic_title'], 'N/A'))}",
                                                                                        "description": "@{concat('SOCRadar Alarm - Status: ', items('For_Each_Alarm')?['status'], ' - Alarm ID: ', string(items('For_Each_Alarm')?['alarm_id']))}",
                                                                                        "severity": "@{outputs('Map_Severity')}",
                                                                                        "status": "Closed",
                                                                                        "classification": "@{outputs('Map_Classification')}",
                                                                                        "labels": "@outputs('Build_Labels')"
                                                                                    },
                                                                                    "runAfter": {
                                                                                        "Build_Labels": [
                                                                                            "Succeeded"
                                                                                        ]
                                                                                    }
                                                                                },
                                                                                "Add_ClassificationReason_If_Needed": {
                                                                                    "type": "Compose",
                                                                                    "inputs": "@if(equals(outputs('Map_Classification'), 'Undetermined'), outputs('Build_Base_Properties'), setProperty(outputs('Build_Base_Properties'), 'classificationReason', outputs('Map_ClassificationReason')))",
                                                                                    "runAfter": {
                                                                                        "Build_Base_Properties": [
                                                                                            "Succeeded"
                                                                                        ]
                                                                                    }
                                                                                },
                                                                                "Create_Closed_Incident": {
                                                                                    "type": "Http",
                                                                                    "inputs": {
                                                                                        "method": "PUT",
                                                                                        "uri": "https://management.azure.com/subscriptions/@{parameters('SubscriptionId')}/resourceGroups/@{parameters('ResourceGroupName')}/providers/Microsoft.OperationalInsights/workspaces/@{parameters('WorkspaceName')}/providers/Microsoft.SecurityInsights/incidents/@{guid()}?api-version=2023-11-01",
                                                                                        "headers": {
                                                                                            "Content-Type": "application/json"
                                                                                        },
                                                                                        "authentication": {
                                                                                            "type": "ManagedServiceIdentity",
                                                                                            "audience": "https://management.azure.com"
                                                                                        },
                                                                                        "body": {
                                                                                            "properties": "@outputs('Add_ClassificationReason_If_Needed')"
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {
                                                                                        "Add_ClassificationReason_If_Needed": [
                                                                                            "Succeeded"
                                                                                        ]
                                                                                    }
                                                                                }
                                                                            }
                                                                        },
                                                                        "runAfter": {
                                                                            "Build_Tags": [
                                                                                "Succeeded"
                                                                            ]
                                                                        }
                                                                    },
                                                                    "Check_Audit_Enabled": {
                                                                        "type": "If",
                                                                        "runAfter": {
                                                                            "Check_If_Open_Status": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "expression": {
                                                                            "and": [
                                                                                {
                                                                                    "equals": [
                                                                                        "@parameters('EnableAuditLogging')",
                                                                                        true
                                                                                    ]
                                                                                }
                                                                            ]
                                                                        },
                                                                        "actions": {
                                                                            "Log_Audit_Event": {
                                                                                "type": "Http",
                                                                                "inputs": {
                                                                                    "method": "POST",
                                                                                    "uri": "@{concat(parameters('AuditDcrEndpoint'), '/dataCollectionRules/', parameters('AuditDcrImmutableId'), '/streams/', parameters('AuditStreamName'), '?api-version=2023-01-01')}",
                                                                                    "headers": {
                                                                                        "Content-Type": "application/json"
                                                                                    },
                                                                                    "authentication": {
                                                                                        "type": "ManagedServiceIdentity",
                                                                                        "audience": "https://monitor.azure.com"
                                                                                    },
                                                                                    "body": [
                                                                                        {
                                                                                            "TimeGenerated": "@{utcNow()}",
                                                                                            "EventType": "AlarmImported",
                                                                                            "AlarmId": "@{items('For_Each_Alarm')?['alarm_id']}",
                                                                                            "IncidentId": "@{items('For_Each_Alarm')?['alarm_id']}",
                                                                                            "AlarmType": "@{coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_main_type'], 'N/A')}",
                                                                                            "Status": "@{items('For_Each_Alarm')?['status']}",
                                                                                            "Severity": "@{items('For_Each_Alarm')?['alarm_risk_level']}",
                                                                                            "Message": "Alarm imported to Sentinel",
                                                                                            "FullAlarmJson": "@items('For_Each_Alarm')"
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            }
                                                                        }
                                                                    },
                                                                    "Check_Alarms_Table_Enabled": {
                                                                        "type": "If",
                                                                        "runAfter": {
                                                                            "Check_Audit_Enabled": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "expression": {
                                                                            "and": [
                                                                                {
                                                                                    "equals": [
                                                                                        "@parameters('EnableAlarmsTable')",
                                                                                        true
                                                                                    ]
                                                                                }
                                                                            ]
                                                                        },
                                                                        "actions": {
                                                                            "Ingest_To_Custom_Table": {
                                                                                "type": "Http",
                                                                                "inputs": {
                                                                                    "method": "POST",
                                                                                    "uri": "@{concat(parameters('DceEndpoint'), '/dataCollectionRules/', parameters('AlarmsDcrImmutableId'), '/streams/', parameters('AlarmsStreamName'), '?api-version=2023-01-01')}",
                                                                                    "headers": {
                                                                                        "Content-Type": "application/json"
                                                                                    },
                                                                                    "authentication": {
                                                                                        "type": "ManagedServiceIdentity",
                                                                                        "audience": "https://monitor.azure.com"
                                                                                    },
                                                                                    "body": [
                                                                                        {
                                                                                            "TimeGenerated": "@{utcNow()}",
                                                                                            "AlarmId": "@{string(items('For_Each_Alarm')?['alarm_id'])}",
                                                                                            "CompanyId": "@{parameters('CompanyId')}",
                                                                                            "AlarmMainType": "@{coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_main_type'], 'Unknown')}",
                                                                                            "AlarmSubType": "@{coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_sub_type'], 'Unknown')}",
                                                                                            "Severity": "@{coalesce(items('For_Each_Alarm')?['alarm_risk_level'], 'MEDIUM')}",
                                                                                            "Status": "@{coalesce(items('For_Each_Alarm')?['status'], 'OPEN')}",
                                                                                            "Title": "@{coalesce(items('For_Each_Alarm')?['alarm_type_details']?['alarm_generic_title'], 'SOCRadar Alarm')}",
                                                                                            "AlarmText": "@{take(coalesce(items('For_Each_Alarm')?['alarm_text'], ''), 4000)}",
                                                                                            "AlarmDate": "@{items('For_Each_Alarm')?['date']}",
                                                                                            "AlarmPayload": "@items('For_Each_Alarm')"
                                                                                        }
                                                                                    ],
                                                                                    "retryPolicy": {
                                                                                        "type": "exponential",
                                                                                        "count": 3,
                                                                                        "interval": "PT10S",
                                                                                        "maximumInterval": "PT1M"
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Extract_Existing_IDs": [
                                                    "Succeeded"
                                                ]
                                            }
                                        }
                                    }
                                },
                                "parameters": {
                                    "$connections": {
                                        "value": {
                                            "azuresentinel": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('SentinelConnectionName'))]",
                                                "connectionName": "[[variables('SentinelConnectionName')]",
                                                "connectionProperties": {
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity"
                                                    }
                                                },
                                                "id": "[[subscriptionResourceId('Microsoft.Web/locations/managedApis', variables('workspace-location-inline'), 'azuresentinel')]"
                                            }
                                        }
                                    },
                                    "SocradarApiKey": {
                                        "value": "[[parameters('SocradarApiKey')]"
                                    },
                                    "CompanyId": {
                                        "value": "[[parameters('CompanyId')]"
                                    },
                                    "WorkspaceName": {
                                        "value": "[[parameters('WorkspaceName')]"
                                    },
                                    "PollingIntervalMinutes": {
                                        "value": "[[parameters('PollingIntervalMinutes')]"
                                    },
                                    "InitialLookbackMinutes": {
                                        "value": "[[parameters('InitialLookbackMinutes')]"
                                    },
                                    "ImportAllStatuses": {
                                        "value": "[[parameters('ImportAllStatuses')]"
                                    },
                                    "EnableAuditLogging": {
                                        "value": "[[parameters('EnableAuditLogging')]"
                                    },
                                    "AuditDcrEndpoint": {
                                        "value": "[[parameters('AuditDcrEndpoint')]"
                                    },
                                    "AuditDcrImmutableId": {
                                        "value": "[[parameters('AuditDcrImmutableId')]"
                                    },
                                    "AuditStreamName": {
                                        "value": "[[variables('AuditStreamName')]"
                                    },
                                    "EnableAlarmsTable": {
                                        "value": "[[parameters('EnableAlarmsTable')]"
                                    },
                                    "DceEndpoint": {
                                        "value": "[[parameters('DceEndpoint')]"
                                    },
                                    "AlarmsDcrImmutableId": {
                                        "value": "[[parameters('AlarmsDcrImmutableId')]"
                                    },
                                    "AlarmsStreamName": {
                                        "value": "[[parameters('AlarmsStreamName')]"
                                    },
                                    "SubscriptionId": {
                                        "value": "[[subscription().subscriptionId]"
                                    },
                                    "ResourceGroupName": {
                                        "value": "[[resourceGroup().name]"
                                    }
                                }
                            },
                            "tags": {
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                            }
                        },
                        {
                            "type": "Microsoft.Authorization/roleAssignments",
                            "apiVersion": "2022-04-01",
                            "name": "[[guid(resourceGroup().id, parameters('PlaybookName'), variables('SentinelContributorRoleId'))]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Logic/workflows', parameters('PlaybookName'))]"
                            ],
                            "properties": {
                                "roleDefinitionId": "[[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('SentinelContributorRoleId'))]",
                                "principalId": "[[reference(resourceId('Microsoft.Logic/workflows', parameters('PlaybookName')), '2019-05-01', 'Full').identity.principalId]",
                                "principalType": "ServicePrincipal"
                            }
                        },
                        {
                            "type": "Microsoft.Authorization/roleAssignments",
                            "apiVersion": "2022-04-01",
                            "name": "[[guid(resourceId('Microsoft.OperationalInsights/workspaces', parameters('WorkspaceName')), parameters('PlaybookName'), variables('LogAnalyticsReaderRoleId'))]",
                            "scope": "[[resourceId('Microsoft.OperationalInsights/workspaces', parameters('WorkspaceName'))]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Logic/workflows', parameters('PlaybookName'))]"
                            ],
                            "properties": {
                                "roleDefinitionId": "[[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('LogAnalyticsReaderRoleId'))]",
                                "principalId": "[[reference(resourceId('Microsoft.Logic/workflows', parameters('PlaybookName')), '2019-05-01', 'Full').identity.principalId]",
                                "principalType": "ServicePrincipal"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId1'),'/'))))]",
                            "properties": {
                                "parentId": "[variables('playbookId1')]",
                                "contentId": "[variables('_playbookContentId1')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion1')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SOCRadar",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "SOCRadar",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "name": "SOCRadar",
                                    "email": "integration@socradar.io",
                                    "tier": "Partner",
                                    "link": "https://socradar.io/support"
                                }
                            }
                        }
                    ],
                    "metadata": {
                        "title": "SOCRadar-Alarm-Import",
                        "description": "Imports alarms from SOCRadar with optional audit logging and custom table storage. Supports all statuses or OPEN only.",
                        "version": "3.29.0",
                        "lastUpdateTime": "2026-02-06T00:00:00Z",
                        "releaseNotes": {
                            "version": "1.0",
                            "title": "[variables('blanks')]",
                            "notes": [
                                "Initial version"
                            ]
                        }
                    }
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_playbookContentId1')]",
                "contentKind": "Playbook",
                "displayName": "SOCRadar-Alarm-Import",
                "contentProductId": "[variables('_playbookcontentProductId1')]",
                "id": "[variables('_playbookcontentProductId1')]",
                "version": "[variables('playbookVersion1')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('playbookTemplateSpecName2')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SOCRadar-Alarm-Sync Playbook with template version 3.0.3",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('playbookVersion2')]",
                    "parameters": {
                        "PlaybookName": {
                            "type": "string",
                            "defaultValue": "SOCRadar-Alarm-Sync",
                            "metadata": {
                                "description": "Name of the Logic App"
                            }
                        },
                        "SocradarApiKey": {
                            "type": "securestring",
                            "metadata": {
                                "description": "SOCRadar Platform API Key"
                            }
                        },
                        "CompanyId": {
                            "type": "string",
                            "metadata": {
                                "description": "SOCRadar Company ID"
                            }
                        },
                        "WorkspaceName": {
                            "type": "string",
                            "metadata": {
                                "description": "Microsoft Sentinel Log Analytics Workspace Name"
                            }
                        },
                        "PollingIntervalMinutes": {
                            "type": "int",
                            "defaultValue": 5,
                            "minValue": 1,
                            "maxValue": 1440,
                            "metadata": {
                                "description": "Polling interval in minutes (1-1440)"
                            }
                        }
                    },
                    "variables": {
                        "SentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
                        "SentinelContributorRoleId": "ab8e14d6-4a74-4a29-9ba8-549422addade",
                        "connection-1": "[[subscriptionResourceId('Microsoft.Web/locations/managedApis', variables('workspace-location-inline'), 'azuresentinel')]",
                        "_connection-1": "[[variables('connection-1')]",
                        "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                        "workspace-name": "[parameters('workspace')]",
                        "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('SentinelConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('SentinelConnectionName')]",
                                "api": {
                                    "id": "[[variables('_connection-1')]"
                                },
                                "parameterValueType": "Alternative"
                            }
                        },
                        {
                            "type": "Microsoft.Logic/workflows",
                            "apiVersion": "2019-05-01",
                            "name": "[[parameters('PlaybookName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "identity": {
                                "type": "SystemAssigned"
                            },
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('SentinelConnectionName'))]"
                            ],
                            "properties": {
                                "state": "Enabled",
                                "definition": {
                                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                        "$connections": {
                                            "type": "Object"
                                        },
                                        "SocradarApiKey": {
                                            "type": "SecureString"
                                        },
                                        "CompanyId": {
                                            "type": "String"
                                        },
                                        "WorkspaceName": {
                                            "type": "String"
                                        },
                                        "PollingIntervalMinutes": {
                                            "type": "Int"
                                        }
                                    },
                                    "triggers": {
                                        "Recurrence": {
                                            "type": "Recurrence",
                                            "recurrence": {
                                                "frequency": "Minute",
                                                "interval": "[[parameters('PollingIntervalMinutes')]"
                                            }
                                        }
                                    },
                                    "actions": {
                                        "Calculate_Lookback_Time": {
                                            "type": "Compose",
                                            "inputs": "@addMinutes(utcNow(), mul(-2, parameters('PollingIntervalMinutes')))"
                                        },
                                        "Initialize_Closed_Incidents": {
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "closed_incidents",
                                                        "type": "array",
                                                        "value": "[variables('TemplateEmptyArray')]"
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Calculate_Lookback_Time": [
                                                    "Succeeded"
                                                ]
                                            }
                                        },
                                        "Initialize_Closed_NextLink": {
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "closed_next_link",
                                                        "type": "string",
                                                        "value": "[[concat('https://management.azure.com/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.OperationalInsights/workspaces/', parameters('WorkspaceName'), '/providers/Microsoft.SecurityInsights/incidents?api-version=2023-11-01&$top=1000&$filter=properties/labels/any(label: label/labelName eq ''SOCRadar'') and properties/status eq ''Closed'' and properties/lastModifiedTimeUtc ge @{outputs(''Calculate_Lookback_Time'')}')]"
                                                    }
                                                ]
                                            },
                                            "runAfter": {
                                                "Initialize_Closed_Incidents": [
                                                    "Succeeded"
                                                ]
                                            }
                                        },
                                        "Pagination_Loop_Closed": {
                                            "type": "Until",
                                            "expression": "@equals(variables('closed_next_link'), '')",
                                            "limit": {
                                                "count": 100,
                                                "timeout": "PT1H"
                                            },
                                            "actions": {
                                                "Query_Closed_Page": {
                                                    "type": "Http",
                                                    "inputs": {
                                                        "method": "GET",
                                                        "uri": "@variables('closed_next_link')",
                                                        "authentication": {
                                                            "type": "ManagedServiceIdentity"
                                                        },
                                                        "retryPolicy": {
                                                            "type": "exponential",
                                                            "count": 4,
                                                            "interval": "PT10S",
                                                            "maximumInterval": "PT1H"
                                                        }
                                                    }
                                                },
                                                "Compose_New_Closed": {
                                                    "type": "Compose",
                                                    "inputs": "@union(variables('closed_incidents'), coalesce(body('Query_Closed_Page')?['value'], json('[]')))",
                                                    "runAfter": {
                                                        "Query_Closed_Page": [
                                                            "Succeeded"
                                                        ]
                                                    }
                                                },
                                                "Set_Closed_Incidents": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "closed_incidents",
                                                        "value": "@outputs('Compose_New_Closed')"
                                                    },
                                                    "runAfter": {
                                                        "Compose_New_Closed": [
                                                            "Succeeded"
                                                        ]
                                                    }
                                                },
                                                "Set_Closed_NextLink": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "closed_next_link",
                                                        "value": "@coalesce(body('Query_Closed_Page')?['nextLink'], '')"
                                                    },
                                                    "runAfter": {
                                                        "Set_Closed_Incidents": [
                                                            "Succeeded"
                                                        ]
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Initialize_Closed_NextLink": [
                                                    "Succeeded"
                                                ]
                                            }
                                        },
                                        "For_Each_Incident": {
                                            "type": "Foreach",
                                            "foreach": "@variables('closed_incidents')",
                                            "runtimeConfiguration": {
                                                "concurrency": {
                                                    "repetitions": 5
                                                }
                                            },
                                            "actions": {
                                                "Extract_Alarm_ID": {
                                                    "type": "Compose",
                                                    "inputs": "@split(split(items('For_Each_Incident')?['properties']?['title'], '#')[1], ' ')[0]"
                                                },
                                                "Check_Has_Synced_Tag": {
                                                    "type": "Compose",
                                                    "inputs": "@contains(string(coalesce(items('For_Each_Incident')?['properties']?['labels'], json('[]'))), 'Synced')",
                                                    "runAfter": {
                                                        "Extract_Alarm_ID": [
                                                            "Succeeded"
                                                        ]
                                                    }
                                                },
                                                "Check_If_Closed_And_Not_Synced": {
                                                    "type": "If",
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "equals": [
                                                                    "@items('For_Each_Incident')?['properties']?['status']",
                                                                    "Closed"
                                                                ]
                                                            },
                                                            {
                                                                "equals": [
                                                                    "@outputs('Check_Has_Synced_Tag')",
                                                                    false
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "actions": {
                                                        "Update_SOCRadar_Status": {
                                                            "type": "Http",
                                                            "inputs": {
                                                                "method": "POST",
                                                                "uri": "https://platform.socradar.com/api/company/@{parameters('CompanyId')}/alarms/status/change",
                                                                "headers": {
                                                                    "API-Key": "@{parameters('SocradarApiKey')}",
                                                                    "Content-Type": "application/json"
                                                                },
                                                                "body": {
                                                                    "alarm_ids": "@createArray(int(outputs('Extract_Alarm_ID')))",
                                                                    "status": "@{if(equals(items('For_Each_Incident')?['properties']?['classification'], 'FalsePositive'), 9, if(equals(items('For_Each_Incident')?['properties']?['classification'], 'BenignPositive'), 12, 2))}",
                                                                    "comments": "Closed in Microsoft Sentinel (Classification: @{coalesce(items('For_Each_Incident')?['properties']?['classification'], 'Unclassified')})"
                                                                },
                                                                "retryPolicy": {
                                                                    "type": "exponential",
                                                                    "count": 4,
                                                                    "interval": "PT10S",
                                                                    "maximumInterval": "PT1H"
                                                                }
                                                            },
                                                            "runtimeConfiguration": {
                                                                "secureData": {
                                                                    "properties": [
                                                                        "inputs"
                                                                    ]
                                                                }
                                                            }
                                                        },
                                                        "Map_Severity": {
                                                            "type": "Compose",
                                                            "inputs": "@coalesce(items('For_Each_Incident')?['properties']?['severity'], 'Medium')",
                                                            "runAfter": {
                                                                "Update_SOCRadar_Status": [
                                                                    "Succeeded"
                                                                ]
                                                            }
                                                        },
                                                        "Update_SOCRadar_Severity": {
                                                            "type": "Http",
                                                            "inputs": {
                                                                "method": "POST",
                                                                "uri": "https://platform.socradar.com/api/company/@{parameters('CompanyId')}/alarm/severity",
                                                                "headers": {
                                                                    "API-Key": "@{parameters('SocradarApiKey')}",
                                                                    "Content-Type": "application/json"
                                                                },
                                                                "body": {
                                                                    "alarm_ids": "@createArray(int(outputs('Extract_Alarm_ID')))",
                                                                    "severity": "@{outputs('Map_Severity')}"
                                                                },
                                                                "retryPolicy": {
                                                                    "type": "exponential",
                                                                    "count": 4,
                                                                    "interval": "PT10S",
                                                                    "maximumInterval": "PT1H"
                                                                }
                                                            },
                                                            "runtimeConfiguration": {
                                                                "secureData": {
                                                                    "properties": [
                                                                        "inputs"
                                                                    ]
                                                                }
                                                            },
                                                            "runAfter": {
                                                                "Map_Severity": [
                                                                    "Succeeded"
                                                                ]
                                                            }
                                                        },
                                                        "Add_Synced_Tag": {
                                                            "type": "Http",
                                                            "inputs": {
                                                                "method": "PUT",
                                                                "uri": "[[concat('https://management.azure.com/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.OperationalInsights/workspaces/', parameters('WorkspaceName'), '/providers/Microsoft.SecurityInsights/incidents/@{items(''For_Each_Incident'')?[''name'']}?api-version=2023-11-01')]",
                                                                "authentication": {
                                                                    "type": "ManagedServiceIdentity"
                                                                },
                                                                "headers": {
                                                                    "Content-Type": "application/json"
                                                                },
                                                                "body": {
                                                                    "etag": "@{items('For_Each_Incident')?['etag']}",
                                                                    "properties": {
                                                                        "title": "@{items('For_Each_Incident')?['properties']?['title']}",
                                                                        "description": "@{items('For_Each_Incident')?['properties']?['description']}",
                                                                        "status": "@{items('For_Each_Incident')?['properties']?['status']}",
                                                                        "severity": "@{items('For_Each_Incident')?['properties']?['severity']}",
                                                                        "classification": "@{items('For_Each_Incident')?['properties']?['classification']}",
                                                                        "classificationReason": "@{items('For_Each_Incident')?['properties']?['classificationReason']}",
                                                                        "classificationComment": "@{items('For_Each_Incident')?['properties']?['classificationComment']}",
                                                                        "owner": "@items('For_Each_Incident')?['properties']?['owner']",
                                                                        "labels": "@union(coalesce(items('For_Each_Incident')?['properties']?['labels'], json('[]')), json('[{\"labelName\": \"Synced\", \"labelType\": \"User\"}]'))",
                                                                        "firstActivityTimeUtc": "@{items('For_Each_Incident')?['properties']?['firstActivityTimeUtc']}",
                                                                        "lastActivityTimeUtc": "@{items('For_Each_Incident')?['properties']?['lastActivityTimeUtc']}"
                                                                    }
                                                                },
                                                                "retryPolicy": {
                                                                    "type": "exponential",
                                                                    "count": 4,
                                                                    "interval": "PT10S",
                                                                    "maximumInterval": "PT1H"
                                                                }
                                                            },
                                                            "runAfter": {
                                                                "Update_SOCRadar_Severity": [
                                                                    "Succeeded",
                                                                    "Failed",
                                                                    "Skipped",
                                                                    "TimedOut"
                                                                ]
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Check_Has_Synced_Tag": [
                                                            "Succeeded"
                                                        ]
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Pagination_Loop_Closed": [
                                                    "Succeeded"
                                                ]
                                            }
                                        }
                                    }
                                },
                                "parameters": {
                                    "$connections": {
                                        "value": {
                                            "azuresentinel": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('SentinelConnectionName'))]",
                                                "connectionName": "[[variables('SentinelConnectionName')]",
                                                "connectionProperties": {
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity"
                                                    }
                                                },
                                                "id": "[[subscriptionResourceId('Microsoft.Web/locations/managedApis', variables('workspace-location-inline'), 'azuresentinel')]"
                                            }
                                        }
                                    },
                                    "SocradarApiKey": {
                                        "value": "[[parameters('SocradarApiKey')]"
                                    },
                                    "CompanyId": {
                                        "value": "[[parameters('CompanyId')]"
                                    },
                                    "WorkspaceName": {
                                        "value": "[[parameters('WorkspaceName')]"
                                    },
                                    "PollingIntervalMinutes": {
                                        "value": "[[parameters('PollingIntervalMinutes')]"
                                    }
                                }
                            },
                            "tags": {
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                            }
                        },
                        {
                            "type": "Microsoft.Authorization/roleAssignments",
                            "apiVersion": "2022-04-01",
                            "name": "[[guid(resourceGroup().id, parameters('PlaybookName'), variables('SentinelContributorRoleId'))]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Logic/workflows', parameters('PlaybookName'))]"
                            ],
                            "properties": {
                                "roleDefinitionId": "[[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('SentinelContributorRoleId'))]",
                                "principalId": "[[reference(resourceId('Microsoft.Logic/workflows', parameters('PlaybookName')), '2019-05-01', 'Full').identity.principalId]",
                                "principalType": "ServicePrincipal"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
                            "properties": {
                                "parentId": "[variables('playbookId2')]",
                                "contentId": "[variables('_playbookContentId2')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion2')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SOCRadar",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "SOCRadar",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "name": "SOCRadar",
                                    "email": "integration@socradar.io",
                                    "tier": "Partner",
                                    "link": "https://socradar.io/support"
                                }
                            }
                        }
                    ],
                    "metadata": {
                        "title": "SOCRadar-Alarm-Sync",
                        "description": "Syncs closed incidents from Microsoft Sentinel back to SOCRadar platform. Uses Synced tag to prevent duplicate syncs. Filters by: SOCRadar tag + Closed status + lastModified. Now with pagination for 1000+ incidents.",
                        "version": "2.9.0",
                        "lastUpdateTime": "2026-02-06T00:00:00Z",
                        "releaseNotes": {
                            "version": "1.0",
                            "title": "[variables('blanks')]",
                            "notes": [
                                "Initial version"
                            ]
                        }
                    }
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_playbookContentId2')]",
                "contentKind": "Playbook",
                "displayName": "SOCRadar-Alarm-Sync",
                "contentProductId": "[variables('_playbookcontentProductId2')]",
                "id": "[variables('_playbookcontentProductId2')]",
                "version": "[variables('playbookVersion2')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('playbookTemplateSpecName3')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SOCRadar-Alarms-Infrastructure Playbook with template version 3.0.3",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('playbookVersion3')]",
                    "parameters": {
                        "WorkspaceName": {
                            "type": "string",
                            "metadata": {
                                "description": "Microsoft Sentinel Log Analytics Workspace Name"
                            }
                        },
                        "TableRetentionDays": {
                            "type": "int",
                            "defaultValue": 90,
                            "minValue": 30,
                            "maxValue": 730,
                            "metadata": {
                                "description": "Data retention in days (30-730)"
                            }
                        }
                    },
                    "variables": {
                        "workspaceResourceId": "[[resourceId('Microsoft.OperationalInsights/workspaces', parameters('WorkspaceName'))]",
                        "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                        "workspace-name": "[parameters('workspace')]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Insights/dataCollectionEndpoints",
                            "apiVersion": "2023-03-11",
                            "name": "SOCRadar-DCE",
                            "location": "[[variables('workspace-location-inline')]",
                            "properties": {
                                "description": "Data Collection Endpoint for SOCRadar integration",
                                "networkAcls": {
                                    "publicNetworkAccess": "Enabled"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/tables",
                            "apiVersion": "2022-10-01",
                            "name": "[[concat(parameters('WorkspaceName'), '/SOCRadar_Alarms_CL')]",
                            "properties": {
                                "schema": {
                                    "name": "SOCRadar_Alarms_CL",
                                    "columns": [
                                        {
                                            "name": "TimeGenerated",
                                            "type": "datetime",
                                            "description": "Ingestion timestamp"
                                        },
                                        {
                                            "name": "AlarmId",
                                            "type": "string",
                                            "description": "SOCRadar alarm ID"
                                        },
                                        {
                                            "name": "CompanyId",
                                            "type": "string",
                                            "description": "SOCRadar company ID"
                                        },
                                        {
                                            "name": "AlarmMainType",
                                            "type": "string",
                                            "description": "Main alarm category"
                                        },
                                        {
                                            "name": "AlarmSubType",
                                            "type": "string",
                                            "description": "Alarm sub-category"
                                        },
                                        {
                                            "name": "Severity",
                                            "type": "string",
                                            "description": "CRITICAL/HIGH/MEDIUM/LOW/INFO"
                                        },
                                        {
                                            "name": "Status",
                                            "type": "string",
                                            "description": "Alarm status"
                                        },
                                        {
                                            "name": "Title",
                                            "type": "string",
                                            "description": "Alarm title"
                                        },
                                        {
                                            "name": "AlarmText",
                                            "type": "string",
                                            "description": "Alarm description (truncated to 4000 chars)"
                                        },
                                        {
                                            "name": "AlarmDate",
                                            "type": "string",
                                            "description": "Original alarm date from SOCRadar"
                                        },
                                        {
                                            "name": "AlarmPayload",
                                            "type": "dynamic",
                                            "description": "Full SOCRadar alarm JSON"
                                        }
                                    ]
                                },
                                "retentionInDays": "[[parameters('TableRetentionDays')]",
                                "plan": "Analytics"
                            }
                        },
                        {
                            "type": "Microsoft.Insights/dataCollectionRules",
                            "apiVersion": "2023-03-11",
                            "name": "SOCRadar-Alarms-DCR",
                            "location": "[[variables('workspace-location-inline')]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Insights/dataCollectionEndpoints', 'SOCRadar-DCE')]",
                                "[[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('WorkspaceName'), 'SOCRadar_Alarms_CL')]"
                            ],
                            "properties": {
                                "description": "DCR for SOCRadar alarms ingestion",
                                "dataCollectionEndpointId": "[[resourceId('Microsoft.Insights/dataCollectionEndpoints', 'SOCRadar-DCE')]",
                                "streamDeclarations": {
                                    "Custom-SOCRadar_Alarms_CL": {
                                        "columns": [
                                            {
                                                "name": "TimeGenerated",
                                                "type": "datetime"
                                            },
                                            {
                                                "name": "AlarmId",
                                                "type": "string"
                                            },
                                            {
                                                "name": "CompanyId",
                                                "type": "string"
                                            },
                                            {
                                                "name": "AlarmMainType",
                                                "type": "string"
                                            },
                                            {
                                                "name": "AlarmSubType",
                                                "type": "string"
                                            },
                                            {
                                                "name": "Severity",
                                                "type": "string"
                                            },
                                            {
                                                "name": "Status",
                                                "type": "string"
                                            },
                                            {
                                                "name": "Title",
                                                "type": "string"
                                            },
                                            {
                                                "name": "AlarmText",
                                                "type": "string"
                                            },
                                            {
                                                "name": "AlarmDate",
                                                "type": "string"
                                            },
                                            {
                                                "name": "AlarmPayload",
                                                "type": "dynamic"
                                            }
                                        ]
                                    }
                                },
                                "destinations": {
                                    "logAnalytics": [
                                        {
                                            "workspaceResourceId": "[[variables('workspaceResourceId')]",
                                            "name": "workspace"
                                        }
                                    ]
                                },
                                "dataFlows": [
                                    {
                                        "streams": [
                                            "Custom-SOCRadar_Alarms_CL"
                                        ],
                                        "destinations": [
                                            "workspace"
                                        ],
                                        "transformKql": "source",
                                        "outputStream": "Custom-SOCRadar_Alarms_CL"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
                            "properties": {
                                "parentId": "[variables('playbookId3')]",
                                "contentId": "[variables('_playbookContentId3')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion3')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SOCRadar",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "SOCRadar",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "name": "SOCRadar",
                                    "email": "integration@socradar.io",
                                    "tier": "Partner",
                                    "link": "https://socradar.io/support"
                                }
                            }
                        }
                    ],
                    "metadata": {
                        "title": "SOCRadar-Alarms-Infrastructure",
                        "description": "Creates DCE, Custom Table and DCR for storing SOCRadar alarms in Log Analytics",
                        "version": "1.0.0",
                        "lastUpdateTime": "2026-02-19T00:00:00Z",
                        "releaseNotes": {
                            "version": "1.0",
                            "title": "[variables('blanks')]",
                            "notes": [
                                "Initial version"
                            ]
                        }
                    }
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_playbookContentId3')]",
                "contentKind": "Playbook",
                "displayName": "SOCRadar-Alarms-Infrastructure",
                "contentProductId": "[variables('_playbookcontentProductId3')]",
                "id": "[variables('_playbookcontentProductId3')]",
                "version": "[variables('playbookVersion3')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('playbookTemplateSpecName4')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SOCRadar-Audit-Infrastructure Playbook with template version 3.0.3",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('playbookVersion4')]",
                    "parameters": {
                        "WorkspaceName": {
                            "type": "string",
                            "metadata": {
                                "description": "Microsoft Sentinel Log Analytics Workspace Name"
                            }
                        },
                        "TableRetentionDays": {
                            "type": "int",
                            "defaultValue": 30,
                            "minValue": 7,
                            "maxValue": 730,
                            "metadata": {
                                "description": "Retention period for audit logs in days (7-730)"
                            }
                        }
                    },
                    "variables": {
                        "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                        "workspace-name": "[parameters('workspace')]",
                        "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/tables",
                            "apiVersion": "2022-10-01",
                            "name": "[[concat(parameters('WorkspaceName'), '/SOCRadarAuditLog_CL')]",
                            "properties": {
                                "schema": {
                                    "name": "SOCRadarAuditLog_CL",
                                    "columns": [
                                        {
                                            "name": "TimeGenerated",
                                            "type": "datetime",
                                            "description": "Event timestamp"
                                        },
                                        {
                                            "name": "EventType",
                                            "type": "string",
                                            "description": "Type: AlarmImported, AlarmSynced, Error"
                                        },
                                        {
                                            "name": "AlarmId",
                                            "type": "string",
                                            "description": "SOCRadar alarm ID"
                                        },
                                        {
                                            "name": "IncidentId",
                                            "type": "string",
                                            "description": "Sentinel incident ID"
                                        },
                                        {
                                            "name": "AlarmType",
                                            "type": "string",
                                            "description": "Main alarm type"
                                        },
                                        {
                                            "name": "Status",
                                            "type": "string",
                                            "description": "Alarm status"
                                        },
                                        {
                                            "name": "Severity",
                                            "type": "string",
                                            "description": "Alarm severity"
                                        },
                                        {
                                            "name": "Message",
                                            "type": "string",
                                            "description": "Details or error message"
                                        },
                                        {
                                            "name": "FullAlarmJson",
                                            "type": "dynamic",
                                            "description": "Complete SOCRadar alarm object"
                                        }
                                    ]
                                },
                                "retentionInDays": "[[parameters('TableRetentionDays')]",
                                "plan": "Analytics"
                            }
                        },
                        {
                            "type": "Microsoft.Insights/dataCollectionRules",
                            "apiVersion": "2023-03-11",
                            "name": "SOCRadar-Audit-DCR",
                            "location": "[[variables('workspace-location-inline')]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('WorkspaceName'), 'SOCRadarAuditLog_CL')]"
                            ],
                            "kind": "Direct",
                            "properties": {
                                "description": "DCR for SOCRadar audit log ingestion",
                                "streamDeclarations": {
                                    "Custom-SOCRadarAuditLog_CL": {
                                        "columns": [
                                            {
                                                "name": "TimeGenerated",
                                                "type": "datetime"
                                            },
                                            {
                                                "name": "EventType",
                                                "type": "string"
                                            },
                                            {
                                                "name": "AlarmId",
                                                "type": "string"
                                            },
                                            {
                                                "name": "IncidentId",
                                                "type": "string"
                                            },
                                            {
                                                "name": "AlarmType",
                                                "type": "string"
                                            },
                                            {
                                                "name": "Status",
                                                "type": "string"
                                            },
                                            {
                                                "name": "Severity",
                                                "type": "string"
                                            },
                                            {
                                                "name": "Message",
                                                "type": "string"
                                            },
                                            {
                                                "name": "FullAlarmJson",
                                                "type": "dynamic"
                                            }
                                        ]
                                    }
                                },
                                "destinations": {
                                    "logAnalytics": [
                                        {
                                            "workspaceResourceId": "[[resourceId('Microsoft.OperationalInsights/workspaces', parameters('WorkspaceName'))]",
                                            "name": "workspace"
                                        }
                                    ]
                                },
                                "dataFlows": [
                                    {
                                        "streams": [
                                            "Custom-SOCRadarAuditLog_CL"
                                        ],
                                        "destinations": [
                                            "workspace"
                                        ],
                                        "transformKql": "source",
                                        "outputStream": "Custom-SOCRadarAuditLog_CL"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
                            "properties": {
                                "parentId": "[variables('playbookId4')]",
                                "contentId": "[variables('_playbookContentId4')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion4')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SOCRadar",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "SOCRadar",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "name": "SOCRadar",
                                    "email": "integration@socradar.io",
                                    "tier": "Partner",
                                    "link": "https://socradar.io/support"
                                }
                            }
                        }
                    ],
                    "metadata": {
                        "title": "SOCRadar-Audit-Infrastructure",
                        "description": "Creates Log Analytics custom table and Data Collection Rule for SOCRadar audit logging",
                        "version": "1.1.0",
                        "lastUpdateTime": "2026-02-19T00:00:00Z",
                        "releaseNotes": {
                            "version": "1.0",
                            "title": "[variables('blanks')]",
                            "notes": [
                                "Initial version"
                            ]
                        }
                    }
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_playbookContentId4')]",
                "contentKind": "Playbook",
                "displayName": "SOCRadar-Audit-Infrastructure",
                "contentProductId": "[variables('_playbookcontentProductId4')]",
                "id": "[variables('_playbookcontentProductId4')]",
                "version": "[variables('playbookVersion4')]"
            }
        }
    ],
    "outputs": {}
}