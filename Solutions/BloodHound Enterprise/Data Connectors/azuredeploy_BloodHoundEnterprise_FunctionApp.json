{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "functionAppName": {
      "type": "String",
      "metadata": {
        "description": "Name of the Function App. This must be unique across Azure, since each instance requires its own Function App (e.g., BloodHoundEnterprise-Maple)."
      }
    },
    "logAnalyticsWorkspaceName": {
      "type": "String",
      "metadata": {
        "description": "The name of the existing Log Analytics Workspace where you want to create a Data Collection Endpoint (DCE) and Data Collection Rule (DCR) for custom tables."
      }
    },
    "bloodhoundTenantDomain": {
      "type": "String",
      "metadata": {
        "description": "The URL for the BloodHound Enterprise tenant domain."
      }
    },
    "Bloodhound-Token-Id-Secret-Value": {
      "type": "SecureString",
      "metadata": {
        "description": "The value for the BloodHound token ID. This value will be stored in an Azure Key Vault secret."
      }
    },
    "Bloodhound-Token-Key-Secret-Value": {
      "type": "SecureString",
      "metadata": {
        "description": "The value for the BloodHound token key. This value will be stored in an Azure Key Vault secret."
      }
    },
    "microsoftEntraIdApplicationAppId": {
      "type": "String",
      "metadata": {
        "description": "The unique identifier for the Microsoft Entra ID application. This ID, also known as the Client ID, is used to authenticate your application to the Microsoft identity platform."
      }
    },
    "microsoftEntraIdApplicationAppSecret": {
      "type": "SecureString",
      "metadata": {
        "description": "A confidential secret generated for your Microsoft Entra ID application. This secret, also known as the Client Secret, is used along with the App ID to prove the application's identity when requesting an access token."
      }
    },
    "lookupDays": {
      "defaultValue": 2,
      "type": "Int",
      "metadata": {
        "description": "Specifies the number of days in the past for which the system should fetch data. A higher value means more historical data will be retrieved, which increases the time and compute resources required, during the first iteration when setting up the system. This parameter sets the default lookback period when no previous timestamp is available."
      }
    },
    "selectedBloodhoundEnvironments": {
      "defaultValue": "All",
      "type": "String",
      "metadata": {
        "description": "The selected BloodHound environments from which you want to fetch data. These should be provided as comma-separated values (e.g., Ghost.Corp, Phantom.Corp). The default value is All."
      }
    },
    "selectedFindingTypes": {
      "defaultValue": "All",
      "type": "String",
      "metadata": {
        "description": "The selected finding types."
      }
    },
    "utcTimeZone": {
      "type": "String",
      "metadata": {
        "description": "The UTC time zone to use for the Function App."
      },
      "defaultValue": "[utcNow()]"
    }
  },
  "variables": {
    "storageAccountName": "[concat(toLower(parameters('functionAppName')), 'sa')]",
    "appServicePlanName": "[concat(parameters('functionAppName'), 'plan')]",
    "attackPathsTable": "BHEAttackPathsData_CL",
    "attackPathsTimelineTable": "BHEAttackPathsTimelineData_CL",
    "auditLogsTable": "BHEAuditLogsData_CL",
    "findingTrendsTable": "BHEFindingTrendsData_CL",
    "postureHistoryTable": "BHEPostureHistoryData_CL",
    "tierZeroAssetsTable": "BHETierZeroAssetsData_CL",
    "bheAttackPathsTable": "BHEAttackPathsData_CL",
    "bheAuditLogsTable": "BHEAuditLogsData_CL",
    "bheFindingTrendsTable": "BHEFindingTrendsData_CL",
    "bhePostureHistoryTable": "BHEPostureHistoryData_CL",
    "bheTierZeroAssetsTable": "BHETierZeroAssetsData_CL",
    "bheAttackPathsTimelineTable": "BHEAttackPathsTimelineData_CL",
    "microsoftEntraIdApplicationAppId": "[parameters('microsoftEntraIdApplicationAppId')]",
    "microsoftEntraIdApplicationAppSecret": "[parameters('microsoftEntraIdApplicationAppSecret')]",
    "applicationInsightsName": "[parameters('functionAppName')]",
    "subscriptionId": "[subscription().subscriptionId]",
    "logAnalyticsWorkspaceLocation": "[resourceGroup().location]",
    "logAnalyticsWorkspaceResourceGroupName": "[resourceGroup().name]",
    "tenantId": "[subscription().tenantId]",
    "storageAccountType": "Standard_LRS",
    "keyVaultName": "[concat('kv-', toLower(parameters('functionAppName')))]",
    "bloodhoundTokenIdSecretName": "Bloodhound-Token-Id-Secret-Value",
    "bloodhoundTokenKeySecretName": "Bloodhound-Token-Key-Secret-Value",
    "dceName": "BloodHoundDCE",
    "dcrName": "BloodHoundDCR",
    "managedIdentityName": "[concat('deploymentScriptIdentity-', parameters('functionAppName'))]",
    "storageBlobDataContributorRoleId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
    "deploymentContainerName": "deploymentpackage",
    "zipFileName": "[concat(parameters('functionAppName'), '.zip')]",
    "zipFileUrl": "https://github.com/metron-labs/Azure-Sentinel/blob/bloodhound/Solutions/BloodHound%20Enterprise/Data%20Connectors/BloodHoundDataConnector/BloodHoundAzureFunction.zip?raw=true"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/dataCollectionEndpoints",
      "apiVersion": "2023-03-11",
      "name": "[variables('dceName')]",
      "location": "[variables('logAnalyticsWorkspaceLocation')]",
      "properties": {
        "networkAcls": {
          "publicNetworkAccess": "Enabled"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "apiVersion": "2022-10-01",
      "name": "[concat(parameters('logAnalyticsWorkspaceName'), '/', variables('bheAttackPathsTable'))]",
      "properties": {
        "schema": {
          "name": "[variables('bheAttackPathsTable')]",
          "columns": [
            {
              "name": "TimeGenerated",
              "type": "datetime"
            },
            {
              "name": "IngestionTime",
              "type": "datetime"
            },
            {
              "name": "NonTierZeroPrincipal",
              "type": "string"
            },
            {
              "name": "ImpactedPrincipal",
              "type": "string"
            },
            {
              "name": "domain_name",
              "type": "string"
            },
            {
              "name": "NonTierZeroPrincipalProps",
              "type": "dynamic"
            },
            {
              "name": "NonTierZeroPrincipalKind",
              "type": "string"
            },
            {
              "name": "ImpactedPrincipalProps",
              "type": "dynamic"
            },
            {
              "name": "ImpactedPrincipalKind",
              "type": "string"
            },
            {
              "name": "RelProps",
              "type": "dynamic"
            },
            {
              "name": "ComboGraphRelationID",
              "type": "int"
            },
            {
              "name": "Finding",
              "type": "string"
            },
            {
              "name": "DomainSID",
              "type": "string"
            },
            {
              "name": "PrincipalHash",
              "type": "string"
            },
            {
              "name": "ImpactPercentage",
              "type": "string"
            },
            {
              "name": "ImpactCount",
              "type": "int"
            },
            {
              "name": "ExposurePercentage",
              "type": "string"
            },
            {
              "name": "ExposureCount",
              "type": "int"
            },
            {
              "name": "Severity",
              "type": "string"
            },
            {
              "name": "AcceptedUntil",
              "type": "string"
            },
            {
              "name": "Accepted",
              "type": "boolean"
            },
            {
              "name": "Environment",
              "type": "string"
            },
            {
              "name": "NonTierZeroPrincipalName",
              "type": "string"
            },
            {
              "name": "ImpactedPrincipalName",
              "type": "string"
            },
            {
              "name": "IsInherited",
              "type": "string"
            },
            {
              "name": "NonTierZeroPrincipalEnvironment",
              "type": "string"
            },
            {
              "name": "NonTierZeroPrincipalEnvironmentID",
              "type": "string"
            },
            {
              "name": "ImpactedPrincipalEnvironment",
              "type": "string"
            },
            {
              "name": "ImpactedPrincipalEnvironmentID",
              "type": "string"
            },
            {
              "name": "id",
              "type": "int"
            },
            {
              "name": "created_at",
              "type": "datetime"
            },
            {
              "name": "updated_at",
              "type": "datetime"
            },
            {
              "name": "deleted_at",
              "type": "dynamic"
            },
            {
              "name": "tenant_url",
              "type": "string"
            },
            {
              "name": "Remediation",
              "type": "string"
            },
            {
              "name": "PathTitle",
              "type": "string"
            },
            {
              "name": "ShortDescription",
              "type": "string"
            },
            {
              "name": "ShortRemediation",
              "type": "string"
            },
            {
              "name": "LongRemediation",
              "type": "string"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "apiVersion": "2022-10-01",
      "name": "[concat(parameters('logAnalyticsWorkspaceName'), '/', variables('bheAuditLogsTable'))]",
      "properties": {
        "schema": {
          "name": "[variables('bheAuditLogsTable')]",
          "columns": [
            {
              "name": "TimeGenerated",
              "type": "datetime"
            },
            {
              "name": "IngestionTime",
              "type": "datetime"
            },
            {
              "name": "id",
              "type": "int"
            },
            {
              "name": "created_at",
              "type": "datetime"
            },
            {
              "name": "actor_id",
              "type": "string"
            },
            {
              "name": "actor_name",
              "type": "string"
            },
            {
              "name": "actor_email",
              "type": "string"
            },
            {
              "name": "action",
              "type": "string"
            },
            {
              "name": "fields",
              "type": "dynamic"
            },
            {
              "name": "request_id",
              "type": "string"
            },
            {
              "name": "source_ip_address",
              "type": "string"
            },
            {
              "name": "status",
              "type": "string"
            },
            {
              "name": "commit_id",
              "type": "string"
            },
            {
              "name": "tenant_url",
              "type": "string"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "apiVersion": "2022-10-01",
      "name": "[concat(parameters('logAnalyticsWorkspaceName'), '/', variables('bheFindingTrendsTable'))]",
      "properties": {
        "schema": {
          "name": "[variables('bheFindingTrendsTable')]",
          "columns": [
            {
              "name": "TimeGenerated",
              "type": "datetime"
            },
            {
              "name": "IngestionTime",
              "type": "datetime"
            },
            {
              "name": "composite_risk",
              "type": "string"
            },
            {
              "name": "display_title",
              "type": "string"
            },
            {
              "name": "display_type",
              "type": "string"
            },
            {
              "name": "environment_id",
              "type": "string"
            },
            {
              "name": "exposure_count",
              "type": "int"
            },
            {
              "name": "finding",
              "type": "string"
            },
            {
              "name": "finding_count_decrease",
              "type": "int"
            },
            {
              "name": "finding_count_end",
              "type": "int"
            },
            {
              "name": "finding_count_increase",
              "type": "int"
            },
            {
              "name": "finding_count_start",
              "type": "int"
            },
            {
              "name": "impact_count",
              "type": "int"
            },
            {
              "name": "tenant_url",
              "type": "string"
            },
            {
              "name": "domain_name",
              "type": "string"
            },
            {
              "name": "start_date",
              "type": "datetime"
            },
            {
              "name": "end_date",
              "type": "datetime"
            },
            {
              "name": "period",
              "type": "string"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "apiVersion": "2022-10-01",
      "name": "[concat(parameters('logAnalyticsWorkspaceName'), '/', variables('bhePostureHistoryTable'))]",
      "properties": {
        "schema": {
          "name": "[variables('bhePostureHistoryTable')]",
          "columns": [
            {
              "name": "TimeGenerated",
              "type": "datetime"
            },
            {
              "name": "IngestionTime",
              "type": "datetime"
            },
            {
              "name": "metric_date",
              "type": "datetime"
            },
            {
              "name": "value",
              "type": "string"
            },
            {
              "name": "start_time",
              "type": "datetime"
            },
            {
              "name": "end_time",
              "type": "datetime"
            },
            {
              "name": "domain_id",
              "type": "string"
            },
            {
              "name": "data_type",
              "type": "string"
            },
            {
              "name": "domain_name",
              "type": "string"
            },
            {
              "name": "tenant_url",
              "type": "string"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "apiVersion": "2022-10-01",
      "name": "[concat(parameters('logAnalyticsWorkspaceName'), '/', variables('bheTierZeroAssetsTable'))]",
      "properties": {
        "schema": {
          "name": "[variables('bheTierZeroAssetsTable')]",
          "columns": [
            {
              "name": "TimeGenerated",
              "type": "datetime"
            },
            {
              "name": "IngestionTime",
              "type": "datetime"
            },
            {
              "name": "nodeId",
              "type": "string"
            },
            {
              "name": "label",
              "type": "string"
            },
            {
              "name": "kindType",
              "type": "string"
            },
            {
              "name": "objectId",
              "type": "string"
            },
            {
              "name": "isTierZero",
              "type": "boolean"
            },
            {
              "name": "isOwnedObject",
              "type": "boolean"
            },
            {
              "name": "lastSeen",
              "type": "datetime"
            },
            {
              "name": "tenant_url",
              "type": "string"
            },
            {
              "name": "domain_name",
              "type": "string"
            },
            {
              "name": "name",
              "type": "string"
            },
            {
              "name": "properties",
              "type": "dynamic"
            },
            {
              "name": "displayname",
              "type": "string"
            },
            {
              "name": "description",
              "type": "string"
            },
            {
              "name": "distinguishedname",
              "type": "string"
            },
            {
              "name": "samaccountname",
              "type": "string"
            },
            {
              "name": "userprincipalname",
              "type": "string"
            },
            {
              "name": "email",
              "type": "string"
            },
            {
              "name": "Title",
              "type": "string"
            },
            {
              "name": "domain",
              "type": "string"
            },
            {
              "name": "domainsid",
              "type": "string"
            },
            {
              "name": "tenantid",
              "type": "string"
            },
            {
              "name": "ownersid",
              "type": "string"
            },
            {
              "name": "functionallevel",
              "type": "string"
            },
            {
              "name": "admincount",
              "type": "boolean"
            },
            {
              "name": "isaclprotected",
              "type": "boolean"
            },
            {
              "name": "sensitive",
              "type": "boolean"
            },
            {
              "name": "enabled",
              "type": "boolean"
            },
            {
              "name": "isbuiltin",
              "type": "boolean"
            },
            {
              "name": "isassignabletorole",
              "type": "boolean"
            },
            {
              "name": "securityenabled",
              "type": "boolean"
            },
            {
              "name": "securityidentifier",
              "type": "string"
            },
            {
              "name": "dontreqpreauth",
              "type": "boolean"
            },
            {
              "name": "passwordnotreqd",
              "type": "boolean"
            },
            {
              "name": "pwdneverexpires",
              "type": "boolean"
            },
            {
              "name": "passwordexpired",
              "type": "boolean"
            },
            {
              "name": "pwdlastset",
              "type": "int"
            },
            {
              "name": "lastlogon",
              "type": "int"
            },
            {
              "name": "lastlogontimestamp",
              "type": "int"
            },
            {
              "name": "unicodepassword",
              "type": "string"
            },
            {
              "name": "unixpassword",
              "type": "string"
            },
            {
              "name": "userpassword",
              "type": "string"
            },
            {
              "name": "sfupassword",
              "type": "string"
            },
            {
              "name": "operatingsystem",
              "type": "datetime"
            },
            {
              "name": "isdc",
              "type": "boolean"
            },
            {
              "name": "haslaps",
              "type": "boolean"
            },
            {
              "name": "unconstraineddelegation",
              "type": "boolean"
            },
            {
              "name": "trustedtoauth",
              "type": "boolean"
            },
            {
              "name": "lockedout",
              "type": "boolean"
            },
            {
              "name": "webclientrunning",
              "type": "boolean"
            },
            {
              "name": "certificatemappingmethods",
              "type": "dynamic"
            },
            {
              "name": "certificatemappingmethodsraw",
              "type": "int"
            },
            {
              "name": "strongcertificatebindingenforcement",
              "type": "string"
            },
            {
              "name": "strongcertificatebindingenforcementraw",
              "type": "int"
            },
            {
              "name": "supportedencryptiontypes",
              "type": "dynamic"
            },
            {
              "name": "serviceprincipalnames",
              "type": "dynamic"
            },
            {
              "name": "clientallowedntlmservers",
              "type": "dynamic"
            },
            {
              "name": "ntlmminclientsec",
              "type": "int"
            },
            {
              "name": "ntlmminserversec",
              "type": "int"
            },
            {
              "name": "lmcompatibilitylevel",
              "type": "int"
            },
            {
              "name": "smbsigning",
              "type": "boolean"
            },
            {
              "name": "enablesecuritysignature",
              "type": "boolean"
            },
            {
              "name": "requiresecuritysignature",
              "type": "boolean"
            },
            {
              "name": "restrictoutboundntlm",
              "type": "boolean"
            },
            {
              "name": "restrictreceivingntmltraffic",
              "type": "boolean"
            },
            {
              "name": "ldapavailable",
              "type": "boolean"
            },
            {
              "name": "ldapsavailable",
              "type": "boolean"
            },
            {
              "name": "ldapsepa",
              "type": "boolean"
            },
            {
              "name": "ldapsigning",
              "type": "boolean"
            },
            {
              "name": "blocksinheritance",
              "type": "boolean"
            },
            {
              "name": "gpcpath",
              "type": "string"
            },
            {
              "name": "appid",
              "type": "string"
            },
            {
              "name": "appdescription",
              "type": "string"
            },
            {
              "name": "appdisplayname",
              "type": "string"
            },
            {
              "name": "appownerorganizationid",
              "type": "string"
            },
            {
              "name": "serviceprincipaltype",
              "type": "string"
            },
            {
              "name": "publisherdomain",
              "type": "string"
            },
            {
              "name": "signinaudience",
              "type": "string"
            },
            {
              "name": "loginurl",
              "type": "string"
            },
            {
              "name": "onpremid",
              "type": "datetime"
            },
            {
              "name": "onpremsyncenabled",
              "type": "boolean"
            },
            {
              "name": "usertype",
              "type": "string"
            },
            {
              "name": "templateid",
              "type": "datetime"
            },
            {
              "name": "gmsa",
              "type": "boolean"
            },
            {
              "name": "hasspn",
              "type": "boolean"
            },
            {
              "name": "whencreated",
              "type": "int"
            },
            {
              "name": "collected",
              "type": "boolean"
            },
            {
              "name": "Date",
              "type": "datetime"
            },
            {
              "name": "homedirectory",
              "type": "string"
            },
            {
              "name": "logonscript",
              "type": "string"
            },
            {
              "name": "logonscriptenabled",
              "type": "boolean"
            },
            {
              "name": "sidhistory",
              "type": "dynamic"
            },
            {
              "name": "usedeskeyonly",
              "type": "boolean"
            },
            {
              "name": "usemachineid",
              "type": "boolean"
            },
            {
              "name": "encryptedtextpwdallowed",
              "type": "boolean"
            },
            {
              "name": "doesanyacegrantownerrights",
              "type": "boolean"
            },
            {
              "name": "doesanyinheritedacegrantownerrights",
              "type": "boolean"
            },
            {
              "name": "composite_azure_users",
              "type": "int"
            },
            {
              "name": "composite_computers",
              "type": "int"
            },
            {
              "name": "composite_principals",
              "type": "int"
            },
            {
              "name": "composite_risk_assets",
              "type": "int"
            },
            {
              "name": "composite_sps",
              "type": "int"
            },
            {
              "name": "composite_users",
              "type": "int"
            },
            {
              "name": "composite_vms",
              "type": "int"
            },
            {
              "name": "descendent_count",
              "type": "int"
            },
            {
              "name": "owner_objectid",
              "type": "string"
            },
            {
              "name": "principal_count",
              "type": "int"
            },
            {
              "name": "tier_zero_active_assets_count",
              "type": "int"
            },
            {
              "name": "tier_zero_exposure_percent",
              "type": "real"
            },
            {
              "name": "tier_zero_total_assets_count",
              "type": "int"
            },
            {
              "name": "system_tags",
              "type": "string"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "apiVersion": "2022-10-01",
      "name": "[concat(parameters('logAnalyticsWorkspaceName'), '/', variables('bheAttackPathsTimelineTable'))]",
      "properties": {
        "schema": {
          "name": "[variables('bheAttackPathsTimelineTable')]",
          "columns": [
            {
              "name": "TimeGenerated",
              "type": "datetime"
            },
            {
              "name": "IngestionTime",
              "type": "datetime"
            },
            {
              "name": "CompositeRisk",
              "type": "string"
            },
            {
              "name": "domain_name",
              "type": "string"
            },
            {
              "name": "tenant_url",
              "type": "string"
            },
            {
              "name": "FindingCount",
              "type": "int"
            },
            {
              "name": "ExposureCount",
              "type": "int"
            },
            {
              "name": "ImpactCount",
              "type": "int"
            },
            {
              "name": "ImpactedAssetCount",
              "type": "int"
            },
            {
              "name": "DomainSID",
              "type": "string"
            },
            {
              "name": "Finding",
              "type": "string"
            },
            {
              "name": "id",
              "type": "int"
            },
            {
              "name": "path_title",
              "type": "string"
            },
            {
              "name": "created_at",
              "type": "datetime"
            },
            {
              "name": "updated_at",
              "type": "datetime"
            },
            {
              "name": "deleted_at",
              "type": "dynamic"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2023-03-11",
      "name": "[variables('dcrName')]",
      "location": "[variables('logAnalyticsWorkspaceLocation')]",
      "dependsOn": [
        "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('logAnalyticsWorkspaceName'), variables('bheAttackPathsTable'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('logAnalyticsWorkspaceName'), variables('bheAuditLogsTable'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('logAnalyticsWorkspaceName'), variables('bheFindingTrendsTable'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('logAnalyticsWorkspaceName'), variables('bhePostureHistoryTable'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('logAnalyticsWorkspaceName'), variables('bheTierZeroAssetsTable'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('logAnalyticsWorkspaceName'), variables('bheAttackPathsTimelineTable'))]"
      ],
      "properties": {
        "dataCollectionEndpointId": "[resourceId(subscription().subscriptionId, variables('logAnalyticsWorkspaceResourceGroupName'),'Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
        "streamDeclarations": {
          "Custom-BHEAttackPathsData_CL": {
            "columns": [
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "IngestionTime",
                "type": "datetime"
              },
              {
                "name": "NonTierZeroPrincipal",
                "type": "string"
              },
              {
                "name": "ImpactedPrincipal",
                "type": "string"
              },
              {
                "name": "domain_name",
                "type": "string"
              },
              {
                "name": "NonTierZeroPrincipalProps",
                "type": "dynamic"
              },
              {
                "name": "NonTierZeroPrincipalKind",
                "type": "string"
              },
              {
                "name": "ImpactedPrincipalProps",
                "type": "dynamic"
              },
              {
                "name": "ImpactedPrincipalKind",
                "type": "string"
              },
              {
                "name": "RelProps",
                "type": "dynamic"
              },
              {
                "name": "ComboGraphRelationID",
                "type": "int"
              },
              {
                "name": "Finding",
                "type": "string"
              },
              {
                "name": "DomainSID",
                "type": "string"
              },
              {
                "name": "PrincipalHash",
                "type": "string"
              },
              {
                "name": "ImpactPercentage",
                "type": "string"
              },
              {
                "name": "ImpactCount",
                "type": "int"
              },
              {
                "name": "ExposurePercentage",
                "type": "string"
              },
              {
                "name": "ExposureCount",
                "type": "int"
              },
              {
                "name": "Severity",
                "type": "string"
              },
              {
                "name": "AcceptedUntil",
                "type": "string"
              },
              {
                "name": "Accepted",
                "type": "boolean"
              },
              {
                "name": "Environment",
                "type": "string"
              },
              {
                "name": "NonTierZeroPrincipalName",
                "type": "string"
              },
              {
                "name": "ImpactedPrincipalName",
                "type": "string"
              },
              {
                "name": "IsInherited",
                "type": "string"
              },
              {
                "name": "NonTierZeroPrincipalEnvironment",
                "type": "string"
              },
              {
                "name": "NonTierZeroPrincipalEnvironmentID",
                "type": "string"
              },
              {
                "name": "ImpactedPrincipalEnvironment",
                "type": "string"
              },
              {
                "name": "ImpactedPrincipalEnvironmentID",
                "type": "string"
              },
              {
                "name": "id",
                "type": "int"
              },
              {
                "name": "created_at",
                "type": "datetime"
              },
              {
                "name": "updated_at",
                "type": "datetime"
              },
              {
                "name": "deleted_at",
                "type": "dynamic"
              },
              {
                "name": "tenant_url",
                "type": "string"
              },
              {
                "name": "Remediation",
                "type": "string"
              },
              {
                "name": "PathTitle",
                "type": "string"
              },
              {
                "name": "ShortDescription",
                "type": "string"
              },
              {
                "name": "ShortRemediation",
                "type": "string"
              },
              {
                "name": "LongRemediation",
                "type": "string"
              }
            ]
          },
          "Custom-BHEAuditLogsData_CL": {
            "columns": [
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "IngestionTime",
                "type": "datetime"
              },
              {
                "name": "id",
                "type": "int"
              },
              {
                "name": "created_at",
                "type": "datetime"
              },
              {
                "name": "actor_id",
                "type": "string"
              },
              {
                "name": "actor_name",
                "type": "string"
              },
              {
                "name": "actor_email",
                "type": "string"
              },
              {
                "name": "action",
                "type": "string"
              },
              {
                "name": "fields",
                "type": "dynamic"
              },
              {
                "name": "request_id",
                "type": "string"
              },
              {
                "name": "source_ip_address",
                "type": "string"
              },
              {
                "name": "status",
                "type": "string"
              },
              {
                "name": "commit_id",
                "type": "string"
              },
              {
                "name": "tenant_url",
                "type": "string"
              }
            ]
          },
          "Custom-BHEFindingTrendsData_CL": {
            "columns": [
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "IngestionTime",
                "type": "datetime"
              },
              {
                "name": "composite_risk",
                "type": "string"
              },
              {
                "name": "display_title",
                "type": "string"
              },
              {
                "name": "display_type",
                "type": "string"
              },
              {
                "name": "environment_id",
                "type": "string"
              },
              {
                "name": "exposure_count",
                "type": "int"
              },
              {
                "name": "finding",
                "type": "string"
              },
              {
                "name": "finding_count_decrease",
                "type": "int"
              },
              {
                "name": "finding_count_end",
                "type": "int"
              },
              {
                "name": "finding_count_increase",
                "type": "int"
              },
              {
                "name": "finding_count_start",
                "type": "int"
              },
              {
                "name": "impact_count",
                "type": "int"
              },
              {
                "name": "tenant_url",
                "type": "string"
              },
              {
                "name": "domain_name",
                "type": "string"
              },
              {
                "name": "start_date",
                "type": "datetime"
              },
              {
                "name": "end_date",
                "type": "datetime"
              },
              {
                "name": "period",
                "type": "string"
              }
            ]
          },
          "Custom-BHEPostureHistoryData_CL": {
            "columns": [
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "IngestionTime",
                "type": "datetime"
              },
              {
                "name": "metric_date",
                "type": "datetime"
              },
              {
                "name": "value",
                "type": "string"
              },
              {
                "name": "start_time",
                "type": "datetime"
              },
              {
                "name": "end_time",
                "type": "datetime"
              },
              {
                "name": "domain_id",
                "type": "string"
              },
              {
                "name": "data_type",
                "type": "string"
              },
              {
                "name": "domain_name",
                "type": "string"
              },
              {
                "name": "tenant_url",
                "type": "string"
              }
            ]
          },
          "Custom-BHETierZeroAssetsData_CL": {
            "columns": [
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "IngestionTime",
                "type": "datetime"
              },
              {
                "name": "nodeId",
                "type": "string"
              },
              {
                "name": "label",
                "type": "string"
              },
              {
                "name": "kindType",
                "type": "string"
              },
              {
                "name": "objectId",
                "type": "string"
              },
              {
                "name": "isTierZero",
                "type": "boolean"
              },
              {
                "name": "isOwnedObject",
                "type": "boolean"
              },
              {
                "name": "lastSeen",
                "type": "datetime"
              },
              {
                "name": "tenant_url",
                "type": "string"
              },
              {
                "name": "domain_name",
                "type": "string"
              },
              {
                "name": "name",
                "type": "string"
              },
              {
                "name": "properties",
                "type": "dynamic"
              },
              {
                "name": "displayname",
                "type": "string"
              },
              {
                "name": "description",
                "type": "string"
              },
              {
                "name": "distinguishedname",
                "type": "string"
              },
              {
                "name": "samaccountname",
                "type": "string"
              },
              {
                "name": "userprincipalname",
                "type": "string"
              },
              {
                "name": "email",
                "type": "string"
              },
              {
                "name": "Title",
                "type": "string"
              },
              {
                "name": "domain",
                "type": "string"
              },
              {
                "name": "domainsid",
                "type": "string"
              },
              {
                "name": "tenantid",
                "type": "string"
              },
              {
                "name": "ownersid",
                "type": "string"
              },
              {
                "name": "functionallevel",
                "type": "string"
              },
              {
                "name": "admincount",
                "type": "boolean"
              },
              {
                "name": "isaclprotected",
                "type": "boolean"
              },
              {
                "name": "sensitive",
                "type": "boolean"
              },
              {
                "name": "enabled",
                "type": "boolean"
              },
              {
                "name": "isbuiltin",
                "type": "boolean"
              },
              {
                "name": "isassignabletorole",
                "type": "boolean"
              },
              {
                "name": "securityenabled",
                "type": "boolean"
              },
              {
                "name": "securityidentifier",
                "type": "string"
              },
              {
                "name": "dontreqpreauth",
                "type": "boolean"
              },
              {
                "name": "passwordnotreqd",
                "type": "boolean"
              },
              {
                "name": "pwdneverexpires",
                "type": "boolean"
              },
              {
                "name": "passwordexpired",
                "type": "boolean"
              },
              {
                "name": "pwdlastset",
                "type": "int"
              },
              {
                "name": "lastlogon",
                "type": "int"
              },
              {
                "name": "lastlogontimestamp",
                "type": "int"
              },
              {
                "name": "unicodepassword",
                "type": "string"
              },
              {
                "name": "unixpassword",
                "type": "string"
              },
              {
                "name": "userpassword",
                "type": "string"
              },
              {
                "name": "sfupassword",
                "type": "string"
              },
              {
                "name": "operatingsystem",
                "type": "datetime"
              },
              {
                "name": "isdc",
                "type": "boolean"
              },
              {
                "name": "haslaps",
                "type": "boolean"
              },
              {
                "name": "unconstraineddelegation",
                "type": "boolean"
              },
              {
                "name": "trustedtoauth",
                "type": "boolean"
              },
              {
                "name": "lockedout",
                "type": "boolean"
              },
              {
                "name": "webclientrunning",
                "type": "boolean"
              },
              {
                "name": "certificatemappingmethods",
                "type": "dynamic"
              },
              {
                "name": "certificatemappingmethodsraw",
                "type": "int"
              },
              {
                "name": "strongcertificatebindingenforcement",
                "type": "string"
              },
              {
                "name": "strongcertificatebindingenforcementraw",
                "type": "int"
              },
              {
                "name": "supportedencryptiontypes",
                "type": "dynamic"
              },
              {
                "name": "serviceprincipalnames",
                "type": "dynamic"
              },
              {
                "name": "clientallowedntlmservers",
                "type": "dynamic"
              },
              {
                "name": "ntlmminclientsec",
                "type": "int"
              },
              {
                "name": "ntlmminserversec",
                "type": "int"
              },
              {
                "name": "lmcompatibilitylevel",
                "type": "int"
              },
              {
                "name": "smbsigning",
                "type": "boolean"
              },
              {
                "name": "enablesecuritysignature",
                "type": "boolean"
              },
              {
                "name": "requiresecuritysignature",
                "type": "boolean"
              },
              {
                "name": "restrictoutboundntlm",
                "type": "boolean"
              },
              {
                "name": "restrictreceivingntmltraffic",
                "type": "boolean"
              },
              {
                "name": "ldapavailable",
                "type": "boolean"
              },
              {
                "name": "ldapsavailable",
                "type": "boolean"
              },
              {
                "name": "ldapsepa",
                "type": "boolean"
              },
              {
                "name": "ldapsigning",
                "type": "boolean"
              },
              {
                "name": "blocksinheritance",
                "type": "boolean"
              },
              {
                "name": "gpcpath",
                "type": "string"
              },
              {
                "name": "appid",
                "type": "string"
              },
              {
                "name": "appdescription",
                "type": "string"
              },
              {
                "name": "appdisplayname",
                "type": "string"
              },
              {
                "name": "appownerorganizationid",
                "type": "string"
              },
              {
                "name": "serviceprincipaltype",
                "type": "string"
              },
              {
                "name": "publisherdomain",
                "type": "string"
              },
              {
                "name": "signinaudience",
                "type": "string"
              },
              {
                "name": "loginurl",
                "type": "string"
              },
              {
                "name": "onpremid",
                "type": "datetime"
              },
              {
                "name": "onpremsyncenabled",
                "type": "boolean"
              },
              {
                "name": "usertype",
                "type": "string"
              },
              {
                "name": "templateid",
                "type": "datetime"
              },
              {
                "name": "gmsa",
                "type": "boolean"
              },
              {
                "name": "hasspn",
                "type": "boolean"
              },
              {
                "name": "whencreated",
                "type": "int"
              },
              {
                "name": "collected",
                "type": "boolean"
              },
              {
                "name": "Date",
                "type": "datetime"
              },
              {
                "name": "homedirectory",
                "type": "string"
              },
              {
                "name": "logonscript",
                "type": "string"
              },
              {
                "name": "logonscriptenabled",
                "type": "boolean"
              },
              {
                "name": "sidhistory",
                "type": "dynamic"
              },
              {
                "name": "usedeskeyonly",
                "type": "boolean"
              },
              {
                "name": "usemachineid",
                "type": "boolean"
              },
              {
                "name": "encryptedtextpwdallowed",
                "type": "boolean"
              },
              {
                "name": "doesanyacegrantownerrights",
                "type": "boolean"
              },
              {
                "name": "doesanyinheritedacegrantownerrights",
                "type": "boolean"
              },
              {
                "name": "composite_azure_users",
                "type": "int"
              },
              {
                "name": "composite_computers",
                "type": "int"
              },
              {
                "name": "composite_principals",
                "type": "int"
              },
              {
                "name": "composite_risk_assets",
                "type": "int"
              },
              {
                "name": "composite_sps",
                "type": "int"
              },
              {
                "name": "composite_users",
                "type": "int"
              },
              {
                "name": "composite_vms",
                "type": "int"
              },
              {
                "name": "descendent_count",
                "type": "int"
              },
              {
                "name": "owner_objectid",
                "type": "string"
              },
              {
                "name": "principal_count",
                "type": "int"
              },
              {
                "name": "tier_zero_active_assets_count",
                "type": "int"
              },
              {
                "name": "tier_zero_exposure_percent",
                "type": "real"
              },
              {
                "name": "tier_zero_total_assets_count",
                "type": "int"
              },
              {
                "name": "system_tags",
                "type": "string"
              }
            ]
          },
          "Custom-BHEAttackPathsTimelineData_CL": {
            "columns": [
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "IngestionTime",
                "type": "datetime"
              },
              {
                "name": "CompositeRisk",
                "type": "string"
              },
              {
                "name": "domain_name",
                "type": "string"
              },
              {
                "name": "tenant_url",
                "type": "string"
              },
              {
                "name": "FindingCount",
                "type": "int"
              },
              {
                "name": "ExposureCount",
                "type": "int"
              },
              {
                "name": "ImpactCount",
                "type": "int"
              },
              {
                "name": "ImpactedAssetCount",
                "type": "int"
              },
              {
                "name": "DomainSID",
                "type": "string"
              },
              {
                "name": "Finding",
                "type": "string"
              },
              {
                "name": "id",
                "type": "int"
              },
              {
                "name": "path_title",
                "type": "string"
              },
              {
                "name": "created_at",
                "type": "datetime"
              },
              {
                "name": "updated_at",
                "type": "datetime"
              },
              {
                "name": "deleted_at",
                "type": "dynamic"
              }
            ]
          }
        },
        "dataSources": {},
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[resourceId(variables('SubscriptionId'), variables('logAnalyticsWorkspaceResourceGroupName'), 'Microsoft.OperationalInsights/Workspaces', parameters('logAnalyticsWorkspaceName'))]",
              "name": "[parameters('logAnalyticsWorkspaceName')]"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Custom-BHEAttackPathsData_CL"
            ],
            "destinations": [
              "[parameters('logAnalyticsWorkspaceName')]"
            ],
            "transformKql": "source\n| extend TimeGenerated = todatetime(updated_at), IngestionTime = now()\n",
            "outputStream": "[concat('Custom-', variables('attackPathsTable'))]"
          },
          {
            "streams": [
              "Custom-BHEAuditLogsData_CL"
            ],
            "destinations": [
              "[parameters('logAnalyticsWorkspaceName')]"
            ],
            "transformKql": "source\n| extend TimeGenerated = todatetime(created_at), IngestionTime = now()\n",
            "outputStream": "[concat('Custom-', variables('auditLogsTable'))]"
          },
          {
            "streams": [
              "Custom-BHEFindingTrendsData_CL"
            ],
            "destinations": [
              "[parameters('logAnalyticsWorkspaceName')]"
            ],
            "transformKql": "source\n| extend TimeGenerated = now()\n",
            "outputStream": "[concat('Custom-', variables('findingTrendsTable'))]"
          },
          {
            "streams": [
              "Custom-BHEPostureHistoryData_CL"
            ],
            "destinations": [
              "[parameters('logAnalyticsWorkspaceName')]"
            ],
            "transformKql": "source\n| extend TimeGenerated = todatetime(metric_date), IngestionTime = now()\n",
            "outputStream": "[concat('Custom-', variables('postureHistoryTable'))]"
          },
          {
            "streams": [
              "Custom-BHETierZeroAssetsData_CL"
            ],
            "destinations": [
              "[parameters('logAnalyticsWorkspaceName')]"
            ],
            "transformKql": "source\n| extend TimeGenerated = now()\n",
            "outputStream": "[concat('Custom-', variables('tierZeroAssetsTable'))]"
          },
          {
            "streams": [
              "Custom-BHEAttackPathsTimelineData_CL"
            ],
            "destinations": [
              "[parameters('logAnalyticsWorkspaceName')]"
            ],
            "transformKql": "source\n| extend TimeGenerated = todatetime(created_at), IngestionTime = now()\n",
            "outputStream": "[concat('Custom-', variables('attackPathsTimelineTable'))]"
          }
        ],
        "provisioningState": "Succeeded"
      }
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[variables('applicationInsightsName')]",
      "location": "[variables('logAnalyticsWorkspaceLocation')]",
      "tags": {
        "[format('hidden-link:{0}', resourceId('Microsoft.Web/sites', parameters('functionAppName')))]": "Resource"
      },
      "kind": "web",
      "properties": {
        "Application_Type": "web"
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-12-01",
      "name": "[parameters('functionAppName')]",
      "location": "[variables('logAnalyticsWorkspaceLocation')]",
      "dependsOn": [
        "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
        "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
        "[resourceId('Microsoft.Resources/deploymentScripts', 'uploadZipToBlob')]"
      ],
      "kind": "functionapp,linux",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "reserved": true,
        "siteConfig": {
          "appSettings": [
            {
              "name": "AzureWebJobsStorage",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
            },
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "BLOODHOUND_TENANT_DOMAIN",
              "value": "[parameters('bloodhoundTenantDomain')]"
            },
            {
              "name": "BLOODHOUND_TOKEN_ID_SECRET_NAME",
              "value": "[variables('bloodhoundTokenIdSecretName')]"
            },
            {
              "name": "BLOODHOUND_TOKEN_KEY_SECRET_NAME",
              "value": "[variables('bloodhoundTokenKeySecretName')]"
            },
            {
              "name": "MICROSOFT_ENTRA_ID_APPLICATION_TENANT_ID",
              "value": "[variables('tenantId')]"
            },
            {
              "name": "MICROSOFT_ENTRA_ID_APPLICATION_APP_ID",
              "value": "[variables('microsoftEntraIdApplicationAppId')]"
            },
            {
              "name": "MICROSOFT_ENTRA_ID_APPLICATION_APP_SECRET",
              "value": "[variables('microsoftEntraIdApplicationAppSecret')]"
            },
            {
              "name": "DCE_URI",
              "value": "[reference(resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName')), '2023-03-11').logsIngestion.endpoint]"
            },
            {
              "name": "DCR_IMMUTABLE_ID",
              "value": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', variables('dcrName')), '2023-03-11').immutableId]"
            },
            {
              "name": "AUDIT_LOGS_TABLE_NAME",
              "value": "[variables('auditLogsTable')]"
            },
            {
              "name": "FINDING_TRENDS_TABLE_NAME",
              "value": "[variables('findingTrendsTable')]"
            },
            {
              "name": "POSTURE_HISTORY_TABLE_NAME",
              "value": "[variables('postureHistoryTable')]"
            },
            {
              "name": "ATTACK_PATHS_TABLE_NAME",
              "value": "[variables('attackPathsTable')]"
            },
            {
              "name": "ATTACK_PATHS_TIMELINE_TABLE_NAME",
              "value": "[variables('attackPathsTimelineTable')]"
            },
            {
              "name": "TIER_ZERO_ASSETS_TABLE_NAME",
              "value": "[variables('tierZeroAssetsTable')]"
            },
            {
              "name": "KEY_VAULT_URL",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2021-06-01-preview').vaultUri]"
            },
            {
              "name": "LOOKUP_DAYS",
              "value": "[parameters('lookupDays')]"
            },
            {
              "name": "SELECTED_BLOODHOUND_ENVIRONMENTS",
              "value": "[parameters('selectedBloodhoundEnvironments')]"
            },
            {
              "name": "SELECTED_FINDING_TYPES",
              "value": "[parameters('selectedFindingTypes')]"
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName')), '2020-02-02').ConnectionString]"
            }
          ],
          "cors": {
            "allowedOrigins": [
              "https://portal.azure.com"
            ]
          },
          "ftpsState": "Disabled"
        },
        "functionAppConfig": {
          "deployment": {
            "storage": {
              "type": "BlobContainer",
              "value": "[concat(reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2022-09-01').primaryEndpoints.blob, variables('deploymentContainerName'))]",
              "authentication": {
                "type": "SystemAssignedIdentity"
              }
            }
          },
          "scaleAndConcurrency": {
            "maximumInstanceCount": 40,
            "instanceMemoryMB": 2048
          },
          "runtime": {
            "name": "python",
            "version": "3.12"
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2023-01-01",
      "name": "[variables('appServicePlanName')]",
      "location": "[variables('logAnalyticsWorkspaceLocation')]",
      "sku": {
        "name": "FC1",
        "tier": "FlexConsumption"
      },
      "kind": "functionapp",
      "properties": {
        "reserved": true
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2022-09-01",
      "name": "[variables('storageAccountName')]",
      "location": "[variables('logAnalyticsWorkspaceLocation')]",
      "sku": {
        "name": "[variables('storageAccountType')]"
      },
      "kind": "StorageV2",
      "properties": {}
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2023-01-01",
      "name": "[concat(variables('storageAccountName'), '/default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ],
      "properties": {
        "deleteRetentionPolicy": {
          "enabled": false
        }
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2023-01-01",
      "name": "[concat(variables('storageAccountName'), '/default/deploymentpackage')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ],
      "properties": {
        "publicAccess": "None"
      }
    },
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[variables('managedIdentityName')]",
      "location": "[variables('logAnalyticsWorkspaceLocation')]"
    },
    {
      "type": "Microsoft.Storage/storageAccounts/providers/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[concat(variables('storageAccountName'), '/Microsoft.Authorization/', guid(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), variables('managedIdentityName'), 'StorageBlobDataContributor'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName'))]"
      ],
      "properties": {
        "roleDefinitionId": "[variables('storageBlobDataContributorRoleId')]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName')), '2023-01-31').principalId]",
        "principalType": "ServicePrincipal"
      }
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "uploadZipToBlob",
      "location": "[variables('logAnalyticsWorkspaceLocation')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', variables('storageAccountName'), 'default', variables('deploymentContainerName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts/providers/roleAssignments', variables('storageAccountName'), 'Microsoft.Authorization', guid(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), variables('managedIdentityName'), 'StorageBlobDataContributor'))]"
      ],
      "kind": "AzureCLI",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName'))]": {}
        }
      },
      "properties": {
        "azCliVersion": "2.52.0",
        "timeout": "PT10M",
        "retentionInterval": "PT1H",
        "cleanupPreference": "OnSuccess",
        "forceUpdateTag": "[parameters('utcTimeZone')]",
        "scriptContent": "[concat('#!/bin/bash\nset -e\necho \"Starting deployment script...\"\necho \"Waiting for role assignment to propagate...\"\nsleep 30\necho \"Downloading zip file...\"\ncurl -L --fail --show-error -o ', variables('zipFileName'), ' \"', variables('zipFileUrl'), '\"\necho \"Verifying downloaded file...\"\nif [ ! -f ', variables('zipFileName'), ' ]; then\n  echo \"Error: Downloaded file does not exist\"\n  exit 1\nfi\necho \"File downloaded successfully\"\necho \"Uploading to storage account...\"\naz storage blob upload --account-name ', variables('storageAccountName'), ' --container-name ', variables('deploymentContainerName'), ' --name ', variables('zipFileName'), ' --file ', variables('zipFileName'), ' --auth-mode login --overwrite --no-progress\necho \"Upload completed successfully\"\n')]"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceGroup().id, 'StorageBlobDataContributor', parameters('functionAppName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
        "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
      ],
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
        "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-12-01', 'Full').identity.principalId]",
        "principalType": "ServicePrincipal"
      },
      "scope": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "WaitSection",
      "location": "[variables('logAnalyticsWorkspaceLocation')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
      ],
      "kind": "AzurePowerShell",
      "properties": {
        "azPowerShellVersion": "7.0",
        "scriptContent": "start-sleep -Seconds 30",
        "cleanupPreference": "Always",
        "retentionInterval": "PT1H"
      }
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "generateSasUrl",
      "location": "[variables('logAnalyticsWorkspaceLocation')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deploymentScripts', 'uploadZipToBlob')]",
        "[resourceId('Microsoft.Resources/deploymentScripts', 'WaitSection')]"
      ],
      "kind": "AzurePowerShell",
      "properties": {
        "azPowerShellVersion": "7.0",
        "timeout": "PT5M",
        "retentionInterval": "PT1H",
        "cleanupPreference": "OnSuccess",
        "scriptContent": "[concat('$storageAccountName = \"', variables('storageAccountName'), '\"\n$containerName = \"', variables('deploymentContainerName'), '\"\n$blobName = \"', variables('zipFileName'), '\"\n$storageAccountKey = \"', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01').keys[0].value, '\"\n$ctx = New-AzStorageContext -StorageAccountName $storageAccountName -StorageAccountKey $storageAccountKey\n$expiryTime = (Get-Date).AddHours(1)\n$sasToken = New-AzStorageBlobSASToken -Context $ctx -Container $containerName -Blob $blobName -Permission r -ExpiryTime $expiryTime\n$blobUrl = \"', reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2022-09-01').primaryEndpoints.blob, variables('deploymentContainerName'), '/', variables('zipFileName'), '?\" + $sasToken\n$DeploymentScriptOutputs = @{}\n$DeploymentScriptOutputs[''result''] = $blobUrl\n')]"
      }
    },
    {
      "type": "Microsoft.Web/sites/extensions",
      "apiVersion": "2022-09-01",
      "name": "[concat(parameters('functionAppName'), '/onedeploy')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deploymentScripts', 'generateSasUrl')]"
      ],
      "properties": {
        "packageUri": "[reference(resourceId('Microsoft.Resources/deploymentScripts', 'generateSasUrl'), '2020-10-01').outputs.result]",
        "remoteBuild": true
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2021-06-01-preview",
      "name": "[variables('keyVaultName')]",
      "location": "[variables('logAnalyticsWorkspaceLocation')]",
      "dependsOn": [],
      "properties": {
        "sku": {
          "family": "A",
          "name": "Standard"
        },
        "tenantId": "[variables('tenantId')]",
        "enableSoftDelete": true,
        "enableRbacAuthorization": true,
        "enabledForTemplateDeployment": true,
        "accessPolicies": []
      },
      "resources": [
        {
          "type": "secrets",
          "apiVersion": "2021-06-01-preview",
          "name": "[variables('bloodhoundTokenIdSecretName')]",
          "dependsOn": [
            "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
          ],
          "properties": {
            "value": "[parameters('Bloodhound-Token-Id-Secret-Value')]"
          }
        },
        {
          "type": "secrets",
          "apiVersion": "2021-06-01-preview",
          "name": "[variables('bloodhoundTokenKeySecretName')]",
          "dependsOn": [
            "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
          ],
          "properties": {
            "value": "[parameters('Bloodhound-Token-Key-Secret-Value')]"
          }
        }
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceGroup().id, 'KeyVaultSecretsUser', parameters('functionAppName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]",
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ],
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
        "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2022-03-01', 'Full').identity.principalId]"
      },
      "scope": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
    }
  ],
  "outputs": {
    "storageAccountName": {
      "type": "String",
      "value": "[variables('storageAccountName')]"
    },
    "containerName": {
      "type": "String",
      "value": "[variables('deploymentContainerName')]"
    },
    "zipFileName": {
      "type": "String",
      "value": "[variables('zipFileName')]"
    },
    "blobUrl": {
      "type": "String",
      "value": "[concat(reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2022-09-01').primaryEndpoints.blob, variables('deploymentContainerName'), '/', variables('zipFileName'))]"
    }
  }
}