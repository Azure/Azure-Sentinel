{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass the arm-ttk test, 'Location-Should-Not-Be-Hardcoded'. Instead the `workspace-location` derived from the log analytics workspace is used."
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "Central India",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "subscription": {
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "type": "string",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is configured"
      }
    },
    "resourceGroupName": {
      "defaultValue": "[resourceGroup().name]",
      "type": "string",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is configured"
      }
    },
    "workspace": {
      "defaultValue": "BloodHound-Log-Analytics",
      "type": "string",
      "metadata": {
        "description": "the log analytics workspace enabled for Microsoft Sentinel"
      }
    },
    "workspaceId": {
      "type": "string",
      "metadata": {
        "description": "The unique identifier (GUID) of the Log Analytics workspace."
      }
    }
  },
  "variables": {
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_logAnalyticsTableId1": "BHEAttackPathsData_CL",
    "_logAnalyticsTableId2": "BHEAttackPathsTimelineData_CL",
    "_logAnalyticsTableId3": "BHEAuditLogsData_CL",
    "_logAnalyticsTableId4": "BHEFindingTrendsData_CL",
    "_logAnalyticsTableId5": "BHEPostureHistoryData_CL",
    "_logAnalyticsTableId6": "BHEPostureStatsData_CL",
    "_logAnalyticsTableId7": "BHETierZeroAssetsData_CL",
    "dceResourceName": "BloodHoundDCE",
    "dceImmutableId": "[guid(variables('dceResourceName'))]",
    "dcrResourceName": "BloodHoundDCR"
  },
  "resources": [
    {
      "name": "[variables('dceResourceName')]",
      "type": "Microsoft.Insights/dataCollectionEndpoints",
      "apiVersion": "2021-09-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "DCE for fetching Attack Paths from BloodHound Enterprise",
        "networkAcls": {
          "publicNetworkAccess": "Enabled"
        },
        "configurationAccess": {
          "immutableId": "[variables('dceImmutableId')]"
        }
      }
    },
    // --- Custom Log Table 1 (BHEAttackPathsData_CL) ---
    {
      "name": "[concat(parameters('workspace'), '/', variables('_logAnalyticsTableId1'))]",
      "apiVersion": "2022-10-01",
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "location": "[parameters('workspace-location')]",
      "kind": null,
      "properties": {
        "totalRetentionInDays": 30,
        "archiveRetentionInDays": 0,
        "plan": "Analytics",
        "retentionInDaysAsDefault": true,
        "totalRetentionInDaysAsDefault": true,
        "schema": {
          "tableSubType": "DataCollectionRuleBased",
          "name": "[variables('_logAnalyticsTableId1')]",
          "tableType": "CustomLog",
          "columns": [
            {
              "name": "TimeGenerated",
              "type": "datetime",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "NonTierZeroPrincipal",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactedPrincipal",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "domain_name",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "NonTierZeroPrincipalProps",
              "type": "dynamic",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "NonTierZeroPrincipalKind",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactedPrincipalProps",
              "type": "dynamic",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactedPrincipalKind",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "RelProps",
              "type": "dynamic",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ComboGraphRelationID",
              "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "Finding",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "DomainSID",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "PrincipalHash",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactPercentage",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactCount",
              "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ExposurePercentage",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ExposureCount",
              "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "Severity",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "AcceptedUntil",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "Accepted",
              "type": "boolean",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "Environment",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "NonTierZeroPrincipalName",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactedPrincipalName",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "IsInherited",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "NonTierZeroPrincipalEnvironment",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "NonTierZeroPrincipalEnvironmentID",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactedPrincipalEnvironment",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ImpactedPrincipalEnvironmentID",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "id",
              "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "created_at",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "updated_at",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "deleted_at",
              "type": "dynamic",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "tenant_url",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "Remediation",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "PathTitle",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ShortDescription",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "ShortRemediation",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            },
            {
              "name": "LongRemediation",
              "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
            }
          ],
          "standardColumns": [
            {
              "name": "TenantId",
              "type": "guid",
              "isDefaultDisplay": false,
              "isHidden": false
            }
          ],
          "solutions": [
            "LogManagement"
          ],
          "isTroubleshootingAllowed": true
        },
        "provisioningState": "Succeeded",
        "retentionInDays": 30
      },
      "id": "[concat('/subscriptions/', parameters('subscription'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspace'), '/tables/', variables('_logAnalyticsTableId1'))]"
    },
    // --- Custom Log Table 2 (BHEAttackPathsTimelineData_CL) ---
    {
      "name": "[concat(parameters('workspace'), '/', variables('_logAnalyticsTableId2'))]",
      "apiVersion": "2022-10-01",
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "location": "[parameters('workspace-location')]",
      "kind": null,
      "properties": {
        "totalRetentionInDays": 30,
        "archiveRetentionInDays": 0,
        "plan": "Analytics",
        "retentionInDaysAsDefault": true,
        "totalRetentionInDaysAsDefault": true,
        "schema": {
          "tableSubType": "DataCollectionRuleBased",
          "name": "[variables('_logAnalyticsTableId2')]",
          "tableType": "CustomLog",
          "columns": [
            {
                        "name": "CompositeRisk",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "domain_name",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "tenant_url",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "FindingCount",
                        "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "ExposureCount",
                        "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "ImpactCount",
                        "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "ImpactedAssetCount",
                        "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "DomainSID",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "Finding",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "id",
                        "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "path_title",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "created_at",
                        "type": "datetime",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "updated_at",
                        "type": "datetime",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "deleted_at",
                        "type": "dynamic",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "TimeGenerated",
              "type": "datetime",
              "isDefaultDisplay": false,
              "isHidden": false
                    }
          ],
          "standardColumns": [
            {
              "name": "TenantId",
              "type": "guid",
              "isDefaultDisplay": false,
              "isHidden": false
            }
          ],
          "solutions": [
            "LogManagement"
          ],
          "isTroubleshootingAllowed": true
        },
        "provisioningState": "Succeeded",
        "retentionInDays": 30
      },
      "id": "[concat('/subscriptions/', parameters('subscription'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspace'), '/tables/', variables('_logAnalyticsTableId2'))]"
    },
    // --- Custom Log Table 3 (BHEAuditLogsData_CL) ---
    {
      "name": "[concat(parameters('workspace'), '/', variables('_logAnalyticsTableId3'))]",
      "apiVersion": "2022-10-01",
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "location": "[parameters('workspace-location')]",
      "kind": null,
      "properties": {
        "totalRetentionInDays": 30,
        "archiveRetentionInDays": 0,
        "plan": "Analytics",
        "retentionInDaysAsDefault": true,
        "totalRetentionInDaysAsDefault": true,
        "schema": {
          "tableSubType": "DataCollectionRuleBased",
          "name": "[variables('_logAnalyticsTableId3')]",
          "tableType": "CustomLog",
          "columns": [
            {
                        "name": "id",
                        "type": "int",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "created_at",
                        "type": "datetime",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "actor_id",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "actor_name",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "actor_email",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "action",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "fields",
                        "type": "dynamic",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "request_id",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "source_ip_address",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "status",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "commit_id",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "tenant_url",
                        "type": "string",
              "isDefaultDisplay": false,
              "isHidden": false
                    },
                    {
                        "name": "TimeGenerated",
              "type": "datetime",
              "isDefaultDisplay": false,
              "isHidden": false
                    }
          ],
          "standardColumns": [
            {
              "name": "TenantId",
              "type": "guid",
              "isDefaultDisplay": false,
              "isHidden": false
            }
          ],
          "solutions": [
            "LogManagement"
          ],
          "isTroubleshootingAllowed": true
        },
        "provisioningState": "Succeeded",
        "retentionInDays": 30
      },
      "id": "[concat('/subscriptions/', parameters('subscription'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspace'), '/tables/', variables('_logAnalyticsTableId3'))]"
    },
    // --- Custom Log Table 4 (BHEFindingTrendsData_CL) ---
    {
      "name": "[concat(parameters('workspace'), '/', variables('_logAnalyticsTableId4'))]",
      "apiVersion": "2022-10-01",
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "location": "[parameters('workspace-location')]",
      "kind": null,
      "properties": {
        "totalRetentionInDays": 30,
        "archiveRetentionInDays": 0,
        "plan": "Analytics",
        "retentionInDaysAsDefault": true,
        "totalRetentionInDaysAsDefault": true,
        "schema": {
          "tableSubType": "DataCollectionRuleBased",
          "name": "[variables('_logAnalyticsTableId4')]",
          "tableType": "CustomLog",
          "columns": [
            {
                        "name": "composite_risk",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false

                    },
                    {
                        "name": "display_title",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "display_type",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "environment_id",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "exposure_count",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "finding",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "finding_count_decrease",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "finding_count_end",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "finding_count_increase",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "finding_count_start",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "impact_count",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "tenant_url",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "domain_name",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "start_date",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "end_date",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "TimeGenerated",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    }
          ],
          "standardColumns": [
            {
              "name": "TenantId",
              "type": "guid",
              "isDefaultDisplay": false,
              "isHidden": false
            }
          ],
          "solutions": [
            "LogManagement"
          ],
          "isTroubleshootingAllowed": true
        },
        "provisioningState": "Succeeded",
        "retentionInDays": 30
      },
      "id": "[concat('/subscriptions/', parameters('subscription'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspace'), '/tables/', variables('_logAnalyticsTableId4'))]"
    },
    // --- Custom Log Table 5 (BHEPostureHistoryData_CL) ---
    {
      "name": "[concat(parameters('workspace'), '/', variables('_logAnalyticsTableId5'))]",
      "apiVersion": "2022-10-01",
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "location": "[parameters('workspace-location')]",
      "kind": null,
      "properties": {
        "totalRetentionInDays": 30,
        "archiveRetentionInDays": 0,
        "plan": "Analytics",
        "retentionInDaysAsDefault": true,
        "totalRetentionInDaysAsDefault": true,
        "schema": {
          "tableSubType": "DataCollectionRuleBased",
          "name": "[variables('_logAnalyticsTableId5')]",
          "tableType": "CustomLog",
          "columns": [
                    {
                        "name": "metric_date",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "value",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "start_time",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "end_time",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "domain_id",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "data_type",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "domain_name",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "tenant_url",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "TimeGenerated",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    }
          ],
          "standardColumns": [
            {
              "name": "TenantId",
              "type": "guid",
              "isDefaultDisplay": false,
              "isHidden": false
            }
          ],
          "solutions": [
            "LogManagement"
          ],
          "isTroubleshootingAllowed": true
        },
        "provisioningState": "Succeeded",
        "retentionInDays": 30
      },
      "id": "[concat('/subscriptions/', parameters('subscription'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspace'), '/tables/', variables('_logAnalyticsTableId5'))]"
    },
    // --- Custom Log Table 6 (BHEPostureStatsData_CL) ---
    {
      "name": "[concat(parameters('workspace'), '/', variables('_logAnalyticsTableId6'))]",
      "apiVersion": "2022-10-01",
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "location": "[parameters('workspace-location')]",
      "kind": null,
      "properties": {
        "totalRetentionInDays": 30,
        "archiveRetentionInDays": 0,
        "plan": "Analytics",
        "retentionInDaysAsDefault": true,
        "totalRetentionInDaysAsDefault": true,
        "schema": {
          "tableSubType": "DataCollectionRuleBased",
          "name": "[variables('_logAnalyticsTableId6')]",
          "tableType": "CustomLog",
          "columns": [
                    {
                        "name": "domain_sid",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "exposure_index",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "tier_zero_count",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "critical_risk_count",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "id",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "tenant_url",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "created_at",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "updated_at",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "deleted_at",
                        "type": "dynamic",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "domain_name",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "TimeGenerated",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    }
          ],
          "standardColumns": [
            {
              "name": "TenantId",
              "type": "guid",
              "isDefaultDisplay": false,
              "isHidden": false
            }
          ],
          "solutions": [
            "LogManagement"
          ],
          "isTroubleshootingAllowed": true
        },
        "provisioningState": "Succeeded",
        "retentionInDays": 30
      },
      "id": "[concat('/subscriptions/', parameters('subscription'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspace'), '/tables/', variables('_logAnalyticsTableId6'))]"
    },
    // --- Custom Log Table 7 (BHETierZeroAssetsData_CL) ---
    {
      "name": "[concat(parameters('workspace'), '/', variables('_logAnalyticsTableId7'))]",
      "apiVersion": "2022-10-01",
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "location": "[parameters('workspace-location')]",
      "kind": null,
      "properties": {
        "totalRetentionInDays": 30,
        "archiveRetentionInDays": 0,
        "plan": "Analytics",
        "retentionInDaysAsDefault": true,
        "totalRetentionInDaysAsDefault": true,
        "schema": {
          "tableSubType": "DataCollectionRuleBased",
          "name": "[variables('_logAnalyticsTableId7')]",
          "tableType": "CustomLog",
          "columns": [
                    {
                        "name": "nodeId",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "label",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "kindType",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "objectId",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "isTierZero",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "isOwnedObject",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "lastSeen",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "tenant_url",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "domain_name",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "name",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "properties",
                        "type": "dynamic",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "displayname",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "description",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "distinguishedname",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "samaccountname",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "userprincipalname",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "email",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "Title",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "domain",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "domainsid",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "tenantid",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "ownersid",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "functionallevel",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "admincount",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "isaclprotected",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "sensitive",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "enabled",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "isbuiltin",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "isassignabletorole",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "securityenabled",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "securityidentifier",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "dontreqpreauth",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "passwordnotreqd",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "pwdneverexpires",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "passwordexpired",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "pwdlastset",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "lastlogon",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "lastlogontimestamp",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "unicodepassword",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "unixpassword",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "userpassword",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "sfupassword",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "operatingsystem",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "isdc",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "haslaps",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "unconstraineddelegation",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "trustedtoauth",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "lockedout",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "webclientrunning",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "certificatemappingmethods",
                        "type": "dynamic",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "certificatemappingmethodsraw",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "strongcertificatebindingenforcement",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "strongcertificatebindingenforcementraw",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "supportedencryptiontypes",
                        "type": "dynamic",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "serviceprincipalnames",
                        "type": "dynamic",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "clientallowedntlmservers",
                        "type": "dynamic",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "ntlmminclientsec",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "ntlmminserversec",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "lmcompatibilitylevel",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "smbsigning",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "enablesecuritysignature",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "requiresecuritysignature",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "restrictoutboundntlm",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "restrictreceivingntmltraffic",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "ldapavailable",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "ldapsavailable",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "ldapsepa",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "ldapsigning",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "blocksinheritance",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "gpcpath",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "appid",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "appdescription",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "appdisplayname",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "appownerorganizationid",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "serviceprincipaltype",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "publisherdomain",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "signinaudience",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "loginurl",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "onpremid",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "onpremsyncenabled",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "usertype",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "templateid",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "gmsa",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "hasspn",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "whencreated",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "collected",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "Date",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "homedirectory",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "logonscript",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "logonscriptenabled",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "sidhistory",
                        "type": "dynamic",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "usedeskeyonly",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "usemachineid",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "encryptedtextpwdallowed",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "doesanyacegrantownerrights",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "doesanyinheritedacegrantownerrights",
                        "type": "boolean",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "composite_azure_users",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "composite_computers",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "composite_principals",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "composite_risk_assets",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "composite_sps",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "composite_users",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "composite_vms",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "descendent_count",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "owner_objectid",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "principal_count",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "tier_zero_active_assets_count",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "tier_zero_exposure_percent",
                        "type": "real",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "tier_zero_total_assets_count",
                        "type": "int",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "system_tags",
                        "type": "string",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    },
                    {
                        "name": "TimeGenerated",
                        "type": "datetime",
                        "isDefaultDisplay": false,
                        "isHidden": false
                    }
          ],
          "standardColumns": [
            {
              "name": "TenantId",
              "type": "guid",
              "isDefaultDisplay": false,
              "isHidden": false
            }
          ],
          "solutions": [
            "LogManagement"
          ],
          "isTroubleshootingAllowed": true
        },
        "provisioningState": "Succeeded",
        "retentionInDays": 30
      },
      "id": "[concat('/subscriptions/', parameters('subscription'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspace'), '/tables/', variables('_logAnalyticsTableId7'))]"
    },
    // --- Data Collection Rule (DCR) ---
    {
      "name": "[variables('dcrResourceName')]",
      "apiVersion": "2021-09-01-preview",
      "type": "Microsoft.Insights/dataCollectionRules",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceResourceName'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspace'), variables('_logAnalyticsTableId1'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspace'), variables('_logAnalyticsTableId2'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspace'), variables('_logAnalyticsTableId3'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspace'), variables('_logAnalyticsTableId4'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspace'), variables('_logAnalyticsTableId5'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspace'), variables('_logAnalyticsTableId6'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspace'), variables('_logAnalyticsTableId7'))]"
      ],
      "kind": null,
      "properties": {
        "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceResourceName'))]",
        "streamDeclarations": {
          // Stream for BHEAttackPathsData_CL
          "Custom-BHEAttackPathsData_CL": {
            "columns": [
                    {
                        "name": "TimeGenerated",
                        "type": "datetime"
                    },
                    {
                        "name": "NonTierZeroPrincipal",
                        "type": "string"
                    },
                    {
                        "name": "ImpactedPrincipal",
                        "type": "string"
                    },
                    {
                        "name": "domain_name",
                        "type": "string"
                    },
                    {
                        "name": "NonTierZeroPrincipalProps",
                        "type": "dynamic"
                    },
                    {
                        "name": "NonTierZeroPrincipalKind",
                        "type": "string"
                    },
                    {
                        "name": "ImpactedPrincipalProps",
                        "type": "dynamic"
                    },
                    {
                        "name": "ImpactedPrincipalKind",
                        "type": "string"
                    },
                    {
                        "name": "RelProps",
                        "type": "dynamic"
                    },
                    {
                        "name": "ComboGraphRelationID",
                        "type": "int"
                    },
                    {
                        "name": "Finding",
                        "type": "string"
                    },
                    {
                        "name": "DomainSID",
                        "type": "string"
                    },
                    {
                        "name": "PrincipalHash",
                        "type": "string"
                    },
                    {
                        "name": "ImpactPercentage",
                        "type": "string"
                    },
                    {
                        "name": "ImpactCount",
                        "type": "int"
                    },
                    {
                        "name": "ExposurePercentage",
                        "type": "string"
                    },
                    {
                        "name": "ExposureCount",
                        "type": "int"
                    },
                    {
                        "name": "Severity",
                        "type": "string"
                    },
                    {
                        "name": "AcceptedUntil",
                        "type": "string"
                    },
                    {
                        "name": "Accepted",
                        "type": "boolean"
                    },
                    {
                        "name": "Environment",
                        "type": "string"
                    },
                    {
                        "name": "NonTierZeroPrincipalName",
                        "type": "string"
                    },
                    {
                        "name": "ImpactedPrincipalName",
                        "type": "string"
                    },
                    {
                        "name": "IsInherited",
                        "type": "string"
                    },
                    {
                        "name": "NonTierZeroPrincipalEnvironment",
                        "type": "string"
                    },
                    {
                        "name": "NonTierZeroPrincipalEnvironmentID",
                        "type": "string"
                    },
                    {
                        "name": "ImpactedPrincipalEnvironment",
                        "type": "string"
                    },
                    {
                        "name": "ImpactedPrincipalEnvironmentID",
                        "type": "string"
                    },
                    {
                        "name": "id",
                        "type": "int"
                    },
                    {
                        "name": "created_at",
                        "type": "string"
                    },
                    {
                        "name": "updated_at",
                        "type": "string"
                    },
                    {
                        "name": "deleted_at",
                        "type": "dynamic"
                    },
                    {
                        "name": "tenant_url",
                        "type": "string"
                    },
                    {
                        "name": "Remediation",
                        "type": "string"
                    },
                    {
                        "name": "PathTitle",
                        "type": "string"
                    },
                    {
                        "name": "ShortDescription",
                        "type": "string"
                    },
                    {
                        "name": "ShortRemediation",
                        "type": "string"
                    },
                    {
                        "name": "LongRemediation",
                        "type": "string"
                    }
            ]
          },
          // Stream for BHEAttackPathsTimelineData_CL
          "Custom-BHEAttackPathsTimelineData_CL": {
            "columns": [
                    {
                        "name": "TimeGenerated",
                        "type": "datetime"
                    },
                    {
                        "name": "CompositeRisk",
                        "type": "string"
                    },
                    {
                        "name": "domain_name",
                        "type": "string"
                    },
                    {
                        "name": "tenant_url",
                        "type": "string"
                    },
                    {
                        "name": "FindingCount",
                        "type": "int"
                    },
                    {
                        "name": "ExposureCount",
                        "type": "int"
                    },
                    {
                        "name": "ImpactCount",
                        "type": "int"
                    },
                    {
                        "name": "ImpactedAssetCount",
                        "type": "int"
                    },
                    {
                        "name": "DomainSID",
                        "type": "string"
                    },
                    {
                        "name": "Finding",
                        "type": "string"
                    },
                    {
                        "name": "id",
                        "type": "int"
                    },
                    {
                        "name": "path_title",
                        "type": "string"
                    },
                    {
                        "name": "created_at",
                        "type": "datetime"
                    },
                    {
                        "name": "updated_at",
                        "type": "datetime"
                    },
                    {
                        "name": "deleted_at",
                        "type": "dynamic"
                    }
            ]
          },
          // Stream for BHEAuditLogsData_CL
          "Custom-BHEAuditLogsData_CL": {
            "columns": [
                    {
                        "name": "TimeGenerated",
                        "type": "datetime"
                    },
                    {
                        "name": "id",
                        "type": "int"
                    },
                    {
                        "name": "created_at",
                        "type": "datetime"
                    },
                    {
                        "name": "actor_id",
                        "type": "string"
                    },
                    {
                        "name": "actor_name",
                        "type": "string"
                    },
                    {
                        "name": "actor_email",
                        "type": "string"
                    },
                    {
                        "name": "action",
                        "type": "string"
                    },
                    {
                        "name": "fields",
                        "type": "dynamic"
                    },
                    {
                        "name": "request_id",
                        "type": "string"
                    },
                    {
                        "name": "source_ip_address",
                        "type": "string"
                    },
                    {
                        "name": "status",
                        "type": "string"
                    },
                    {
                        "name": "commit_id",
                        "type": "string"
                    },
                    {
                        "name": "tenant_url",
                        "type": "string"
                    }
            ]
          },
          // Stream for BHEFindingTrendsData_CL
          "Custom-BHEFindingTrendsData_CL": {
            "columns": [
                    {
                        "name": "TimeGenerated",
                        "type": "datetime"
                    },
                    {
                        "name": "composite_risk",
                        "type": "string"
                    },
                    {
                        "name": "display_title",
                        "type": "string"
                    },
                    {
                        "name": "display_type",
                        "type": "string"
                    },
                    {
                        "name": "environment_id",
                        "type": "string"
                    },
                    {
                        "name": "exposure_count",
                        "type": "int"
                    },
                    {
                        "name": "finding",
                        "type": "string"
                    },
                    {
                        "name": "finding_count_decrease",
                        "type": "int"
                    },
                    {
                        "name": "finding_count_end",
                        "type": "int"
                    },
                    {
                        "name": "finding_count_increase",
                        "type": "int"
                    },
                    {
                        "name": "finding_count_start",
                        "type": "int"
                    },
                    {
                        "name": "impact_count",
                        "type": "int"
                    },
                    {
                        "name": "tenant_url",
                        "type": "string"
                    },
                    {
                        "name": "domain_name",
                        "type": "string"
                    },
                    {
                        "name": "start_date",
                        "type": "datetime"
                    },
                    {
                        "name": "end_date",
                        "type": "datetime"
                    }
            ]
          },
          // Stream for BHEPostureHistoryData_CL
          "Custom-BHEPostureHistoryData_CL": {
            "columns": [
                    {
                        "name": "TimeGenerated",
                        "type": "datetime"
                    },
                    {
                        "name": "metric_date",
                        "type": "datetime"
                    },
                    {
                        "name": "value",
                        "type": "string"
                    },
                    {
                        "name": "start_time",
                        "type": "datetime"
                    },
                    {
                        "name": "end_time",
                        "type": "datetime"
                    },
                    {
                        "name": "domain_id",
                        "type": "string"
                    },
                    {
                        "name": "data_type",
                        "type": "string"
                    },
                    {
                        "name": "domain_name",
                        "type": "string"
                    },
                    {
                        "name": "tenant_url",
                        "type": "string"
                    }
            ]
          },
          // Stream for BHEPostureStatsData_CL
          "Custom-BHEPostureStatsData_CL": {
            "columns": [
                    {
                        "name": "TimeGenerated",
                        "type": "datetime"
                    },
                    {
                        "name": "domain_sid",
                        "type": "string"
                    },
                    {
                        "name": "exposure_index",
                        "type": "string"
                    },
                    {
                        "name": "tier_zero_count",
                        "type": "int"
                    },
                    {
                        "name": "critical_risk_count",
                        "type": "int"
                    },
                    {
                        "name": "id",
                        "type": "int"
                    },
                    {
                        "name": "tenant_url",
                        "type": "string"
                    },
                    {
                        "name": "created_at",
                        "type": "datetime"
                    },
                    {
                        "name": "updated_at",
                        "type": "datetime"
                    },
                    {
                        "name": "deleted_at",
                        "type": "dynamic"
                    },
                    {
                        "name": "domain_name",
                        "type": "string"
                    }
            ]
          },
          // Stream for BHETierZeroAssetsData_CL
          "Custom-BHETierZeroAssetsData_CL": {
            "columns": [
                    {
                        "name": "TimeGenerated",
                        "type": "datetime"
                    },
                    {
                        "name": "nodeId",
                        "type": "string"
                    },
                    {
                        "name": "label",
                        "type": "string"
                    },
                    {
                        "name": "kindType",
                        "type": "string"
                    },
                    {
                        "name": "objectId",
                        "type": "string"
                    },
                    {
                        "name": "isTierZero",
                        "type": "boolean"
                    },
                    {
                        "name": "isOwnedObject",
                        "type": "boolean"
                    },
                    {
                        "name": "lastSeen",
                        "type": "datetime"
                    },
                    {
                        "name": "tenant_url",
                        "type": "string"
                    },
                    {
                        "name": "domain_name",
                        "type": "string"
                    },
                    {
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "name": "properties",
                        "type": "dynamic"
                    },
                    {
                        "name": "displayname",
                        "type": "string"
                    },
                    {
                        "name": "description",
                        "type": "string"
                    },
                    {
                        "name": "distinguishedname",
                        "type": "string"
                    },
                    {
                        "name": "samaccountname",
                        "type": "string"
                    },
                    {
                        "name": "userprincipalname",
                        "type": "string"
                    },
                    {
                        "name": "email",
                        "type": "string"
                    },
                    {
                        "name": "Title",
                        "type": "string"
                    },
                    {
                        "name": "domain",
                        "type": "string"
                    },
                    {
                        "name": "domainsid",
                        "type": "string"
                    },
                    {
                        "name": "tenantid",
                        "type": "string"
                    },
                    {
                        "name": "ownersid",
                        "type": "string"
                    },
                    {
                        "name": "functionallevel",
                        "type": "string"
                    },
                    {
                        "name": "admincount",
                        "type": "boolean"
                    },
                    {
                        "name": "isaclprotected",
                        "type": "boolean"
                    },
                    {
                        "name": "sensitive",
                        "type": "boolean"
                    },
                    {
                        "name": "enabled",
                        "type": "boolean"
                    },
                    {
                        "name": "isbuiltin",
                        "type": "boolean"
                    },
                    {
                        "name": "isassignabletorole",
                        "type": "boolean"
                    },
                    {
                        "name": "securityenabled",
                        "type": "boolean"
                    },
                    {
                        "name": "securityidentifier",
                        "type": "string"
                    },
                    {
                        "name": "dontreqpreauth",
                        "type": "boolean"
                    },
                    {
                        "name": "passwordnotreqd",
                        "type": "boolean"
                    },
                    {
                        "name": "pwdneverexpires",
                        "type": "boolean"
                    },
                    {
                        "name": "passwordexpired",
                        "type": "boolean"
                    },
                    {
                        "name": "pwdlastset",
                        "type": "int"
                    },
                    {
                        "name": "lastlogon",
                        "type": "int"
                    },
                    {
                        "name": "lastlogontimestamp",
                        "type": "int"
                    },
                    {
                        "name": "unicodepassword",
                        "type": "string"
                    },
                    {
                        "name": "unixpassword",
                        "type": "string"
                    },
                    {
                        "name": "userpassword",
                        "type": "string"
                    },
                    {
                        "name": "sfupassword",
                        "type": "string"
                    },
                    {
                        "name": "operatingsystem",
                        "type": "datetime"
                    },
                    {
                        "name": "isdc",
                        "type": "boolean"
                    },
                    {
                        "name": "haslaps",
                        "type": "boolean"
                    },
                    {
                        "name": "unconstraineddelegation",
                        "type": "boolean"
                    },
                    {
                        "name": "trustedtoauth",
                        "type": "boolean"
                    },
                    {
                        "name": "lockedout",
                        "type": "boolean"
                    },
                    {
                        "name": "webclientrunning",
                        "type": "boolean"
                    },
                    {
                        "name": "certificatemappingmethods",
                        "type": "dynamic"
                    },
                    {
                        "name": "certificatemappingmethodsraw",
                        "type": "int"
                    },
                    {
                        "name": "strongcertificatebindingenforcement",
                        "type": "string"
                    },
                    {
                        "name": "strongcertificatebindingenforcementraw",
                        "type": "int"
                    },
                    {
                        "name": "supportedencryptiontypes",
                        "type": "dynamic"
                    },
                    {
                        "name": "serviceprincipalnames",
                        "type": "dynamic"
                    },
                    {
                        "name": "clientallowedntlmservers",
                        "type": "dynamic"
                    },
                    {
                        "name": "ntlmminclientsec",
                        "type": "int"
                    },
                    {
                        "name": "ntlmminserversec",
                        "type": "int"
                    },
                    {
                        "name": "lmcompatibilitylevel",
                        "type": "int"
                    },
                    {
                        "name": "smbsigning",
                        "type": "boolean"
                    },
                    {
                        "name": "enablesecuritysignature",
                        "type": "boolean"
                    },
                    {
                        "name": "requiresecuritysignature",
                        "type": "boolean"
                    },
                    {
                        "name": "restrictoutboundntlm",
                        "type": "boolean"
                    },
                    {
                        "name": "restrictreceivingntmltraffic",
                        "type": "boolean"
                    },
                    {
                        "name": "ldapavailable",
                        "type": "boolean"
                    },
                    {
                        "name": "ldapsavailable",
                        "type": "boolean"
                    },
                    {
                        "name": "ldapsepa",
                        "type": "boolean"
                    },
                    {
                        "name": "ldapsigning",
                        "type": "boolean"
                    },
                    {
                        "name": "blocksinheritance",
                        "type": "boolean"
                    },
                    {
                        "name": "gpcpath",
                        "type": "string"
                    },
                    {
                        "name": "appid",
                        "type": "string"
                    },
                    {
                        "name": "appdescription",
                        "type": "string"
                    },
                    {
                        "name": "appdisplayname",
                        "type": "string"
                    },
                    {
                        "name": "appownerorganizationid",
                        "type": "string"
                    },
                    {
                        "name": "serviceprincipaltype",
                        "type": "string"
                    },
                    {
                        "name": "publisherdomain",
                        "type": "string"
                    },
                    {
                        "name": "signinaudience",
                        "type": "string"
                    },
                    {
                        "name": "loginurl",
                        "type": "string"
                    },
                    {
                        "name": "onpremid",
                        "type": "datetime"
                    },
                    {
                        "name": "onpremsyncenabled",
                        "type": "boolean"
                    },
                    {
                        "name": "usertype",
                        "type": "string"
                    },
                    {
                        "name": "templateid",
                        "type": "datetime"
                    },
                    {
                        "name": "gmsa",
                        "type": "boolean"
                    },
                    {
                        "name": "hasspn",
                        "type": "boolean"
                    },
                    {
                        "name": "whencreated",
                        "type": "int"
                    },
                    {
                        "name": "collected",
                        "type": "boolean"
                    },
                    {
                        "name": "Date",
                        "type": "datetime"
                    },
                    {
                        "name": "homedirectory",
                        "type": "string"
                    },
                    {
                        "name": "logonscript",
                        "type": "string"
                    },
                    {
                        "name": "logonscriptenabled",
                        "type": "boolean"
                    },
                    {
                        "name": "sidhistory",
                        "type": "dynamic"
                    },
                    {
                        "name": "usedeskeyonly",
                        "type": "boolean"
                    },
                    {
                        "name": "usemachineid",
                        "type": "boolean"
                    },
                    {
                        "name": "encryptedtextpwdallowed",
                        "type": "boolean"
                    },
                    {
                        "name": "doesanyacegrantownerrights",
                        "type": "boolean"
                    },
                    {
                        "name": "doesanyinheritedacegrantownerrights",
                        "type": "boolean"
                    },
                    {
                        "name": "composite_azure_users",
                        "type": "int"
                    },
                    {
                        "name": "composite_computers",
                        "type": "int"
                    },
                    {
                        "name": "composite_principals",
                        "type": "int"
                    },
                    {
                        "name": "composite_risk_assets",
                        "type": "int"
                    },
                    {
                        "name": "composite_sps",
                        "type": "int"
                    },
                    {
                        "name": "composite_users",
                        "type": "int"
                    },
                    {
                        "name": "composite_vms",
                        "type": "int"
                    },
                    {
                        "name": "descendent_count",
                        "type": "int"
                    },
                    {
                        "name": "owner_objectid",
                        "type": "string"
                    },
                    {
                        "name": "principal_count",
                        "type": "int"
                    },
                    {
                        "name": "tier_zero_active_assets_count",
                        "type": "int"
                    },
                    {
                        "name": "tier_zero_exposure_percent",
                        "type": "real"
                    },
                    {
                        "name": "tier_zero_total_assets_count",
                        "type": "int"
                    },
                    {
                        "name": "system_tags",
                        "type": "string"
                    }
            ]
          }
        },
        "dataSources": {},
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[variables('workspaceResourceId')]",
              "workspaceId": "[parameters('workspaceId')]",
              "name": "[parameters('workspaceId')]"
            }
          ]
        },
        "dataFlows": [
          // Data flow for BHEAttackPathsData_CL
          {
            "streams": [
              "Custom-BHEAttackPathsData_CL"
            ],
            "destinations": [
              "[parameters('workspaceId')]"
            ],
            "transformKql": "source | extend TimeGenerated = now()",
            "outputStream": "Custom-BHEAttackPathsData_CL"
          },
          // Data flow for BHEAttackPathsTimelineData_CL
          {
            "streams": [
              "Custom-BHEAttackPathsTimelineData_CL"
            ],
            "destinations": [
              "[parameters('workspaceId')]"
            ],
            "transformKql": "source | extend TimeGenerated = now()",
            "outputStream": "Custom-BHEAttackPathsTimelineData_CL"
          },
          // Data flow for BHEAuditLogsData_CL
          {
            "streams": [
              "Custom-BHEAuditLogsData_CL"
            ],
            "destinations": [
              "[parameters('workspaceId')]"
            ],
            "transformKql": "source | extend TimeGenerated = now()",
            "outputStream": "Custom-BHEAuditLogsData_CL"
          },
          // Data flow for BHEFindingTrendsData_CL
          {
            "streams": [
                    "Custom-BHEFindingTrendsData_CL"
                ],
                "destinations": [
                    "[parameters('workspaceId')]"
                ],
                "transformKql": "source\n| extend TimeGenerated = now()\n",
                "outputStream": "Custom-BHEFindingTrendsData_CL"
          },
          // Data flow for BHEPostureHistoryData_CL
          {
                "streams": [
                    "Custom-BHEPostureHistoryData_CL"
                ],
                "destinations": [
                    "[parameters('workspaceId')]"
                ],
                "transformKql": "source\n| extend TimeGenerated = now()\n",
                "outputStream": "Custom-BHEPostureHistoryData_CL"
          },
          // Data flow for BHEPostureStatsData_CL
          {
                "streams": [
                    "Custom-BHEPostureStatsData_CL"
                ],
                "destinations": [
                    "[parameters('workspaceId')]"
                ],
                "transformKql": "source\n| extend TimeGenerated = now()\n",
                "outputStream": "Custom-BHEPostureStatsData_CL"
          },
          // Data flow for BHETierZeroAssetsData_CL
          {
                "streams": [
                    "Custom-BHETierZeroAssetsData_CL"
                ],
                "destinations": [
                    "[parameters('workspaceId')]"
                ],
                "transformKql": "source\n| extend TimeGenerated = now()\n",
                "outputStream": "Custom-BHETierZeroAssetsData_CL"
          }
        ],
        "provisioningState": "Succeeded"
      }
    }
  ]
}
