{
  "name": "dcr-cyren-ip-reputation",
  "apiVersion": "2024-03-11",
  "type": "Microsoft.Insights/dataCollectionRules",
  "location": "{{location}}",
  "properties": {
    "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
    "streamDeclarations": {
      "Custom-Cyren_Indicators_CL": {
        "columns": [
          { "name": "TimeGenerated", "type": "datetime" },
          { "name": "payload", "type": "dynamic" },
          { "name": "timestamp", "type": "datetime" },
          { "name": "url_s", "type": "string" },
          { "name": "ip_s", "type": "string" },
          { "name": "fileHash_s", "type": "string" },
          { "name": "domain_s", "type": "string" },
          { "name": "protocol_s", "type": "string" },
          { "name": "port_d", "type": "int" },
          { "name": "category_s", "type": "string" },
          { "name": "risk_d", "type": "int" },
          { "name": "firstSeen_t", "type": "datetime" },
          { "name": "lastSeen_t", "type": "datetime" },
          { "name": "source_s", "type": "string" },
          { "name": "relationships_s", "type": "string" },
          { "name": "detection_methods_s", "type": "string" },
          { "name": "action_s", "type": "string" },
          { "name": "type_s", "type": "string" },
          { "name": "identifier_s", "type": "string" },
          { "name": "detection_ts_t", "type": "datetime" },
          { "name": "object_type_s", "type": "string" }
        ]
      }
    },
    "destinations": {
      "logAnalytics": [
        {
          "workspaceResourceId": "{{workspaceResourceId}}",
          "name": "clv2ws1"
        }
      ]
    },
    "dataFlows": [
      {
        "streams": [ "Custom-Cyren_Indicators_CL" ],
        "destinations": [ "clv2ws1" ],
        "transformKql": "source | extend p=todynamic(payload) | extend d=todynamic(p.detection), m=todynamic(p.meta) | extend url_str=tostring(p.url) | extend TimeGenerated=todatetime(timestamp), url_s=url_str, ip_s=tostring(p.identifier), domain_s=iif(isnotempty(url_str), tostring(split(split(url_str, '://')[1], '/')[0]), ''), fileHash_s='', protocol_s=tostring(m.protocol), port_d=toint(m.port), category_s=iif(isnull(d.category), '', strcat_array(d.category, ',')), risk_d=toint(d.risk), firstSeen_t=todatetime(p.first_seen), lastSeen_t=todatetime(p.last_seen), source_s='Cyren IP Reputation', relationships_s=tostring(p.relationships), detection_methods_s=iif(isnull(p.detection_methods), '', strcat_array(p.detection_methods, ',')), action_s=tostring(p.action), type_s=tostring(p.type), identifier_s=tostring(p.identifier), detection_ts_t=todatetime(d.detection_ts), object_type_s=tostring(m.object_type) | project TimeGenerated, url_s, ip_s, fileHash_s, domain_s, protocol_s, port_d, category_s, risk_d, firstSeen_t, lastSeen_t, source_s, relationships_s, detection_methods_s, action_s, type_s, identifier_s, detection_ts_t, object_type_s",
        "outputStream": "Custom-Cyren_Indicators_CL"
      }
    ]
  }
}
