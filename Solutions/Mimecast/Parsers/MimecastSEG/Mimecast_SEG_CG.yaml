id: 91267889-770d-451b-9ed8-d3ed260c48e3
Function:
  Title: Parser for Mimecast SEG Cloud Gateway
  Version: "1.0.0"
  LastUpdated: "2024-07-25"
Category: Microsoft Sentinel Parser
FunctionName: MimecastCG
FunctionAlias: MimecastCG
FunctionQuery: |
  let dummy_table = datatable(TimeGenerated: datetime) [];
  let MimecastCG_view = view() {
  union isfuzzy=true dummy_table,
  Seg_Cg_CL
  | extend  
        ["Time Generated"] = column_ifexists('TimeGenerated', ''),
        ["Url Category"] = columnifexists("urlCategory_s", ""),
        ["Scan Results"] = columnifexists("scanResults_s", ""),
        ["File Name"] = columnifexists("fileName_s", ""),
        ["Sha256"] = columnifexists("sha256_s", ""),
        ["File Extension"] = columnifexists("fileExtension_s", ""),
        ["Virus Found"] = columnifexists("virusFound_s", ""),
        ["Sha1"] = columnifexists("sha1_s", ""),
        ["Sender Domain"] = columnifexists("senderDomain_s", ""),
        ["Md5"] = columnifexists("md5_g", ""),
        ["Custom Threat Dictionary"] = columnifexists("customThreatDictionary_s", ""),
        ["Items Detected"] = columnifexists("itemsDetected_s", ""),
        ["Similar Custom External Domain"] = columnifexists("similarCustomExternalDomain_s", ""),
        ["Tagged External"] = columnifexists("taggedExternal_s", ""),
        ["Similar Internal Domain"] = columnifexists("similarInternalDomain_s", ""),
        ["New Domain"] = columnifexists("newDomain_s", ""),
        ["Internal User Name"] = columnifexists("internalUserName_s", ""),
        ["Mimecast Threat Dictionary"] = columnifexists("mimecastThreatDictionary_s", ""),
        ["Similar Mimecast External Domain"] = columnifexists("similarMimecastExternalDomain_s", ""),
        ["Custom Name Match"] = columnifexists("customNameMatch_s", ""),
        ["Tagged Malicious"] = columnifexists("taggedMalicious_s", ""),
        ["Reply Mismatch"] = columnifexists("replyMismatch_s", ""),
        ["Aggregate ID S"] = columnifexists("aggregateId_s", ""),
        ["Aggregate ID G"] = columnifexists("aggregateId_g", ""),
        ["Rejection Type"] = columnifexists("rejectionType_s", ""),
        ["Rejection Code"] = columnifexists("rejectionCode_s", ""),
        ["Rejection Info"] = columnifexists("rejectionInfo_s", ""),
        ["Delivered"] = columnifexists("delivered_s", ""),
        ["Destination IP"] = columnifexists("destinationIp_s", ""),
        ["Host Name"] = columnifexists("Hostname_s", ""),
        ["Delivery Attempts"] = columnifexists("deliveryAttempts_s", ""),
        ["TLS Used"] = columnifexists("tlsUsed_s", ""),
        ["Delivery Errors"] = columnifexists("deliveryErrors_s", ""),
        ["Attachments"] = columnifexists("attachments_s", ""),
        ["Route"] = columnifexists("route_s", ""),
        ["Processing ID"] = columnifexists("processingId_s", ""),
        ["Account ID"] = columnifexists("accountId_s", ""),
        ["Action"] = columnifexists("action_s", ""),
        ["Event Time"] = columnifexists("timestamp_d", ""),
        ["Sender Envelope"] = columnifexists("senderEnvelope_s", ""),
        ["Message ID"] = columnifexists("messageId_s", ""),
        ["Subject"] = columnifexists("subject_s", ""),
        ["Total of Size Attachments"] = columnifexists("totalSizeAttachments_s", ""),
        ["Number of Attachments"] = columnifexists("numberAttachments_s", ""),
        ["Email Size"] = columnifexists("emailSize_s", ""),
        ["Type"] = columnifexists("type_s", ""),
        ["Sub Type"] = columnifexists("subtype_s", ""),
        ["Monitored Domain Source"] = columnifexists("monitoredDomainSource_s", ""),
        ["Similar Domain"] = columnifexists("similarDomain_s", ""),
        ["Offset"] = columnifexists("_offset_d", ""),
        ["Partition"] = columnifexists("_partition_d", ""),
        ["Hold Reason"] = columnifexists("holdReason_s", ""),
        ["Recipients"] = columnifexists("recipients_s", ""),
        ["Sender IP"] = columnifexists("senderIp_s", ""),
        ["Direction"] = columnifexists("direction_s", ""),
        ["Sender Header"] = columnifexists("senderHeader_s", ""),
        ["TLS Version"] = columnifexists("tlsVersion_s", ""),
        ["TLS Cipher"] = columnifexists("tlsCipher_s", ""),
        ["Spam Info"] = columnifexists("spamInfo_s", ""),
        ["Spam Processing Detail"] = columnifexists("spamProcessingDetail_s", "")
  | summarize arg_max(["Time Generated"], *) by 
        ["Url Category"],
        ["Scan Results"],
        ["File Name"],
        ["Sha256"],
        ["File Extension"],
        ["Virus Found"],
        ["Sha1"],
        ["Sender Domain"],
        ["Md5"],
        ["Custom Threat Dictionary"],
        ["Items Detected"],
        ["Similar Custom External Domain"],
        ["Tagged External"],
        ["Similar Internal Domain"],
        ["New Domain"],
        ["Internal User Name"],
        ["Mimecast Threat Dictionary"],
        ["Similar Mimecast External Domain"],
        ["Custom Name Match"],
        ["Tagged Malicious"],
        ["Reply Mismatch"],
        ["Aggregate ID"] = coalesce(["Aggregate ID S"], ["Aggregate ID G"]),
        ["Rejection Type"],
        ["Rejection Code"],
        ["Rejection Info"],
        ["Delivered"],
        ["Destination IP"],
        ["Host Name"],
        ["Delivery Attempts"],
        ["TLS Used"],
        ["Delivery Errors"],
        ["Attachments"],
        ["Route"],
        ["Processing ID"],
        ["Account ID"],
        ["Action"],
        ["Event Time"],
        ["Sender Envelope"],
        ["Message ID"],
        ["Subject"],
        ["Total of Size Attachments"],
        ["Number of Attachments"],
        ["Email Size"],
        ["Type"],
        ["Sub Type"],
        ["Monitored Domain Source"],
        ["Similar Domain"],
        ["Hold Reason"],
        ["Recipients"],
        ["Sender IP"],
        ["Direction"],
        ["Sender Header"],
        ["TLS Version"],
        ["TLS Cipher"],
        ["Spam Info"],
        ["Spam Processing Detail"]
  | extend ['Event Time'] = iff( isempty( ['Event Time']) ,now() , todatetime(unixtime_milliseconds_todatetime( tolong(["Event Time"]) ))  )
  | extend  ['Message ID'] = trim(@"[\<\>]", ['Message ID'] )
  | project 
        ["Time Generated"],
        ["Url Category"],
        ["Scan Results"],
        ["File Name"],
        ["Sha256"],
        ["File Extension"],
        ["Virus Found"],
        ["Sha1"],
        ["Sender Domain"],
        ["Md5"],
        ["Custom Threat Dictionary"],
        ["Items Detected"],
        ["Similar Custom External Domain"],
        ["Tagged External"],
        ["Similar Internal Domain"],
        ["New Domain"],
        ["Internal User Name"],
        ["Mimecast Threat Dictionary"],
        ["Similar Mimecast External Domain"],
        ["Custom Name Match"],
        ["Tagged Malicious"],
        ["Reply Mismatch"],
        ["Aggregate ID"] = coalesce(["Aggregate ID S"], ["Aggregate ID G"]),
        ["Rejection Type"],
        ["Rejection Code"],
        ["Rejection Info"],
        ["Delivered"],
        ["Destination IP"],
        ["Host Name"],
        ["Delivery Attempts"],
        ["TLS Used"],
        ["Delivery Errors"],
        ["Attachments"],
        ["Route"],
        ["Processing ID"],
        ["Account ID"],
        ["Action"],
        ["Event Time"] ,
        ["Sender Envelope"],
        ["Message ID"],
        ["Subject"],
        ["Total of Size Attachments"],
        ["Number of Attachments"],
        ["Email Size"],
        ["Type"],
        ["Sub Type"],
        ["Monitored Domain Source"],
        ["Similar Domain"],
        ["Offset"],
        ["Partition"],
        ["Hold Reason"],
        ["Recipients"],
        ["Sender IP"],
        ["Direction"],
        ["Sender Header"],
        ["TLS Version"],
        ["TLS Cipher"],
        ["Spam Info"],
        ["Spam Processing Detail"]
  };
  MimecastCG_view
