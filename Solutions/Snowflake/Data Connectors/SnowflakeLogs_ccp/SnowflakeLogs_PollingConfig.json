[
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2025-03-01",
    "name": "SnowflakeLoadPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "APIKey",
        "ApiKey": "{{apikey}}",
        "ApiKeyName": "Authorization",
        "ApiKeyIdentifier": "Bearer"
      },
      "request": {
        "apiEndpoint": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','/api/v2/statements?retry=true')]",
        "httpMethod": "POST",
        "queryWindowInMin": 10,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 180,
        "isPostPayloadJson": true,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "nullable": "false"
        },
        "queryParametersTemplate": "{\r\n                        \"statement\": \"SELECT OBJECT_CONSTRUCT_KEEP_NULL(*) AS data FROM LOAD_HISTORY WHERE LAST_LOAD_TIME > '{_QueryWindowStartTime}' AND LAST_LOAD_TIME < '{_QueryWindowEndTime}' ORDER BY LAST_LOAD_TIME ASC\",\r\n                        \"database\": \"SNOWFLAKE\",\r\n                        \"schema\": \"ACCOUNT_USAGE\"\r\n                    }"
      },
      "response": {
        "eventsJsonPaths": [
          "$"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "LinkHeader",
        "linkHeaderTokenJsonPath": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','$.statementStatusUrl')]"
      },
      "connectorDefinitionName": "SnowflakeLogsCCPDefinition",
      "dataType": "SnowflakeLoad",
      "dcrConfig": {
        "streamName": "Custom-SnowflakeLoad",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      },
      "addOnAttributes": {
        "AccountId": "{{accountId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2025-03-01",
    "name": "SnowflakeLoginPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "APIKey",
        "ApiKey": "{{apiKey}}",
        "ApiKeyName": "Authorization",
        "ApiKeyIdentifier": "Bearer"
      },
      "request": {
        "apiEndpoint": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','/api/v2/statements?retry=true')]",
        "httpMethod": "POST",
        "queryWindowInMin": 10,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 180,
        "isPostPayloadJson": true,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "nullable": "false"
        },
        "queryParametersTemplate": "{\r\n                        \"statement\": \"SELECT OBJECT_CONSTRUCT_KEEP_NULL(*) AS data FROM LOGIN_HISTORY WHERE EVENT_TIMESTAMP > '{_QueryWindowStartTime}' AND EVENT_TIMESTAMP < '{_QueryWindowEndTime}' ORDER BY EVENT_TIMESTAMP ASC\",\r\n                        \"database\": \"SNOWFLAKE\",\r\n                        \"schema\": \"ACCOUNT_USAGE\"\r\n                    }"
      },
      "response": {
        "eventsJsonPaths": [
          "$"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "LinkHeader",
        "linkHeaderTokenJsonPath": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','$.statementStatusUrl')]"
      },
      "connectorDefinitionName": "SnowflakeLogsCCPDefinition",
      "dataType": "SnowflakeLogin",
      "dcrConfig": {
        "streamName": "Custom-SnowflakeLogin",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      },
      "addOnAttributes": {
        "AccountId": "{{accountId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2025-03-01",
    "name": "SnowflakeMaterializedViewPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "APIKey",
        "ApiKey": "{{apiKey}}",
        "ApiKeyName": "Authorization",
        "ApiKeyIdentifier": "Bearer"
      },
      "request": {
        "apiEndpoint": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','/api/v2/statements?retry=true')]",
        "httpMethod": "POST",
        "queryWindowInMin": 10,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 180,
        "isPostPayloadJson": true,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "nullable": "false"
        },
        "queryParametersTemplate": "{\r\n                        \"statement\": \"SELECT OBJECT_CONSTRUCT_KEEP_NULL(*) AS data FROM MATERIALIZED_VIEW_REFRESH_HISTORY WHERE START_TIME > '{_QueryWindowStartTime}' AND START_TIME < '{_QueryWindowEndTime}' ORDER BY START_TIME ASC\",\r\n                        \"database\": \"SNOWFLAKE\",\r\n                        \"schema\": \"ACCOUNT_USAGE\"\r\n                    }"
      },
      "response": {
        "eventsJsonPaths": [
          "$"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "LinkHeader",
        "linkHeaderTokenJsonPath": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','$.statementStatusUrl')]"
      },
      "connectorDefinitionName": "SnowflakeLogsCCPDefinition",
      "dataType": "SnowflakeMaterializedView",
      "dcrConfig": {
        "streamName": "Custom-SnowflakeMaterializedView",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      },
      "addOnAttributes": {
        "AccountId": "{{accountId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2025-03-01",
    "name": "SnowflakeQueryPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "APIKey",
        "ApiKey": "{{apiKey}}",
        "ApiKeyName": "Authorization",
        "ApiKeyIdentifier": "Bearer"
      },
      "request": {
        "apiEndpoint": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','/api/v2/statements?retry=true')]",
        "httpMethod": "POST",
        "queryWindowInMin": 10,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 180,
        "isPostPayloadJson": true,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "nullable": "false"
        },
        "queryParametersTemplate": "{\r\n                        \"statement\": \"SELECT OBJECT_CONSTRUCT_KEEP_NULL(*) AS data FROM QUERY_HISTORY WHERE START_TIME > '{_QueryWindowStartTime}' AND START_TIME < '{_QueryWindowEndTime}' ORDER BY START_TIME ASC\",\r\n                        \"database\": \"SNOWFLAKE\",\r\n                        \"schema\": \"ACCOUNT_USAGE\"\r\n                    }"
      },
      "response": {
        "eventsJsonPaths": [
          "$"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "LinkHeader",
        "linkHeaderTokenJsonPath": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','$.statementStatusUrl')]"
      },
      "connectorDefinitionName": "SnowflakeLogsCCPDefinition",
      "dataType": "SnowflakeQuery",
      "dcrConfig": {
        "streamName": "Custom-SnowflakeQuery",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      },
      "addOnAttributes": {
        "AccountId": "{{accountId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2025-03-01",
    "name": "SnowflakeRoleGrantPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "APIKey",
        "ApiKey": "{{apiKey}}",
        "ApiKeyName": "Authorization",
        "ApiKeyIdentifier": "Bearer"
      },
      "request": {
        "apiEndpoint": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','/api/v2/statements?retry=true')]",
        "httpMethod": "POST",
        "queryWindowInMin": 10,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 180,
        "isPostPayloadJson": true,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "nullable": "false"
        },
        "queryParametersTemplate": "{\r\n                        \"statement\": \"SELECT OBJECT_CONSTRUCT_KEEP_NULL(*) AS data FROM GRANTS_TO_ROLES WHERE CREATED_ON > '{_QueryWindowStartTime}' AND CREATED_ON < '{_QueryWindowEndTime}' ORDER BY CREATED_ON ASC\",\r\n                        \"database\": \"SNOWFLAKE\",\r\n                        \"schema\": \"ACCOUNT_USAGE\"\r\n                    }"
      },
      "response": {
        "eventsJsonPaths": [
          "$"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "LinkHeader",
        "linkHeaderTokenJsonPath": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','$.statementStatusUrl')]"
      },
      "connectorDefinitionName": "SnowflakeLogsCCPDefinition",
      "dataType": "SnowflakeRoleGrant",
      "dcrConfig": {
        "streamName": "Custom-SnowflakeRoleGrant",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      },
      "addOnAttributes": {
        "AccountId": "{{accountId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2025-03-01",
    "name": "SnowflakeRolesPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "APIKey",
        "ApiKey": "{{apiKey}}",
        "ApiKeyName": "Authorization",
        "ApiKeyIdentifier": "Bearer"
      },
      "request": {
        "apiEndpoint": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','/api/v2/statements?retry=true')]",
        "httpMethod": "POST",
        "queryWindowInMin": 10,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 180,
        "isPostPayloadJson": true,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "nullable": "false"
        },
        "queryParametersTemplate": "{\r\n                        \"statement\": \"SELECT OBJECT_CONSTRUCT_KEEP_NULL(*) AS data FROM ROLES WHERE CREATED_ON > '{_QueryWindowStartTime}' AND CREATED_ON < '{_QueryWindowEndTime}' ORDER BY CREATED_ON ASC\",\r\n                        \"database\": \"SNOWFLAKE\",\r\n                        \"schema\": \"ACCOUNT_USAGE\"\r\n                    }"
      },
      "response": {
        "eventsJsonPaths": [
          "$"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "LinkHeader",
        "linkHeaderTokenJsonPath": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','$.statementStatusUrl')]"
      },
      "connectorDefinitionName": "SnowflakeLogsCCPDefinition",
      "dataType": "SnowflakeRoles",
      "dcrConfig": {
        "streamName": "Custom-SnowflakeRoles",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      },
      "addOnAttributes": {
        "AccountId": "{{accountId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2025-03-01",
    "name": "SnowflakeTablePoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "APIKey",
        "ApiKey": "{{apiKey}}",
        "ApiKeyName": "Authorization",
        "ApiKeyIdentifier": "Bearer"
      },
      "request": {
        "apiEndpoint": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','/api/v2/statements?retry=true')]",
        "httpMethod": "POST",
        "queryWindowInMin": 10,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 180,
        "isPostPayloadJson": true,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "nullable": "false"
        },
        "queryParametersTemplate": "{\r\n                        \"statement\": \"SELECT OBJECT_CONSTRUCT_KEEP_NULL(*) AS data FROM TABLES WHERE CREATED > '{_QueryWindowStartTime}' AND CREATED < '{_QueryWindowEndTime}' ORDER BY CREATED ASC\",\r\n                        \"database\": \"SNOWFLAKE\",\r\n                        \"schema\": \"ACCOUNT_USAGE\"\r\n                    }"
      },
      "response": {
        "eventsJsonPaths": [
          "$"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "LinkHeader",
        "linkHeaderTokenJsonPath": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','$.statementStatusUrl')]"
      },
      "connectorDefinitionName": "SnowflakeLogsCCPDefinition",
      "dataType": "SnowflakeTable",
      "dcrConfig": {
        "streamName": "Custom-SnowflakeTable",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      },
      "addOnAttributes": {
        "AccountId": "{{accountId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2025-03-01",
    "name": "SnowflakeTableStorageMetricsPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "APIKey",
        "ApiKey": "{{apiKey}}",
        "ApiKeyName": "Authorization",
        "ApiKeyIdentifier": "Bearer"
      },
      "request": {
        "apiEndpoint": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','/api/v2/statements?retry=true')]",
        "httpMethod": "POST",
        "queryWindowInMin": 10,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 180,
        "isPostPayloadJson": true,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "nullable": "false"
        },
        "queryParametersTemplate": "{\r\n                        \"statement\": \"SELECT OBJECT_CONSTRUCT_KEEP_NULL(*) AS data FROM TABLE_STORAGE_METRICS WHERE TABLE_CREATED > '{_QueryWindowStartTime}' AND TABLE_CREATED < '{_QueryWindowEndTime}' ORDER BY TABLE_CREATED ASC\",\r\n                        \"database\": \"SNOWFLAKE\",\r\n                        \"schema\": \"ACCOUNT_USAGE\"\r\n                    }"
      },
      "response": {
        "eventsJsonPaths": [
          "$"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "LinkHeader",
        "linkHeaderTokenJsonPath": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','$.statementStatusUrl')]"
      },
      "connectorDefinitionName": "SnowflakeLogsCCPDefinition",
      "dataType": "SnowflakeTableStorageMetrics",
      "dcrConfig": {
        "streamName": "Custom-SnowflakeTableStorageMetrics",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      },
      "addOnAttributes": {
        "AccountId": "{{accountId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2025-03-01",
    "name": "SnowflakeUserGrantPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "APIKey",
        "ApiKey": "{{apiKey}}",
        "ApiKeyName": "Authorization",
        "ApiKeyIdentifier": "Bearer"
      },
      "request": {
        "apiEndpoint": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','/api/v2/statements?retry=true')]",
        "httpMethod": "POST",
        "queryWindowInMin": 10,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 180,
        "isPostPayloadJson": true,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "nullable": "false"
        },
        "queryParametersTemplate": "{\r\n                        \"statement\": \"SELECT OBJECT_CONSTRUCT_KEEP_NULL(*) AS data FROM GRANTS_TO_USERS WHERE CREATED_ON > '{_QueryWindowStartTime}' AND CREATED_ON < '{_QueryWindowEndTime}' ORDER BY CREATED_ON ASC\",\r\n                        \"database\": \"SNOWFLAKE\",\r\n                        \"schema\": \"ACCOUNT_USAGE\"\r\n                    }"
      },
      "response": {
        "eventsJsonPaths": [
          "$"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "LinkHeader",
        "linkHeaderTokenJsonPath": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','$.statementStatusUrl')]"
      },
      "connectorDefinitionName": "SnowflakeLogsCCPDefinition",
      "dataType": "SnowflakeUserGrant",
      "dcrConfig": {
        "streamName": "Custom-SnowflakeUserGrant",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      },
      "addOnAttributes": {
        "AccountId": "{{accountId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2025-03-01",
    "name": "SnowflakeUsersPoller",
    "location": "[parameters('workspace-location')]",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "APIKey",
        "ApiKey": "{{apiKey}}",
        "ApiKeyName": "Authorization",
        "ApiKeyIdentifier": "Bearer"
      },
      "request": {
        "apiEndpoint": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','/api/v2/statements?retry=true')]",
        "httpMethod": "POST",
        "queryWindowInMin": 10,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 5,
        "timeoutInSeconds": 180,
        "isPostPayloadJson": true,
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "nullable": "false"
        },
        "queryParametersTemplate": "{\r\n                        \"statement\": \"SELECT OBJECT_CONSTRUCT_KEEP_NULL(*) AS data FROM USERS WHERE CREATED_ON > '{_QueryWindowStartTime}' AND CREATED_ON < '{_QueryWindowEndTime}' ORDER BY CREATED_ON ASC\",\r\n                        \"database\": \"SNOWFLAKE\",\r\n                        \"schema\": \"ACCOUNT_USAGE\"\r\n                    }"
      },
      "response": {
        "eventsJsonPaths": [
          "$"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "LinkHeader",
        "linkHeaderTokenJsonPath": "[[concat('https://',parameters('accountId'),'.snowflakecomputing.com','$.statementStatusUrl')]"
      },
      "connectorDefinitionName": "SnowflakeLogsCCPDefinition",
      "dataType": "SnowflakeUsers",
      "dcrConfig": {
        "streamName": "Custom-SnowflakeUsers",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      },
      "addOnAttributes": {
        "AccountId": "{{accountId}}"
      }
    }
  }
]