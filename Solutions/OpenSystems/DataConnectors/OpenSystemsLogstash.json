{
  "id": "OpenSystemsLogstash",
  "title": "OpenSystems Logstash Connector",
  "publisher": "OpenSystems",
  "descriptionMarkdown": "This data connector deploys a Logstash instance to collect logs from your OpenSystems environment via Event Hub and ingest them into Azure Sentinel.",
  "graphQueries": [
    {
      "metricName": "Total ZTNA logs received",
      "legend": "OSAGZtnaLogs_CL",
      "baseQuery": "OSAGZtnaLogs_CL"
    },
    {
      "metricName": "Total Firewall logs received",
      "legend": "OSAGFirewallLogs_CL",
      "baseQuery": "OSAGFirewallLogs_CL"
    },
    {
      "metricName": "Total Authentication logs received",
      "legend": "OSAGAuthenticationLogs_CL",
      "baseQuery": "OSAGAuthenticationLogs_CL"
    },
    {
      "metricName": "Total Proxy logs received",
      "legend": "OSAGProxyLogs_CL",
      "baseQuery": "OSAGProxyLogs_CL"
    }
  ],
  "sampleQueries": [
    {
      "description": "Raw ZTNA logs",
      "query": "OSAGZtnaLogs_CL | take 100"
    },
    {
      "description": "View normalized ZTNA events (ASIM Authentication)",
      "query": "OpenSystemsImZTNA | take 100"
    },
    {
      "description": "Raw Firewall logs",
      "query": "OSAGFirewallLogs_CL | take 100"
    },
    {
      "description": "View normalized Firewall network sessions (ASIM NetworkSession)",
      "query": "OpenSystemsImNetworkSessionFirewall | take 100"
    },
    {
      "description": "Raw Authentication logs",
      "query": "OSAGAuthenticationLogs_CL | take 100"
    },
    {
      "description": "View normalized Authentication events (ASIM Authentication)",
      "query": "OpenSystemsImAuthentication | take 100"
    },
    {
      "description": "Raw Proxy logs",
      "query": "OSAGProxyLogs_CL | take 100"
    },
    {
      "description": "View normalized Proxy network events (ASIM NetworkSession/HTTP)",
      "query": "OpenSystemsImNetworkSessionProxy | take 100"
    }
  ],
  "dataTypes": [
    {
      "name": "OSAGZtnaLogs_CL",
      "lastDataReceivedQuery": "OSAGZtnaLogs_CL | summarize LastLogReceived = max(TimeGenerated) | project LastLogReceived"
    },
    {
      "name": "OSAGFirewallLogs_CL",
      "lastDataReceivedQuery": "OSAGFirewallLogs_CL | summarize LastLogReceived = max(TimeGenerated) | project LastLogReceived"
    },
    {
      "name": "OSAGAuthenticationLogs_CL",
      "lastDataReceivedQuery": "OSAGAuthenticationLogs_CL | summarize LastLogReceived = max(TimeGenerated) | project LastLogReceived"
    },
    {
      "name": "OSAGProxyLogs_CL",
      "lastDataReceivedQuery": "OSAGProxyLogs_CL | summarize LastLogReceived = max(TimeGenerated) | project LastLogReceived"
    }
  ],
  "connectivityCriterias": [
    {
      "type": "IsConnectedQuery",
      "value": [
        "OSAGZtnaLogs_CL | summarize LastLogReceived = max(TimeGenerated) | project IsConnected = LastLogReceived > ago(1d)",
        "OSAGFirewallLogs_CL | summarize LastLogReceived = max(TimeGenerated) | project IsConnected = LastLogReceived > ago(1d)",
        "OSAGAuthenticationLogs_CL | summarize LastLogReceived = max(TimeGenerated) | project IsConnected = LastLogReceived > ago(1d)",
        "OSAGProxyLogs_CL | summarize LastLogReceived = max(TimeGenerated) | project IsConnected = LastLogReceived > ago(1d)"
      ]
    }
  ],
  "availability": {
    "status": 1,
    "isPreview": true
  },
  "permissions": {
    "resourceProvider": [
      {
        "provider": "Microsoft.OperationalInsights/workspaces",
        "permissionsDisplayText": "read and write permissions are required.",
        "providerDisplayName": "Workspace",
        "scope": "Workspace",
        "requiredPermissions": {
          "write": true,
          "read": true,
          "delete": true
        }
      },
      {
        "provider": "Microsoft.OperationalInsights/solutions",
        "permissionsDisplayText": "read permission is required.",
        "providerDisplayName": "Solution",
        "scope": "Workspace",
        "requiredPermissions": {
          "read": true
        }
      }
    ],
    "customs": [
      {
        "name": "Azure Container Apps, DCRs, and DCEs",
        "description": "Permissions to deploy Azure Container Apps, Managed Environments, Data Collection Rules (DCRs), and Data Collection Endpoints (DCEs) are required. This is typically covered by having the 'Contributor' role on the subscription or resource group."
      },
      {
        "name": "Role Assignment Permissions",
        "description": "Permissions to create role assignments (specifically 'Monitoring Metrics Publisher' on DCRs) are required for the deploying user or service principal."
      },
      {
        "name": "Required Credentials for ARM Template",
        "description": "During deployment, you will need to provide: Event Hub endpoint and connection string, and Service Principal credentials (Client ID, Client Secret, Object/Principal ID)."
      }
    ]
  },
  "instructionSteps": [
    {
      "title": "STEP 1: Prerequisites",
      "description": "Ensure you have the following information and permissions before proceeding: \n1. Event Hub Endpoint and Connection String. \n2. Service Principal credentials (Client ID, Client Secret, Object/Principal ID). \n3. Permissions to deploy Azure Container Apps, Managed Environments, Data Collection Rules (DCRs), Data Collection Endpoints (DCEs), and create Role Assignments (typically 'Contributor' role on the subscription or resource group)."
    },
    {
      "title": "STEP 2: Deploy the Connector",
      "description": "Deploy the ARM template to set up the Logstash container instance, data collection rule, and associated resources.\n\n1. Click the **Deploy to Azure** button below. This will take you to the Azure portal.\n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-OpenSystemsLogstash-azuredeploy)\n\n2. In the Azure portal, select your desired **Subscription**, **Resource Group**, and **Region**.\n3. Provide the required parameters, including those gathered in the prerequisites step (Event Hub details, Service Principal credentials, etc.), when prompted by the deployment wizard.\n4. Review the terms and click **Review + create**, then **Create** to start the deployment."
    },
    {
      "title": "STEP 3: Post-Deployment Verification",
      "description": "After successful deployment: \n1. Verify that the Azure Container App running the Logstash instance is in a 'Running' state. \n2. Check the `OSAGZtnaLogs_CL`, `OSAGFirewallLogs_CL`, `OSAGAuthenticationLogs_CL`, and `OSAGProxyLogs_CL` tables in your Log Analytics workspace for incoming data. It may take some time for logs to appear after initial setup. \n3. Use the sample queries provided in the 'Next Steps' tab of this data connector page to view and analyze your logs."
    }
  ]
}
