{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for Global Secure Access"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Enriched Microsoft 365 logs Workbook",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook2-name": {
      "type": "string",
      "defaultValue": "Network Traffic Insights",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "_solutionName": "Global Secure Access",
    "_solutionVersion": "3.0.0",
    "solutionId": "azuresentinel.azure-sentinel-solution-globalsecureaccess",
    "_solutionId": "[variables('solutionId')]",
    "workbookVersion1": "1.0.1",
    "workbookContentId1": "GSAM365EnrichedEvents",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "workbookVersion2": "1.0.1",
    "workbookContentId2": "GSANetworkTraffic",
    "workbookId2": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId2'))]",
    "workbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId2'))))]",
    "_workbookContentId2": "[variables('workbookContentId2')]",
    "_workbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId2'),'-', variables('workbookVersion2'))))]",
    "analyticRuleObject1": {
      "analyticRuleVersion1": "1.0.2",
      "_analyticRulecontentId1": "4c9f0a9e-44d7-4c9b-b7f0-f6a6e0d8f8fa",
      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4c9f0a9e-44d7-4c9b-b7f0-f6a6e0d8f8fa')]",
      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('4c9f0a9e-44d7-4c9b-b7f0-f6a6e0d8f8fa')))]",
      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','4c9f0a9e-44d7-4c9b-b7f0-f6a6e0d8f8fa','-', '1.0.2')))]"
    },
    "analyticRuleObject2": {
      "analyticRuleVersion2": "1.0.2",
      "_analyticRulecontentId2": "e3b6a9e7-4c3a-45e6-8baf-1d3bfa8e0c2b",
      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'e3b6a9e7-4c3a-45e6-8baf-1d3bfa8e0c2b')]",
      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('e3b6a9e7-4c3a-45e6-8baf-1d3bfa8e0c2b')))]",
      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','e3b6a9e7-4c3a-45e6-8baf-1d3bfa8e0c2b','-', '1.0.2')))]"
    },
    "analyticRuleObject3": {
      "analyticRuleVersion3": "1.0.2",
      "_analyticRulecontentId3": "f6a8d6a5-3e9f-47c8-a8d5-1b2b9d3b7d6a",
      "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'f6a8d6a5-3e9f-47c8-a8d5-1b2b9d3b7d6a')]",
      "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('f6a8d6a5-3e9f-47c8-a8d5-1b2b9d3b7d6a')))]",
      "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','f6a8d6a5-3e9f-47c8-a8d5-1b2b9d3b7d6a','-', '1.0.2')))]"
    },
    "analyticRuleObject4": {
      "analyticRuleVersion4": "1.0.2",
      "_analyticRulecontentId4": "82cfa6b9-5f7e-4b8b-8b2f-a63f21b7a7d1",
      "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '82cfa6b9-5f7e-4b8b-8b2f-a63f21b7a7d1')]",
      "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('82cfa6b9-5f7e-4b8b-8b2f-a63f21b7a7d1')))]",
      "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','82cfa6b9-5f7e-4b8b-8b2f-a63f21b7a7d1','-', '1.0.2')))]"
    },
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "GSAM365EnrichedEvents Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "This Workbook provides a detailed view of Microsoft 365 log data, enriched with contextual information to enhance visibility into user activities and potential security threats."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"Please select the Log Analytics Workspace with 'NetworkAccessTrafficLogs' enabled in the Microsoft Entra ID 'Diagnostic settings'\",\"style\":\"info\"},\"name\":\"text - 14\",\"styleSettings\":{\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"## Enriched Microsoft 365 logs Workbook\\n---\\n\\nThe enriched Microsoft 365 logs provide information about Microsoft 365 workloads, so you can review network data and security events relevant to Microsoft 365 apps.\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"value::all\"],\"parameters\":[{\"id\":\"ff8b2a55-1849-4848-acf8-eab5452e9f10\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"LogAnalyticWorkspace\",\"label\":\"Log Analytic Workspace\",\"type\":5,\"description\":\"The Log Analytic Workspace In Which To Execute The Queries\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.operationalinsights/workspaces\\\"\\r\\n| project id\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.operationalinsights/workspaces\":true},\"additionalResourceOptions\":[\"value::1\",\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"f15f34d8-8e2d-4c39-8dee-be2f979c86a8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":3600000}},{\"id\":\"8bab511b-53b3-4220-9d1c-372345b06728\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Users\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"EnrichedMicrosoft365AuditLogs\\r\\n| summarize Count = count() by UserId\\r\\n| order by Count desc, UserId asc\\r\\n| project Value = UserId, Label = strcat(UserId, ' - ', Count, ' Logs'), Selected = false\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"typeSettings\":{\"limitSelectTo\":20,\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"value::all\"]}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 15\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"tabStyle\":\"bigger\",\"links\":[{\"id\":\"e841bafb-6437-4d29-84ac-ba16c5a6d901\",\"cellValue\":\"selTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"ac5f2082-50bc-4739-bdf2-20c93b613671\",\"cellValue\":\"selTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"SharePoint/OneDrive Insights\",\"subTarget\":\"Threat\",\"style\":\"link\"},{\"id\":\"dc2778e7-739b-44ba-9ae4-c81901277f57\",\"cellValue\":\"selTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Exchange Online Insights\",\"subTarget\":\"ThreatEXO\",\"style\":\"link\"},{\"id\":\"666111e2-54ff-4fa4-a648-11a5c8c0235b\",\"cellValue\":\"selTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Teams Insights\",\"subTarget\":\"ThreatTeams\",\"style\":\"link\"}]},\"name\":\"links - 7\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where UserId in ({Users}) or '*' in ({Users})\\r\\n| where OfficeWorkload in (\\\"Exchange\\\")\\r\\n| extend GeoInfo = geo_info_from_ip_address(SourceIp) // Assuming a function exists to pull geo info\\r\\n| extend \\r\\n    Country = tostring(GeoInfo.country), \\r\\n    State = tostring(GeoInfo.state), \\r\\n    City = tostring(GeoInfo.city), \\r\\n    Latitude = tostring(GeoInfo.latitude), \\r\\n    Longitude = tostring(GeoInfo.longitude)\\r\\n| project \\r\\n    UserId, \\r\\n    Location = strcat(City, ', ', State, ', ', Country), // Constructing a full location string\\r\\n    Latitude, \\r\\n    Longitude, \\r\\n    City, \\r\\n    State, \\r\\n    Country\\r\\n| summarize Count = count() by City, State, Country\\r\\n\",\"size\":0,\"title\":\"Access By Location\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"CountryRegion\",\"locInfoColumn\":\"Country\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"Count\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"Country\",\"legendMetric\":\"Count\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"Count\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"turquoise\"}}},\"customWidth\":\"50\",\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where UserId in ({Users}) or '*' in ({Users})\\r\\n| where OfficeWorkload in (\\\"Exchange\\\")\\r\\n| summarize [\\\"Count\\\"] = count() by [\\\"Source IP\\\"] = SourceIp, [\\\"Device Operating System\\\"] = DeviceOperatingSystem\\r\\n| order by [\\\"Count\\\"] desc\\r\\n\",\"size\":0,\"title\":\"Access By Location And OS\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"]},\"customWidth\":\"50\",\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where Operation in (\\\"Set-AdminAuditLogConfig\\\", \\\"Set-OrganizationConfig\\\")\\r\\n| project TimeGenerated, [\\\"User ID\\\"] = UserId, [\\\"Client IP\\\"] = SourceIp, Operation\\r\\n| summarize Count = count() by TimeGenerated, [\\\"User ID\\\"], [\\\"Client IP\\\"], Operation\\r\\n| project TimeGenerated, [\\\"User ID\\\"], [\\\"Client IP\\\"], Operation, Count\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"title\":\"Audit Of Critical Configuration Changes\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}}]}},\"customWidth\":\"50\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where Operation in (\\\"Set-TransportRule\\\", \\\"Set-AtpPolicyForO365\\\", \\\"Set-MalwareFilterRule\\\")\\r\\n| project TimeGenerated, [\\\"User ID\\\"] = UserId, [\\\"Client IP\\\"] = SourceIp, Operation\\r\\n| summarize Count = count() by TimeGenerated, [\\\"User ID\\\"], [\\\"Client IP\\\"], Operation\\r\\n| project TimeGenerated, [\\\"User ID\\\"], [\\\"Client IP\\\"], Operation, Count\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"title\":\"Changes In Email Security Policies\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}}]}},\"customWidth\":\"50\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where Operation in (\\\"Add-RoleGroupMember\\\", \\\"Remove-ManagementRoleAssignment\\\")\\r\\n| project TimeGenerated, [\\\"User ID\\\"] = UserId, [\\\"Client IP\\\"] = SourceIp, Operation\\r\\n| summarize Count = count() by TimeGenerated, [\\\"User ID\\\"], [\\\"Client IP\\\"], Operation\\r\\n| project TimeGenerated, [\\\"User ID\\\"], [\\\"Client IP\\\"], Operation, Count\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"title\":\"Monitoring Role Group Membership Changes\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}}]}},\"customWidth\":\"50\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where Operation in (\\\"New-TenantAllowBlockListSpoofitems\\\", \\\"Remove-TenantAllowBlockListSpoofitems\\\")\\r\\n| project TimeGenerated, [\\\"User ID\\\"] = UserId, [\\\"Client IP\\\"] = SourceIp, Operation\\r\\n| summarize Count = count() by TimeGenerated, [\\\"User ID\\\"], [\\\"Client IP\\\"], Operation\\r\\n| project TimeGenerated, [\\\"User ID\\\"], [\\\"Client IP\\\"], Operation, Count\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"title\":\"Spoofing Settings Management Activities\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}}]}},\"customWidth\":\"50\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where Operation in (\\\"New-SafeAttachmentPolicy\\\", \\\"Set-SafeAttachmentPolicy\\\", \\\"Set-SafeAttachmentRule\\\")\\r\\n| project TimeGenerated, [\\\"User ID\\\"] = UserId, [\\\"Client IP\\\"] = SourceIp, Operation\\r\\n| summarize Count = count() by TimeGenerated, [\\\"User ID\\\"], [\\\"Client IP\\\"], Operation\\r\\n| project TimeGenerated, [\\\"User ID\\\"], [\\\"Client IP\\\"], Operation, Count\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"title\":\"Safe Attachments Policy Changes\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}}]}},\"customWidth\":\"50\",\"name\":\"query - 6\"}]},\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"ThreatEXO\"},\"name\":\"group - 18\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId, UserPrincipalName\\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId | where OfficeWorkload == \\\"Exchange\\\" | where Operation in (\\\"Add-MailboxFolderPermission\\\", \\\"Add-RoleGroupMember\\\", \\\"New-TransportRule\\\", \\\"Remove-ManagementRoleAssignment\\\", \\\"Set-TransportRule\\\") | summarize Count = count(), Users = makeset(UserPrincipalName) by Operation | order by Count desc\",\"size\":0,\"title\":\"Permission changes and security policy updates\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"seltab\",\"comparison\":\"isEqualTo\",\"value\":\"ThreatEXO\"},\"name\":\"query - 13\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where UserId in ({Users}) or '*' in ({Users})\\r\\n| where OfficeWorkload in (\\\"Teams\\\")\\r\\n| extend GeoInfo = geo_info_from_ip_address(SourceIp) // Assuming a function exists to pull geo info\\r\\n| extend \\r\\n    Country = tostring(GeoInfo.country), \\r\\n    State = tostring(GeoInfo.state), \\r\\n    City = tostring(GeoInfo.city), \\r\\n    Latitude = tostring(GeoInfo.latitude), \\r\\n    Longitude = tostring(GeoInfo.longitude)\\r\\n| project \\r\\n    UserId, \\r\\n    Location = strcat(City, ', ', State, ', ', Country), // Constructing a full location string\\r\\n    Latitude, \\r\\n    Longitude, \\r\\n    City, \\r\\n    State, \\r\\n    Country\\r\\n| summarize Count = count() by City, State, Country\\r\\n\",\"size\":0,\"title\":\"Access By Location\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"CountryRegion\",\"locInfoColumn\":\"Country\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"Count\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"Country\",\"legendMetric\":\"Count\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"Count\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"turquoise\"}}},\"customWidth\":\"50\",\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where UserId in ({Users}) or '*' in ({Users})\\r\\n| where OfficeWorkload in (\\\"Teams\\\")\\r\\n| summarize [\\\"Count\\\"] = count() by [\\\"Source IP\\\"] = SourceIp, [\\\"Device Operating System\\\"] = DeviceOperatingSystem\\r\\n| order by [\\\"Count\\\"] desc\\r\\n\",\"size\":0,\"title\":\"Access By Location And OS\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"]},\"customWidth\":\"50\",\"name\":\"query - 1\"}]},\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"ThreatTeams\"},\"name\":\"group - 10\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where UserId in ({Users}) or '*' in ({Users})\\r\\n| where OfficeWorkload in (\\\"OneDrive\\\", \\\"SharePoint\\\",\\\"SPO/OneDrive\\\")\\r\\n| extend GeoInfo = geo_info_from_ip_address(SourceIp) // Assuming a function exists to pull geo info\\r\\n| extend \\r\\n    Country = tostring(GeoInfo.country), \\r\\n    State = tostring(GeoInfo.state), \\r\\n    City = tostring(GeoInfo.city), \\r\\n    Latitude = tostring(GeoInfo.latitude), \\r\\n    Longitude = tostring(GeoInfo.longitude)\\r\\n| project \\r\\n    UserId, \\r\\n    Location = strcat(City, ', ', State, ', ', Country), // Constructing a full location string\\r\\n    Latitude, \\r\\n    Longitude, \\r\\n    City, \\r\\n    State, \\r\\n    Country\\r\\n| summarize Count = count() by City, State, Country\\r\\n\",\"size\":0,\"title\":\"Access By Location\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"CountryRegion\",\"locInfoColumn\":\"Country\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"Count\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"Country\",\"legendMetric\":\"Country\",\"numberOfMetrics\":19,\"legendAggregation\":\"Count\",\"itemColorSettings\":{\"nodeColorField\":\"Count\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"turquoise\"}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Threat\"},\"name\":\"query - 19\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where UserId in ({Users}) or '*' in ({Users})\\r\\n| where OfficeWorkload in (\\\"OneDrive\\\", \\\"SharePoint\\\", \\\"SPO/OneDrive\\\")\\r\\n| summarize [\\\"Event Count\\\"] = count() by [\\\"Source IP\\\"] = SourceIp, [\\\"Device Operating System\\\"] = DeviceOperatingSystem\\r\\n| order by [\\\"Event Count\\\"] desc\\r\\n\",\"size\":2,\"title\":\"Access By Location And OS\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 20\"}]},\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Threat\"},\"name\":\"group - 20\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId, UserPrincipalName \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where OfficeWorkload == \\\"Teams\\\"\\r\\n| where Operation in (\\\"MemberAdded\\\", \\\"MemberRemoved\\\", \\\"TeamDeleted\\\")\\r\\n| project TimeGenerated, [\\\"User ID\\\"] = UserId, UserPrincipalName, [\\\"Client IP\\\"] = SourceIp, Operation\\r\\n| summarize Count = count() by TimeGenerated, [\\\"User ID\\\"],UserPrincipalName, [\\\"Client IP\\\"], Operation\\r\\n| project TimeGenerated, [\\\"User\\\"] = UserPrincipalName, [\\\"User ID\\\"], [\\\"Client IP\\\"], Operation, Count\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"title\":\"Changes In Team Memberships\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"ThreatTeams\"},\"customWidth\":\"50\",\"name\":\"query - 11\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let RiskyExtensions = dynamic([\\\"exe\\\", \\\"msi\\\", \\\"bat\\\", \\\"cmd\\\", \\\"com\\\", \\\"scr\\\", \\\"pif\\\", \\\"ps1\\\", \\\"vbs\\\", \\\"js\\\", \\\"jse\\\", \\\"wsf\\\", \\\"docm\\\", \\\"xlsm\\\", \\\"pptm\\\", \\\"dll\\\", \\\"ocx\\\", \\\"cpl\\\", \\\"app\\\", \\\"vb\\\", \\\"reg\\\", \\\"inf\\\", \\\"hta\\\"]);\\r\\n\\r\\nNetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId, UserPrincipalName\\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where OfficeWorkload in (\\\"SPO/OneDrive\\\")\\r\\n| where UserId in ({Users}) or '*' in ({Users})\\r\\n| where SourceFileExtension in (RiskyExtensions)\\r\\n| project TimeGenerated, [\\\"User ID\\\"] = UserId, UserPrincipalName, [\\\"Client IP\\\"] = SourceIp, SourceFileExtension, Operation\\r\\n| summarize Count = count() by TimeGenerated, [\\\"User ID\\\"], UserPrincipalName, [\\\"Client IP\\\"], SourceFileExtension, Operation\\r\\n| project TimeGenerated, [\\\"User\\\"] = UserPrincipalName, [\\\"Client IP\\\"], SourceFileExtension, Operation, Count\\r\\n\",\"size\":0,\"title\":\"Risky File Operations\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"OperationCount\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}}]}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Threat\"},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId, UserPrincipalName\\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where OfficeWorkload in (\\\"OneDrive\\\", \\\"SharePoint\\\", \\\"SPO/OneDrive\\\")\\r\\n| where Operation in (\\\"FileRecycled\\\", \\\"FileDownloaded\\\", \\\"FileUploaded\\\", \\\"FileCreated\\\", \\\"File Modified\\\")\\r\\n| project TimeGenerated, UserPrincipalName, [\\\"User ID\\\"] = UserId, [\\\"Client IP\\\"] = SourceIp, Operation\\r\\n| summarize Count = count() by TimeGenerated, UserPrincipalName, [\\\"User ID\\\"], [\\\"Client IP\\\"], Operation\\r\\n| project TimeGenerated, [\\\"User\\\"] = UserPrincipalName, [\\\"Client IP\\\"], Operation, Count\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"title\":\"Bulk File Events\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}},{\"columnMatch\":\"OperationCount\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"}}]}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Threat\"},\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId, UserPrincipalName \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where OfficeWorkload in (\\\"SPO/OneDrive\\\")\\r\\n| where Operation == \\\"FileDeletedFirstStageRecycleBin\\\"\\r\\n| project Timestamp = TimeGenerated, [\\\"User ID\\\"] = UserId, UserPrincipalName, [\\\"Client IP\\\"] = SourceIp, Operation\\r\\n| summarize Count = count() by bin(Timestamp, 1h), [\\\"User ID\\\"], UserPrincipalName, [\\\"Client IP\\\"], Operation\\r\\n| project Timestamp, [\\\"User\\\"] = UserPrincipalName, [\\\"Client IP\\\"], Operation, Count\\r\\n| order by Count desc\\r\\n| where Count > 1\\r\\n\",\"size\":0,\"title\":\" Bulk File Deletion Operations\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}},{\"columnMatch\":\"FileDeletions\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}}]}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Threat\"},\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let baselinePeriod = 30d;\\r\\nlet detectionWindow = 1h;\\r\\nlet downloadThreshold = 5; // Threshold of downloads indicating potential exfiltration\\r\\n\\r\\nNetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId ,UserPrincipalName\\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where TimeGenerated >= ago(baselinePeriod)\\r\\n| where OfficeWorkload in (\\\"OneDrive\\\", \\\"SharePoint\\\", \\\"SPO/OneDrive\\\")\\r\\n| where Operation == \\\"FileDownloaded\\\"\\r\\n| project Timestamp = TimeGenerated, [\\\"User ID\\\"] = UserId, UserPrincipalName, [\\\"Client IP\\\"] = SourceIp, Operation\\r\\n| summarize Count = count() by bin(Timestamp, detectionWindow), UserPrincipalName, [\\\"User ID\\\"], [\\\"Client IP\\\"], Operation\\r\\n| project Timestamp, [\\\"User\\\"] = UserPrincipalName, [\\\"Client IP\\\"], Operation, Count\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"title\":\"Bulk File Download\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}},{\"columnMatch\":\"DownloadCount\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}}]}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Threat\"},\"name\":\"query - 4\"}]},\"name\":\"group - 9\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic\\r\\n| where TrafficType == 'microsoft365'\\r\\n| where UniqueTokenId != \\\"\\\"\\r\\n| project\\r\\n    UniqueTokenId,\\r\\n    SourceIp,\\r\\n    DeviceId,\\r\\n    DeviceOperatingSystem,\\r\\n    DeviceOperatingSystemVersion,\\r\\n    InitiatingProcessName,\\r\\n    AgentVersion,\\r\\n    UserId \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\n    on UniqueTokenId\\r\\n| where UserId in ('*') or '*' in ('*')\\r\\n| extend GeoInfo = geo_info_from_ip_address(SourceIp) // Assuming a function exists to pull geo info\\r\\n| extend \\r\\n    Country = tostring(GeoInfo.country), \\r\\n    State = tostring(GeoInfo.state), \\r\\n    City = tostring(GeoInfo.city), \\r\\n    Latitude = tostring(GeoInfo.latitude), \\r\\n    Longitude = tostring(GeoInfo.longitude)\\r\\n| project \\r\\n    UserId, \\r\\n    Location = strcat(City, ', ', State, ', ', Country), // Constructing a full location string\\r\\n    Latitude, \\r\\n    Longitude, \\r\\n    City, \\r\\n    State, \\r\\n    Country\\r\\n| where tostring(Country) != \\\"\\\"\\r\\n| summarize Count = count() by City, State, Country\\r\\n\",\"size\":0,\"title\":\"Access By Location\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"CountryRegion\",\"locInfoColumn\":\"Country\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"Count\",\"sizeAggregation\":\"Sum\",\"minSize\":20,\"labelSettings\":\"Country\",\"legendMetric\":\"Country\",\"numberOfMetrics\":8,\"legendAggregation\":\"Count\",\"itemColorSettings\":{\"nodeColorField\":\"Count\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"turquoise\"}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId, UserPrincipalName \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where UserId in ({Users}) or '*' in ({Users})\\r\\n| summarize [\\\"Event Count\\\"] = count() by [\\\"Time Generated\\\"] = TimeGenerated, [\\\"User\\\"] = UserPrincipalName, [\\\"Source IP\\\"] = SourceIp, [\\\"Device Operating System\\\"] = DeviceOperatingSystem, [\\\"Workload\\\"] = OfficeWorkload\\r\\n| order by [\\\"Time Generated\\\"] desc\\r\\n\",\"size\":0,\"title\":\"Access By Location And OS\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Time Generated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}}],\"rowLimit\":1000,\"filter\":true}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"query - 1\"}]},\"name\":\"group - 19\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = NetworkAccessTraffic\\r\\n    | where TrafficType == 'microsoft365'\\r\\n    | where UniqueTokenId != \\\"\\\"\\r\\n    | project\\r\\n        UniqueTokenId,\\r\\n        SourceIp,\\r\\n        DeviceId,\\r\\n        DeviceOperatingSystem,\\r\\n        DeviceOperatingSystemVersion,\\r\\n        InitiatingProcessName,\\r\\n        AgentVersion,\\r\\n        UserId,\\r\\n        UserPrincipalName \\r\\n    | join kind=inner (\\r\\n        OfficeActivity \\r\\n        | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n        | where UniqueTokenId != \\\"\\\")\\r\\n        on UniqueTokenId\\r\\n    | where UserId in ('*') or '*' in ('*')\\r\\n    | project \\r\\n        Operation, \\r\\n        UserId,\\r\\n        UserPrincipalName, \\r\\n        Workload = OfficeWorkload, \\r\\n        SourceIp, \\r\\n        DeviceId, \\r\\n        TimeGenerated, \\r\\n        Details = pack_all(),\\r\\n        OS = tostring(DeviceOperatingSystem)\\r\\n    | extend Workload = tostring(Workload)\\r\\n    | extend WorkloadStatus = case(\\r\\n                                  Workload == \\\"Exchange\\\",\\r\\n                                  \\\"Exchange\\\",\\r\\n                                  Workload == \\\"Teams\\\",\\r\\n                                  \\\"Teams\\\",\\r\\n                                  Workload == \\\"SharePoint\\\",\\r\\n                                  \\\"SharePoint\\\",\\r\\n                                  \\\"Other\\\"\\r\\n                              );\\r\\nlet appData = data\\r\\n    | summarize \\r\\n        TotalCount = count(), \\r\\n        ExchangeCount = countif(Workload == \\\"Exchange\\\"), \\r\\n        TeamsCount = countif(Workload == \\\"Teams\\\"), \\r\\n        SharePointCount = countif(Workload == \\\"SharePoint\\\"), \\r\\n        OtherCount = countif(Workload == \\\"Other\\\") \\r\\n        by UserId, UserPrincipalName\\r\\n    | where UserId != ''\\r\\n    | join kind=inner (\\r\\n        data\\r\\n        | make-series Trend = count() default = 0 on TimeGenerated in range(ago(15m), now(), 1m) by UserId, UserPrincipalName\\r\\n        | project-away TimeGenerated\\r\\n        )\\r\\n        on UserId\\r\\n    | order by TotalCount desc, UserId asc\\r\\n    | project\\r\\n        UserPrincipalName,\\r\\n        UserId,\\r\\n        TotalCount,\\r\\n        ExchangeCount,\\r\\n        TeamsCount,\\r\\n        SharePointCount,\\r\\n        OtherCount,\\r\\n        Trend\\r\\n    | serialize Id = row_number();\\r\\ndata\\r\\n| summarize \\r\\n    TotalCount = count(), \\r\\n    ExchangeCount = countif(Workload == \\\"Exchange\\\"), \\r\\n    TeamsCount = countif(Workload == \\\"Teams\\\"), \\r\\n    SharePointCount = countif(Workload == \\\"SharePoint\\\"), \\r\\n    OtherCount = countif(Workload == \\\"Other\\\") \\r\\n    by UserId, UserPrincipalName, SourceIp = tostring(SourceIp)\\r\\n| join kind=inner (\\r\\n    data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range(ago(15m), now(), 1m) by UserId, SourceIp\\r\\n    | project-away TimeGenerated\\r\\n    )\\r\\n    on UserId, SourceIp\\r\\n| order by TotalCount desc, UserId asc\\r\\n| project\\r\\n    UserId,\\r\\n    UserPrincipalName,\\r\\n    SourceIp,\\r\\n    TotalCount,\\r\\n    ExchangeCount,\\r\\n    TeamsCount,\\r\\n    SharePointCount,\\r\\n    OtherCount,\\r\\n    Trend\\r\\n| serialize Id = row_number(1000000)\\r\\n| join kind=inner (appData) on UserId\\r\\n| project\\r\\n    Id,\\r\\n    Name = SourceIp,\\r\\n    Type = 'Client IP',\\r\\n    ['Events Count'] = TotalCount,\\r\\n    Trend,\\r\\n    ['Exchange Events'] = ExchangeCount,\\r\\n    ['Teams Events'] = TeamsCount,\\r\\n    ['SharePoint Events'] = SharePointCount,\\r\\n    ['Other Count'] = OtherCount,\\r\\n    ParentId = Id1\\r\\n| union (\\r\\n    appData \\r\\n    | project\\r\\n        Id,\\r\\n        Name = UserPrincipalName,\\r\\n        Type = 'Operating System',\\r\\n        ['Events Count'] = TotalCount,\\r\\n        Trend,\\r\\n        ['Exchange Events'] = ExchangeCount,\\r\\n        ['Teams Events'] = TeamsCount,\\r\\n        ['SharePoint Events'] = SharePointCount,\\r\\n        ['Other Count'] = OtherCount,\\r\\n        ParentId = -1\\r\\n    )\\r\\n| order by ['Events Count'] desc, Name asc\\r\\n\",\"size\":2,\"title\":\"Activity Log\",\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5},{\"columnMatch\":\"Type\",\"formatter\":5},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"Other Count\",\"formatter\":5},{\"columnMatch\":\"ParentId\",\"formatter\":5},{\"columnMatch\":\"Operation Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"Exchange Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\"}},{\"columnMatch\":\"Teams Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"purple\"}},{\"columnMatch\":\"SharePoint Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"turquoise\"}},{\"columnMatch\":\"Details\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"GenericDetails\",\"linkIsContextBlade\":true}}],\"rowLimit\":1000,\"filter\":true,\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Name\"}}},\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"query - 6\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<br />\\r\\nðŸ’¡ _Click on a segment of the pie chart to explore more details_\"},\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId, UserPrincipalName \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| extend \\r\\n    OS = coalesce(DeviceOperatingSystem, \\\"Unknown OS\\\"),\\r\\n    OSVersion = coalesce(tostring(DeviceOperatingSystemVersion), \\\"Unknown Version\\\")\\r\\n| summarize DeviceCount = count() by OS, OSVersion\\r\\n| order by DeviceCount desc\\r\\n\",\"size\":3,\"title\":\"Devices Accessing M365\",\"timeContextFromParameter\":\"TimeRange\",\"exportParameterName\":\"Parampie\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId, UserPrincipalName \\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where UserId in ({Users}) or '*' in ({Users})\\r\\n| extend \\r\\n    [\\\"Operating System\\\"] = coalesce(DeviceOperatingSystem, \\\"Unknown OS\\\"),\\r\\n    [\\\"OS Version\\\"] = coalesce(tostring(DeviceOperatingSystemVersion), \\\"Unknown Version\\\"),\\r\\n    [\\\"Device ID\\\"] = coalesce(tostring(DeviceId), \\\"Unknown DeviceId\\\")\\r\\n| where [\\\"Operating System\\\"] == dynamic({Parampie}).label\\r\\n| summarize [\\\"Transaction Count\\\"] = count() by [\\\"Operating System\\\"], [\\\"OS Version\\\"], [\\\"Device ID\\\"]\\r\\n| order by [\\\"Transaction Count\\\"] desc\\r\\n\",\"size\":2,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"]},\"customWidth\":\"50\",\"conditionalVisibilities\":[{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},{\"parameterName\":\"Parampie\",\"comparison\":\"isNotEqualTo\"}],\"name\":\"query - 1\"}]},\"name\":\"group - 19\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let BusinessHoursStart = 8; // 8 AM\\r\\nlet BusinessHoursEnd = 18; // 6 PM\\r\\n\\r\\nNetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId, UserPrincipalName\\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where UserId in ({Users}) or '*' in ({Users})\\r\\n| extend HourOfDay = hourofday(TimeGenerated)\\r\\n| where HourOfDay < BusinessHoursStart or HourOfDay > BusinessHoursEnd\\r\\n| summarize [\\\"Off-Hour Activities\\\"] = count() by [\\\"User Principal Name\\\"] = UserPrincipalName, [\\\"User ID\\\"] = UserId, [\\\"Date\\\"] = bin(TimeGenerated, 1d), [\\\"Operation\\\"]\\r\\n| project  [\\\"Off-Hour Activities\\\"], [\\\"User Principal Name\\\"], [\\\"User ID\\\"], [\\\"Date\\\"]\\r\\n| order by [\\\"Off-Hour Activities\\\"] desc\\r\\n\",\"size\":0,\"title\":\"Activity Outside Standard Working Hours (8:00 - 18:00)\",\"timeContextFromParameter\":\"TimeRange\",\"exportedParameters\":[{\"fieldName\":\"Date\",\"parameterName\":\"Date\",\"parameterType\":1},{\"fieldName\":\"User ID\",\"parameterName\":\"UserId\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Date\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"query - 14\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\r\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId, UserPrincipalName\\r\\n| join kind=inner (\\r\\n    OfficeActivity \\r\\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\r\\n    | where UniqueTokenId != \\\"\\\")\\r\\non UniqueTokenId\\r\\n| where UserId in ({Users}) or '*' in ({Users})\\r\\n| where UserId == '{UserId}'\\r\\n| where TimeGenerated >= datetime('{Date}')\\r\\n| project [\\\"Time Generated\\\"] = TimeGenerated, [\\\"User\\\"] = UserPrincipalName, [\\\"Source IP\\\"] = SourceIp, [\\\"Device Operating System\\\"] = DeviceOperatingSystem, [\\\"Device Operating System Version\\\"] = DeviceOperatingSystemVersion, [\\\"Device Id\\\"] = DeviceId,[\\\"Workload\\\"] = OfficeWorkload, [\\\"Unique Token Id\\\"] = UniqueTokenId, [\\\"Initiating Process Name\\\"] = InitiatingProcessName, [\\\"Agent Version\\\"] = AgentVersion, [\\\"Record Type\\\"] = RecordType, Operation, [\\\"Item Type\\\"] = ItemType, [\\\"Site URL\\\"] = Site_Url, [\\\"Source File Name\\\"] = SourceFileName_\",\"size\":0,\"title\":\"Activity Outside Standard Working Hours Drill Down\",\"timeContextFromParameter\":\"TimeRange\",\"exportedParameters\":[{\"fieldName\":\"Date\",\"parameterName\":\"Date\",\"parameterType\":1},{\"fieldName\":\"User\",\"parameterName\":\"UserId\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Time Generated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}},{\"columnMatch\":\"Date\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimeNoMsPattern\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"query - 15\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic | where TrafficType == 'microsoft365' | where UniqueTokenId != \\\"\\\"\\n| project UniqueTokenId, SourceIp, DeviceId, DeviceOperatingSystem, DeviceOperatingSystemVersion, InitiatingProcessName, AgentVersion, UserId \\n| join kind=inner (\\n    OfficeActivity \\n    | extend UniqueTokenId = tostring(AppAccessContext.UniqueTokenId)\\n    | where UniqueTokenId != \\\"\\\")\\non UniqueTokenId\\n| summarize Count = count() by bin(TimeGenerated, 1h)\\n| order by TimeGenerated asc\\n\",\"size\":0,\"title\":\"Microsoft 365 Transactions\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"unstackedbar\"},\"conditionalVisibility\":{\"parameterName\":\"selTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"query - 2\"}],\"fallbackResourceIds\":[\"Global Secure Access\"],\"fromTemplateId\":\"GSA Enriched Microsoft 365 logs\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=GSAM365EnrichedEvents; logoFileName=gsa.svg; description=This Workbook provides a detailed view of Microsoft 365 log data, enriched with contextual information to enhance visibility into user activities and potential security threats.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.1; title=Enriched Microsoft 365 logs Workbook; templateRelativePath=GSAM365EnrichedEvents.json; provider=Microsoft}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Global Secure Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "GSASentinelSupport@microsoft.com",
                  "link": "https://learn.microsoft.com/en-us/entra/global-secure-access/overview-what-is-global-secure-access"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "AzureActiveDirectory",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "GSANetworkTraffic Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId2')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "This workbook provides an overview of all traffic logs within your network, offering insights into data transfer, anomalies, and potential threats."
              },
              "properties": {
                "displayName": "[parameters('workbook2-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Network Traffic Insights Workbook (Preview)\\n---\\nInformation in the dashboard is based on log data\\n\\n\\n\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"value::all\"],\"parameters\":[{\"id\":\"ff8b2a55-1849-4848-acf8-eab5452e9f10\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"LogAnalyticWorkspace\",\"label\":\"Log Analytic Workspace\",\"type\":5,\"description\":\"The Log Analytic Workspace In Which To Execute The Queries\",\"isRequired\":true,\"query\":\"resources\\r\\n| where type == \\\"microsoft.operationalinsights/workspaces\\\"\\r\\n| project id\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.operationalinsights/workspaces\":true},\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"f15f34d8-8e2d-4c39-8dee-be2f979c86a8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":604800000}},{\"id\":\"8bab511b-53b3-4220-9d1c-372345b06728\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Users\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"NetworkAccessTraffic\\r\\n| summarize Count = count() by UserPrincipalName\\r\\n| order by Count desc, UserPrincipalName asc\\r\\n| project Value = UserPrincipalName, Label = strcat(UserPrincipalName, ' - ', Count, ' Logs'), Selected = false\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"typeSettings\":{\"limitSelectTo\":20,\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"value::all\"]},{\"id\":\"527af4d2-3089-4aa4-9fbb-48ec697db20d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"WebCategories\",\"label\":\"Web Categories\",\"type\":2,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"NetworkAccessTraffic\\r\\n| extend firstCategory = tostring(split(DestinationWebCategories, ',')[0]) // Split and get the first category\\r\\n| summarize Count = count() by firstCategory\\r\\n| order by Count desc, firstCategory asc\\r\\n| project Value = firstCategory, Label = strcat(firstCategory, ' - ', Count, ' Logs')\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"value::all\"]}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 15\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"2b2cd1be-9d25-412c-8444-f005c4789b55\",\"cellValue\":\"tabSel\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"cc3e67f2-f20f-4430-8dee-d0773b90d9ce\",\"cellValue\":\"tabSel\",\"linkTarget\":\"parameter\",\"linkLabel\":\"All Traffic\",\"subTarget\":\"AllTraffic\",\"style\":\"link\"},{\"id\":\"5ae54b5a-ac7b-4b7a-a1e1-1e574625caa3\",\"cellValue\":\"tabSel\",\"linkTarget\":\"parameter\",\"linkLabel\":\"URL Lookup\",\"subTarget\":\"URLLookup\",\"style\":\"link\"},{\"id\":\"68c566f8-957e-4a3f-8b66-730fc24135fb\",\"cellValue\":\"tabSel\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Security Insights\",\"subTarget\":\"Security\",\"style\":\"link\"}]},\"name\":\"links - 7\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let NetworkAccessTrafficData = NetworkAccessTraffic\\r\\n| where SourceIp != \\\"\\\" and isnotempty(SourceIp)\\r\\n| summarize arg_max(TimeGenerated, *) by SourceIp, TenantId;\\r\\n\\r\\nlet SigninLogsData = SigninLogs\\r\\n| where IPAddress != \\\"\\\" and isnotempty(IPAddress)\\r\\n| summarize arg_max(TimeGenerated, *) by IPAddress, TenantId, UserId, CorrelationId;\\r\\n\\r\\nSigninLogsData\\r\\n| join kind=leftanti (\\r\\n    NetworkAccessTrafficData\\r\\n    | where SourceIp != \\\"\\\" and isnotempty(SourceIp)\\r\\n) on $left.IPAddress == $right.SourceIp and $left.TenantId == $right.TenantId\\r\\n| project TimeGenerated, IPAddress, UserId, UserPrincipalName, AppDisplayName, DeviceDetail.deviceId\\r\\n\",\"size\":0,\"title\":\"Sign-ins Outside Global Secure Access\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"rowLimit\":1000,\"filter\":true}},\"name\":\"query - 0\"}]},\"conditionalVisibility\":{\"parameterName\":\"tabSel\",\"comparison\":\"isEqualTo\",\"value\":\"Security\"},\"name\":\"group - 10\"},{\"type\":1,\"content\":{\"json\":\"ðŸ’¡ Type the URL for detailed analysis\"},\"conditionalVisibility\":{\"parameterName\":\"tabSel\",\"comparison\":\"isEqualTo\",\"value\":\"URLLookup\"},\"name\":\"text - 10\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"ec8c38c8-3064-4921-8dcd-a69d3895599b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"URL\",\"type\":1,\"typeSettings\":{\"isSearchBox\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"tabSel\",\"comparison\":\"isEqualTo\",\"value\":\"URLLookup\"},\"name\":\"parameters - 9\"},{\"type\":1,\"content\":{\"json\":\"# Web Categories\"},\"name\":\"text - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let CategoryData = NetworkAccessTraffic \\r\\n| where DestinationFqdn contains \\\"{URL}\\\"  // Filters logs based on the provided URL parameter\\r\\n| extend CategoriesList = split(DestinationWebCategories, \\\",\\\")  // Split categories into a list\\r\\n| mv-expand Category = CategoriesList  // Expand the list into individual rows\\r\\n| extend Category = trim_start(\\\" \\\", trim_end(\\\" \\\", tostring(Category)))  // Trim leading and trailing spaces\\r\\n| extend Category = iff(TrafficType == \\\"microsoft365\\\", \\\"Microsoft M365\\\", Category)  // Set category to \\\"Microsoft M365\\\" if TrafficType is \\\"microsoft365\\\"\\r\\n| summarize UniqueCategories = make_set(Category);  // Create a set of unique categories\\r\\n\\r\\nCategoryData\\r\\n| extend \\r\\n    PrimaryCategory = iff(array_length(UniqueCategories) > 0, tostring(UniqueCategories[0]), \\\"None\\\")\\r\\n| project \\r\\n    col1 = PrimaryCategory,\\r\\n    snapshot = \\\"Primary Category\\\"\\r\\n\\r\\n| union (\\r\\n    CategoryData\\r\\n    | extend \\r\\n        SecondaryCategory = iff(array_length(UniqueCategories) > 1, tostring(UniqueCategories[1]), \\\"None\\\")\\r\\n    | project \\r\\n        col1 = SecondaryCategory,\\r\\n        snapshot = \\\"Secondary Category\\\"\\r\\n)\\r\\n\\r\\n| order by snapshot asc\\r\\n\",\"size\":4,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"snapshot\"},\"leftContent\":{\"columnMatch\":\"col1\",\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}}},\"showBorder\":true,\"size\":\"auto\"}},\"name\":\"query - 17\"},{\"type\":1,\"content\":{\"json\":\"# Traffic Access Details\"},\"name\":\"text - 15\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let NetworkData = NetworkAccessTraffic\\r\\n| where DestinationFqdn contains \\\"{URL}\\\";  // Filters logs based on the provided URL parameter\\r\\n\\r\\nNetworkData\\r\\n| summarize \\r\\n    UniqueUsers = dcount(UserPrincipalName),\\r\\n    UniqueDevices = dcount(DeviceId),    \\r\\n    TotalAllow = countif(Action == \\\"Allow\\\"),\\r\\n    TotalBlock = countif(Action == \\\"Block\\\")\\r\\n| project \\r\\n    col1 = UniqueUsers, \\r\\n    snapshot = \\\"Unique Users\\\"\\r\\n| union (NetworkData\\r\\n    | summarize UniqueDevices = dcount(DeviceId)\\r\\n    | project col1 = UniqueDevices, snapshot = \\\"Unique Devices\\\")\\r\\n| union (NetworkData\\r\\n    | summarize TotalAllow = countif(Action == \\\"Allow\\\")\\r\\n    | project col1 = TotalAllow, snapshot = \\\"Total Allow\\\")\\r\\n| union (NetworkData\\r\\n    | summarize TotalBlock = countif(Action == \\\"Block\\\")\\r\\n    | project col1 = TotalBlock, snapshot = \\\"Total Block\\\")\\r\\n| order by snapshot asc\",\"size\":4,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"snapshot\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"col1\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":true}},\"name\":\"query - 14\"},{\"type\":1,\"content\":{\"json\":\"# Bandwidth Usage\"},\"name\":\"text - 16\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let NetworkData = NetworkAccessTraffic\\r\\n| where DestinationFqdn contains \\\"{URL}\\\";  // Filters logs based on the provided URL parameter\\r\\n\\r\\nNetworkData\\r\\n| summarize \\r\\n    TotalSent = sum(SentBytes),\\r\\n    TotalReceived = sum(ReceivedBytes),\\r\\n    TotalBandwidth = sum(SentBytes + ReceivedBytes)\\r\\n| extend \\r\\n    TotalSentMB = round(TotalSent / 1024.0 / 1024.0, 2),\\r\\n    TotalReceivedMB = round(TotalReceived / 1024.0 / 1024.0, 2),\\r\\n    TotalBandwidthMB = round(TotalBandwidth / 1024.0 / 1024.0, 2)\\r\\n| project \\r\\n    TotalSentMB,\\r\\n    TotalReceivedMB,\\r\\n    TotalBandwidthMB\\r\\n| extend dummy = 1\\r\\n| project-away dummy\\r\\n| mv-expand \\r\\n    Column = pack_array(\\\"TotalSentMB\\\", \\\"TotalReceivedMB\\\", \\\"TotalBandwidthMB\\\"),\\r\\n    Value = pack_array(TotalSentMB, TotalReceivedMB, TotalBandwidthMB)\\r\\n| extend \\r\\n    snapshot = case(\\r\\n        Column == \\\"TotalSentMB\\\", \\\"Total Sent (MB)\\\",\\r\\n        Column == \\\"TotalReceivedMB\\\", \\\"Total Received (MB)\\\",\\r\\n        Column == \\\"TotalBandwidthMB\\\", \\\"Total Bandwidth (MB)\\\",\\r\\n        \\\"Unknown\\\"\\r\\n    ),\\r\\n    col1 = iff(Value < 0.01, 0.00, Value)\\r\\n| project-away Column, Value\\r\\n| order by snapshot asc\",\"size\":4,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"snapshot\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"col1\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":true}},\"name\":\"query - 17\"},{\"type\":1,\"content\":{\"json\":\"# Traffic Logs (filtered)\"},\"name\":\"text - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic\\r\\n| where UserPrincipalName in ({Users}) or '*' in ({Users})\\r\\n| where DestinationWebCategories in ({WebCategories}) or '*' in ({WebCategories})\\r\\n| where DestinationFqdn contains \\\"{URL}\\\"\\r\\n| project \\r\\n    Timestamp = TimeGenerated,\\r\\n    User = UserPrincipalName,\\r\\n    [\\\"Source IP\\\"] = SourceIp,\\r\\n    [\\\"Destination IP\\\"] = DestinationIp,\\r\\n    [\\\"Destination Port\\\"] = DestinationPort,\\r\\n    [\\\"Destination FQDN\\\"] = DestinationFqdn,\\r\\n    Action = case(\\r\\n        tolower(Action) == \\\"allow\\\", \\\"ðŸŸ¢ Allow\\\", \\r\\n        tolower(Action) == \\\"block\\\", \\\"ðŸ”´ Block\\\", \\r\\n        tolower(Action) // This returns the action in lowercase if it doesn't match \\\"allow\\\" or \\\"block\\\"\\r\\n    ),\\r\\n    [\\\"Policy Name\\\"] = PolicyName,\\r\\n    [\\\"Policy Rule ID\\\"] = PolicyRuleId,\\r\\n    [\\\"Received Bytes\\\"] = ReceivedBytes,\\r\\n    [\\\"Sent Bytes\\\"] = SentBytes,\\r\\n    [\\\"Device OS\\\"] = DeviceOperatingSystem    \\r\\n| order by Timestamp desc\\r\\n\",\"size\":0,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"]},\"name\":\"query - 13\"}]},\"conditionalVisibility\":{\"parameterName\":\"tabSel\",\"comparison\":\"isEqualTo\",\"value\":\"URLLookup\"},\"name\":\"group - URL Lookup\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic\\r\\n| where UserPrincipalName in ({Users}) or '*' in ({Users})\\r\\n| where DestinationWebCategories in ({WebCategories}) or '*' in ({WebCategories})\\r\\n| project \\r\\n    Timestamp = TimeGenerated,\\r\\n    User = UserPrincipalName,\\r\\n    [\\\"Source IP\\\"] = SourceIp,\\r\\n    [\\\"Destination IP\\\"] = DestinationIp,\\r\\n    [\\\"Destination Port\\\"] = DestinationPort,\\r\\n    [\\\"Destination FQDN\\\"] = DestinationFqdn,\\r\\n    Action = case(\\r\\n        tolower(Action) == \\\"allow\\\", \\\"ðŸŸ¢ Allow\\\", \\r\\n        tolower(Action) == \\\"block\\\", \\\"ðŸ”´ Block\\\", \\r\\n        tolower(Action) // This returns the action in lowercase if it doesn't match \\\"allow\\\" or \\\"block\\\"\\r\\n    ),\\r\\n    [\\\"Policy Name\\\"] = PolicyName,\\r\\n    [\\\"Web Category\\\"] = DestinationWebCategories,\\r\\n    [\\\"Transport Protocol\\\"] = TransportProtocol,\\r\\n    [\\\"Traffic Type\\\"] = TrafficType,\\r\\n    [\\\"Received Bytes\\\"] = ReceivedBytes,\\r\\n    [\\\"Sent Bytes\\\"] = SentBytes,\\r\\n    [\\\"Device OS\\\"] = DeviceOperatingSystem,\\r\\n    [\\\"Policy Rule ID\\\"] = PolicyRuleId\\r\\n| order by Timestamp desc\\r\\n\",\"size\":3,\"title\":\"Traffic Logs\",\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"rowLimit\":1000,\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"tabSel\",\"comparison\":\"isEqualTo\",\"value\":\"AllTraffic\"},\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Unique Users\\nNetworkAccessTraffic\\n| where UserPrincipalName in ({Users}) or '*' in ({Users})\\n| where DestinationWebCategories in ({WebCategories}) or '*' in ({WebCategories})\\n| extend GeoInfo = geo_info_from_ip_address(SourceIp) // Extend each row with geolocation info\\n| project SourceIp, Country = tostring(GeoInfo.country), State = tostring(GeoInfo.state), City = tostring(GeoInfo.city), Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\\n| summarize UniqueUsers=dcount(Country)\\n| extend snapshot = \\\"Total Locations\\\"\\n| project col1 = UniqueUsers, snapshot\\n\\n// Union with Unique Devices\\n| union (\\n    NetworkAccessTraffic\\n    | where UserPrincipalName in ({Users}) or '*' in ({Users})\\n    | extend BytesInGB = todouble(SentBytes + ReceivedBytes) / (1024 * 1024 * 1024)  // Convert bytes to gigabytes\\n    | summarize TotalBytesGB = sum(BytesInGB)\\n    | extend snapshot = \\\"Total Bytes (GB)\\\"\\n    | project col1 =   tolong(TotalBytesGB), snapshot\\n)\\n\\n// Union with Total Internet Access\\n| union (\\n    NetworkAccessTraffic\\n    | where UserPrincipalName in ({Users}) or '*' in ({Users})\\n    | summarize TotalTransactions = count()\\n    | extend snapshot = \\\"Total Transactions\\\"\\n    | project col1 = TotalTransactions, snapshot\\n)\\n\\n// Union with Total Private Access\\n// Order by Snapshot for consistent tile ordering on dashboard\\n| order by snapshot\",\"size\":4,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"snapshot\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"col1\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":true,\"size\":\"auto\"},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"ExistingClients\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"ExistingClients\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"ExistingClients\",\"heatmapPalette\":\"greenRed\"}},\"textSettings\":{\"style\":\"bignumber\"}},\"conditionalVisibility\":{\"parameterName\":\"tabSel\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"query - 2\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic\\r\\n| where UserPrincipalName in ({Users}) or '*' in ({Users})\\r\\n| where DestinationWebCategories in ({WebCategories}) or '*' in ({WebCategories})\\r\\n| extend BytesIn = todouble(SentBytes + ReceivedBytes) / (1024 * 1024)  // Convert bytes to Mbytes\\r\\n| summarize TotalBytesMB = sum(BytesIn) by bin(TimeGenerated, 1h), TrafficType\\r\\n| order by bin(TimeGenerated, 1h) asc, TrafficType asc\\r\\n| project TimeGenerated, TrafficType, TotalBytesMB\\r\\n\",\"size\":2,\"title\":\"Usage Over Time (MB)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"barchart\"},\"conditionalVisibility\":{\"parameterName\":\"tabSel\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"query - 0\"}]},\"name\":\"group - 5\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic\\r\\n| where UserPrincipalName in ({Users}) or '*' in ({Users})\\r\\n| where DestinationWebCategories in ({WebCategories}) or '*' in ({WebCategories})\\r\\n| extend GeoInfo = geo_info_from_ip_address(SourceIp) // Extend each row with geolocation info\\r\\n| project  TimeGenerated, SourceIp, Country = tostring(GeoInfo.country), State = tostring(GeoInfo.state), City = tostring(GeoInfo.city), Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\\r\\n| where Country != \\\"\\\"\\r\\n| summarize Count = count() by City, State, Country\\r\\n\\r\\n\",\"size\":3,\"title\":\"Locations\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"CountryRegion\",\"locInfoColumn\":\"Country\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"Count\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"Country\",\"legendMetric\":\"Country\",\"legendAggregation\":\"Count\",\"itemColorSettings\":{\"nodeColorField\":\"Count\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"turquoise\"}}},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic\\r\\n| where UserPrincipalName in ({Users}) or '*' in ({Users})\\r\\n| where DestinationWebCategories in ({WebCategories}) or '*' in ({WebCategories})\\r\\n| where tolower(Action) == \\\"allow\\\" and DestinationWebCategories != '' // Filter for allowed traffic\\r\\n| where DestinationWebCategories in ({WebCategories}) or '*' in ({WebCategories})\\r\\n| extend firstCategory = tostring(split(DestinationWebCategories, ',')[0]) // Split and get the first category\\r\\n| summarize Count = count() by firstCategory\\r\\n\",\"size\":2,\"title\":\"Allowed Web Categories Distribution \",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic\\r\\n| where UserPrincipalName in ({Users}) or '*' in ({Users})\\r\\n| where DestinationWebCategories in ({WebCategories}) or '*' in ({WebCategories})\\r\\n| where tolower(Action) == \\\"block\\\" and DestinationWebCategories != '' // Filter for blocked traffic\\r\\n| extend firstCategory = tostring(split(DestinationWebCategories, ',')[0]) // Split and get the first category\\r\\n| summarize Count = count() by firstCategory\\r\\n\",\"size\":3,\"title\":\"Blocked Web Categories Distribution\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic  \\r\\n| where UserPrincipalName in ({Users}) or '*' in ({Users})\\r\\n| where DestinationWebCategories in ({WebCategories}) or '*' in ({WebCategories})\\r\\n| where tolower(Action) == \\\"block\\\" and DestinationFqdn != ''  // Filter for blocked traffic with non-empty Destination FQDN\\r\\n| summarize Count = count() by [\\\"Destination FQDN\\\"] = DestinationFqdn, [\\\"Destination Web Categories\\\"] = DestinationWebCategories, [\\\"Policy Name\\\"] = PolicyName\\r\\n| order by Count\\r\\n\",\"size\":0,\"title\":\"Blocked Destinations\",\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"}}],\"rowLimit\":1000,\"filter\":true,\"sortBy\":[{\"itemKey\":\"$gen_bar_Count_3\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"$gen_bar_Count_3\",\"sortOrder\":2}]},\"customWidth\":\"50\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic\\r\\n| where UserPrincipalName in ({Users}) or '*' in ({Users})\\r\\n| where DestinationWebCategories in ({WebCategories}) or '*' in ({WebCategories})\\r\\n| where SentBytes > 0\\r\\n| where tolower(Action) != \\\"block\\\"\\r\\n| summarize \\r\\n    Count = count(), \\r\\n    [\\\"Sent Bytes\\\"] = sum(SentBytes), \\r\\n    [\\\"Received Bytes\\\"] = sum(ReceivedBytes), \\r\\n    [\\\"Total Bytes\\\"] = sum(ReceivedBytes + SentBytes) \\r\\n    by [\\\"Destination FQDN\\\"] = DestinationFqdn\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"title\":\"Allowed Destinations\",\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"palette\":\"magenta\"}},{\"columnMatch\":\"Recived\",\"formatter\":4,\"formatOptions\":{\"palette\":\"turquoise\"}},{\"columnMatch\":\"Total\",\"formatter\":4,\"formatOptions\":{\"palette\":\"pink\"}},{\"columnMatch\":\"Sent\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"}}],\"rowLimit\":1000,\"filter\":true,\"sortBy\":[{\"itemKey\":\"$gen_bar_Count_1\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"$gen_bar_Count_1\",\"sortOrder\":2}]},\"customWidth\":\"50\",\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"NetworkAccessTraffic\\r\\n| where UserPrincipalName in ({Users}) or '*' in ({Users})\\r\\n| where TransportProtocol != ''\\r\\n| summarize Count = count() by toupper(TransportProtocol)\\r\\n| top 10 by Count\\r\\n\",\"size\":2,\"title\":\"Protocol Distribution\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogAnalyticWorkspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 3\"}]},\"conditionalVisibility\":{\"parameterName\":\"tabSel\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"group - 4\"}],\"fallbackResourceIds\":[\"Global Secure Access\"],\"fromTemplateId\":\"GSA Network Traffic Insights\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId2'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=GSANetworkTraffic; logoFileName=gsa.svg; description=This workbook provides an overview of all traffic logs within your network, offering insights into data transfer, anomalies, and potential threats.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.1; title=Network Traffic Insights; templateRelativePath=GSANetworkTraffic.json; subtitle=; provider=Microsoft}.description",
                "parentId": "[variables('workbookId2')]",
                "contentId": "[variables('_workbookContentId2')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Global Secure Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "GSASentinelSupport@microsoft.com",
                  "link": "https://learn.microsoft.com/en-us/entra/global-secure-access/overview-what-is-global-secure-access"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "AzureActiveDirectory",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId2')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook2-name')]",
        "contentProductId": "[variables('_workbookcontentProductId2')]",
        "id": "[variables('_workbookcontentProductId2')]",
        "version": "[variables('workbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Identity - AfterHoursActivity_AnalyticalRules Analytics Rule with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query identifies connections that occur outside of the defined operational hours. It helps in monitoring and flagging any unusual activity that may occur during non-business hours, indicating potential security concerns or policy violations.",
                "displayName": "GSA - Detect Connections Outside Operational Hours",
                "enabled": false,
                "query": "let starttime = todatetime('{{StartTimeISO}}');\nlet endtime = todatetime('{{EndTimeISO}}');\nlet operational_start_hour = 8; // Start of operational hours (8 AM)\nlet operational_end_hour = 18; // End of operational hours (6 PM)\nNetworkAccessTraffic\n| where TimeGenerated between (starttime .. endtime)\n| extend HourOfDay = datetime_part('hour', TimeGenerated)\n| where HourOfDay < operational_start_hour or HourOfDay >= operational_end_hour\n| project TimeGenerated, UserPrincipalName, SourceIp, DestinationIp, DestinationPort, Action, DeviceId, DeviceOperatingSystem, ConnectionId\n| extend IPCustomEntity = SourceIp, AccountCustomEntity = UserPrincipalName\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT24H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "AzureActiveDirectory",
                    "dataTypes": [
                      "NetworkAccessTrafficLogs"
                    ]
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1078",
                  "T1133"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "Name"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
              "properties": {
                "description": "Global Secure Access Analytics Rule 1",
                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "Global Secure Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "GSASentinelSupport@microsoft.com",
                  "link": "https://learn.microsoft.com/en-us/entra/global-secure-access/overview-what-is-global-secure-access"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
        "contentKind": "AnalyticsRule",
        "displayName": "GSA - Detect Connections Outside Operational Hours",
        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SWG - Abnormal Deny Rate_AnalyticalRules Analytics Rule with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies abnormal deny rate for specific source IP to destination IP based on the normal average and standard deviation learned during a configured period. This can indicate potential exfiltration, initial access, or C2, where an attacker tries to exploit the same vulnerability on machines in the organization but is being blocked by firewall rules.\n\nConfigurable Parameters:\n    - minimumOfStdsThreshold: The number of stds to use in the threshold calculation. Default is set to 3.\n    - learningPeriodTime: Learning period for threshold calculation in days. Default is set to 5.\n    - binTime: Learning buckets time in hours. Default is set to 1 hour.\n    - minimumThreshold: Minimum threshold for alert. Default is set to 5.\n    - minimumBucketThreshold: Minimum learning buckets threshold for alert. Default is set to 5.",
                "displayName": "GSA - Detect Abnormal Deny Rate for Source to Destination IP",
                "enabled": false,
                "query": "let NumOfStdsThreshold = 3;\nlet LearningPeriod = 5d;\nlet BinTime = 1h;\nlet MinThreshold = 5.0;\nlet MinLearningBuckets = 5;\nlet TrafficLogs = NetworkAccessTraffic\n  | where Action == \"Denied\"\n  | where isnotempty(DestinationIp) and isnotempty(SourceIp);\nlet LearningSrcIpDenyRate = TrafficLogs\n  | where TimeGenerated between (ago(LearningPeriod + 1d) .. ago(1d))\n  | summarize count_ = count() by SourceIp, bin(TimeGenerated, BinTime), DestinationIp\n  | summarize LearningTimeSrcIpDenyRateAvg = avg(count_), LearningTimeSrcIpDenyRateStd = stdev(count_), LearningTimeBuckets = count() by SourceIp, DestinationIp\n  | where LearningTimeBuckets > MinLearningBuckets;\nlet AlertTimeSrcIpDenyRate = TrafficLogs\n  | where TimeGenerated between (ago(1h) .. now())\n  | summarize AlertTimeSrcIpDenyRateCount = count() by SourceIp, DestinationIp;\nAlertTimeSrcIpDenyRate\n  | join kind=leftouter (LearningSrcIpDenyRate) on SourceIp, DestinationIp\n  | extend LearningThreshold = max_of(LearningTimeSrcIpDenyRateAvg + NumOfStdsThreshold * LearningTimeSrcIpDenyRateStd, MinThreshold)\n  | where AlertTimeSrcIpDenyRateCount > LearningThreshold\n  | project SourceIp, DestinationIp, AlertTimeSrcIpDenyRateCount, LearningThreshold\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT25H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 1,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "AzureActiveDirectory",
                    "dataTypes": [
                      "NetworkAccessTrafficLogs"
                    ]
                  }
                ],
                "tactics": [
                  "InitialAccess",
                  "Exfiltration",
                  "CommandAndControl"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SourceIp",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "DestinationIp",
                        "identifier": "Url"
                      }
                    ],
                    "entityType": "URL"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
              "properties": {
                "description": "Global Secure Access Analytics Rule 2",
                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "Global Secure Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "GSASentinelSupport@microsoft.com",
                  "link": "https://learn.microsoft.com/en-us/entra/global-secure-access/overview-what-is-global-secure-access"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
        "contentKind": "AnalyticsRule",
        "displayName": "GSA - Detect Abnormal Deny Rate for Source to Destination IP",
        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject3').analyticRuleTemplateSpecName3]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SWG - Abnormal Port to Protocol_AnalyticalRules Analytics Rule with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject3').analyticRuleVersion3]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies changes in the protocol used for specific destination ports, comparing the current runtime with a learned baseline.\nThis can indicate potential protocol misuse or configuration changes.\nConfigurable Parameters:\n- Learning period: The time range to establish the baseline. Default is set to 7 days.\n- Run time: The time range for current analysis. Default is set to 1 day.",
                "displayName": "GSA - Detect Protocol Changes for Destination Ports",
                "enabled": false,
                "query": "let LearningPeriod = 7d;\nlet RunTime = 1d;\nlet StartLearningPeriod = ago(LearningPeriod + RunTime);\nlet EndRunTime = ago(RunTime);\nlet LearningPortToProtocol = \n  NetworkAccessTraffic\n  | where TimeGenerated between (StartLearningPeriod .. EndRunTime)\n  | where isnotempty(DestinationPort)\n  | summarize LearningTimeCount = count() by LearningTimeDstPort = DestinationPort, LearningTimeProtocol = TransportProtocol, SourceIp, DestinationFqdn;\nlet AlertTimePortToProtocol = \n  NetworkAccessTraffic\n  | where TimeGenerated between (EndRunTime .. now())\n  | where isnotempty(DestinationPort)\n  | summarize AlertTimeCount = count() by AlertTimeDstPort = DestinationPort, AlertTimeProtocol = TransportProtocol, SourceIp, DestinationFqdn;\nAlertTimePortToProtocol\n  | join kind=leftouter (LearningPortToProtocol) on $left.AlertTimeDstPort == $right.LearningTimeDstPort and $left.SourceIp == $right.SourceIp and $left.DestinationFqdn == $right.DestinationFqdn\n  | where isnull(LearningTimeProtocol) or LearningTimeProtocol != AlertTimeProtocol\n  | project AlertTimeDstPort, AlertTimeProtocol, LearningTimeProtocol, SourceIp, DestinationFqdn\n  | extend IPCustomEntity = SourceIp, FqdnCustomEntity = DestinationFqdn\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "P8D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 1,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "AzureActiveDirectory",
                    "dataTypes": [
                      "NetworkAccessTrafficLogs"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion",
                  "Exfiltration",
                  "CommandAndControl"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "FqdnCustomEntity",
                        "identifier": "Url"
                      }
                    ],
                    "entityType": "URL"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject3').analyticRuleId3,'/'))))]",
              "properties": {
                "description": "Global Secure Access Analytics Rule 3",
                "parentId": "[variables('analyticRuleObject3').analyticRuleId3]",
                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                "source": {
                  "kind": "Solution",
                  "name": "Global Secure Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "GSASentinelSupport@microsoft.com",
                  "link": "https://learn.microsoft.com/en-us/entra/global-secure-access/overview-what-is-global-secure-access"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
        "contentKind": "AnalyticsRule",
        "displayName": "GSA - Detect Protocol Changes for Destination Ports",
        "contentProductId": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "id": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject4').analyticRuleTemplateSpecName4]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SWG - Source IP Port Scan_AnalyticalRules Analytics Rule with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject4').analyticRuleVersion4]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies a source IP scanning multiple open ports on Global Secure Access Firewall. This can indicate malicious scanning of ports by an attacker, trying to reveal open ports in the organization that can be compromised for initial access.\n  Configurable Parameters:\n  - Port scan time - the time range to look for multiple ports scanned. Default is set to 30 seconds.\n  - Minimum different ports threshold - alert only if more than this number of ports scanned. Default is set to 100.",
                "displayName": "GSA - Detect Source IP Scanning Multiple Open Ports",
                "enabled": false,
                "query": "let port_scan_time = 30s;\nlet min_ports_threshold = 100;\nNetworkAccessTraffic\n| where TimeGenerated > ago(1d)\n| where Action == 'Allowed'\n| summarize PortsScanned = dcount(DestinationPort) by SourceIp, DestinationFqdn, bin(TimeGenerated, port_scan_time)\n| where PortsScanned > min_ports_threshold\n| project SourceIp, PortsScanned, TimeGenerated,DestinationFqdn\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 1,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "AzureActiveDirectory",
                    "dataTypes": [
                      "NetworkAccessTrafficLogs"
                    ]
                  }
                ],
                "tactics": [
                  "Discovery"
                ],
                "techniques": [
                  "T1046"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SourceIp",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "DestinationFqdn",
                        "identifier": "Url"
                      }
                    ],
                    "entityType": "URL"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject4').analyticRuleId4,'/'))))]",
              "properties": {
                "description": "Global Secure Access Analytics Rule 4",
                "parentId": "[variables('analyticRuleObject4').analyticRuleId4]",
                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                "source": {
                  "kind": "Solution",
                  "name": "Global Secure Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "GSASentinelSupport@microsoft.com",
                  "link": "https://learn.microsoft.com/en-us/entra/global-secure-access/overview-what-is-global-secure-access"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
        "contentKind": "AnalyticsRule",
        "displayName": "GSA - Detect Source IP Scanning Multiple Open Ports",
        "contentProductId": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "id": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Global Secure Access",
        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>â€¢ Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Global%20Secure%20Access/ReleaseNotes.md\">Release Notes</a></p>\n<p>â€¢ There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p><a href=\"https://aka.ms/GlobalSecureAccess\">Global Secure Access</a> is a <a href=\"https://learn.microsoft.com/en-us/azure/sentinel/sentinel-solutions-catalog#domain-solutions\">domain solution</a> and does not include any data connectors. The content in this solution requires one of the product solutions below.</p>\n<p><strong>Prerequisite:</strong></p>\n<p>Install one or more of the listed solutions to unlock the value provided by this solution.</p>\n<ol>\n<li>Microsoft Entra ID</li>\n</ol>\n<p><strong>Underlying Microsoft Technologies used:</strong></p>\n<p>This solution depends on the following technologies, and some of these dependencies may either be in Preview state or might result in additional ingestion or operational costs:</p>\n<ol>\n<li>Product solutions as described above</li>\n</ol>\n<p><strong>Workbooks:</strong> 2, <strong>Analytic Rules:</strong> 4</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/gsa.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Global Secure Access",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "GSASentinelSupport@microsoft.com",
          "tier": "Microsoft",
          "link": "https://learn.microsoft.com/en-us/entra/global-secure-access/overview-what-is-global-secure-access"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId2')]",
              "version": "[variables('workbookVersion2')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
            }
          ]
        },
        "firstPublishDate": "2024-04-08",
        "providers": [
          "Microsoft"
        ],
        "categories": {
          "domains": [
            "Identity"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
