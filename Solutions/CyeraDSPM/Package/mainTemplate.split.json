{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "author": "Cyera DSPM OCTO Team - support@cyera.io",
        "comments": "Solution template for CyeraDSPM (split with nested triggers)"
    },
    "parameters": {
        "location": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
            }
        },
        "workspace-location": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
            }
        },
        "workspace": {
            "defaultValue": "",
            "type": "string",
            "metadata": {
                "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
            }
        }
    },
    "variables": {
        "email": "support@cyera.io",
        "_email": "[variables('email')]",
        "_solutionName": "Cyera",
        "_solutionVersion": "3.0.0",
        "solutionId": "cyeradspm.azure-sentinel-solution-cyeradspm",
        "_solutionId": "[variables('solutionId')]",
        "solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]",
        "_solutioncontentProductId": "[variables('solutioncontentProductId')]",
        "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
        "dataConnectorCCPVersion": "1.0.0",
        "dataConnectorContentIdConnectorDefinition1": "CyeraDSPMCCF",
        "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
        "_dataConnectorContentIdConnectorDefinition1": "[variables('dataConnectorContentIdConnectorDefinition1')]",
        "_dataConnectorContentIdConnections1": "CyeraCCFConnector",
        "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
        "dataConnectorFunctionsVersion": "1.0.0",
        "dataConnectorContentIdConnectorDefinition2": "CyeraFunctionsConnector",
        "dataConnectorTemplateNameConnectorDefinition2": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition2')))]",
        "_dataConnectorContentIdConnectorDefinition2": "[variables('dataConnectorContentIdConnectorDefinition2')]",
        "armTemplateBasetUrl": "https://raw.githubusercontent.com/joshua-acklin-cyera/Azure-Sentinel/refs/heads/cyera-dspm/",
        "_armTemplateAzureFunctionsUri": "[uriComponent(uri(variables('armTemplateBasetUrl'), 'Solutions/CyeraDSPM/Data%20Connectors/CyeraDSPM_Functions/CyeraFunctionDeployment.json'))]",
        "_cyeraLogoUrl": "[uri(variables('armTemplateBasetUrl'), 'Logos/cyera_logo.svg')]",
        "_cyeraLogoIcon": "[uri(variables('armTemplateBasetUrl'), 'Logos/cyera_icon.svg')]",
        "_armTemplateAzureFunctionsInstallGuide": "[uri(variables('armTemplateBasetUrl'), 'Solutions/CyeraDSPM/Data%20Connectors/CyeraDSPM_Functions/INSTALL.md')]",
        "_armTemplateAzureFunctionsScripts": "[uri(variables('armTemplateBasetUrl'), 'Solutions/CyeraDSPM/Data%20Connectors/CyeraDSPM_Functions/install-pack-v0_7_0.zip')]",
        "_cyeraRelaeseNotesUrl": "[uri(variables('armTemplateBasetUrl'), 'Solutions/CyeraDSPM/ReleaseNotes.md')]",
        "dce-name": "[concat('cyera-dce-',variables('_dataConnectorContentIdConnections1'))]",
        "dcr-name": "[concat('cyera-dcr-',variables('_dataConnectorContentIdConnections1'))]",
        "blanks": "[replace('b', 'b', '')]"
    },
    "resources": [
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "displayName": "Cyera DSPM CCF Connector",
                "contentKind": "DataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('dataConnectorCCPVersion')]",
                    "parameters": {
                        "data-collections-endpoint-name-ccf": {
                            "type": "string",
                            "defaultValue": "CyeraDSPMDataCollectionEndpoint",
                            "metadata": { "description": "Name of the Data Collection Endpoint - CCF" }
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Resources/deployments",
                            "apiVersion": "2021-04-01",
                            "name": "Deploy-Cyera-CCF-ConnectorDefinition",
                            "properties": {
                                "mode": "Incremental",
                                "templateLink": {
                                    "uri": "[uri(variables('armTemplateBasetUrl'), 'Solutions/CyeraDSPM/Data%20Connectors/CyeraDSPM_CCF/CyeraDSPM_ConnectorDefinition.json')]"
                                },
                                "parameters": {
                                    "workspace": { "value": "[parameters('workspace')]" },
                                    "workspace-location": { "value": "[parameters('workspace-location')]" },
                                    "dataConnectorCCPVersion": { "value": "[variables('dataConnectorCCPVersion')]" },
                                    "solutionId": { "value": "[variables('_solutionId')]" },
                                    "solutionName": { "value": "[variables('_solutionName')]" },
                                    "email": { "value": "[variables('_email')]" },
                                    "dataConnectorContentIdConnectorDefinition1": { "value": "[variables('_dataConnectorContentIdConnectorDefinition1')]" },
                                    "dataConnectorContentIdConnections1": { "value": "[variables('_dataConnectorContentIdConnections1')]" },
                                    "cyeraLogoIcon": { "value": "[variables('_cyeraLogoIcon')]" }
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Resources/deployments",
                            "apiVersion": "2021-04-01",
                            "name": "Deploy-Cyera-CCF-DCR",
                            "properties": {
                                "mode": "Incremental",
                                "templateLink": {
                                    "uri": "[uri(variables('armTemplateBasetUrl'), 'Solutions/CyeraDSPM/Data%20Connectors/CyeraDSPM_CCF/CyeraDSPM_DCR.json')]"
                                },
                                "parameters": {
                                    "workspace": { "value": "[parameters('workspace')]" },
                                    "workspace-location": { "value": "[parameters('workspace-location')]" },
                                    "dataConnectorContentIdConnections1": { "value": "[variables('_dataConnectorContentIdConnections1')]" }
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Resources/deployments",
                            "apiVersion": "2021-04-01",
                            "name": "Deploy-Cyera-CCF-Tables",
                            "properties": {
                                "mode": "Incremental",
                                "templateLink": {
                                    "uri": "[uri(variables('armTemplateBasetUrl'), 'Solutions/CyeraDSPM/Data%20Connectors/CyeraDSPM_CCF/CyeraDSPM_Table.json')]"
                                },
                                "parameters": {
                                    "workspace-location": { "value": "[parameters('workspace-location')]" }
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('dataConnectorCCPVersion')]"
            }
        },
        {
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
            "apiVersion": "2022-09-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
            "location": "[parameters('workspace-location')]",
            "kind": "Customizable",
            "properties": {
                "connectorUiConfig": {
                    "id": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                    "title": "Cyera DSPM Azure Sentinel Data Connector",
                    "publisher": "Cyera Inc",
                    "logo": "[variables('_cyeraLogoIcon')]",
                    "descriptionMarkdown": "The [Cyera DSPM](https://api.cyera.io/) data connector allows you to connect to your Cyera's DSPM tenant and ingesting Classifications, Assets, Issues, and Identity Resources/Definitions into Microsoft Sentinel. The data connector is built on Microsoft Sentinel's Codeless Connector Framework and uses the Cyera's API to fetch Cyera's [DSPM Telemetry](https://www.cyera.com/) once recieced can be correlated with security events creating custom columns so that queries don't need to parse it again, thus resulting in better performance.",
                    "graphQueries": [
                        { "metricName": "cyera_functions_classifications", "legend": "Total Cyera Classification Records", "baseQuery": "CyeraClassifications_CL" },
                        { "metricName": "cyera_functions_assets", "legend": "Total Cyera Assets Records", "baseQuery": "CyeraAssets_CL" },
                        { "metricName": "cyera_functions_assets_ms", "legend": "Total Cyera Asset MS Records", "baseQuery": "CyeraAssets_MS_CL" },
                        { "metricName": "cyera_functions_issues", "legend": "Total Cyera Issue Records", "baseQuery": "CyeraIssues_CL" },
                        { "metricName": "cyera_functions_identities", "legend": "Total Cyera Identities Records", "baseQuery": "CyeraIdentities_CL" }
                    ],
                    "sampleQueries": [
                        { "description": "Get Sample of Cyera DSPM Classification Definitions", "query": "CyeraClassifications_CL | take 10" },
                        { "description": "Get Sample of Cyera DSPM Datastore Assets", "query": "CyeraAssets_CL | take 10" },
                        { "description": "Get Sample of Cyera DSPM Table Assets", "query": "CyeraAssets_MS_CL | take 10" },
                        { "description": "Get Sample of Cyera DSPM Issues Identified", "query": "CyeraIssues_CL | take 10" },
                        { "description": "Get Sample of Cyera DSPM Identities", "query": "CyeraIdentities_CL | take 10" }
                    ],
                    "dataTypes": [
                        { "name": "CyeraClassifications_CL", "lastDataReceivedQuery": "CyeraClassifications_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" },
                        { "name": "CyeraAssets_CL", "lastDataReceivedQuery": "CyeraAssets_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" },
                        { "name": "CyeraAssets_MS_CL", "lastDataReceivedQuery": "CyeraAssets_MS_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" },
                        { "name": "CyeraIssues_CL", "lastDataReceivedQuery": "CyeraIssues_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" },
                        { "name": "CyeraIdentities_CL", "lastDataReceivedQuery": "CyeraIdentities_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" }
                    ],
                    "connectivityCriteria": [ { "type": "HasDataConnectors", "value": null } ],
                    "availability": { "status": 1, "isPreview": false },
                    "permissions": {
                        "resourceProvider": [ {
                            "provider": "Microsoft.OperationalInsights/workspaces",
                            "permissionsDisplayText": "Read and Write permissions are required.",
                            "providerDisplayName": "Workspace",
                            "scope": "Workspace",
                            "requiredPermissions": { "read": true, "write": true, "delete": true, "action": false }
                        } ]
                    },
                    "instructionSteps": [
                        {
                            "title": "Cyera DSPM Authentication",
                            "description": "Connect to your Cyera DSPM tenenant via Personal Access Tokens",
                            "instructions": [
                                { "type": "Textbox", "parameters": { "label": "Cyera Personal Access Token Client ID", "placeholder": "client_id", "type": "text", "name": "username" } },
                                { "type": "Textbox", "parameters": { "label": "Cyera Personal Access Token Secret Key", "placeholder": "secret_key", "type": "password", "name": "password" } },
                                { "type": "ConnectionToggleButton", "parameters": { "connectLabel": "Connect", "name": "toggle" } }
                            ]
                        }
                    ],
                    "isConnectivityCriteriasMatchSome": false
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "displayName": "CyeraDSPM",
                "contentKind": "ResourcesDataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('dataConnectorCCPVersion')]",
                    "parameters": {
                        "connectorDefinitionName": { "defaultValue": "CyeraDSPMCCF", "type": "string", "minLength": 1 },
                        "workspace": { "defaultValue": "[parameters('workspace')]", "type": "string" },
                        "dcrConfig": { "defaultValue": { "dataCollectionEndpoint": "data collection Endpoint", "dataCollectionRuleImmutableId": "data collection rule immutableId" }, "type": "object" },
                        "username": { "defaultValue": "", "type": "string", "minLength": 1 },
                        "password": { "defaultValue": "", "type": "securestring", "minLength": 1 }
                    },
                    "variables": {
                        "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Resources/deployments",
                            "apiVersion": "2021-04-01",
                            "name": "Deploy-Cyera-CCF-PollingConfig",
                            "properties": {
                                "mode": "Incremental",
                                "templateLink": {
                                    "uri": "[uri(variables('armTemplateBasetUrl'), 'Solutions/CyeraDSPM/Data%20Connectors/CyeraDSPM_CCF/CyeraDSPM_PollingConfig.json')]"
                                },
                                "parameters": {
                                    "workspace": { "value": "[parameters('workspace')]" },
                                    "workspace-location": { "value": "[parameters('workspace-location')]" },
                                    "dcrConfig": { "value": "[parameters('dcrConfig')]" },
                                    "username": { "value": "[parameters('username')]" },
                                    "password": { "value": "[parameters('password')]" },
                                    "connectorDefinitionName": { "value": "[parameters('connectorDefinitionName')]" },
                                    "solutionId": { "value": "[variables('_solutionId')]" },
                                    "solutionName": { "value": "[variables('_solutionName')]" },
                                    "email": { "value": "[variables('_email')]" },
                                    "dataConnectorCCPVersion": { "value": "[variables('dataConnectorCCPVersion')]" },
                                    "dataConnectorContentIdConnections1": { "value": "[variables('_dataConnectorContentIdConnections1')]" }
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('dataConnectorCCPVersion')]"
            }
        },
        {
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
            "apiVersion": "2022-01-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": { "sourceId": "[variables('_solutionId')]", "name": "[variables('_solutionName')]", "kind": "Solution" },
                "author": { "name": "Microsoft", "email": "[variables('_email')]" },
                "support": { "name": "Microsoft Corporation", "email": "support@microsoft.com", "tier": "Microsoft", "link": "https://support.microsoft.com" },
                "dependencies": { "criteria": [ { "version": "[variables('dataConnectorCCPVersion')]", "contentId": "[variables('_dataConnectorContentIdConnections1')]", "kind": "ResourcesDataConnector" } ] }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition2'), variables('dataConnectorFunctionsVersion'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition2')]",
                "displayName": "Cyera DSPM Functions App",
                "contentKind": "DataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('dataConnectorFunctionsVersion')]",
                    "parameters": {
                        "data-collections-endpoint-name-function": {
                            "type": "string",
                            "defaultValue": "[last(split(subscription().id, '/'))]",
                            "metadata": { "description": "Name of the Data Collection Endpoint - Azure Functions" }
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Resources/deployments",
                            "apiVersion": "2021-04-01",
                            "name": "Deploy-Cyera-Functions-Solution",
                            "properties": {
                                "mode": "Incremental",
                                "templateLink": {
                                    "uri": "[uri(variables('armTemplateBasetUrl'), 'Solutions/CyeraDSPM/Data%20Connectors/CyeraDSPM_Functions/Solution_CyeraDSPM.json')]"
                                },
                                "parameters": {
                                    "workspace": { "value": "[parameters('workspace')]" },
                                    "workspace-location": { "value": "[parameters('workspace-location')]" },
                                    "dataConnectorFunctionsVersion": { "value": "[variables('dataConnectorFunctionsVersion')]" },
                                    "solutionId": { "value": "[variables('_solutionId')]" },
                                    "solutionName": { "value": "[variables('_solutionName')]" },
                                    "email": { "value": "[variables('_email')]" },
                                    "cyeraLogoIcon": { "value": "[variables('_cyeraLogoIcon')]" },
                                    "dataConnectorContentIdConnectorDefinition2": { "value": "[variables('_dataConnectorContentIdConnectorDefinition2')]" },
                                    "armTemplateAzureFunctionsUri": { "value": "[variables('_armTemplateAzureFunctionsUri')]" },
                                    "armTemplateAzureFunctionsInstallGuide": { "value": "[variables('_armTemplateAzureFunctionsInstallGuide')]" },
                                    "armTemplateAzureFunctionsScripts": { "value": "[variables('_armTemplateAzureFunctionsScripts')]" }
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition2'),'-', variables('dataConnectorFunctionsVersion'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('dataConnectorFunctionsVersion')]"
            }
        },
        {
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition2'))]",
            "apiVersion": "2022-09-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
            "location": "[parameters('workspace-location')]",
            "kind": "GenericUI",
            "properties": {
                "connectorUiConfig": {
                    "id": "[variables('_dataConnectorContentIdConnectorDefinition2')]",
                    "title": "Cyera DSPM Sentinel Data Connector - Azure Functions ",
                    "publisher": "Cyera Inc",
                    "logo": "[variables('_cyeraLogoIcon')]",
                    "descriptionMarkdown": "The **Cyera DSPM Azure Function Connector** enables seamless ingestion of Cyera’s **Data Security Posture Management (DSPM)** telemetry — *Assets*, *Identities*, *Issues*, and *Classifications* — into **Microsoft Sentinel**.\\n\\nThis connector uses an **Azure Function App** to call Cyera’s REST API on a schedule, fetch the latest DSPM telemetry, and send it to Sentinel through the **Azure Monitor Logs Ingestion API** via a **Data Collection Endpoint (DCE)** and **Data Collection Rule (DCR, kind: Direct)** — no agents required.\\n\\n**Tables created/used**\\n\\n| Entity | Table | Purpose |\\n|---|---|---|\\n| Assets | `CyeraAssets_CL` | Raw asset metadata and data-store context |\\n| Identities | `CyeraIdentities_CL` | Identity definitions and sensitivity context |\\n| Issues | `CyeraIssues_CL` | Findings and remediation details |\\n| Classifications | `CyeraClassifications_CL` | Data class & sensitivity definitions |\\n| MS View | `CyeraAssets_MS_CL` | Normalized asset view for dashboards |\\n\\n> **Note:** This connector should only be used if directed by your Cyera CSE and otherwise use CCF based connector **Cyera DSPM Azure Sentinel Data Connector** which aligns with Microsoft’s recommended Direct ingestion path for Sentinel.",
                    "additionalRequirementBanner": "This connector deploys KQL transforms in the DCR. No parser function is required.",
                    "graphQueries": [
                        { "metricName": "cyera_functions_classifications", "legend": "Total Cyera Classification Records", "baseQuery": "CyeraClassifications_CL" },
                        { "metricName": "cyera_functions_assets", "legend": "Total Cyera Assets Records", "baseQuery": "CyeraAssets_CL" },
                        { "metricName": "cyera_functions_assets_ms", "legend": "Total Cyera Asset MS Records", "baseQuery": "CyeraAssets_MS_CL" },
                        { "metricName": "cyera_functions_issues", "legend": "Total Cyera Issue Records", "baseQuery": "CyeraIssues_CL" },
                        { "metricName": "cyera_functions_identities", "legend": "Total Cyera Identities Records", "baseQuery": "CyeraIdentities_CL" }
                    ],
                    "sampleQueries": [
                        { "description": "Get Sample of Cyera DSPM Classification Definitions", "query": "CyeraClassifications_CL | take 10" },
                        { "description": "Get Sample of Cyera DSPM Datastore Assets", "query": "CyeraAssets_CL | take 10" },
                        { "description": "Get Sample of Cyera DSPM Table Assets", "query": "CyeraAssets_MS_CL | take 10" },
                        { "description": "Get Sample of Cyera DSPM Issues Identified", "query": "CyeraIssues_CL | take 10" },
                        { "description": "Get Sample of Cyera DSPM Identities", "query": "CyeraIdentities_CL | take 10" }
                    ],
                    "dataTypes": [
                        { "name": "CyeraClassifications_CL", "lastDataReceivedQuery": "CyeraClassifications_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" },
                        { "name": "CyeraAssets_CL", "lastDataReceivedQuery": "CyeraAssets_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" },
                        { "name": "CyeraAssets_MS_CL", "lastDataReceivedQuery": "CyeraAssets_MS_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" },
                        { "name": "CyeraIssues_CL", "lastDataReceivedQuery": "CyeraIssues_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" },
                        { "name": "CyeraIdentities_CL", "lastDataReceivedQuery": "CyeraIdentities_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" }
                    ],
                    "ConnectivityCriteria": [
                        { "type": "IsConnectedQuery", "value": [ "CyeraClassifications_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)" ] },
                        { "type": "IsConnectedQuery", "value": [ "CyeraAssets_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)" ] },
                        { "type": "IsConnectedQuery", "value": [ "CyeraAssets_MS_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)" ] },
                        { "type": "IsConnectedQuery", "value": [ "CyeraIssues_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)" ] },
                        { "type": "IsConnectedQuery", "value": [ "CyeraIdentities_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)" ] }
                    ],
                    "availability": { "status": 1, "isPreview": false },
                    "permissions": {
                        "resourceProvider": [ {
                            "provider": "Microsoft.OperationalInsights/workspaces",
                            "permissionsDisplayText": "Read and Write permissions are required.",
                            "providerDisplayName": "Workspace",
                            "scope": "Workspace",
                            "requiredPermissions": { "read": true, "write": true, "delete": true, "action": false }
                        } ]
                    },
                    "instructionSteps": [
                        { "title": "Note", "description": ">**NOTE:** This connector uses an **Azure Function App** and the **Azure Monitor Logs Ingestion API** (DCE + DCR, kind: Direct). Function runtime and data egress may incur charges. See [Azure Functions pricing](https://azure.microsoft.com/pricing/details/functions/)." },
                        { "title": "Optional Step", "description": ">**(Optional)** Store Cyera API credentials in **Azure Key Vault** and reference them from the Function App. See [Key Vault references](https://learn.microsoft.com/azure/app-service/app-service-key-vault-references)." },
                        { "title": "STEP 1 — Prepare Cyera API Access", "description": "1) Generate a **Personal Access Token** [Generating Personal Access Token](https://support.cyera.io/hc/en-us/articles/19446274608919-Personal-and-API-Tokens) in your Cyera tenant.\\n2) Note **API Base URL**, **Client ID**, and **Client Secret**." },
                        {
                            "title": "STEP 2 — Choose ONE deployment option",
                            "description": "> Before deploying, have these values handy:",
                            "instructions": [
                                { "parameters": { "fillWith": [ "CyeraDSPMConnector" ], "label": "[variables('dataConnectorContentIdConnectorDefinition2')]" }, "type": "CopyableLabel" },
                                { "parameters": { "fillWith": [ "[parameters('workspace')]" ], "label": "Workspace Name" }, "type": "CopyableLabel" },
                                { "parameters": { "fillWith": [ "[parameters('workspace-location')]" ], "label": "Workspace Location" }, "type": "CopyableLabel" },
                                { "parameters": { "fillWith": [ "https://api.cyera.io" ], "label": "Cyera Base URL" }, "type": "CopyableLabel" },
                                { "parameters": { "fillWith": [ "CyeraClientID" ], "label": "Cyera Personal Access Token Client ID" }, "type": "CopyableLabel" },
                                { "parameters": { "fillWith": [ "CyeraSecret" ], "label": "Cyera Personal Access Token Secret" }, "type": "CopyableLabel" }
                            ]
                        },
                        { "title": "Option 1", "description": "[concat('**Option 1 - Azure Resource Manager (ARM) Template**\\n\\nUse this method for automated deployment of the Cyera DSPM Functions and all required resources to support the connector.\\n\\n1. Click the **Deploy to Azure** button below. \\n+\\n\t[![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/', variables('_armTemplateAzureFunctionsUri'), '?FunctionName=testtesttest)\\n2. Select the preferred **FunctionName** and **Workspace Name**. \\n+3. Enter the **Workspace Location**, **Cyera API Base Url**, **Personal Access Token Client ID**, and **Personal Access Token Secret**. \\n+>Note: If using Azure Key Vault secrets for any of the values above, use the`@Microsoft.KeyVault(SecretUri={Security Identifier})`schema in place of the string values. Refer to [Key Vault references documentation](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) for further details. \\n+4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \\n+5. Click **Purchase** to deploy.')]" },
                        { "title": "Option 2 — Manual Deployment", "description": "[concat('Follow the [install pack’s step-by-step guide](', variables('_armTemplateAzureFunctionsInstallGuide'), ').\\n\\n1) Create/update the 5 custom tables, data collection rule with format `sentinel-dce-<functuion_name>`, and data collection endpoint with format `sentinel-dcr-<functuion_name>` using the scripts in [install-pack-v0_7_0/scripts](', variables('_armTemplateAzureFunctionsScripts'), ').\\n2) Deploy the Azure Function from the repo`s Function folder (Timer-trigger; schedule typically 5–15 minutes).\\n3) Configure Function App settings:\\n   - `CyeraBaseUrl` — Cyera API Base URL\\n   - `CyeraClientId` — Client ID (PAT)\\n   - `CyeraSecret` — Client Secret (PAT)\\n   - `DCR_IMMUTABLE_ID` — DCR immutable ID\\n   - `DCE_ENDPOINT` — Logs ingestion endpoint URL\\n   - `STREAM_ASSETS`=`Custom-CyeraAssets`, `STREAM_IDENTITIES`=`Custom-CyeraIdentities`, `STREAM_ISSUES`=`Custom-CyeraIssues`, `STREAM_CLASSIFICATIONS`=`Custom-CyeraClassifications`\\n4) Save and Start the Function App.')]" }
                    ]
                }
            }
        },
        {
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition2')))]",
            "apiVersion": "2022-01-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition2'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition2')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorFunctionsVersion')]",
                "source": { "sourceId": "[variables('_solutionId')]", "name": "[variables('_solutionName')]", "kind": "Solution" },
                "author": { "name": "Microsoft", "email": "[variables('_email')]" },
                "support": { "name": "Microsoft Corporation", "email": "support@microsoft.com", "tier": "Microsoft", "link": "https://support.microsoft.com" }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
            "apiVersion": "2023-04-01-preview",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "version": "3.0.0",
                "kind": "Solution",
                "contentSchemaVersion": "3.0.0",
                "displayName": "CyeraDSPM",
                "publisherDisplayName": "Cyera Inc",
                "descriptionHtml": "[concat('<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>• Review the solution <a href="', variables('_cyeraRelaeseNotesUrl') ,'">Release Notes</a></p>\n<p>• There may be <a href="https://aka.ms/sentinelsolutionsknownissues">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href="https://api.cyera.io/">Cyera DSPM</a> data connector allows you to connect to your Cyera`s DSPM instance and ingesting Classifications, Assets, Issues, and Identity Definitions into Microsoft Sentinel. The data connector is built on Microsoft Sentinel`s Codeless Connector Platform and uses the Cyera`s API to fetch Cyera`s <a href="https://www.cyera.com/">DSPM Telemetry</a> once recieced can be correlated with security events creating custom columns so that queries don`t need to parse it again, thus resulting in better performance.</p>\n<p><a href="https://aka.ms/azuresentinel">Learn more about Microsoft Sentinel</a> | <a href="https://aka.ms/azuresentinelsolutionsdoc">Learn more about Solutions</a></p>\n')]",
                "contentKind": "Solution",
                "contentProductId": "[variables('_solutioncontentProductId')]",
                "id": "[variables('_solutioncontentProductId')]",
                "icon": "[concat('<img src="', variables('_cyeraLogoUrl'))]",
                "contentId": "[variables('_solutionId')]",
                "parentId": "[variables('_solutionId')]",
                "source": { "kind": "Solution", "name": "CyeraDSPM", "sourceId": "[variables('_solutionId')]" },
                "author": { "name": "Cyera DSPM OCTO Team", "email": "[variables('_email')]" },
                "support": { "name": "Cyera Inc", "email": "support@cyera.io", "tier": "Partner", "link": "https://support.cyera.io" },
                "firstPublishDate": "2025-10-15",
                "lastPublishDate": "2025-10-15",
                "providers": [ "Cyera" ],
                "categories": { "domains": [ "Security - Data Security Posture Management" ] }
            },
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
        }
    ],
    "outputs": {}
}


