{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": { "type": "string" },
        "workspace-location": { "type": "string" },
        "dataConnectorCCPVersion": { "type": "string" },
        "solutionId": { "type": "string" },
        "solutionName": { "type": "string" },
        "email": { "type": "string" },
        "dataConnectorContentIdConnectorDefinition1": { "type": "string" },
        "dataConnectorContentIdConnections1": { "type": "string" },
        "cyeraLogoIcon": { "type": "string" }
    },
    "variables": {
        "_dataConnectorContentIdConnectorDefinition1": "[parameters('dataConnectorContentIdConnectorDefinition1')]",
        "_dataConnectorContentIdConnections1": "[parameters('dataConnectorContentIdConnections1')]",
        "_solutionId": "[parameters('solutionId')]",
        "_solutionName": "[parameters('solutionName')]",
        "_email": "[parameters('email')]",
        "_cyeraLogoIcon": "[parameters('cyeraLogoIcon')]",
        "_dataConnectorCCPVersion": "[parameters('dataConnectorCCPVersion')]"
    },
    "resources": [
        {
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
            "apiVersion": "2022-09-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
            "location": "[parameters('workspace-location')]",
            "kind": "Customizable",
            "properties": {
                "connectorUiConfig": {
                    "id": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                    "title": "Cyera DSPM Azure Sentinel Data Connector",
                    "logo": "[variables('_cyeraLogoIcon')]",
                    "publisher": "Cyera Inc",
                    "descriptionMarkdown": "The [Cyera DSPM](https://api.cyera.io/) data connector allows you to connect to your Cyera's DSPM instance and ingesting Classifications, Assets, Issues, and Identity Definitions into Microsoft Sentinel. The data connector is built on Microsoft Sentinel's Codeless Connector Platform and uses the Cyera's API to fetch Cyera's [DSPM Telemetry](https://www.cyera.com/) once recieced can be correlated with security events creating custom columns so that queries don't need to parse it again, thus resulting in better performance.",
                    "graphQueries": [
                        { "metricName": "cyera_functions_classifications", "legend": "Total Cyera Classification Records", "baseQuery": "CyeraClassifications_CL" },
                        { "metricName": "cyera_functions_assets", "legend": "Total Cyera Assets Records", "baseQuery": "CyeraAssets_CL" },
                        { "metricName": "cyera_functions_assets_ms", "legend": "Total Cyera Asset MS Records", "baseQuery": "CyeraAssets_MS_CL" },
                        { "metricName": "cyera_functions_issues", "legend": "Total Cyera Issue Records", "baseQuery": "CyeraIssues_CL" },
                        { "metricName": "cyera_functions_identities", "legend": "Total Cyera Identities Records", "baseQuery": "CyeraIdentities_CL" }
                    ],
                    "sampleQueries": [
                        { "description": "Get Sample of Cyera DSPM Classification Definitions", "query": "CyeraClassifications_CL | take 10" },
                        { "description": "Get Sample of Cyera DSPM Datastore Assets", "query": "CyeraAssets_CL | take 10" },
                        { "description": "Get Sample of Cyera DSPM Table Assets", "query": "CyeraAssets_MS_CL | take 10" },
                        { "description": "Get Sample of Cyera DSPM Issues Identified", "query": "CyeraIssues_CL | take 10" },
                        { "description": "Get Sample of Cyera DSPM Identities", "query": "CyeraIdentities_CL | take 10" }
                    ],
                    "dataTypes": [
                        { "name": "CyeraClassifications_CL", "lastDataReceivedQuery": "CyeraClassifications_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" },
                        { "name": "CyeraAssets_CL", "lastDataReceivedQuery": "CyeraAssets_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" },
                        { "name": "CyeraAssets_MS_CL", "lastDataReceivedQuery": "CyeraAssets_MS_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" },
                        { "name": "CyeraIssues_CL", "lastDataReceivedQuery": "CyeraIssues_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" },
                        { "name": "CyeraIdentities_CL", "lastDataReceivedQuery": "CyeraIdentities_CL\n       | where TimeGenerated > ago(48h)                | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)" }
                    ],
                    "connectivityCriteria": [ { "type": "HasDataConnectors", "value": null } ],
                    "availability": { "status": 1, "isPreview": false },
                    "permissions": {
                        "resourceProvider": [
                            {
                                "provider": "Microsoft.OperationalInsights/workspaces",
                                "permissionsDisplayText": "Read and Write permissions are required.",
                                "providerDisplayName": "Workspace",
                                "scope": "Workspace",
                                "requiredPermissions": { "read": true, "write": true, "delete": true, "action": false }
                            }
                        ]
                    },
                    "instructionSteps": [
                        {
                            "title": "Cyera DSPM Authentication",
                            "description": "Connect to your Cyera DSPM tenenant via Personal Access Tokens",
                            "instructions": [
                                { "type": "Textbox", "parameters": { "label": "Cyera Personal Access Token Client ID", "placeholder": "client_id", "type": "text", "name": "username" } },
                                { "type": "Textbox", "parameters": { "label": "Cyera Personal Access Token Secret Key", "placeholder": "secret_key", "type": "password", "name": "password" } },
                                { "type": "ConnectionToggleButton", "parameters": { "connectLabel": "Connect", "name": "toggle" } }
                            ]
                        }
                    ],
                    "isConnectivityCriteriasMatchSome": false
                }
            }
        },
        {
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
            "apiVersion": "2022-01-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('_dataConnectorCCPVersion')]",
                "source": { "sourceId": "[variables('_solutionId')]", "name": "[variables('_solutionName')]", "kind": "Solution" },
                "author": { "name": "Microsoft", "email": "[variables('_email')]" },
                "support": { "name": "Microsoft Corporation", "email": "support@microsoft.com", "tier": "Microsoft", "link": "https://support.microsoft.com" },
                "dependencies": { "criteria": [ { "version": "[variables('_dataConnectorCCPVersion')]", "contentId": "[variables('_dataConnectorContentIdConnections1')]", "kind": "ResourcesDataConnector" } ] }
            }
        }
    ]
}


