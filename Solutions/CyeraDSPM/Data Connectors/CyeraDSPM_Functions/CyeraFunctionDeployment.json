{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "FunctionName": {
            "defaultValue": "CyeraDSPMConnector",
            "minLength": 1,
            "maxLength": 30,
            "type": "string"
        },
        "workspace": {
            "type": "string",
            "defaultValue": "<workspaceName>"
        },
        "workspace-location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "[concat('Region to deploy solution resources -- separate from location selection',resourceGroup().location)]"
            }
        },
        "CyeraBaseUrl": {
            "type": "string",
            "defaultValue": "https://api.cyera.io"
        },
        "CyeraClientId": {
            "type": "securestring",
            "defaultValue": "<CyeraClientID>"
        },
        "CyeraSecret": {
            "type": "securestring",
            "defaultValue": "<CyeraSecret>"
        }
    },
    "variables": {
        "FunctionName": "[take(concat(toLower(parameters('FunctionName')), uniqueString(resourceGroup().id)), 24)]",
        "StorageSuffix": "[environment().suffixes.storage]",
        "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
        "dce-name": "[concat('sentinel-dce-',variables('FunctionName'))]",
        "dcr-name": "[concat('sentinel-dcr-',variables('FunctionName'))]"
    },
    "resources": [
      {
          "type": "Microsoft.Resources/deployments",
          "apiVersion": "2022-09-01",
          "name": "AuditTablesTemplate",
          "properties": {
              "mode": "Incremental",
              "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {},
                  "variables": {},
                  "resources": [
                      {
                          "name": "[format('{0}/{1}', parameters('workspace'), 'CyeraClassifications_CL')]",
                          "type": "Microsoft.OperationalInsights/workspaces/tables",
                          "apiVersion": "2022-10-01",
                          "tags": {},
                          "properties": {
                              "plan": "Analytics",
                              "schema": {
                                  "name": "CyeraClassifications_CL",
                                  "columns": [
                                      {
                                          "name": "TimeGenerated",
                                          "type": "datetime"
                                      },
                                      {
                                          "name": "ClassificationUid",
                                          "type": "string"
                                      },
                                      {
                                          "name": "Name",
                                          "type": "string"
                                      },
                                      {
                                          "name": "ClassificationGroup",
                                          "type": "string"
                                      },
                                      {
                                          "name": "DataClassName",
                                          "type": "string"
                                      },
                                      {
                                          "name": "BusinessContext",
                                          "type": "dynamic"
                                      },
                                      {
                                          "name": "Frameworks",
                                          "type": "dynamic"
                                      },
                                      {
                                          "name": "Collections",
                                          "type": "dynamic"
                                      },
                                      {
                                          "name": "Residency",
                                          "type": "dynamic"
                                      },
                                      {
                                          "name": "Sensitivity",
                                          "type": "string"
                                      },
                                      {
                                          "name": "SensitivityDisplayName",
                                          "type": "string"
                                      },
                                      {
                                          "name": "Provider",
                                          "type": "string"
                                      }
                                  ]
                              }
                          }
                      },
                      {
                          "name": "[format('{0}/{1}', parameters('workspace'), 'CyeraAssets_MS_CL')]",
                          "type": "Microsoft.OperationalInsights/workspaces/tables",
                          "apiVersion": "2022-10-01",
                          "tags": {},
                          "properties": {
                              "plan": "Analytics",
                                  "schema": {
                                      "name": "CyeraAssets_MS_CL",
                                      "columns": [
                                          {
                                              "name": "AssetID",
                                              "type": "string"
                                          },
                                          {
                                              "name": "AssetName",
                                              "type": "string"
                                          },
                                          {
                                              "name": "Workload",
                                              "type": "string"
                                          },
                                          {
                                              "name": "SubWorkload",
                                              "type": "string"
                                          },
                                          {
                                              "name": "Location",
                                              "type": "string"
                                          },
                                          {
                                              "name": "Risks",
                                              "type": "int"
                                          },
                                          {
                                              "name": "SensitivityLabel",
                                              "type": "string"
                                          },
                                          {
                                              "name": "AssetOwner",
                                              "type": "string"
                                          },
                                          {
                                              "name": "TimeGenerated",
                                              "type": "datetime"
                                          },
                                          {
                                              "name": "Provider",
                                              "type": "string"
                                          },
                                          {
                                              "name": "AdditionalFields",
                                              "type": "dynamic"
                                          }
                                      ]
                                  }
                          }
                      },
                      {
                          "name": "[format('{0}/{1}', parameters('workspace'), 'CyeraIdentities_CL')]",
                          "type": "Microsoft.OperationalInsights/workspaces/tables",
                          "apiVersion": "2022-10-01",
                          "tags": {},
                          "properties": {
                              "plan": "Analytics",
                                  "schema": {
                                      "name": "CyeraIdentities_CL",
                                      "columns": [
                                          {
                                              "name": "TimeGenerated",
                                              "type": "datetime"
                                          },
                                          {
                                              "name": "DisplayId",
                                              "type": "string"
                                          },
                                          {
                                              "name": "DisplayName",
                                              "type": "string"
                                          },
                                          {
                                              "name": "IdentityType",
                                              "type": "string"
                                          },
                                          {
                                              "name": "IdentityProvider",
                                              "type": "string"
                                          },
                                          {
                                              "name": "TrustedLevel",
                                              "type": "string"
                                          },
                                          {
                                              "name": "IsEnabled",
                                              "type": "boolean"
                                          },
                                          {
                                              "name": "MFAStatus",
                                              "type": "string"
                                          },
                                          {
                                              "name": "HasCopilot",
                                              "type": "boolean"
                                          },
                                          {
                                              "name": "CreationTime",
                                              "type": "datetime"
                                          },
                                          {
                                              "name": "LastActiveTime",
                                              "type": "datetime"
                                          },
                                          {
                                              "name": "IssuesTotal",
                                              "type": "long"
                                          },
                                          {
                                              "name": "SensitiveRecords",
                                              "type": "long"
                                          },
                                          {
                                              "name": "RecordsVerySensitive",
                                              "type": "long"
                                          },
                                          {
                                              "name": "RecordsSensitive",
                                              "type": "long"
                                          },
                                          {
                                              "name": "RecordsConfidential",
                                              "type": "long"
                                          },
                                          {
                                              "name": "RecordsInternal",
                                              "type": "long"
                                          },
                                          {
                                              "name": "RecordsNotSensitive",
                                              "type": "long"
                                          },
                                          {
                                              "name": "Uid",
                                              "type": "string"
                                          },
                                          {
                                              "name": "Provider",
                                              "type": "string"
                                          }
                                      ]
                                  }
                          }
                      },
                      {
                          "name": "[format('{0}/{1}', parameters('workspace'), 'CyeraIssues_CL')]",
                          "type": "Microsoft.OperationalInsights/workspaces/tables",
                          "apiVersion": "2022-10-01",
                          "tags": {},
                          "properties": {
                              "plan": "Analytics",
                                  "schema": {
                                      "name": "CyeraIssues_CL",
                                      "columns": [
                                          {
                                              "name": "TimeGenerated",
                                              "type": "datetime"
                                          },
                                          {
                                              "name": "IssueId",
                                              "type": "string"
                                          },
                                          {
                                              "name": "Name",
                                              "type": "string"
                                          },
                                          {
                                              "name": "Description",
                                              "type": "string"
                                          },
                                          {
                                              "name": "Severity",
                                              "type": "string"
                                          },
                                          {
                                              "name": "SeverityRank",
                                              "type": "int"
                                          },
                                          {
                                              "name": "createdDate",
                                              "type": "datetime"
                                          },
                                          {
                                              "name": "updatedDate",
                                              "type": "datetime"
                                          },
                                          {
                                              "name": "DatastoreUid",
                                              "type": "string"
                                          },
                                          {
                                              "name": "assetUid",
                                              "type": "string"
                                          },
                                          {
                                              "name": "AssetOwner",
                                              "type": "string"
                                          },
                                          {
                                              "name": "recordsAtRisk",
                                              "type": "long"
                                          },
                                          {
                                              "name": "classificationGroups",
                                              "type": "dynamic"
                                          },
                                          {
                                              "name": "remediation",
                                              "type": "dynamic"
                                          },
                                          {
                                              "name": "evidence",
                                              "type": "dynamic"
                                          },
                                          {
                                              "name": "Status",
                                              "type": "string"
                                          },
                                          {
                                              "name": "StatusNormalized",
                                              "type": "string"
                                          },
                                          {
                                              "name": "Provider",
                                              "type": "string"
                                          }
                                      ]
                                  }
                          }
                      }
                  ]
              },
              "parameters": {}
          },
          "subscriptionId": "[subscription().subscriptionId]",
          "resourceGroup": "[resourceGroup().name]"
      },
      {
            "type": "Microsoft.Insights/dataCollectionEndpoints",
            "apiVersion": "2022-06-01",
            "name": "[variables('dce-name')]",
            "location": "[parameters('workspace-location')]",
            "properties": {
              "networkAcls": {
                "publicNetworkAccess": "Enabled"
              }
            }
          },
        {
  			     "name": "[variables('dcr-name')]",
            "apiVersion": "2022-06-01",
            "type": "Microsoft.Insights/dataCollectionRules",
            "location": "[parameters('workspace-location')]",
			"dependsOn": [
              "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dce-name'))]",
              "[resourceId('Microsoft.Resources/deployments', 'AuditTablesTemplate')]"
            ],
            "properties": {
                "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dce-name'))]",
                "streamDeclarations": {
                    "Custom-CyeraClassifications_SRC": {
                        "columns": [
                            {
                                "name": "dataClassName",
                                "type": "string"
                            },
                            {
                                "name": "classificationName",
                                "type": "string"
                            },
                            {
                                "name": "classificationGroup",
                                "type": "string"
                            },
                            {
                                "name": "dataCategory",
                                "type": "string"
                            },
                            {
                                "name": "collections",
                                "type": "dynamic"
                            },
                            {
                                "name": "customCollections",
                                "type": "dynamic"
                            },
                            {
                                "name": "uid",
                                "type": "string"
                            },
                            {
                                "name": "name",
                                "type": "string"
                            },
                            {
                                "name": "sensitivity",
                                "type": "string"
                            },
                            {
                                "name": "sensitivityDisplayName",
                                "type": "string"
                            },
                            {
                                "name": "defaultSensitivity",
                                "type": "string"
                            },
                            {
                                "name": "defaultSensitivityDisplayName",
                                "type": "string"
                            },
                            {
                                "name": "context",
                                "type": "dynamic"
                            },
                            {
                                "name": "frameworks",
                                "type": "dynamic"
                            },
                            {
                                "name": "learned",
                                "type": "boolean"
                            },
                            {
                                "name": "classificationLevel",
                                "type": "string"
                            }
                        ]
                    },
                    "Custom-CyeraAssets_SRC": {
                        "columns": [
                            {
                                "name": "uid",
                                "type": "string"
                            },
                            {
                                "name": "name",
                                "type": "string"
                            },
                            {
                                "name": "provider",
                                "type": "string"
                            },
                            {
                                "name": "infrastructure",
                                "type": "string"
                            },
                            {
                                "name": "engine",
                                "type": "string"
                            },
                            {
                                "name": "regions",
                                "type": "dynamic"
                            },
                            {
                                "name": "account",
                                "type": "dynamic"
                            },
                            {
                                "name": "classificationGroups",
                                "type": "dynamic"
                            },
                            {
                                "name": "cloudProviderTags",
                                "type": "dynamic"
                            },
                            {
                                "name": "owner",
                                "type": "string"
                            },
                            {
                                "name": "type",
                                "type": "string"
                            },
                            {
                                "name": "dataType",
                                "type": "string"
                            },
                            {
                                "name": "discoveredDate",
                                "type": "datetime"
                            },
                            {
                                "name": "createdDate",
                                "type": "datetime"
                            },
                            {
                                "name": "cloudProviderUrl",
                                "type": "string"
                            },
                            {
                                "name": "scanningState",
                                "type": "string"
                            },
                            {
                                "name": "ghost",
                                "type": "boolean"
                            },
                            {
                                "name": "vpc",
                                "type": "string"
                            },
                            {
                                "name": "sensitivity",
                                "type": "string"
                            },
                            {
                                "name": "sensitivityDisplayName",
                                "type": "string"
                            },
                            {
                                "name": "recordCountBySensitivity",
                                "type": "dynamic"
                            },
                            {
                                "name": "issues",
                                "type": "dynamic"
                            },
                            {
                                "name": "userTags",
                                "type": "dynamic"
                            },
                            {
                                "name": "collections",
                                "type": "dynamic"
                            },
                            {
                                "name": "customCollections",
                                "type": "dynamic"
                            },
                            {
                                "name": "frameworks",
                                "type": "dynamic"
                            },
                            {
                                "name": "learned",
                                "type": "boolean"
                            },
                            {
                                "name": "classificationLevel",
                                "type": "string"
                            },
                            {
                                "name": "encrypted",
                                "type": "boolean"
                            },
                            {
                                "name": "sslEnforced",
                                "type": "string"
                            },
                            {
                                "name": "logging",
                                "type": "string"
                            },
                            {
                                "name": "publicAccessibilityState",
                                "type": "string"
                            },
                            {
                                "name": "lastDataRefresh",
                                "type": "string"
                            },
                            {
                                "name": "lastModifiedTime",
                                "type": "string"
                            },
                            {
                                "name": "driveId",
                                "type": "string"
                            },
                            {
                                "name": "arn",
                                "type": "string"
                            },
                            {
                                "name": "rdsEndpoint",
                                "type": "string"
                            },
                            {
                                "name": "azureId",
                                "type": "string"
                            },
                            {
                                "name": "datastoreSizeInGiB",
                                "type": "dynamic"
                            },
                            {
                                "name": "projectIds",
                                "type": "dynamic"
                            },
                            {
                                "name": "datastoreOwners",
                                "type": "dynamic"
                            },
                            {
                                "name": "autoScan",
                                "type": "boolean"
                            },
                            {
                                "name": "siteName",
                                "type": "string"
                            },
                            {
                                "name": "userId",
                                "type": "string"
                            },
                            {
                                "name": "siteId",
                                "type": "string"
                            }
                        ]
                    },
                    "Custom-CyeraIssues_SRC": {
                        "columns": [
                            {
                                "name": "provider",
                                "type": "string"
                            },
                            {
                                "name": "infrastructure",
                                "type": "string"
                            },
                            {
                                "name": "engine",
                                "type": "string"
                            },
                            {
                                "name": "regions",
                                "type": "dynamic"
                            },
                            {
                                "name": "account",
                                "type": "dynamic"
                            },
                            {
                                "name": "classificationGroups",
                                "type": "dynamic"
                            },
                            {
                                "name": "cloudProviderTags",
                                "type": "dynamic"
                            },
                            {
                                "name": "owner",
                                "type": "string"
                            },
                            {
                                "name": "uid",
                                "type": "string"
                            },
                            {
                                "name": "name",
                                "type": "string"
                            },
                            {
                                "name": "severity",
                                "type": "string"
                            },
                            {
                                "name": "createdDate",
                                "type": "datetime"
                            },
                            {
                                "name": "updatedDate",
                                "type": "datetime"
                            },
                            {
                                "name": "status",
                                "type": "string"
                            },
                            {
                                "name": "riskStatus",
                                "type": "string"
                            },
                            {
                                "name": "resolution",
                                "type": "string"
                            },
                            {
                                "name": "resolutionNote",
                                "type": "string"
                            },
                            {
                                "name": "datastoreName",
                                "type": "string"
                            },
                            {
                                "name": "datastoreUid",
                                "type": "string"
                            },
                            {
                                "name": "risk",
                                "type": "dynamic"
                            },
                            {
                                "name": "data",
                                "type": "dynamic"
                            },
                            {
                                "name": "datastoreCloudProviderTags",
                                "type": "dynamic"
                            },
                            {
                                "name": "datastoreUserTags",
                                "type": "dynamic"
                            },
                            {
                                "name": "datastoreOwners",
                                "type": "dynamic"
                            },
                            {
                                "name": "remediationAdvice",
                                "type": "string"
                            },
                            {
                                "name": "policyUid",
                                "type": "string"
                            },
                            {
                                "name": "itsmTickets",
                                "type": "dynamic"
                            }
                        ]
                    },
                    "Custom-CyeraIdentities_SRC": {
                        "columns": [
                            {
                                "name": "uid",
                                "type": "string"
                            },
                            {
                                "name": "category",
                                "type": "string"
                            },
                            {
                                "name": "displayName",
                                "type": "string"
                            },
                            {
                                "name": "displayId",
                                "type": "string"
                            },
                            {
                                "name": "scopeNamespace",
                                "type": "string"
                            },
                            {
                                "name": "scopeDisplayName",
                                "type": "string"
                            },
                            {
                                "name": "scopeId",
                                "type": "string"
                            },
                            {
                                "name": "trustLevel",
                                "type": "string"
                            },
                            {
                                "name": "isStale",
                                "type": "boolean"
                            },
                            {
                                "name": "isEnabled",
                                "type": "boolean"
                            },
                            {
                                "name": "multiFactorAuthenticationStatus",
                                "type": "string"
                            },
                            {
                                "name": "membersCount",
                                "type": "dynamic"
                            },
                            {
                                "name": "hasCopilot",
                                "type": "boolean"
                            },
                            {
                                "name": "lastActiveTime",
                                "type": "string"
                            },
                            {
                                "name": "creationTime",
                                "type": "string"
                            },
                            {
                                "name": "description",
                                "type": "string"
                            },
                            {
                                "name": "isAdmin",
                                "type": "boolean"
                            },
                            {
                                "name": "classificationGroupsNames",
                                "type": "dynamic"
                            },
                            {
                                "name": "sensitivity",
                                "type": "string"
                            },
                            {
                                "name": "sensitiveRecords",
                                "type": "dynamic"
                            },
                            {
                                "name": "sensitivityBreakdown",
                                "type": "dynamic"
                            },
                            {
                                "name": "lastPasswordUpdateTime",
                                "type": "string"
                            },
                            {
                                "name": "jobTitle",
                                "type": "string"
                            },
                            {
                                "name": "department",
                                "type": "string"
                            },
                            {
                                "name": "officeLocation",
                                "type": "string"
                            },
                            {
                                "name": "country",
                                "type": "string"
                            },
                            {
                                "name": "hasMultipleParents",
                                "type": "boolean"
                            },
                            {
                                "name": "domain",
                                "type": "string"
                            },
                            {
                                "name": "businessFunction",
                                "type": "string"
                            },
                            {
                                "name": "seniorityLevel",
                                "type": "string"
                            },
                            {
                                "name": "issueCountBySeverity",
                                "type": "dynamic"
                            },
                            {
                                "name": "reportsTo",
                                "type": "string"
                            },
                            {
                                "name": "managerId",
                                "type": "string"
                            }
                        ]
                    }
                },
                "destinations": {
                    "logAnalytics": [
                        {
                            "workspaceResourceId": "[variables('workspaceResourceId')]",
                            "name": "cyeradspm"
                        }
                    ]
                },
                "dataFlows": [
                    {
                        "streams": [
                            "Custom-CyeraClassifications_SRC"
                        ],
                        "destinations": [
                            "cyeradspm"
                        ],
                        "transformKql": "source\n| extend TimeGenerated = now()",
                        "outputStream": "Custom-CyeraClassifications_CL"
                    },
                    {
                        "streams": [
                            "Custom-CyeraAssets_SRC"
                        ],
                        "destinations": [
                            "cyeradspm"
                        ],
                        "transformKql": "source | extend AssetID = case(\n not(isempty(tostring(azureId))), tostring(azureId),\n not(isempty(tostring(arn))), tostring(arn),\n not(isempty(tostring(driveId))), tostring(driveId),\n not(isempty(tostring(siteId))), tostring(siteId),\n not(isempty(tostring(rdsEndpoint))), tostring(rdsEndpoint),\n tostring(uid)\n)\n| extend ownersArr = iif(isnull(datastoreOwners), parse_json('[]'), todynamic(datastoreOwners))\n| extend firstOwner = iif(array_length(ownersArr) > 0, ownersArr[0], parse_json('null'))\n| extend owner_email = tostring(firstOwner.email),\n owner_upn = tostring(firstOwner.userPrincipalName),\n owner_name = tostring(firstOwner.name),\n owner_uid = tostring(firstOwner.datastoreOwnerUid)\n| extend AssetOwner = case(\n isnotempty(owner_email), owner_email,\n isnotempty(owner_upn), owner_upn,\n isnotempty(owner_name), owner_name,\n isnotempty(owner_uid), owner_uid,\n isnotempty(tostring(account.name)), tostring(account.name),\n ''\n)\n| extend\n AssetName = tostring(name),\n Workload = tostring(['type']),\n SubWorkload = tostring(engine),\n Location = tostring(regions[0]),\n Risks = iif(isnull(issues.open), toint(0), toint(issues.open)),\n SensitivityLabel = tostring(sensitivity),\n Provider = 'Cyera',\n TimeGenerated = case(isempty(tostring(discoveredDate)), todatetime(createdDate), todatetime(discoveredDate))\n| extend AdditionalFields = bag_pack(\n 'AccountIdentifier', tostring(account.inPlatformIdentifier),\n 'PublicAccessibilityState', tostring(publicAccessibilityState),\n 'CloudPlatform', tostring(provider),\n 'Regions', regions,\n 'CloudProviderUrl', tostring(cloudProviderUrl),\n 'ClassificationGroups', classificationGroups,\n 'RecordCountBySensitivity', recordCountBySensitivity,\n 'CloudProviderTags', cloudProviderTags,\n 'UserTags', userTags,\n 'OwnersRaw', ownersArr\n)\n| project AssetID, AssetName, Workload, SubWorkload, Location,\n Risks, SensitivityLabel, AssetOwner, TimeGenerated, Provider, AdditionalFields",
                        "outputStream": "Custom-CyeraAssets_MS_CL"
                    },
                    {
                        "streams": [
                            "Custom-CyeraAssets_SRC"
                        ],
                        "destinations": [
                            "cyeradspm"
                        ],
                        "transformKql": "source\n| extend accountIdentifier = tostring(account.inPlatformIdentifier)\n| extend assetName = tostring(name)\n| extend assetType = tostring(['type'])\n| extend engine = tostring(engine)\n| extend location = tostring(regions[0])\n| extend nativeAssetId = tostring(uid)\n| extend openIssues = toint(issues.open)\n| extend issuesClosed = toint(issues.closed)\n| extend issuesInProgress = toint(issues.inProgress)\n| extend assetOwner = tostring(datastoreOwners[0].email)\n| extend publicAccessibilityState = tostring(publicAccessibilityState)\n| extend regions = tostring(regions)\n| extend sensitivity = tostring(sensitivity)\n| extend sensitivityDisplayName = tostring(sensitivityDisplayName)\n| extend classificationLevel = tostring(classificationLevel)\n| extend uid = tostring(uid)\n| extend workload = tostring(dataType)\n| extend createdDate = todatetime(createdDate)\n| extend lastModifiedDate = todatetime(lastModifiedTime)\n| extend lastScannedDate = todatetime(discoveredDate)\n| extend ghost = tobool(ghost)\n| extend encrypted = tobool(encrypted)\n| extend sslEnforced = tobool(sslEnforced)\n| extend autoScan = tobool(autoScan)\n| extend scanningState = tostring(scanningState)\n| extend datastoreSizeInGiB = todouble(datastoreSizeInGiB)\n| extend rcVerySensitive = toint(todynamic(recordCountBySensitivity)['VerySensitive'])\n| extend rcSensitive = toint(todynamic(recordCountBySensitivity)['Sensitive'])\n| extend rcInternal = toint(todynamic(recordCountBySensitivity)['Internal'])\n| extend rcNotSensitive = toint(todynamic(recordCountBySensitivity)['NotSensitive'])\n| extend rcUnclassified = toint(todynamic(recordCountBySensitivity)['Unclassified'])\n| extend provider = tostring(provider)\n| extend cloudProviderUrl = tostring(cloudProviderUrl)\n| extend classificationGroups = classificationGroups\n| extend cloudProviderTags = cloudProviderTags\n| extend userTags = userTags\n| extend AdditionalFields = bag_pack('OwnersRaw', datastoreOwners)\n| extend TimeGenerated = todatetime(discoveredDate)\n| project accountIdentifier, assetName, assetType, engine, location, nativeAssetId, openIssues, issuesClosed, issuesInProgress, assetOwner, publicAccessibilityState, regions, sensitivity, sensitivityDisplayName, classificationLevel, uid, workload, createdDate, lastModifiedDate, lastScannedDate, ghost, encrypted, sslEnforced, autoScan, scanningState, datastoreSizeInGiB, rcVerySensitive, rcSensitive, rcInternal, rcNotSensitive, rcUnclassified, provider, cloudProviderUrl, classificationGroups, cloudProviderTags, userTags, AdditionalFields, TimeGenerated\n",
                        "outputStream": "Custom-CyeraAssets_CL"
                    },
                    {
                        "streams": [
                            "Custom-CyeraIssues_SRC"
                        ],
                        "destinations": [
                            "cyeradspm"
                        ],
                        "transformKql": "source\n| extend TimeGenerated = now()",
                        "outputStream": "Custom-CyeraIssues_CL"
                    },
                    {
                        "streams": [
                            "Custom-CyeraIdentities_SRC"
                        ],
                        "destinations": [
                            "cyeradspm"
                        ],
                        "transformKql": "source\n| extend TimeGenerated = now()",
                        "outputStream": "Custom-CyeraIdentities_CL"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('FunctionName')]",
            "location": "[resourceGroup().location]",
            "kind": "web",
            "properties": {
                "Application_Type": "web",
                "ApplicationId": "[variables('FunctionName')]",
                "WorkspaceResourceId": "[variables('workspaceResourceId')]"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2019-06-01",
            "name": "[tolower(variables('FunctionName'))]",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "kind": "StorageV2",
            "properties": {
                "networkAcls": {
                    "bypass": "AzureServices",
                    "virtualNetworkRules": [],
                    "ipRules": [],
                    "defaultAction": "Allow"
                },
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                    "services": {
                        "file": {
                            "keyType": "Account",
                            "enabled": true
                        },
                        "blob": {
                            "keyType": "Account",
                            "enabled": true
                        }
                    },
                    "keySource": "Microsoft.Storage"
                }
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices",
            "apiVersion": "2019-06-01",
            "name": "[concat(variables('FunctionName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', tolower(variables('FunctionName')))]"
            ],
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "properties": {
                "cors": {
                    "corsRules": []
                },
                "deleteRetentionPolicy": {
                    "enabled": false
                }
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/fileServices",
            "apiVersion": "2019-06-01",
            "name": "[concat(variables('FunctionName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', tolower(variables('FunctionName')))]"
            ],
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "properties": {
                "cors": {
                    "corsRules": []
                }
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2018-11-01",
            "name": "[variables('FunctionName')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', tolower(variables('FunctionName')))]",
                "[resourceId('Microsoft.Insights/components', variables('FunctionName'))]"
            ],
            "kind": "functionapp,linux",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "name": "[variables('FunctionName')]",
                "httpsOnly": true,
                "clientAffinityEnabled": true,
                "alwaysOn": true,
                "reserved": true,
                "siteConfig": {
                    "linuxFxVersion": "python|3.11"
                }
            },
            "resources": [
                {
                    "apiVersion": "2018-11-01",
                    "type": "config",
                    "name": "appsettings",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', variables('FunctionName'))]"
                    ],
                    "properties": {
                        "FUNCTIONS_EXTENSION_VERSION": "~4",
                        "FUNCTIONS_WORKER_RUNTIME": "python",
                        "APPINSIGHTS_INSTRUMENTATIONKEY": "[reference(resourceId('Microsoft.insights/components', variables('FunctionName')), '2015-05-01').InstrumentationKey]",
                        "APPLICATIONINSIGHTS_CONNECTION_STRING": "[reference(resourceId('microsoft.insights/components', variables('FunctionName')), '2015-05-01').ConnectionString]",
                        "AzureWebJobsStorage": "[concat('DefaultEndpointsProtocol=https;AccountName=', toLower(variables('FunctionName')),';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', toLower(variables('FunctionName'))), '2019-06-01').keys[0].value, ';EndpointSuffix=',toLower(variables('StorageSuffix')))]",
                        "DCR_INGEST": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', 'CyeraDSPMFunctions'), '2022-06-01','Full').properties.dataCollectionEndpointId]",
                        "DCR_IMMUTABLE_ID": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', 'CyeraDSPMFunctions'), '2022-06-01','Full').properties.immutableId]",
                        "CYERA_BASE": "[parameters('CyeraBaseUrl')]",
                        "CYERA_CLIENT_ID": "[parameters('CyeraClientId')]",
                        "CYERA_SECRET": "[parameters('CyeraSecret')]",
                        "WEBSITE_RUN_FROM_PACKAGE": "https://github.com/joshua-acklin-cyera/Azure-Sentinel/raw/refs/heads/cyera-dspm/Solutions/CyeraDSPM/Data%20Connectors/CyeraDSPM_Functions/CyeraDSPM_Functions.zip"
                    }
                }
            ]
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "2019-06-01",
            "name": "[concat(variables('FunctionName'), '/default/azure-webjobs-hosts')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('FunctionName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('FunctionName'))]"
            ],
            "properties": {
                "publicAccess": "None"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "2019-06-01",
            "name": "[concat(variables('FunctionName'), '/default/azure-webjobs-secrets')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('FunctionName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('FunctionName'))]"
            ],
            "properties": {
                "publicAccess": "None"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
            "apiVersion": "2019-06-01",
            "name": "[concat(variables('FunctionName'), '/default/', tolower(variables('FunctionName')))]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/fileServices', variables('FunctionName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('FunctionName'))]"
            ],
            "properties": {
                "shareQuota": 5120
            }
        }
    ]
}
