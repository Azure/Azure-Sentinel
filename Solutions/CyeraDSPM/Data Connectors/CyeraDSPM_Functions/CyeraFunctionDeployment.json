{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "FunctionName": {
            "defaultValue": "CyeraDSPMConnector",
            "minLength": 1,
            "maxLength": 30,
            "type": "string"
        },
        "workspace": {
            "type": "string",
            "defaultValue": "<workspaceName>"
        },
        "workspace-location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "[concat('Region to deploy solution resources -- separate from location selection',resourceGroup().location)]"
            }
        },
        "CyeraBaseUrl": {
            "type": "string",
            "defaultValue": "https://api.cyera.io"
        },
        "CyeraClientId": {
            "type": "securestring",
            "defaultValue": "<CyeraClientID>"
        },
        "CyeraSecret": {
            "type": "securestring",
            "defaultValue": "<CyeraSecret>"
        }
    },
    "variables": {
        "FunctionName": "[take(concat(toLower(parameters('FunctionName')), uniqueString(resourceGroup().id)), 24)]",
        "StorageSuffix": "[environment().suffixes.storage]",
        "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
        "dce-name": "[concat('sentinel-dce-',variables('FunctionName'))]",
        "dcr-name": "[concat('sentinel-dcr-',variables('FunctionName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2022-09-01",
            "name": "AuditTablesTemplate",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[format('{0}/{1}', parameters('workspace'), 'CyeraClassifications_CL')]",
                            "type": "Microsoft.OperationalInsights/workspaces/tables",
                            "apiVersion": "2022-10-01",
                            "tags": {},
                            "properties": {
                                "plan": "Analytics",
                                "schema": {
                                    "name": "CyeraClassifications_CL",
                                    "columns": [
                                        {
                                            "name": "TimeGenerated",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "uid",
                                            "type": "string"
                                        },
                                        {
                                            "name": "dataClassName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "classificationName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "name",
                                            "type": "string"
                                        },
                                        {
                                            "name": "sensitivity",
                                            "type": "string"
                                        },
                                        {
                                            "name": "sensitivityDisplayName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "defaultSensitivity",
                                            "type": "string"
                                        },
                                        {
                                            "name": "defaultSensitivityDisplayName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "dataCategory",
                                            "type": "string"
                                        },
                                        {
                                            "name": "classificationGroup",
                                            "type": "string"
                                        },
                                        {
                                            "name": "classificationLevel",
                                            "type": "string"
                                        },
                                        {
                                            "name": "learned",
                                            "type": "boolean"
                                        },
                                        {
                                            "name": "collections",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "customCollections",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "frameworks",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "context",
                                            "type": "dynamic"
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "name": "[format('{0}/{1}', parameters('workspace'), 'CyeraAssets_CL')]",
                            "type": "Microsoft.OperationalInsights/workspaces/tables",
                            "apiVersion": "2022-10-01",
                            "tags": {},
                            "properties": {
                                "plan": "Analytics",
                                "schema": {
                                    "name": "CyeraAssets_CL",
                                    "columns": [
                                        {
                                            "name": "TimeGenerated",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "uid",
                                            "type": "string"
                                        },
                                        {
                                            "name": "name",
                                            "type": "string"
                                        },
                                        {
                                            "name": "type_s",
                                            "type": "string"
                                        },
                                        {
                                            "name": "provider",
                                            "type": "string"
                                        },
                                        {
                                            "name": "infrastructure",
                                            "type": "string"
                                        },
                                        {
                                            "name": "engine",
                                            "type": "string"
                                        },
                                        {
                                            "name": "regions",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "account",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "classificationGroups",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "cloudProviderTags",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "owner",
                                            "type": "string"
                                        },
                                        {
                                            "name": "dataType",
                                            "type": "string"
                                        },
                                        {
                                            "name": "discoveredDate",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "createdDate",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "cloudProviderUrl",
                                            "type": "string"
                                        },
                                        {
                                            "name": "scanningState",
                                            "type": "string"
                                        },
                                        {
                                            "name": "ghost",
                                            "type": "boolean"
                                        },
                                        {
                                            "name": "vpc",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "sensitivity",
                                            "type": "string"
                                        },
                                        {
                                            "name": "sensitivityDisplayName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "recordCountBySensitivity",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "issues",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "userTags",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "collections",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "customCollections",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "frameworks",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "learned",
                                            "type": "boolean"
                                        },
                                        {
                                            "name": "classificationLevel",
                                            "type": "string"
                                        },
                                        {
                                            "name": "encrypted",
                                            "type": "boolean"
                                        },
                                        {
                                            "name": "sslEnforced",
                                            "type": "string"
                                        },
                                        {
                                            "name": "logging",
                                            "type": "string"
                                        },
                                        {
                                            "name": "publicAccessibilityState",
                                            "type": "string"
                                        },
                                        {
                                            "name": "lastDataRefresh",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "lastModifiedTime",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "lastModifiedDate",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "lastScannedDate",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "driveId",
                                            "type": "string"
                                        },
                                        {
                                            "name": "arn",
                                            "type": "string"
                                        },
                                        {
                                            "name": "rdsEndpoint",
                                            "type": "string"
                                        },
                                        {
                                            "name": "azureId",
                                            "type": "string"
                                        },
                                        {
                                            "name": "datastoreSizeInGiB",
                                            "type": "real"
                                        },
                                        {
                                            "name": "projectIds",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "datastoreOwners",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "autoScan",
                                            "type": "boolean"
                                        },
                                        {
                                            "name": "siteName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "userId",
                                            "type": "string"
                                        },
                                        {
                                            "name": "siteId",
                                            "type": "string"
                                        },
                                        {
                                            "name": "resourceId",
                                            "type": "string"
                                        },
                                        {
                                            "name": "region",
                                            "type": "string"
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "name": "[format('{0}/{1}', parameters('workspace'), 'CyeraAssets_MS_CL')]",
                            "type": "Microsoft.OperationalInsights/workspaces/tables",
                            "apiVersion": "2022-10-01",
                            "tags": {},
                            "properties": {
                                "plan": "Analytics",
                                "schema": {
                                    "name": "CyeraAssets_MS_CL",
                                    "columns": [
                                        {
                                            "name": "TimeGenerated",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "AssetID",
                                            "type": "string"
                                        },
                                        {
                                            "name": "AssetName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Workload",
                                            "type": "string"
                                        },
                                        {
                                            "name": "SubWorkload",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Location",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Risks",
                                            "type": "int"
                                        },
                                        {
                                            "name": "SensitivityLabel",
                                            "type": "string"
                                        },
                                        {
                                            "name": "AssetOwner",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Provider",
                                            "type": "string"
                                        },
                                        {
                                            "name": "AdditionalFields",
                                            "type": "dynamic"
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "name": "[format('{0}/{1}', parameters('workspace'), 'CyeraIdentities_CL')]",
                            "type": "Microsoft.OperationalInsights/workspaces/tables",
                            "apiVersion": "2022-10-01",
                            "tags": {},
                            "properties": {
                                "plan": "Analytics",
                                "schema": {
                                    "name": "CyeraIdentities_CL",
                                    "columns": [
                                        {
                                            "name": "TimeGenerated",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "uid",
                                            "type": "string"
                                        },
                                        {
                                            "name": "category",
                                            "type": "string"
                                        },
                                        {
                                            "name": "displayName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "displayId",
                                            "type": "string"
                                        },
                                        {
                                            "name": "scopeNamespace",
                                            "type": "string"
                                        },
                                        {
                                            "name": "scopeDisplayName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "scopeId",
                                            "type": "string"
                                        },
                                        {
                                            "name": "trustLevel",
                                            "type": "string"
                                        },
                                        {
                                            "name": "isStale",
                                            "type": "boolean"
                                        },
                                        {
                                            "name": "isEnabled",
                                            "type": "boolean"
                                        },
                                        {
                                            "name": "multiFactorAuthenticationStatus",
                                            "type": "string"
                                        },
                                        {
                                            "name": "membersCount",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "hasCopilot",
                                            "type": "boolean"
                                        },
                                        {
                                            "name": "lastActiveTime",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "creationTime",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "description",
                                            "type": "string"
                                        },
                                        {
                                            "name": "isAdmin",
                                            "type": "boolean"
                                        },
                                        {
                                            "name": "classificationGroupsNames",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "sensitivity",
                                            "type": "string"
                                        },
                                        {
                                            "name": "sensitiveRecords",
                                            "type": "real"
                                        },
                                        {
                                            "name": "sensitivityBreakdown",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "lastPasswordUpdateTime",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "jobTitle",
                                            "type": "string"
                                        },
                                        {
                                            "name": "department",
                                            "type": "string"
                                        },
                                        {
                                            "name": "officeLocation",
                                            "type": "string"
                                        },
                                        {
                                            "name": "country",
                                            "type": "string"
                                        },
                                        {
                                            "name": "hasMultipleParents",
                                            "type": "boolean"
                                        },
                                        {
                                            "name": "domain",
                                            "type": "string"
                                        },
                                        {
                                            "name": "businessFunction",
                                            "type": "string"
                                        },
                                        {
                                            "name": "seniorityLevel",
                                            "type": "string"
                                        },
                                        {
                                            "name": "issueCountBySeverity",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "reportsTo",
                                            "type": "string"
                                        },
                                        {
                                            "name": "managerId",
                                            "type": "string"
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "name": "[format('{0}/{1}', parameters('workspace'), 'CyeraIssues_CL')]",
                            "type": "Microsoft.OperationalInsights/workspaces/tables",
                            "apiVersion": "2022-10-01",
                            "tags": {},
                            "properties": {
                                "plan": "Analytics",
                                "schema": {
                                    "name": "CyeraIssues_CL",
                                    "columns": [
                                        {
                                            "name": "TimeGenerated",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "provider",
                                            "type": "string"
                                        },
                                        {
                                            "name": "infrastructure",
                                            "type": "string"
                                        },
                                        {
                                            "name": "engine",
                                            "type": "string"
                                        },
                                        {
                                            "name": "regions",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "account",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "classificationGroups",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "cloudProviderTags",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "owner",
                                            "type": "string"
                                        },
                                        {
                                            "name": "uid",
                                            "type": "string"
                                        },
                                        {
                                            "name": "name",
                                            "type": "string"
                                        },
                                        {
                                            "name": "severity",
                                            "type": "string"
                                        },
                                        {
                                            "name": "createdDate",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "updatedDate",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "status",
                                            "type": "string"
                                        },
                                        {
                                            "name": "riskStatus",
                                            "type": "string"
                                        },
                                        {
                                            "name": "resolution",
                                            "type": "string"
                                        },
                                        {
                                            "name": "resolutionNote",
                                            "type": "string"
                                        },
                                        {
                                            "name": "datastoreName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "datastoreUid",
                                            "type": "string"
                                        },
                                        {
                                            "name": "risk",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "data",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "datastoreCloudProviderTags",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "datastoreUserTags",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "datastoreOwners",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "remediationAdvice",
                                            "type": "string"
                                        },
                                        {
                                            "name": "policyUid",
                                            "type": "string"
                                        },
                                        {
                                            "name": "itsmTickets",
                                            "type": "dynamic"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "parameters": {}
            },
            "subscriptionId": "[subscription().subscriptionId]",
            "resourceGroup": "[resourceGroup().name]"
        },
        {
            "type": "Microsoft.Insights/dataCollectionEndpoints",
            "apiVersion": "2022-06-01",
            "name": "[variables('dce-name')]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "networkAcls": {
                    "publicNetworkAccess": "Enabled"
                }
            }
        },
        {
            "name": "[variables('dcr-name')]",
            "apiVersion": "2022-06-01",
            "type": "Microsoft.Insights/dataCollectionRules",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dce-name'))]",
                "[resourceId('Microsoft.Resources/deployments', 'AuditTablesTemplate')]"
            ],
            "properties": {
                "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dce-name'))]",
                "streamDeclarations": {
                    "Custom-CyeraAssets_SRC": {
                        "columns": [
                            {
                                "name": "TimeGenerated",
                                "type": "datetime"
                            },
                            {
                                "name": "uid",
                                "type": "string"
                            },
                            {
                                "name": "name",
                                "type": "string"
                            },
                            {
                                "name": "type",
                                "type": "string"
                            },
                            {
                                "name": "provider",
                                "type": "string"
                            },
                            {
                                "name": "infrastructure",
                                "type": "string"
                            },
                            {
                                "name": "engine",
                                "type": "string"
                            },
                            {
                                "name": "regions",
                                "type": "dynamic"
                            },
                            {
                                "name": "account",
                                "type": "dynamic"
                            },
                            {
                                "name": "classificationGroups",
                                "type": "dynamic"
                            },
                            {
                                "name": "cloudProviderTags",
                                "type": "dynamic"
                            },
                            {
                                "name": "owner",
                                "type": "string"
                            },
                            {
                                "name": "dataType",
                                "type": "string"
                            },
                            {
                                "name": "discoveredDate",
                                "type": "datetime"
                            },
                            {
                                "name": "createdDate",
                                "type": "datetime"
                            },
                            {
                                "name": "cloudProviderUrl",
                                "type": "string"
                            },
                            {
                                "name": "scanningState",
                                "type": "string"
                            },
                            {
                                "name": "ghost",
                                "type": "boolean"
                            },
                            {
                                "name": "vpc",
                                "type": "string"
                            },
                            {
                                "name": "sensitivity",
                                "type": "string"
                            },
                            {
                                "name": "sensitivityDisplayName",
                                "type": "string"
                            },
                            {
                                "name": "recordCountBySensitivity",
                                "type": "dynamic"
                            },
                            {
                                "name": "issues",
                                "type": "dynamic"
                            },
                            {
                                "name": "userTags",
                                "type": "dynamic"
                            },
                            {
                                "name": "collections",
                                "type": "dynamic"
                            },
                            {
                                "name": "customCollections",
                                "type": "dynamic"
                            },
                            {
                                "name": "frameworks",
                                "type": "dynamic"
                            },
                            {
                                "name": "learned",
                                "type": "boolean"
                            },
                            {
                                "name": "classificationLevel",
                                "type": "string"
                            },
                            {
                                "name": "encrypted",
                                "type": "boolean"
                            },
                            {
                                "name": "sslEnforced",
                                "type": "string"
                            },
                            {
                                "name": "logging",
                                "type": "string"
                            },
                            {
                                "name": "publicAccessibilityState",
                                "type": "string"
                            },
                            {
                                "name": "lastDataRefresh",
                                "type": "datetime"
                            },
                            {
                                "name": "lastModifiedTime",
                                "type": "datetime"
                            },
                            {
                                "name": "lastModifiedDate",
                                "type": "datetime"
                            },
                            {
                                "name": "lastScannedDate",
                                "type": "datetime"
                            },
                            {
                                "name": "driveId",
                                "type": "string"
                            },
                            {
                                "name": "arn",
                                "type": "string"
                            },
                            {
                                "name": "rdsEndpoint",
                                "type": "string"
                            },
                            {
                                "name": "azureId",
                                "type": "string"
                            },
                            {
                                "name": "datastoreSizeInGiB",
                                "type": "real"
                            },
                            {
                                "name": "projectIds",
                                "type": "dynamic"
                            },
                            {
                                "name": "datastoreOwners",
                                "type": "dynamic"
                            },
                            {
                                "name": "autoScan",
                                "type": "boolean"
                            },
                            {
                                "name": "siteName",
                                "type": "string"
                            },
                            {
                                "name": "userId",
                                "type": "string"
                            },
                            {
                                "name": "siteId",
                                "type": "string"
                            },
                            {
                                "name": "resourceId",
                                "type": "string"
                            },
                            {
                                "name": "region",
                                "type": "string"
                            }
                        ]
                    },
                    "Custom-CyeraIdentities_SRC": {
                        "columns": [
                            {
                                "name": "TimeGenerated",
                                "type": "datetime"
                            },
                            {
                                "name": "uid",
                                "type": "string"
                            },
                            {
                                "name": "category",
                                "type": "string"
                            },
                            {
                                "name": "displayName",
                                "type": "string"
                            },
                            {
                                "name": "displayId",
                                "type": "string"
                            },
                            {
                                "name": "scopeNamespace",
                                "type": "string"
                            },
                            {
                                "name": "scopeDisplayName",
                                "type": "string"
                            },
                            {
                                "name": "scopeId",
                                "type": "string"
                            },
                            {
                                "name": "trustLevel",
                                "type": "string"
                            },
                            {
                                "name": "isStale",
                                "type": "boolean"
                            },
                            {
                                "name": "isEnabled",
                                "type": "boolean"
                            },
                            {
                                "name": "multiFactorAuthenticationStatus",
                                "type": "string"
                            },
                            {
                                "name": "membersCount",
                                "type": "dynamic"
                            },
                            {
                                "name": "hasCopilot",
                                "type": "boolean"
                            },
                            {
                                "name": "lastActiveTime",
                                "type": "datetime"
                            },
                            {
                                "name": "creationTime",
                                "type": "datetime"
                            },
                            {
                                "name": "description",
                                "type": "string"
                            },
                            {
                                "name": "isAdmin",
                                "type": "boolean"
                            },
                            {
                                "name": "classificationGroupsNames",
                                "type": "dynamic"
                            },
                            {
                                "name": "sensitivity",
                                "type": "string"
                            },
                            {
                                "name": "sensitiveRecords",
                                "type": "real"
                            },
                            {
                                "name": "sensitivityBreakdown",
                                "type": "dynamic"
                            },
                            {
                                "name": "lastPasswordUpdateTime",
                                "type": "datetime"
                            },
                            {
                                "name": "jobTitle",
                                "type": "string"
                            },
                            {
                                "name": "department",
                                "type": "string"
                            },
                            {
                                "name": "officeLocation",
                                "type": "string"
                            },
                            {
                                "name": "country",
                                "type": "string"
                            },
                            {
                                "name": "hasMultipleParents",
                                "type": "boolean"
                            },
                            {
                                "name": "domain",
                                "type": "string"
                            },
                            {
                                "name": "businessFunction",
                                "type": "string"
                            },
                            {
                                "name": "seniorityLevel",
                                "type": "string"
                            },
                            {
                                "name": "issueCountBySeverity",
                                "type": "dynamic"
                            },
                            {
                                "name": "reportsTo",
                                "type": "string"
                            },
                            {
                                "name": "managerId",
                                "type": "string"
                            }
                        ]
                    },
                    "Custom-CyeraIssues_SRC": {
                        "columns": [
                            {
                                "name": "TimeGenerated",
                                "type": "datetime"
                            },
                            {
                                "name": "provider",
                                "type": "string"
                            },
                            {
                                "name": "infrastructure",
                                "type": "string"
                            },
                            {
                                "name": "engine",
                                "type": "string"
                            },
                            {
                                "name": "regions",
                                "type": "dynamic"
                            },
                            {
                                "name": "account",
                                "type": "dynamic"
                            },
                            {
                                "name": "classificationGroups",
                                "type": "dynamic"
                            },
                            {
                                "name": "cloudProviderTags",
                                "type": "dynamic"
                            },
                            {
                                "name": "owner",
                                "type": "string"
                            },
                            {
                                "name": "uid",
                                "type": "string"
                            },
                            {
                                "name": "name",
                                "type": "string"
                            },
                            {
                                "name": "severity",
                                "type": "string"
                            },
                            {
                                "name": "createdDate",
                                "type": "datetime"
                            },
                            {
                                "name": "updatedDate",
                                "type": "datetime"
                            },
                            {
                                "name": "status",
                                "type": "string"
                            },
                            {
                                "name": "riskStatus",
                                "type": "string"
                            },
                            {
                                "name": "resolution",
                                "type": "string"
                            },
                            {
                                "name": "resolutionNote",
                                "type": "string"
                            },
                            {
                                "name": "datastoreName",
                                "type": "string"
                            },
                            {
                                "name": "datastoreUid",
                                "type": "string"
                            },
                            {
                                "name": "risk",
                                "type": "dynamic"
                            },
                            {
                                "name": "data",
                                "type": "dynamic"
                            },
                            {
                                "name": "datastoreCloudProviderTags",
                                "type": "dynamic"
                            },
                            {
                                "name": "datastoreUserTags",
                                "type": "dynamic"
                            },
                            {
                                "name": "datastoreOwners",
                                "type": "dynamic"
                            },
                            {
                                "name": "remediationAdvice",
                                "type": "string"
                            },
                            {
                                "name": "policyUid",
                                "type": "string"
                            },
                            {
                                "name": "itsmTickets",
                                "type": "dynamic"
                            }
                        ]
                    },
                    "Custom-CyeraClassifications_SRC": {
                        "columns": [
                            {
                                "name": "TimeGenerated",
                                "type": "datetime"
                            },
                            {
                                "name": "uid",
                                "type": "string"
                            },
                            {
                                "name": "dataClassName",
                                "type": "string"
                            },
                            {
                                "name": "classificationName",
                                "type": "string"
                            },
                            {
                                "name": "name",
                                "type": "string"
                            },
                            {
                                "name": "sensitivity",
                                "type": "string"
                            },
                            {
                                "name": "sensitivityDisplayName",
                                "type": "string"
                            },
                            {
                                "name": "defaultSensitivity",
                                "type": "string"
                            },
                            {
                                "name": "defaultSensitivityDisplayName",
                                "type": "string"
                            },
                            {
                                "name": "dataCategory",
                                "type": "string"
                            },
                            {
                                "name": "classificationGroup",
                                "type": "string"
                            },
                            {
                                "name": "classificationLevel",
                                "type": "string"
                            },
                            {
                                "name": "learned",
                                "type": "boolean"
                            },
                            {
                                "name": "collections",
                                "type": "dynamic"
                            },
                            {
                                "name": "customCollections",
                                "type": "dynamic"
                            },
                            {
                                "name": "frameworks",
                                "type": "dynamic"
                            },
                            {
                                "name": "context",
                                "type": "dynamic"
                            }
                        ]
                    }
                },
                "destinations": {
                    "logAnalytics": [
                        {
                            "workspaceResourceId": "[variables('workspaceResourceId')]",
                            "name": "cyeradspm"
                        }
                    ]
                },
                "dataFlows": [
                    {
                        "streams": [
                            "Custom-CyeraAssets_SRC"
                        ],
                        "destinations": [
                            "cyeradspm"
                        ],
                        "outputStream": "Custom-CyeraAssets_CL",
                        "transformKql": "source\n| extend TimeGenerated = todatetime(iif(isnull(TimeGenerated), now(), TimeGenerated))\n| extend type_s = ['type']\n| project TimeGenerated, uid, name, type_s, provider, infrastructure, engine, regions, account, classificationGroups, cloudProviderTags, owner, dataType, discoveredDate, createdDate, cloudProviderUrl, scanningState, ghost, vpc, sensitivity, sensitivityDisplayName, recordCountBySensitivity, issues, userTags, collections, customCollections, frameworks, learned, classificationLevel, encrypted, sslEnforced, logging, publicAccessibilityState, lastDataRefresh, lastModifiedTime, lastModifiedDate, lastScannedDate, driveId, arn, rdsEndpoint, azureId, datastoreSizeInGiB, projectIds, datastoreOwners, autoScan, siteName, userId, siteId, resourceId, region"
                    },
                    {
                        "streams": [
                            "Custom-CyeraIdentities_SRC"
                        ],
                        "destinations": [
                            "cyeradspm"
                        ],
                        "outputStream": "Custom-CyeraIdentities_CL",
                        "transformKql": "source\n| extend TimeGenerated = todatetime(iif(isnull(TimeGenerated), now(), TimeGenerated))\n| project TimeGenerated, uid, category, displayName, displayId, scopeNamespace, scopeDisplayName, scopeId, trustLevel, isStale, isEnabled, multiFactorAuthenticationStatus, membersCount, hasCopilot, lastActiveTime, creationTime, description, isAdmin, classificationGroupsNames, sensitivity, sensitiveRecords, sensitivityBreakdown, lastPasswordUpdateTime, jobTitle, department, officeLocation, country, hasMultipleParents, domain, businessFunction, seniorityLevel, issueCountBySeverity, reportsTo, managerId"
                    },
                    {
                        "streams": [
                            "Custom-CyeraIssues_SRC"
                        ],
                        "destinations": [
                            "cyeradspm"
                        ],
                        "outputStream": "Custom-CyeraIssues_CL",
                        "transformKql": "source\n| extend TimeGenerated = todatetime(iif(isnull(TimeGenerated), now(), TimeGenerated))\n| project TimeGenerated, provider, infrastructure, engine, regions, account, classificationGroups, cloudProviderTags, owner, uid, name, severity, createdDate, updatedDate, status, riskStatus, resolution, resolutionNote, datastoreName, datastoreUid, risk, data, datastoreCloudProviderTags, datastoreUserTags, datastoreOwners, remediationAdvice, policyUid, itsmTickets"
                    },
                    {
                        "streams": [
                            "Custom-CyeraClassifications_SRC"
                        ],
                        "destinations": [
                            "cyeradspm"
                        ],
                        "outputStream": "Custom-CyeraClassifications_CL",
                        "transformKql": "source\n| extend TimeGenerated = todatetime(iif(isnull(TimeGenerated), now(), TimeGenerated))\n| project TimeGenerated, uid, dataClassName, classificationName, name, sensitivity, sensitivityDisplayName, defaultSensitivity, defaultSensitivityDisplayName, dataCategory, classificationGroup, classificationLevel, learned, collections, customCollections, frameworks, context"
                    },
                    {
                        "streams": [
                            "Custom-CyeraAssets_SRC"
                        ],
                        "destinations": [
                            "cyeradspm"
                        ],
                        "outputStream": "Custom-CyeraAssets_MS_CL",
                        "transformKql": "source\n| extend _cand1 = iif(isnotnull(lastModifiedTime), lastModifiedTime, now())\n| extend _cand2 = iif(isnotnull(lastDataRefresh), lastDataRefresh, _cand1)\n| extend _cand3 = iif(isnotnull(createdDate), createdDate, _cand2)\n| extend _cand4 = iif(isnotnull(discoveredDate), discoveredDate, _cand3)\n| extend TimeGenerated = iif(isnull(_cand4) or _cand4 > now()+1d or _cand4 < datetime(2000-01-01), now(), todatetime(_cand4))\n| extend AssetID = case(isnotempty(tostring(arn)), tostring(arn), tostring(uid))\n| extend ownersArr  = iif(isnull(datastoreOwners), parse_json('[]'), todynamic(datastoreOwners))\n| extend firstOwner = iif(array_length(ownersArr) > 0, ownersArr[0], parse_json('null'))\n| extend owner_email = tostring(firstOwner.email),\n         owner_upn   = tostring(firstOwner.userPrincipalName),\n         owner_name  = tostring(firstOwner.name),\n         owner_uid   = tostring(firstOwner.datastoreOwnerUid)\n| extend AssetOwner = case(\n    isnotempty(owner_email), owner_email,\n    isnotempty(owner_upn),   owner_upn,\n    isnotempty(owner_name),  owner_name,\n    isnotempty(owner_uid),   owner_uid,\n    isnotempty(tostring(account.name)), tostring(account.name),\n    ''\n  )\n| extend AssetName   = tostring(name)\n| extend Workload    = tostring(['type'])\n| extend SubWorkload = tostring(engine)\n| extend _regions = todynamic(regions)\n| extend Location = iif(isnull(_regions) or array_length(_regions)==0, tostring(regions), tostring(_regions[0]))\n| extend _iss = todynamic(issues)\n| extend _openL   = tolong(_iss.open)\n| extend _progL   = tolong(_iss.inProgress)\n| extend _closedL = tolong(_iss.closed)\n| extend _flatL   = tolong(issues)\n| extend RisksLong = iif(\n    isnull(_openL) and isnull(_progL) and isnull(_closedL),\n    iif(isnull(_flatL), tolong(0), _flatL),\n    (iif(isnull(_openL),   tolong(0), _openL)\n     + iif(isnull(_progL), tolong(0), _progL)\n     + iif(isnull(_closedL), tolong(0), _closedL))\n  )\n| extend Risks = toint(RisksLong)\n| extend SensitivityLabel = tostring(sensitivity)\n| extend Provider         = 'Cyera'\n| extend AdditionalFields = pack(\n    'AccountIdentifier',        tostring(account.inPlatformIdentifier),\n    'PublicAccessibilityState', tostring(publicAccessibilityState),\n    'CloudPlatform',            tostring(provider),\n    'Regions',                  iif(isnull(_regions), parse_json('[]'), _regions),\n    'CloudProviderUrl',         tostring(cloudProviderUrl),\n    'ClassificationGroups',     iif(isnull(classificationGroups), parse_json('[]'), todynamic(classificationGroups)),\n    'CloudProviderTags',        iif(isnull(cloudProviderTags), parse_json('[]'), todynamic(cloudProviderTags)),\n    'UserTags',                 iif(isnull(userTags), parse_json('[]'), todynamic(userTags)),\n    'OwnersRaw',                ownersArr\n  )\n| project TimeGenerated, AssetID, AssetName, Workload, SubWorkload, Location, Risks,\n          SensitivityLabel, AssetOwner, Provider, AdditionalFields"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('FunctionName')]",
            "location": "[resourceGroup().location]",
            "kind": "web",
            "properties": {
                "Application_Type": "web",
                "ApplicationId": "[variables('FunctionName')]",
                "WorkspaceResourceId": "[variables('workspaceResourceId')]"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2019-06-01",
            "name": "[tolower(variables('FunctionName'))]",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "kind": "StorageV2",
            "properties": {
                "networkAcls": {
                    "bypass": "AzureServices",
                    "virtualNetworkRules": [],
                    "ipRules": [],
                    "defaultAction": "Allow"
                },
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                    "services": {
                        "file": {
                            "keyType": "Account",
                            "enabled": true
                        },
                        "blob": {
                            "keyType": "Account",
                            "enabled": true
                        }
                    },
                    "keySource": "Microsoft.Storage"
                }
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices",
            "apiVersion": "2019-06-01",
            "name": "[concat(variables('FunctionName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', tolower(variables('FunctionName')))]"
            ],
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "properties": {
                "cors": {
                    "corsRules": []
                },
                "deleteRetentionPolicy": {
                    "enabled": false
                }
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/fileServices",
            "apiVersion": "2019-06-01",
            "name": "[concat(variables('FunctionName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', tolower(variables('FunctionName')))]"
            ],
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "properties": {
                "cors": {
                    "corsRules": []
                }
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2018-11-01",
            "name": "[variables('FunctionName')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', tolower(variables('FunctionName')))]",
                "[resourceId('Microsoft.Insights/components', variables('FunctionName'))]"
            ],
            "kind": "functionapp,linux",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "name": "[variables('FunctionName')]",
                "httpsOnly": true,
                "clientAffinityEnabled": true,
                "alwaysOn": true,
                "reserved": true,
                "siteConfig": {
                    "linuxFxVersion": "python|3.11"
                }
            },
            "resources": [
                {
                    "apiVersion": "2018-11-01",
                    "type": "config",
                    "name": "appsettings",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', variables('FunctionName'))]"
                    ],
                    "properties": {
                        "FUNCTIONS_EXTENSION_VERSION": "~4",
                        "FUNCTIONS_WORKER_RUNTIME": "python",
                        "APPINSIGHTS_INSTRUMENTATIONKEY": "[reference(resourceId('Microsoft.insights/components', variables('FunctionName')), '2015-05-01').InstrumentationKey]",
                        "APPLICATIONINSIGHTS_CONNECTION_STRING": "[reference(resourceId('microsoft.insights/components', variables('FunctionName')), '2015-05-01').ConnectionString]",
                        "AzureWebJobsStorage": "[concat('DefaultEndpointsProtocol=https;AccountName=', toLower(variables('FunctionName')),';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', toLower(variables('FunctionName'))), '2019-06-01').keys[0].value, ';EndpointSuffix=',toLower(variables('StorageSuffix')))]",
                        "DCR_INGEST": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', variables('dcr-name')), '2022-06-01','Full').properties.dataCollectionEndpointId]",
                        "DCR_IMMUTABLE_ID": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', variables('dcr-name')), '2022-06-01','Full').properties.immutableId]",
                        "CYERA_BASE": "[parameters('CyeraBaseUrl')]",
                        "CYERA_CLIENT_ID": "[parameters('CyeraClientId')]",
                        "CYERA_SECRET": "[parameters('CyeraSecret')]",
                        "WEBSITE_RUN_FROM_PACKAGE": "https://github.com/joshua-acklin-cyera/Azure-Sentinel/raw/refs/heads/cyera-dspm/Solutions/CyeraDSPM/Data%20Connectors/CyeraDSPM_Functions/AzureFunctions/CyeraDSPM_Functions.zip"
                    }
                }
            ]
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "2019-06-01",
            "name": "[concat(variables('FunctionName'), '/default/azure-webjobs-hosts')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('FunctionName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('FunctionName'))]"
            ],
            "properties": {
                "publicAccess": "None"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "2019-06-01",
            "name": "[concat(variables('FunctionName'), '/default/azure-webjobs-secrets')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('FunctionName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('FunctionName'))]"
            ],
            "properties": {
                "publicAccess": "None"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
            "apiVersion": "2019-06-01",
            "name": "[concat(variables('FunctionName'), '/default/', tolower(variables('FunctionName')))]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/fileServices', variables('FunctionName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('FunctionName'))]"
            ],
            "properties": {
                "shareQuota": 5120
            }
        }
    ]
}