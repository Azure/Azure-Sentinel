{
    "type": "Microsoft.Insights/dataCollectionRules",
    "apiVersion": "2022-06-01",
    "name": "VersasecCms-DCR",
    "location": "{{location}}",
    "dependsOn": [
        "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('dceName'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspaceName'), 'VersasecCmsSysLogs_CL')]",
		"[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspaceName'), 'VersasecCmsErrorLogs_CL')]",
        "[resourceId('Microsoft.OperationsManagement/solutions', concat('SecurityInsights(', parameters('workspaceName'), ')'))]"
    ],
    "properties": {
        "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
        "streamDeclarations": {
          "Custom-VersasecCmsSysLogs_API": {
            "columns": [
              { "name": "rowData", "type": "dynamic" }
            ]
          },
          "Custom-VersasecCmsErrorLogs_API": {
            "columns": [
              { "name": "rowData", "type": "dynamic" }
            ]
          }
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "{{workspaceResourceId}}",
              "name": "ws"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [ "Custom-VersasecCmsSysLogs_API" ],
            "destinations": [ "ws" ],
            "transformKql": "source | project SyslogID = toreal(rowData[0]), SyslogIDCode = tostring(rowData[1]), SyslogIDStrg = tostring(rowData[2]), TimeGenerated = todatetime(rowData[3]), ID = toreal(rowData[4]), ComputerName = tostring(rowData[5]), CLID = tostring(rowData[6]), Param1 = tostring(rowData[7]), UserID = toreal(rowData[8]), TicketRef = tostring(rowData[9])",
            "outputStream": "[concat('Custom-', variables('syslogTableName'))]"
          },
          {
            "streams": [ "Custom-VersasecCmsErrorLogs_API" ],
            "destinations": [ "ws" ],
            "transformKql": "source | project CmsErrorID = toreal(rowData[0]), CmsErrorIDCode = tostring(rowData[1]), CmsErrorIDStrg = tostring(rowData[2]), TimeGenerated = todatetime(rowData[3]), ID = toreal(rowData[4]), ComputerName = tostring(rowData[5]), CLID = tostring(rowData[6]), ErrorStrg = tostring(rowData[7]), UserID = toreal(rowData[8]), SupportTicket = tostring(rowData[9]), TicketRef = tostring(rowData[10])",
            "outputStream": "[concat('Custom-', variables('errorlogTableName'))]"
          }
        ]
    },
	"variables": {
        "syslogTableName": "VersasecCmsSysLogs_CL",
        "errorlogTableName": "VersasecCmsErrorLogs_CL"
    }
}
