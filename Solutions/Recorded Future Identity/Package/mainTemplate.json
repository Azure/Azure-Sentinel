{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Recorded Future Premier Integrations - support@recordedfuture.com",
    "comments": "Solution template for Recorded Future Identity"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "email": "support@recordedfuture.com",
    "_email": "[variables('email')]",
    "_solutionName": "Recorded Future Identity",
    "_solutionVersion": "3.1.2",
    "solutionId": "recordedfuture1605638642586.recorded_future_identity_solution",
    "_solutionId": "[variables('solutionId')]",
    "RFI-CustomConnector-0-2-0": "RFI-CustomConnector-0-2-0",
    "_RFI-CustomConnector-0-2-0": "[variables('RFI-CustomConnector-0-2-0')]",
    "TemplateEmptyArray": "[json('[]')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "RFI-CustomConnector-0-2-0",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-lc-',uniquestring(variables('_playbookContentId1'))))]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','lc','-', uniqueString(concat(variables('_solutionId'),'-','LogicAppsCustomConnector','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
    "RFI-Playbook-Alert-Importer": "RFI-Playbook-Alert-Importer",
    "_RFI-Playbook-Alert-Importer": "[variables('RFI-Playbook-Alert-Importer')]",
    "TemplateEmptyObject": "[json('{}')]",
    "playbookVersion2": "1.1",
    "playbookContentId2": "RFI-Playbook-Alert-Importer",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))))]",
    "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
    "RFI-Playbook-Alert-Importer-LAW": "RFI-Playbook-Alert-Importer-LAW",
    "_RFI-Playbook-Alert-Importer-LAW": "[variables('RFI-Playbook-Alert-Importer-LAW')]",
    "playbookVersion3": "1.1",
    "playbookContentId3": "RFI-Playbook-Alert-Importer-LAW",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3'))))]",
    "_playbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId3'),'-', variables('playbookVersion3'))))]",
    "RFI-Playbook-Alert-Importer-LAW-Sentinel": "RFI-Playbook-Alert-Importer-LAW-Sentinel",
    "_RFI-Playbook-Alert-Importer-LAW-Sentinel": "[variables('RFI-Playbook-Alert-Importer-LAW-Sentinel')]",
    "playbookVersion4": "1.1",
    "playbookContentId4": "RFI-Playbook-Alert-Importer-LAW-Sentinel",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4'))))]",
    "_playbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId4'),'-', variables('playbookVersion4'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RFI-CustomConnector-0-2-0 Playbook with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "ConnectorName": {
              "defaultValue": "RFI-CustomConnector-0-2-0",
              "type": "String",
              "metadata": {
                "description": "Name of custom connector."
              }
            },
            "ServiceEndpoint": {
              "defaultValue": "https://api.recordedfuture.com/gw/azure-identity",
              "type": "String",
              "metadata": {
                "description": "Base URL to Recorded Future Identity API."
              }
            }
          },
          "variables": {
            "operationId-Credential_Lookup": "Credential_Lookup",
            "_operationId-Credential_Lookup": "[[variables('operationId-Credential_Lookup')]",
            "operationId-Credential_Search": "Credential_Search",
            "_operationId-Credential_Search": "[[variables('operationId-Credential_Search')]",
            "operationId-Playbook_Alerts_Search": "Playbook_Alerts_Search",
            "_operationId-Playbook_Alerts_Search": "[[variables('operationId-Playbook_Alerts_Search')]",
            "operationId-Playbook_Alerts_Update": "Playbook_Alerts_Update",
            "_operationId-Playbook_Alerts_Update": "[[variables('operationId-Playbook_Alerts_Update')]",
            "operationId-Playbook_Alerts_Lookup": "Playbook_Alerts_Lookup",
            "_operationId-Playbook_Alerts_Lookup": "[[variables('operationId-Playbook_Alerts_Lookup')]",
            "operationId-Credential_Lookup_V2": "Credential_Lookup_V2",
            "_operationId-Credential_Lookup_V2": "[[variables('operationId-Credential_Lookup_V2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId1": "RFI-CustomConnector-0-2-0",
            "playbookId1": "[[resourceId('Microsoft.Web/customApis', parameters('ConnectorName'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('ConnectorName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "connectionParameters": {
                  "api_key": {
                    "type": "securestring"
                  }
                },
                "backendService": {
                  "serviceUrl": "[[parameters('ServiceEndPoint')]"
                },
                "capabilities": "[variables('TemplateEmptyArray')]",
                "brandColor": "#FFFFFF",
                "description": "Recorded Future Identity Connector enables access to the Recorded Future Identity Intelligence. The connector has dedicated actions for search and lookup of identity leaks.",
                "displayName": "[[parameters('ConnectorName')]",
                "iconUri": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEBLAEsAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/2wBDAQMEBAUEBQkFBQkUDQsNFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBT/wAARCAAoADADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9U6a7rGpZ2CqoyWY4Ap1YXjjwXpvxC8K6h4d1hZX02+QJMIZDG+AwYYYdOVFVHlckpOyJlzKLcVdniXxW8VeJvF/ir4ofD2wSO4tY/Cq3NnBGoWRpnIDfOSOoYjB44Fa/wz8ZeIdL+JujeAdRaOKwsfBlreSwsoMi3IKoxL55GMj04rzjx5p+m+G/id8VYLnT573RbLwLbxfZlnaNpI1KKq+bgkH5evPQ9a0PBvh3S/GPxkt9LaznttC1L4b20HkeczOkLuo2+ZwSQOM98V9U6VP6va3u8t9uvLHXff8Aq58sqtT6xe/vc1t+nNLTbb+rH1SrBlDKQVIyCOhpay/C/h2z8I+HdN0TTldbHT4Et4RI5dtijAyT1NalfKStd22Pqo3sr7nnvgr45eHPHV5pttaRanYtqkTS6fJqNi8Ed4qrubynPysQuTjOcAntXZnXtMXT5b86jaCxiJEl156+UhBwctnA5r5TH7OvifRfBOjLNczCb/hHLmxmGpaqDBol2y482PL7QjoWiOzO3dkcE1f0H4X3mrXMGsaZpFtqlpYX9rPeeG21LT2ju1SKZAwjt0WFWUyAgu2X2c7doz79TBYVtypVNPl3+W//AAdmeDTxuKVo1aer9e36f8DdM+ifFcHhzxN4fk0jWbq0fTtciNsqtciM3KsOkbAgk88bfWrGlz6D4d0yHT7S7s7a1023WAI1wpMMSYQBiTnAIAye9fP2tfBTxBcR6o0fgfSXj1jR20+zs471CmhSmaV/My/Y+YrHys4ZMAYwaZo/7P2t6R4atJr3QbXXtVtfFEuoXtvNLEJNVs8MEy7HafmIkCOQMjnmsvq1Dks62l9tP8/l/wAA1+s1ue6o6231/wAvn/wT3vQPiDofiK3vp7a8WGKz1CXS3e5IjDTxkBlUk/N14x1pvj34iaH8N/D9/rGs3Oy3so0llihw82xpFjDBM5I3MBmvmiP4C+KbCbUtQv8AQUXRZrjURFosNzYlbRZpFZJQ06tGqlRsJXDrsGARxVjx58BPFGo+B/FWj2nhm38R6rqS2Mun6/PqMLTQRRRwI1vvcIxI8t8EBVYOScH5TqsDhPaxvV9266rur63+f5XMnjcV7OVqT5rdn2dtLf11se2ftIK0nwJ8bKqlmOmyYAGT2ri4G1P4ReKPB8usnRdK0XUJLqK8k8O6W9vDIwgBt1mA3Fm3b9vuSO9FFZ4P36caL2k5X/8AAUaYz3akqq3io2/8CZ5HbeIvEqre+JTrusp4ivPCIuLRe87x3cgkVV28lI13kDkEk+1d/rHxE1fxz8XF0vQPE2o2nhu91CwgjuLJNn7t7K6eTyy6d2jX5scEcdKKK9+rShyzqWV0nbRd1+VvxZ4NKrNShTu7Nq+r7frfX5D/AId674p8U+NINJ1/VpJmmubuHVdFupHdo4Yy/kMsS2wEJBWI+Y0pEgJ6lgB9JWtvHZ28UES7Yo1CKMk8D3NFFfN5laNSKirK1z6PLbypycnd3t+R/9k=",
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "title": "Recorded Future Identity",
                    "description": "The Recorded Future Identity Intelligence Connector enables security and IT\nteams to detect identity compromises, for both employees and customers. To\ndo this, Recorded Future automates the collection, analysis, and production\nof identity intelligence from a vast range of sources. Through this\nconnector, organizations can incorporate identity intelligence into\nautomated workflows (e.g., password resets) with applications such as Azure\nActive Directory and Microsoft Sentinel.",
                    "contact": {
                      "name": "Recorded Future Support",
                      "url": "https://support.recordedfuture.com",
                      "email": "support@recordedfuture.com"
                    },
                    "version": "2.0.0"
                  },
                  "host": "api.recordedfuture.com",
                  "basePath": "/gw/azure-identity",
                  "schemes": [
                    "https"
                  ],
                  "consumes": "[variables('TemplateEmptyArray')]",
                  "produces": "[variables('TemplateEmptyArray')]",
                  "paths": {
                    "/credentials/lookup": {
                      "post": {
                        "tags": [
                          "Identity"
                        ],
                        "summary": "Credential Lookup - Look up credential data for one or more users",
                        "description": "Look up exposed credential data for a specific set of subjects",
                        "operationId": "[[variables('_operationId-Credential_Lookup')]",
                        "consumes": [
                          "application/json"
                        ],
                        "produces": [
                          "application/json"
                        ],
                        "parameters": [
                          {
                            "in": "body",
                            "name": "body",
                            "schema": {
                              "$ref": "#/definitions/CredentialsLookupRequest"
                            }
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "Returns detailed information on the exposed credentials",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "exposed_credentials": {
                                  "title": "Exposed credentials",
                                  "description": "List of exposed credentials",
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "clear_text_hint": {
                                        "description": "First two letters of the exposed secret. Only available for secrets exposed in clear text",
                                        "type": "string",
                                        "example": "s5",
                                        "x-ms-visibility": "important"
                                      },
                                      "dumps": {
                                        "description": "List of data dumps in which the signature has been involved.",
                                        "type": "array",
                                        "items": {
                                          "type": "object",
                                          "properties": {
                                            "breaches": {
                                              "description": "List of data breaches related to the dump",
                                              "type": "array",
                                              "items": {
                                                "type": "object",
                                                "properties": {
                                                  "breached": {
                                                    "type": "string",
                                                    "example": "2016-06-01T00:00:00Z",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "description": {
                                                    "type": "string",
                                                    "example": "Evony.com reportedly suffered data breaches in June and August 2016, resulting in the exposure of over 34 million user accounts.",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "domain": {
                                                    "type": "string",
                                                    "example": "evony.com",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "name": {
                                                    "type": "string",
                                                    "example": "Evony",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "precision": {
                                                    "type": "string",
                                                    "example": "month",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "site_description": {
                                                    "type": "string",
                                                    "example": "Evony.com is the website of Evony LLC, which develops browser and mobile-based online games.",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "start": {
                                                    "type": "string",
                                                    "example": "2016-06-01T00:00:00Z",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "stop": {
                                                    "type": "string",
                                                    "example": "2016-08-31T23:59:59Z",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "type": {
                                                    "type": "string",
                                                    "example": "Breach",
                                                    "x-ms-visibility": "important"
                                                  }
                                                }
                                              }
                                            },
                                            "description": {
                                              "description": "Description of the dump",
                                              "type": "string",
                                              "example": "This credential data was derived from stealer malware logs. These logs were obtained through Recorded Future\\u2019s proprietary sources.",
                                              "x-ms-visibility": "important"
                                            },
                                            "downloaded": {
                                              "description": "Date when the dump was downloaded",
                                              "type": "string",
                                              "example": "2021-07-23T00:00:00Z",
                                              "x-ms-visibility": "important"
                                            },
                                            "name": {
                                              "description": "Name of the dump",
                                              "type": "string",
                                              "example": "XSS.is Dump 2021",
                                              "x-ms-visibility": "important"
                                            },
                                            "type": {
                                              "description": "Type of the dump",
                                              "type": "string",
                                              "example": "Combo List",
                                              "x-ms-visibility": "important"
                                            }
                                          }
                                        }
                                      },
                                      "exposed_secret_format": {
                                        "description": "Format of the exposed secret. Either the hash algorithm or clear for cleartext.",
                                        "type": "string",
                                        "example": "clear",
                                        "x-ms-visibility": "important"
                                      },
                                      "first_seen": {
                                        "description": "Date when the signature was first seen exposed",
                                        "type": "string",
                                        "example": "2021-07-23T00:00:00Z",
                                        "x-ms-visibility": "important"
                                      },
                                      "last_seen": {
                                        "description": "Date when the signature was last seen exposed",
                                        "type": "string",
                                        "example": "2021-07-23T00:00:00Z",
                                        "x-ms-visibility": "important"
                                      },
                                      "malware_family": {
                                        "title": "Malware family",
                                        "description": "Family of malware used to extract the credentials",
                                        "type": "string",
                                        "example": "RedLine Stealer",
                                        "x-ms-visibility": "important"
                                      },
                                      "secret_hashes": {
                                        "description": "List of known hashes of the exposed secret. Calculated by Recorded Future if the secret was exposed in clear text.",
                                        "type": "array",
                                        "items": {
                                          "type": "object",
                                          "properties": {
                                            "algorithm": {
                                              "title": "algorithm",
                                              "description": "Hash algorithm used",
                                              "type": "string",
                                              "example": "SHA1",
                                              "x-ms-visibility": "important"
                                            },
                                            "hash": {
                                              "title": "hash",
                                              "description": "Hash value",
                                              "type": "string",
                                              "example": "a7862e41d43a09e0297f197ec4673ad2c0e0d43c",
                                              "x-ms-visibility": "important"
                                            }
                                          }
                                        }
                                      },
                                      "secret_properties": {
                                        "description": "Properties of the clear text",
                                        "type": "array",
                                        "items": {
                                          "type": "string",
                                          "example": "Letter",
                                          "x-ms-visibility": "important"
                                        },
                                        "x-ms-visibility": "important"
                                      },
                                      "secret_rank": {
                                        "description": "Any common password collections the password is part of",
                                        "type": "string",
                                        "example": "Top100kCommonPasswords",
                                        "x-ms-visibility": "important"
                                      },
                                      "signature": {
                                        "title": "signature",
                                        "description": "Requested signature",
                                        "type": "string",
                                        "example": "06regq@www.google.com",
                                        "x-ms-visibility": "important"
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          },
                          "401": {
                            "description": "Authorization token is missing",
                            "schema": {
                              "$ref": "#/definitions/401Error"
                            }
                          },
                          "403": {
                            "description": "Provided token is not authorized to use the API.",
                            "schema": {
                              "$ref": "#/definitions/403Error"
                            }
                          }
                        },
                        "deprecated": true,
                        "security": [
                          {
                            "api_key": "[variables('TemplateEmptyArray')]"
                          }
                        ],
                        "x-ms-api-annotation": {
                          "family": "Credential_Lookup",
                          "revision": 1
                        },
                        "x-ms-visibility": "important"
                      }
                    },
                    "/credentials/search": {
                      "post": {
                        "tags": [
                          "Identity"
                        ],
                        "summary": "Credential Search - Search credential data for one or more domains",
                        "description": "Search credential data exposed in data dumps and through malware logs",
                        "operationId": "[[variables('_operationId-Credential_Search')]",
                        "consumes": [
                          "application/json"
                        ],
                        "produces": [
                          "application/json"
                        ],
                        "parameters": [
                          {
                            "in": "body",
                            "name": "body",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "domain_type": {
                                  "title": "Credential type",
                                  "description": "Select credential type",
                                  "default": "My Organization (workforce use case)",
                                  "enum": [
                                    "My Organization (workforce use case)",
                                    "Customer (external use case)"
                                  ],
                                  "type": "string",
                                  "example": "My Organization (workforce use case)",
                                  "x-ms-visibility": "important"
                                },
                                "domains": {
                                  "title": "Domains",
                                  "description": "List of domains to search",
                                  "type": "array",
                                  "items": {
                                    "title": "Domain",
                                    "description": "A domain owned by your organization",
                                    "type": "string",
                                    "example": "google.com",
                                    "x-ms-visibility": "important"
                                  },
                                  "x-ms-visibility": "important"
                                },
                                "filter": {
                                  "type": "object",
                                  "properties": {
                                    "breach_properties": {
                                      "$ref": "#/definitions/BreachProperties"
                                    },
                                    "dump_properties": {
                                      "$ref": "#/definitions/DumpProperties"
                                    },
                                    "latest_downloaded_gte": {
                                      "format": "date-time",
                                      "title": "From",
                                      "description": "YYYY-MM-DD (until today)",
                                      "type": "string",
                                      "example": "2017-07-21T19:32:28+02:00",
                                      "x-ms-visibility": "important"
                                    },
                                    "properties": {
                                      "$ref": "#/definitions/CredentialProperties"
                                    }
                                  }
                                },
                                "limit": {
                                  "title": "Results",
                                  "description": "Maxiumum number of results",
                                  "default": 500,
                                  "type": "number",
                                  "example": 10,
                                  "x-ms-visibility": "advanced"
                                },
                                "offset": {
                                  "title": "Offset",
                                  "description": "Records from offset",
                                  "type": "string",
                                  "example": "eyJzdWJqZWN0IjpudWxsLCJsb2dpbiI6IjU2MDQwMjQ5MjUxIiwiYXV0aG9yaXphdGlvbl9zZXJ2aWNlIjoiZ29vZ2xlLmNvbSJ9",
                                  "x-ms-visibility": "advanced"
                                }
                              }
                            }
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "Returns a list exposed credentials related to the searched domains",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "count": {
                                  "title": "Count",
                                  "description": "Number of returned credentials",
                                  "type": "number",
                                  "example": 2,
                                  "x-ms-visibility": "important"
                                },
                                "credential_dumps": {
                                  "title": "Credential dumps",
                                  "description": "List of credentials exposed in data dumps",
                                  "type": "array",
                                  "items": {
                                    "type": "string",
                                    "example": "test@domain.com",
                                    "x-ms-visibility": "important"
                                  }
                                },
                                "malware_logs": {
                                  "title": "Malware logs",
                                  "description": "List of credentials exposed through malware logs",
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "domain": {
                                        "title": "Domain",
                                        "description": "Login domain",
                                        "type": "string",
                                        "example": "www.domain.com",
                                        "x-ms-visibility": "important"
                                      },
                                      "login": {
                                        "title": "Login",
                                        "description": "Login username",
                                        "type": "string",
                                        "example": "testuser",
                                        "x-ms-visibility": "important"
                                      }
                                    }
                                  }
                                },
                                "next_offset": {
                                  "title": "Next offset",
                                  "description": "Offset used to request succeeding records",
                                  "type": "string",
                                  "example": "eyJzdWJqZWN0IjpudWxsLCJsb2dpbiI6IjU2MDQwMjQ5MjUxIiwiYXV0aG9yaXphdGlvbl9zZXJ2aWNlIjoiZ29vZ2xlLmNvbSJ9",
                                  "x-ms-visibility": "important"
                                }
                              }
                            }
                          },
                          "401": {
                            "description": "Authorization token is missing",
                            "schema": {
                              "$ref": "#/definitions/401Error"
                            }
                          },
                          "403": {
                            "description": "Provided token is not authorized to use the API.",
                            "schema": {
                              "$ref": "#/definitions/403Error"
                            }
                          }
                        },
                        "security": [
                          {
                            "api_key": "[variables('TemplateEmptyArray')]"
                          }
                        ],
                        "x-ms-visibility": "important"
                      }
                    },
                    "/playbook-alerts/search": {
                      "post": {
                        "tags": [
                          "Identity"
                        ],
                        "summary": "Playbook Alerts - Search for novel identity exposures",
                        "description": "Search for novel identity exposures",
                        "operationId": "[[variables('_operationId-Playbook_Alerts_Search')]",
                        "consumes": [
                          "application/json"
                        ],
                        "produces": [
                          "application/json"
                        ],
                        "parameters": [
                          {
                            "in": "body",
                            "name": "body",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "lookback_days": {
                                  "title": "Look back days",
                                  "description": "Number of days to look back for Playbook Alerts",
                                  "default": 7,
                                  "maximum": 15,
                                  "minimum": 1,
                                  "type": "number",
                                  "example": 7
                                },
                                "priorities": {
                                  "title": "Priorities",
                                  "description": "Priority of the alerts",
                                  "type": "array",
                                  "items": {
                                    "default": "High",
                                    "enum": [
                                      "High",
                                      "Moderate",
                                      "Informational"
                                    ],
                                    "type": "string",
                                    "example": "High"
                                  }
                                },
                                "status": {
                                  "title": "Status",
                                  "description": "Status of the alert",
                                  "type": "array",
                                  "items": {
                                    "enum": [
                                      "New",
                                      "InProgress"
                                    ],
                                    "type": "string",
                                    "example": "New"
                                  }
                                }
                              }
                            }
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "Returns a list with alerts of novel identity exposures",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "pba_items": {
                                  "title": "Playbook alert items",
                                  "description": "List of alerts with novel identity exposures",
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "alert_id": {
                                        "type": "string",
                                        "example": "task:82710d98-8354-450e-a9b0-985efb114196"
                                      },
                                      "identity": {
                                        "type": "string",
                                        "example": "example@example.com"
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          },
                          "401": {
                            "description": "Authorization token is missing",
                            "schema": {
                              "$ref": "#/definitions/401Error"
                            }
                          },
                          "403": {
                            "description": "Provided token is not authorized to use the API.",
                            "schema": {
                              "$ref": "#/definitions/403Error"
                            }
                          }
                        },
                        "security": [
                          {
                            "api_key": "[variables('TemplateEmptyArray')]"
                          }
                        ],
                        "x-ms-visibility": "important"
                      }
                    },
                    "/playbook-alerts/update": {
                      "put": {
                        "tags": [
                          "Identity"
                        ],
                        "summary": "Playbook Alerts - Update Playbook Alert",
                        "description": "Update a Playbook Alert. Generic alert properties like status, priority and assignee may be updated, or a log message may be appended.",
                        "operationId": "[[variables('_operationId-Playbook_Alerts_Update')]",
                        "consumes": [
                          "application/json"
                        ],
                        "produces": [
                          "application/json"
                        ],
                        "parameters": [
                          {
                            "in": "body",
                            "name": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "alert_id": {
                                  "description": "Id of the Playbook alert",
                                  "type": "string",
                                  "example": "task:82710d98-8354-450e-a9b0-985efb114196"
                                },
                                "log_entry": {
                                  "description": "Freetext log message. Maximum of 5000 characters.",
                                  "type": "string",
                                  "example": "This has been handled."
                                },
                                "status": {
                                  "$ref": "#/definitions/PlaybookAlertStatus"
                                },
                                "added_actions_taken": {
                                  "$ref": "#/definitions/PlaybookAlertOnwardActionList"
                                }
                              }
                            }
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "Result of the update request.",
                            "schema": {
                              "$ref": "#/definitions/PlaybookAlertStatusResponse"
                            }
                          }
                        },
                        "security": [
                          {
                            "api_key": "[variables('TemplateEmptyArray')]"
                          }
                        ],
                        "x-ms-visibility": "important"
                      }
                    },
                    "/playbook-alerts/{playbook_alert_id}": {
                      "get": {
                        "tags": [
                          "Identity"
                        ],
                        "summary": "Playbook Alerts - Detailed Identity Novel Exposures alert data",
                        "description": "Retrieve detailed information about a Identity Novel Exposures Playbook Alert",
                        "operationId": "[[variables('_operationId-Playbook_Alerts_Lookup')]",
                        "produces": [
                          "application/json"
                        ],
                        "parameters": [
                          {
                            "$ref": "#/parameters/PlaybookAlertId"
                          },
                          {
                            "in": "query",
                            "name": "return_html",
                            "description": "Return HTML for Microsoft Sentinel description and comments",
                            "type": "boolean"
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "Data for the requested panels.",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "html_comment": {
                                  "type": "string"
                                },
                                "html_description": {
                                  "type": "string"
                                },
                                "result": {
                                  "$ref": "#/definitions/IdentityExposuresResponse"
                                }
                              }
                            }
                          }
                        },
                        "security": [
                          {
                            "api_key": "[variables('TemplateEmptyArray')]"
                          }
                        ],
                        "x-ms-visibility": "important"
                      }
                    },
                    "/v2/credentials/lookup": {
                      "post": {
                        "tags": [
                          "Identity"
                        ],
                        "summary": "Credential Lookup V2 - Look up credential data for one or more users",
                        "description": "Look up exposed credential data for a specific set of subjects",
                        "operationId": "[[variables('_operationId-Credential_Lookup_V2')]",
                        "consumes": [
                          "application/json"
                        ],
                        "produces": [
                          "application/json"
                        ],
                        "parameters": [
                          {
                            "in": "body",
                            "name": "body",
                            "schema": {
                              "$ref": "#/definitions/CredentialsLookupRequest"
                            }
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "Success",
                            "schema": {
                              "$ref": "#/definitions/LookupResponse"
                            }
                          }
                        },
                        "security": [
                          {
                            "api_key": "[variables('TemplateEmptyArray')]"
                          }
                        ],
                        "x-ms-api-annotation": {
                          "family": "Credential_Lookup",
                          "revision": 2
                        },
                        "x-ms-visibility": "important"
                      }
                    }
                  },
                  "definitions": {
                    "401Error": {
                      "type": "object",
                      "properties": {
                        "error": {
                          "type": "object",
                          "properties": {
                            "status": {
                              "type": "number",
                              "example": 401
                            }
                          }
                        }
                      }
                    },
                    "403Error": {
                      "type": "object",
                      "properties": {
                        "code": {
                          "type": "number",
                          "example": 403
                        },
                        "error": {
                          "type": "object",
                          "properties": {
                            "message": {
                              "type": "string",
                              "example": "Not Authenticated"
                            },
                            "status": {
                              "type": "string",
                              "example": "fail"
                            }
                          }
                        }
                      }
                    },
                    "ActionChange": {
                      "description": "This change applies to any alert type.",
                      "required": [
                        "type",
                        "removed",
                        "added"
                      ],
                      "type": "object",
                      "properties": {
                        "added": {
                          "type": "array",
                          "items": {
                            "type": "string",
                            "example": "task:4d65b0f8-8254-402c-8178-4a9f97afc9b2"
                          }
                        },
                        "removed": {
                          "type": "array",
                          "items": {
                            "type": "string",
                            "example": "task:4d65b0f8-8254-402c-8178-4a9f97afc9b2"
                          }
                        },
                        "type": {
                          "enum": [
                            "action_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "AssessmentIdsChange": {
                      "description": "This change applies to any alert type.",
                      "required": [
                        "type"
                      ],
                      "type": "object",
                      "properties": {
                        "added": {
                          "type": "array",
                          "items": {
                            "type": "string",
                            "example": "C&C Server"
                          }
                        },
                        "removed": {
                          "type": "array",
                          "items": {
                            "type": "string",
                            "example": "Active Mail Server"
                          }
                        },
                        "type": {
                          "enum": [
                            "assessment_ids_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "Assignee": {
                      "required": [
                        "id"
                      ],
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string",
                          "example": "uhash:Ds92mDX"
                        },
                        "name": {
                          "type": "string",
                          "example": "Marty"
                        }
                      }
                    },
                    "AssigneeChange": {
                      "required": [
                        "type"
                      ],
                      "type": "object",
                      "properties": {
                        "new": {
                          "type": "string",
                          "example": "uhash:AbHGsX"
                        },
                        "old": {
                          "type": "string",
                          "example": "uhash:Ds92mDX"
                        },
                        "type": {
                          "enum": [
                            "assignee_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "AssigneeChangeV2": {
                      "description": "This change applies to any alert type.",
                      "required": [
                        "type"
                      ],
                      "type": "object",
                      "properties": {
                        "new": {
                          "$ref": "#/definitions/Assignee"
                        },
                        "old": {
                          "$ref": "#/definitions/Assignee"
                        },
                        "type": {
                          "enum": [
                            "assignee_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "CommentChange": {
                      "description": "This change applies to any alert type.",
                      "required": [
                        "type",
                        "comment"
                      ],
                      "type": "object",
                      "properties": {
                        "comment": {
                          "type": "string"
                        },
                        "type": {
                          "enum": [
                            "comment_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "CredentialProperties": {
                      "description": "Filter on credential properties",
                      "type": "array",
                      "items": {
                        "description": "Credentials must include",
                        "enum": [
                          "Letter",
                          "Number",
                          "Symbol",
                          "UpperCase",
                          "LowerCase",
                          "MixedCase",
                          "AtLeast8Characters",
                          "AtLeast12Characters",
                          "AtLeast16Characters",
                          "AtLeast24Characters"
                        ],
                        "type": "string",
                        "example": "Letter"
                      },
                      "x-ms-visibility": "advanced"
                    },
                    "CustomOnwardActionsAddedChange": {
                      "description": "This change applies to any alert type.",
                      "type": "object",
                      "properties": {
                        "added_actions_taken": {
                          "$ref": "#/definitions/PlaybookAlertOnwardActionList"
                        },
                        "type": {
                          "enum": [
                            "onward_actions_added_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "CustomOnwardActionsRemovedChange": {
                      "description": "This change applies to any alert type.",
                      "type": "object",
                      "properties": {
                        "removed_actions_taken": {
                          "$ref": "#/definitions/PlaybookAlertOnwardActionList"
                        },
                        "type": {
                          "enum": [
                            "onward_actions_removed_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "CustomStatusChange": {
                      "description": "This change applies to any alert type.",
                      "required": [
                        "type",
                        "old",
                        "new",
                        "actions_taken"
                      ],
                      "type": "object",
                      "properties": {
                        "actions_taken": {
                          "$ref": "#/definitions/PlaybookAlertOnwardActionList"
                        },
                        "new": {
                          "type": "string",
                          "example": "InProgress"
                        },
                        "old": {
                          "type": "string",
                          "example": "New"
                        },
                        "type": {
                          "enum": [
                            "status_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "DescriptionChange": {
                      "description": "This change applies to any alert type.",
                      "required": [
                        "type"
                      ],
                      "type": "object",
                      "properties": {
                        "new": {
                          "type": "string"
                        },
                        "old": {
                          "type": "string"
                        },
                        "type": {
                          "enum": [
                            "description_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "EntitiesChange": {
                      "required": [
                        "type"
                      ],
                      "type": "object",
                      "properties": {
                        "added": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "removed": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "type": {
                          "enum": [
                            "entities_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "EntitiesChangeV2": {
                      "description": "This change applies to any alert type.",
                      "required": [
                        "type",
                        "removed",
                        "added"
                      ],
                      "type": "object",
                      "properties": {
                        "added": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/Entity"
                          }
                        },
                        "removed": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/Entity"
                          }
                        },
                        "type": {
                          "enum": [
                            "entities_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "Entity": {
                      "required": [
                        "id",
                        "type"
                      ],
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string",
                          "example": "ip:19.158.255.26"
                        },
                        "name": {
                          "type": "string",
                          "example": "19.158.255.26"
                        },
                        "type": {
                          "type": "string",
                          "example": "IpAddress"
                        }
                      }
                    },
                    "ExternalIdChange": {
                      "description": "This change applies to any alert type.",
                      "required": [
                        "type"
                      ],
                      "type": "object",
                      "properties": {
                        "new": {
                          "type": "string"
                        },
                        "old": {
                          "type": "string"
                        },
                        "type": {
                          "enum": [
                            "external_id_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "IdentityExposuresCompromisedHost": {
                      "type": "object",
                      "properties": {
                        "antivirus": {
                          "type": "array",
                          "items": {
                            "type": "string",
                            "example": "Windows Defender"
                          }
                        },
                        "computer_name": {
                          "type": "string",
                          "example": "DESKTOP-SNP2T8O"
                        },
                        "exfiltration_date": {
                          "type": "string",
                          "example": "2022-11-13T15:51:43Z"
                        },
                        "malware_file": {
                          "type": "string",
                          "example": "C:\\Users\\admin\\AppData\\Local\\Temp\\build.exe"
                        },
                        "os": {
                          "type": "string",
                          "example": "Windows 10 Pro [x64]"
                        },
                        "os_username": {
                          "type": "string",
                          "example": "admin"
                        },
                        "timezone": {
                          "type": "string",
                          "example": "UTC+03:00"
                        },
                        "uac": {
                          "type": "string",
                          "example": "AllowAll"
                        }
                      }
                    },
                    "IdentityExposuresDump": {
                      "type": "object",
                      "properties": {
                        "description": {
                          "type": "string",
                          "example": "This credential data was derived from stealer malware logs."
                        },
                        "name": {
                          "type": "string",
                          "example": "Stealer Malware Logs 2023-12-19"
                        }
                      }
                    },
                    "IdentityExposuresExposedSecret": {
                      "type": "object",
                      "properties": {
                        "details": {
                          "$ref": "#/definitions/IdentityExposuresPasswordDetails"
                        },
                        "effectively_clear": {
                          "type": "boolean"
                        },
                        "hashes": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/IdentityExposuresPasswordHash"
                          }
                        },
                        "type": {
                          "type": "string",
                          "example": "clear"
                        }
                      }
                    },
                    "IdentityExposuresInfrastructure": {
                      "type": "object",
                      "properties": {
                        "ip": {
                          "type": "string",
                          "example": "10.212.35.167"
                        }
                      }
                    },
                    "IdentityExposuresMalwareFamily": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string",
                          "example": "YuDlEm"
                        },
                        "name": {
                          "type": "string",
                          "example": "Vidar"
                        }
                      }
                    },
                    "IdentityExposuresPasswordDetails": {
                      "type": "object",
                      "properties": {
                        "clear_text_hint": {
                          "type": "string",
                          "example": "Qwe"
                        },
                        "clear_text_value": {
                          "type": "string",
                          "example": "Qwerty12345"
                        },
                        "properties": {
                          "type": "array",
                          "items": {
                            "enum": [
                              "Letter",
                              "Number",
                              "Symbol",
                              "UpperCase",
                              "LowerCase",
                              "MixedCase",
                              "AtLeast8Characters",
                              "AtLeast10Characters",
                              "AtLeast12Characters",
                              "AtLeast16Characters",
                              "AtLeast24Characters",
                              "Cookies",
                              "UnexpiredCookies",
                              "AuthorizationTechnology",
                              "MalwareOnly"
                            ],
                            "type": "string"
                          }
                        },
                        "rank": {
                          "enum": [
                            "Top100kCommonPasswords",
                            "TopMillionCommonPasswords"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "IdentityExposuresPasswordHash": {
                      "type": "object",
                      "properties": {
                        "algorithm": {
                          "type": "string",
                          "example": "SHA256"
                        },
                        "hash": {
                          "type": "string",
                          "example": "ae976b7cea782af2e98761dd2e0af8d20e4fe958a95580b848fecbc1fedb30b9"
                        },
                        "hash_prefix": {
                          "type": "string",
                          "example": "ae976b7cea782af2"
                        }
                      }
                    },
                    "IdentityExposuresResponse": {
                      "type": "object",
                      "properties": {
                        "panel_evidence_summary": {
                          "$ref": "#/definitions/IdentityExposuresSummaryPanel"
                        },
                        "panel_log": {
                          "$ref": "#/definitions/PlaybookAlertLogPanel"
                        },
                        "panel_log_v2": {
                          "$ref": "#/definitions/PlaybookAlertLogPanelV2"
                        },
                        "panel_status": {
                          "$ref": "#/definitions/IdentityExposuresStatusPanel"
                        },
                        "playbook_alert_id": {
                          "type": "string"
                        }
                      }
                    },
                    "IdentityExposuresStatusPanel": {
                      "description": "Data structure containing general information about the alert and it's associated entity.",
                      "type": "object",
                      "properties": {
                        "actions_taken": {
                          "$ref": "#/definitions/PlaybookAlertOnwardActionList"
                        },
                        "assignee_id": {
                          "$ref": "#/definitions/PlaybookAlertAssigneeId"
                        },
                        "assignee_name": {
                          "$ref": "#/definitions/PlaybookAlertAssigneeName"
                        },
                        "case_rule_id": {
                          "$ref": "#/definitions/PlaybookAlertCaseRuleId"
                        },
                        "case_rule_label": {
                          "$ref": "#/definitions/PlaybookAlertCaseRuleLabel"
                        },
                        "created": {
                          "$ref": "#/definitions/PlaybookAlertCreated"
                        },
                        "creator_id": {
                          "$ref": "#/definitions/PlaybookAlertCreatorId"
                        },
                        "creator_name": {
                          "$ref": "#/definitions/PlaybookAlertCreatorName"
                        },
                        "entity_id": {
                          "type": "string"
                        },
                        "entity_name": {
                          "type": "string"
                        },
                        "organisation_id": {
                          "$ref": "#/definitions/PlaybookAlertOrganisationId"
                        },
                        "organisation_name": {
                          "$ref": "#/definitions/PlaybookAlertOrganisationName"
                        },
                        "owner_id": {
                          "$ref": "#/definitions/PlaybookAlertOwnerId"
                        },
                        "owner_name": {
                          "$ref": "#/definitions/PlaybookAlertOwnerName"
                        },
                        "owner_organisation_details": {
                          "$ref": "#/definitions/PlaybookAlertOwnerOrganisationDetails"
                        },
                        "priority": {
                          "$ref": "#/definitions/PlaybookAlertPriority"
                        },
                        "reopen": {
                          "$ref": "#/definitions/PlaybookAlertReopenStrategy"
                        },
                        "status": {
                          "$ref": "#/definitions/PlaybookAlertStatus"
                        },
                        "targets": {
                          "description": "A list of domains associated with the exposure.",
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/ResolvedEntity"
                          }
                        },
                        "updated": {
                          "$ref": "#/definitions/PlaybookAlertUpdated"
                        }
                      }
                    },
                    "IdentityExposuresSummaryPanel": {
                      "type": "object",
                      "properties": {
                        "assessments": {
                          "description": "A list of assessments.",
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "criticality": {
                                "$ref": "#/definitions/PlaybookAlertPriority"
                              },
                              "name": {
                                "enum": [
                                  "Technology",
                                  "Malware",
                                  "Public Leak"
                                ],
                                "type": "string"
                              }
                            }
                          }
                        },
                        "authorization_url": {
                          "type": "string",
                          "example": "https://example.com/auth/login"
                        },
                        "compromised_host": {
                          "$ref": "#/definitions/IdentityExposuresCompromisedHost"
                        },
                        "dump": {
                          "$ref": "#/definitions/IdentityExposuresDump"
                        },
                        "exposed_secret": {
                          "$ref": "#/definitions/IdentityExposuresExposedSecret"
                        },
                        "infrastructure": {
                          "$ref": "#/definitions/IdentityExposuresInfrastructure"
                        },
                        "malware_family": {
                          "$ref": "#/definitions/IdentityExposuresMalwareFamily"
                        },
                        "subject": {
                          "type": "string",
                          "example": "user@example.com"
                        },
                        "technologies": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/IdentityExposuresTechnology"
                          }
                        }
                      }
                    },
                    "IdentityExposuresTechnology": {
                      "type": "object",
                      "properties": {
                        "category": {
                          "type": "string",
                          "example": "I50CbE"
                        },
                        "id": {
                          "type": "string",
                          "example": "I50CbE"
                        },
                        "name": {
                          "type": "string",
                          "example": "Amazon AWS"
                        }
                      }
                    },
                    "OnwardActionId": {
                      "description": "The id for the type of action taken. The possible values can be found in the response from metadata/common in actions_by_category field. The action ids possible can grow over time",
                      "type": "string"
                    },
                    "PlaybookAlertAssigneeId": {
                      "description": "ID of the assignee",
                      "type": "string",
                      "example": "uhash:40wXmPVONA"
                    },
                    "PlaybookAlertAssigneeName": {
                      "description": "Full name of the assignee",
                      "type": "string",
                      "example": "Marty McFly"
                    },
                    "PlaybookAlertAuthorId": {
                      "description": "Id of the author",
                      "type": "string",
                      "example": "uhash:40wXmPVONA"
                    },
                    "PlaybookAlertAuthorName": {
                      "description": "Full name of the author",
                      "type": "string",
                      "example": "Marty McFly"
                    },
                    "PlaybookAlertCaseRuleId": {
                      "description": "The Rule that created the Playbook Alert",
                      "type": "string"
                    },
                    "PlaybookAlertCaseRuleLabel": {
                      "description": "The Rule that created the Playbook Alert",
                      "enum": [
                        "Domain Abuse",
                        "Cyber Vulnerability"
                      ],
                      "type": "string"
                    },
                    "PlaybookAlertCreated": {
                      "format": "date-time",
                      "description": "The Creation time of the Playbook Alert",
                      "type": "string",
                      "example": "2023-07-21T19:32:28+02:00"
                    },
                    "PlaybookAlertCreatorId": {
                      "description": "Id of the Creator of the Playbook Alert",
                      "type": "string",
                      "example": "uhash:40wXmPVONA"
                    },
                    "PlaybookAlertCreatorName": {
                      "description": "Full name of the Creator of the Playbook Alert",
                      "type": "string",
                      "example": "Marty McFly"
                    },
                    "PlaybookAlertEnterpriseId": {
                      "description": "Id of the Enterprise",
                      "type": "string",
                      "example": "uhash:1HX2qIn4Zy"
                    },
                    "PlaybookAlertEnterpriseName": {
                      "description": "Name of the Enterprise",
                      "type": "string",
                      "example": "Recorded Future"
                    },
                    "PlaybookAlertLogPanel": {
                      "description": "Detailed view of manual or automated changes to the alert and underlying data. This version is deprecated and will be removed completely in future updates.",
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "action_priority": {
                            "$ref": "#/definitions/PlaybookAlertPriority"
                          },
                          "actor_id": {
                            "$ref": "#/definitions/PlaybookAlertAuthorId"
                          },
                          "actor_name": {
                            "$ref": "#/definitions/PlaybookAlertAuthorName"
                          },
                          "created": {
                            "format": "date-time",
                            "type": "string",
                            "example": "2023-07-21T19:32:28+02:00"
                          },
                          "id": {
                            "type": "string"
                          },
                          "message": {
                            "description": "Log message",
                            "type": "string",
                            "example": "Sample log message."
                          },
                          "modified": {
                            "format": "date-time",
                            "type": "string",
                            "example": "2023-07-21T19:32:28+02:00"
                          }
                        }
                      }
                    },
                    "PlaybookAlertLogPanelV2": {
                      "description": "Detailed view of manual or automated changes to the alert and underlying data.",
                      "type": "array",
                      "items": {
                        "required": [
                          "id",
                          "created"
                        ],
                        "type": "object",
                        "properties": {
                          "author_id": {
                            "$ref": "#/definitions/PlaybookAlertAuthorId"
                          },
                          "author_name": {
                            "$ref": "#/definitions/PlaybookAlertAuthorName"
                          },
                          "created": {
                            "format": "date-time",
                            "type": "string",
                            "example": "2023-07-21T19:32:28+02:00"
                          },
                          "id": {
                            "type": "string",
                            "example": "uuid:a3c4f8f0-8dd8-4940-8b0a-75a59764d068"
                          }
                        }
                      }
                    },
                    "PlaybookAlertOnwardActionList": {
                      "type": "array",
                      "items": {
                        "$ref": "#/definitions/OnwardActionId"
                      },
                      "example": [
                        "identity_novel_exposures.placed_in_risky_group",
                        "identity_novel_exposures.reviewed_incident_report",
                        "identity_novel_exposures.account_disabled_or_terminated",
                        "identity_novel_exposures.account_remediated",
                        "identity_novel_exposures.enforced_password_reset",
                        "identity_novel_exposures.other"
                      ]
                    },
                    "PlaybookAlertOrganisation": {
                      "type": "object",
                      "properties": {
                        "organisation_id": {
                          "$ref": "#/definitions/PlaybookAlertOrganisationId2"
                        },
                        "organisation_name": {
                          "$ref": "#/definitions/PlaybookAlertOrganisationName2"
                        }
                      }
                    },
                    "PlaybookAlertOrganisationId": {
                      "description": "Id of the Organisation",
                      "type": "string",
                      "example": "uhash:3HX3rIn4Kv"
                    },
                    "PlaybookAlertOrganisationId2": {
                      "description": "Id of the Organisation",
                      "type": "string",
                      "example": "uhash:3HX3rIn4Kv"
                    },
                    "PlaybookAlertOrganisationName": {
                      "description": "Name of the Organisation",
                      "type": "string",
                      "example": "Recorded Future"
                    },
                    "PlaybookAlertOrganisationName2": {
                      "description": "Name of the Organisation",
                      "type": "string",
                      "example": "Recorded Future"
                    },
                    "PlaybookAlertOwnerId": {
                      "description": "Id of the owner",
                      "type": "string",
                      "example": "uhash:3HX3rIn4Kv"
                    },
                    "PlaybookAlertOwnerName": {
                      "description": "Name of the owner",
                      "type": "string",
                      "example": "Recorded Future"
                    },
                    "PlaybookAlertOwnerOrganisationDetails": {
                      "type": "object",
                      "properties": {
                        "enterprise_id": {
                          "$ref": "#/definitions/PlaybookAlertEnterpriseId"
                        },
                        "enterprise_name": {
                          "$ref": "#/definitions/PlaybookAlertEnterpriseName"
                        },
                        "organisations": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/PlaybookAlertOrganisation"
                          }
                        }
                      }
                    },
                    "PlaybookAlertPriority": {
                      "description": "The priority of the Playbook Alert.",
                      "enum": [
                        "High",
                        "Moderate",
                        "Informational"
                      ],
                      "type": "string"
                    },
                    "PlaybookAlertReopenStrategy": {
                      "description": "Reopen strategies can only be applied to alerts with a status of Dismissed or Resolved.\nThe following combinations of status/reopen are allowed:\n* Dismissed -> Never * Resolved -> Never * Resolved -> SignificantUpdates ",
                      "enum": [
                        "Never",
                        "SignificantUpdates"
                      ],
                      "type": "string"
                    },
                    "PlaybookAlertStatus": {
                      "description": "The status of the Playbook Alert.",
                      "enum": [
                        "New",
                        "InProgress",
                        "Dismissed",
                        "Resolved"
                      ],
                      "type": "string",
                      "example": "Resolved"
                    },
                    "PlaybookAlertStatusResponse": {
                      "type": "object",
                      "properties": {
                        "status_code": {
                          "description": "Status describing the result of the request.",
                          "enum": [
                            "Ok",
                            "Error"
                          ],
                          "type": "string",
                          "example": "Ok"
                        },
                        "status_message": {
                          "description": "Text describing the status, suitable for displaying an error.",
                          "type": "string",
                          "example": "Ok"
                        }
                      }
                    },
                    "PlaybookAlertUpdated": {
                      "format": "date-time",
                      "description": "The Update time of the Playbook Alert",
                      "type": "string",
                      "example": "2023-07-21T19:32:28+02:00"
                    },
                    "PriorityChange": {
                      "description": "This change applies to any alert type.",
                      "required": [
                        "type",
                        "old",
                        "new"
                      ],
                      "type": "object",
                      "properties": {
                        "new": {
                          "type": "string",
                          "example": "High"
                        },
                        "old": {
                          "type": "string",
                          "example": "Moderate"
                        },
                        "type": {
                          "enum": [
                            "priority_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "RelatedEntitiesChange": {
                      "required": [
                        "type"
                      ],
                      "type": "object",
                      "properties": {
                        "added": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "removed": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "type": {
                          "enum": [
                            "related_entities_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "RelatedEntitiesChangeV2": {
                      "description": "This change applies to any alert type.",
                      "required": [
                        "type",
                        "removed",
                        "added"
                      ],
                      "type": "object",
                      "properties": {
                        "added": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/Entity"
                          }
                        },
                        "removed": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/Entity"
                          }
                        },
                        "type": {
                          "enum": [
                            "related_entities_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "ReopenStrategyChange": {
                      "description": "This change applies to any alert type.",
                      "required": [
                        "type"
                      ],
                      "type": "object",
                      "properties": {
                        "new": {
                          "type": "string",
                          "example": "Never"
                        },
                        "old": {
                          "type": "string",
                          "example": "SignificantUpdates"
                        },
                        "type": {
                          "enum": [
                            "reopen_strategy_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "ResolvedEntity": {
                      "required": [
                        "name"
                      ],
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "example": "Entity Name"
                        }
                      }
                    },
                    "StandardPanels": {
                      "description": "Request inclusion of detailed alert data, grouped into a set of panels. If left unset, all panels will be returned.",
                      "type": "array",
                      "items": {
                        "enum": [
                          "status",
                          "summary",
                          "log"
                        ],
                        "type": "string"
                      },
                      "example": [
                        "status",
                        "summary",
                        "log"
                      ]
                    },
                    "StatusChange": {
                      "description": "This change applies to any alert type.",
                      "required": [
                        "type",
                        "old",
                        "new"
                      ],
                      "type": "object",
                      "properties": {
                        "new": {
                          "type": "string",
                          "example": "InProgress"
                        },
                        "old": {
                          "type": "string",
                          "example": "New"
                        },
                        "type": {
                          "enum": [
                            "status_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "TitleChange": {
                      "description": "This change applies to any alert type.",
                      "required": [
                        "type"
                      ],
                      "type": "object",
                      "properties": {
                        "new": {
                          "type": "string"
                        },
                        "old": {
                          "type": "string"
                        },
                        "type": {
                          "enum": [
                            "title_change"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "AuthorizationService": {
                      "type": "object",
                      "properties": {
                        "domain": {
                          "type": "string"
                        },
                        "fqdn": {
                          "type": "string"
                        },
                        "protocols": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "technology": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/Technology"
                          }
                        },
                        "url": {
                          "type": "string"
                        }
                      }
                    },
                    "BreachMetadata": {
                      "type": "object",
                      "properties": {
                        "breached": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "description": {
                          "type": "string"
                        },
                        "domain": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "precision": {
                          "enum": [
                            "year",
                            "month",
                            "day"
                          ],
                          "type": "string"
                        },
                        "site_description": {
                          "type": "string"
                        },
                        "start": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "stop": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "type": {
                          "type": "string"
                        }
                      }
                    },
                    "BreachProperties": {
                      "type": "object",
                      "properties": {
                        "date": {
                          "format": "date-time",
                          "description": "YYYY-MM-DD (until today)",
                          "type": "string",
                          "example": "2022-02-08T11:32:37.951+01:00"
                        },
                        "name": {
                          "type": "string",
                          "example": "Cit0day"
                        }
                      },
                      "x-ms-visibility": "advanced"
                    },
                    "CleartextPasswordDetails": {
                      "type": "object",
                      "properties": {
                        "clear_text_hint": {
                          "description": "First two characters of the cleartext password",
                          "type": "string"
                        },
                        "clear_text_value": {
                          "description": "The password as clear text",
                          "type": "string"
                        },
                        "properties": {
                          "description": "Properties exhibited by the password",
                          "type": "array",
                          "items": {
                            "enum": [
                              "Letter",
                              "Number",
                              "Symbol",
                              "UpperCase",
                              "LowerCase",
                              "MixedCase",
                              "AtLeast8Characters",
                              "AtLeast10Characters",
                              "AtLeast12Characters",
                              "AtLeast16Characters",
                              "AtLeast24Characters",
                              "Cookies",
                              "UnexpiredCookies",
                              "AuthorizationTechnology",
                              "MalwareOnly"
                            ],
                            "type": "string"
                          }
                        },
                        "rank": {
                          "description": "A ranking of how common this password is",
                          "enum": [
                            "Top100kCommonPasswords",
                            "TopMillionCommonPasswords"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "Compromise": {
                      "type": "object",
                      "properties": {
                        "antivirus": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "computer_name": {
                          "type": "string"
                        },
                        "exfiltration_date": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "malware_file": {
                          "type": "string"
                        },
                        "os": {
                          "type": "string"
                        },
                        "os_username": {
                          "type": "string"
                        },
                        "timezone": {
                          "type": "string"
                        },
                        "uac": {
                          "type": "string"
                        }
                      }
                    },
                    "Cookie": {
                      "type": "object",
                      "properties": {
                        "dns": {
                          "type": "string"
                        },
                        "expiration": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "http": {
                          "type": "boolean"
                        },
                        "name": {
                          "type": "string"
                        },
                        "secure": {
                          "type": "boolean"
                        }
                      }
                    },
                    "CountryCodeMappingModel": {
                      "type": "object",
                      "properties": {
                        "alpha2Code": {
                          "type": "string"
                        },
                        "alpha3Code": {
                          "type": "string"
                        },
                        "countryCode": {
                          "type": "string"
                        },
                        "displayName": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        }
                      }
                    },
                    "Credentials": {
                      "type": "object",
                      "properties": {
                        "authorization_service": {
                          "type": "object",
                          "properties": {
                            "domain": {
                              "type": "string"
                            },
                            "fqdn": {
                              "type": "string"
                            },
                            "protocols": {
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "technology": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/Technology"
                              }
                            },
                            "url": {
                              "type": "string"
                            }
                          }
                        },
                        "compromise": {
                          "type": "object",
                          "properties": {
                            "exfiltration_date": {
                              "format": "date-time",
                              "type": "string"
                            }
                          }
                        },
                        "cookies": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/Cookie"
                          }
                        },
                        "dumps": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/DumpMetadata"
                          }
                        },
                        "exposed_secret": {
                          "$ref": "#/definitions/SecretDetails"
                        },
                        "first_downloaded": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "latest_downloaded": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "malware_family": {
                          "type": "object",
                          "properties": {
                            "id": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            }
                          }
                        },
                        "subject": {
                          "type": "string"
                        }
                      }
                    },
                    "CredentialsLookupRequest": {
                      "type": "object",
                      "properties": {
                        "filter": {
                          "type": "object",
                          "properties": {
                            "authorization_protocols": {
                              "description": "Only include credentials with these authorization protocols",
                              "type": "array",
                              "items": {
                                "type": "string"
                              },
                              "x-ms-visibility": "important"
                            },
                            "authorization_technologies": {
                              "description": "Only include credentials with these authorization technologies",
                              "type": "array",
                              "items": {
                                "type": "string"
                              },
                              "x-ms-visibility": "important"
                            },
                            "breach_properties": {
                              "description": "Only include credentials from breaches that exhibit these properties",
                              "type": "object",
                              "properties": {
                                "date": {
                                  "format": "date-time",
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                }
                              },
                              "x-ms-visibility": "important"
                            },
                            "dump_properties": {
                              "description": "Only include credentials from dumps that exhibit these properties",
                              "type": "object",
                              "properties": {
                                "date": {
                                  "format": "date-time",
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                }
                              },
                              "x-ms-visibility": "important"
                            },
                            "exfiltration_date_gte": {
                              "format": "date-time",
                              "description": "YYYY-MM-DD (until today)",
                              "type": "string",
                              "x-ms-visibility": "important"
                            },
                            "first_downloaded_gte": {
                              "format": "date-time",
                              "description": "YYYY-MM-DD (until today)",
                              "type": "string",
                              "x-ms-visibility": "important"
                            },
                            "latest_downloaded_gte": {
                              "format": "date-time",
                              "description": "YYYY-MM-DD (until today)",
                              "type": "string",
                              "x-ms-visibility": "important"
                            },
                            "malware_families": {
                              "description": "Only include credentials with these malware families",
                              "type": "array",
                              "items": {
                                "type": "string"
                              },
                              "x-ms-visibility": "important"
                            },
                            "properties": {
                              "description": "Only include breaches of passwords that exhibit these properties",
                              "type": "array",
                              "items": {
                                "enum": [
                                  "Letter",
                                  "Number",
                                  "Symbol",
                                  "UpperCase",
                                  "LowerCase",
                                  "MixedCase",
                                  "AtLeast8Characters",
                                  "AtLeast10Characters",
                                  "AtLeast12Characters",
                                  "AtLeast16Characters",
                                  "AtLeast24Characters",
                                  "Cookies",
                                  "UnexpiredCookies",
                                  "AuthorizationTechnology",
                                  "MalwareOnly"
                                ],
                                "type": "string"
                              },
                              "x-ms-visibility": "important"
                            },
                            "username_properties": {
                              "description": "Only include credentials with these username properties",
                              "type": "array",
                              "items": {
                                "enum": [
                                  "Email"
                                ],
                                "type": "string"
                              },
                              "x-ms-visibility": "important"
                            }
                          }
                        },
                        "organization_id": {
                          "type": "string",
                          "x-ms-visibility": "important"
                        },
                        "subjects": {
                          "title": "Emails",
                          "description": "List of email addresses to look up",
                          "type": "array",
                          "items": {
                            "description": "An email-address with exposed credentials",
                            "type": "string",
                            "x-ms-visibility": "important"
                          },
                          "x-ms-visibility": "important"
                        },
                        "subjects_login": {
                          "title": "Credential with auth domain",
                          "description": "List of breached domain users to look up",
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/DomainLogin"
                          },
                          "x-ms-visibility": "important"
                        },
                        "subjects_sha1": {
                          "title": "Hashed emails",
                          "description": "List of hashed email addresses to look up",
                          "type": "array",
                          "items": {
                            "description": "The SHA1 hash of an email-address with exposed credentials",
                            "type": "string",
                            "x-ms-visibility": "advanced"
                          },
                          "x-ms-visibility": "advanced"
                        }
                      }
                    },
                    "CredentialsSearchRequest": {
                      "type": "object",
                      "properties": {
                        "domain_types": {
                          "type": "array",
                          "items": {
                            "enum": [
                              "Authorization",
                              "Email"
                            ],
                            "type": "string"
                          }
                        },
                        "domains": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "filter": {
                          "type": "object",
                          "properties": {
                            "authorization_protocols": {
                              "description": "Only include credentials with these authorization protocols",
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "authorization_technologies": {
                              "description": "Only include credentials with these authorization technologies",
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "breach_properties": {
                              "description": "Only include credentials from breaches that exhibit these properties",
                              "type": "object",
                              "properties": {
                                "date": {
                                  "format": "date-time",
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                }
                              }
                            },
                            "dump_properties": {
                              "description": "Only include credentials from dumps that exhibit these properties",
                              "type": "object",
                              "properties": {
                                "date": {
                                  "format": "date-time",
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                }
                              }
                            },
                            "exfiltration_date_gte": {
                              "format": "date-time",
                              "description": "Only include exfiltrations this time onwards",
                              "type": "string"
                            },
                            "first_downloaded_gte": {
                              "format": "date-time",
                              "description": "Only include breaches this time onwards",
                              "type": "string"
                            },
                            "latest_downloaded_gte": {
                              "format": "date-time",
                              "description": "Only include breaches this time onwards",
                              "type": "string"
                            },
                            "malware_families": {
                              "description": "Only include credentials with these malware families",
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "properties": {
                              "description": "Only include breaches of passwords that exhibit these properties",
                              "type": "array",
                              "items": {
                                "enum": [
                                  "Letter",
                                  "Number",
                                  "Symbol",
                                  "UpperCase",
                                  "LowerCase",
                                  "MixedCase",
                                  "AtLeast8Characters",
                                  "AtLeast10Characters",
                                  "AtLeast12Characters",
                                  "AtLeast16Characters",
                                  "AtLeast24Characters",
                                  "Cookies",
                                  "UnexpiredCookies",
                                  "AuthorizationTechnology",
                                  "MalwareOnly"
                                ],
                                "type": "string"
                              }
                            },
                            "username_properties": {
                              "description": "Only include credentials with these username properties",
                              "type": "array",
                              "items": {
                                "enum": [
                                  "Email"
                                ],
                                "type": "string"
                              }
                            }
                          }
                        },
                        "limit": {
                          "type": "integer"
                        },
                        "offset": {
                          "type": "string"
                        },
                        "organization_id": {
                          "type": "string"
                        }
                      }
                    },
                    "DeprecatedCompromise": {
                      "type": "object",
                      "properties": {
                        "exfiltration_date": {
                          "format": "date-time",
                          "type": "string"
                        }
                      }
                    },
                    "DomainLogin": {
                      "type": "object",
                      "properties": {
                        "domain": {
                          "description": "domain.com",
                          "type": "string",
                          "x-ms-visibility": "important"
                        },
                        "login": {
                          "description": "Either input username or hash of username",
                          "type": "string",
                          "x-ms-visibility": "important"
                        },
                        "login_sha1": {
                          "description": "Either input username or hash of username",
                          "type": "string",
                          "x-ms-visibility": "important"
                        }
                      }
                    },
                    "DumpMetadata": {
                      "type": "object",
                      "properties": {
                        "breaches": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/BreachMetadata"
                          }
                        },
                        "compromise": {
                          "type": "object",
                          "properties": {
                            "antivirus": {
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "computer_name": {
                              "type": "string"
                            },
                            "exfiltration_date": {
                              "format": "date-time",
                              "type": "string"
                            },
                            "malware_file": {
                              "type": "string"
                            },
                            "os": {
                              "type": "string"
                            },
                            "os_username": {
                              "type": "string"
                            },
                            "timezone": {
                              "type": "string"
                            },
                            "uac": {
                              "type": "string"
                            }
                          }
                        },
                        "description": {
                          "type": "string"
                        },
                        "downloaded": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "infrastructure": {
                          "type": "object",
                          "properties": {
                            "ip": {
                              "type": "string"
                            }
                          }
                        },
                        "location": {
                          "type": "object",
                          "properties": {
                            "address": {
                              "type": "string"
                            },
                            "address1": {
                              "type": "string"
                            },
                            "address2": {
                              "type": "string"
                            },
                            "city": {
                              "type": "string"
                            },
                            "country": {
                              "type": "object",
                              "properties": {
                                "alpha2Code": {
                                  "type": "string"
                                },
                                "alpha3Code": {
                                  "type": "string"
                                },
                                "countryCode": {
                                  "type": "string"
                                },
                                "displayName": {
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                }
                              }
                            },
                            "postal_code": {
                              "type": "string"
                            },
                            "state": {
                              "type": "string"
                            },
                            "zip": {
                              "type": "string"
                            }
                          }
                        },
                        "name": {
                          "type": "string"
                        },
                        "type": {
                          "type": "string"
                        }
                      }
                    },
                    "DumpMetadataSearchRequest": {
                      "type": "object",
                      "properties": {
                        "limit": {
                          "type": "integer"
                        },
                        "names": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        }
                      }
                    },
                    "DumpProperties": {
                      "type": "object",
                      "properties": {
                        "date": {
                          "format": "date-time",
                          "description": "YYYY-MM-DD (until today)",
                          "type": "string",
                          "example": "2022-02-08T11:32:37.951+01:00"
                        },
                        "name": {
                          "type": "string",
                          "example": "XSS.is Dump 2021"
                        }
                      },
                      "x-ms-visibility": "advanced"
                    },
                    "IdentityDetails": {
                      "type": "object",
                      "properties": {
                        "subjects": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        }
                      }
                    },
                    "IdentityRequestFilter": {
                      "type": "object",
                      "properties": {
                        "authorization_protocols": {
                          "description": "Only include credentials with these authorization protocols",
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "authorization_technologies": {
                          "description": "Only include credentials with these authorization technologies",
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "breach_properties": {
                          "description": "Only include credentials from breaches that exhibit these properties",
                          "type": "object",
                          "properties": {
                            "date": {
                              "format": "date-time",
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            }
                          }
                        },
                        "dump_properties": {
                          "description": "Only include credentials from dumps that exhibit these properties",
                          "type": "object",
                          "properties": {
                            "date": {
                              "format": "date-time",
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            }
                          }
                        },
                        "exfiltration_date_gte": {
                          "format": "date-time",
                          "description": "Only include exfiltrations this time onwards",
                          "type": "string"
                        },
                        "first_downloaded_gte": {
                          "format": "date-time",
                          "description": "Only include breaches this time onwards",
                          "type": "string"
                        },
                        "latest_downloaded_gte": {
                          "format": "date-time",
                          "description": "Only include breaches this time onwards",
                          "type": "string"
                        },
                        "malware_families": {
                          "description": "Only include credentials with these malware families",
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "properties": {
                          "description": "Only include breaches of passwords that exhibit these properties",
                          "type": "array",
                          "items": {
                            "enum": [
                              "Letter",
                              "Number",
                              "Symbol",
                              "UpperCase",
                              "LowerCase",
                              "MixedCase",
                              "AtLeast8Characters",
                              "AtLeast10Characters",
                              "AtLeast12Characters",
                              "AtLeast16Characters",
                              "AtLeast24Characters",
                              "Cookies",
                              "UnexpiredCookies",
                              "AuthorizationTechnology",
                              "MalwareOnly"
                            ],
                            "type": "string"
                          }
                        },
                        "username_properties": {
                          "description": "Only include credentials with these username properties",
                          "type": "array",
                          "items": {
                            "enum": [
                              "Email"
                            ],
                            "type": "string"
                          }
                        }
                      }
                    },
                    "IncidentReportCredentials": {
                      "type": "object",
                      "properties": {
                        "authorization_domain": {
                          "type": "string"
                        },
                        "contains_active_cookies": {
                          "type": "boolean"
                        },
                        "contains_cookies": {
                          "type": "boolean"
                        },
                        "contains_high_risk_technologies": {
                          "type": "boolean"
                        },
                        "domain_category": {
                          "type": "string"
                        },
                        "domain_technology": {
                          "type": "string"
                        },
                        "email_or_login": {
                          "type": "string"
                        },
                        "password": {
                          "type": "string"
                        },
                        "password_sha1": {
                          "type": "string"
                        }
                      }
                    },
                    "IncidentReportDetails": {
                      "type": "object",
                      "properties": {
                        "antivirus": {
                          "type": "string"
                        },
                        "country": {
                          "type": "string"
                        },
                        "exfiltration_date": {
                          "type": "string"
                        },
                        "ip_address": {
                          "type": "string"
                        },
                        "malware_family": {
                          "type": "string"
                        },
                        "malware_file": {
                          "type": "string"
                        },
                        "os": {
                          "type": "string"
                        },
                        "os_username": {
                          "type": "string"
                        },
                        "postal_code": {
                          "type": "string"
                        },
                        "timezone": {
                          "type": "string"
                        },
                        "uac": {
                          "type": "string"
                        }
                      }
                    },
                    "IncidentReportRequest": {
                      "type": "object",
                      "properties": {
                        "include_details": {
                          "type": "boolean"
                        },
                        "limit": {
                          "type": "integer"
                        },
                        "offset": {
                          "type": "string"
                        },
                        "organization_id": {
                          "type": "string"
                        },
                        "source_malware_log": {
                          "type": "string"
                        }
                      }
                    },
                    "IncidentReportResponse": {
                      "type": "object",
                      "properties": {
                        "count": {
                          "type": "integer"
                        },
                        "credentials": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/IncidentReportCredentials"
                          }
                        },
                        "details": {
                          "type": "object",
                          "properties": {
                            "antivirus": {
                              "type": "string"
                            },
                            "country": {
                              "type": "string"
                            },
                            "exfiltration_date": {
                              "type": "string"
                            },
                            "ip_address": {
                              "type": "string"
                            },
                            "malware_family": {
                              "type": "string"
                            },
                            "malware_file": {
                              "type": "string"
                            },
                            "os": {
                              "type": "string"
                            },
                            "os_username": {
                              "type": "string"
                            },
                            "postal_code": {
                              "type": "string"
                            },
                            "timezone": {
                              "type": "string"
                            },
                            "uac": {
                              "type": "string"
                            }
                          }
                        },
                        "next_offset": {
                          "type": "string"
                        },
                        "total_count": {
                          "type": "integer"
                        }
                      }
                    },
                    "Infrastructure": {
                      "type": "object",
                      "properties": {
                        "ip": {
                          "type": "string"
                        }
                      }
                    },
                    "LeakedIdentity": {
                      "type": "object",
                      "properties": {
                        "count": {
                          "type": "integer"
                        },
                        "credentials": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/Credentials"
                          }
                        },
                        "identity": {
                          "$ref": "#/definitions/IdentityDetails"
                        }
                      }
                    },
                    "Location": {
                      "type": "object",
                      "properties": {
                        "address": {
                          "type": "string"
                        },
                        "address1": {
                          "type": "string"
                        },
                        "address2": {
                          "type": "string"
                        },
                        "city": {
                          "type": "string"
                        },
                        "country": {
                          "type": "object",
                          "properties": {
                            "alpha2Code": {
                              "type": "string"
                            },
                            "alpha3Code": {
                              "type": "string"
                            },
                            "countryCode": {
                              "type": "string"
                            },
                            "displayName": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            }
                          }
                        },
                        "postal_code": {
                          "type": "string"
                        },
                        "state": {
                          "type": "string"
                        },
                        "zip": {
                          "type": "string"
                        }
                      }
                    },
                    "LookupResponse": {
                      "type": "object",
                      "properties": {
                        "count": {
                          "type": "integer"
                        },
                        "identities": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/LeakedIdentity"
                          }
                        },
                        "next_offset": {
                          "type": "string"
                        }
                      }
                    },
                    "MalwareFamily": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        }
                      }
                    },
                    "MetadataDumpResponse": {
                      "type": "object",
                      "properties": {
                        "dumps": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/DumpMetadata"
                          }
                        }
                      }
                    },
                    "PasswordHash": {
                      "type": "object"
                    },
                    "PasswordLookupRequest": {
                      "type": "object",
                      "properties": {
                        "passwords": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/PasswordHash"
                          }
                        }
                      }
                    },
                    "PasswordLookupResponse": {
                      "type": "object",
                      "properties": {
                        "results": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/SinglePasswordLookupResult"
                          }
                        }
                      }
                    },
                    "SearchResponse": {
                      "type": "object",
                      "properties": {
                        "count": {
                          "type": "integer"
                        },
                        "count_relation": {
                          "type": "string"
                        },
                        "identities": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/SearchResponseIdentity"
                          }
                        },
                        "next_offset": {
                          "type": "string"
                        }
                      }
                    },
                    "SearchResponseIdentity": {
                      "type": "object"
                    },
                    "SecretDetails": {
                      "type": "object",
                      "properties": {
                        "details": {
                          "type": "object",
                          "properties": {
                            "clear_text_hint": {
                              "description": "First two characters of the cleartext password",
                              "type": "string"
                            },
                            "clear_text_value": {
                              "description": "The password as clear text",
                              "type": "string"
                            },
                            "properties": {
                              "description": "Properties exhibited by the password",
                              "type": "array",
                              "items": {
                                "enum": [
                                  "Letter",
                                  "Number",
                                  "Symbol",
                                  "UpperCase",
                                  "LowerCase",
                                  "MixedCase",
                                  "AtLeast8Characters",
                                  "AtLeast10Characters",
                                  "AtLeast12Characters",
                                  "AtLeast16Characters",
                                  "AtLeast24Characters",
                                  "Cookies",
                                  "UnexpiredCookies",
                                  "AuthorizationTechnology",
                                  "MalwareOnly"
                                ],
                                "type": "string"
                              }
                            },
                            "rank": {
                              "description": "A ranking of how common this password is",
                              "enum": [
                                "Top100kCommonPasswords",
                                "TopMillionCommonPasswords"
                              ],
                              "type": "string"
                            }
                          }
                        },
                        "effectively_clear": {
                          "type": "boolean"
                        },
                        "hashes": {
                          "description": "Known hashes for this secret",
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/PasswordHash"
                          }
                        },
                        "type": {
                          "type": "string"
                        }
                      }
                    },
                    "SinglePasswordLookupResult": {
                      "type": "object",
                      "properties": {
                        "exposure_status": {
                          "enum": [
                            "NeverExposed",
                            "Uncommon",
                            "Common"
                          ],
                          "type": "string"
                        },
                        "password": {
                          "$ref": "#/definitions/PasswordHash"
                        }
                      }
                    },
                    "Technology": {
                      "type": "object",
                      "properties": {
                        "category": {
                          "type": "string"
                        },
                        "id": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        }
                      }
                    }
                  },
                  "parameters": {
                    "PlaybookAlertId": {
                      "in": "path",
                      "name": "playbook_alert_id",
                      "description": "The unique id of a specific Playbook Alert",
                      "required": true,
                      "type": "string"
                    }
                  },
                  "securityDefinitions": {
                    "api_key": {
                      "type": "apiKey",
                      "in": "header",
                      "name": "X-RFToken"
                    }
                  },
                  "security": [
                    {
                      "api_key": "[variables('TemplateEmptyArray')]"
                    }
                  ],
                  "tags": "[variables('TemplateEmptyArray')]",
                  "x-ms-connector-metadata": [
                    {
                      "propertyName": "Website",
                      "propertyValue": "https://www.recordedfuture.com"
                    },
                    {
                      "propertyName": "Privacy Policy",
                      "propertyValue": "https://www.recordedfuture.com/privacy-policy/"
                    },
                    {
                      "propertyName": "Categories",
                      "propertyValue": "AI;Data"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('LogicAppsCustomConnector-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "LogicAppsCustomConnector",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId1')]",
        "contentKind": "LogicAppsCustomConnector",
        "displayName": "RFI-CustomConnector-0-2-0",
        "contentProductId": "[variables('_playbookcontentProductId1')]",
        "id": "[variables('_playbookcontentProductId1')]",
        "version": "[variables('playbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RFI-Playbook-Alert-Importer Playbook with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RFI-Playbook-Alert-Importer",
              "type": "string"
            },
            "RFICustomConnector": {
              "defaultValue": "RFI-CustomConnector-0-2-0",
              "metadata": {
                "description": "Required. Name of the logic app connector which performs Recorded Future Communication. Normally this should not change from RFI-CustomConnector-0-2-0."
              },
              "type": "string"
            },
            "entra_id_security_group_id": {
              "defaultValue": "Insert Entra ID security group or leave empty",
              "metadata": {
                "description": "Optional. The ID of the Entra ID security group where we should put users who have leaked credentials. If left empty, a user will not be placed in an Entra ID security group."
              },
              "type": "String"
            },
            "confirm_user_as_risky": {
              "metadata": {
                "description": "Optional. If specified, will confirm user as risky. Requires Microsoft Entra ID P1 or P2 license"
              },
              "defaultValue": false,
              "type": "Bool"
            },
            "entra_id_domain": {
              "defaultValue": "",
              "metadata": {
                "description": "Optional. If specified, will replace the domain of any leaked credentials with this value."
              },
              "type": "String"
            }
          },
          "variables": {
            "AzureadConnectionName": "[[concat('Azuread-', parameters('PlaybookName'))]",
            "AzureadipConnectionName": "[[concat('Azureadip-', parameters('PlaybookName'))]",
            "Rfi-Customconnector-0-2-0ConnectionName": "RFI-CustomConnector-0-2-0",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('RFICustomConnector'))]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuread')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureadip')]",
            "_connection-4": "[[variables('connection-4')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('Rfi-Customconnector-0-2-0ConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureadConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureadipConnectionName'))]"
              ],
              "identity": {
                "type": "SystemAssigned"
              },
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "RFI-Playbook-Alert-Importer",
                "hidden-SentinelTemplateVersion": "1.1",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "name": "[[parameters('PlaybookName')]",
              "properties": {
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "For_each": {
                      "actions": {
                        "Add_user_to_Entra_ID_security_group": {
                          "type": "If",
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "equals": [
                                    "@parameters('entra_id_security_group_id')",
                                    ""
                                  ]
                                }
                              }
                            ]
                          },
                          "actions": {
                            "Add_risky_user_to_Active_Directory_security_group_for_users_at_risk": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuread']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "body": {
                                  "@@odata.id": "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']"
                                },
                                "path": "/v1.0/groups/@{encodeURIComponent(parameters('entra_id_security_group_id'))}/members/$ref"
                              }
                            }
                          },
                          "runAfter": {
                            "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                              "Succeeded"
                            ],
                            "Workaround_-_Current_Time": [
                              "Succeeded"
                            ]
                          }
                        },
                        "Compute_user_principal_name": {
                          "description": "Replace the domain of the leaked identity with entra_id_domain, if the entra_id_domain parameter is provided.",
                          "inputs": "@if(\n  and(\n    not(\n      equals(parameters('entra_id_domain'), null)\n    ),\n    not(\n      equals(parameters('entra_id_domain'), '')\n    )\n  ),\n  concat(split(item()?['identity'], '@')[0], '@', parameters('entra_id_domain')),\n  item()?['identity']\n)",
                          "type": "Compose"
                        },
                        "Confirm_user_as_risky_(requires_P1_or_P2_license)": {
                          "type": "If",
                          "expression": {
                            "and": [
                              {
                                "equals": [
                                  "@parameters('confirm_user_as_risky')",
                                  true
                                ]
                              }
                            ]
                          },
                          "actions": {
                            "Confirm_a_risky_user_as_compromised": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azureadip']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "body": {
                                  "userIds": [
                                    "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']"
                                  ]
                                },
                                "path": "/beta/riskyUsers/confirmCompromised"
                              }
                            }
                          },
                          "runAfter": {
                            "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                              "Succeeded"
                            ],
                            "Workaround_-_Current_Time": [
                              "Succeeded"
                            ]
                          }
                        },
                        "Get_User_-_Check_if_the_user_exists_in_Active_Directory": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuread']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/v1.0/users/@{encodeURIComponent(outputs('Compute_user_principal_name'))}"
                          },
                          "runAfter": {
                            "Compute_user_principal_name": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Playbook_Alerts_-_Update_Playbook_Alert": {
                          "inputs": {
                            "body": {
                              "alert_id": "@item()?['alert_id']",
                              "log_entry": "Actions taken in Entra ID integration: \n- User found. \n@{if(not(equals(parameters('entra_id_security_group_id'),'')), string('- Placed into security group.'), '- Did not place into security group')} \n@{if(equals(parameters('confirm_user_as_risky'),true), string('- Confirmed as risky user if present in that list.'), '- Did not confirm user as risky')}",
                              "status": "Resolved",
                              "added_actions_taken": [
                                "@if(or(not(equals(parameters('entra_id_security_group_id'), '')),parameters('confirm_user_as_risky'), false),'identity_novel_exposures.placed_in_risky_group','identity_novel_exposures.other')"
                              ]
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['rfi-customconnector-0-2-0']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/playbook-alerts/update"
                          },
                          "runAfter": {
                            "Add_user_to_Entra_ID_security_group": [
                              "Succeeded",
                              "Skipped"
                            ],
                            "Confirm_user_as_risky_(requires_P1_or_P2_license)": [
                              "Succeeded",
                              "Failed",
                              "Skipped"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Playbook_Alerts_-_Update_Playbook_Alert_-_If_user_not_found": {
                          "inputs": {
                            "body": {
                              "alert_id": "@item()?['alert_id']",
                              "log_entry": "User not found. Might be false positive. Dismissed",
                              "status": "Dismissed"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['rfi-customconnector-0-2-0']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/playbook-alerts/update"
                          },
                          "runAfter": {
                            "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                              "Failed"
                            ],
                            "Workaround_-_Current_Time": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Workaround_-_Current_Time": {
                          "description": "This step is only here to handle a specific case where the user is not found but we have a alert id. Without this, the whole run would be seen as \"Failed\" even though it did everything correct",
                          "inputs": "[variables('TemplateEmptyObject')]",
                          "kind": "CurrentTime",
                          "runAfter": {
                            "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                              "Succeeded",
                              "Failed"
                            ]
                          },
                          "type": "Expression"
                        }
                      },
                      "foreach": "@body('Playbook_Alerts_-_Search_for_novel_identity_exposures')?['pba_items']",
                      "runAfter": {
                        "Playbook_Alerts_-_Search_for_novel_identity_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Playbook_Alerts_-_Search_for_novel_identity_exposures": {
                      "inputs": {
                        "body": {
                          "lookback_days": 7,
                          "priorities": [
                            "High",
                            "Moderate"
                          ]
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['rfi-customconnector-0-2-0']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/playbook-alerts/search"
                      },
                      "type": "ApiConnection"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "entra_id_domain": {
                      "defaultValue": "[[parameters('entra_id_domain')]",
                      "type": "String"
                    },
                    "entra_id_security_group_id": {
                      "defaultValue": "[[parameters('entra_id_security_group_id')]",
                      "type": "String"
                    },
                    "confirm_user_as_risky": {
                      "defaultValue": "[[parameters('confirm_user_as_risky')]",
                      "type": "Bool"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "evaluatedRecurrence": {
                        "frequency": "Minute",
                        "interval": 15
                      },
                      "recurrence": {
                        "frequency": "Minute",
                        "interval": 15
                      },
                      "type": "Recurrence"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuread": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureadConnectionName'))]",
                        "connectionName": "[[variables('AzureadConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuread')]"
                      },
                      "azureadip": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureadipConnectionName'))]",
                        "connectionName": "[[variables('AzureadipConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureadip')]"
                      },
                      "rfi-customconnector-0-2-0": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Rfi-Customconnector-0-2-0ConnectionName'))]",
                        "connectionName": "[[variables('Rfi-Customconnector-0-2-0ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('RFICustomConnector'))]"
                      }
                    }
                  }
                },
                "provisioningState": "Succeeded",
                "state": "Disabled"
              },
              "type": "Microsoft.Logic/workflows"
            },
            {
              "apiVersion": "2016-06-01",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[variables('Rfi-Customconnector-0-2-0ConnectionName')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('Rfi-Customconnector-0-2-0ConnectionName')]"
              },
              "type": "Microsoft.Web/connections"
            },
            {
              "apiVersion": "2016-06-01",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[variables('AzureadConnectionName')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-3')]"
                },
                "displayName": "[[variables('AzureadConnectionName')]"
              },
              "type": "Microsoft.Web/connections"
            },
            {
              "apiVersion": "2016-06-01",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[variables('AzureadipConnectionName')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-4')]"
                },
                "displayName": "[[variables('AzureadipConnectionName')]"
              },
              "type": "Microsoft.Web/connections"
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_RFI-CustomConnector-0-2-0')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "RFI-Playbook-Alert-Importer",
            "description": "This playbook fetches identity compromises from Recorded Future, places users in a security group and confirms them as 'risky users' in Entra ID.",
            "prerequisites": [
              "First install the RFI-CustomConnector-0-2-0 custom connector",
              "To use the Recorded Future Identity connector, you will need a valid API token from Recorded Future as described in the [documentation](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Recorded%20Future%20Identity/Playbooks/readme.md#how-to-obtain-recorded-future-api-token)"
            ],
            "postDeployment": [
              "After deployment, open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2025-04-29T00:00:00Z",
            "tags": [
              "Identity protection"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "Initial version",
                "notes": [
                  "Initial version"
                ]
              },
              {
                "version": "1.1",
                "title": "Improved stability",
                "notes": [
                  "Removed Get Risky User action due to instability"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId2')]",
        "contentKind": "Playbook",
        "displayName": "RFI-Playbook-Alert-Importer",
        "contentProductId": "[variables('_playbookcontentProductId2')]",
        "id": "[variables('_playbookcontentProductId2')]",
        "version": "[variables('playbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RFI-Playbook-Alert-Importer-LAW Playbook with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RFI-Playbook-Alert-Importer-LAW",
              "type": "string"
            },
            "RFICustomConnector": {
              "defaultValue": "RFI-CustomConnector-0-2-0",
              "metadata": {
                "description": "Required. Name of the logic app connector which performs Recorded Future Communication. Normally this should not change from RFI-CustomConnector-0-2-0."
              },
              "type": "string"
            },
            "entra_id_security_group_id": {
              "defaultValue": "Insert Entra ID security group or leave empty",
              "metadata": {
                "description": "Optional. The ID of the Entra ID security group where we should put users who have leaked credentials. If left empty, a user will not be placed in an Entra ID security group."
              },
              "type": "String"
            },
            "confirm_user_as_risky": {
              "metadata": {
                "description": "Optional. If specified, will confirm user as risky. Requires Microsoft Entra ID P1 or P2 license"
              },
              "defaultValue": false,
              "type": "Bool"
            },
            "entra_id_domain": {
              "defaultValue": "",
              "metadata": {
                "description": "Optional. If specified, will replace the domain of any leaked credentials with this value."
              },
              "type": "String"
            },
            "save_to_log_analytics_workspace": {
              "defaultValue": true,
              "metadata": {
                "description": "Required. If true, will save each Playbook Alert that matches an existing user to a Log Analytics Workspace table."
              },
              "type": "Bool"
            },
            "playbook_alert_log_analytics_custom_log_name": {
              "defaultValue": "RecordedFutureIdentity_PlaybookAlertResults_CL",
              "metadata": {
                "description": "Required. The name of the Log Analytics Workspace table where Playbook Alerts should be saved."
              },
              "type": "String"
            }
          },
          "variables": {
            "AzureadConnectionName": "[[concat('Azuread-', parameters('PlaybookName'))]",
            "AzureadipConnectionName": "[[concat('Azureadip-', parameters('PlaybookName'))]",
            "AzureloganalyticsdatacollectorConnectionName": "[[concat('Azureloganalyticsdatacollector-', parameters('PlaybookName'))]",
            "Rfi-Customconnector-0-2-0ConnectionName": "RFI-CustomConnector-0-2-0",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('RFICustomConnector'))]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuread')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureadip')]",
            "_connection-4": "[[variables('connection-4')]",
            "connection-5": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureloganalyticsdatacollector')]",
            "_connection-5": "[[variables('connection-5')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('Rfi-Customconnector-0-2-0ConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureadConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureadipConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]"
              ],
              "identity": {
                "type": "SystemAssigned"
              },
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "RFI-Playbook-Alert-Importer-LAW",
                "hidden-SentinelTemplateVersion": "1.1",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "name": "[[parameters('PlaybookName')]",
              "properties": {
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "For_each": {
                      "actions": {
                        "Add_user_to_Entra_ID_security_group": {
                          "type": "If",
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "equals": [
                                    "@parameters('entra_id_security_group_id')",
                                    ""
                                  ]
                                }
                              }
                            ]
                          },
                          "actions": {
                            "Add_risky_user_to_Active_Directory_security_group_for_users_at_risk": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuread']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "body": {
                                  "@@odata.id": "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']"
                                },
                                "path": "/v1.0/groups/@{encodeURIComponent(parameters('entra_id_security_group_id'))}/members/$ref"
                              }
                            }
                          },
                          "runAfter": {
                            "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                              "Succeeded"
                            ],
                            "Workaround_-_Current_Time": [
                              "Succeeded"
                            ]
                          }
                        },
                        "Compute_user_principal_name": {
                          "description": "Replace the domain of the leaked identity with entra_id_domain, if the entra_id_domain parameter is provided.",
                          "inputs": "@if(\n  and(\n    not(\n      equals(parameters('entra_id_domain'), null)\n    ),\n    not(\n      equals(parameters('entra_id_domain'), '')\n    )\n  ),\n  concat(split(item()?['identity'], '@')[0], '@', parameters('entra_id_domain')),\n  item()?['identity']\n)",
                          "type": "Compose"
                        },
                        "Confirm_user_as_risky_(requires_P1_or_P2_license)": {
                          "type": "If",
                          "expression": {
                            "and": [
                              {
                                "equals": [
                                  "@parameters('confirm_user_as_risky')",
                                  true
                                ]
                              }
                            ]
                          },
                          "actions": {
                            "Confirm_a_risky_user_as_compromised": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azureadip']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "body": {
                                  "userIds": [
                                    "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']"
                                  ]
                                },
                                "path": "/beta/riskyUsers/confirmCompromised"
                              }
                            }
                          },
                          "runAfter": {
                            "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                              "Succeeded"
                            ],
                            "Workaround_-_Current_Time": [
                              "Succeeded"
                            ]
                          }
                        },
                        "Get_User_-_Check_if_the_user_exists_in_Active_Directory": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuread']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/v1.0/users/@{encodeURIComponent(outputs('Compute_user_principal_name'))}"
                          },
                          "runAfter": {
                            "Compute_user_principal_name": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "If_save_to_LAW": {
                          "actions": {
                            "Playbook_Alerts_-_Detailed_Identity_Novel_Exposures_alert_data": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['rfi-customconnector-0-2-0']['connectionId']"
                                  }
                                },
                                "method": "get",
                                "path": "/playbook-alerts/@{encodeURIComponent(item()?['alert_id'])}",
                                "queries": {
                                  "return_html": false
                                }
                              }
                            },
                            "Playbook_Alerts_-_Update_Playbook_Alert_-_Saved_to_LAW": {
                              "runAfter": {
                                "Send_Data_-_Save_Playbook_alert_to_LogAnalytics_Custom_Log": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['rfi-customconnector-0-2-0']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "body": {
                                  "alert_id": "@item()?['alert_id']",
                                  "log_entry": "Actions taken in Entra ID integration: \n- User found. \n@{if(not(equals(parameters('entra_id_security_group_id'),'')), string('- Placed into security group.'), '- Did not place into security group')} \n@{if(equals(parameters('confirm_user_as_risky'),true), string('- Confirmed as risky user if present in that list.'), '- Did not confirm user as risky')}\n@{if(equals(parameters('save_to_log_analytics_workspace'),true), string('- Saved to log analytics workspace'), '- Did not save to log analytics workspace')}",
                                  "status": "Resolved",
                                  "added_actions_taken": [
                                    "@if(or(not(equals(parameters('entra_id_security_group_id'), '')),parameters('confirm_user_as_risky'), false),'identity_novel_exposures.placed_in_risky_group','identity_novel_exposures.other')"
                                  ]
                                },
                                "path": "/playbook-alerts/update"
                              }
                            },
                            "Send_Data_-_Save_Playbook_alert_to_LogAnalytics_Custom_Log": {
                              "runAfter": {
                                "Playbook_Alerts_-_Detailed_Identity_Novel_Exposures_alert_data": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "body": "@string(body('Playbook_Alerts_-_Detailed_Identity_Novel_Exposures_alert_data')?['result'])",
                                "headers": {
                                  "Log-Type": "@parameters('playbook_alert_log_analytics_custom_log_name')"
                                },
                                "path": "/api/logs"
                              }
                            }
                          },
                          "runAfter": {
                            "Add_user_to_Entra_ID_security_group": [
                              "Succeeded",
                              "Skipped"
                            ],
                            "Confirm_user_as_risky_(requires_P1_or_P2_license)": [
                              "Succeeded",
                              "Failed",
                              "Skipped"
                            ]
                          },
                          "else": {
                            "actions": {
                              "Playbook_Alerts_-_Update_Playbook_Alert-_If_user_found": {
                                "type": "ApiConnection",
                                "inputs": {
                                  "host": {
                                    "connection": {
                                      "name": "@parameters('$connections')['rfi-customconnector-0-2-0']['connectionId']"
                                    }
                                  },
                                  "method": "put",
                                  "body": {
                                    "alert_id": "@item()?['alert_id']",
                                    "log_entry": "Actions taken in Entra ID integration: \n- User found. \n@{if(not(equals(parameters('entra_id_security_group_id'),'')), string('- Placed into security group.'), '- Did not place into security group')} \n@{if(equals(parameters('confirm_user_as_risky'),true), string('- Confirmed as risky user if present in that list.'), '- Did not confirm user as risky')}\n@{if(equals(parameters('save_to_log_analytics_workspace'),true), string('- Saved to log analytics workspace'), '- Did not save to log analytics workspace')}",
                                    "status": "Resolved",
                                    "added_actions_taken": [
                                      "@if(or(not(equals(parameters('entra_id_security_group_id'), '')),parameters('confirm_user_as_risky'), false),'identity_novel_exposures.placed_in_risky_group','identity_novel_exposures.other')"
                                    ]
                                  },
                                  "path": "/playbook-alerts/update"
                                }
                              }
                            }
                          },
                          "expression": {
                            "or": [
                              {
                                "equals": [
                                  "@parameters('save_to_log_analytics_workspace')",
                                  true
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Playbook_Alerts_-_Update_Playbook_Alert_-_If_user_not_found": {
                          "inputs": {
                            "body": {
                              "alert_id": "@item()?['alert_id']",
                              "log_entry": "User not found. Might be false positive. Dismissed",
                              "status": "Dismissed"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['rfi-customconnector-0-2-0']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/playbook-alerts/update"
                          },
                          "runAfter": {
                            "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                              "Failed"
                            ],
                            "Workaround_-_Current_Time": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Workaround_-_Current_Time": {
                          "description": "This step is only here to handle a specific case where the user is not found but we have a alert id. Without this, the whole run would be seen as \"Failed\" even though it did everything correct",
                          "inputs": "[variables('TemplateEmptyObject')]",
                          "kind": "CurrentTime",
                          "runAfter": {
                            "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                              "Succeeded",
                              "Failed"
                            ]
                          },
                          "type": "Expression"
                        }
                      },
                      "foreach": "@body('Playbook_Alerts_-_Search_for_novel_identity_exposures')?['pba_items']",
                      "runAfter": {
                        "Playbook_Alerts_-_Search_for_novel_identity_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Playbook_Alerts_-_Search_for_novel_identity_exposures": {
                      "inputs": {
                        "body": {
                          "lookback_days": 7,
                          "priorities": [
                            "High",
                            "Moderate"
                          ]
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['rfi-customconnector-0-2-0']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/playbook-alerts/search"
                      },
                      "type": "ApiConnection"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "entra_id_domain": {
                      "defaultValue": "[[parameters('entra_id_domain')]",
                      "type": "String"
                    },
                    "entra_id_security_group_id": {
                      "defaultValue": "[[parameters('entra_id_security_group_id')]",
                      "type": "String"
                    },
                    "confirm_user_as_risky": {
                      "defaultValue": "[[parameters('confirm_user_as_risky')]",
                      "type": "Bool"
                    },
                    "playbook_alert_log_analytics_custom_log_name": {
                      "defaultValue": "[[parameters('playbook_alert_log_analytics_custom_log_name')]",
                      "type": "String"
                    },
                    "save_to_log_analytics_workspace": {
                      "defaultValue": "[[parameters('save_to_log_analytics_workspace')]",
                      "type": "Bool"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "evaluatedRecurrence": {
                        "frequency": "Minute",
                        "interval": 15
                      },
                      "recurrence": {
                        "frequency": "Minute",
                        "interval": 15
                      },
                      "type": "Recurrence"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuread": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureadConnectionName'))]",
                        "connectionName": "[[variables('AzureadConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuread')]"
                      },
                      "azureadip": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureadipConnectionName'))]",
                        "connectionName": "[[variables('AzureadipConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureadip')]"
                      },
                      "azureloganalyticsdatacollector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]",
                        "connectionName": "[[variables('AzureloganalyticsdatacollectorConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureloganalyticsdatacollector')]"
                      },
                      "rfi-customconnector-0-2-0": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Rfi-Customconnector-0-2-0ConnectionName'))]",
                        "connectionName": "[[variables('Rfi-Customconnector-0-2-0ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('RFICustomConnector'))]"
                      }
                    }
                  }
                },
                "provisioningState": "Succeeded",
                "state": "Disabled"
              },
              "type": "Microsoft.Logic/workflows"
            },
            {
              "apiVersion": "2016-06-01",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[variables('Rfi-Customconnector-0-2-0ConnectionName')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('Rfi-Customconnector-0-2-0ConnectionName')]"
              },
              "type": "Microsoft.Web/connections"
            },
            {
              "apiVersion": "2016-06-01",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[variables('AzureadConnectionName')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-3')]"
                },
                "displayName": "[[variables('AzureadConnectionName')]"
              },
              "type": "Microsoft.Web/connections"
            },
            {
              "apiVersion": "2016-06-01",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[variables('AzureadipConnectionName')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-4')]"
                },
                "displayName": "[[variables('AzureadipConnectionName')]"
              },
              "type": "Microsoft.Web/connections"
            },
            {
              "apiVersion": "2016-06-01",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[variables('AzureloganalyticsdatacollectorConnectionName')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-5')]"
                },
                "displayName": "[[variables('AzureloganalyticsdatacollectorConnectionName')]"
              },
              "type": "Microsoft.Web/connections"
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_RFI-CustomConnector-0-2-0')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "RFI-Playbook-Alert-Importer-LAW",
            "description": "This playbook fetches identity compromises from Recorded Future, places users in a security group and confirms them as 'risky users' in Entra ID.",
            "prerequisites": [
              "First install the RFI-CustomConnector-0-2-0 custom connector",
              "To use the Recorded Future Identity connector, you will need a valid API token from Recorded Future as described in the [documentation](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Recorded%20Future%20Identity/Playbooks/readme.md#how-to-obtain-recorded-future-api-token)"
            ],
            "postDeployment": [
              "After deployment, open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2025-04-29T00:00:00Z",
            "tags": [
              "Identity protection"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "Initial version",
                "notes": [
                  "Initial version"
                ]
              },
              {
                "version": "1.1",
                "title": "Improved stability",
                "notes": [
                  "Removed Get Risky User action due to instability"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId3')]",
        "contentKind": "Playbook",
        "displayName": "RFI-Playbook-Alert-Importer-LAW",
        "contentProductId": "[variables('_playbookcontentProductId3')]",
        "id": "[variables('_playbookcontentProductId3')]",
        "version": "[variables('playbookVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RFI-Playbook-Alert-Importer-LAW-Sentinel Playbook with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RFI-Playbook-Alert-Importer-LAW-Sentinel",
              "type": "string"
            },
            "RFICustomConnector": {
              "defaultValue": "RFI-CustomConnector-0-2-0",
              "metadata": {
                "description": "Required. Name of the logic app connector which performs Recorded Future Communication. Normally this should not change from RFI-CustomConnector-0-2-0."
              },
              "type": "string"
            },
            "entra_id_security_group_id": {
              "defaultValue": "Insert Entra ID security group or leave empty",
              "metadata": {
                "description": "Optional. The ID of the Entra ID security group where we should put users who have leaked credentials. If left empty, a user will not be placed in an Entra ID security group."
              },
              "type": "String"
            },
            "confirm_user_as_risky": {
              "metadata": {
                "description": "Optional. If specified, will confirm user as risky. Requires Microsoft Entra ID P1 or P2 license"
              },
              "defaultValue": false,
              "type": "Bool"
            },
            "entra_id_domain": {
              "defaultValue": "",
              "metadata": {
                "description": "Optional. If specified, will replace the domain of any leaked credentials with this value."
              },
              "type": "String"
            },
            "create_incident": {
              "defaultValue": true,
              "metadata": {
                "description": "Required. If true, will create a Microsoft Sentinel Incident for each legitimate Playbook Alert."
              },
              "type": "Bool"
            },
            "sentinel_workspace_name": {
              "defaultValue": "",
              "metadata": {
                "description": "Microsoft Sentinel Workspace name"
              },
              "type": "string"
            },
            "save_to_log_analytics_workspace": {
              "defaultValue": true,
              "metadata": {
                "description": "Required. If true, will save each legitimate Playbook Alert to a Log Analytics Workspace table."
              },
              "type": "Bool"
            },
            "playbook_alert_log_analytics_custom_log_name": {
              "defaultValue": "RecordedFutureIdentity_PlaybookAlertResults_CL",
              "metadata": {
                "description": "Required. The name of the Log Analytics Workspace table where Playbook Alerts should be saved."
              },
              "type": "String"
            }
          },
          "variables": {
            "AzureadConnectionName": "[[concat('Azuread-', parameters('PlaybookName'))]",
            "AzureadipConnectionName": "[[concat('Azureadip-', parameters('PlaybookName'))]",
            "AzureloganalyticsdatacollectorConnectionName": "[[concat('Azureloganalyticsdatacollector-', parameters('PlaybookName'))]",
            "AzuresentinelConnectionName": "[[concat('Azuresentinel-', parameters('PlaybookName'))]",
            "Rfi-Customconnector-0-2-0ConnectionName": "RFI-CustomConnector-0-2-0",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuread')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureadip')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-4": "[[variables('connection-4')]",
            "connection-5": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureloganalyticsdatacollector')]",
            "_connection-5": "[[variables('connection-5')]",
            "connection-6": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('RFICustomConnector'))]",
            "_connection-6": "[[variables('connection-6')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureadConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureadipConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzuresentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('Rfi-Customconnector-0-2-0ConnectionName'))]"
              ],
              "identity": {
                "type": "SystemAssigned"
              },
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "RFI-Playbook-Alert-Importer-LAW-Sentinel",
                "hidden-SentinelTemplateVersion": "1.1",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "name": "[[parameters('PlaybookName')]",
              "properties": {
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "For_each": {
                      "actions": {
                        "Add_user_to_Entra_ID_security_group": {
                          "type": "If",
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "equals": [
                                    "@parameters('entra_id_security_group_id')",
                                    ""
                                  ]
                                }
                              }
                            ]
                          },
                          "actions": {
                            "Add_risky_user_to_Active_Directory_security_group_for_users_at_risk": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuread']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "body": {
                                  "@@odata.id": "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']"
                                },
                                "path": "/v1.0/groups/@{encodeURIComponent(parameters('entra_id_security_group_id'))}/members/$ref"
                              }
                            }
                          },
                          "runAfter": {
                            "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                              "Succeeded"
                            ],
                            "Workaround_-_Current_Time": [
                              "Succeeded"
                            ]
                          }
                        },
                        "Compute_user_principal_name": {
                          "description": "Replace the domain of the leaked identity with entra_id_domain, if the entra_id_domain parameter is provided.",
                          "inputs": "@if(\n  and(\n    not(\n      equals(parameters('entra_id_domain'), null)\n    ),\n    not(\n      equals(parameters('entra_id_domain'), '')\n    )\n  ),\n  concat(split(item()?['identity'], '@')[0], '@', parameters('entra_id_domain')),\n  item()?['identity']\n)",
                          "type": "Compose"
                        },
                        "Confirm_user_as_risky_(requires_P1_or_P2_license)": {
                          "type": "If",
                          "expression": {
                            "and": [
                              {
                                "equals": [
                                  "@parameters('confirm_user_as_risky')",
                                  true
                                ]
                              }
                            ]
                          },
                          "actions": {
                            "Confirm_a_risky_user_as_compromised": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azureadip']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "body": {
                                  "userIds": [
                                    "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']"
                                  ]
                                },
                                "path": "/beta/riskyUsers/confirmCompromised"
                              }
                            }
                          },
                          "runAfter": {
                            "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                              "Succeeded"
                            ],
                            "Workaround_-_Current_Time": [
                              "Succeeded"
                            ]
                          }
                        },
                        "Get_User_-_Check_if_the_user_exists_in_Active_Directory": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuread']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/v1.0/users/@{encodeURIComponent(outputs('Compute_user_principal_name'))}"
                          },
                          "runAfter": {
                            "Compute_user_principal_name": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "If_Create_incident_OR_Save_to_LAW": {
                          "actions": {
                            "Create_Microsoft_Sentinel_Incident": {
                              "actions": {
                                "Add_comment_to_incident_(V3)": {
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@body('Create_incident')?['id']",
                                      "message": "<p class=\"editor-paragraph\">@{body('Playbook_Alerts_-_Detailed_Identity_Novel_Exposures_alert_data')?['html_comment']}</p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  },
                                  "runAfter": {
                                    "Create_incident": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection"
                                },
                                "Create_incident": {
                                  "inputs": {
                                    "body": {
                                      "description": "@body('Playbook_Alerts_-_Detailed_Identity_Novel_Exposures_alert_data')?['html_description']",
                                      "severity": "Medium",
                                      "status": "New",
                                      "tagsToAdd": {
                                        "TagsToAdd": [
                                          {
                                            "Tag": "Recorded Future Identity Alert"
                                          }
                                        ]
                                      },
                                      "title": "Identity Exposure: @{item()?['identity']}"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "put",
                                    "path": "[[concat('/Incidents/subscriptions/', subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/workspaces/',parameters('sentinel_workspace_name') ) ]"
                                  },
                                  "type": "ApiConnection"
                                }
                              },
                              "expression": {
                                "and": [
                                  {
                                    "equals": [
                                      "@parameters('create_incident')",
                                      true
                                    ]
                                  }
                                ]
                              },
                              "runAfter": {
                                "Playbook_Alerts_-_Detailed_Identity_Novel_Exposures_alert_data": [
                                  "Succeeded"
                                ]
                              },
                              "type": "If"
                            },
                            "If_Save_to_Log_Analytics_Workspace": {
                              "actions": {
                                "Send_Data_-_Save_Playbook_alert_to_LogAnalytics_Custom_Log": {
                                  "inputs": {
                                    "body": "@string(body('Playbook_Alerts_-_Detailed_Identity_Novel_Exposures_alert_data')?['result'])",
                                    "headers": {
                                      "Log-Type": "@parameters('playbook_alert_log_analytics_custom_log_name')"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/api/logs"
                                  },
                                  "type": "ApiConnection"
                                }
                              },
                              "expression": {
                                "and": [
                                  {
                                    "equals": [
                                      "@parameters('save_to_log_analytics_workspace')",
                                      true
                                    ]
                                  }
                                ]
                              },
                              "runAfter": {
                                "Playbook_Alerts_-_Detailed_Identity_Novel_Exposures_alert_data": [
                                  "Succeeded"
                                ]
                              },
                              "type": "If"
                            },
                            "Playbook_Alerts_-_Detailed_Identity_Novel_Exposures_alert_data": {
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['rfi-customconnector-0-2-0']['connectionId']"
                                  }
                                },
                                "method": "get",
                                "path": "/playbook-alerts/@{encodeURIComponent(item()?['alert_id'])}",
                                "queries": {
                                  "return_html": true
                                }
                              },
                              "type": "ApiConnection"
                            },
                            "Playbook_Alerts_-_Update_Playbook_Alert_-_Incident_created": {
                              "inputs": {
                                "body": {
                                  "alert_id": "@item()?['alert_id']",
                                  "log_entry": "Actions taken in Entra ID integration: \n- User found. \n@{if(not(equals(parameters('entra_id_security_group_id'),'')), string('- Placed into security group.'), '- Did not place into security group')} \n@{if(equals(parameters('confirm_user_as_risky'),true), string('- Confirmed as risky user if present in that list.'), '- Did not confirm user as risky')}\n@{if(equals(parameters('create_incident'),true), string('- Incident created in Microsoft Sentinel'), '- Did not create Microsoft Sentinel incident')}\n@{if(equals(parameters('save_to_log_analytics_workspace'),true), string('- Saved to log analytics workspace'), '- Did not save to log analytics workspace')}",
                                  "added_actions_taken": [
                                    "@if(or(not(equals(parameters('entra_id_security_group_id'), '')),parameters('confirm_user_as_risky'), false),'identity_novel_exposures.placed_in_risky_group','identity_novel_exposures.other')"
                                  ],
                                  "status": "Resolved"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['rfi-customconnector-0-2-0']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/playbook-alerts/update"
                              },
                              "runAfter": {
                                "Create_Microsoft_Sentinel_Incident": [
                                  "Succeeded",
                                  "Skipped"
                                ],
                                "If_Save_to_Log_Analytics_Workspace": [
                                  "Succeeded",
                                  "Skipped"
                                ]
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "else": {
                            "actions": {
                              "Playbook_Alerts_-_Update_Playbook_Alert-_If_user_found": {
                                "inputs": {
                                  "body": {
                                    "alert_id": "@item()?['alert_id']",
                                    "log_entry": "Actions taken in Entra ID integration: \n- User found. \n@{if(not(equals(parameters('entra_id_security_group_id'),'')), string('- Placed into security group.'), '- Did not place into security group')} \n@{if(equals(parameters('confirm_user_as_risky'),true), string('- Confirmed as risky user if present in that list.'), '- Did not confirm user as risky')}\n@{if(equals(parameters('create_incident'),true), string('- Incident created in Microsoft Sentinel'), '- Did not create Microsoft Sentinel incident')}\n@{if(equals(parameters('save_to_log_analytics_workspace'),true), string('- Saved to log analytics workspace'), '- Did not save to log analytics workspace')}",
                                    "added_actions_taken": [
                                      "@if(or(not(equals(parameters('entra_id_security_group_id'), '')),parameters('confirm_user_as_risky'), false),'identity_novel_exposures.placed_in_risky_group','identity_novel_exposures.other')"
                                    ],
                                    "status": "Resolved"
                                  },
                                  "host": {
                                    "connection": {
                                      "name": "@parameters('$connections')['rfi-customconnector-0-2-0']['connectionId']"
                                    }
                                  },
                                  "method": "put",
                                  "path": "/playbook-alerts/update"
                                },
                                "type": "ApiConnection"
                              }
                            }
                          },
                          "expression": {
                            "or": [
                              {
                                "equals": [
                                  "@parameters('create_incident')",
                                  true
                                ]
                              },
                              {
                                "equals": [
                                  "@parameters('save_to_log_analytics_workspace')",
                                  true
                                ]
                              }
                            ]
                          },
                          "runAfter": {
                            "Add_user_to_Entra_ID_security_group": [
                              "Succeeded",
                              "Skipped"
                            ],
                            "Confirm_user_as_risky_(requires_P1_or_P2_license)": [
                              "Succeeded",
                              "Failed",
                              "Skipped"
                            ]
                          },
                          "type": "If"
                        },
                        "Playbook_Alerts_-_Update_Playbook_Alert_-_If_user_not_found": {
                          "inputs": {
                            "body": {
                              "alert_id": "@item()?['alert_id']",
                              "log_entry": "User not found. Might be false positive. Dismissed",
                              "status": "Dismissed"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['rfi-customconnector-0-2-0']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/playbook-alerts/update"
                          },
                          "runAfter": {
                            "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                              "Failed"
                            ],
                            "Workaround_-_Current_Time": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Workaround_-_Current_Time": {
                          "description": "This step is only here to handle a specific case where the user is not found but we have a alert id. Without this, the whole run would be seen as \"Failed\" even though it did everything correct",
                          "inputs": "[variables('TemplateEmptyObject')]",
                          "kind": "CurrentTime",
                          "runAfter": {
                            "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                              "Succeeded",
                              "Failed"
                            ]
                          },
                          "type": "Expression"
                        }
                      },
                      "foreach": "@body('Playbook_Alerts_-_Search_for_novel_identity_exposures')?['pba_items']",
                      "runAfter": {
                        "Playbook_Alerts_-_Search_for_novel_identity_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Playbook_Alerts_-_Search_for_novel_identity_exposures": {
                      "inputs": {
                        "body": {
                          "lookback_days": 7,
                          "priorities": [
                            "High",
                            "Moderate"
                          ]
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['rfi-customconnector-0-2-0']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/playbook-alerts/search"
                      },
                      "type": "ApiConnection"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "entra_id_domain": {
                      "defaultValue": "[[parameters('entra_id_domain')]",
                      "type": "String"
                    },
                    "entra_id_security_group_id": {
                      "defaultValue": "[[parameters('entra_id_security_group_id')]",
                      "type": "String"
                    },
                    "confirm_user_as_risky": {
                      "defaultValue": "[[parameters('confirm_user_as_risky')]",
                      "type": "Bool"
                    },
                    "create_incident": {
                      "defaultValue": "[[parameters('create_incident')]",
                      "type": "Bool"
                    },
                    "playbook_alert_log_analytics_custom_log_name": {
                      "defaultValue": "[[parameters('playbook_alert_log_analytics_custom_log_name')]",
                      "type": "String"
                    },
                    "save_to_log_analytics_workspace": {
                      "defaultValue": "[[parameters('save_to_log_analytics_workspace')]",
                      "type": "Bool"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "evaluatedRecurrence": {
                        "frequency": "Minute",
                        "interval": 15
                      },
                      "recurrence": {
                        "frequency": "Minute",
                        "interval": 15
                      },
                      "type": "Recurrence"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuread": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureadConnectionName'))]",
                        "connectionName": "[[variables('AzureadConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuread')]"
                      },
                      "azureadip": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureadipConnectionName'))]",
                        "connectionName": "[[variables('AzureadipConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureadip')]"
                      },
                      "azureloganalyticsdatacollector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]",
                        "connectionName": "[[variables('AzureloganalyticsdatacollectorConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureloganalyticsdatacollector')]"
                      },
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzuresentinelConnectionName'))]",
                        "connectionName": "[[variables('AzuresentinelConnectionName')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        },
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]"
                      },
                      "rfi-customconnector-0-2-0": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Rfi-Customconnector-0-2-0ConnectionName'))]",
                        "connectionName": "[[variables('Rfi-Customconnector-0-2-0ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('RFICustomConnector'))]"
                      }
                    }
                  }
                },
                "provisioningState": "Succeeded",
                "state": "Enabled"
              },
              "type": "Microsoft.Logic/workflows"
            },
            {
              "apiVersion": "2016-06-01",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[variables('AzureadConnectionName')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('AzureadConnectionName')]"
              },
              "type": "Microsoft.Web/connections"
            },
            {
              "apiVersion": "2016-06-01",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[variables('AzureadipConnectionName')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-3')]"
                },
                "displayName": "[[variables('AzureadipConnectionName')]"
              },
              "type": "Microsoft.Web/connections"
            },
            {
              "apiVersion": "2016-06-01",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[variables('AzuresentinelConnectionName')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-4')]"
                },
                "displayName": "[[variables('AzuresentinelConnectionName')]",
                "parameterValueType": "Alternative"
              },
              "type": "Microsoft.Web/connections"
            },
            {
              "apiVersion": "2016-06-01",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[variables('AzureloganalyticsdatacollectorConnectionName')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-5')]"
                },
                "displayName": "[[variables('AzureloganalyticsdatacollectorConnectionName')]"
              },
              "type": "Microsoft.Web/connections"
            },
            {
              "apiVersion": "2016-06-01",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[variables('Rfi-Customconnector-0-2-0ConnectionName')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-6')]"
                },
                "displayName": "[[variables('Rfi-Customconnector-0-2-0ConnectionName')]"
              },
              "type": "Microsoft.Web/connections"
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_RFI-CustomConnector-0-2-0')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "RFI-Playbook-Alert-Importer-LAW-Sentinel",
            "description": "This playbook fetches identity compromises from Recorded Future, places users in a security group and confirms them as 'risky users' in Entra ID.",
            "prerequisites": [
              "First install the RFI-CustomConnector-0-2-0 custom connector",
              "To use the Recorded Future Identity connector, you will need a valid API token from Recorded Future as described in the [documentation](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Recorded%20Future%20Identity/Playbooks/readme.md#how-to-obtain-recorded-future-api-token)"
            ],
            "postDeployment": [
              "After deployment, open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2025-04-29T00:00:00Z",
            "tags": [
              "Identity protection"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "Initial version",
                "notes": [
                  "Initial version"
                ]
              },
              {
                "version": "1.1",
                "title": "Improved stability",
                "notes": [
                  "Removed Get Risky User action due to instability"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId4')]",
        "contentKind": "Playbook",
        "displayName": "RFI-Playbook-Alert-Importer-LAW-Sentinel",
        "contentProductId": "[variables('_playbookcontentProductId4')]",
        "id": "[variables('_playbookcontentProductId4')]",
        "version": "[variables('playbookVersion4')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.1.2",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Recorded Future Identity",
        "publisherDisplayName": "Recorded Future Support Team",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p> Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Recorded%20Future%20Identity/ReleaseNotes.md\">Release Notes</a></p>\n<p> There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p><a href=\"https://www.recordedfuture.com/\">Recorded Future</a> Identity Intelligence enables security and IT teams to detect identity compromises, for both employees and customers. To do this, Recorded Future automates the collection, analysis, and production of identity intelligence from a vast range of sources. Organizations can incorporate identity intelligence into automated workflows that regularly monitor for compromised credentials and take immediate action with applications such as Entra ID and Microsoft Sentinel.\nThere are many ways organizations can utilize Recorded Future Identity Intelligence; the playbooks in this Solution are just a quick introduction to some of those ways. In particular, these playbooks include several actions that can be coordinated, or used separately. They include:</p>\n<ol>\n<li>searches for compromised workforce or external customer users</li>\n<li>looking up existing users and saving the compromised user data to a Log file</li>\n<li>confirming high risk Entra ID users</li>\n<li>adding a compromised user to an Entra ID security group</li>\n<li>Updating Recorded Future Playbook Alerts</li>\n</ol>\n<p>For more information, see the <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Recorded%20Future%20Identity/Playbooks\">Documentation for this Solution</a>.</p>\n<p>The playbooks have internal dependencies where you have to install:</p>\n<ul>\n<li>RFI-CustomConnector-0-2-0</li>\n</ul>\n<p>Before:</p>\n<ul>\n<li>RFI-Playbook-Alert-Importer</li>\n<li>RFI-Playbook-Alert-Importer-LAW</li>\n<li>RFI-Playbook-Alert-Importer-LAW-Sentinel.</li>\n</ul>\n<p>This solution depends on underlying Microsoft technologies. Some of these dependencies either may be in Preview state or might result in additional ingestion or operational costs:</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/azure-monitor/logs/workspace-design\">Log Analytics</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/logic-apps/logic-apps-pricing\">Logic apps</a></li>\n</ul>\n<p><strong>Custom Azure Logic Apps Connectors:</strong> 1, <strong>Playbooks:</strong> 3</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/RecordedFuture.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Recorded Future Identity",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Recorded Future Premier Integrations",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Recorded Future Support Team",
          "email": "support@recordedfuture.com",
          "tier": "Partner",
          "link": "https://support.recordedfuture.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "LogicAppsCustomConnector",
              "contentId": "[variables('_RFI-CustomConnector-0-2-0')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RFI-Playbook-Alert-Importer')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RFI-Playbook-Alert-Importer-LAW')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RFI-Playbook-Alert-Importer-LAW-Sentinel')]",
              "version": "[variables('playbookVersion4')]"
            }
          ]
        },
        "firstPublishDate": "2022-09-06",
        "lastPublishDate": "2025-04-02",
        "providers": [
          "Recorded Future"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection",
            "Identity"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
