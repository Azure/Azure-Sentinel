{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Recorded Future Premier Integrations - support@recordedfuture.com",
    "comments": "Solution template for Recorded Future Identity"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "email": "support@recordedfuture.com",
    "_email": "[variables('email')]",
    "_solutionName": "Recorded Future Identity",
    "_solutionVersion": "3.0.1",
    "solutionId": "recordedfuture1605638642586.recorded_future_identity_solution",
    "_solutionId": "[variables('solutionId')]",
    "RFI-CustomConnector-0-1-0": "RFI-CustomConnector-0-1-0",
    "_RFI-CustomConnector-0-1-0": "[variables('RFI-CustomConnector-0-1-0')]",
    "TemplateEmptyArray": "[json('[]')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "RFI-CustomConnector-0-1-0",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-lc-',uniquestring(variables('_playbookContentId1'))))]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','lc','-', uniqueString(concat(variables('_solutionId'),'-','LogicAppsCustomConnector','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
    "RFI-add-EntraID-security-group-user": "RFI-add-EntraID-security-group-user",
    "_RFI-add-EntraID-security-group-user": "[variables('RFI-add-EntraID-security-group-user')]",
    "playbookVersion2": "1.1",
    "playbookContentId2": "RFI-add-EntraID-security-group-user",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))))]",
    "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
    "RFI-confirm-EntraID-risky-user": "RFI-confirm-EntraID-risky-user",
    "_RFI-confirm-EntraID-risky-user": "[variables('RFI-confirm-EntraID-risky-user')]",
    "playbookVersion3": "1.1",
    "playbookContentId3": "RFI-confirm-EntraID-risky-user",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3'))))]",
    "_playbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId3'),'-', variables('playbookVersion3'))))]",
    "RFI-lookup-and-save-user": "RFI-lookup-and-save-user",
    "_RFI-lookup-and-save-user": "[variables('RFI-lookup-and-save-user')]",
    "playbookVersion4": "1.2",
    "playbookContentId4": "RFI-lookup-and-save-user",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4'))))]",
    "_playbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId4'),'-', variables('playbookVersion4'))))]",
    "RFI-search-workforce-user": "RFI-search-workforce-user",
    "_RFI-search-workforce-user": "[variables('RFI-search-workforce-user')]",
    "TemplateEmptyObject": "[json('{}')]",
    "blanks": "[replace('b', 'b', '')]",
    "playbookVersion5": "1.2",
    "playbookContentId5": "RFI-search-workforce-user",
    "_playbookContentId5": "[variables('playbookContentId5')]",
    "playbookId5": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId5'))]",
    "playbookTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId5'))))]",
    "_playbookcontentProductId5": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId5'),'-', variables('playbookVersion5'))))]",
    "RFI-search-external-user": "RFI-search-external-user",
    "_RFI-search-external-user": "[variables('RFI-search-external-user')]",
    "playbookVersion6": "1.2",
    "playbookContentId6": "RFI-search-external-user",
    "_playbookContentId6": "[variables('playbookContentId6')]",
    "playbookId6": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId6'))]",
    "playbookTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId6'))))]",
    "_playbookcontentProductId6": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId6'),'-', variables('playbookVersion6'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RFI-CustomConnector-0-1-0 Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "ConnectorName": {
              "defaultValue": "RFI-CustomConnector-0-1-0",
              "type": "String",
              "metadata": {
                "description": "Recorded Future Identity Custom Connector 0.1.0"
              }
            },
            "ServiceEndpoint": {
              "defaultValue": "https://api.recordedfuture.com/gw/azure-identity",
              "type": "String",
              "metadata": {
                "description": "Recorded Future Identity API"
              }
            }
          },
          "variables": {
            "operationId-Credential_Lookup": "Credential_Lookup",
            "_operationId-Credential_Lookup": "[[variables('operationId-Credential_Lookup')]",
            "operationId-Credential_Search": "Credential_Search",
            "_operationId-Credential_Search": "[[variables('operationId-Credential_Search')]",
            "operationId-Credential_Lookup_V2": "Credential_Lookup_V2",
            "_operationId-Credential_Lookup_V2": "[[variables('operationId-Credential_Lookup_V2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId1": "RFI-CustomConnector-0-1-0",
            "playbookId1": "[[resourceId('Microsoft.Web/customApis', parameters('ConnectorName'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('ConnectorName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "connectionParameters": {
                  "api_key": {
                    "type": "securestring"
                  }
                },
                "backendService": {
                  "serviceUrl": "[[parameters('ServiceEndPoint')]"
                },
                "capabilities": "[variables('TemplateEmptyArray')]",
                "brandColor": "#FFFFFF",
                "description": "Recorded Future Identity Connector enables access to the Recorded Future Identity Intelligence. The connector has dedicated actions for search and lookup of identity leaks.",
                "displayName": "[[parameters('ConnectorName')]",
                "iconUri": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEBLAEsAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/2wBDAQMEBAUEBQkFBQkUDQsNFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBT/wAARCAAoADADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9U6a7rGpZ2CqoyWY4Ap1YXjjwXpvxC8K6h4d1hZX02+QJMIZDG+AwYYYdOVFVHlckpOyJlzKLcVdniXxW8VeJvF/ir4ofD2wSO4tY/Cq3NnBGoWRpnIDfOSOoYjB44Fa/wz8ZeIdL+JujeAdRaOKwsfBlreSwsoMi3IKoxL55GMj04rzjx5p+m+G/id8VYLnT573RbLwLbxfZlnaNpI1KKq+bgkH5evPQ9a0PBvh3S/GPxkt9LaznttC1L4b20HkeczOkLuo2+ZwSQOM98V9U6VP6va3u8t9uvLHXff8Aq58sqtT6xe/vc1t+nNLTbb+rH1SrBlDKQVIyCOhpay/C/h2z8I+HdN0TTldbHT4Et4RI5dtijAyT1NalfKStd22Pqo3sr7nnvgr45eHPHV5pttaRanYtqkTS6fJqNi8Ed4qrubynPysQuTjOcAntXZnXtMXT5b86jaCxiJEl156+UhBwctnA5r5TH7OvifRfBOjLNczCb/hHLmxmGpaqDBol2y482PL7QjoWiOzO3dkcE1f0H4X3mrXMGsaZpFtqlpYX9rPeeG21LT2ju1SKZAwjt0WFWUyAgu2X2c7doz79TBYVtypVNPl3+W//AAdmeDTxuKVo1aer9e36f8DdM+ifFcHhzxN4fk0jWbq0fTtciNsqtciM3KsOkbAgk88bfWrGlz6D4d0yHT7S7s7a1023WAI1wpMMSYQBiTnAIAye9fP2tfBTxBcR6o0fgfSXj1jR20+zs471CmhSmaV/My/Y+YrHys4ZMAYwaZo/7P2t6R4atJr3QbXXtVtfFEuoXtvNLEJNVs8MEy7HafmIkCOQMjnmsvq1Dks62l9tP8/l/wAA1+s1ue6o6231/wAvn/wT3vQPiDofiK3vp7a8WGKz1CXS3e5IjDTxkBlUk/N14x1pvj34iaH8N/D9/rGs3Oy3so0llihw82xpFjDBM5I3MBmvmiP4C+KbCbUtQv8AQUXRZrjURFosNzYlbRZpFZJQ06tGqlRsJXDrsGARxVjx58BPFGo+B/FWj2nhm38R6rqS2Mun6/PqMLTQRRRwI1vvcIxI8t8EBVYOScH5TqsDhPaxvV9266rur63+f5XMnjcV7OVqT5rdn2dtLf11se2ftIK0nwJ8bKqlmOmyYAGT2ri4G1P4ReKPB8usnRdK0XUJLqK8k8O6W9vDIwgBt1mA3Fm3b9vuSO9FFZ4P36caL2k5X/8AAUaYz3akqq3io2/8CZ5HbeIvEqre+JTrusp4ivPCIuLRe87x3cgkVV28lI13kDkEk+1d/rHxE1fxz8XF0vQPE2o2nhu91CwgjuLJNn7t7K6eTyy6d2jX5scEcdKKK9+rShyzqWV0nbRd1+VvxZ4NKrNShTu7Nq+r7frfX5D/AId674p8U+NINJ1/VpJmmubuHVdFupHdo4Yy/kMsS2wEJBWI+Y0pEgJ6lgB9JWtvHZ28UES7Yo1CKMk8D3NFFfN5laNSKirK1z6PLbypycnd3t+R/9k=",
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "title": "Recorded Future Identity",
                    "description": "The Recorded Future Identity Intelligence Connector enables security and IT\nteams to detect identity compromises, for both employees and customers. To\ndo this, Recorded Future automates the collection, analysis, and production\nof identity intelligence from a vast range of sources. Through this\nconnector, organizations can incorporate identity intelligence into\nautomated workflows (e.g., password resets) with applications such as Azure\nActive Directory and Microsoft Sentinel.",
                    "contact": {
                      "name": "Recorded Future Support",
                      "url": "https://support.recordedfuture.com",
                      "email": "support@recordedfuture.com"
                    },
                    "version": "1.1.0"
                  },
                  "host": "api.recordedfuture.com",
                  "basePath": "/gw/azure-identity",
                  "schemes": [
                    "https"
                  ],
                  "consumes": "[variables('TemplateEmptyArray')]",
                  "produces": "[variables('TemplateEmptyArray')]",
                  "paths": {
                    "/credentials/lookup": {
                      "post": {
                        "tags": [
                          "Identity"
                        ],
                        "summary": "Credential Lookup - Look up credential data for one or more users",
                        "description": "Look up exposed credential data for a specific set of subjects",
                        "operationId": "[[variables('_operationId-Credential_Lookup')]",
                        "consumes": [
                          "application/json"
                        ],
                        "produces": [
                          "application/json"
                        ],
                        "parameters": [
                          {
                            "in": "body",
                            "name": "body",
                            "schema": {
                              "$ref": "#/definitions/CredentialsLookupRequest"
                            }
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "Returns detailed information on the exposed credentials",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "exposed_credentials": {
                                  "title": "Exposed credentials",
                                  "description": "List of exposed credentials",
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "clear_text_hint": {
                                        "description": "First two letters of the exposed secret. Only available for secrets exposed in clear text",
                                        "type": "string",
                                        "example": "s5",
                                        "x-ms-visibility": "important"
                                      },
                                      "dumps": {
                                        "description": "List of data dumps in which the signature has been involved.",
                                        "type": "array",
                                        "items": {
                                          "type": "object",
                                          "properties": {
                                            "breaches": {
                                              "description": "List of data breaches related to the dump",
                                              "type": "array",
                                              "items": {
                                                "type": "object",
                                                "properties": {
                                                  "breached": {
                                                    "type": "string",
                                                    "example": "2016-06-01T00:00:00Z",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "description": {
                                                    "type": "string",
                                                    "example": "Evony.com reportedly suffered data breaches in June and August 2016, resulting in the exposure of over 34 million user accounts.",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "domain": {
                                                    "type": "string",
                                                    "example": "evony.com",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "name": {
                                                    "type": "string",
                                                    "example": "Evony",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "precision": {
                                                    "type": "string",
                                                    "example": "month",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "site_description": {
                                                    "type": "string",
                                                    "example": "Evony.com is the website of Evony LLC, which develops browser and mobile-based online games.",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "start": {
                                                    "type": "string",
                                                    "example": "2016-06-01T00:00:00Z",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "stop": {
                                                    "type": "string",
                                                    "example": "2016-08-31T23:59:59Z",
                                                    "x-ms-visibility": "important"
                                                  },
                                                  "type": {
                                                    "type": "string",
                                                    "example": "Breach",
                                                    "x-ms-visibility": "important"
                                                  }
                                                }
                                              }
                                            },
                                            "description": {
                                              "description": "Description of the dump",
                                              "type": "string",
                                              "example": "This credential data was derived from stealer malware logs. These logs were obtained through Recorded Future\\u2019s proprietary sources.",
                                              "x-ms-visibility": "important"
                                            },
                                            "downloaded": {
                                              "description": "Date when the dump was downloaded",
                                              "type": "string",
                                              "example": "2021-07-23T00:00:00Z",
                                              "x-ms-visibility": "important"
                                            },
                                            "name": {
                                              "description": "Name of the dump",
                                              "type": "string",
                                              "example": "XSS.is Dump 2021",
                                              "x-ms-visibility": "important"
                                            },
                                            "type": {
                                              "description": "Type of the dump",
                                              "type": "string",
                                              "example": "Combo List",
                                              "x-ms-visibility": "important"
                                            }
                                          }
                                        }
                                      },
                                      "exposed_secret_format": {
                                        "description": "Format of the exposed secret. Either the hash algorithm or clear for cleartext.",
                                        "type": "string",
                                        "example": "clear",
                                        "x-ms-visibility": "important"
                                      },
                                      "first_seen": {
                                        "description": "Date when the signature was first seen exposed",
                                        "type": "string",
                                        "example": "2021-07-23T00:00:00Z",
                                        "x-ms-visibility": "important"
                                      },
                                      "last_seen": {
                                        "description": "Date when the signature was last seen exposed",
                                        "type": "string",
                                        "example": "2021-07-23T00:00:00Z",
                                        "x-ms-visibility": "important"
                                      },
                                      "malware_family": {
                                        "title": "Malware family",
                                        "description": "Family of malware used to extract the credentials",
                                        "type": "string",
                                        "example": "RedLine Stealer",
                                        "x-ms-visibility": "important"
                                      },
                                      "secret_hashes": {
                                        "description": "List of known hashes of the exposed secret. Calculated by Recorded Future if the secret was exposed in clear text.",
                                        "type": "array",
                                        "items": {
                                          "type": "object",
                                          "properties": {
                                            "algorithm": {
                                              "title": "algorithm",
                                              "description": "Hash algorithm used",
                                              "type": "string",
                                              "example": "SHA1",
                                              "x-ms-visibility": "important"
                                            },
                                            "hash": {
                                              "title": "hash",
                                              "description": "Hash value",
                                              "type": "string",
                                              "example": "a7862e41d43a09e0297f197ec4673ad2c0e0d43c",
                                              "x-ms-visibility": "important"
                                            }
                                          }
                                        }
                                      },
                                      "secret_properties": {
                                        "description": "Properties of the clear text",
                                        "type": "array",
                                        "items": {
                                          "type": "string",
                                          "example": "Letter",
                                          "x-ms-visibility": "important"
                                        },
                                        "x-ms-visibility": "important"
                                      },
                                      "secret_rank": {
                                        "description": "Any common password collections the password is part of",
                                        "type": "string",
                                        "example": "Top100kCommonPasswords",
                                        "x-ms-visibility": "important"
                                      },
                                      "signature": {
                                        "title": "signature",
                                        "description": "Requested signature",
                                        "type": "string",
                                        "example": "06regq@www.google.com",
                                        "x-ms-visibility": "important"
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          },
                          "401": {
                            "description": "Authorization token is missing",
                            "schema": {
                              "$ref": "#/definitions/401Error"
                            }
                          },
                          "403": {
                            "description": "Provided token is not authorized to use the API.",
                            "schema": {
                              "$ref": "#/definitions/403Error"
                            }
                          }
                        },
                        "security": [
                          {
                            "apiKey-auth": "[variables('TemplateEmptyArray')]"
                          }
                        ],
                        "deprecated": true,
                        "x-ms-api-annotation": {
                          "family": "Credential_Lookup",
                          "revision": 1
                        },
                        "x-ms-visibility": "important"
                      }
                    },
                    "/credentials/search": {
                      "post": {
                        "tags": [
                          "Identity"
                        ],
                        "summary": "Credential Search - Search credential data for one or more domains",
                        "description": "Search credential data exposed in data dumps and through malware logs",
                        "operationId": "[[variables('_operationId-Credential_Search')]",
                        "consumes": [
                          "application/json"
                        ],
                        "produces": [
                          "application/json"
                        ],
                        "parameters": [
                          {
                            "in": "body",
                            "name": "body",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "domain_type": {
                                  "title": "Credential type",
                                  "description": "Select credential type",
                                  "default": "My Organization (workforce use case)",
                                  "enum": [
                                    "My Organization (workforce use case)",
                                    "Customer (external use case)"
                                  ],
                                  "type": "string",
                                  "example": "My Organization (workforce use case)",
                                  "x-ms-visibility": "important"
                                },
                                "domains": {
                                  "title": "Domains",
                                  "description": "List of domains to search",
                                  "type": "array",
                                  "items": {
                                    "title": "Domain",
                                    "description": "A domain owned by your organization",
                                    "type": "string",
                                    "example": "google.com",
                                    "x-ms-visibility": "important"
                                  },
                                  "x-ms-visibility": "important"
                                },
                                "filter": {
                                  "type": "object",
                                  "properties": {
                                    "breach_properties": {
                                      "$ref": "#/definitions/BreachProperties"
                                    },
                                    "dump_properties": {
                                      "$ref": "#/definitions/DumpProperties"
                                    },
                                    "latest_downloaded_gte": {
                                      "format": "date-time",
                                      "title": "From",
                                      "description": "YYYY-MM-DD (until today)",
                                      "type": "string",
                                      "example": "2017-07-21T19:32:28+02:00",
                                      "x-ms-visibility": "important"
                                    },
                                    "properties": {
                                      "$ref": "#/definitions/CredentialProperties"
                                    }
                                  }
                                },
                                "limit": {
                                  "title": "Results",
                                  "description": "Maxiumum number of results",
                                  "default": 500,
                                  "type": "number",
                                  "example": 10,
                                  "x-ms-visibility": "advanced"
                                },
                                "offset": {
                                  "title": "Offset",
                                  "description": "Records from offset",
                                  "type": "string",
                                  "example": "eyJzdWJqZWN0IjpudWxsLCJsb2dpbiI6IjU2MDQwMjQ5MjUxIiwiYXV0aG9yaXphdGlvbl9zZXJ2aWNlIjoiZ29vZ2xlLmNvbSJ9",
                                  "x-ms-visibility": "advanced"
                                }
                              }
                            }
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "Returns a list exposed credentials related to the searched domains",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "count": {
                                  "title": "Count",
                                  "description": "Number of returned credentials",
                                  "type": "number",
                                  "example": 2,
                                  "x-ms-visibility": "important"
                                },
                                "credential_dumps": {
                                  "title": "Credential dumps",
                                  "description": "List of credentials exposed in data dumps",
                                  "type": "array",
                                  "items": {
                                    "type": "string",
                                    "example": "test@domain.com",
                                    "x-ms-visibility": "important"
                                  }
                                },
                                "malware_logs": {
                                  "title": "Malware logs",
                                  "description": "List of credentials exposed through malware logs",
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "domain": {
                                        "title": "Domain",
                                        "description": "Login domain",
                                        "type": "string",
                                        "example": "www.domain.com",
                                        "x-ms-visibility": "important"
                                      },
                                      "login": {
                                        "title": "Login",
                                        "description": "Login username",
                                        "type": "string",
                                        "example": "testuser",
                                        "x-ms-visibility": "important"
                                      }
                                    }
                                  }
                                },
                                "next_offset": {
                                  "title": "Next offset",
                                  "description": "Offset used to request succeeding records",
                                  "type": "string",
                                  "example": "eyJzdWJqZWN0IjpudWxsLCJsb2dpbiI6IjU2MDQwMjQ5MjUxIiwiYXV0aG9yaXphdGlvbl9zZXJ2aWNlIjoiZ29vZ2xlLmNvbSJ9",
                                  "x-ms-visibility": "important"
                                }
                              }
                            }
                          },
                          "401": {
                            "description": "Authorization token is missing",
                            "schema": {
                              "$ref": "#/definitions/401Error"
                            }
                          },
                          "403": {
                            "description": "Provided token is not authorized to use the API.",
                            "schema": {
                              "$ref": "#/definitions/403Error"
                            }
                          }
                        },
                        "security": [
                          {
                            "apiKey-auth": "[variables('TemplateEmptyArray')]"
                          }
                        ],
                        "x-ms-visibility": "important"
                      }
                    },
                    "/v2/credentials/lookup": {
                      "post": {
                        "tags": [
                          "Identity"
                        ],
                        "summary": "Credential Lookup V2 - Look up credential data for one or more users",
                        "description": "Look up exposed credential data for a specific set of subjects",
                        "operationId": "[[variables('_operationId-Credential_Lookup_V2')]",
                        "consumes": [
                          "application/json"
                        ],
                        "produces": [
                          "application/json"
                        ],
                        "parameters": [
                          {
                            "in": "body",
                            "name": "body",
                            "schema": {
                              "$ref": "#/definitions/CredentialsLookupRequest"
                            }
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "Success",
                            "schema": {
                              "$ref": "#/definitions/LookupResponse"
                            }
                          }
                        },
                        "security": [
                          {
                            "apiKey-auth": "[variables('TemplateEmptyArray')]"
                          }
                        ],
                        "x-ms-api-annotation": {
                          "family": "Credential_Lookup",
                          "revision": 2
                        },
                        "x-ms-visibility": "important"
                      }
                    }
                  },
                  "definitions": {
                    "401Error": {
                      "type": "object",
                      "properties": {
                        "error": {
                          "type": "object",
                          "properties": {
                            "status": {
                              "type": "number",
                              "example": 401
                            }
                          }
                        }
                      }
                    },
                    "403Error": {
                      "type": "object",
                      "properties": {
                        "code": {
                          "type": "number",
                          "example": 403
                        },
                        "error": {
                          "type": "object",
                          "properties": {
                            "message": {
                              "type": "string",
                              "example": "Not Authenticated"
                            },
                            "status": {
                              "type": "string",
                              "example": "fail"
                            }
                          }
                        }
                      }
                    },
                    "CredentialProperties": {
                      "description": "Filter on credential properties",
                      "type": "array",
                      "items": {
                        "description": "Credentials must include",
                        "enum": [
                          "Letter",
                          "Number",
                          "Symbol",
                          "UpperCase",
                          "LowerCase",
                          "MixedCase",
                          "AtLeast8Characters",
                          "AtLeast12Characters",
                          "AtLeast16Characters",
                          "AtLeast24Characters"
                        ],
                        "type": "string",
                        "example": "Letter"
                      },
                      "x-ms-visibility": "advanced"
                    },
                    "AuthorizationService": {
                      "type": "object",
                      "properties": {
                        "domain": {
                          "type": "string"
                        },
                        "fqdn": {
                          "type": "string"
                        },
                        "protocols": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "technology": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/Technology"
                          }
                        },
                        "url": {
                          "type": "string"
                        }
                      }
                    },
                    "BreachMetadata": {
                      "type": "object",
                      "properties": {
                        "breached": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "description": {
                          "type": "string"
                        },
                        "domain": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "precision": {
                          "enum": [
                            "year",
                            "month",
                            "day"
                          ],
                          "type": "string"
                        },
                        "site_description": {
                          "type": "string"
                        },
                        "start": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "stop": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "type": {
                          "type": "string"
                        }
                      }
                    },
                    "BreachProperties": {
                      "type": "object",
                      "properties": {
                        "date": {
                          "format": "date-time",
                          "description": "YYYY-MM-DD (until today)",
                          "type": "string",
                          "example": "2022-02-08T11:32:37.951+01:00"
                        },
                        "name": {
                          "type": "string",
                          "example": "Cit0day"
                        }
                      },
                      "x-ms-visibility": "advanced"
                    },
                    "CleartextPasswordDetails": {
                      "type": "object",
                      "properties": {
                        "clear_text_hint": {
                          "description": "First two characters of the cleartext password",
                          "type": "string"
                        },
                        "clear_text_value": {
                          "description": "The password as clear text",
                          "type": "string"
                        },
                        "properties": {
                          "description": "Properties exhibited by the password",
                          "type": "array",
                          "items": {
                            "enum": [
                              "Letter",
                              "Number",
                              "Symbol",
                              "UpperCase",
                              "LowerCase",
                              "MixedCase",
                              "AtLeast8Characters",
                              "AtLeast10Characters",
                              "AtLeast12Characters",
                              "AtLeast16Characters",
                              "AtLeast24Characters",
                              "Cookies",
                              "UnexpiredCookies",
                              "AuthorizationTechnology",
                              "MalwareOnly"
                            ],
                            "type": "string"
                          }
                        },
                        "rank": {
                          "description": "A ranking of how common this password is",
                          "enum": [
                            "Top100kCommonPasswords",
                            "TopMillionCommonPasswords"
                          ],
                          "type": "string"
                        }
                      }
                    },
                    "Compromise": {
                      "type": "object",
                      "properties": {
                        "antivirus": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "computer_name": {
                          "type": "string"
                        },
                        "exfiltration_date": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "malware_file": {
                          "type": "string"
                        },
                        "os": {
                          "type": "string"
                        },
                        "os_username": {
                          "type": "string"
                        },
                        "timezone": {
                          "type": "string"
                        },
                        "uac": {
                          "type": "string"
                        }
                      }
                    },
                    "Cookie": {
                      "type": "object",
                      "properties": {
                        "dns": {
                          "type": "string"
                        },
                        "expiration": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "http": {
                          "type": "boolean"
                        },
                        "name": {
                          "type": "string"
                        },
                        "secure": {
                          "type": "boolean"
                        }
                      }
                    },
                    "CountryCodeMappingModel": {
                      "type": "object",
                      "properties": {
                        "alpha2Code": {
                          "type": "string"
                        },
                        "alpha3Code": {
                          "type": "string"
                        },
                        "countryCode": {
                          "type": "string"
                        },
                        "displayName": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        }
                      }
                    },
                    "Credentials": {
                      "type": "object",
                      "properties": {
                        "authorization_service": {
                          "type": "object",
                          "properties": {
                            "domain": {
                              "type": "string"
                            },
                            "fqdn": {
                              "type": "string"
                            },
                            "protocols": {
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "technology": {
                              "type": "array",
                              "items": {
                                "$ref": "#/definitions/Technology"
                              }
                            },
                            "url": {
                              "type": "string"
                            }
                          }
                        },
                        "compromise": {
                          "type": "object",
                          "properties": {
                            "exfiltration_date": {
                              "format": "date-time",
                              "type": "string"
                            }
                          }
                        },
                        "cookies": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/Cookie"
                          }
                        },
                        "dumps": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/DumpMetadata"
                          }
                        },
                        "exposed_secret": {
                          "$ref": "#/definitions/SecretDetails"
                        },
                        "first_downloaded": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "latest_downloaded": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "malware_family": {
                          "type": "object",
                          "properties": {
                            "id": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            }
                          }
                        },
                        "subject": {
                          "type": "string"
                        }
                      }
                    },
                    "CredentialsLookupRequest": {
                      "type": "object",
                      "properties": {
                        "filter": {
                          "type": "object",
                          "properties": {
                            "authorization_protocols": {
                              "description": "Only include credentials with these authorization protocols",
                              "type": "array",
                              "items": {
                                "type": "string"
                              },
                              "x-ms-visibility": "important"
                            },
                            "authorization_technologies": {
                              "description": "Only include credentials with these authorization technologies",
                              "type": "array",
                              "items": {
                                "type": "string"
                              },
                              "x-ms-visibility": "important"
                            },
                            "breach_properties": {
                              "description": "Only include credentials from breaches that exhibit these properties",
                              "type": "object",
                              "properties": {
                                "date": {
                                  "format": "date-time",
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                }
                              },
                              "x-ms-visibility": "important"
                            },
                            "dump_properties": {
                              "description": "Only include credentials from dumps that exhibit these properties",
                              "type": "object",
                              "properties": {
                                "date": {
                                  "format": "date-time",
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                }
                              },
                              "x-ms-visibility": "important"
                            },
                            "exfiltration_date_gte": {
                              "format": "date-time",
                              "description": "YYYY-MM-DD (until today)",
                              "type": "string",
                              "x-ms-visibility": "important"
                            },
                            "first_downloaded_gte": {
                              "format": "date-time",
                              "description": "YYYY-MM-DD (until today)",
                              "type": "string",
                              "x-ms-visibility": "important"
                            },
                            "latest_downloaded_gte": {
                              "format": "date-time",
                              "description": "YYYY-MM-DD (until today)",
                              "type": "string",
                              "x-ms-visibility": "important"
                            },
                            "malware_families": {
                              "description": "Only include credentials with these malware families",
                              "type": "array",
                              "items": {
                                "type": "string"
                              },
                              "x-ms-visibility": "important"
                            },
                            "properties": {
                              "description": "Only include breaches of passwords that exhibit these properties",
                              "type": "array",
                              "items": {
                                "enum": [
                                  "Letter",
                                  "Number",
                                  "Symbol",
                                  "UpperCase",
                                  "LowerCase",
                                  "MixedCase",
                                  "AtLeast8Characters",
                                  "AtLeast10Characters",
                                  "AtLeast12Characters",
                                  "AtLeast16Characters",
                                  "AtLeast24Characters",
                                  "Cookies",
                                  "UnexpiredCookies",
                                  "AuthorizationTechnology",
                                  "MalwareOnly"
                                ],
                                "type": "string"
                              },
                              "x-ms-visibility": "important"
                            },
                            "username_properties": {
                              "description": "Only include credentials with these username properties",
                              "type": "array",
                              "items": {
                                "enum": [
                                  "Email"
                                ],
                                "type": "string"
                              },
                              "x-ms-visibility": "important"
                            }
                          }
                        },
                        "organization_id": {
                          "type": "string",
                          "x-ms-visibility": "important"
                        },
                        "subjects": {
                          "title": "Emails",
                          "description": "List of email addresses to look up",
                          "type": "array",
                          "items": {
                            "description": "An email-address with exposed credentials",
                            "type": "string",
                            "x-ms-visibility": "important"
                          },
                          "x-ms-visibility": "important"
                        },
                        "subjects_login": {
                          "title": "Credential with auth domain",
                          "description": "List of breached domain users to look up",
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/DomainLogin"
                          },
                          "x-ms-visibility": "important"
                        },
                        "subjects_sha1": {
                          "title": "Hashed emails",
                          "description": "List of hashed email addresses to look up",
                          "type": "array",
                          "items": {
                            "description": "The SHA1 hash of an email-address with exposed credentials",
                            "type": "string",
                            "x-ms-visibility": "advanced"
                          },
                          "x-ms-visibility": "advanced"
                        }
                      }
                    },
                    "CredentialsSearchRequest": {
                      "type": "object",
                      "properties": {
                        "domain_types": {
                          "type": "array",
                          "items": {
                            "enum": [
                              "Authorization",
                              "Email"
                            ],
                            "type": "string"
                          }
                        },
                        "domains": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "filter": {
                          "type": "object",
                          "properties": {
                            "authorization_protocols": {
                              "description": "Only include credentials with these authorization protocols",
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "authorization_technologies": {
                              "description": "Only include credentials with these authorization technologies",
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "breach_properties": {
                              "description": "Only include credentials from breaches that exhibit these properties",
                              "type": "object",
                              "properties": {
                                "date": {
                                  "format": "date-time",
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                }
                              }
                            },
                            "dump_properties": {
                              "description": "Only include credentials from dumps that exhibit these properties",
                              "type": "object",
                              "properties": {
                                "date": {
                                  "format": "date-time",
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                }
                              }
                            },
                            "exfiltration_date_gte": {
                              "format": "date-time",
                              "description": "Only include exfiltrations this time onwards",
                              "type": "string"
                            },
                            "first_downloaded_gte": {
                              "format": "date-time",
                              "description": "Only include breaches this time onwards",
                              "type": "string"
                            },
                            "latest_downloaded_gte": {
                              "format": "date-time",
                              "description": "Only include breaches this time onwards",
                              "type": "string"
                            },
                            "malware_families": {
                              "description": "Only include credentials with these malware families",
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "properties": {
                              "description": "Only include breaches of passwords that exhibit these properties",
                              "type": "array",
                              "items": {
                                "enum": [
                                  "Letter",
                                  "Number",
                                  "Symbol",
                                  "UpperCase",
                                  "LowerCase",
                                  "MixedCase",
                                  "AtLeast8Characters",
                                  "AtLeast10Characters",
                                  "AtLeast12Characters",
                                  "AtLeast16Characters",
                                  "AtLeast24Characters",
                                  "Cookies",
                                  "UnexpiredCookies",
                                  "AuthorizationTechnology",
                                  "MalwareOnly"
                                ],
                                "type": "string"
                              }
                            },
                            "username_properties": {
                              "description": "Only include credentials with these username properties",
                              "type": "array",
                              "items": {
                                "enum": [
                                  "Email"
                                ],
                                "type": "string"
                              }
                            }
                          }
                        },
                        "limit": {
                          "type": "integer"
                        },
                        "offset": {
                          "type": "string"
                        },
                        "organization_id": {
                          "type": "string"
                        }
                      }
                    },
                    "DeprecatedCompromise": {
                      "type": "object",
                      "properties": {
                        "exfiltration_date": {
                          "format": "date-time",
                          "type": "string"
                        }
                      }
                    },
                    "DomainLogin": {
                      "type": "object",
                      "properties": {
                        "domain": {
                          "description": "domain.com",
                          "type": "string",
                          "x-ms-visibility": "important"
                        },
                        "login": {
                          "description": "Either input username or hash of username",
                          "type": "string",
                          "x-ms-visibility": "important"
                        },
                        "login_sha1": {
                          "description": "Either input username or hash of username",
                          "type": "string",
                          "x-ms-visibility": "important"
                        }
                      }
                    },
                    "DumpMetadata": {
                      "type": "object",
                      "properties": {
                        "breaches": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/BreachMetadata"
                          }
                        },
                        "compromise": {
                          "type": "object",
                          "properties": {
                            "antivirus": {
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "computer_name": {
                              "type": "string"
                            },
                            "exfiltration_date": {
                              "format": "date-time",
                              "type": "string"
                            },
                            "malware_file": {
                              "type": "string"
                            },
                            "os": {
                              "type": "string"
                            },
                            "os_username": {
                              "type": "string"
                            },
                            "timezone": {
                              "type": "string"
                            },
                            "uac": {
                              "type": "string"
                            }
                          }
                        },
                        "description": {
                          "type": "string"
                        },
                        "downloaded": {
                          "format": "date-time",
                          "type": "string"
                        },
                        "infrastructure": {
                          "type": "object",
                          "properties": {
                            "ip": {
                              "type": "string"
                            }
                          }
                        },
                        "location": {
                          "type": "object",
                          "properties": {
                            "address": {
                              "type": "string"
                            },
                            "address1": {
                              "type": "string"
                            },
                            "address2": {
                              "type": "string"
                            },
                            "city": {
                              "type": "string"
                            },
                            "country": {
                              "type": "object",
                              "properties": {
                                "alpha2Code": {
                                  "type": "string"
                                },
                                "alpha3Code": {
                                  "type": "string"
                                },
                                "countryCode": {
                                  "type": "string"
                                },
                                "displayName": {
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                }
                              }
                            },
                            "postal_code": {
                              "type": "string"
                            },
                            "state": {
                              "type": "string"
                            },
                            "zip": {
                              "type": "string"
                            }
                          }
                        },
                        "name": {
                          "type": "string"
                        },
                        "type": {
                          "type": "string"
                        }
                      }
                    },
                    "DumpMetadataSearchRequest": {
                      "type": "object",
                      "properties": {
                        "limit": {
                          "type": "integer"
                        },
                        "names": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        }
                      }
                    },
                    "DumpProperties": {
                      "type": "object",
                      "properties": {
                        "date": {
                          "format": "date-time",
                          "description": "YYYY-MM-DD (until today)",
                          "type": "string",
                          "example": "2022-02-08T11:32:37.951+01:00"
                        },
                        "name": {
                          "type": "string",
                          "example": "XSS.is Dump 2021"
                        }
                      },
                      "x-ms-visibility": "advanced"
                    },
                    "IdentityDetails": {
                      "type": "object",
                      "properties": {
                        "subjects": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        }
                      }
                    },
                    "IdentityRequestFilter": {
                      "type": "object",
                      "properties": {
                        "authorization_protocols": {
                          "description": "Only include credentials with these authorization protocols",
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "authorization_technologies": {
                          "description": "Only include credentials with these authorization technologies",
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "breach_properties": {
                          "description": "Only include credentials from breaches that exhibit these properties",
                          "type": "object",
                          "properties": {
                            "date": {
                              "format": "date-time",
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            }
                          }
                        },
                        "dump_properties": {
                          "description": "Only include credentials from dumps that exhibit these properties",
                          "type": "object",
                          "properties": {
                            "date": {
                              "format": "date-time",
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            }
                          }
                        },
                        "exfiltration_date_gte": {
                          "format": "date-time",
                          "description": "Only include exfiltrations this time onwards",
                          "type": "string"
                        },
                        "first_downloaded_gte": {
                          "format": "date-time",
                          "description": "Only include breaches this time onwards",
                          "type": "string"
                        },
                        "latest_downloaded_gte": {
                          "format": "date-time",
                          "description": "Only include breaches this time onwards",
                          "type": "string"
                        },
                        "malware_families": {
                          "description": "Only include credentials with these malware families",
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "properties": {
                          "description": "Only include breaches of passwords that exhibit these properties",
                          "type": "array",
                          "items": {
                            "enum": [
                              "Letter",
                              "Number",
                              "Symbol",
                              "UpperCase",
                              "LowerCase",
                              "MixedCase",
                              "AtLeast8Characters",
                              "AtLeast10Characters",
                              "AtLeast12Characters",
                              "AtLeast16Characters",
                              "AtLeast24Characters",
                              "Cookies",
                              "UnexpiredCookies",
                              "AuthorizationTechnology",
                              "MalwareOnly"
                            ],
                            "type": "string"
                          }
                        },
                        "username_properties": {
                          "description": "Only include credentials with these username properties",
                          "type": "array",
                          "items": {
                            "enum": [
                              "Email"
                            ],
                            "type": "string"
                          }
                        }
                      }
                    },
                    "IncidentReportCredentials": {
                      "type": "object",
                      "properties": {
                        "authorization_domain": {
                          "type": "string"
                        },
                        "contains_active_cookies": {
                          "type": "boolean"
                        },
                        "contains_cookies": {
                          "type": "boolean"
                        },
                        "contains_high_risk_technologies": {
                          "type": "boolean"
                        },
                        "domain_category": {
                          "type": "string"
                        },
                        "domain_technology": {
                          "type": "string"
                        },
                        "email_or_login": {
                          "type": "string"
                        },
                        "password": {
                          "type": "string"
                        },
                        "password_sha1": {
                          "type": "string"
                        }
                      }
                    },
                    "IncidentReportDetails": {
                      "type": "object",
                      "properties": {
                        "antivirus": {
                          "type": "string"
                        },
                        "country": {
                          "type": "string"
                        },
                        "exfiltration_date": {
                          "type": "string"
                        },
                        "ip_address": {
                          "type": "string"
                        },
                        "malware_family": {
                          "type": "string"
                        },
                        "malware_file": {
                          "type": "string"
                        },
                        "os": {
                          "type": "string"
                        },
                        "os_username": {
                          "type": "string"
                        },
                        "postal_code": {
                          "type": "string"
                        },
                        "timezone": {
                          "type": "string"
                        },
                        "uac": {
                          "type": "string"
                        }
                      }
                    },
                    "IncidentReportRequest": {
                      "type": "object",
                      "properties": {
                        "include_details": {
                          "type": "boolean"
                        },
                        "limit": {
                          "type": "integer"
                        },
                        "offset": {
                          "type": "string"
                        },
                        "organization_id": {
                          "type": "string"
                        },
                        "source_malware_log": {
                          "type": "string"
                        }
                      }
                    },
                    "IncidentReportResponse": {
                      "type": "object",
                      "properties": {
                        "count": {
                          "type": "integer"
                        },
                        "credentials": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/IncidentReportCredentials"
                          }
                        },
                        "details": {
                          "type": "object",
                          "properties": {
                            "antivirus": {
                              "type": "string"
                            },
                            "country": {
                              "type": "string"
                            },
                            "exfiltration_date": {
                              "type": "string"
                            },
                            "ip_address": {
                              "type": "string"
                            },
                            "malware_family": {
                              "type": "string"
                            },
                            "malware_file": {
                              "type": "string"
                            },
                            "os": {
                              "type": "string"
                            },
                            "os_username": {
                              "type": "string"
                            },
                            "postal_code": {
                              "type": "string"
                            },
                            "timezone": {
                              "type": "string"
                            },
                            "uac": {
                              "type": "string"
                            }
                          }
                        },
                        "next_offset": {
                          "type": "string"
                        },
                        "total_count": {
                          "type": "integer"
                        }
                      }
                    },
                    "Infrastructure": {
                      "type": "object",
                      "properties": {
                        "ip": {
                          "type": "string"
                        }
                      }
                    },
                    "LeakedIdentity": {
                      "type": "object",
                      "properties": {
                        "count": {
                          "type": "integer"
                        },
                        "credentials": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/Credentials"
                          }
                        },
                        "identity": {
                          "$ref": "#/definitions/IdentityDetails"
                        }
                      }
                    },
                    "Location": {
                      "type": "object",
                      "properties": {
                        "address": {
                          "type": "string"
                        },
                        "address1": {
                          "type": "string"
                        },
                        "address2": {
                          "type": "string"
                        },
                        "city": {
                          "type": "string"
                        },
                        "country": {
                          "type": "object",
                          "properties": {
                            "alpha2Code": {
                              "type": "string"
                            },
                            "alpha3Code": {
                              "type": "string"
                            },
                            "countryCode": {
                              "type": "string"
                            },
                            "displayName": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            }
                          }
                        },
                        "postal_code": {
                          "type": "string"
                        },
                        "state": {
                          "type": "string"
                        },
                        "zip": {
                          "type": "string"
                        }
                      }
                    },
                    "LookupResponse": {
                      "type": "object",
                      "properties": {
                        "count": {
                          "type": "integer"
                        },
                        "identities": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/LeakedIdentity"
                          }
                        },
                        "next_offset": {
                          "type": "string"
                        }
                      }
                    },
                    "MalwareFamily": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        }
                      }
                    },
                    "MetadataDumpResponse": {
                      "type": "object",
                      "properties": {
                        "dumps": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/DumpMetadata"
                          }
                        }
                      }
                    },
                    "PasswordHash": {
                      "type": "object"
                    },
                    "PasswordLookupRequest": {
                      "type": "object",
                      "properties": {
                        "passwords": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/PasswordHash"
                          }
                        }
                      }
                    },
                    "PasswordLookupResponse": {
                      "type": "object",
                      "properties": {
                        "results": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/SinglePasswordLookupResult"
                          }
                        }
                      }
                    },
                    "SearchResponse": {
                      "type": "object",
                      "properties": {
                        "count": {
                          "type": "integer"
                        },
                        "count_relation": {
                          "type": "string"
                        },
                        "identities": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/SearchResponseIdentity"
                          }
                        },
                        "next_offset": {
                          "type": "string"
                        }
                      }
                    },
                    "SearchResponseIdentity": {
                      "type": "object"
                    },
                    "SecretDetails": {
                      "type": "object",
                      "properties": {
                        "details": {
                          "type": "object",
                          "properties": {
                            "clear_text_hint": {
                              "description": "First two characters of the cleartext password",
                              "type": "string"
                            },
                            "clear_text_value": {
                              "description": "The password as clear text",
                              "type": "string"
                            },
                            "properties": {
                              "description": "Properties exhibited by the password",
                              "type": "array",
                              "items": {
                                "enum": [
                                  "Letter",
                                  "Number",
                                  "Symbol",
                                  "UpperCase",
                                  "LowerCase",
                                  "MixedCase",
                                  "AtLeast8Characters",
                                  "AtLeast10Characters",
                                  "AtLeast12Characters",
                                  "AtLeast16Characters",
                                  "AtLeast24Characters",
                                  "Cookies",
                                  "UnexpiredCookies",
                                  "AuthorizationTechnology",
                                  "MalwareOnly"
                                ],
                                "type": "string"
                              }
                            },
                            "rank": {
                              "description": "A ranking of how common this password is",
                              "enum": [
                                "Top100kCommonPasswords",
                                "TopMillionCommonPasswords"
                              ],
                              "type": "string"
                            }
                          }
                        },
                        "effectively_clear": {
                          "type": "boolean"
                        },
                        "hashes": {
                          "description": "Known hashes for this secret",
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/PasswordHash"
                          }
                        },
                        "type": {
                          "type": "string"
                        }
                      }
                    },
                    "SinglePasswordLookupResult": {
                      "type": "object",
                      "properties": {
                        "exposure_status": {
                          "enum": [
                            "NeverExposed",
                            "Uncommon",
                            "Common"
                          ],
                          "type": "string"
                        },
                        "password": {
                          "$ref": "#/definitions/PasswordHash"
                        }
                      }
                    },
                    "Technology": {
                      "type": "object",
                      "properties": {
                        "category": {
                          "type": "string"
                        },
                        "id": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        }
                      }
                    }
                  },
                  "securityDefinitions": {
                    "apiKey-auth": {
                      "type": "apiKey",
                      "name": "X-RFToken",
                      "in": "header",
                      "description": "API Credential"
                    }
                  },
                  "security": [
                    {
                      "apiKey-auth": "[variables('TemplateEmptyArray')]"
                    }
                  ],
                  "tags": "[variables('TemplateEmptyArray')]",
                  "x-ms-connector-metadata": [
                    {
                      "propertyName": "Website",
                      "propertyValue": "https://www.recordedfuture.com"
                    },
                    {
                      "propertyName": "Privacy Policy",
                      "propertyValue": "https://www.recordedfuture.com/privacy-policy/"
                    },
                    {
                      "propertyName": "Categories",
                      "propertyValue": "AI;Data"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('LogicAppsCustomConnector-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "LogicAppsCustomConnector",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId1')]",
        "contentKind": "LogicAppsCustomConnector",
        "displayName": "RFI-CustomConnector-0-1-0",
        "contentProductId": "[variables('_playbookcontentProductId1')]",
        "id": "[variables('_playbookcontentProductId1')]",
        "version": "[variables('playbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RFI-add-EntraID-security-group-user Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RFI-add-EntraID-security-group-user",
              "type": "string"
            }
          },
          "variables": {
            "EntraIDConnectionName": "[[concat('EntraID-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuread')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateVersion": "1.1",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('EntraIDConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "manual": {
                      "type": "Request",
                      "kind": "Http",
                      "inputs": {
                        "method": "POST",
                        "schema": {
                          "properties": {
                            "active_directory_domain": {
                              "type": "string"
                            },
                            "active_directory_security_group_id": {
                              "type": "string"
                            },
                            "risky_user_email": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    }
                  },
                  "actions": {
                    "Add_risky_user_to_Active_Directory_security_group_for_users_at_risk": {
                      "runAfter": {
                        "Response_-_Risky_user_was_not_found_in_Active_Directory": [
                          "Skipped"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "@@odata.id": "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuread']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v1.0/groups/@{encodeURIComponent(triggerBody()?['active_directory_security_group_id'])}/members/$ref"
                      }
                    },
                    "Get_User_-_Check_if_the_user_exists_in_Active_Directory": {
                      "runAfter": {
                        "If_Active_Directory_domain_parameter_is_not_null_and_not_empty": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuread']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/v1.0/users/@{encodeURIComponent(variables('user_principal_name'))}"
                      }
                    },
                    "If_Active_Directory_domain_parameter_is_not_null_and_not_empty": {
                      "actions": {
                        "Set_Active_Directory_user_principal_name_to_user_email's_username_+_AD_domain": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "user_principal_name",
                            "value": "@{concat(split(triggerBody()?['risky_user_email'], '@')[0], '@', triggerBody()?['active_directory_domain'])}"
                          },
                          "description": "Use [user email's username + Active Directory domain] as Active Directory user principal name."
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Active_Directory_user_principal_name": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Set_Active_Directory_user_principal_name_to_user's_email": {
                            "type": "SetVariable",
                            "inputs": {
                              "name": "user_principal_name",
                              "value": "@triggerBody()?['risky_user_email']"
                            },
                            "description": "Use [user's email] as Active Directory user principal name."
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "not": {
                              "equals": [
                                "@triggerBody()?['active_directory_domain']",
                                "@null"
                              ]
                            }
                          },
                          {
                            "not": {
                              "equals": [
                                "@triggerBody()?['active_directory_domain']",
                                ""
                              ]
                            }
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Initialize_-_Active_Directory_user_principal_name": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "user_principal_name",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "Response_-_Failed_to_add_risky_user_to_AD_security_group_for_users_at_risk": {
                      "runAfter": {
                        "Response_-_Successfully_added_risky_user_to_AD_security_group_for_users_at_risk": [
                          "Skipped"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "parameters_passed": {
                              "active_directory_domain": "@triggerBody()?['active_directory_domain']",
                              "active_directory_security_group_id": "@triggerBody()?['active_directory_security_group_id']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            },
                            "user_id_in_active_directory": "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']",
                            "user_principal_name_used": "@variables('user_principal_name')"
                          },
                          "reason": "Failed to add Active Directory risky user to Active Directory security group for users at risk. Check active_directory_security_group_id parameter.",
                          "status": "Error"
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "parameters_passed": {
                                  "properties": {
                                    "active_directory_domain": {
                                      "type": "string"
                                    },
                                    "active_directory_security_group_id": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "user_id_in_active_directory": {
                                  "type": "string"
                                },
                                "user_principal_name": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "reason": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 422
                      }
                    },
                    "Response_-_Risky_user_was_not_found_in_Active_Directory": {
                      "runAfter": {
                        "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                          "Failed"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "parameters_passed": {
                              "active_directory_domain": "@triggerBody()?['active_directory_domain']",
                              "active_directory_security_group_id": "@triggerBody()?['active_directory_security_group_id']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            },
                            "user_principal_name_used": "@variables('user_principal_name')"
                          },
                          "reason": "Risky user was not found in Active Directory.",
                          "status": "Error"
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "parameters_passed": {
                                  "properties": {
                                    "active_directory_domain": {
                                      "type": "string"
                                    },
                                    "active_directory_security_group_id": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "user_principal_name_used": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "reason": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 404
                      }
                    },
                    "Response_-_Successfully_added_risky_user_to_AD_security_group_for_users_at_risk": {
                      "runAfter": {
                        "Add_risky_user_to_Active_Directory_security_group_for_users_at_risk": [
                          "Succeeded"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "parameters_passed": {
                              "active_directory_domain": "@triggerBody()?['active_directory_domain']",
                              "active_directory_security_group_id": "@triggerBody()?['active_directory_security_group_id']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            },
                            "user_id_in_active_directory": "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']",
                            "user_principal_name_used": "@variables('user_principal_name')"
                          },
                          "status": "Successfully added risky user to Active Directory security group for users at risk."
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "parameters_passed": {
                                  "properties": {
                                    "active_directory_domain": {
                                      "type": "string"
                                    },
                                    "active_directory_security_group_id": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "user_id_in_active_directory": {
                                  "type": "string"
                                },
                                "user_principal_name": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 200
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuread": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('EntraIDConnectionName'))]",
                        "connectionName": "[[variables('EntraIDConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuread')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('EntraIDConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('EntraIDConnectionName')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RFI-add-EntraID-security-group-user",
            "description": "This playbook adds a compromised user to an EntraID security group. Triage and remediation should be handled in follow up playbooks or actions.",
            "lastUpdateTime": "2024-06-11T14:25:00Z",
            "tags": [
              "Identity protection"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "Initial version",
                "notes": [
                  "Initial version"
                ]
              },
              {
                "version": "1.1",
                "title": "Updates",
                "notes": [
                  "Solution update. Change PlaybookName prefix to RFI."
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId2')]",
        "contentKind": "Playbook",
        "displayName": "RFI-add-EntraID-security-group-user",
        "contentProductId": "[variables('_playbookcontentProductId2')]",
        "id": "[variables('_playbookcontentProductId2')]",
        "version": "[variables('playbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RFI-confirm-EntraID-risky-user Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RFI-confirm-EntraID-risky-user",
              "type": "string"
            }
          },
          "variables": {
            "EntraIDConnectionName": "[[concat('EntraID-', parameters('PlaybookName'))]",
            "EntraIDIdentityProtectionConnectionName": "[[concat('EntraIDip-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuread')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureadip')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateVersion": "1.1",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('EntraIDConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('EntraIDIdentityProtectionConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "manual": {
                      "type": "Request",
                      "kind": "Http",
                      "inputs": {
                        "method": "POST",
                        "schema": {
                          "properties": {
                            "active_directory_domain": {
                              "type": "string"
                            },
                            "risky_user_email": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    }
                  },
                  "actions": {
                    "Check_if_AD_Identity_Protection_risky_users_list_contains_the_user": {
                      "runAfter": {
                        "Response_-_Risky_user_was_not_found_in_Active_Directory": [
                          "Skipped"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azureadip']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/beta/riskyUsers/@{encodeURIComponent(body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id'])}"
                      }
                    },
                    "Confirm_the_user_is_indeed_compromised": {
                      "runAfter": {
                        "Check_if_AD_Identity_Protection_risky_users_list_contains_the_user": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "userIds": [
                            "@body('Check_if_AD_Identity_Protection_risky_users_list_contains_the_user')?['id']"
                          ]
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azureadip']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/beta/riskyUsers/confirmCompromised"
                      }
                    },
                    "Get_User_-_Check_if_the_user_exists_in_Active_Directory": {
                      "runAfter": {
                        "If_Active_Directory_domain_parameter_is_not_null_and_not_empty": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuread']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/v1.0/users/@{encodeURIComponent(variables('user_principal_name'))}"
                      }
                    },
                    "If_Active_Directory_domain_parameter_is_not_null_and_not_empty": {
                      "actions": {
                        "Set_Active_Directory_user_principal_name_to_user_email's_username_+_AD_domain": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "user_principal_name",
                            "value": "@{concat(split(triggerBody()?['risky_user_email'], '@')[0], '@', triggerBody()?['active_directory_domain'])}"
                          },
                          "description": "Use [user email's username + Active Directory domain] as Active Directory user principal name."
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Active_Directory_user_principal_name": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Set_Active_Directory_user_principal_name_to_user's_email": {
                            "type": "SetVariable",
                            "inputs": {
                              "name": "user_principal_name",
                              "value": "@triggerBody()?['risky_user_email']"
                            },
                            "description": "Use [user's email] as Active Directory user principal name."
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "not": {
                              "equals": [
                                "@triggerBody()?['active_directory_domain']",
                                "@null"
                              ]
                            }
                          },
                          {
                            "not": {
                              "equals": [
                                "@triggerBody()?['active_directory_domain']",
                                ""
                              ]
                            }
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Initialize_-_Active_Directory_user_principal_name": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "user_principal_name",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "Response_-_Failed_to_confirm_user_at_risk_is_compromised": {
                      "runAfter": {
                        "Response_-_Successfully_confirmed_user_at_risk_is_indeed_compromised": [
                          "Skipped"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "active_directory_identity_protection_results_for_risky_user": "@body('Check_if_AD_Identity_Protection_risky_users_list_contains_the_user')",
                            "parameters_passed": {
                              "active_directory_domain": "@triggerBody()?['active_directory_domain']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            },
                            "user_id_in_active_directory": "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']",
                            "user_principal_name_used": "@variables('user_principal_name')"
                          },
                          "reason": "Failed to confirm user at risk is compromised. Probably your tenant is not licensed for Active Directory Identity Protection feature. You can upgrade your subscription to access this feature.",
                          "status": "Error"
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "active_directory_identity_protection_results_for_risky_user": {
                                  "type": "object"
                                },
                                "parameters_passed": {
                                  "properties": {
                                    "active_directory_domain": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "user_id_in_active_directory": {
                                  "type": "string"
                                },
                                "user_principal_name": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "reason": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 422
                      }
                    },
                    "Response_-_Risky_user_was_not_found_in_Active_Directory": {
                      "runAfter": {
                        "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                          "Failed"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "parameters_passed": {
                              "active_directory_domain": "@triggerBody()?['active_directory_domain']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            },
                            "user_principal_name_used": "@variables('user_principal_name')"
                          },
                          "reason": "Risky user was not found in Active Directory.",
                          "status": "Error"
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "parameters_passed": {
                                  "properties": {
                                    "active_directory_domain": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "user_principal_name": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "reason": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 404
                      }
                    },
                    "Response_-_Successfully_confirmed_user_at_risk_is_indeed_compromised": {
                      "runAfter": {
                        "Confirm_the_user_is_indeed_compromised": [
                          "Succeeded"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "active_directory_identity_protection_results_for_risky_user": "@body('Check_if_AD_Identity_Protection_risky_users_list_contains_the_user')",
                            "parameters_passed": {
                              "active_directory_domain": "@triggerBody()?['active_directory_domain']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            },
                            "user_id_in_active_directory": "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']",
                            "user_principal_name_used": "@variables('user_principal_name')"
                          },
                          "status": "Confirmed user at risk is indeed compromised."
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "active_directory_identity_protection_results_for_risky_user": {
                                  "type": "object"
                                },
                                "parameters_passed": {
                                  "properties": {
                                    "active_directory_domain": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "user_id_in_active_directory": {
                                  "type": "string"
                                },
                                "user_principal_name": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 200
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuread": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('EntraIDConnectionName'))]",
                        "connectionName": "[[variables('EntraIDConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuread')]"
                      },
                      "azureadip": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('EntraIDIdentityProtectionConnectionName'))]",
                        "connectionName": "[[variables('EntraIDIdentityProtectionConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureadip')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('EntraIDConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('EntraIDConnectionName')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('EntraIDIdentityProtectionConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-3')]"
                },
                "displayName": "[[variables('EntraIDIdentityProtectionConnectionName')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RFI-confirm-EntraID-risky-user",
            "description": "This playbook confirms compromise of users deemed 'high risk' by EntraID.",
            "lastUpdateTime": "2024-06-11T14:25:00Z",
            "tags": [
              "Identity protection"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "Initial version",
                "notes": [
                  "Initial version"
                ]
              },
              {
                "version": "1.1",
                "title": "Updates",
                "notes": [
                  "Solution update. Change PlaybookName prefix to RFI."
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId3')]",
        "contentKind": "Playbook",
        "displayName": "RFI-confirm-EntraID-risky-user",
        "contentProductId": "[variables('_playbookcontentProductId3')]",
        "id": "[variables('_playbookcontentProductId3')]",
        "version": "[variables('playbookVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RFI-lookup-and-save-user Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RFI-lookup-and-save-user",
              "type": "string"
            },
            "IdentityCustomConnectorName": {
              "defaultValue": "RFI-CustomConnector-0-1-0",
              "type": "string",
              "metadata": {
                "description": "Name of the logic app connector which performs Recorded Future Communication. Normaly this dont change from RFI-CustomConnector-0-1-0"
              }
            }
          },
          "variables": {
            "IdentityconnectorupdateConnectionName": "RFI-CustomConnector-0-1-0",
            "AzureloganalyticsdatacollectorConnectionName": "[[concat('Azureloganalyticsdatacollector-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('IdentityCustomConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureloganalyticsdatacollector')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "lookup_results_log_analytics_custom_log_name_default": {
                      "defaultValue": "RecordedFutureIdentity_UsersLookupResults_CL",
                      "type": "String"
                    },
                    "lookup_lookback_days_default": {
                      "defaultValue": -14,
                      "type": "Int"
                    }
                  },
                  "triggers": {
                    "manual": {
                      "type": "Request",
                      "kind": "Http",
                      "inputs": {
                        "method": "POST",
                        "schema": {
                          "properties": {
                            "lookup_lookback_days": {
                              "type": "integer"
                            },
                            "lookup_results_log_analytics_custom_log_name": {
                              "type": "string"
                            },
                            "risky_user_email": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    }
                  },
                  "actions": {
                    "Credential_Lookup_V2_-_Look_up_credential_data_for_one_or_more_users": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "filter": {
                            "first_downloaded_gte": "@{formatDateTime(addDays(utcNow(), if(equals(triggerBody()?['lookup_lookback_days'], null), parameters('lookup_lookback_days_default'), triggerBody()?['lookup_lookback_days'])), 'yyyy-MM-dd')}"
                          },
                          "subjects": [
                            "@triggerBody()?['risky_user_email']"
                          ]
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['IdentityConnectorUpdate']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v2/credentials/lookup"
                      }
                    },
                    "Response_-_Failed_to_get_Lookup_data": {
                      "runAfter": {
                        "Credential_Lookup_V2_-_Look_up_credential_data_for_one_or_more_users": [
                          "Failed"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "lookup_lookback_date": "@formatDateTime(addDays(utcNow(), if(equals(triggerBody()?['lookup_lookback_days'], null), parameters('lookup_lookback_days_default'), triggerBody()?['lookup_lookback_days'])), 'yyyy-MM-dd')",
                            "lookup_results": "@body('Credential_Lookup_V2_-_Look_up_credential_data_for_one_or_more_users')",
                            "lookup_results_log_analytics_custom_log_name": "@if(equals(triggerBody()?['lookup_results_log_analytics_custom_log_name'], null), parameters('lookup_results_log_analytics_custom_log_name_default'), triggerBody()?['lookup_results_log_analytics_custom_log_name'])",
                            "parameters_passed": {
                              "lookup_lookback_days": "@triggerBody()?['lookup_lookback_days']",
                              "lookup_results_log_analytics_custom_log_name": "@triggerBody()?['lookup_results_log_analytics_custom_log_name']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            }
                          },
                          "reason": "Failed to get Lookup data.",
                          "status": "Error"
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "lookup_lookback_date": {
                                  "type": "string"
                                },
                                "lookup_results": {
                                  "type": "object"
                                },
                                "lookup_results_log_analytics_custom_log_name": {
                                  "type": "string"
                                },
                                "parameters_passed": {
                                  "properties": {
                                    "lookup_lookback_days": {
                                      "type": "integer"
                                    },
                                    "lookup_results_log_analytics_custom_log_name": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                }
                              },
                              "type": "object"
                            },
                            "reason": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 422
                      }
                    },
                    "Response_-_Failed_to_save_Lookup_results": {
                      "runAfter": {
                        "Response_-_Successfully_saved_lookup_results_into_LogAnalytics": [
                          "Skipped"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "lookup_lookback_date": "@formatDateTime(addDays(utcNow(), if(equals(triggerBody()?['lookup_lookback_days'], null), parameters('lookup_lookback_days_default'), triggerBody()?['lookup_lookback_days'])), 'yyyy-MM-dd')",
                            "lookup_results": "@body('Credential_Lookup_V2_-_Look_up_credential_data_for_one_or_more_users')",
                            "lookup_results_log_analytics_custom_log_name": "@if(equals(triggerBody()?['lookup_results_log_analytics_custom_log_name'], null), parameters('lookup_results_log_analytics_custom_log_name_default'), triggerBody()?['lookup_results_log_analytics_custom_log_name'])",
                            "parameters_passed": {
                              "lookup_lookback_days": "@triggerBody()?['lookup_lookback_days']",
                              "lookup_results_log_analytics_custom_log_name": "@triggerBody()?['lookup_results_log_analytics_custom_log_name']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            }
                          },
                          "reason": "Failed to save Lookup results into LogAnalytics.",
                          "status": "Error"
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "lookup_lookback_date": {
                                  "type": "string"
                                },
                                "lookup_results": {
                                  "type": "object"
                                },
                                "lookup_results_log_analytics_custom_log_name": {
                                  "type": "string"
                                },
                                "parameters_passed": {
                                  "properties": {
                                    "lookup_lookback_days": {
                                      "type": "integer"
                                    },
                                    "lookup_results_log_analytics_custom_log_name": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                }
                              },
                              "type": "object"
                            },
                            "reason": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 422
                      }
                    },
                    "Response_-_Successfully_saved_lookup_results_into_LogAnalytics": {
                      "runAfter": {
                        "Send_Data_-_Save_Lookup_results_to_LogAnalytics_Custom_Log": [
                          "Succeeded"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "lookup_lookback_date": "@formatDateTime(addDays(utcNow(), if(equals(triggerBody()?['lookup_lookback_days'], null), parameters('lookup_lookback_days_default'), triggerBody()?['lookup_lookback_days'])), 'yyyy-MM-dd')",
                            "lookup_results": "@body('Credential_Lookup_V2_-_Look_up_credential_data_for_one_or_more_users')",
                            "lookup_results_log_analytics_custom_log_name": "@if(equals(triggerBody()?['lookup_results_log_analytics_custom_log_name'], null), parameters('lookup_results_log_analytics_custom_log_name_default'), triggerBody()?['lookup_results_log_analytics_custom_log_name'])",
                            "parameters_passed": {
                              "lookup_lookback_days": "@triggerBody()?['lookup_lookback_days']",
                              "lookup_results_log_analytics_custom_log_name": "@triggerBody()?['lookup_results_log_analytics_custom_log_name']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            }
                          },
                          "status": "Successfully saved risky user lookup results into LogAnalytics table."
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "lookup_lookback_date": {
                                  "type": "string"
                                },
                                "lookup_results": {
                                  "type": "object"
                                },
                                "lookup_results_log_analytics_custom_log_name": {
                                  "type": "string"
                                },
                                "parameters_passed": {
                                  "properties": {
                                    "lookup_lookback_days": {
                                      "type": "integer"
                                    },
                                    "lookup_results_log_analytics_custom_log_name": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                }
                              },
                              "type": "object"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 200
                      }
                    },
                    "Send_Data_-_Save_Lookup_results_to_LogAnalytics_Custom_Log": {
                      "runAfter": {
                        "Response_-_Failed_to_get_Lookup_data": [
                          "Skipped"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{body('Credential_Lookup_V2_-_Look_up_credential_data_for_one_or_more_users')}",
                        "headers": {
                          "Log-Type": "@{if(equals(triggerBody()?['lookup_results_log_analytics_custom_log_name'], null), parameters('lookup_results_log_analytics_custom_log_name_default'), triggerBody()?['lookup_results_log_analytics_custom_log_name'])}",
                          "time-generated-field": "@{utcNow()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azureloganalyticsdatacollector_1']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/api/logs"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "IdentityConnectorUpdate": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('IdentityconnectorupdateConnectionName'))]",
                        "connectionName": "[[variables('IdentityconnectorupdateConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('IdentityCustomConnectorName'))]"
                      },
                      "azureloganalyticsdatacollector_1": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]",
                        "connectionName": "[[variables('AzureloganalyticsdatacollectorConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureloganalyticsdatacollector')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "RFI-lookup-and-save-user",
                "hidden-SentinelTemplateVersion": "1.2",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('IdentityconnectorupdateConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('IdentityconnectorupdateConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('IdentityconnectorupdateConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureloganalyticsdatacollectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureloganalyticsdatacollectorConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_RFI-CustomConnector-0-1-0')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "RFI-lookup-and-save-user",
            "description": "This playbook gets compromise identity details from Recorded Future Identity Intelligence and saves the data for further review and analysis.",
            "prerequisites": [
              "The custom connector RFI-CustomConnector-0-1-0 have to be deployed under the same subscription.",
              "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the [documentation](https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials)"
            ],
            "postDeployment": [
              "After deployment, open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2024-06-11T14:25:00Z",
            "tags": [
              "Identity protection"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "Initial version",
                "notes": [
                  "Initial version"
                ]
              },
              {
                "version": "1.1",
                "title": "Updates",
                "notes": [
                  "Solution update. Change PlaybookName prefix to RFI."
                ]
              },
              {
                "version": "1.2",
                "title": "Identity endpoint update",
                "notes": [
                  "Updated lookup envpoint to new version. Structure of data in the lookup_results_log_analytics_custom_log_name "
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId4')]",
        "contentKind": "Playbook",
        "displayName": "RFI-lookup-and-save-user",
        "contentProductId": "[variables('_playbookcontentProductId4')]",
        "id": "[variables('_playbookcontentProductId4')]",
        "version": "[variables('playbookVersion4')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RFI-search-workforce-user Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion5')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RFI-search-workforce-user",
              "type": "string"
            },
            "workspace_name": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Microsoft Log Analytic Workspace Name"
              }
            },
            "Playbook-Name-add-EntraID-security-group-user": {
              "defaultValue": "RFI-add-EntraID-security-group-user",
              "type": "string"
            },
            "Playbook-Name-lookup-and-save-user": {
              "defaultValue": "RFI-lookup-and-save-user",
              "type": "string"
            },
            "Playbook-Name-confirm-EntraID-risky-user": {
              "defaultValue": "RFI-confirm-EntraID-risky-user",
              "type": "string"
            }
          },
          "variables": {
            "LogAnalyticsDataCollectorConnectionName": "[[concat('azureloganalyticsdatacollector-', parameters('PlaybookName'))]",
            "AzureMonitorLogsConnectionName": "[[concat('azuremonitorlogs-', parameters('PlaybookName'))]",
            "RecordedFutureIdentityConnectionName": "[[concat('recordedfutureidenti-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureloganalyticsdatacollector')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuremonitorlogs')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfutureidenti')]",
            "_connection-4": "[[variables('connection-4')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateVersion": "1.2",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('LogAnalyticsDataCollectorConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogsConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureIdentityConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "organization_domain": {
                      "defaultValue": "example.com",
                      "type": "String"
                    },
                    "search_lookback_days": {
                      "defaultValue": -14,
                      "type": "Int"
                    },
                    "credential_dumps_log_analytics_custom_log_name": {
                      "defaultValue": "RecordedFutureIdentity_LeakedCredentials_CredentialDumps_CL",
                      "type": "String"
                    },
                    "malware_logs_log_analytics_custom_log_name": {
                      "defaultValue": "RecordedFutureIdentity_LeakedCredentials_MalwareLogs_CL",
                      "type": "String"
                    },
                    "lookup_results_log_analytics_custom_log_name": {
                      "defaultValue": "RecordedFutureIdentity_UsersLookupResults_CL",
                      "type": "String"
                    },
                    "lookup_lookback_days": {
                      "defaultValue": -365,
                      "type": "Int"
                    },
                    "active_directory_domain": {
                      "defaultValue": "[variables('blanks')]",
                      "type": "String"
                    },
                    "active_directory_security_group_id": {
                      "defaultValue": "[variables('blanks')]",
                      "type": "String"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Day",
                        "interval": 1
                      },
                      "evaluatedRecurrence": {
                        "frequency": "Day",
                        "interval": 1
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "Add_Log_Analytics_Credential_dump_exposures_to_the_corresponding_array": {
                      "runAfter": {
                        "Query_Log_Analytics_for_Credential_dump_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "known_credential_dump_creds",
                        "value": "@body('Query_Log_Analytics_for_Credential_dump_exposures')?['value']"
                      }
                    },
                    "Add_Log_Analytics_Malware_log_exposures_to_the_corresponding_array": {
                      "runAfter": {
                        "Query_Log_Analytics_for_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "known_malware_log_creds",
                        "value": "@body('Query_Log_Analytics_for_Malware_log_exposures')?['value']"
                      }
                    },
                    "Credential_Search_-_Search_credential_data_for_one_or_more_domains": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "domain_type": "My Organization (workforce use case)",
                          "domains": [
                            "@parameters('organization_domain')"
                          ],
                          "filter": {
                            "latest_downloaded_gte": "@{formatDateTime(addDays(utcNow(), parameters('search_lookback_days')), 'yyyy-MM-dd')}"
                          },
                          "limit": 500
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfutureidenti']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/credentials/search"
                      }
                    },
                    "For_Each_-_Make_new_and_known_Credential_dumps_be_comparable": {
                      "foreach": "@body('Credential_Search_-_Search_credential_data_for_one_or_more_domains')?['credential_dumps']",
                      "actions": {
                        "Append_transformed_exposures_to_array": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "transformed_rf_api_credential_dump_creds",
                            "value": {
                              "email": "@items('For_Each_-_Make_new_and_known_Credential_dumps_be_comparable')"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Array_of_transformed_new_Credential_dump_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_Each_-_extend_new_exposures_array_with_new_Credential_dump_exposures": {
                      "foreach": "@variables('unknown_credential_dump_creds')",
                      "actions": {
                        "Add_new_Credential_dump_exposure_email_to_the_array_of_all_new_exposures": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "newly_leaked_emails",
                            "value": "@items('For_Each_-_extend_new_exposures_array_with_new_Credential_dump_exposures')?['email']"
                          }
                        }
                      },
                      "runAfter": {
                        "For_Each_-_extend_new_exposures_array_with_new_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_Each_-_extend_new_exposures_array_with_new_Malware_log_exposures": {
                      "foreach": "@variables('unknown_malware_log_creds')",
                      "actions": {
                        "Add_new_Malware_log_exposure_email_to_the_array_of_all_new_exposures": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "newly_leaked_emails",
                            "value": "@items('For_Each_-_extend_new_exposures_array_with_new_Malware_log_exposures')?['login']"
                          }
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Array_of_all_new_exposures_(emails)": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_Each_new_Credential_dump_exposures": {
                      "foreach": "@variables('transformed_rf_api_credential_dump_creds')",
                      "actions": {
                        "If_Credential_dump_exposure_is_new": {
                          "actions": {
                            "Add_new_exposure_to_the_new_Credential_dump_exposures_array": {
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "unknown_credential_dump_creds",
                                "value": "@items('For_Each_new_Credential_dump_exposures')"
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "contains": [
                                    "@variables('known_credential_dump_creds')",
                                    "@items('For_Each_new_Credential_dump_exposures')"
                                  ]
                                }
                              }
                            ]
                          },
                          "type": "If",
                          "description": "\"New\" - means it have not been previously seen by the Logic App."
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Array_of_new_Credential_dump_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_Each_new_Malware_log_exposures": {
                      "foreach": "@body('Credential_Search_-_Search_credential_data_for_one_or_more_domains')?['malware_logs']",
                      "actions": {
                        "If_Malware_log_exposure_is_new": {
                          "actions": {
                            "Add_new_exposure_to_the_new_Malware_log_exposures_array": {
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "unknown_malware_log_creds",
                                "value": "@items('For_Each_new_Malware_log_exposures')"
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "contains": [
                                    "@variables('known_malware_log_creds')",
                                    "@items('For_Each_new_Malware_log_exposures')"
                                  ]
                                }
                              }
                            ]
                          },
                          "type": "If",
                          "description": "\"New\" - means it have not been previously seen by the Logic App."
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Array_of_new_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_new_exposures_-_do_protective_actions": {
                      "foreach": "@variables('newly_leaked_emails')",
                      "actions": {
                        "Current_time": {
                          "type": "Expression",
                          "kind": "CurrentTime",
                          "inputs": "[variables('TemplateEmptyObject')]",
                          "description": "This block is needed only to create 3 branches in this For each loop."
                        },
                        "RFI-add-EntraID-security-group-user": {
                          "runAfter": {
                            "Current_time": [
                              "Succeeded"
                            ]
                          },
                          "type": "Workflow",
                          "inputs": {
                            "body": {
                              "active_directory_domain": "@parameters('active_directory_domain')",
                              "active_directory_security_group_id": "@parameters('active_directory_security_group_id')",
                              "risky_user_email": "@{items('For_each_new_exposures_-_do_protective_actions')}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "triggerName": "manual",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Playbook-Name-add-EntraID-security-group-user'))]"
                              }
                            }
                          }
                        },
                        "RFI-lookup-and-save-user": {
                          "runAfter": {
                            "Current_time": [
                              "Succeeded"
                            ]
                          },
                          "type": "Workflow",
                          "inputs": {
                            "body": {
                              "lookup_lookback_days": "@parameters('lookup_lookback_days')",
                              "lookup_results_log_analytics_custom_log_name": "@parameters('lookup_results_log_analytics_custom_log_name')",
                              "risky_user_email": "@{items('For_each_new_exposures_-_do_protective_actions')}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "triggerName": "manual",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Playbook-Name-lookup-and-save-user'))]"
                              }
                            }
                          }
                        },
                        "RFI-confirm-EntraID-risky-user": {
                          "runAfter": {
                            "Current_time": [
                              "Succeeded"
                            ]
                          },
                          "type": "Workflow",
                          "inputs": {
                            "body": {
                              "active_directory_domain": "@parameters('active_directory_domain')",
                              "risky_user_email": "@{items('For_each_new_exposures_-_do_protective_actions')}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "triggerName": "manual",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Playbook-Name-confirm-EntraID-risky-user'))]"
                              }
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "For_Each_-_extend_new_exposures_array_with_new_Credential_dump_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    },
                    "Initialize_-_Array_of_all_new_exposures_(emails)": {
                      "runAfter": {
                        "Send_Data_-_Save_new_Credential_dump_exposures_into_Log_Analytics_Custom_Log": [
                          "Succeeded",
                          "Skipped",
                          "TimedOut",
                          "Failed"
                        ],
                        "Send_Data_-_Save_new_Malware_log_exposures_into_Log_Analytics_Custom_Log": [
                          "Succeeded",
                          "Skipped",
                          "TimedOut",
                          "Failed"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "newly_leaked_emails",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Initialize_-_Array_of_known_Credential_dump_exposures": {
                      "runAfter": {
                        "Credential_Search_-_Search_credential_data_for_one_or_more_domains": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "known_credential_dump_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "Existing Credential dumps (collected during prior Logic App runs)"
                    },
                    "Initialize_-_Array_of_known_Malware_log_exposures": {
                      "runAfter": {
                        "Credential_Search_-_Search_credential_data_for_one_or_more_domains": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "known_malware_log_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "Existing Malware logs (collected during prior Logic App runs)"
                    },
                    "Initialize_-_Array_of_new_Credential_dump_exposures": {
                      "runAfter": {
                        "For_Each_-_Make_new_and_known_Credential_dumps_be_comparable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "unknown_credential_dump_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "\"New\" - means that this are new leaks, which weren't seen on previous runs of the logic app."
                    },
                    "Initialize_-_Array_of_new_Malware_log_exposures": {
                      "runAfter": {
                        "Add_Log_Analytics_Malware_log_exposures_to_the_corresponding_array": [
                          "Succeeded",
                          "Skipped"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "unknown_malware_log_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "Exposures that wasn't previously seen by the Logic App."
                    },
                    "Initialize_-_Array_of_transformed_new_Credential_dump_exposures": {
                      "runAfter": {
                        "Add_Log_Analytics_Credential_dump_exposures_to_the_corresponding_array": [
                          "Succeeded",
                          "Skipped"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "transformed_rf_api_credential_dump_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "New Credential dumps are formatted to enable storing and comparing them with existing Credential dumps in Log Analytics."
                    },
                    "Query_Log_Analytics_for_Credential_dump_exposures": {
                      "runAfter": {
                        "Initialize_-_Array_of_known_Credential_dump_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{parameters('credential_dumps_log_analytics_custom_log_name')}\n| project email=email_s",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/queryData",
                        "queries": {
                          "resourcegroups": "[[resourceGroup().name]",
                          "resourcename": "[[parameters('workspace_name')]",
                          "resourcetype": "Log Analytics Workspace",
                          "subscriptions": "[[subscription().subscriptionId]",
                          "timerange": "@{formatDateTime(addDays(utcNow(), parameters('search_lookback_days')), 'yyyy-MM-dd')}"
                        }
                      }
                    },
                    "Query_Log_Analytics_for_Malware_log_exposures": {
                      "runAfter": {
                        "Initialize_-_Array_of_known_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{parameters('malware_logs_log_analytics_custom_log_name')}\n| project login=login_s, domain=domain_s",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/queryData",
                        "queries": {
                          "resourcegroups": "[[resourceGroup().name]",
                          "resourcename": "[[parameters('workspace_name')]",
                          "resourcetype": "Log Analytics Workspace",
                          "subscriptions": "[[subscription().subscriptionId]",
                          "timerange": "@{formatDateTime(addDays(utcNow(), parameters('search_lookback_days')), 'yyyy-MM-dd')}"
                        }
                      }
                    },
                    "Send_Data_-_Save_new_Credential_dump_exposures_into_Log_Analytics_Custom_Log": {
                      "runAfter": {
                        "Transform_new_Credential_dump_exposures_array_into_a_JSON_object": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{outputs('Transform_new_Credential_dump_exposures_array_into_a_JSON_object')}",
                        "headers": {
                          "Log-Type": "@parameters('credential_dumps_log_analytics_custom_log_name')",
                          "time-generated-field": "@{utcNow()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/api/logs"
                      }
                    },
                    "Send_Data_-_Save_new_Malware_log_exposures_into_Log_Analytics_Custom_Log": {
                      "runAfter": {
                        "Transform_new_Malware_log_exposures_array_into_a_JSON_object": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{outputs('Transform_new_Malware_log_exposures_array_into_a_JSON_object')}",
                        "headers": {
                          "Log-Type": "@parameters('malware_logs_log_analytics_custom_log_name')",
                          "time-generated-field": "@{utcNow()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/api/logs"
                      }
                    },
                    "Transform_new_Credential_dump_exposures_array_into_a_JSON_object": {
                      "runAfter": {
                        "For_Each_new_Credential_dump_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "@variables('unknown_credential_dump_creds')"
                    },
                    "Transform_new_Malware_log_exposures_array_into_a_JSON_object": {
                      "runAfter": {
                        "For_Each_new_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "@variables('unknown_malware_log_creds')"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azureloganalyticsdatacollector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('LogAnalyticsDataCollectorConnectionName'))]",
                        "connectionName": "[[variables('LogAnalyticsDataCollectorConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureloganalyticsdatacollector')]"
                      },
                      "azuremonitorlogs": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogsConnectionName'))]",
                        "connectionName": "[[variables('AzureMonitorLogsConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuremonitorlogs')]"
                      },
                      "recordedfutureidenti": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureIdentityConnectionName'))]",
                        "connectionName": "[[variables('RecordedFutureIdentityConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfutureidenti')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('LogAnalyticsDataCollectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('LogAnalyticsDataCollectorConnectionName')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('AzureMonitorLogsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-3')]"
                },
                "displayName": "[[variables('AzureMonitorLogsConnectionName')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('RecordedFutureIdentityConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-4')]"
                },
                "displayName": "[[variables('RecordedFutureIdentityConnectionName')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId5'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId5')]",
                "contentId": "[variables('_playbookContentId5')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RFI-search-workforce-user",
            "description": "This playbook searches the Recorded Future Identity Intelligence Module for compromised workforce users.\n\nThis playbook depends on:\n- RFI-add-EntraID-security-group-user\n- RFI-confirm-EntraID-risky-user\n- RFI-lookup-and-save-user\n\n Those playbooks need to be installed **manually** before installing current playbook.",
            "lastUpdateTime": "2024-08-27T14:25:00Z",
            "tags": [
              "Identity protection"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "Initial version",
                "notes": [
                  "Initial version"
                ]
              },
              {
                "version": "1.1",
                "title": "Updates",
                "notes": [
                  "Added subscriptionId as a parameter and updated solution to match V3. Change PlaybookName prefix to RFI."
                ]
              },
              {
                "version": "1.2",
                "title": "Updates",
                "notes": [
                  "Added workspace_name as a parameter."
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId5')]",
        "contentKind": "Playbook",
        "displayName": "RFI-search-workforce-user",
        "contentProductId": "[variables('_playbookcontentProductId5')]",
        "id": "[variables('_playbookcontentProductId5')]",
        "version": "[variables('playbookVersion5')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RFI-search-external-user Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion6')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RFI-search-external-user",
              "type": "string"
            },
            "workspace_name": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Microsoft Log Analytic Workspace Name"
              }
            },
            "Playbook-Name-add-EntraID-security-group-user": {
              "defaultValue": "RFI-add-EntraID-security-group-user",
              "type": "string"
            },
            "Playbook-Name-lookup-and-save-user": {
              "defaultValue": "RFI-lookup-and-save-user",
              "type": "string"
            },
            "Playbook-Name-confirm-EntraID-risky-user": {
              "defaultValue": "RFI-confirm-EntraID-risky-user",
              "type": "string"
            }
          },
          "variables": {
            "LogAnalyticsDataCollectorConnectionName": "[[concat('azureloganalyticsdatacollector-', parameters('PlaybookName'))]",
            "AzureMonitorLogsConnectionName": "[[concat('azuremonitorlogs-', parameters('PlaybookName'))]",
            "RecordedFutureIdentityConnectionName": "[[concat('recordedfutureidenti-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureloganalyticsdatacollector')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuremonitorlogs')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfutureidenti')]",
            "_connection-4": "[[variables('connection-4')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateVersion": "1.2",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('LogAnalyticsDataCollectorConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogsConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureIdentityConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "organization_domain": {
                      "defaultValue": "example.com",
                      "type": "String"
                    },
                    "search_lookback_days": {
                      "defaultValue": -14,
                      "type": "Int"
                    },
                    "malware_logs_log_analytics_custom_log_name": {
                      "defaultValue": "RecordedFutureIdentity_LeakedCredentials_MalwareLogs_CL",
                      "type": "String"
                    },
                    "lookup_results_log_analytics_custom_log_name": {
                      "defaultValue": "RecordedFutureIdentity_UsersLookupResults_CL",
                      "type": "String"
                    },
                    "lookup_lookback_days": {
                      "defaultValue": -365,
                      "type": "Int"
                    },
                    "active_directory_domain": {
                      "defaultValue": "[variables('blanks')]",
                      "type": "String"
                    },
                    "active_directory_security_group_id": {
                      "defaultValue": "[variables('blanks')]",
                      "type": "String"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Day",
                        "interval": 1
                      },
                      "evaluatedRecurrence": {
                        "frequency": "Day",
                        "interval": 1
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "Add_Log_Analytics_Malware_log_exposures_to_the_corresponding_array": {
                      "runAfter": {
                        "Query_Log_Analytics_for_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "known_malware_log_creds",
                        "value": "@body('Query_Log_Analytics_for_Malware_log_exposures')?['value']"
                      }
                    },
                    "Credential_Search_-_Search_credential_data_for_one_or_more_domains": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "domain_type": "Customer (external use case)",
                          "domains": [
                            "@parameters('organization_domain')"
                          ],
                          "filter": {
                            "latest_downloaded_gte": "@{formatDateTime(addDays(utcNow(), parameters('search_lookback_days')), 'yyyy-MM-dd')}"
                          },
                          "limit": 500
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfutureidenti']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/credentials/search"
                      }
                    },
                    "For_Each_-_extend_new_exposures_array_with_new_Malware_log_exposures": {
                      "foreach": "@variables('unknown_malware_log_creds')",
                      "actions": {
                        "Add_new_Malware_log_exposure_email_to_the_array_of_all_new_exposures": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "newly_leaked_emails",
                            "value": "@items('For_Each_-_extend_new_exposures_array_with_new_Malware_log_exposures')?['login']"
                          }
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Array_of_all_new_exposures_(emails)": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_Each_new_Malware_log_exposures": {
                      "foreach": "@body('Credential_Search_-_Search_credential_data_for_one_or_more_domains')?['malware_logs']",
                      "actions": {
                        "If_Malware_log_exposure_is_new": {
                          "actions": {
                            "Add_new_exposure_to_the_new_Malware_log_exposures_array": {
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "unknown_malware_log_creds",
                                "value": "@items('For_Each_new_Malware_log_exposures')"
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "contains": [
                                    "@variables('known_malware_log_creds')",
                                    "@items('For_Each_new_Malware_log_exposures')"
                                  ]
                                }
                              }
                            ]
                          },
                          "type": "If",
                          "description": "\"New\" - means it have not been previously seen by the Logic App."
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Array_of_new_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_new_exposures_-_do_protective_actions": {
                      "foreach": "@variables('newly_leaked_emails')",
                      "actions": {
                        "Current_time": {
                          "type": "Expression",
                          "kind": "CurrentTime",
                          "inputs": "[variables('TemplateEmptyObject')]",
                          "description": "This block is needed only to create 3 branches in this For each loop."
                        },
                        "RFI-add-EntraID-security-group-user": {
                          "runAfter": {
                            "Current_time": [
                              "Succeeded"
                            ]
                          },
                          "type": "Workflow",
                          "inputs": {
                            "body": {
                              "active_directory_domain": "@parameters('active_directory_domain')",
                              "active_directory_security_group_id": "@parameters('active_directory_security_group_id')",
                              "risky_user_email": "@{items('For_each_new_exposures_-_do_protective_actions')}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "triggerName": "manual",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Playbook-Name-add-EntraID-security-group-user'))]"
                              }
                            }
                          }
                        },
                        "RFI-confirm-EntraID-risky-user": {
                          "runAfter": {
                            "Current_time": [
                              "Succeeded"
                            ]
                          },
                          "type": "Workflow",
                          "inputs": {
                            "body": {
                              "active_directory_domain": "@parameters('active_directory_domain')",
                              "risky_user_email": "@{items('For_each_new_exposures_-_do_protective_actions')}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "triggerName": "manual",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Playbook-Name-confirm-EntraID-risky-user'))]"
                              }
                            }
                          }
                        },
                        "RFI-lookup-and-save-user": {
                          "runAfter": {
                            "Current_time": [
                              "Succeeded"
                            ]
                          },
                          "type": "Workflow",
                          "inputs": {
                            "body": {
                              "lookup_lookback_days": "@parameters('lookup_lookback_days')",
                              "lookup_results_log_analytics_custom_log_name": "@parameters('lookup_results_log_analytics_custom_log_name')",
                              "risky_user_email": "@{items('For_each_new_exposures_-_do_protective_actions')}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "triggerName": "manual",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Playbook-Name-lookup-and-save-user'))]"
                              }
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "For_Each_-_extend_new_exposures_array_with_new_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    },
                    "Initialize_-_Array_of_all_new_exposures_(emails)": {
                      "runAfter": {
                        "Send_Data_-_Save_new_Malware_log_exposures_into_Log_Analytics_Custom_Log": [
                          "Succeeded",
                          "Skipped",
                          "TimedOut",
                          "Failed"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "newly_leaked_emails",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Initialize_-_Array_of_known_Malware_log_exposures": {
                      "runAfter": {
                        "Credential_Search_-_Search_credential_data_for_one_or_more_domains": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "known_malware_log_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "Existing Malware logs (collected during prior Logic App runs)"
                    },
                    "Initialize_-_Array_of_new_Malware_log_exposures": {
                      "runAfter": {
                        "Add_Log_Analytics_Malware_log_exposures_to_the_corresponding_array": [
                          "Succeeded",
                          "Skipped"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "unknown_malware_log_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "Exposures that wasn't previously seen by the Logic App."
                    },
                    "Query_Log_Analytics_for_Malware_log_exposures": {
                      "runAfter": {
                        "Initialize_-_Array_of_known_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{parameters('malware_logs_log_analytics_custom_log_name')}\n| project login=login_s, domain=domain_s",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/queryData",
                        "queries": {
                          "resourcegroups": "[[resourceGroup().name]",
                          "resourcename": "[[parameters('workspace_name')]",
                          "resourcetype": "Log Analytics Workspace",
                          "subscriptions": "[[subscription().subscriptionId]",
                          "timerange": "@{formatDateTime(addDays(utcNow(), parameters('search_lookback_days')), 'yyyy-MM-dd')}"
                        }
                      }
                    },
                    "Send_Data_-_Save_new_Malware_log_exposures_into_Log_Analytics_Custom_Log": {
                      "runAfter": {
                        "Transform_new_Malware_log_exposures_array_into_a_JSON_object": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{outputs('Transform_new_Malware_log_exposures_array_into_a_JSON_object')}",
                        "headers": {
                          "Log-Type": "@parameters('malware_logs_log_analytics_custom_log_name')",
                          "time-generated-field": "@{utcNow()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/api/logs"
                      }
                    },
                    "Transform_new_Malware_log_exposures_array_into_a_JSON_object": {
                      "runAfter": {
                        "For_Each_new_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "@variables('unknown_malware_log_creds')"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azureloganalyticsdatacollector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('LogAnalyticsDataCollectorConnectionName'))]",
                        "connectionName": "[[variables('LogAnalyticsDataCollectorConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureloganalyticsdatacollector')]"
                      },
                      "azuremonitorlogs": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogsConnectionName'))]",
                        "connectionName": "[[variables('AzureMonitorLogsConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuremonitorlogs')]"
                      },
                      "recordedfutureidenti": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureIdentityConnectionName'))]",
                        "connectionName": "[[variables('RecordedFutureIdentityConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfutureidenti')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('LogAnalyticsDataCollectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('LogAnalyticsDataCollectorConnectionName')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('AzureMonitorLogsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-3')]"
                },
                "displayName": "[[variables('AzureMonitorLogsConnectionName')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('RecordedFutureIdentityConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-4')]"
                },
                "displayName": "[[variables('RecordedFutureIdentityConnectionName')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId6'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId6')]",
                "contentId": "[variables('_playbookContentId6')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RFI-search-external-user",
            "description": "This playbook searches the Recorded Future Identity Intelligence Module for compromised external (customer) users.\n\nThis playbook depends on:\n- RFI-add-EntraID-security-group-user\n- RFI-confirm-EntraID-risky-user\n- RFI-lookup-and-save-user\n\n Those playbooks need to be installed **manually** before installing current playbook.",
            "lastUpdateTime": "2024-08-27T14:25:00Z",
            "tags": [
              "Identity protection"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "Initial version",
                "notes": [
                  "Initial version"
                ]
              },
              {
                "version": "1.1",
                "title": "Updates",
                "notes": [
                  "Added subscriptionId as a parameter and updated solution to match V3. Change PlaybookName prefix to RFI."
                ]
              },
              {
                "version": "1.2",
                "title": "Updates",
                "notes": [
                  "Added Log Analytic Workspace as a parameter."
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId6')]",
        "contentKind": "Playbook",
        "displayName": "RFI-search-external-user",
        "contentProductId": "[variables('_playbookcontentProductId6')]",
        "id": "[variables('_playbookcontentProductId6')]",
        "version": "[variables('playbookVersion6')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.1",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Recorded Future Identity",
        "publisherDisplayName": "Recorded Future Support Team",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>• Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Recorded%20Future%20Identity/ReleaseNotes.md\">Release Notes</a></p>\n<p>• There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p><a href=\"https://www.recordedfuture.com/\">Recorded Future</a> Identity Intelligence enables security and IT teams to detect identity compromises, for both employees and customers. To do this, Recorded Future automates the collection, analysis, and production of identity intelligence from a vast range of sources. Organizations can incorporate identity intelligence into automated workflows that regularly monitor for compromised credentials and take immediate action with applications such as Azure Active Directory and Microsoft Sentinel.\nThere are many ways organizations can utilize Recorded Future Identity Intelligence; the playbooks in this Solution are just a quick introduction to some of those ways. In particular, these playbooks include several actions that can be coordinated, or used separately. They include:</p>\n<ol>\n<li>searches for compromised workforce or external customer users</li>\n<li>looking up existing users and saving the compromised user data to a Log file</li>\n<li>confirming high risk Azure Active Directory (AAD) users</li>\n<li>adding a compromised user to an AAD security group</li>\n</ol>\n<p>For more information, see the <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Recorded%20Future%20Identity/Playbooks\">Documentation for this Solution</a>.</p>\n<p>The playbooks have internal dependencies where you have to install:</p>\n<ul>\n<li>RecordedFutureIdentity-add-EntraID-security-group-user</li>\n<li>RecordedFutureIdentity-confirm-EntraID-risky-user</li>\n<li>RecordedFutureIdentity-lookup-and-save-user</li>\n</ul>\n<p>Before:</p>\n<ul>\n<li>RecordedFutureIdentity-search-workforce-user</li>\n<li>RecordedFutureIdentity-search-external-user.</li>\n</ul>\n<p>This solution depends on underlying Microsoft technologies. Some of these dependencies either may be in Preview state or might result in additional ingestion or operational costs:</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/azure-monitor/logs/workspace-design\">Log Analytics</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/logic-apps/logic-apps-pricing\">Logic apps</a></li>\n</ul>\n<p><strong>Custom Azure Logic Apps Connectors:</strong> 1, <strong>Playbooks:</strong> 5</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/RecordedFuture.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Recorded Future Identity",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Recorded Future Premier Integrations",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Recorded Future Support Team",
          "email": "support@recordedfuture.com",
          "tier": "Partner",
          "link": "https://support.recordedfuture.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "LogicAppsCustomConnector",
              "contentId": "[variables('_RFI-CustomConnector-0-1-0')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RFI-add-EntraID-security-group-user')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RFI-confirm-EntraID-risky-user')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RFI-lookup-and-save-user')]",
              "version": "[variables('playbookVersion4')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RFI-search-workforce-user')]",
              "version": "[variables('playbookVersion5')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RFI-search-external-user')]",
              "version": "[variables('playbookVersion6')]"
            }
          ]
        },
        "firstPublishDate": "2022-09-06",
        "lastPublishDate": "2022-09-06",
        "providers": [
          "Recorded Future"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection",
            "Identity"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
