{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "logicAppName": {
      "type": "string",
      "defaultValue": "pb-cyren-to-crowdstrike"
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "Cyren_JwtToken": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Cyren CCF JWT Bearer token for authentication"
      }
    },
    "Cyren_FeedId": {
      "type": "string",
      "defaultValue": "ip_reputation",
      "metadata": {
        "description": "Cyren CCF Feed ID (e.g. ip_reputation, malware_urls)"
      }
    },
    "CrowdStrike_ClientId": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "CrowdStrike OAuth2 Client ID"
      }
    },
    "CrowdStrike_ClientSecret": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "CrowdStrike OAuth2 Client Secret"
      }
    },
    "CrowdStrike_BaseUrl": {
      "type": "string",
      "defaultValue": "https://api.crowdstrike.com",
      "metadata": {
        "description": "CrowdStrike API Base URL (e.g. https://api.crowdstrike.com or https://api.us-2.crowdstrike.com)"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('logicAppName')]",
      "location": "[parameters('location')]",
      "properties": {
        "state": "Enabled",
        "parameters": {
          "Cyren_JwtToken": {
            "value": "[parameters('Cyren_JwtToken')]"
          },
          "Cyren_FeedId": {
            "value": "[parameters('Cyren_FeedId')]"
          },
          "CrowdStrike_ClientId": {
            "value": "[parameters('CrowdStrike_ClientId')]"
          },
          "CrowdStrike_ClientSecret": {
            "value": "[parameters('CrowdStrike_ClientSecret')]"
          },
          "CrowdStrike_BaseUrl": {
            "value": "[parameters('CrowdStrike_BaseUrl')]"
          }
        },
        "definition": {
          "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "Cyren_BaseUrl": {
              "type": "string",
              "defaultValue": "https://api-feeds.cyren.com/v1/feed/data"
            },
            "Cyren_JwtToken": {
              "type": "string",
              "defaultValue": ""
            },
            "Cyren_FeedId": {
              "type": "string",
              "defaultValue": "ip_reputation"
            },
            "CrowdStrike_BaseUrl": {
              "type": "string",
              "defaultValue": "https://api.crowdstrike.com"
            },
            "CrowdStrike_ClientId": {
              "type": "string",
              "defaultValue": ""
            },
            "CrowdStrike_ClientSecret": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "triggers": {
            "Recurrence": {
              "type": "Recurrence",
              "recurrence": {
                "frequency": "Minute",
                "interval": 360,
                "timeZone": "UTC"
              }
            }
          },
          "actions": {
            "Initialize_PersistentToken": {
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "persistentToken",
                    "type": "string",
                    "value": ""
                  }
                ]
              },
              "runAfter": {}
            },
            "Initialize_ContinuePolling": {
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "continuePolling",
                    "type": "boolean",
                    "value": true
                  }
                ]
              },
              "runAfter": {
                "Initialize_PersistentToken": [
                  "Succeeded"
                ]
              }
            },
            "Get_CrowdStrike_Token": {
              "type": "Http",
              "inputs": {
                "method": "POST",
                "uri": "@{concat(parameters('CrowdStrike_BaseUrl'), '/oauth2/token')}",
                "headers": {
                  "Content-Type": "application/x-www-form-urlencoded"
                },
                "body": "client_id=@{parameters('CrowdStrike_ClientId')}&client_secret=@{parameters('CrowdStrike_ClientSecret')}"
              },
              "runAfter": {
                "Initialize_ContinuePolling": [
                  "Succeeded"
                ]
              }
            },
            "Poll_Cyren_Feed": {
              "type": "Until",
              "expression": "@equals(variables('continuePolling'), false)",
              "limit": {
                "count": 10,
                "timeout": "PT1H"
              },
              "runAfter": {
                "Get_CrowdStrike_Token": [
                  "Succeeded"
                ]
              },
              "actions": {
                "Get_Cyren_Indicators": {
                  "type": "Http",
                  "inputs": {
                    "method": "GET",
                    "uri": "@{concat(parameters('Cyren_BaseUrl'), '?feedId=', parameters('Cyren_FeedId'), '&count=1000&queryWindowInMin=360', if(equals(variables('persistentToken'), ''), '', concat('&token=', variables('persistentToken'))))}",
                    "headers": {
                      "Authorization": "@{concat('Bearer ', parameters('Cyren_JwtToken'))}",
                      "Accept": "application/json"
                    }
                  },
                  "runAfter": {}
                },
                "Check_Response_Has_Data": {
                  "type": "If",
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@length(body('Filter_Empty_Lines'))",
                          0
                        ]
                      }
                    ]
                  },
                  "runAfter": {
                    "Filter_Empty_Lines": [
                      "Succeeded"
                    ]
                  },
                  "actions": {
                    "For_Each_Indicator": {
                      "type": "Foreach",
                      "foreach": "@body('Filter_Empty_Lines')",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      },
                      "actions": {
                        "Post_IOC_to_CrowdStrike": {
                          "type": "Http",
                          "inputs": {
                            "method": "POST",
                            "uri": "@{concat(parameters('CrowdStrike_BaseUrl'), '/iocs/entities/indicators/v1?ignore_warnings=true')}",
                            "headers": {
                              "Content-Type": "application/json",
                              "Authorization": "@{concat('Bearer ', body('Get_CrowdStrike_Token')?['access_token'])}"
                            },
                            "body": {
                              "indicators": [
                                {
                                  "type": "ipv4",
                                  "value": "@{item()?['identifier']}",
                                  "action": "detect",
                                  "severity": "medium",
                                  "source": "Cyren Threat Intelligence",
                                  "description": "Cyren @{parameters('Cyren_FeedId')} | Risk: @{coalesce(item()?['detection']?['risk'], 'N/A')} | Last Seen: @{coalesce(item()?['last_seen'], 'N/A')}",
                                  "expiration": "@{addDays(utcNow(), 30)}",
                                  "platforms": [
                                    "windows",
                                    "mac",
                                    "linux"
                                  ],
                                  "tags": [
                                    "cyren",
                                    "@{parameters('Cyren_FeedId')}"
                                  ],
                                  "applied_globally": true
                                }
                              ]
                            }
                          }
                        }
                      }
                    }
                  },
                  "else": {
                    "actions": {
                      "No_Data_Stop_Polling": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "continuePolling",
                          "value": false
                        }
                      }
                    }
                  }
                },
                "Check_Pagination_Token": {
                  "type": "If",
                  "expression": {
                    "and": [
                      {
                        "less": [
                          "@length(body('Filter_Empty_Lines'))",
                          1000
                        ]
                      }
                    ]
                  },
                  "runAfter": {
                    "Check_Response_Has_Data": [
                      "Succeeded"
                    ]
                  },
                  "actions": {
                    "Update_PersistentToken": {
                      "type": "SetVariable",
                      "inputs": {
                        "name": "persistentToken",
                        "value": "@{outputs('Extract_Last_Offset')}"
                      },
                      "runAfter": {
                        "Extract_Last_Offset": [
                          "Succeeded"
                        ]
                      }
                    },
                    "Extract_Last_Offset": {
                      "type": "Compose",
                      "inputs": "@string(json(last(body('Filter_Empty_Lines')))?['offset'])",
                      "runAfter": {}
                    }
                  },
                  "else": {
                    "actions": {
                      "Stop_Polling": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "continuePolling",
                          "value": false
                        }
                      }
                    }
                  }
                },
                "Split_NDJSON_Lines": {
                  "type": "Compose",
                  "inputs": "@split(trim(string(body('Get_Cyren_Indicators'))), decodeUriComponent('%0A'))",
                  "runAfter": {
                    "Get_Cyren_Indicators": [
                      "Succeeded"
                    ]
                  }
                },
                "Filter_Empty_Lines": {
                  "type": "Query",
                  "inputs": {
                    "from": "@outputs('Split_NDJSON_Lines')",
                    "where": "@not(equals(trim(item()), ''))"
                  },
                  "runAfter": {
                    "Split_NDJSON_Lines": [
                      "Succeeded"
                    ]
                  }
                }
              }
            }
          },
          "outputs": {}
        }
      }
    }
  ]
}
