{
    "id": "MongoDBAtlasLogsAzureFunctions",
    "title": "MongoDB Atlas Logs",
    "publisher": "MongoDB",
    "descriptionMarkdown": "The [MongoDBAtlas](https://www.mongodb.com/) Logs connector gives the capability to upload MongoDB Atlas logs into Microsoft Sentinel through the MongoDB Atlas Administrdation API. Refer to the API documentation: `https://www.mongodb.com/docs/api/doc/atlas-admin-api-v2/` for more information. The connector provides the ability to get a range of process and audit log messages for the specified host for the specified project.",
    "graphQueries": [
        {
            "metricName": "Total data received",
            "legend": "MDBALogTable_CL",
            "baseQuery": "MDBALogTable_CL"
        }
    ],
    "sampleQueries": [
        {
            "description" : "MongoDB Atlas logs",
            "query": "MDBALogTable_CL\n | sort by TimeGenerated desc"
        }
    ],
    "dataTypes": [
        {
            "name": "MDBALogTable_CL",
            "lastDataReceivedQuery": "MDBALogTable_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
        }
    ],
    "connectivityCriterias": [
        {
            "type": "IsConnectedQuery",
            "value": [
                "MDBALogTable_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
            ]
        }
    ],
    "availability": {
        "status": 1,
        "isPreview": true
    },
    "permissions": {
        "resourceProvider": [
            {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                    "write": true,
                    "read": true,
                    "delete": true
                }
            },
			{
				"provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
				"permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
				"providerDisplayName": "Keys",
				"scope": "Workspace",
				"requiredPermissions": {
					"action": true
				}
			}
        ],
        "customs": [
            {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
            },            
            {
            "name": "REST API Credentials/permissions",
            "description": "MongoDB Altas service account **Client ID** and **Cient Secret** are required.  [See the documentation to learn more about creating a service account](https://www.mongodb.com/docs/atlas/configure-api-access/#grant-programmatic-access-to-an-organization)"
            }
        ]
    },
    "instructionSteps": [
        {
            "title": "",
            "description": ">**NOTE:** This connector uses Azure Functions to connect to 'MongoDB Atlas' to pull its logs into Azure Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
        },
        {
            "title": "",
            "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
        },
        {
            "title": "",
            "description": "**STEP 1 - Configuration steps for the 'MongoDB Atlas Administration API'**\n\nFollow these instructions](https://www.mongodb.com/docs/atlas/configure-api-access/#grant-programmatic-access-to-an-organization) to create a MongoDB Altas service account. Copy the Client ID and Client Secret you created. Copy also the Group ID (Project ID) and Cluster ID for later steps."
        },
        {
            "title": "",
            "description": "**STEP 2 - Choose ONE from the following two deployment options to when automatically deploying the 'MongoDB Atlas Logs' connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the 'MongoDB Atlas Logs' connector, have the Workspace ID, if you are using an existing workspace (can be copied from the following), as well as the 'MongoDB Atlas' API authorization key(s), readily available.",
            "instructions": [
                {
                    "parameters": {
                        "fillWith": [
                            "WorkspaceId"
                        ],
                        "label": "Workspace ID"
                    },
                    "type": "CopyableLabel"
                },
                {
                    "parameters": {
                        "fillWith": [
                            "PrimaryKey"
                        ],
                        "label": "Primary Key"
                    },
                    "type": "CopyableLabel"
                }
            ]
        },
        {
            "title": "",
            "description": "**Option 1 - Deployment using an existing workspace.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](<Add Link to ARM Template on https://aka.ms/threathunter GitHub repo, name template as azuredeploy_Connector_PROVIDER_NAME_APPLIANCE_NAME_AzureFunction.json>)\n2. Select the preferred **Subscription** and **Resource Group**. \n3. Click 'Yes' for 'Use existing Log Analytics Workspace?'\n\n4.Enter the **Workspace ID**, **Group ID**, **Cluster ID**, **Client ID** and **Client Secret**.\n>Note: If using Azure Key Vault secrets for any of the values above, use the`@Microsoft.KeyVault(SecretUri={Security Identifier})`schema in place of the string values. Refer to [Key Vault references documentation](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) for further details. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy."
        },
        {
            "title": "",
            "description": "**Option 2 - Deployment using a new workspace.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](<Add Link to ARM Template on https://aka.ms/threathunter GitHub repo, name template as azuredeploy_Connector_PROVIDER_NAME_APPLIANCE_NAME_AzureFunction.json>)\n2. Select the preferred **Subscription** and **Resource Group**. \n3. Click 'No' for 'Use existing Log Analytics Workspace?'\n\n4.Enter the **New workspace name**. This will be created in the selected Resource Group, **Group ID**, **Cluster ID**, **Client ID** and **Client Secret**.\n>Note: If using Azure Key Vault secrets for any of the values above, use the`@Microsoft.KeyVault(SecretUri={Security Identifier})`schema in place of the string values. Refer to [Key Vault references documentation](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) for further details. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy."
        }
    ]
}
