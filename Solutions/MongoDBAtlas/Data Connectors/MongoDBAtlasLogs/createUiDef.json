{
    "$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "MongoDB Atlas Logs",
            "steps": [
                {
                    "name": "basics",
                    "label": "Basics",
                    "elements": [
                        {
                            "name": "resourceScope",
                            "type": "Microsoft.Common.ResourceScope",
                            "location": {
                            "metadata": {
                                "hidden": "Hiding location, we get it from the log analytics workspace"
                            },
                            "visible": false
                            }
                        },
                        {
                            "name": "useExistingWorkspace",
                            "type": "Microsoft.Common.OptionsGroup",
                            "label": "Use existing Log Analytics Workspace?",
                            "defaultValue": "yes",
                            "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Yes",
                                    "value": "yes"
                                },
                                {
                                    "label": "No, create a new one",
                                    "value": "no"
                                }
                            ],
                            "required": true
                            },
                            "visible": true
                        },
                        {
                            "name": "LogAnalyticsWorkspaceResourceID",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Log Analytics Workspace Resource ID",
                            "subLabel": "",
                            "defaultValue": "/subscriptions/xxxxxxxx-xxxxxxxx-xxxxxxxx-xxxxxxxx-xxxxxxxx/resourcegroups/xxxxxxxx/providers/microsoft.operationalinsights/workspaces/xxxxxxxx",
                            "toolTip": "Azure Resource ID (NOT THE WORKSPACE ID) of the existing Log Analytics Workspace where you would like the MongoDB Atlas data and optional Function App Application Insights data to reside. This can be found by clicking the &#34;JSON View&#34; link within the Overview page of the Log Analytics workspace resource. The format is: &#34;/subscriptions/xxxxxxxx-xxxxxxxx-xxxxxxxx-xxxxxxxx-xxxxxxxx/resourcegroups/xxxxxxxx/providers/microsoft.operationalinsights/workspaces/xxxxxxxx&#34;",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": "",
                                "validations": []
                            },
                            "infoMessages": [],
                            "visible": "[equals(steps('basics').useExistingWorkspace, 'yes')]"
                        },
                        {
                            "name": "newWorkspaceName",
                            "type": "Microsoft.Common.TextBox",
                            "label": "New Workspace Name",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "Enter a name for the new Log Analytics workspace to be created.",
                            "constraints": {
                                "required": false,
                                "regex": "^[a-z0-9A-Z-]{4,63}$",
                                "validationMessage": "The name must be 4–63 characters long and contain only letters, numbers, and hyphens.",
                                "validations": []
                            },
                            "infoMessages": [],
                            "visible": "[equals(steps('basics').useExistingWorkspace, 'no')]"
                        }
                    ]
                },
                {
                    "name": "mongodb",
                    "label": "MongoDB connection",
                    "elements": [
                        {
                            "name": "schedule-text",
                            "type": "Microsoft.Common.TextBlock",
                            "options": {
                                "text": "Configure the properties used to connect to the MongoDB Atlas Administration API",
                                "link": {
                                    "label": "Learn more",
                                    "uri": "https://www.mongodb.com/docs/api/doc/atlas-admin-api-v2/operation/operation-downloadgroupclusterlog"
                                }
                            }
                        },
                        {
                            "name": "MongoDbGroupId",
                            "type": "Microsoft.Common.TextBox",
                            "label": "MongoDB Group Id",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "“The MongoDB Atlas Group Id (Project)",
                            "constraints": {
                                "required": true,
                                "regex": "^([a-f0-9]{24})$",
                                "validationMessage": "Please enter a Group Id (Project)",
                                "validations": []
                            },
                            "infoMessages": [],
                            "visible": true
                        },
                        {
                            "name": "MongoDbClusterId",
                            "type": "Microsoft.Common.TextBox",
                            "label": "MongoDB Cluster Id",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "The MongoDB Atlas Cluster Id (Hostname)",
                            "constraints": {
                                "required": true,
                                "regex": "",
                                "regex": "^[a-zA-Z0-9][a-zA-Z0-9-.]*$",
                                "validationMessage": "Please enter a Cluster Id (Hostname)",
                                "validations": []
                            },
                            "infoMessages": [],
                            "visible": true
                        },
                        {
                            "name": "MongoDbClientId",
                            "type": "Microsoft.Common.TextBox",
                            "label": "MongoDB Client Id",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "The MongoDB Atlas client id of your service account",
                            "constraints": {
                                "required": true,
                                "regex": "^[a-zA-Z0-9][a-zA-Z0-9-_]*$",
                                "validationMessage": "Please enter a client id",
                                "validations": []
                            },
                            "infoMessages": [],
                            "visible": true
                        },
                        {
                            "name": "MongoDbClientSecret",
                            "type": "Microsoft.Common.TextBox",
                            "label": "MongoDB Client Secret",
                            "defaultValue": "",
                            "toolTip": "The MongoDB Atlas client secret of your service account",
                            "constraints": {
                                "required": true,
                                "regex": "",
                                "validationMessage": "Please enter a Client Secret",
                                "validations": []
                            },
                            "visible": true
                        }
                    ]
                },
                {
                    "name": "filters",
                    "label": "MongoDB filters",
                    "elements": [
                        {
                            "name": "schedule-text",
                            "type": "Microsoft.Common.TextBlock",
                            "options": {
                                "text": "Configure which categories of log messages will be uploaded to Microsoft Sentinel.\nIf you check the box for a category then you can add an optional comma separated list (maximum 10) of IDs for that category.\nIf you leave the IDs box blank then all messages of that category will be included.\n If you enter IDs then only those IDs for that category will be uploaded to Microsoft Sentinel.",
                                "link": {
                                    "label": "Learn more",
                                    "uri": "https://www.mongodb.com/docs/manual/reference/log-messages/#filtering-by-known-log-id"
                                }
                            }
                        },
                        {
                            "name": "includeAccessLogs",
                            "type": "Microsoft.Common.CheckBox",
                            "label": "Include Access Logs",
                            "defaultValue": false
                        },
                        {
                            "name": "accessIdFilterList",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Access log IDs",
                            "defaultValue": "",
                            "visible": "[equals(steps('filters').includeAccessLogs, true)]"
                        },
                        {
                            "name": "includeNetworkLogs",
                            "type": "Microsoft.Common.CheckBox",
                            "label": "Include Network Logs",
                            "defaultValue": false
                        },
                        {
                            "name": "networkIdFilterList",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Network log IDs",
                            "defaultValue": "",
                            "visible": "[equals(steps('filters').includeNetworkLogs, true)]"
                        },
                        {
                            "name": "includeQueryLogs",
                            "type": "Microsoft.Common.CheckBox",
                            "label": "Include Query Logs",
                            "defaultValue": false
                        },
                        {
                            "name": "queryIdFilterList",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Query log IDs",
                            "defaultValue": "",
                            "visible": "[equals(steps('filters').includeQueryLogs, true)]"
                        }
                    ]
                },
                {
                    "name": "schedule",
                    "label": "Schedule",
                    "elements": [
                        {
                            "name": "schedule-text",
                            "type": "Microsoft.Common.TextBlock",
                            "options": {
                                "text": "The polling schedule at which logs will be uploaded from MongoDB Atlas into the Log Analytics workspace",
                                "link": {
                                    "label": "Learn more",
                                    "uri": "https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-timer?tabs=python-v2%2Cisolated-process%2Cnodejs-v4&pivots=programming-language-csharp#ncrontab-expressions"
                                }
                            }
                        },
                        {
                            "name": "ConnectorSchedule",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Connector Schedule",
                            "subLabel": "",
                            "defaultValue": "0 */5 * * * *",
                            "toolTip": "The polling schedule at which logs will be uploaded from MongoDB Atlas into the Log Analytics workspace",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": "",
                                "validations": []
                            },
                            "infoMessages": [],
                            "visible": true
                        }
                    ]
                }
            ]
        },
        "outputs": {
            "kind": "ResourceGroup",
            "location": "[steps('basics').resourceScope.location.name]",
            "resourceGroupId": "[steps('basics').resourceScope.resourceGroup.id]",
            "parameters": {
                "useExistingWorkspace": "[steps('basics').useExistingWorkspace]",
                "LogAnalyticsWorkspaceResourceID": "[steps('basics').LogAnalyticsWorkspaceResourceID]",
                "newWorkspaceName": "[steps('basics').newWorkspaceName]",
                "ConnectorSchedule": "[steps('schedule').ConnectorSchedule]",
                "MongoDbGroupId": "[steps('mongodb').MongoDbGroupId]",
                "MongoDbClusterId": "[steps('mongodb').MongoDbClusterId]",
                "MongoDbClientId": "[steps('mongodb').MongoDbClientId]",
                "MongoDbClientSecret": "[steps('mongodb').MongoDbClientSecret]",
                "includeAccessLogs": "[steps('filters').includeAccessLogs]",
                "accessIdFilterList": "[steps('filters').accessIdFilterList]",
                "includeNetworkLogs": "[steps('filters').includeNetworkLogs]",
                "networkIdFilterList": "[steps('filters').networkIdFilterList]",
                "includeQueryLogs": "[steps('filters').includeQueryLogs]",
                "queryIdFilterList": "[steps('filters').queryIdFilterList]"
            }
        },
        "validators": [
            {
            "kind": "Custom",
                "parameters": {
                    "expression": "[or(parameters('includeAccessLogs'), parameters('includeNetworkLogs'), parameters('includeQueryLogs'))]",
                    "message": "You must select at least one log type (Access, Network, or Query)."
                }
            }
        ]
    }
}