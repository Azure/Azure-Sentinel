{
    "$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "MongoDB Atlas Logs",
            "steps": [
                {
                    "name": "basics",
                    "label": "Basics",
                    "elements": [
                        {
                            "name": "resourceScope",
                            "type": "Microsoft.Common.ResourceScope",
                            "location": {
                            "metadata": {
                                "hidden": "Hiding location, we get it from the log analytics workspace"
                            },
                            "visible": false
                            }
                        },
                        {
                            "name": "LogAnalyticsWorkspaceResourceID",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Log Analytics Workspace Resource ID",
                            "subLabel": "",
                            "placeholder": "/subscriptions/xxxxxxxx-xxxxxxxx-xxxxxxxx-xxxxxxxx-xxxxxxxx/resourcegroups/xxxxxxxx/providers/microsoft.operationalinsights/workspaces/xxxxxxxx",
                            "toolTip": "Azure Resource ID (NOT THE WORKSPACE ID) of the existing Log Analytics Workspace where you would like the MongoDB Atlas data and optional Function App Application Insights data to reside. This can be found by clicking the &#34;JSON View&#34; link within the Overview page of the Log Analytics workspace resource. The format is: &#34;/subscriptions/xxxxxxxx-xxxxxxxx-xxxxxxxx-xxxxxxxx-xxxxxxxx/resourcegroups/xxxxxxxx/providers/microsoft.operationalinsights/workspaces/xxxxxxxx&#34;",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": "",
                                "validations": []
                            },
                            "infoMessages": []
                        }
                    ]
                },
                {
                    "name": "mongodb",
                    "label": "MongoDB connection",
                    "elements": [
                        {
                            "name": "schedule-text",
                            "type": "Microsoft.Common.TextBlock",
                            "options": {
                                "text": "Configure the properties used to connect to the MongoDB Atlas Administration API",
                                "link": {
                                    "label": "Learn more",
                                    "uri": "https://www.mongodb.com/docs/api/doc/atlas-admin-api-v2/operation/operation-downloadgroupclusterlog"
                                }
                            }
                        },
                        {
                            "name": "MongoDbGroupId",
                            "type": "Microsoft.Common.TextBox",
                            "label": "MongoDB Group Id",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "â€œThe MongoDB Atlas Group Id (Project)",
                            "constraints": {
                                "required": true,
                                "regex": "^([a-f0-9]{24})$",
                                "validationMessage": "Please enter a Group Id (Project)",
                                "validations": []
                            },
                            "infoMessages": [],
                            "visible": true
                        },
                        {
                            "name": "MongoDbClusterId",
                            "type": "Microsoft.Common.TextBox",
                            "label": "MongoDB Cluster Id (List)",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "A list of up to 10 MongoDB Atlas Cluster Id's (Hostname), each on a separate line.",
                            "multiLine": true,
                            "constraints": {
                                "required": true,
                                "regex": "^(?:(?:[a-zA-Z0-9][a-zA-Z0-9-.]*)\r?\n?){1,10}$",
                                "validationMessage": "Please enter between 1 and 10 Cluster Id's (Hostname)",
                                "validations": []
                            },
                            "infoMessages": [],
                            "visible": true
                        },
                        {
                            "name": "MongoDbClientId",
                            "type": "Microsoft.Common.TextBox",
                            "label": "MongoDB Client Id",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "The MongoDB Atlas client id of your service account",
                            "constraints": {
                                "required": true,
                                "regex": "^[a-zA-Z0-9][a-zA-Z0-9-_]*$",
                                "validationMessage": "Please enter a client id",
                                "validations": []
                            },
                            "infoMessages": [],
                            "visible": true
                        },
                        {
                            "name": "authMethod",
                            "type": "Microsoft.Common.OptionsGroup",
                            "label": "Authentication Method",
                            "defaultValue": "Client Secret",
                            "toolTip": "Choose how to provide the MongoDB client secret",
                            "constraints": {
                                "allowedValues": [
                                    {
                                        "label": "Client Secret",
                                        "value": "secret"
                                    },
                                    {
                                        "label": "Key Vault",
                                        "value": "keyvault"
                                    }
                                ],
                                "required": true
                            }
                        },
                        {
                            "name": "MongoDbClientSecret",
                            "type": "Microsoft.Common.TextBox",
                            "label": "MongoDB Client Secret",
                            "defaultValue": "",
                            "toolTip": "The MongoDB Atlas client secret of your service account",
                            "constraints": {
                                "required": "[equals(steps('mongodb').authMethod, 'secret')]",
                                "regex": "",
                                "validationMessage": "Please enter a Client Secret",
                                "validations": []
                            },
                            "visible": "[equals(steps('mongodb').authMethod, 'secret')]"
                        },
                        {
                            "name": "keyVaultName",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Key Vault Name",
                            "defaultValue": "",
                            "toolTip": "Name of existing Key Vault containing the MongoDB client secret. The secret must be named 'mongodb-client-secret'",
                            "constraints": {
                                "required": "[equals(steps('mongodb').authMethod, 'keyvault')]",
                                "regex": "^[a-zA-Z0-9-]{3,24}$",
                                "validationMessage": "Key Vault name must be 3-24 characters and contain only letters, numbers, and hyphens",
                                "validations": []
                            },
                            "visible": "[equals(steps('mongodb').authMethod, 'keyvault')]"
                        }
                    ]
                },
                {
                    "name": "filters",
                    "label": "MongoDB filters",
                    "elements": [
                        {
                            "name": "filter-text1",
                            "type": "Microsoft.Common.TextBlock",
                            "options": {
                                "text": "Configure which categories of log messages, from ACCESS, NETWORK and QUERY, will be uploaded to Microsoft Sentinel."
                            }
                        },
                        {
                            "name": "filter-text2",
                            "type": "Microsoft.Common.TextBlock",
                            "options": {
                                "text": "If you decide to include a category of log message, you can choose to include all logs in that category or filter further by ID. If you filter by ID, you can add a comma separated list of IDs (maximum 10) for that category. If you provide an include list, only logs with those IDs are uploaded. If you provide an exclude list, all logs are uploaded except the ones with the IDs you list."
                            }
                        },
                        {
                            "name": "accessLogs",
                            "type": "Microsoft.Common.Section",
                            "label": "ACCESS logs",
                            "elements": [
                                {
                                    "name": "accessLogsFilterType",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "ACCESS logs filter criteria",
                                    "defaultValue": "Include all logs in this category",
                                    "toolTip": "",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Do not include any logs in this category",
                                                "value": "none"
                                            },
                                            {
                                                "label": "Include all logs in this category",
                                                "value": "all"
                                            },
                                            {
                                                "label": "Include only these log IDs",
                                                "value": "include"
                                            },
                                            {
                                                "label": "Exclude these log IDs",
                                                "value": "exclude"
                                            }
                                        ],
                                        "required": true
                                    }
                                },
                                {
                                    "name": "accessIdIncludeFilterList",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Include only these ACCESS log IDs",
                                    "defaultValue": "",
                                    "toolTip": "If you list IDs to include, only those will be uploaded.",
                                    "constraints": {
                                        "regex": "^\\s*\\d+\\s*(,\\s*\\d+\\s*){0,9}$",
                                        "validationMessage": "Please enter a comma separated list of maximum 10 log message IDs",
                                        "required": true
                                    },
                                    "visible": "[equals(steps('filters').accessLogs.accessLogsFilterType, 'include')]"
                                },
                                {
                                    "name": "accessIdExcludeFilterList",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Exclude these ACCESS log IDs",
                                    "defaultValue": "",
                                    "toolTip": "If you list IDs to exclude, everything will be uploaded except the ones you listed.",
                                    "constraints": {
                                        "regex": "^\\s*\\d+\\s*(,\\s*\\d+\\s*){0,9}$",
                                        "validationMessage": "Please enter a comma separated list of maximum 10 log message IDs",
                                        "required": true
                                    },
                                    "visible": "[equals(steps('filters').accessLogs.accessLogsFilterType, 'exclude')]"
                                }
                            ],
                            "visible": true
                        },
                        {
                            "name": "networkLogs",
                            "type": "Microsoft.Common.Section",
                            "label": "NETWORK logs",
                            "elements": [
                                {
                                    "name": "networkLogsFilterType",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "NETWORK logs filter criteria",
                                    "defaultValue": "Include all logs in this category",
                                    "toolTip": "",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Do not include any logs in this category",
                                                "value": "none"
                                            },
                                            {
                                                "label": "Include all logs in this category",
                                                "value": "all"
                                            },
                                            {
                                                "label": "Include only these log IDs",
                                                "value": "include"
                                            },
                                            {
                                                "label": "Exclude these log IDs",
                                                "value": "exclude"
                                            }
                                        ],
                                        "required": true
                                    }
                                },
                                {
                                    "name": "networkIdIncludeFilterList",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Include only these NETWORK log IDs",
                                    "defaultValue": "",
                                    "toolTip": "If you list IDs to include, only those will be uploaded.",
                                    "constraints": {
                                        "regex": "^\\s*\\d+\\s*(,\\s*\\d+\\s*){0,9}$",
                                        "validationMessage": "Please enter a comma separated list of maximum 10 log message IDs",
                                        "required": true
                                    },
                                    "visible": "[equals(steps('filters').networkLogs.networkLogsFilterType, 'include')]"
                                },
                                {
                                    "name": "networkIdExcludeFilterList",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Exclude these NETWORK log IDs",
                                    "defaultValue": "",
                                    "toolTip": "If you list IDs to exclude, everything will be uploaded except the ones you listed.",
                                    "constraints": {
                                        "regex": "^\\s*\\d+\\s*(,\\s*\\d+\\s*){0,9}$",
                                        "validationMessage": "Please enter a comma separated list of maximum 10 log message IDs",
                                        "required": true
                                    },
                                    "visible": "[equals(steps('filters').networkLogs.networkLogsFilterType, 'exclude')]"
                                }
                            ],
                            "visible": true
                        },
                        {
                            "name": "queryLogs",
                            "type": "Microsoft.Common.Section",
                            "label": "QUERY logs",
                            "elements": [
                                {
                                    "name": "queryLogsFilterType",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "QUERY logs filter criteria",
                                    "defaultValue": "Include all logs in this category",
                                    "toolTip": "",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Do not include any logs in this category",
                                                "value": "none"
                                            },
                                            {
                                                "label": "Include all logs in this category",
                                                "value": "all"
                                            },
                                            {
                                                "label": "Include only these log IDs",
                                                "value": "include"
                                            },
                                            {
                                                "label": "Exclude these log IDs",
                                                "value": "exclude"
                                            }
                                        ],
                                        "required": true
                                    }
                                },
                                {
                                    "name": "queryIdIncludeFilterList",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Include only these QUERY log IDs",
                                    "defaultValue": "",
                                    "toolTip": "If you list IDs to include, only those will be uploaded.",
                                    "constraints": {
                                        "regex": "^\\s*\\d+\\s*(,\\s*\\d+\\s*){0,9}$",
                                        "validationMessage": "Please enter a comma separated list of maximum 10 log message IDs",
                                        "required": true
                                    },
                                    "visible": "[equals(steps('filters').queryLogs.queryLogsFilterType, 'include')]"
                                },
                                {
                                    "name": "queryIdExcludeFilterList",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Exclude these QUERY log IDs",
                                    "defaultValue": "",
                                    "toolTip": "If you list IDs to exclude, everything will be uploaded except the ones you listed.",
                                    "constraints": {
                                        "regex": "^\\s*\\d+\\s*(,\\s*\\d+\\s*){0,9}$",
                                        "validationMessage": "Please enter a comma separated list of maximum 10 log message IDs",
                                        "required": true
                                    },
                                    "visible": "[equals(steps('filters').queryLogs.queryLogsFilterType, 'exclude')]"
                                }
                            ],
                            "visible": true
                        }
                    ]
                },
                {
                    "name": "schedule",
                    "label": "Schedule",
                    "elements": [
                        {
                            "name": "schedule-text",
                            "type": "Microsoft.Common.TextBlock",
                            "options": {
                                "text": "The polling schedule at which logs will be uploaded from MongoDB Atlas into the Log Analytics workspace",
                                "link": {
                                    "label": "Learn more",
                                    "uri": "https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-timer?tabs=python-v2%2Cisolated-process%2Cnodejs-v4&pivots=programming-language-csharp#ncrontab-expressions"
                                }
                            }
                        },
                        {
                            "name": "ConnectorSchedule",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Connector Schedule",
                            "subLabel": "",
                            "defaultValue": "0 */5 * * * *",
                            "toolTip": "The polling schedule at which logs will be uploaded from MongoDB Atlas into the Log Analytics workspace",
                            "constraints": {
                                "required": false,
                                "regex": "",
                                "validationMessage": "",
                                "validations": []
                            },
                            "infoMessages": [],
                            "visible": true
                        }
                    ]
                }
            ]
        },
        "outputs": {
            "kind": "ResourceGroup",
            "location": "[steps('basics').resourceScope.location.name]",
            "resourceGroupId": "[steps('basics').resourceScope.resourceGroup.id]",
            "parameters": {
                "LogAnalyticsWorkspaceResourceID": "[steps('basics').LogAnalyticsWorkspaceResourceID]",
                "ConnectorSchedule": "[steps('schedule').ConnectorSchedule]",
                "MongoDbGroupId": "[steps('mongodb').MongoDbGroupId]",
                "MongoDbClusterId": "[steps('mongodb').MongoDbClusterId]",
                "MongoDbClientId": "[steps('mongodb').MongoDbClientId]",
                "MongoDbClientSecret": "[if(equals(steps('mongodb').authMethod, 'secret'), steps('mongodb').MongoDbClientSecret, '')]",
                "keyVaultName": "[if(equals(steps('mongodb').authMethod, 'keyvault'), steps('mongodb').keyVaultName, '')]",
                "accessLogsFilterType": "[steps('filters').accessLogs.accessLogsFilterType]",
                "accessIdFilterList": "[if(equals(steps('filters').accessLogs.accessLogsFilterType, 'include'), steps('filters').accessLogs.accessIdIncludeFilterList, steps('filters').accessLogs.accessIdExcludeFilterList)]",
                "networkLogsFilterType": "[steps('filters').networkLogs.networkLogsFilterType]",
                "networkIdFilterList": "[if(equals(steps('filters').networkLogs.networkLogsFilterType, 'include'), steps('filters').networkLogs.networkIdIncludeFilterList, steps('filters').networkLogs.networkIdExcludeFilterList)]",
                "queryLogsFilterType": "[steps('filters').queryLogs.queryLogsFilterType]",
                "queryIdFilterList": "[if(equals(steps('filters').queryLogs.queryLogsFilterType, 'include'), steps('filters').queryLogs.queryIdIncludeFilterList, steps('filters').queryLogs.queryIdExcludeFilterList)]"
            }
        }
    }
}