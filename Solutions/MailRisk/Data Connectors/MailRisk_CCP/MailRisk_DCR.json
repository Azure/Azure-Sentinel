[
  {
    "name": "MailRisk-Emails-DCR",
    "apiVersion": "2022-06-01",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "{{location}}",
    "kind": null,
    "properties": {
      "streamDeclarations": {
        "Custom-MailRiskEmailsStream": {
          "columns": [
            {
              "name": "event_id",
              "type": "int"
            },
            {
              "name": "event",
              "type": "string"
            },
            {
              "name": "email_id",
              "type": "int"
            },
            {
              "name": "company_id",
              "type": "int"
            },
            {
              "name": "created_at",
              "type": "string"
            },
            {
              "name": "email",
              "type": "string"
            }
          ]
        }
      },
      "destinations": {
        "logAnalytics": [
          {
            "workspaceResourceId": "{{workspaceResourceId}}",
            "name": "clv2ws1"
          }
        ]
      },
      "dataFlows": [
        {
          "streams": [
            "Custom-MailRiskEmailsStream"
          ],
          "destinations": [
            "clv2ws1"
          ],
          "transformKql": "source | extend email = todynamic(email) | extend TimeGenerated = now() | extend EventType = tostring(event) | extend Id = toint(email.id) | extend MessageId = tostring(email.message_id) | extend Subject = tostring(email.subject) | extend FromEmail = tostring(email.from_email) | extend FromName = tostring(email.from_name) | extend ReplyTo = tostring(email.reply_to) | extend OriginatingIP = tostring(email.originating_ip) | extend SizeBytes = toint(email.size_bytes) | extend SpamScore = toint(email.spam_score) | extend SPF = tostring(email.spf) | extend Risk = tostring(email.risk) | extend Category = tostring(email.category) | extend RiskSource = tostring(email.risk_source) | extend ReportedRisk = toint(email.reported_risk) | extend ReporterDomain = tostring(email.reporter_domain) | extend CompanyId = toint(email.company_id) | extend FeedbackRequested = tobool(email.feedback_requested) | extend FeedbackProvided = tobool(email.feedback_provided) | extend ContentStatus = tostring(email.content_status) | extend LinksCount = toint(email.links_count) | extend AttachmentsCount = toint(email.attachments_count) | extend SentAt = todatetime(email.sent_at) | extend ReportedAt = todatetime(email.reported_at) | extend AssessedAt = todatetime(email.assessed_at) | extend CheckedAt = todatetime(email.checked_at) | extend Links = todynamic(email.links) | extend Attachments = todynamic(email.attachments) | extend Headers = todynamic(email.headers) | extend Assessments = todynamic(email.assessments) | project TimeGenerated, EventType, Id, MessageId, Subject, FromEmail, FromName, ReplyTo, OriginatingIP, SizeBytes, SpamScore, SPF, Risk, Category, RiskSource, ReportedRisk, ReporterDomain, CompanyId, FeedbackRequested, FeedbackProvided, ContentStatus, LinksCount, AttachmentsCount, SentAt, ReportedAt, AssessedAt, CheckedAt, Links, Attachments, Headers, Assessments",
          "outputStream": "Custom-MailRiskEventEmails_CL"
        }
      ],
      "dataCollectionEndpointId": "{{dataCollectionEndpointId}}"
    }
  }
]
