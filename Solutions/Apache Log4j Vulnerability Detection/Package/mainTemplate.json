{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for Apache Log4j Vulnerability Detection"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Log4j Post Compromise Hunting",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook2-name": {
      "type": "string",
      "defaultValue": "Log4j Impact Assessment",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "watchlist1-id": {
      "type": "string",
      "defaultValue": "Log4j",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the watchlist"
      }
    }
  },
  "variables": {
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "_solutionName": "Apache Log4j Vulnerability Detection",
    "_solutionVersion": "3.0.1",
    "solutionId": "azuresentinel.azure-sentinel-solution-apachelog4jvulnerability",
    "_solutionId": "[variables('solutionId')]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "Log4jPostCompromiseHuntingWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "workbookVersion2": "1.0.0",
    "workbookContentId2": "Log4jImpactAssessmentWorkbook",
    "workbookId2": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId2'))]",
    "workbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId2'))))]",
    "_workbookContentId2": "[variables('workbookContentId2')]",
    "_workbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId2'),'-', variables('workbookVersion2'))))]",
    "TemplateEmptyArray": "[json('[]')]",
    "analyticRuleObject1": {
      "analyticRuleVersion1": "1.0.2",
      "_analyticRulecontentId1": "3d71fc38-f249-454e-8479-0a358382ef9a",
      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '3d71fc38-f249-454e-8479-0a358382ef9a')]",
      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('3d71fc38-f249-454e-8479-0a358382ef9a')))]",
      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','3d71fc38-f249-454e-8479-0a358382ef9a','-', '1.0.2')))]"
    },
    "analyticRuleObject2": {
      "analyticRuleVersion2": "1.0.3",
      "_analyticRulecontentId2": "2de8abd6-a613-450e-95ed-08e503369fb3",
      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2de8abd6-a613-450e-95ed-08e503369fb3')]",
      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('2de8abd6-a613-450e-95ed-08e503369fb3')))]",
      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','2de8abd6-a613-450e-95ed-08e503369fb3','-', '1.0.3')))]"
    },
    "analyticRuleObject3": {
      "analyticRuleVersion3": "2.0.4",
      "_analyticRulecontentId3": "6e575295-a7e6-464c-8192-3e1d8fd6a990",
      "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '6e575295-a7e6-464c-8192-3e1d8fd6a990')]",
      "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('6e575295-a7e6-464c-8192-3e1d8fd6a990')))]",
      "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','6e575295-a7e6-464c-8192-3e1d8fd6a990','-', '2.0.4')))]"
    },
    "analyticRuleObject4": {
      "analyticRuleVersion4": "1.0.7",
      "_analyticRulecontentId4": "29283b22-a1c0-4d16-b0a9-3460b655a46a",
      "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '29283b22-a1c0-4d16-b0a9-3460b655a46a')]",
      "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('29283b22-a1c0-4d16-b0a9-3460b655a46a')))]",
      "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','29283b22-a1c0-4d16-b0a9-3460b655a46a','-', '1.0.7')))]"
    },
    "huntingQueryObject1": {
      "huntingQueryVersion1": "1.0.4",
      "_huntingQuerycontentId1": "1d4d383e-0ca6-4d3a-a861-8f37aeef18cb",
      "huntingQueryTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('1d4d383e-0ca6-4d3a-a861-8f37aeef18cb')))]"
    },
    "huntingQueryObject2": {
      "huntingQueryVersion2": "1.0.0",
      "_huntingQuerycontentId2": "19abc034-139e-4e64-a05d-cb07ce8b003b",
      "huntingQueryTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('19abc034-139e-4e64-a05d-cb07ce8b003b')))]"
    },
    "huntingQueryObject3": {
      "huntingQueryVersion3": "1.0.3",
      "_huntingQuerycontentId3": "e178baf5-3cf3-4960-8ca4-8da6d90d8206",
      "huntingQueryTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('e178baf5-3cf3-4960-8ca4-8da6d90d8206')))]"
    },
    "huntingQueryObject4": {
      "huntingQueryVersion4": "1.0.3",
      "_huntingQuerycontentId4": "38cc38c3-bd6c-470e-ae1a-3136a9ded97f",
      "huntingQueryTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('38cc38c3-bd6c-470e-ae1a-3136a9ded97f')))]"
    },
    "huntingQueryObject5": {
      "huntingQueryVersion5": "1.0.3",
      "_huntingQuerycontentId5": "020b05d3-6447-402c-87b6-f8faff7c7e19",
      "huntingQueryTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('020b05d3-6447-402c-87b6-f8faff7c7e19')))]"
    },
    "huntingQueryObject6": {
      "huntingQueryVersion6": "1.0.3",
      "_huntingQuerycontentId6": "3e43fe23-c6c0-45ca-b680-263e8afada95",
      "huntingQueryTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('3e43fe23-c6c0-45ca-b680-263e8afada95')))]"
    },
    "huntingQueryObject7": {
      "huntingQueryVersion7": "1.0.3",
      "_huntingQuerycontentId7": "78882f9a-f3ef-4010-973c-3f6336f5bef7",
      "huntingQueryTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('78882f9a-f3ef-4010-973c-3f6336f5bef7')))]"
    },
    "huntingQueryObject8": {
      "huntingQueryVersion8": "1.0.2",
      "_huntingQuerycontentId8": "6fee32b3-3271-4a3f-9b01-dbd9432a1707",
      "huntingQueryTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('6fee32b3-3271-4a3f-9b01-dbd9432a1707')))]"
    },
    "huntingQueryObject9": {
      "huntingQueryVersion9": "1.0.2",
      "_huntingQuerycontentId9": "09e45ec6-ac42-4b5a-be69-54623c4aa062",
      "huntingQueryTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('09e45ec6-ac42-4b5a-be69-54623c4aa062')))]"
    },
    "huntingQueryObject10": {
      "huntingQueryVersion10": "1.0.2",
      "_huntingQuerycontentId10": "bf094505-fd2e-484f-b72a-acd79ee00ce8",
      "huntingQueryTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('bf094505-fd2e-484f-b72a-acd79ee00ce8')))]"
    },
    "BatchImport": "BatchImport",
    "_BatchImport": "[variables('BatchImport')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "BatchImport",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookId1": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId1'))))]",
    "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
    "IndicateProcessor": "IndicateProcessor",
    "_IndicateProcessor": "[variables('IndicateProcessor')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "IndicateProcessor",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))))]",
    "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
    "Campaign": "Campaign",
    "_Campaign": "[variables('Campaign')]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Log4jPostCompromiseHunting Workbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "This hunting workbook is intended to help identify activity related to the Log4j compromise discovered in December 2021."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Log4j Post Compromise Hunting\\n---\\n\\nThis hunting workbook is intended to help identify activity related to the Log4j compromise discovered in December 2021.<br>\\nMore details can be found in the following reports:\\n - https://msrc-blog.microsoft.com/2021/12/11/microsofts-response-to-cve-2021-44228-apache-log4j2/\"},\"name\":\"text - 2\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"2d961dc0-1459-4406-8958-6260fec61361\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"FindTrace\",\"subTarget\":\"FindTrace\",\"style\":\"link\"},{\"id\":\"fbc91177-748c-4880-946a-b5d014e32aa6\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"SecurityNestedRecommendation\",\"subTarget\":\"SecurityNestedRecommendation\",\"style\":\"link\"},{\"id\":\"c2a98db3-8b74-459d-a4f5-c61ab64b7756\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"AzureDiagnostics\",\"subTarget\":\"AzureDiagnostics\",\"style\":\"link\"},{\"id\":\"bafb8fbb-3d10-43d7-97ea-808d17742c52\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"MultipleDataSources\",\"subTarget\":\"MultipleDataSources\",\"style\":\"link\"},{\"id\":\"e7ed0b51-0c07-4189-a0bf-d64f97e0a124\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Syslog\",\"subTarget\":\"Syslog\",\"style\":\"link\"}]},\"name\":\"links - 6\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## FindTrace\\r\\n\\r\\n\\r\\nThis tab is useful to find out any occuranes of the collected IOC in the existing workspace.\\r\\nThis loads the list of curated IOCs listed in \\r\\n\\r\\nhttps://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Log4j_IOC_List.csv\\r\\n\\r\\nBased on the selection of one it loads the tables having any occurance of the selected IOCs.\\r\\n\\r\\nBased on a table selected it loads the raw logs from the table.\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"064d84aa-3004-4950-af39-59e04c0c4c68\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"timeframe\",\"label\":\"Hunting Time Frame\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":2592000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"30\",\"name\":\"parameters - 1\"},{\"type\":1,\"content\":{\"json\":\"Set the timeframe you wish to hunt in using the dropdown to the right.\\r\\nNote that using a large timeframe may cause queries to timeout depending on the size of your environment. If you have difficulties try reducing your timeframe.\",\"style\":\"info\"},\"customWidth\":\"70\",\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let IPList = externaldata(IPAddress:string)[@\\\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Log4j_IOC_List.csv\\\"] with (format=\\\"csv\\\", ignoreFirstRecord=True);\\r\\nIPList\",\"size\":2,\"title\":\"IOC List\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"timeframe\",\"exportFieldName\":\"IPAddress\",\"exportParameterName\":\"selectedIP\",\"exportDefaultValue\":\"0.0.0.0\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"rowLimit\":10000,\"filter\":true}},\"customWidth\":\"15\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"search \\\"{selectedIP}\\\"\\r\\n| distinct  $table\\r\\n| project-rename TableName = $table\",\"size\":2,\"title\":\"Find Trace for {selectedIP}\",\"noDataMessage\":\"No Trace found of this IP Address\",\"noDataMessageStyle\":3,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"timeframe\",\"exportFieldName\":\"TableName\",\"exportParameterName\":\"selectedTable\",\"exportDefaultValue\":\"None\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"filter\":true}},\"customWidth\":\"25\",\"conditionalVisibility\":{\"parameterName\":\"selectedIP\",\"comparison\":\"isNotEqualTo\",\"value\":\"0.0.0.0\"},\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{selectedTable}\\r\\n| search \\\"{selectedIP}\\\"\",\"size\":2,\"title\":\"Traces in {selectedTable}\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"rowLimit\":10000,\"filter\":true}},\"customWidth\":\"60\",\"conditionalVisibilities\":[{\"parameterName\":\"selectedTable\",\"comparison\":\"isNotEqualTo\",\"value\":\"None\"},{\"parameterName\":\"selectedIP\",\"comparison\":\"isNotEqualTo\",\"value\":\"0.0.0.0\"}],\"name\":\"query - 6\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"FindTrace\"},\"name\":\"group - 5 - Copy\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## SecurityNestedRecommendation\\r\\n------------------------\\r\\n\\r\\n  This section uses the Azure Defender Security Nested Recommendations data to find machines vulnerable to log4j CVE-2021-44228. Log4j is an open-source Apache logging library that is used in \\r\\n   many Java-based applications. Security Nested Recommendations data is sent to Microsoft Sentinel using the continuous export feature of Azure Defender(refrence link below).\\r\\n   \\r\\n   Reference: https://msrc-blog.microsoft.com/2021/12/11/microsofts-response-to-cve-2021-44228-apache-log4j2/\\r\\n\\r\\n   Reference: https://docs.microsoft.com/azure/security-center/continuous-export?tabs=azure-portal\\r\\n   \\r\\n   Reference: https://techcommunity.microsoft.com/t5/microsoft-defender-for-cloud/how-defender-for-cloud-displays-machines-affected-by-log4j/ba-p/3037271'\\r\\n\"},\"name\":\"text - 6\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"ea3c6cdf-3199-4b98-845f-cfdba057542f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"timeframe\",\"label\":\"Hunting Timeframe\",\"type\":4,\"description\":\"Used to set the scope of other queries\",\"value\":{\"durationMs\":2592000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"30\",\"name\":\"parameters - 0\"},{\"type\":1,\"content\":{\"json\":\"Set the timeframe you wish to hunt in using the dropdown to the right.\\r\\nNote that using a large timeframe may cause queries to timeout depending on the size of your environment. If you have difficulties try reducing your timeframe.\",\"style\":\"info\"},\"customWidth\":\"70\",\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityNestedRecommendation\\r\\n  | where RemediationDescription has 'CVE-2021-44228'\\r\\n  | parse ResourceDetails with * 'virtualMachines/' VirtualMAchine '\\\"' *\\r\\n  | summarize arg_min(TimeGenerated, *) by TenantId, RecommendationSubscriptionId, VirtualMAchine, RecommendationName,Description,RemediationDescription, tostring(AdditionalData),VulnerabilityId\",\"size\":0,\"title\":\"Vulnerable Machines related to log4j CVE-2021-44228\",\"noDataMessage\":\"No user signins in the timeframe set.\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"timeframe\",\"exportedParameters\":[{\"fieldName\":\"IPAddress\",\"parameterName\":\"ip_addr\",\"parameterType\":1},{\"fieldName\":\"UserPrincipalName\",\"parameterName\":\"upn\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Vulnerable Machines related to log4j CVE-2021-44228\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"SecurityNestedRecommendation\"},\"name\":\"SecurityNestedRecommendation\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"AzureDiagnostics\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Azure Diagnostics\\r\\n------------------------\\r\\n\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"46282188-a54e-4ff0-a5eb-9d4ef712d9e9\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"timeframe\",\"label\":\"Hunting Time Frame\",\"type\":4,\"description\":\"Used to time scope the subsequent hunting queries\",\"isRequired\":true,\"value\":{\"durationMs\":2592000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"30\",\"name\":\"parameters - 1\"},{\"type\":1,\"content\":{\"json\":\"Set the timeframe you wish to hunt in using the dropdown to the right.\\r\\nNote that using a large timeframe may cause queries to timeout depending on the size of your environment. If you have difficulties try reducing your timeframe.\",\"style\":\"info\"},\"customWidth\":\"70\",\"name\":\"text - 2\"},{\"type\":1,\"content\":{\"json\":\"## Azure WAF matching for Log4j vuln(CVE-2021-44228)\\r\\n\\r\\nThis query will alert on a positive pattern match by Azure WAF for CVE-2021-44228 log4j vulnerability exploitation attempt. If possible, it then decodes the malicious command for further analysis.\\r\\n   Refrence: https://www.microsoft.com/security/blog/2021/12/11/guidance-for-preventing-detecting-and-hunting-for-cve-2021-44228-log4j-2-exploitation/\"},\"name\":\"text - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureDiagnostics\\r\\n  | where details_data_s has \\\"jndi:\\\"\\r\\n  | parse details_data_s with * '${' MaliciousCommand '}' *\\r\\n  | extend EncodeCmd = iff(MaliciousCommand has 'Base64/', split(split(MaliciousCommand, \\\"Base64/\\\",1)[0], \\\"}\\\", 0)[0], \\\"\\\")\\r\\n  | extend EncodeCmd1 = iff(MaliciousCommand has 'base64/', split(split(MaliciousCommand, \\\"base64/\\\",1)[0], \\\"}\\\", 0)[0], \\\"\\\")\\r\\n  | extend CmdLine = iff( isnotempty(EncodeCmd), EncodeCmd, EncodeCmd1)\\r\\n  | extend DecodedCmdLine = base64_decode_tostring(tostring(CmdLine))\\r\\n  | extend DecodedCmdLine = iff( isnotempty(DecodedCmdLine), DecodedCmdLine, \\\"Unable to decode\\\")\\r\\n  | project TimeGenerated, Target=hostname_s, MaliciousHost = clientIp_s, MaliciousCommand, details_data_s, DecodedCmdLine, Message, ruleSetType_s, OperationName, SubscriptionId, details_message_s, details_file_s\\r\\n\",\"size\":0,\"title\":\"Applications or Service Principals with new Key Credentials Added.\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"timeframe\",\"exportedParameters\":[{\"fieldName\":\"AppId\",\"parameterName\":\"app_id_1\",\"parameterType\":1},{\"fieldName\":\"InitiatingUser\",\"parameterName\":\"init_user\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 3\"},{\"type\":1,\"content\":{\"json\":\"## WAF_log4j_vulnerability\\r\\n\\r\\nThis hunting query looks in Azure Web Application Firewall data to find possible exploitation attempts for CVE-2021-44228 involving log4j vulnerability.\\r\\n   Refrence: https://www.microsoft.com/security/blog/2021/12/11/guidance-for-preventing-detecting-and-hunting-for-cve-2021-44228-log4j-2-exploitation/\\r\\n\"},\"name\":\"text - 16\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let log4jcmdstring = dynamic([\\\"${jndi:ldap\\\",\\\"${jndi:dns\\\",\\\"${jndi:rmi\\\",\\\"${jndi:corba\\\",\\\"${jndi:iiop\\\",\\\"${jndi:nis\\\",\\\"${jndi:nds\\\"]);\\r\\n  let log4jRegex = @'(\\\\\\\\$|%24)(\\\\\\\\{|%7B)([^jJ]*[jJ])([^nN]*[nN])([^dD]*[dD])([^iI]*[iI])(:|%3A|\\\\\\\\$|%24|}|%7D)';\\r\\n  AzureDiagnostics\\r\\n  | where Category in (\\\"FrontdoorWebApplicationFirewallLog\\\", \\\"FrontdoorAccessLog\\\", \\\"ApplicationGatewayFirewallLog\\\", \\\"ApplicationGatewayAccessLog\\\")\\r\\n  //The regex and the string matching look for the most common attacks. This is not supposed to be comprehensive.\\r\\n  | where originalRequestUriWithArgs_s has_any (log4jcmdstring) or originalRequestUriWithArgs_s matches regex log4jRegex or userAgent_s has_any (log4jcmdstring) or  userAgent_s matches regex log4jRegex\\r\\n  | extend CmdLine = iff(originalRequestUriWithArgs_s has 'Base64/', split(split(originalRequestUriWithArgs_s, \\\"Base64/\\\",1)[0], \\\"}\\\", 0)[0], split(split(userAgent_s, \\\"Base64/\\\",1)[0], \\\"}\\\", 0)[0])\\r\\n  | extend CmdLine = base64_decode_tostring(tostring(CmdLine))\\r\\n  | where CmdLine has_any (\\\"wget\\\",\\\"curl\\\")\\r\\n  | summarize Total = count() by originalRequestUriWithArgs_s, userAgent_s, clientIP_s,clientPort_d, TimeGenerated, host_s, requestUri_s, httpStatus_d,listenerName_s, CmdLine, httpMethod_s, Category\",\"size\":0,\"title\":\"Azure WAF Log4j CVE-2021-44228 hunting\",\"noDataMessage\":\"No Service Principals Added to Groups in Timeframe\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"timeframe\",\"exportedParameters\":[{\"fieldName\":\"TargetUserId\",\"parameterName\":\"target_id\",\"parameterType\":1},{\"fieldName\":\"GroupName\",\"parameterName\":\"group\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 4\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"AzureDiagnostics\"},\"name\":\"group - 3\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## MultipleDataSources\\r\\n\\r\\nThis query uses various log sources having user agent data to look for log4j CVE-2021-44228 exploitation attempt based on user agent pattern. Log4j is an open-source Apache logging library that is used in \\r\\n   many Java-based applications. The regex and the string matching look for the most common attacks. This might not be comprehensive to detect every possible user agent variation.\\r\\n   Reference: https://msrc-blog.microsoft.com/2021/12/11/microsofts-response-to-cve-2021-44228-apache-log4j2/\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"9825da9b-9932-4b35-b6dc-26aa29a58913\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"timeframe\",\"label\":\"Hunting Time Frame\",\"type\":4,\"value\":{\"durationMs\":2592000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"30\",\"name\":\"parameters - 2\"},{\"type\":1,\"content\":{\"json\":\"Set the timeframe you wish to hunt in using the dropdown to the right.\\r\\nNote that using a large timeframe may cause queries to timeout depending on the size of your environment. If you have difficulties try reducing your timeframe.\\r\\n\\r\\n\",\"style\":\"info\"},\"customWidth\":\"70\",\"name\":\"text - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let UserAgentString = dynamic ([\\\"${jndi:ldap:/\\\", \\\"${jndi:rmi:/\\\", \\\"${jndi:ldaps:/\\\", \\\"${jndi:dns:/\\\", \\\"${jndi:iiop:/\\\",\\\"${jndi:\\\",\\\"${jndi:nds:/\\\",\\\"${jndi:corba/\\\"]);\\r\\n  let UARegex = @'(\\\\\\\\$|%24)(\\\\\\\\{|%7B)([^jJ]*[jJ])([^nN]*[nN])([^dD]*[dD])([^iI]*[iI])(:|%3A|\\\\\\\\$|%24|}|%7D)';\\r\\n  (union isfuzzy=true\\r\\n  (OfficeActivity\\r\\n  | where UserAgent has_any (UserAgentString) or UserAgent matches regex UARegex\\r\\n  | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = ClientIP, Account = UserId, Type, Operation\\r\\n  | extend timestamp = StartTime, AccountCustomEntity = Account, IPCustomEntity = SourceIP\\r\\n  ),\\r\\n  (AzureDiagnostics\\r\\n  | where Category in (\\\"FrontdoorWebApplicationFirewallLog\\\", \\\"FrontdoorAccessLog\\\", \\\"ApplicationGatewayFirewallLog\\\", \\\"ApplicationGatewayAccessLog\\\")\\r\\n  | where userAgent_s has_any (UserAgentString) or userAgent_s matches regex UARegex\\r\\n  | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent = userAgent_s, SourceIP = clientIP_s, Type, host_s, requestUri_s, httpStatus_d\\r\\n  | extend timestamp = StartTime, IPCustomEntity = SourceIP, UrlCustomEntity = requestUri_s\\r\\n  ),\\r\\n  (\\r\\n  W3CIISLog\\r\\n  | where csUserAgent has_any (UserAgentString) or csUserAgent matches regex UARegex\\r\\n  | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent = csUserAgent, SourceIP = cIP, Account = csUserName, Type, sSiteName, csMethod, csUriStem\\r\\n  | extend timestamp = StartTime, AccountCustomEntity = Account, IPCustomEntity = SourceIP, UrlCustomEntity = csUriStem\\r\\n  ),\\r\\n  (\\r\\n  AWSCloudTrail\\r\\n  | where UserAgent has_any (UserAgentString) or UserAgent matches regex UARegex\\r\\n  | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = SourceIpAddress, Account = UserIdentityUserName, Type, EventName\\r\\n  | extend timestamp = StartTime, AccountCustomEntity = Account, IPCustomEntity = SourceIP\\r\\n  ),\\r\\n  (SigninLogs\\r\\n  | where UserAgent has_any (UserAgentString) or UserAgent matches regex UARegex\\r\\n  | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = IPAddress, Account = UserPrincipalName, Type, Operation = OperationName, tostring(LocationDetails), tostring(DeviceDetail),    AppDisplayName, ClientAppUsed\\r\\n  | extend timestamp = StartTime, AccountCustomEntity = Account, IPCustomEntity = SourceIP\\r\\n  ),\\r\\n  (AADNonInteractiveUserSignInLogs \\r\\n  | where UserAgent has_any (UserAgentString) or UserAgent matches regex UARegex\\r\\n  | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = IPAddress, Account = UserPrincipalName, Type, Operation = OperationName, tostring(LocationDetails), tostring(DeviceDetail), AppDisplayName, ClientAppUsed\\r\\n  | extend timestamp = StartTime, AccountCustomEntity = Account, IPCustomEntity = SourceIP\\r\\n  ),\\r\\n  (imWebSessions\\r\\n  | where HttpUserAgent has_any (UserAgentString) or HttpUserAgent matches regex UARegex\\r\\n  | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by HttpUserAgent, SourceIP = SrcIpAddr, DstIpAddr, Account = SrcUsername, URL, Type\\r\\n  | extend timestamp = StartTime, AccountCustomEntity = Account, IPCustomEntity = SourceIP, UrlCustomEntity = URL\\r\\n  ),\\r\\n  (imNetworkSession\\r\\n  | where HttpUserAgent has_any (UserAgentString) or HttpUserAgent matches regex UARegex\\r\\n  | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by HttpUserAgent, SourceIP = SrcIpAddr, DstIpAddr, Account = SrcUsername, Type, Url\\r\\n  | extend timestamp = StartTime, AccountCustomEntity = Account, IPCustomEntity = SourceIP, UrlCustomEntity = Url\\r\\n  )\\r\\n  )\",\"size\":0,\"title\":\"User agent search for log4j exploitation attempt\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"MultipleDataSources\"},\"name\":\"group - 4\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Syslog\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Syslog\\r\\n\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"064d84aa-3004-4950-af39-59e04c0c4c68\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"timeframe\",\"label\":\"Hunting Time Frame\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":2592000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"30\",\"name\":\"parameters - 1\"},{\"type\":1,\"content\":{\"json\":\"Set the timeframe you wish to hunt in using the dropdown to the right.\\r\\nNote that using a large timeframe may cause queries to timeout depending on the size of your environment. If you have difficulties try reducing your timeframe.\",\"style\":\"info\"},\"customWidth\":\"70\",\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Syslog\\r\\n  | where Facility == 'user'\\r\\n  | where SyslogMessage has \\\"AUOMS_EXECVE\\\"\\r\\n  | where SyslogMessage has 'jndi' and SyslogMessage has_any ('ldap', 'dns', 'rmi', 'corba', 'iiop', 'nis', 'nds')\\r\\n  | parse SyslogMessage with \\\"type=\\\" EventType \\\" audit(\\\" * \\\"): \\\" EventData\\r\\n  | where EventType =~ \\\"AUOMS_EXECVE\\\"\\r\\n  | project TimeGenerated, EventType, Computer, EventData\\r\\n  | parse EventData with * \\\"syscall=\\\" syscall \\\" syscall_r=\\\" * \\\" success=\\\" success \\\" exit=\\\" exit \\\" a0\\\" * \\\" ppid=\\\" ppid \\\" pid=\\\" pid \\\" audit_user=\\\" audit_user \\\" auid=\\\" auid \\\" user=\\\" user \\\" uid=\\\" uid \\\" group=\\\" group \\\" gid=\\\" gid \\\"effective_user=\\\" effective_user \\\" euid=\\\" euid \\\" set_user=\\\" set_user \\\" suid=\\\" suid \\\" filesystem_user=\\\" filesystem_user \\\" fsuid=\\\" fsuid \\\" effective_group=\\\" effective_group \\\" egid=\\\" egid \\\" set_group=\\\" set_group \\\" sgid=\\\" sgid \\\" filesystem_group=\\\" filesystem_group \\\" fsgid=\\\" fsgid \\\" tty=\\\" tty \\\" ses=\\\" ses \\\" comm=\\\\\\\"\\\" comm \\\"\\\\\\\" exe=\\\\\\\"\\\" exe \\\"\\\\\\\"\\\" * \\\"cwd=\\\\\\\"\\\" cwd \\\"\\\\\\\"\\\" * \\\"name=\\\\\\\"\\\" name \\\"\\\\\\\"\\\" * \\\"cmdline=\\\\\\\"\\\" cmdline \\\"\\\\\\\" containerid=\\\" containerid\\r\\n  | where comm has_any (\\\"wget\\\",\\\"curl\\\")\\r\\n  | where cmdline has_any (\\\"${jndi:ldap\\\",\\\"${jndi:dns\\\",\\\"${jndi:rmi\\\",\\\"${jndi:corba\\\",\\\"${jndi:iiop\\\",\\\"${jndi:nis\\\", \\\"${jndi:nds\\\")\\r\\n  | project TimeGenerated, Computer, audit_user, user, cmdline\\r\\n  | extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated\\r\\n  | sort by TimeGenerated desc\",\"size\":0,\"title\":\"Possible exploitation of Apache log4j component detected\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Syslog\\r\\n  | where Facility == 'user'\\r\\n  | where SyslogMessage has \\\"AUOMS_EXECVE\\\"\\r\\n  | parse SyslogMessage with \\\"type=\\\" EventType \\\" audit(\\\" * \\\"): \\\" EventData\\r\\n  | where EventType =~ \\\"AUOMS_EXECVE\\\"\\r\\n  | parse EventData with * \\\"syscall=\\\" syscall \\\" syscall_r=\\\" * \\\" success=\\\" success \\\" exit=\\\" exit \\\" a0\\\" * \\\" ppid=\\\" ppid \\\" pid=\\\" pid \\\" audit_user=\\\" audit_user \\\" auid=\\\" auid \\\" user=\\\" user \\\" uid=\\\" uid \\\" group=\\\" group \\\" gid=\\\" gid \\\"effective_user=\\\" effective_user \\\" euid=\\\" euid \\\" set_user=\\\" set_user \\\" suid=\\\" suid \\\" filesystem_user=\\\" filesystem_user \\\" fsuid=\\\" fsuid \\\" effective_group=\\\" effective_group \\\" egid=\\\" egid \\\" set_group=\\\" set_group \\\" sgid=\\\" sgid \\\" filesystem_group=\\\" filesystem_group \\\" fsgid=\\\" fsgid \\\" tty=\\\" tty \\\" ses=\\\" ses \\\" comm=\\\\\\\"\\\" comm \\\"\\\\\\\" exe=\\\\\\\"\\\" exe \\\"\\\\\\\"\\\" * \\\"cwd=\\\\\\\"\\\" cwd \\\"\\\\\\\"\\\" * \\\"name=\\\\\\\"\\\" name \\\"\\\\\\\"\\\" * \\\"cmdline=\\\\\\\"\\\" cmdline \\\"\\\\\\\" containerid=\\\" containerid\\r\\n  | where cmdline has_any (\\\"service apparmor stop\\\",\\\"service aliyun.service stop\\\",\\\"systemctl disable apparmor\\\",\\\"systemctl disable aliyun.service\\\")\\r\\n  or  (exe has \\\"pkill\\\" and cmdline has_any (\\\"omsagent\\\",\\\"auoms\\\",\\\"omiagent\\\",\\\"waagent\\\") and cmdline !has \\\"/omsagent/plugin/pi\\\"and cmdline !has \\\"/omsconfig/modules\\\")\\r\\n  | project TimeGenerated, Computer, audit_user, user, cmdline\\r\\n  | sort by TimeGenerated desc\",\"size\":0,\"title\":\"Linux security related process termination activity detected\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Syslog\\r\\n  | where Facility == 'user'\\r\\n  | where SyslogMessage has \\\"AUOMS_EXECVE\\\"\\r\\n  | parse SyslogMessage with \\\"type=\\\" EventType \\\" audit(\\\" * \\\"): \\\" EventData\\r\\n  | where EventType =~ \\\"AUOMS_EXECVE\\\"\\r\\n  | project TimeGenerated, EventType, Computer, EventData\\r\\n  | parse EventData with * \\\"syscall=\\\" syscall \\\" syscall_r=\\\" * \\\" success=\\\" success \\\" exit=\\\" exit \\\" a0\\\" * \\\" ppid=\\\" ppid \\\" pid=\\\" pid \\\" audit_user=\\\" audit_user \\\" auid=\\\" auid \\\" user=\\\" user \\\" uid=\\\" uid \\\" group=\\\" group \\\" gid=\\\" gid \\\"effective_user=\\\" effective_user \\\" euid=\\\" euid \\\" set_user=\\\" set_user \\\" suid=\\\" suid \\\" filesystem_user=\\\" filesystem_user \\\" fsuid=\\\" fsuid \\\" effective_group=\\\" effective_group \\\" egid=\\\" egid \\\" set_group=\\\" set_group \\\" sgid=\\\" sgid \\\" filesystem_group=\\\" filesystem_group \\\" fsgid=\\\" fsgid \\\" tty=\\\" tty \\\" ses=\\\" ses \\\" comm=\\\\\\\"\\\" comm \\\"\\\\\\\" exe=\\\\\\\"\\\" exe \\\"\\\\\\\"\\\" * \\\"cwd=\\\\\\\"\\\" cwd \\\"\\\\\\\"\\\" * \\\"name=\\\\\\\"\\\" name \\\"\\\\\\\"\\\" * \\\"cmdline=\\\\\\\"\\\" cmdline \\\"\\\\\\\" containerid=\\\" containerid\\r\\n  | where exe has_any (\\\"bash\\\",\\\"dash\\\")\\r\\n  | where cmdline matches regex  \\\"[0-9]{1,3}\\\\\\\\.[0-9]{1,3}\\\\\\\\.[0-9]{1,3}\\\\\\\\.[0-9]{1,3}\\\"\\r\\n  | where cmdline has \\\"curl\\\" and cmdline has \\\"wget\\\"\\r\\n  | project TimeGenerated, Computer, audit_user, user, cmdline\\r\\n  | extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated\\r\\n  | sort by TimeGenerated desc\",\"size\":0,\"title\":\"Suspicious Shell script detected\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Syslog\\r\\n  | where Facility == 'user'\\r\\n  | where SyslogMessage has \\\"AUOMS_EXECVE\\\"\\r\\n  | parse SyslogMessage with \\\"type=\\\" EventType \\\" audit(\\\" * \\\"): \\\" EventData\\r\\n  | project TimeGenerated, EventType, Computer, EventData\\r\\n  | where EventType =~ \\\"AUOMS_EXECVE\\\"\\r\\n  | parse EventData with * \\\"syscall=\\\" syscall \\\" syscall_r=\\\" * \\\" success=\\\" success \\\" exit=\\\" exit \\\" a0\\\" * \\\" ppid=\\\" ppid \\\" pid=\\\" pid \\\" audit_user=\\\" audit_user \\\" auid=\\\" auid \\\" user=\\\" user \\\" uid=\\\" uid \\\" group=\\\" group \\\" gid=\\\" gid \\\"effective_user=\\\" effective_user \\\" euid=\\\" euid \\\" set_user=\\\" set_user \\\" suid=\\\" suid \\\" filesystem_user=\\\" filesystem_user \\\" fsuid=\\\" fsuid \\\" effective_group=\\\" effective_group \\\" egid=\\\" egid \\\" set_group=\\\" set_group \\\" sgid=\\\" sgid \\\" filesystem_group=\\\" filesystem_group \\\" fsgid=\\\" fsgid \\\" tty=\\\" tty \\\" ses=\\\" ses \\\" comm=\\\\\\\"\\\" comm \\\"\\\\\\\" exe=\\\\\\\"\\\" exe \\\"\\\\\\\"\\\" * \\\"cwd=\\\\\\\"\\\" cwd \\\"\\\\\\\"\\\" * \\\"name=\\\\\\\"\\\" name \\\"\\\\\\\"\\\" * \\\"cmdline=\\\\\\\"\\\" cmdline \\\"\\\\\\\" containerid=\\\" containerid\\r\\n  | where cmdline has \\\"/Basic/Command/Base64/\\\"\\r\\n  | where exe has_any (\\\"curl\\\", \\\"wget\\\")\\r\\n  | parse cmdline with * \\\"Base64/\\\" OriginalEncodedCommand:string\\r\\n  | extend EncodedCommand = extract(\\\"((?:[A-Za-z0-9+/-]{4})*(?:[A-Za-z0-9+/-]{2}==|[A-Za-z0-9+/-]{3}=|[A-Za-z0-9+/-]{4}))\\\", 1, OriginalEncodedCommand) \\r\\n  | extend DecodedCommand = base64_decode_tostring(EncodedCommand) \\r\\n  | project TimeGenerated, Computer, audit_user, user, cmdline, DecodedCommand, EncodedCommand\\r\\n  | extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated\\r\\n  | sort by TimeGenerated desc\",\"size\":0,\"title\":\"Suspicious Base64 download activity detected\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"query - 7\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Syslog\"},\"name\":\"group - 5\"}],\"fromTemplateId\":\"sentinel-Log4jWindsWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=Log4jPostCompromiseHuntingWorkbook; logoFileName=Log4j.svg; description=This hunting workbook is intended to help identify activity related to the Log4j compromise discovered in December 2021.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Log4j Post Compromise Hunting; templateRelativePath=Log4jPostCompromiseHunting.json; subtitle=; provider=Microsoft Sentinel Community}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "SecurityNestedRecommendation",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "AzureDiagnostics",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "OfficeActivity",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "W3CIISLog",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "AWSCloudTrail",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "SigninLogs",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "AADNonInteractiveUserSignInLogs",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "imWebSessions",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "imNetworkSession",
                      "kind": "DataType"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Log4jImpactAssessment Workbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId2')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "This hunting workbook is intended to help identify activity related to the Log4j compromise discovered in December 2021."
              },
              "properties": {
                "displayName": "[parameters('workbook2-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Log4j Impact Assessment\\r\\n\\r\\nThis Workbook provides a consolidated view of all Security Incidents, Alerts and Asset Vulnerability information related to Log4j across multi-Tenant environments. \\r\\n\\r\\nLearn more about Microsoft's [guidance for preventing, detecting, and hunting for exploitation of the Log4j 2 vulnerability](https://www.microsoft.com/security/blog/2021/12/11/guidance-for-preventing-detecting-and-hunting-for-cve-2021-44228-log4j-2-exploitation/).\\r\\n\\r\\n**The following tables and data sources are being utilized:**\\r\\n* Security Incidents\\r\\n* Security Alerts\\r\\n* Microsoft Defender for Cloud\\r\\n* Microsoft Defender for Endpoint\\r\\n\\r\\n<br>\\r\\n**Pre-Requisites:**\\r\\n* To enable a consolidated multi-Tenant view, [Azure Lighthouse needs to be onboarded](https://docs.microsoft.com/azure/lighthouse/how-to/manage-sentinel-workspaces)\\r\\n* To leverage Microsoft Defender for Cloud asset vulnerability information, follow [this guide](https://docs.microsoft.com/azure/sentinel/connect-defender-for-cloud) to enable this data source\\r\\n* To leverage Microsoft Defender for Endpoint Vulnerability and Secure Score information, follow [this guide](https://techcommunity.microsoft.com/t5/microsoft-sentinel-blog/microsoft-defender-security-insights-in-azure-sentinel/ba-p/2359705) to ingest the data into Microsoft Sentinel\\r\\n* For more information, refer to the Techcommunity blog post\\r\\n\",\"style\":\"info\"},\"name\":\"text - 5\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"loadType\":\"always\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{WatchlistWorkspace}\"],\"parameters\":[{\"id\":\"1ca69445-60fc-4806-b43d-ac7e6aad630a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"summarize by subscriptionId\\r\\n| project value = strcat(\\\"/subscriptions/\\\", subscriptionId), label = subscriptionId\",\"crossComponentResources\":[\"value::selected\"],\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"e94aafa3-c5d9-4523-89f0-4e87aa754511\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\n| where type =~ 'microsoft.operationalinsights/workspaces'\\n| extend customerID = trim(' ', tostring(properties.customerId))\\n| project id, customerID, name=tolower(name)\\n|join \\n(\\n\\tresources\\n\\t// Just show Workspaces that have Sentinel enabled\\n\\t| where type =~ \\\"microsoft.operationsmanagement/solutions\\\"\\n\\t| where name has \\\"SecurityInsights\\\"\\n\\t| parse name with * '(' s_workspace ')'*\\n\\t| project name=tolower(s_workspace)\\n) on name\\n| project tolower(id), customerID, name\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.operationalinsights/workspaces\":true},\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::all\"]},{\"id\":\"66f59acd-2628-457d-a5cd-176aa453472a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":1209600000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}},{\"id\":\"65e74c73-69f0-4eb5-a772-4fb5eae73d28\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"WorkspaceIDguid\",\"type\":1,\"query\":\"resources\\r\\n| where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| extend customerID = trim(' ', tostring(properties.customerId))\\r\\n| project '{Workspace:name}', name, customerID\\r\\n| where '{Workspace:name}' has name\\r\\n//| project customerID, name\\r\\n// join two columns, seperate with a \\\":\\\"; ARG, will comma seperate each row by default\\r\\n| project strcat(customerID,\\\":\\\",name)\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"2af84437-b015-456b-9660-97c8415e72fd\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Product\",\"label\":\"Product Name\",\"type\":2,\"description\":\"Filter on All or a named Product\",\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| extend productName_ = tostring(parse_json(tostring(AdditionalData.alertProductNames))[0])\\r\\n| summarize by productName_\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"5a683c1d-5e10-4d94-bb2a-32c05b17da8e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"resourceGroup\",\"type\":1,\"query\":\"resources\\r\\n| where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n//| where name ==  \\\"{Workspace:label}\\\" \\r\\n| project resourceGroup\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"306edc18-d122-478d-97aa-ebc5a4cb88db\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Owner\",\"type\":2,\"description\":\"Filter on All or a named Owner assigned to an Incident\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| extend owner = tostring(Owner.assignedTo) \\r\\n| summarize Count=count(IncidentNumber) by Owner= case(owner==\\\"\\\", \\\"Unassigned\\\",owner)\\r\\n| project Value = Owner, Label = strcat(Owner, \\\": \\\", Count)\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"974fe358-910d-41b0-bd1a-221b5f415197\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"WatchlistWorkspace\",\"type\":5,\"description\":\"Select the Workspace that contains the Campaign/Vuln Watchlist\",\"isRequired\":true,\"query\":\"resources\\r\\n| where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| extend customerID = trim(' ', tostring(properties.customerId))\\r\\n| project id, customerID, name=tolower(name)\\r\\n|join \\r\\n(\\r\\n\\tresources\\r\\n\\t// Just show Workspaces that have Sentinel enabled\\r\\n\\t| where type =~ \\\"microsoft.operationsmanagement/solutions\\\"\\r\\n\\t| where name has \\\"SecurityInsights\\\"\\r\\n\\t| parse name with * '(' s_workspace ')'*\\r\\n\\t| project name=tolower(s_workspace)\\r\\n) on name\\r\\n| project tolower(id), customerID, name\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"1307edc5-d777-4710-bb54-4727928d8dae\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Watchlist\",\"type\":2,\"isRequired\":true,\"query\":\"_GetWatchlistAlias\",\"crossComponentResources\":[\"{WatchlistWorkspace}\"],\"value\":\"Campaign2\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"32bb7b19-c6a4-4a87-8682-06e107899580\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Campaign\",\"type\":9,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"_GetWatchlist('{Watchlist}') | project SearchKey\",\"crossComponentResources\":[\"{WatchlistWorkspace}\"],\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"Trojan:Win32/Capfetox.AA\",\"Exploit:Linux/CVE-2021-44228.A\",\"Trojan:Linux/BashMiner.A\",\"Possible Log4j exploitation\",\"CVE-2021-44228\",\"Behavior similar to common Linux bots detected\",\"Vulnerable Machines related to log4j CVE-2021-44228\",\"CVE-2021-45046\",\"Suspicious file download\",\"Process associated with digital currency mining detected\",\"TrojanDropper:PowerShell/Cobacis.A\",\"Suspicious script launched\",\"Detected obfuscated command line\",\"A history file has been cleared\",\"Log4j vulnerability exploit aka Log4Shell IP IOC\",\"HackTool:Win32/Capfetox.A!dha\",\"Backdoor:Linux/Tusnami.C\",\"Azure WAF matching for Log4j vuln (CVE-2021-44228)\",\"Cobalt Strike command and control detected\",\"log4j\",\"Potential crypto coin miner started\",\"TrojanDownloader:Linux/CoinMiner\",\"Linux security related process termination activity detected\",\"Process associated with digital currency mining\",\"Download of file associated with digital currency mining\",\"Ongoing hands-on-keyboard attacker activity detected (Cobalt Strike)\",\"CVE-2021-3800\",\"Exploit:Linux/CVE-2021-44228.B\",\"Suspicious use of PowerShell detected\",\"Possible Cryptocoinminer download detected\",\"Azure WAF Log4j CVE-2021-44228 hunting\",\"Trojan:Linux/SuspectJavaExploit.B\",\"Trojan:Linux/SuspectJavaExploit.C\",\"Possible exploitation of Apache Log4j component detected\",\"Cryptocurrency miners EXECVE\",\"Possible exploitation of CVE-2021-44228\",\"Suspicious domain name reference\",\"Suspicious network traffic connection to C2 Server\",\"CVE-2021-23840\",\"VirTool:Win64/CobaltSrike.A\",\"Network connection seen in CVE-2021-44228 exploitation\",\"Exploitation attempt against Log4j (CVE-2021-4428)\",\"Digital currency mining related behavior detected\",\"Trojan:Win32/WebToos.A\",\"Backdoor:Linux/Setag.C\",\"Suspicious Base64 download activity detected\",\"TrojanDownloader:Win32/CoinMiner\",\"Suspicious shell script detected\",\"Suspicious remote PowerShell execution\",\"Trojan:Linux/SuspectJavaExploit.A\",\"CVE-2021-45105\",\"TrojanDownloader:Linux/Tusnami\",\"Suspicious Shell Script Detected\"]}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"}],\"exportParameters\":true},\"name\":\"group - parameter and help\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"84ebce67-e6dc-46ac-a375-b36438e3b2ee\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Security Incidents\",\"subTarget\":\"SecurityIncident\",\"style\":\"link\"},{\"id\":\"fe402b33-8ccb-4d42-906c-4b1a84b902c7\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Security Alerts\",\"subTarget\":\"SecurityAlert\",\"style\":\"link\"}]},\"name\":\"Tab\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n// Get the Workspace Name(s) from a parameter\\r\\n| extend stringtoSplit = split(\\\"{WorkspaceIDguid}\\\",\\\",\\\")\\r\\n| mvexpand stringtoSplit\\r\\n| where stringtoSplit has TenantId\\r\\n| extend workSpacename = trim(@\\\"[^\\\\w]+\\\",tostring(split(stringtoSplit,\\\":\\\").[1]))\\r\\n// end of get workspace name section\\r\\n| where Title in ({Campaign})\\r\\n| summarize arg_max(TimeGenerated, *) by IncidentName\\r\\n| summarize Count=count() by Title, bin(TimeGenerated, {TimeRange:grain})\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":1,\"title\":\"SecurityIncidents related to {Watchlist} over Time\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"areachart\",\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Title\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Count\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"name\":\"SecurityIncidents related to {Watchlist} over Time\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n// Get the Workspace Name(s) from a parameter\\r\\n| extend stringtoSplit = split(\\\"{WorkspaceIDguid}\\\",\\\",\\\")\\r\\n| mvexpand stringtoSplit\\r\\n| where stringtoSplit has TenantId\\r\\n| extend workSpacename = trim(@\\\"[^\\\\w]+\\\",tostring(split(stringtoSplit,\\\":\\\").[1]))\\r\\n// end of get workspace name section\\r\\n| where Title in ({Campaign})\\r\\n| summarize arg_max(TimeGenerated, *) by IncidentName\\r\\n| summarize count(IncidentName) by   [\\\"Workspace\\\"] = workSpacename\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":4,\"title\":\"Count of Security Incidents for selected Workspaces related to {Watchlist}\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"gridSettings\":{\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"wsName\"]},\"sortBy\":[{\"itemKey\":\"wsName\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"wsName\",\"sortOrder\":2}]},\"customWidth\":\"40\",\"name\":\"Count of Security Incidents for selected Workspaces related to {Watchlist}\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n// Get the Workspace Name(s) from a parameter\\r\\n| extend stringtoSplit = split(\\\"{WorkspaceIDguid}\\\",\\\",\\\")\\r\\n| mv-expand stringtoSplit\\r\\n| where stringtoSplit has TenantId\\r\\n| extend workSpacename = trim(@\\\"[^\\\\w]+\\\",tostring(split(stringtoSplit,\\\":\\\").[1]))\\r\\n| where Title in ({Campaign})\\r\\n// end of get workspace name section\\r\\n| summarize arg_max(TimeGenerated, *) by IncidentName\\r\\n| summarize High=  countif(Severity==\\\"High\\\"),\\r\\n            Medium=countif(Severity==\\\"Medium\\\"),\\r\\n            Low   =countif(Severity==\\\"Low\\\"), \\r\\n            Informational=countif(Severity==\\\"Informational\\\"),\\r\\n            Total  = count()\\r\\n            by workSpacename\",\"size\":3,\"title\":\"Count of Security Incidents per selected Workspace and Severity\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"workSpacename\",\"exportParameterName\":\"exportworkSpacename\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"High\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Medium\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Low\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Informational\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"150px\"}},{\"columnMatch\":\"Total\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\"}},{\"columnMatch\":\"50th_PercentileMeanTime\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":26,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":3}}},{\"columnMatch\":\"50th_PercentileCloseTime\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":26,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":3}}},{\"columnMatch\":\"iD\",\"formatter\":5}],\"sortBy\":[{\"itemKey\":\"workSpacename\",\"sortOrder\":1}],\"labelSettings\":[{\"columnId\":\"workSpacename\",\"label\":\"Workspace Name\"}]},\"sortBy\":[{\"itemKey\":\"workSpacename\",\"sortOrder\":1}]},\"customWidth\":\"60\",\"showPin\":true,\"name\":\"Table - SecurityIncidents\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"SecurityIncident Trend per Workspace\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let incidents = SecurityIncident\\r\\n// Get the Workspace Name(s) from a parameter\\r\\n| extend stringtoSplit = split(\\\"{WorkspaceIDguid}\\\",\\\",\\\")\\r\\n| mv-expand stringtoSplit\\r\\n| where stringtoSplit has TenantId\\r\\n| extend workSpacename = trim(@\\\"[^\\\\w]+\\\",tostring(split(stringtoSplit,\\\":\\\").[1]))\\r\\n| where Title in ({Campaign})\\r\\n| summarize arg_max(TimeGenerated, *) by IncidentName\\r\\n// end of get workspace name section\\r\\n| order by LastModifiedTime;\\r\\n// get trend of detections over time\\r\\nlet trend = incidents\\r\\n| summarize Count = count() by Title, workSpacename\\r\\n| join kind = inner ( incidents\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Title, workSpacename\\r\\n    | project-away TimeGenerated)\\r\\n    on Title, workSpacename\\r\\n| extend Id = strcat(Title,\\\"_\\\",workSpacename)\\r\\n| extend ParentId = Title\\r\\n| extend Detection = workSpacename;\\r\\nincidents\\r\\n| summarize Count = count() by Id = Title\\r\\n| extend Title = Id, ParentId = ''\\r\\n| join kind=inner (incidents\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Title\\r\\n    | project-away TimeGenerated\\r\\n    | extend Detection = Title)\\r\\n    on Title\\r\\n| union (trend)\\r\\n| project-away workSpacename1, Title1, workSpacename, Title\\r\\n| sort by Count desc\\r\\n//| summarize count() by workSpacename, Title\",\"size\":1,\"title\":\"SecurityIncidents triggered over time per Workspace\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Detection\",\"exportParameterName\":\"IncidentSelection\",\"exportDefaultValue\":\"{\\\"IncidentSelection\\\": \\\"*\\\"}\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redDark\"}},{\"columnMatch\":\"ParentId\",\"formatter\":5},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"redDark\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5},{\"columnMatch\":\"set_ClassificationComment\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"BenignPositive\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"150px\"}},{\"columnMatch\":\"FalsePositive\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"150px\"}},{\"columnMatch\":\"TruePositive\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"150px\"}},{\"columnMatch\":\"Undetermined\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"150px\"}}],\"filter\":true,\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Detection\"}}},\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n// Get the Workspace Name(s) from a parameter\\r\\n| extend stringtoSplit = split(\\\"{WorkspaceIDguid}\\\",\\\",\\\")\\r\\n| mvexpand stringtoSplit\\r\\n| where stringtoSplit has TenantId\\r\\n| extend workSpacename = trim(@\\\"[^\\\\w]+\\\",tostring(split(stringtoSplit,\\\":\\\").[1]))\\r\\n// end of get workspace name section\\r\\n| where Title in ({Campaign})\\r\\n| summarize arg_max(TimeGenerated, *) by IncidentName\\r\\n| summarize Total  = count()\\r\\n            by workSpacename\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":1,\"title\":\"Count of Security Incidents for selected Workspaces and Severity\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"High\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Medium\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Low\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Informational\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}}],\"labelSettings\":[{\"columnId\":\"workSpacename\",\"label\":\"Workspace Name\"}]}},\"customWidth\":\"40\",\"conditionalVisibility\":{\"parameterName\":\"hide\",\"comparison\":\"isEqualTo\",\"value\":\"hide\"},\"name\":\"query - KQL for MAP count\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n// Just show Workspaces that have Sentinel enabled\\r\\n| where type =~ \\\"microsoft.operationsmanagement/solutions\\\"\\r\\n| where name has \\\"SecurityInsights\\\"\\r\\n| parse name with * '(' s_workspace ')'*\\r\\n| summarize count() by location, s_workspace\",\"size\":0,\"title\":\"Microsoft Sentinel Workspaces by Azure Region\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"visualization\":\"table\",\"mapSettings\":{\"locInfo\":\"AzureLoc\",\"locInfoColumn\":\"location\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"location\",\"legendMetric\":\"location\",\"legendAggregation\":\"Count\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"hide\",\"comparison\":\"isEqualTo\",\"value\":\"hide\"},\"name\":\"query - ARG for MAp count\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"9862f923-5d48-4232-8b1d-54f18cd153d3\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"query - KQL for MAP count\\\",\\\"rightTable\\\":\\\"query - ARG for MAp count\\\",\\\"leftColumn\\\":\\\"workSpacename\\\",\\\"rightColumn\\\":\\\"s_workspace\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[query - KQL for MAP count].workSpacename\\\",\\\"mergedName\\\":\\\"Workspace Name\\\",\\\"fromId\\\":\\\"9862f923-5d48-4232-8b1d-54f18cd153d3\\\"},{\\\"originalName\\\":\\\"[query - KQL for MAP count].Total\\\",\\\"mergedName\\\":\\\"Total\\\",\\\"fromId\\\":\\\"9862f923-5d48-4232-8b1d-54f18cd153d3\\\"},{\\\"originalName\\\":\\\"[query - ARG for MAp count].location\\\",\\\"mergedName\\\":\\\"location\\\",\\\"fromId\\\":\\\"9862f923-5d48-4232-8b1d-54f18cd153d3\\\"},{\\\"originalName\\\":\\\"[query - ARG for MAp count].s_workspace\\\",\\\"mergedName\\\":\\\"s_workspace\\\",\\\"fromId\\\":\\\"9862f923-5d48-4232-8b1d-54f18cd153d3\\\"},{\\\"originalName\\\":\\\"[query - ARG for MAp count].count_\\\",\\\"mergedName\\\":\\\"count_\\\",\\\"fromId\\\":\\\"9862f923-5d48-4232-8b1d-54f18cd153d3\\\"}]}\\r\\n\",\"size\":0,\"title\":\"Microsoft Sentinel Incident Count by Region\",\"exportedParameters\":[{\"fieldName\":\"\",\"parameterName\":\"exportMap1\"},{\"fieldName\":\"location\",\"parameterName\":\"location\",\"parameterType\":1}],\"queryType\":7,\"visualization\":\"map\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"s_workspace\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"s_workspace\",\"sortOrder\":1}],\"mapSettings\":{\"locInfo\":\"AzureLoc\",\"locInfoColumn\":\"location\",\"sizeSettings\":\"Total\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"location\",\"legendMetric\":\"Total\",\"numberOfMetrics\":50,\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"Total\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"conditionalVisibility\":{\"parameterName\":\"hide\",\"comparison\":\"isEqualTo\",\"value\":\"hide\"},\"showPin\":false,\"name\":\"query - 6\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"5443aca4-a73d-46ad-aaea-bd391acc3f0d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"getMapdata1\",\"type\":1,\"isRequired\":true,\"query\":\"extend a = parse_json('{exportMap1}')\\r\\n| project  ['region']=a.regionName,  ['Incident Count']=a.legendValue\\r\\n| limit 1\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"getMapdata2\",\"type\":1,\"isRequired\":true,\"query\":\"extend a = parse_json('{exportMap2}')\\r\\n| project  ['region']=a.regionName,  ['Incident Count']=a.legendValue\\r\\n| limit 1\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"793ac0c4-7518-4e52-9509-eb1bdf97854b\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"getMapdata1_count\",\"type\":1,\"isRequired\":true,\"query\":\"extend a = parse_json('{exportMap1}')\\r\\n| project  ['Incident Count']=a.legendValue\\r\\n| limit 1\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"d4349432-c9cf-436e-9ede-2cd303c4bc9c\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"getMapdata2_count\",\"type\":1,\"isRequired\":true,\"query\":\"extend a = parse_json('{exportMap2}')\\r\\n| project  ['Incident Count']=a.legendValue\\r\\n| limit 1\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"88076350-2736-407f-a272-6b473dc92c6c\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 8\"}]},\"name\":\"group - classification and tactics - incidents\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Incident Investigation\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n// Get the Workspace Name(s) from a parameter\\r\\n| extend stringtoSplit = split(\\\"{WorkspaceIDguid}\\\",\\\",\\\")\\r\\n| mv-expand stringtoSplit\\r\\n| where stringtoSplit has TenantId\\r\\n| extend workSpacename = trim(@\\\"[^\\\\w]+\\\",tostring(split(stringtoSplit,\\\":\\\").[1]))\\r\\n// end of workspace validation, now match workspace to the selected parameter\\r\\n| summarize arg_max(TimeGenerated,*) by IncidentID=strcat(workSpacename,\\\"_\\\",tostring(IncidentNumber))\\r\\n| where Title in ({Campaign})\\r\\n| extend Alerts = extract(\\\"\\\\\\\\[(.*?)\\\\\\\\]\\\", 1, tostring(AlertIds))\\r\\n| extend productName_ = tostring(parse_json(tostring(AdditionalData.alertProductNames))[0])\\r\\n//| where productName_ in ({Product}) or '{Product:label}' ==\\\"All\\\"\\r\\n| mv-expand AlertIds to typeof(string)\\r\\n| join \\r\\n(\\r\\n    SecurityAlert\\r\\n    | extend AlertEntities = parse_json(Entities)\\r\\n    | mv-expand AlertEntities\\r\\n) on $left.AlertIds == $right.SystemAlertId\\r\\n| summarize AlertCount=dcount(AlertIds), entityList=make_set((AlertEntities)) by IncidentID, Status, Severity, Title,  Alerts, IncidentUrl, Owner=tostring(Owner.userPrincipalName) , Tactics =tostring(AdditionalData.tactics), workSpacename, productName_, IncidentNumber\\r\\n// set column order\\r\\n| project workSpacename, IncidentNumber, Severity, Status, AlertCount, Title, entityList, Tactics, IncidentUrl, productName_, Owner\\r\\n| order by IncidentNumber desc\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":0,\"title\":\"{$rowCount} Incidents during {TimeRange:label}\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"SystemAlertId\",\"exportParameterName\":\"AlertID\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"workSpacename\",\"formatter\":5},{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"greenDark\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"lightBlue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Status\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"New\",\"representation\":\"gray\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"AlertCount\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"IncidentUrl\",\"formatter\":1,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Open Incident in Microsoft Sentinel \"}}],\"rowLimit\":500,\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"workSpacename\"]},\"sortBy\":[{\"itemKey\":\"IncidentNumber\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"IncidentNumber\",\"sortOrder\":2}]},\"name\":\"query - single alert - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let AlertEntities = SecurityAlert\\r\\n| where SystemAlertId == \\\"{AlertID}\\\"\\r\\n| where TimeGenerated {TimeRange}\\r\\n| extend AlertEntities = parse_json(Entities)\\r\\n| mv-expand AlertEntities\\r\\n| where isnotempty(AlertEntities)\\r\\n| project AlertEntities;\\r\\nlet filehashEntities = AlertEntities\\r\\n| where AlertEntities.Type =~ \\\"filehash\\\"\\r\\n| extend Entity = tostring(AlertEntities.Value)\\r\\n| extend EntityType = strcat(tostring(AlertEntities.Type), \\\"-\\\", tostring(AlertEntities.Algorithm))\\r\\n| distinct Entity, EntityType;\\r\\nlet fileEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"file\\\"\\r\\n| extend Entity = strcat(tostring(AlertEntities.Directory), \\\"\\\\\\\\\\\", tostring(AlertEntities.Name))\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet nestedFileHashEntities = AlertEntities\\r\\n| where AlertEntities.Type =~ \\\"file\\\"\\r\\n| where isnotempty(AlertEntities.FileHashes)\\r\\n| mv-expand hashes=AlertEntities.FileHashes\\r\\n| extend Entity = tostring(hashes.Value)\\r\\n| extend EntityType = strcat(tostring(hashes.Type), \\\"-\\\", tostring(hashes.Algorithm))\\r\\n| distinct Entity, EntityType;\\r\\nlet IPEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"ip\\\"\\r\\n| extend Entity = tostring(AlertEntities.Address)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet AccountEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"account\\\"\\r\\n| extend Entity = iff(isnotempty(AlertEntities.UPNSuffix), strcat(AlertEntities.Name, '@', AlertEntities.UPNSuffix), AlertEntities.Name)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet HostEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"host\\\"\\r\\n| extend Entity = iff(isnotempty(AlertEntities.DnsDomain), strcat(AlertEntities.HostName, '.', AlertEntities.DnsDomain), AlertEntities.HostName)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet appEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"cloud-application\\\"\\r\\n| extend Entity = tostring(AlertEntities.Name)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet azresEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"azure-resource\\\"\\r\\n| extend Entity = tostring(AlertEntities.ResourceId)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet malwareEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"malware\\\"\\r\\n| extend Entity = tostring(AlertEntities.Name)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet domResIdEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"DomainResourceIdentifier\\\"\\r\\n| extend Entity = tostring(AlertEntities.ResourceName)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet dnsEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"dns\\\"\\r\\n| extend Entity = tostring(AlertEntities.DomainName)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nAlertEntities\\r\\n| where AlertEntities.Type == \\\"url\\\"\\r\\n| extend Entity = tostring(AlertEntities.Url)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType\\r\\n| union IPEntities, AccountEntities, HostEntities, filehashEntities, fileEntities, nestedFileHashEntities, appEntities, azresEntities, malwareEntities, domResIdEntities, dnsEntities\\r\\n| where isnotempty(Entity)\\r\\n| order by EntityType asc\",\"size\":0,\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"hide\",\"comparison\":\"isEqualTo\",\"value\":\"hide\"},\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"20\"}}]},\"name\":\"group - classification and tactics - incidents - Copy\"}]},\"name\":\"SecurityIncidents related to {Watchlist} drill down\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"SecurityIncident\"},\"name\":\"Security Incidents\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityAlert\\r\\n// Get the Workspace Name(s) from a parameter\\r\\n| extend stringtoSplit = split(\\\"{WorkspaceIDguid}\\\",\\\",\\\")\\r\\n| mvexpand stringtoSplit\\r\\n| where stringtoSplit has TenantId\\r\\n| extend workSpacename = trim(@\\\"[^\\\\w]+\\\",tostring(split(stringtoSplit,\\\":\\\").[1]))\\r\\n| extend ThreatName_ = tostring(parse_json(ExtendedProperties).ThreatName)\\r\\n// end of get workspace name section\\r\\n| where DisplayName in ({Campaign}) or ThreatName_ in ({Campaign})\\r\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\\r\\n| summarize Count=count() by Title=AlertName, bin(TimeGenerated, {TimeRange:grain})\",\"size\":1,\"title\":\"SecurityAlerts related to {Watchlist} over Time\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"areachart\",\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Title\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Count\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"name\":\"query - 6 - Copy\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityAlert\\r\\n// Get the Workspace Name(s) from a parameter\\r\\n| extend stringtoSplit = split(\\\"{WorkspaceIDguid}\\\",\\\",\\\")\\r\\n| mvexpand stringtoSplit\\r\\n| where stringtoSplit has TenantId\\r\\n| extend workSpacename = trim(@\\\"[^\\\\w]+\\\",tostring(split(stringtoSplit,\\\":\\\").[1]))\\r\\n// end of get workspace name section\\r\\n| extend ThreatName_ = tostring(parse_json(ExtendedProperties).ThreatName)\\r\\n| where DisplayName in ({Campaign}) or ThreatName_ in ({Campaign})\\r\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\\r\\n| summarize count(AlertName) by   [\\\"Workspace\\\"] = workSpacename\",\"size\":4,\"title\":\"Count of Security Alerts for selected {$rowCount} Workspaces related to {Watchlist}\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"gridSettings\":{\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"wsName\"]},\"sortBy\":[{\"itemKey\":\"wsName\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"wsName\",\"sortOrder\":2}]},\"customWidth\":\"40\",\"name\":\"query - 3 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityAlert\\r\\n// Get the Workspace Name(s) from a parameter\\r\\n| extend stringtoSplit = split(\\\"{WorkspaceIDguid}\\\",\\\",\\\")\\r\\n| mv-expand stringtoSplit\\r\\n| where stringtoSplit has TenantId\\r\\n| extend workSpacename = trim(@\\\"[^\\\\w]+\\\",tostring(split(stringtoSplit,\\\":\\\").[1]))\\r\\n// end of get workspace name section\\r\\n| extend ThreatName_ = tostring(parse_json(ExtendedProperties).ThreatName)\\r\\n| where DisplayName in ({Campaign}) or ThreatName_ in ({Campaign})\\r\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\\r\\n| summarize High=  countif(AlertSeverity==\\\"High\\\"),\\r\\n            Medium=countif(AlertSeverity==\\\"Medium\\\"),\\r\\n            Low   =countif(AlertSeverity==\\\"Low\\\"), \\r\\n            Informational=countif(AlertSeverity==\\\"Informational\\\"),\\r\\n            Total  = count()\\r\\n            by workSpacename\",\"size\":3,\"title\":\"Count of Security Alerts for selected Workspaces and Severity\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"workSpacename\",\"exportParameterName\":\"exportworkSpacename\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"High\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Medium\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Low\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Informational\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"150px\"}},{\"columnMatch\":\"Total\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\"}},{\"columnMatch\":\"50th_PercentileMeanTime\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":26,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":3}}},{\"columnMatch\":\"50th_PercentileCloseTime\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":26,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":3}}},{\"columnMatch\":\"iD\",\"formatter\":5}],\"sortBy\":[{\"itemKey\":\"workSpacename\",\"sortOrder\":1}],\"labelSettings\":[{\"columnId\":\"workSpacename\",\"label\":\"Workspace Name\"}]},\"sortBy\":[{\"itemKey\":\"workSpacename\",\"sortOrder\":1}]},\"customWidth\":\"60\",\"name\":\"query - SecIncidents\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"SecurityAlert Trend per Workspace\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let alerts = SecurityAlert\\r\\n// Get the Workspace Name(s) from a parameter\\r\\n| extend stringtoSplit = split(\\\"{WorkspaceIDguid}\\\",\\\",\\\")\\r\\n| mv-expand stringtoSplit\\r\\n| where stringtoSplit has TenantId\\r\\n| extend workSpacename = trim(@\\\"[^\\\\w]+\\\",tostring(split(stringtoSplit,\\\":\\\").[1]))\\r\\n| extend ThreatName_ = tostring(parse_json(ExtendedProperties).ThreatName)\\r\\n| where DisplayName in ({Campaign}) or ThreatName_ in ({Campaign})\\r\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\\r\\n| extend Title = AlertName;\\r\\n// get trend of detections over time\\r\\nlet trend = alerts\\r\\n| summarize Count = count() by Title, workSpacename\\r\\n| join kind = inner ( alerts\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Title, workSpacename\\r\\n    | project-away TimeGenerated)\\r\\n    on Title, workSpacename\\r\\n| extend Id = strcat(Title,\\\"_\\\",workSpacename)\\r\\n| extend ParentId = Title\\r\\n| extend Detection = workSpacename;\\r\\nalerts\\r\\n| summarize Count = count() by Id = Title\\r\\n| extend Title = Id, ParentId = ''\\r\\n| join kind=inner (alerts\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Title\\r\\n    | project-away TimeGenerated\\r\\n    | extend Detection = Title)\\r\\n    on Title\\r\\n| union (trend)\\r\\n| project-away workSpacename1, Title1, workSpacename, Title\\r\\n| sort by Count desc\\r\\n//| summarize count() by workSpacename, Title\",\"size\":1,\"title\":\"SecurityAlerts triggered over time per Workspace\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Detection\",\"exportParameterName\":\"IncidentSelection\",\"exportDefaultValue\":\"{\\\"IncidentSelection\\\": \\\"*\\\"}\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redDark\"}},{\"columnMatch\":\"ParentId\",\"formatter\":5},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"redDark\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5},{\"columnMatch\":\"set_ClassificationComment\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"BenignPositive\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"150px\"}},{\"columnMatch\":\"FalsePositive\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"150px\"}},{\"columnMatch\":\"TruePositive\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"150px\"}},{\"columnMatch\":\"Undetermined\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"150px\"}}],\"filter\":true,\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Detection\"}}},\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n// Get the Workspace Name(s) from a parameter\\r\\n| extend stringtoSplit = split(\\\"{WorkspaceIDguid}\\\",\\\",\\\")\\r\\n| mvexpand stringtoSplit\\r\\n| where stringtoSplit has TenantId\\r\\n| extend workSpacename = trim(@\\\"[^\\\\w]+\\\",tostring(split(stringtoSplit,\\\":\\\").[1]))\\r\\n// end of get workspace name section\\r\\n| where Title in ({Campaign})\\r\\n| summarize arg_max(TimeGenerated, *) by IncidentName\\r\\n| summarize Total  = count()\\r\\n            by workSpacename\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":1,\"title\":\"Count of Security Incidents for selected Workspaces and Severity\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"High\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Medium\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Low\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"Informational\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}}],\"labelSettings\":[{\"columnId\":\"workSpacename\",\"label\":\"Workspace Name\"}]}},\"customWidth\":\"40\",\"conditionalVisibility\":{\"parameterName\":\"hide\",\"comparison\":\"isEqualTo\",\"value\":\"hide\"},\"name\":\"query - KQL for MAP count\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n// Just show Workspaces that have Sentinel enabled\\r\\n| where type =~ \\\"microsoft.operationsmanagement/solutions\\\"\\r\\n| where name has \\\"SecurityInsights\\\"\\r\\n| parse name with * '(' s_workspace ')'*\\r\\n| summarize count() by location, s_workspace\",\"size\":0,\"title\":\"Microsoft Sentinel Workspaces by Azure Region\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"visualization\":\"table\",\"mapSettings\":{\"locInfo\":\"AzureLoc\",\"locInfoColumn\":\"location\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"location\",\"legendMetric\":\"location\",\"legendAggregation\":\"Count\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"hide\",\"comparison\":\"isEqualTo\",\"value\":\"hide\"},\"name\":\"query - ARG for MAp count\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"9862f923-5d48-4232-8b1d-54f18cd153d3\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"query - KQL for MAP count\\\",\\\"rightTable\\\":\\\"query - ARG for MAp count\\\",\\\"leftColumn\\\":\\\"workSpacename\\\",\\\"rightColumn\\\":\\\"s_workspace\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[query - KQL for MAP count].workSpacename\\\",\\\"mergedName\\\":\\\"Workspace Name\\\",\\\"fromId\\\":\\\"9862f923-5d48-4232-8b1d-54f18cd153d3\\\"},{\\\"originalName\\\":\\\"[query - KQL for MAP count].Total\\\",\\\"mergedName\\\":\\\"Total\\\",\\\"fromId\\\":\\\"9862f923-5d48-4232-8b1d-54f18cd153d3\\\"},{\\\"originalName\\\":\\\"[query - ARG for MAp count].location\\\",\\\"mergedName\\\":\\\"location\\\",\\\"fromId\\\":\\\"9862f923-5d48-4232-8b1d-54f18cd153d3\\\"},{\\\"originalName\\\":\\\"[query - ARG for MAp count].s_workspace\\\",\\\"mergedName\\\":\\\"s_workspace\\\",\\\"fromId\\\":\\\"9862f923-5d48-4232-8b1d-54f18cd153d3\\\"},{\\\"originalName\\\":\\\"[query - ARG for MAp count].count_\\\",\\\"mergedName\\\":\\\"count_\\\",\\\"fromId\\\":\\\"9862f923-5d48-4232-8b1d-54f18cd153d3\\\"}]}\\r\\n\",\"size\":0,\"title\":\"Microsoft Sentinel Incident Count by Region\",\"exportedParameters\":[{\"fieldName\":\"\",\"parameterName\":\"exportMap1\"},{\"fieldName\":\"location\",\"parameterName\":\"location\",\"parameterType\":1}],\"queryType\":7,\"visualization\":\"map\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"s_workspace\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"s_workspace\",\"sortOrder\":1}],\"mapSettings\":{\"locInfo\":\"AzureLoc\",\"locInfoColumn\":\"location\",\"sizeSettings\":\"Total\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"location\",\"legendMetric\":\"Total\",\"numberOfMetrics\":50,\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"Total\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"conditionalVisibility\":{\"parameterName\":\"hide\",\"comparison\":\"isEqualTo\",\"value\":\"hide\"},\"showPin\":false,\"name\":\"query - 6\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"5443aca4-a73d-46ad-aaea-bd391acc3f0d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"getMapdata1\",\"type\":1,\"isRequired\":true,\"query\":\"extend a = parse_json('{exportMap1}')\\r\\n| project  ['region']=a.regionName,  ['Incident Count']=a.legendValue\\r\\n| limit 1\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"getMapdata2\",\"type\":1,\"isRequired\":true,\"query\":\"extend a = parse_json('{exportMap2}')\\r\\n| project  ['region']=a.regionName,  ['Incident Count']=a.legendValue\\r\\n| limit 1\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"793ac0c4-7518-4e52-9509-eb1bdf97854b\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"getMapdata1_count\",\"type\":1,\"isRequired\":true,\"query\":\"extend a = parse_json('{exportMap1}')\\r\\n| project  ['Incident Count']=a.legendValue\\r\\n| limit 1\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"d4349432-c9cf-436e-9ede-2cd303c4bc9c\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"getMapdata2_count\",\"type\":1,\"isRequired\":true,\"query\":\"extend a = parse_json('{exportMap2}')\\r\\n| project  ['Incident Count']=a.legendValue\\r\\n| limit 1\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"88076350-2736-407f-a272-6b473dc92c6c\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 8\"}]},\"name\":\"group - classification and tactics - alerts\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Alert Investigation\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityAlert\\r\\n// Get the Workspace Name(s) from a parameter\\r\\n| extend stringtoSplit = split(\\\"{WorkspaceIDguid}\\\",\\\",\\\")\\r\\n| mv-expand stringtoSplit\\r\\n| where stringtoSplit has TenantId\\r\\n| extend workSpacename = trim(@\\\"[^\\\\w]+\\\",tostring(split(stringtoSplit,\\\":\\\").[1]))\\r\\n| extend ThreatName_ = tostring(parse_json(ExtendedProperties).ThreatName)\\r\\n| extend productName_ = tostring(parse_json(ExtendedProperties).DetectionSource)\\r\\n| where DisplayName in ({Campaign}) or ThreatName_ in ({Campaign})\\r\\n| extend Title = DisplayName\\r\\n| extend Title = iff(Title == \\\"\\\", ThreatName_, DisplayName)\\r\\n// end of workspace validation, now match workspace to the selected parameter\\r\\n| summarize arg_max(TimeGenerated,*) by AlertID=strcat(workSpacename,\\\"_\\\",tostring(SystemAlertId))\\r\\n| summarize entityList=make_set((Entities)) by AlertID, Status, AlertSeverity, Title, AlertLink, workSpacename, productName_, SystemAlertId\\r\\n// set column order\\r\\n| project workSpacename, SystemAlertId, AlertSeverity, Status, Title, entityList, AlertLink, productName_\\r\\n| order by SystemAlertId desc\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":0,\"title\":\"{$rowCount} Alerts during {TimeRange:label}\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"SystemAlertId\",\"exportParameterName\":\"AlertID\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"workSpacename\",\"formatter\":5},{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"greenDark\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"lightBlue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Status\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"New\",\"representation\":\"gray\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"AlertCount\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"IncidentUrl\",\"formatter\":1,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Open Incident in Microsoft Sentinel \"}}],\"rowLimit\":500,\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"workSpacename\"]}}},\"name\":\"query - single alert - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let AlertEntities = SecurityAlert\\r\\n| where SystemAlertId == \\\"{AlertID}\\\"\\r\\n| where TimeGenerated {TimeRange}\\r\\n| extend AlertEntities = parse_json(Entities)\\r\\n| mv-expand AlertEntities\\r\\n| where isnotempty(AlertEntities)\\r\\n| project AlertEntities;\\r\\nlet filehashEntities = AlertEntities\\r\\n| where AlertEntities.Type =~ \\\"filehash\\\"\\r\\n| extend Entity = tostring(AlertEntities.Value)\\r\\n| extend EntityType = strcat(tostring(AlertEntities.Type), \\\"-\\\", tostring(AlertEntities.Algorithm))\\r\\n| distinct Entity, EntityType;\\r\\nlet fileEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"file\\\"\\r\\n| extend Entity = strcat(tostring(AlertEntities.Directory), \\\"\\\\\\\\\\\", tostring(AlertEntities.Name))\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet nestedFileHashEntities = AlertEntities\\r\\n| where AlertEntities.Type =~ \\\"file\\\"\\r\\n| where isnotempty(AlertEntities.FileHashes)\\r\\n| mv-expand hashes=AlertEntities.FileHashes\\r\\n| extend Entity = tostring(hashes.Value)\\r\\n| extend EntityType = strcat(tostring(hashes.Type), \\\"-\\\", tostring(hashes.Algorithm))\\r\\n| distinct Entity, EntityType;\\r\\nlet IPEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"ip\\\"\\r\\n| extend Entity = tostring(AlertEntities.Address)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet AccountEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"account\\\"\\r\\n| extend Entity = iff(isnotempty(AlertEntities.UPNSuffix), strcat(AlertEntities.Name, '@', AlertEntities.UPNSuffix), AlertEntities.Name)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet HostEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"host\\\"\\r\\n| extend Entity = iff(isnotempty(AlertEntities.DnsDomain), strcat(AlertEntities.HostName, '.', AlertEntities.DnsDomain), AlertEntities.HostName)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet appEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"cloud-application\\\"\\r\\n| extend Entity = tostring(AlertEntities.Name)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet azresEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"azure-resource\\\"\\r\\n| extend Entity = tostring(AlertEntities.ResourceId)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet malwareEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"malware\\\"\\r\\n| extend Entity = tostring(AlertEntities.Name)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet domResIdEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"DomainResourceIdentifier\\\"\\r\\n| extend Entity = tostring(AlertEntities.ResourceName)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nlet dnsEntities = AlertEntities\\r\\n| where AlertEntities.Type == \\\"dns\\\"\\r\\n| extend Entity = tostring(AlertEntities.DomainName)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType;\\r\\nAlertEntities\\r\\n| where AlertEntities.Type == \\\"url\\\"\\r\\n| extend Entity = tostring(AlertEntities.Url)\\r\\n| extend EntityType = tostring(AlertEntities.Type)\\r\\n| distinct Entity, EntityType\\r\\n| union IPEntities, AccountEntities, HostEntities, filehashEntities, fileEntities, nestedFileHashEntities, appEntities, azresEntities, malwareEntities, domResIdEntities, dnsEntities\\r\\n| where isnotempty(Entity)\\r\\n| order by EntityType asc\",\"size\":0,\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"hide\",\"comparison\":\"isEqualTo\",\"value\":\"hide\"},\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"20\"}}]},\"name\":\"group - classification and tactics - alerts\"}]},\"name\":\"group - overview alerts\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"SecurityAlert\"},\"name\":\"Security Alerts\"}]},\"name\":\"Incidents Alerts\"},{\"type\":1,\"content\":{\"json\":\"---------------\"},\"name\":\"text - 9\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Security Posture, Threat and Vulnerability Management\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"value::selected\"],\"parameters\":[{\"id\":\"3218e2b0-1bcc-46d4-affa-d298e0cf90f6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DefaultSubscription_Internal\",\"type\":1,\"isRequired\":true,\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| take 1\\r\\n| project subscriptionId\",\"crossComponentResources\":[\"value::selected\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"e6ded9a1-a83c-4762-938d-5bf8ff3d3d38\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription1\",\"type\":6,\"isRequired\":true,\"query\":\"summarize by subscriptionId\\r\\n| project value = strcat(\\\"/subscriptions/\\\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{DefaultSubscription_Internal}', true, false)\",\"crossComponentResources\":[\"value::selected\"],\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"customWidth\":\"33\",\"conditionalVisibility\":{\"parameterName\":\"hide\",\"comparison\":\"isEqualTo\",\"value\":\"hide\"},\"name\":\"parameters - 10\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"d4aa2831-0ab8-4977-a80e-359420e7d5f7\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Azure Security Center\",\"subTarget\":\"ASC\",\"style\":\"link\"},{\"id\":\"695cfb00-50a3-47f1-b08e-4902054f74bf\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Microsoft Defender for Cloud\",\"subTarget\":\"MDC\",\"style\":\"link\"},{\"id\":\"d4f75516-6286-4660-8294-395da6b9c29a\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Defender for Endpoint\",\"subTarget\":\"D4E\",\"style\":\"link\"}]},\"name\":\"links - 6\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"M365SecureScore_CL \\r\\n| extend ActiveUsers=activeUserCount_d, \\r\\n          CurrentScore=currentScore_d, \\r\\n          MaximumScore=maxScore_d, \\r\\n          TenantID=azureTenantId_g \\r\\n| summarize by round(CurrentScore), bin(TimeGenerated, 1d)\",\"size\":0,\"aggregation\":5,\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"timechart\",\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0}},\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"M365SecureScore_CL \\r\\n| project TimeGenerated, \\r\\n          ActiveUsers=activeUserCount_d, \\r\\n          CurrentScore=currentScore_d, \\r\\n          MaximumScore=maxScore_d, \\r\\n          TenantID=azureTenantId_g \\r\\n| sort by TimeGenerated desc\",\"size\":1,\"title\":\"Microsoft 365 Secure Score\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"query - 2\",\"styleSettings\":{\"showBorder\":true}},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"7c67a766-4287-4a07-a256-4ef237151489\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Category\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"M365SecureScoreControls_CL \\r\\n| project RecommendationCategory=controlCategory_s \\r\\n| distinct RecommendationCategory\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"value::all\"]}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"M365SecureScoreControls_CL \\r\\n| where TimeGenerated >= ago(7d) \\r\\n| extend RecommendationCategory=controlCategory_s \\r\\n| where RecommendationCategory in ({Category}) \\r\\n| project RecommendationCategory, \\r\\n        ControlName=controlName_s, \\r\\n        Recommendation=description_s, \\r\\n        ImplementationStatus=implementationStatus_s\",\"size\":1,\"title\":\"Microsoft 365 Secure Score Recommendations\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"query - 5\",\"styleSettings\":{\"showBorder\":true}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"M365\"},\"name\":\"M365\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"MDfESecureScore_CL \\r\\n| summarize  arg_max(TimeGenerated, *) by tostring(TenantId)\\r\\n| project TenantId, TimeGenerated, CurrentScore=score_d\",\"size\":1,\"title\":\"Microsoft Defender for Endpoint Secure Score\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"50\",\"name\":\"query - 3\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"MDfESecureScore_CL \\r\\n| summarize by TimeGenerated, CurrentScore=score_d,tostring(TenantId)\\r\\n| render areachart \",\"size\":1,\"aggregation\":5,\"title\":\"Microsoft Defender for Endpoint Secure Score Trend\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 3 - SecureScoreChart\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"MDfEExposureScore_CL\\r\\n| summarize  arg_max(TimeGenerated, *) by tostring(TenantId)\\r\\n| project TenantId, TimeGenerated, CurrentScore=score_d\",\"size\":1,\"title\":\"Microsoft Defender for Endpoint Exposure Score\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"50\",\"name\":\"query - 4\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"MDfEExposureScore_CL\\r\\n| summarize by TimeGenerated, CurrentScore=score_d,tostring(TenantId)\\r\\n| render areachart \",\"size\":1,\"aggregation\":5,\"title\":\"Microsoft Defender for Endpoint Exposure Score Trend\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"50\",\"name\":\"query - 4 -ExposureScoreTrend\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"MDfERecommendations_CL \\r\\n| project TimeGenerated, Vendor=vendor_s, ProductName=relatedComponent_s, RecommendationName=recommendationName_s, \\r\\n        Weaknesses=weaknesses_d, PublicExploit=publicExploit_b, ConfigScoreImpact=configScoreImpact_d, \\r\\n        ExposureScoreImpact=round(exposureImpact_d), NumberOfExposedMachines=exposedMachinesCount_d, \\r\\n        TotalNumberOfMachines=totalMachineCount_d, RecommendationCategory=recommendationCategory_s, \\r\\n        SubCategory=subCategory_s, RemediationType=remediationType_s\\r\\n| where RecommendationName has_any ({Campaign}) or Weaknesses has_any ({Campaign}) or PublicExploit has_any ({Campaign})\",\"size\":3,\"title\":\"Microsoft Defender for Endpoint Recommendations Related to {Watchlist}\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"PublicExploit\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"True\",\"representation\":\"redBright\",\"text\":\"True\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}}],\"sortBy\":[{\"itemKey\":\"TimeGenerated\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"TimeGenerated\",\"sortOrder\":1}]},\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"MDfEVulnerabilitiesList_CL\\r\\n| where isnotempty(name_s) and exposedMachines_d > 0 \\r\\n| project Name=name_s, Description=description_s, Severity=severity_s, ExposedMachines=exposedMachines_d, CVSS=cvssV3_d,\\r\\n        PublicExploit=publicExploit_b, ExploitVerified=exploitVerified_b, ExploitType=exploitTypes_s, ExploitURL=exploitUris_s, \\r\\n        PublishedOn=publishedOn_t, UpdatedOn=updatedOn_t\\r\\n| where Name has_any ({Campaign}) or Description has_any ({Campaign})\",\"size\":3,\"title\":\"Microsoft Defender for Endpoint Vulnerabilities Related to {Watchlist}\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"redBright\",\"text\":\"High\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"yellow\",\"text\":\"Medium\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"PublicExploit\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"True\",\"representation\":\"redBright\",\"text\":\"True\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"ExploitVerified\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"True\",\"representation\":\"redBright\",\"text\":\"True\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}}]}},\"name\":\"query - 3\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"D4E\"},\"name\":\"D4E\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityResources \\r\\n| where type == 'microsoft.security/securescores'\\r\\n| extend Name = properties.displayName, CurrentScore = properties.score.current, MaximumScore = properties.score.max, Percentage1 = todouble(properties.score.percentage)\\r\\n| project Name, CurrentScore, MaximumScore, Percentage = round(Percentage1*100,2), subscriptionId\\r\\n| join kind=inner (\\r\\n    resources\\r\\n    | summarize by subscriptionId\\r\\n    | project ASCSubscription = strcat(\\\"/subscriptions/\\\", subscriptionId), subscriptionId) on subscriptionId\\r\\n| project-away subscriptionId1\\r\\n| project ASCSubscription, CurrentScore, MaximumScore, Percentage, subscriptionId\",\"size\":4,\"aggregation\":5,\"title\":\"Azure Security Center Secure Score\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Percentage\",\"formatter\":0,\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false}}}]}},\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"    securityresources\\r\\n    | where type == 'microsoft.security/securescores/securescorecontrols'\\r\\n    | extend SecureControl = properties.displayName, unhealthy = properties.unhealthyResourceCount, currentscore = properties.score.current, maxscore = properties.score.max\\r\\n    | where maxscore != 0\\r\\n    | project SecureControl , unhealthy, currentscore, maxscore, subscriptionId\\r\\n    | join kind=inner (\\r\\n    resources\\r\\n    | summarize by subscriptionId\\r\\n    | project ASCSubscription = strcat(\\\"/subscriptions/\\\", subscriptionId), subscriptionId) on subscriptionId\\r\\n| project-away subscriptionId1\\r\\n//    | summarize sum(toint(unhealthy)), avg(tolong(currentscore)), avg(tolong(maxscore)) by subscriptionId, tostring(SecureControl)\",\"size\":0,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":13,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"SecureControl\",\"formatter\":5},{\"columnMatch\":\"unhealthy\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"!=\",\"thresholdValue\":\"0\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"0\",\"representation\":\"greenDark\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"currentscore\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"0\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"greenDark\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"maxscore\",\"formatter\":1},{\"columnMatch\":\"ASCSubscription\",\"formatter\":5}],\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"SecureControl\"],\"expandTopLevel\":false,\"finalBy\":\"ASCSubscription\"}}},\"name\":\"query - 1\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ASC\"},\"name\":\"ASC\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"The following section is from the [Microsoft Defender for Cloud Log4j vulnerability workbook](https://ms.portal.azure.com/#blade/AppInsightsExtension/UsageNotebookBlade/ComponentId/Azure%20Security%20Center/ConfigurationId/community-Workbooks%2FAzure%20Security%20Center%2FLog4j/Type/workbook/WorkbookTemplateName/Log4j%20vulnerability) which finds machines and containers at risk from specific vulnerabilities. The workbook shows resources from your Azure, hybrid, and multi-cloud environments. This section has been modified to accomodate any future Watchlists you may use to filter out Campaign-specific detections and CVE IDs.\\r\\n\\r\\nCVE data comes from Defender for Cloud's integrated vulnerability assessment solutions ([TVM](https://docs.microsoft.com/azure/defender-for-cloud/deploy-vulnerability-assessment-tvm) and [Qualys](https://docs.microsoft.com/azure/defender-for-cloud/deploy-vulnerability-assessment-vm)). These tools show vulnerabilities through the following security recommendations:\\r\\n\\r\\n- [Machines should have vulnerability findings resolved](https://portal.azure.com/#blade/Microsoft_Azure_Security/RecommendationsBlade/assessmentKey/1195afff-c881-495e-9bc5-1486211ae03f)\\r\\n- [Container registry images should have vulnerability findings resolved](https://portal.azure.com/#blade/Microsoft_Azure_Security/RecommendationsBlade/assessmentKey/dbd0cb49-b563-45e7-9724-889e799fa648)\"},\"name\":\"text - 0\"}]},\"name\":\"group - 2\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"24ecf7d5-388a-4dd1-be0b-1655d136e33f\",\"cellValue\":\"AffectedResource\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Machines\",\"subTarget\":\"Machines\",\"style\":\"link\"},{\"id\":\"b5d47c8e-db2f-4379-9db9-692f1323117a\",\"cellValue\":\"AffectedResource\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Containers\",\"subTarget\":\"Containers\",\"style\":\"link\"}]},\"name\":\"Tabs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"_GetWatchlist('{Watchlist}') | project SearchKey\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{WatchlistWorkspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"Hide\"},\"name\":\"queryCampaign\"},{\"type\":1,\"content\":{\"json\":\"---\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"securityresources\\r\\n| where type == \\\"microsoft.security/assessments/subassessments\\\"\\r\\n| extend assessmentKey = extract(\\\".*assessments/(.+?)/.*\\\",1, id)\\r\\n| where assessmentKey == \\\"dbd0cb49-b563-45e7-9724-889e799fa648\\\"\\r\\n| project Resource = tolower(extract(\\\"([\\\\\\\\s\\\\\\\\S]*?)(/providers/Microsoft.Security.*)\\\",1,id)), ResourceGroup = trim_end(\\\"/\\\",extract(\\\".*resourceGroups/(.+?)/\\\",0,id)), ResourceType = tolower(split(id,\\\"/\\\").[6]), subscriptionId, Severity = tostring(parse_json(properties).status.severity), Status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), Description = tostring(parse_json(properties).displayName), CVE = properties.additionalData.cve, ResourceName = tolower(split(id,\\\"/\\\").[8]), SoftwareVendor = tostring(properties.additionalData.softwareVendor), SoftwareName = tostring(properties.additionalData.softwareName), SoftwareVersion = tostring(properties.additionalData.softwareVersion), Source = tostring(properties.additionalData.source)\\r\\n| where Status == 'Unhealthy'\\r\\n| project Severity, VulnId, Description, Resource, ResourceGroup, CVE, ResourceName\\r\\n| mvexpand CVE\\r\\n| extend CVEs = tostring(CVE['title'])\\r\\n//| where CVEs has \\\"CVE-2021-44228\\\" or CVEs has \\\"CVE-2021-45046\\\" or CVEs has \\\"CVE-2021-45105\\\" //modify this to lookup against Watchlist\\r\\n//| summarize CVEs = tostring(make_list(CVEs)), NumOfCvePerResouce = dcount(CVEs) by Resource\",\"size\":1,\"showAnalytics\":true,\"title\":\"Container registries - Qualys\",\"noDataMessage\":\"No unhealthy container registries found\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Resource\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true}}],\"labelSettings\":[{\"columnId\":\"Resource\",\"label\":\"Container Registry\"}]},\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Resource\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"NumResources\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"CVEs\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"NumResources\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibilities\":[{\"parameterName\":\"AffectedResource\",\"comparison\":\"isEqualTo\",\"value\":\"Containers\"},{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"Hide\"}],\"name\":\"RegistriesOverview\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"RegistriesOverview\\\",\\\"rightTable\\\":\\\"queryCampaign\\\",\\\"leftColumn\\\":\\\"CVEs\\\",\\\"rightColumn\\\":\\\"SearchKey\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[TVM].cve\\\",\\\"mergedName\\\":\\\"cve\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[TVM].dcount_VulnId\\\",\\\"mergedName\\\":\\\"dcount_VulnId\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[RegistriesOverview].Severity\\\",\\\"mergedName\\\":\\\"Severity\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistriesOverview].VulnId\\\",\\\"mergedName\\\":\\\"VulnId\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistriesOverview].Description\\\",\\\"mergedName\\\":\\\"Description\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistriesOverview].Resource\\\",\\\"mergedName\\\":\\\"Resource\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistriesOverview].ResourceGroup\\\",\\\"mergedName\\\":\\\"ResourceGroup\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistriesOverview].CVE\\\",\\\"mergedName\\\":\\\"CVE\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistriesOverview].ResourceName\\\",\\\"mergedName\\\":\\\"ResourceName\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistriesOverview].CVEs\\\",\\\"mergedName\\\":\\\"CVEs\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[queryCampaign].SearchKey\\\",\\\"mergedName\\\":\\\"SearchKey\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"}]}\\r\\n\",\"size\":3,\"title\":\"Container registries affected by {Watchlist} CVEs - Qualys\",\"noDataMessage\":\"No unhealthy container registries found\",\"exportFieldName\":\"Resource\",\"exportParameterName\":\"SelectedCR\",\"showExportToExcel\":true,\"queryType\":7,\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"AffectedResource\",\"comparison\":\"isEqualTo\",\"value\":\"Containers\"},\"showPin\":false,\"name\":\"RegistriesOverview Merged\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"securityresources\\r\\n | where type == \\\"microsoft.security/assessments/subassessments\\\"\\r\\n | extend assessmentKey = extract(\\\".*assessments/(.+?)/.*\\\",1,  id)\\r\\n | where assessmentKey == \\\"dbd0cb49-b563-45e7-9724-889e799fa648\\\"\\r\\n | project Resource = tolower(extract(@'(?i)(.*?)/providers/Microsoft.Security/([^/]+)', 1, id)), ResourceType = tolower(split(id,\\\"/\\\").[6]), subscriptionId, severity = tostring(parse_json(properties).status.severity), status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), description = tostring(parse_json(properties).displayName), patchable = parse_json(properties.additionalData).patchable, cve = parse_json(properties.additionalData).cve, Repo = tostring(parse_json(properties.additionalData).repositoryName), imageDigest = tostring(parse_json(properties.additionalData).imageDigest)\\r\\n| where status == 'Unhealthy'\\r\\n| where '{SelectedCR}' == 'All' or Resource == '{SelectedCR}'\\r\\n| mvexpand todynamic(cve)\\r\\n| extend CVEs = parse_json(cve['title'])\\r\\n//| where CVEs has \\\"CVE-2021-44228\\\" or CVEs has \\\"CVE-2021-45046\\\" or CVEs has \\\"CVE-2021-45105\\\" //modify this to lookup against Watchlist\\r\\n//| summarize CVEs = tostring(make_list(CVEs)), CVECount = count(CVEs) by Resource, severity, VulnId, description, tostring(patchable), Repo, imageDigest\\r\\n\",\"size\":0,\"showAnalytics\":true,\"noDataMessage\":\"No unhealthy container registries found\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"labelSettings\":[{\"columnId\":\"Resource\",\"label\":\"Container Registry\"},{\"columnId\":\"severity\",\"label\":\"Severity\"},{\"columnId\":\"VulnId\",\"label\":\"Vuln ID\"},{\"columnId\":\"description\",\"label\":\"Description\"},{\"columnId\":\"patchable\",\"label\":\"Patchable\"},{\"columnId\":\"imageDigest\",\"label\":\"Image digest\"}]}},\"conditionalVisibilities\":[{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"ACRTab\"},{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"Hide\"}],\"name\":\"RegistryDetails\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"RegistryDetails\\\",\\\"rightTable\\\":\\\"queryCampaign\\\",\\\"leftColumn\\\":\\\"CVEs\\\",\\\"rightColumn\\\":\\\"SearchKey\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[TVM].cve\\\",\\\"mergedName\\\":\\\"cve\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[TVM].dcount_VulnId\\\",\\\"mergedName\\\":\\\"dcount_VulnId\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[RegistryDetails].Resource\\\",\\\"mergedName\\\":\\\"Container Registry\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistryDetails].ResourceType\\\",\\\"mergedName\\\":\\\"ResourceType\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistryDetails].subscriptionId\\\",\\\"mergedName\\\":\\\"subscriptionId\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistryDetails].severity\\\",\\\"mergedName\\\":\\\"Severity\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistryDetails].status\\\",\\\"mergedName\\\":\\\"status\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistryDetails].VulnId\\\",\\\"mergedName\\\":\\\"Vuln ID\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistryDetails].description\\\",\\\"mergedName\\\":\\\"Description\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistryDetails].patchable\\\",\\\"mergedName\\\":\\\"Patchable\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistryDetails].cve\\\",\\\"mergedName\\\":\\\"cve\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistryDetails].Repo\\\",\\\"mergedName\\\":\\\"Repo\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistryDetails].imageDigest\\\",\\\"mergedName\\\":\\\"Image digest\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[RegistryDetails].CVEs\\\",\\\"mergedName\\\":\\\"CVEs\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[queryCampaign].SearchKey\\\",\\\"mergedName\\\":\\\"SearchKey\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"}]}\\r\\n\",\"size\":3,\"title\":\"Container registries affected by {Watchlist} CVEs - Qualys\",\"noDataMessage\":\"No unhealthy container registries found\",\"exportFieldName\":\"Resource\",\"exportParameterName\":\"SelectedCR\",\"showExportToExcel\":true,\"queryType\":7,\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"AffectedResource\",\"comparison\":\"isEqualTo\",\"value\":\"Containers\"},\"showPin\":false,\"name\":\"RegistriesDetails Merged\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"414bfeff-09a7-499e-95fc-c3adbf05dff5\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"TVM\",\"subTarget\":\"ServersTab\",\"style\":\"link\"},{\"id\":\"d835a04d-17a7-4e50-b77a-9a8f0a8b3fba\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Qualys\",\"subTarget\":\"ACRTab\",\"style\":\"link\"}]},\"name\":\"MachinesTabs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"_GetWatchlist('{Watchlist}') | project SearchKey\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{WatchlistWorkspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"Hide\"},\"name\":\"queryCampaign\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//let List = (_GetWatchlist('Log4J')\\r\\n//| where Type == \\\"Vulnerability\\\"\\r\\n//| summarize Detection = make_list(Detection));\\r\\nsecurityresources\\r\\n| where type == \\\"microsoft.security/assessments/subassessments\\\"\\r\\n| extend assessmentKey = extract(\\\".*assessments/(.+?)/.*\\\",1, id)\\r\\n| where assessmentKey == \\\"1195afff-c881-495e-9bc5-1486211ae03f\\\"\\r\\n| project Resource = tolower(extract(\\\"([\\\\\\\\s\\\\\\\\S]*?)(/providers/Microsoft.Security.*)\\\",1,id)), ResourceGroup = trim_end(\\\"/\\\",extract(\\\".*resourceGroups/(.+?)/\\\",0,id)), ResourceType = tolower(split(id,\\\"/\\\").[6]), subscriptionId, status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), description = tostring(parse_json(properties).displayName), cve = parse_json(properties.additionalData).cve, SoftwareVendor = tostring(properties.additionalData.softwareVendor), SoftwareName = tostring(properties.additionalData.softwareName), SoftwareVersion = tostring(properties.additionalData.softwareVersion), Source = tostring(properties.additionalData.source)\\r\\n| where status == 'Unhealthy'\\r\\n| summarize dcount(VulnId) by ResourceGroup, Resource, VulnId, description, tostring(cve), SoftwareVendor, SoftwareName, SoftwareVersion\\r\\n| mvexpand todynamic(cve)\\r\\n| extend CVEs = parse_json(cve['title'])\\r\\n//| summarize CVEs = tostring(make_list(CVEs)), CVECount = count(CVEs) by Resource, ResourceGroup, VulnId, description\\r\\n//| where CVEs has \\\"CVE-2021-44228\\\" or CVEs has \\\"CVE-2021-45046\\\" or CVEs has \\\"CVE-2021-45105\\\"\\r\\n//\\t//CVEs has_any (List)\\r\\n| order by Resource\",\"size\":0,\"showAnalytics\":true,\"title\":\" Machine CVEs - Qualys\",\"noDataMessage\":\"No unhealthy machines found\",\"exportFieldName\":\"Resource\",\"exportParameterName\":\"SelectedServer\",\"exportDefaultValue\":\"All\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Resource\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true}}],\"labelSettings\":[{\"columnId\":\"ResourceGroup\",\"label\":\"Resource group\"},{\"columnId\":\"Resource\",\"label\":\"Machine\"},{\"columnId\":\"VulnId\",\"label\":\"Vuln ID\"},{\"columnId\":\"description\",\"label\":\"Description\"}]}},\"conditionalVisibilities\":[{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"ACRTab\"},{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"Hide\"}],\"name\":\"Qualys\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"Qualys\\\",\\\"rightTable\\\":\\\"queryCampaign\\\",\\\"leftColumn\\\":\\\"CVEs\\\",\\\"rightColumn\\\":\\\"SearchKey\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[TVM].cve\\\",\\\"mergedName\\\":\\\"cve\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[TVM].dcount_VulnId\\\",\\\"mergedName\\\":\\\"dcount_VulnId\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Qualys].ResourceGroup\\\",\\\"mergedName\\\":\\\"Resource group\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[Qualys].Resource\\\",\\\"mergedName\\\":\\\"Machine\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[Qualys].VulnId\\\",\\\"mergedName\\\":\\\"Vuln ID\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[Qualys].description\\\",\\\"mergedName\\\":\\\"Description\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[Qualys].cve\\\",\\\"mergedName\\\":\\\"cve\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[Qualys].SoftwareVendor\\\",\\\"mergedName\\\":\\\"SoftwareVendor\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[Qualys].SoftwareName\\\",\\\"mergedName\\\":\\\"SoftwareName\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[Qualys].SoftwareVersion\\\",\\\"mergedName\\\":\\\"SoftwareVersion\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[Qualys].dcount_VulnId\\\",\\\"mergedName\\\":\\\"dcount_VulnId\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[Qualys].CVEs\\\",\\\"mergedName\\\":\\\"CVEs\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[queryCampaign].SearchKey\\\",\\\"mergedName\\\":\\\"SearchKey\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"}]}\\r\\n\",\"size\":3,\"title\":\" Machines affected by {Watchlist} CVEs - Qualys\",\"noDataMessage\":\"No unhealthy machines found\",\"exportFieldName\":\"Resource\",\"exportParameterName\":\"SelectedServer\",\"showExportToExcel\":true,\"queryType\":7,\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"ACRTab\"},\"showPin\":false,\"name\":\"Qualys Merged\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"securityresources\\r\\n| where type == \\\"microsoft.security/assessments/subassessments\\\"\\r\\n| extend assessmentKey = extract(\\\".*assessments/(.+?)/.*\\\",1, id)\\r\\n| where assessmentKey == \\\"1195afff-c881-495e-9bc5-1486211ae03f\\\"\\r\\n| project Resource = tolower(extract(\\\"([\\\\\\\\s\\\\\\\\S]*?)(/providers/Microsoft.Security.*)\\\",1,id)), ResourceGroup = trim_end(\\\"/\\\",extract(\\\".*resourceGroups/(.+?)/\\\",0,id)), ResourceType = tolower(split(id,\\\"/\\\").[6]), subscriptionId, status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), description = tostring(parse_json(properties).displayName), cve = parse_json(properties.additionalData).cve, SoftwareVendor = tostring(properties.additionalData.softwareVendor), SoftwareName = tostring(properties.additionalData.softwareName), SoftwareVersion = tostring(properties.additionalData.softwareVersion), Source = tostring(properties.additionalData.source)\\r\\n| where status == 'Unhealthy'\\r\\n| where Source == \\\"Microsoft threat and vulnerability management\\\"\\r\\n| summarize dcount(VulnId) by ResourceGroup, Resource, VulnId, description, tostring(cve), SoftwareVendor, SoftwareName, SoftwareVersion\\r\\n| mvexpand todynamic(cve)\\r\\n| extend CVEs = parse_json(cve['title'])\\r\\n//| summarize CVEs = tostring(make_list(CVEs)), CVECount = count(CVEs) by Resource, ResourceGroup, VulnId, description, SoftwareVendor, SoftwareName, SoftwareVersion\\r\\n//| where CVEs has \\\"CVE-2021-44228\\\" or CVEs has \\\"CVE-2021-45046\\\" or CVEs has \\\"CVE-2021-45105\\\"\\r\\n| order by Resource\",\"size\":0,\"showAnalytics\":true,\"title\":\"Machines - Microsoft threat and vulnerability management\",\"noDataMessage\":\"No unhealthy machines found\",\"exportFieldName\":\"Resource\",\"exportParameterName\":\"selectedsrvitem\",\"exportDefaultValue\":\"All\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"value::all\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Resource\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"ResourceGroup\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"25ch\"}},{\"columnMatch\":\"VulnId\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"12ch\"}},{\"columnMatch\":\"description\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"28ch\"}},{\"columnMatch\":\"SoftwareVersion\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"19ch\"}}],\"filter\":true,\"sortBy\":[{\"itemKey\":\"VulnId\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"ResourceGroup\",\"label\":\"Resource group\"},{\"columnId\":\"Resource\",\"label\":\"Machine\"},{\"columnId\":\"VulnId\",\"label\":\"Vuln ID\"},{\"columnId\":\"description\",\"label\":\"Description\"},{\"columnId\":\"SoftwareVendor\",\"label\":\"Software vendor\"},{\"columnId\":\"SoftwareName\",\"label\":\"Software name\"},{\"columnId\":\"SoftwareVersion\",\"label\":\"Software version\"},{\"columnId\":\"CVEs\",\"label\":\"CVEs \"}]},\"sortBy\":[{\"itemKey\":\"VulnId\",\"sortOrder\":2}]},\"conditionalVisibilities\":[{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"ServersTab\"},{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"Hide\"}],\"name\":\"TVM\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"TVM\\\",\\\"rightTable\\\":\\\"queryCampaign\\\",\\\"leftColumn\\\":\\\"CVEs\\\",\\\"rightColumn\\\":\\\"SearchKey\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[TVM].Resource\\\",\\\"mergedName\\\":\\\"Machine\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[TVM].ResourceGroup\\\",\\\"mergedName\\\":\\\"Resource group\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[TVM].VulnId\\\",\\\"mergedName\\\":\\\"Vuln ID\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[TVM].description\\\",\\\"mergedName\\\":\\\"Description\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[TVM].SoftwareVendor\\\",\\\"mergedName\\\":\\\"Software vendor\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[TVM].SoftwareName\\\",\\\"mergedName\\\":\\\"Software name\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[TVM].SoftwareVersion\\\",\\\"mergedName\\\":\\\"Software version\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[TVM].CVEs\\\",\\\"mergedName\\\":\\\"CVEs \\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[TVM].CVECount\\\",\\\"mergedName\\\":\\\"CVE count\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[queryCampaign].SearchKey\\\",\\\"mergedName\\\":\\\"SearchKey\\\",\\\"fromId\\\":\\\"6946e113-fce5-43cc-a36d-d78bd41a20d4\\\"},{\\\"originalName\\\":\\\"[TVM].cve\\\",\\\"mergedName\\\":\\\"cve\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[TVM].dcount_VulnId\\\",\\\"mergedName\\\":\\\"dcount_VulnId\\\",\\\"fromId\\\":\\\"unknown\\\"}]}\\r\\n\",\"size\":3,\"title\":\"Machines affected by {Watchlist} CVEs - Microsoft threat and vulnerability management\",\"noDataMessage\":\"No unhealthy machines found\",\"exportFieldName\":\"Resource\",\"exportParameterName\":\"selectedsrvitem\",\"showExportToExcel\":true,\"queryType\":7,\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"ServersTab\"},\"showPin\":false,\"name\":\"TVM Merged\"}]},\"conditionalVisibility\":{\"parameterName\":\"AffectedResource\",\"comparison\":\"isEqualTo\",\"value\":\"Machines\"},\"name\":\"group - 4\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"MDC\"},\"name\":\"group - ASCwb\"}]},\"name\":\"group - 7\",\"styleSettings\":{\"showBorder\":true}}],\"fromTemplateId\":\"sentinel-Log4j-ImpactAssessment\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId2'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=Log4jImpactAssessmentWorkbook; logoFileName=Log4j.svg; description=This hunting workbook is intended to help identify activity related to the Log4j compromise discovered in December 2021.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Log4j Impact Assessment; templateRelativePath=Log4jImpactAssessment.json; subtitle=; provider=Microsoft Sentinel Community}.description",
                "parentId": "[variables('workbookId2')]",
                "contentId": "[variables('_workbookContentId2')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "SecurityIncident",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "SecurityAlert",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "AzureSecurityCenter",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "MDfESecureScore_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "MDfEExposureScore_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "MDfERecommendations_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "MDfEVulnerabilitiesList_CL",
                      "kind": "DataType"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId2')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook2-name')]",
        "contentProductId": "[variables('_workbookcontentProductId2')]",
        "id": "[variables('_workbookcontentProductId2')]",
        "version": "[variables('workbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Log4jVulnerableMachines_AnalyticalRules Analytics Rule with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query uses the Azure Defender Security Nested Recommendations data to find machines vulnerable to log4j CVE-2021-44228. Log4j is an open-source Apache logging library that is used in\n many Java-based applications. Security Nested Recommendations data is sent to Microsoft Sentinel using the continuous export feature of Azure Defender(refrence link below).\n Reference: https://msrc-blog.microsoft.com/2021/12/11/microsofts-response-to-cve-2021-44228-apache-log4j2/\n Reference: https://docs.microsoft.com/azure/security-center/continuous-export?tabs=azure-portal\n Reference: https://techcommunity.microsoft.com/t5/microsoft-defender-for-cloud/how-defender-for-cloud-displays-machines-affected-by-log4j/ba-p/3037271",
                "displayName": "Vulnerable Machines related to log4j CVE-2021-44228",
                "enabled": false,
                "query": "SecurityNestedRecommendation\n| where RemediationDescription has 'CVE-2021-44228'\n| parse ResourceDetails with * 'virtualMachines/' VirtualMachine '\"' *\n| summarize arg_min(TimeGenerated, *) by TenantId, RecommendationSubscriptionId, VirtualMachine, RecommendationName,Description,RemediationDescription, tostring(AdditionalData),VulnerabilityId\n| extend Timestamp = TimeGenerated\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": "[variables('TemplateEmptyArray')]",
                "tactics": [
                  "InitialAccess",
                  "Execution"
                ],
                "techniques": [
                  "T1190",
                  "T1203"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "HostName",
                        "columnName": "VirtualMachine"
                      }
                    ],
                    "entityType": "Host"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Analytics Rule 1",
                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
        "contentKind": "AnalyticsRule",
        "displayName": "Vulnerable Machines related to log4j CVE-2021-44228",
        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AzureWAFmatching_log4j_vuln_AnalyticalRules Analytics Rule with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query will alert on a positive pattern match by Azure WAF for CVE-2021-44228 log4j vulnerability exploitation attempt. If possible, it then decodes the malicious command for further analysis.\n Refrence: https://www.microsoft.com/security/blog/2021/12/11/guidance-for-preventing-detecting-and-hunting-for-cve-2021-44228-log4j-2-exploitation/",
                "displayName": "Azure WAF matching for Log4j vuln(CVE-2021-44228)",
                "enabled": false,
                "query": "let log4jioc = dynamic([\"jndi\",\"ldap\",\"${::\"]);\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.NETWORK\" and Category in (\"ApplicationGatewayFirewallLog\", \"FrontdoorWebApplicationFirewallLog\")\n| extend details_data_s = column_ifexists(\"details_data_s\", tostring(AdditionalFields.details_data))\n|where requestUri_s has_any (log4jioc) or details_message_s has_any (log4jioc) or details_data_s has_any (log4jioc)\n| extend Malicious = iff(isnotempty( details_data_s),details_data_s,iff(isnotempty( requestUri_s),requestUri_s,\"\"))\n|parse Malicious with * '${' MaliciousCommand '}' * \n| extend EncodeCmd = iff(MaliciousCommand has 'Base64/', split(split(MaliciousCommand, \"Base64/\",1)[0], \"}\", 0)[0], \"\")\n| extend EncodeCmd1 = iff(MaliciousCommand has 'base64/', split(split(MaliciousCommand, \"base64/\",1)[0], \"}\", 0)[0], \"\")\n| extend CmdLine = iff( isnotempty(EncodeCmd), EncodeCmd, EncodeCmd1)\n| extend DecodedCmdLine = base64_decode_tostring(tostring(CmdLine))\n| extend DecodedCmdLine = iff( isnotempty(DecodedCmdLine), DecodedCmdLine, \"Unable to decode/Doesn't need decoding\")\n| project TimeGenerated, Target=column_ifexists(\"hostname_s\", tostring(AdditionalFields.hostname)), MaliciousHost = column_ifexists(\"clientIp_s\", tostring(AdditionalFields.clientIp)) , MaliciousCommand, details_data_s = column_ifexists(\"details_data_s\", tostring(AdditionalFields.details_data)), DecodedCmdLine, Message,\nruleSetType_s = column_ifexists(\"ruleSetType_s\", tostring(AdditionalFields.ruleSetType)), OperationName, SubscriptionId, details_message_s = column_ifexists(\"details_message_s\", tostring(AdditionalFields.details_message)), \ndetails_file_s = column_ifexists(\"details_message_s\", tostring(AdditionalFields.details_file))\n| extend timestamp = TimeGenerated\n",
                "queryFrequency": "PT6H",
                "queryPeriod": "PT6H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "AzureDiagnostics"
                    ],
                    "connectorId": "WAF"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1190"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "MaliciousHost"
                      }
                    ],
                    "entityType": "IP"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Analytics Rule 2",
                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
        "contentKind": "AnalyticsRule",
        "displayName": "Azure WAF matching for Log4j vuln(CVE-2021-44228)",
        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject3').analyticRuleTemplateSpecName3]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Log4J_IPIOC_Dec112021_AnalyticalRules Analytics Rule with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject3').analyticRuleVersion3]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies a match across various data feeds for IP IOCs related to the Log4j vulnerability exploit aka Log4Shell described in CVE-2021-44228.\n References: https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-44228",
                "displayName": "Log4j vulnerability exploit aka Log4Shell IP IOC",
                "enabled": false,
                "query": "let IPList = externaldata(IPAddress:string)[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Log4j_IOC_List.csv\"] with (format=\"csv\", ignoreFirstRecord=True);\nlet IPRegex = '[0-9]{1,3}\\\\.[0-9]{1,3}\\\\.[0-9]{1,3}\\\\.[0-9]{1,3}';\n//Network logs\nlet CSlogSourceIP = CommonSecurityLog | summarize by IPAddress = SourceIP, Type;\nlet CSlogDestIP = CommonSecurityLog | summarize by IPAddress = DestinationIP, Type;\nlet CSlogMsgIP = CommonSecurityLog | extend MessageIP = extract(IPRegex, 0, Message) | summarize by IPAddress = MessageIP, Type;\nlet DnsIP = DnsEvents | summarize by IPAddress = IPAddresses, Type;\n// If you have enabled the _Im_Dns and/or imNetworkSession normalization in your workspace, you can uncomment one or both below.  Reference - https://docs.microsoft.com/azure/sentinel/normalization\n//let imDnsIP = _Im_Dns (response_has_any_prefix=IPList) | summarize by IPAddress = ResponseName, Type;\n//let imNetSessIP = imNetworkSession (dstipaddr_has_any_prefix=IPList) | summarize by IPAddress = DstIpAddr, Type;\n//Cloud service logs\nlet officeIP = OfficeActivity | summarize by IPAddress = ClientIP, Type;\nlet signinIP = SigninLogs | summarize by IPAddress, Type;\nlet nonintSigninIP = AADNonInteractiveUserSignInLogs | summarize by IPAddress, Type;\nlet azureActIP = AzureActivity | summarize by IPAddress = CallerIpAddress, Type;\nlet awsCtIP = AWSCloudTrail | summarize by IPAddress = SourceIpAddress, Type;\n//Device logs\nlet vmConnSourceIP = VMConnection | summarize by IPAddress = SourceIp, Type;\nlet vmConnDestIP = VMConnection | summarize by IPAddress = DestinationIp, Type;\nlet iisLogIP = W3CIISLog | summarize by IPAddress = cIP, Type;\nlet devNetIP = DeviceNetworkEvents | summarize by IPAddress = RemoteIP, Type;\n//need to parse to get IP\nlet azureDiagIP = AzureDiagnostics | where ResourceType == \"AZUREFIREWALLS\" | where Category in (\"AzureFirewallApplicationRule\", \"AzureFirewallNetworkRule\")\n| where msg_s has_any (IPList) | parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action | summarize by IPAddress = DestinationHost, Type;\nlet sysEvtIP = Event | where Source == \"Microsoft-Windows-Sysmon\" | where EventID == 3 | where EventData has_any (IPList) | extend EvData = parse_xml(EventData)\n| extend EventDetail = EvData.DataItem.EventData.Data\n| extend SourceIP = tostring(EventDetail.[9].[\"#text\"]), DestinationIP = tostring(EventDetail.[14].[\"#text\"])\n| where SourceIP in (IPList) or DestinationIP in (IPList) | extend IPAddress = iff(SourceIP in (IPList), SourceIP, DestinationIP) | summarize by IPAddress, Type;\n// If you have enabled the _Im_DNS and/or imNetworkSession normalization in your workdspace, you can uncomment below and include. Reference - https://docs.microsoft.com/azure/sentinel/normalization\n//let ipsort = union isfuzzy=true CSlogDestIP, CSlogMsgIP, CSlogSourceIP, DnsIP, officeIP, signinIP, nonintSigninIP, azureActIP, awsCtIP, vmConnDestIP, vmConnSourceIP, azureDiagIP, sysEvtIP, imDnsIP, imNetSessIP\n// If you uncomment above, then comment out the line below\nlet ipsort = union isfuzzy=true CSlogDestIP, CSlogMsgIP, CSlogSourceIP, DnsIP, officeIP, signinIP, nonintSigninIP, azureActIP, awsCtIP, vmConnDestIP, vmConnSourceIP, azureDiagIP, sysEvtIP\n| summarize by IPAddress\n| where isnotempty(IPAddress) | where not(ipv4_is_private(IPAddress)) and IPAddress !in ('0.0.0.0','127.0.0.1');\nlet ipMatch = ipsort | where IPAddress in (IPList);\n(union isfuzzy=true\n(CommonSecurityLog\n| where SourceIP in (ipMatch) or DestinationIP in (ipMatch) or Message has_any (ipMatch)\n| project TimeGenerated, SourceIP, DestinationIP, Message, SourceUserID, RequestURL, Type\n| extend MessageIP = extract(IPRegex, 0, Message)\n| extend IPMatch = case(SourceIP in (ipMatch), \"SourceIP\", DestinationIP in (ipMatch), \"DestinationIP\", MessageIP in (ipMatch), \"Message\", \"No Match\")\n| extend timestamp = TimeGenerated, IPEntity = case(IPMatch == \"SourceIP\", SourceIP, IPMatch == \"DestinationIP\", DestinationIP, IPMatch == \"Message\", MessageIP, \"No Match\")\n),\n(OfficeActivity\n| where  ClientIP in (ipMatch)\n| project TimeGenerated, UserAgent, Operation, RecordType, UserId, ClientIP, Type\n| extend SourceIPAddress = ClientIP, Account = UserId\n| extend timestamp = TimeGenerated , IPEntity = SourceIPAddress , AccountEntity = Account\n),\n(DnsEvents\n| where  IPAddresses has_any (ipMatch)\n| project TimeGenerated, Computer, IPAddresses, Name, ClientIP, Type\n| extend DestinationIPAddress = IPAddresses,  Host = Computer\n| extend timestamp = TimeGenerated, IPEntity = DestinationIPAddress, HostEntity = Host\n),\n(VMConnection\n| where SourceIp in (ipMatch) or DestinationIp in (ipMatch)\n| project TimeGenerated, Computer, SourceIp, DestinationIp, Type\n| extend IPMatch = case( SourceIp in (ipMatch), \"SourceIP\", DestinationIp in (ipMatch), \"DestinationIP\", \"None\")\n| extend timestamp = TimeGenerated , IPEntity = case(IPMatch == \"SourceIP\", SourceIp, IPMatch == \"DestinationIP\", DestinationIp, \"None\"), Host = Computer\n),\n(Event\n| where Source =~ \"Microsoft-Windows-Sysmon\"\n| where EventID == 3\n| where EventData has_any (ipMatch)\n| project TimeGenerated, EventData, UserName, Computer, Type\n| extend EvData = parse_xml(EventData)\n| extend EventDetail = EvData.DataItem.EventData.Data\n| extend SourceIP = tostring(EventDetail.[9].[\"#text\"]), DestinationIP = tostring(EventDetail.[14].[\"#text\"])\n| where SourceIP in (ipMatch) or DestinationIP in (ipMatch)\n| extend IPMatch = case( SourceIP in (ipMatch), \"SourceIP\", DestinationIP in (ipMatch), \"DestinationIP\", \"None\")\n| extend timestamp = TimeGenerated, AccountEntity = UserName, HostEntity = Computer , IPEntity = case(IPMatch == \"SourceIP\", SourceIP, IPMatch == \"DestinationIP\", DestinationIP, \"None\")\n),\n(SigninLogs\n| where IPAddress in (ipMatch)\n| project TimeGenerated, UserPrincipalName, IPAddress, Type\n| extend timestamp = TimeGenerated, AccountEntity = UserPrincipalName, IPEntity = IPAddress\n),\n(AADNonInteractiveUserSignInLogs\n| where IPAddress in (ipMatch)\n| project TimeGenerated, UserPrincipalName, IPAddress, Type\n| extend timestamp = TimeGenerated, AccountEntity = UserPrincipalName, IPEntity = IPAddress\n),\n(W3CIISLog\n| where cIP in (ipMatch)\n| project TimeGenerated, Computer, cIP, csUserName, Type\n| extend timestamp = TimeGenerated, IPEntity = cIP, HostEntity = Computer, AccountEntity = csUserName\n),\n(AzureActivity\n| where CallerIpAddress in (ipMatch)\n| project TimeGenerated, CallerIpAddress, Caller, Type\n| extend timestamp = TimeGenerated, IPEntity = CallerIpAddress, AccountEntity = Caller\n),\n(\nAWSCloudTrail\n| where SourceIpAddress in (ipMatch)\n| project TimeGenerated, SourceIpAddress, UserIdentityUserName, Type\n| extend timestamp = TimeGenerated, IPEntity = SourceIpAddress, AccountEntity = UserIdentityUserName\n),\n(\nDeviceNetworkEvents\n| where RemoteIP in (ipMatch)\n| where ActionType =~ \"InboundConnectionAccepted\"\n| project TimeGenerated, RemoteIP, DeviceName, Type\n| extend timestamp = TimeGenerated, IPEntity = RemoteIP, HostEntity = DeviceName\n),\n(\nAzureDiagnostics\n| where ResourceType =~ \"AZUREFIREWALLS\"\n| where Category in (\"AzureFirewallApplicationRule\", \"AzureFirewallNetworkRule\")\n| where msg_s has_any (ipMatch)\n| project TimeGenerated, msg_s, Type\n| parse msg_s with Protocol 'request from ' SourceIP ':' SourcePort 'to ' DestinationIP ':' DestinationPort '. Action:' Action\n| where DestinationIP has_any (ipMatch)\n| extend timestamp = TimeGenerated, IPEntity = DestinationIP\n)\n// If you have enabled the _Im_Dns and/or imNetworkSession normalization in your workdspace, you can uncomment below and include. Reference - https://docs.microsoft.com/azure/sentinel/normalization\n//,\n//(_Im_Dns (response_has_any_prefix=IPList)\n//| project TimeGenerated, ResponseName, SrcIpAddr, Type\n//| extend DestinationIPAddress = ResponseName,  Host = SrcIpAddr\n//| extend timestamp = TimeGenerated, IPEntity = DestinationIPAddress, HostEntity = Host\n//),\n//(imNetworkSession (dstipaddr_has_any_prefix=IPList)\n//| project TimeGenerated, DstIpAddr, SrcIpAddr, Type\n//| extend timestamp = TimeGenerated, IPEntity = DstIpAddr, HostEntity = SrcIpAddr\n//)\n)\n| extend Name = tostring(split(AccountEntity, '@', 0)[0]), UPNSuffix = tostring(split(AccountEntity, '@', 1)[0])\n| extend HostName = tostring(split(HostEntity, '.', 0)[0]), DnsDomain = tostring(strcat_array(array_slice(split(HostEntity, '.'), 1, -1), '.'))\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "OfficeActivity"
                    ],
                    "connectorId": "Office365"
                  },
                  {
                    "dataTypes": [
                      "DnsEvents"
                    ],
                    "connectorId": "DNS"
                  },
                  {
                    "dataTypes": [
                      "VMConnection"
                    ],
                    "connectorId": "AzureMonitor(VMInsights)"
                  },
                  {
                    "dataTypes": [
                      "CommonSecurityLog"
                    ],
                    "connectorId": "CiscoASA"
                  },
                  {
                    "dataTypes": [
                      "CommonSecurityLog"
                    ],
                    "connectorId": "PaloAltoNetworks"
                  },
                  {
                    "dataTypes": [
                      "SecurityEvent"
                    ],
                    "connectorId": "SecurityEvents"
                  },
                  {
                    "dataTypes": [
                      "SigninLogs"
                    ],
                    "connectorId": "AzureActiveDirectory"
                  },
                  {
                    "dataTypes": [
                      "AADNonInteractiveUserSignInLogs"
                    ],
                    "connectorId": "AzureActiveDirectory"
                  },
                  {
                    "dataTypes": [
                      "WireData"
                    ],
                    "connectorId": "AzureMonitor(WireData)"
                  },
                  {
                    "dataTypes": [
                      "W3CIISLog"
                    ],
                    "connectorId": "AzureMonitor(IIS)"
                  },
                  {
                    "dataTypes": [
                      "AzureActivity"
                    ],
                    "connectorId": "AzureActivity"
                  },
                  {
                    "dataTypes": [
                      "AWSCloudTrail"
                    ],
                    "connectorId": "AWS"
                  },
                  {
                    "dataTypes": [
                      "DeviceNetworkEvents"
                    ],
                    "connectorId": "MicrosoftThreatProtection"
                  },
                  {
                    "dataTypes": [
                      "AzureDiagnostics"
                    ],
                    "connectorId": "AzureFirewall"
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "Name"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "identifier": "HostName",
                        "columnName": "HostName"
                      },
                      {
                        "identifier": "DnsDomain",
                        "columnName": "DnsDomain"
                      }
                    ],
                    "entityType": "Host"
                  },
                  {
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "IPEntity"
                      }
                    ],
                    "entityType": "IP"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject3').analyticRuleId3,'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Analytics Rule 3",
                "parentId": "[variables('analyticRuleObject3').analyticRuleId3]",
                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
        "contentKind": "AnalyticsRule",
        "displayName": "Log4j vulnerability exploit aka Log4Shell IP IOC",
        "contentProductId": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "id": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject4').analyticRuleTemplateSpecName4]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "UserAgentSearch_log4j_AnalyticalRules Analytics Rule with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject4').analyticRuleVersion4]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query uses various log sources having user agent data to look for log4j CVE-2021-44228 exploitation attempt based on user agent pattern. Log4j is an open-source Apache logging library that is used in \n many Java-based applications. The regex and the string matching look for the most common attacks. This might not be comprehensive to detect every possible user agent variation.\n Reference: https://msrc-blog.microsoft.com/2021/12/11/microsofts-response-to-cve-2021-44228-apache-log4j2/",
                "displayName": "User agent search for log4j exploitation attempt",
                "enabled": false,
                "query": "let UserAgentString = dynamic ([\"${jndi:ldap:/\", \"${jndi:rmi:/\", \"${jndi:ldaps:/\", \"${jndi:dns:/\", \"${jndi:iiop:/\",\"${jndi:\",\"${jndi:nds:/\",\"${jndi:corba/\"]);\nlet UARegexMinimalString=dynamic(['{','%7b', '%7B']);\nlet UARegex = @'(\\\\$|%24)(\\\\{|%7B)([^jJ]*[jJ])([^nN]*[nN])([^dD]*[dD])([^iI]*[iI])(:|%3A|\\\\$|%24|}|%7D)';\n(union isfuzzy=true\n(OfficeActivity\n| where UserAgent has_any (UserAgentString) or UserAgent matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = ClientIP, Account = UserId, Type, Operation\n),\n(AzureDiagnostics\n| where Category in (\"FrontdoorWebApplicationFirewallLog\", \"FrontdoorAccessLog\", \"ApplicationGatewayFirewallLog\", \"ApplicationGatewayAccessLog\")\n| where userAgent_s has_any (UserAgentString) or userAgent_s matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent = userAgent_s, SourceIP = column_ifexists(\"clientIp_s\",clientIP_s), Type, column_ifexists(\"originalHost_s\",host_s), Url = requestUri_s, HttpStatus = column_ifexists(\"httpStatusDetails_s\",httpStatus_d), column_ifexists(\"transactionId_g\",trackingReference_s), ruleName_s, ResourceType, ResourceId\n),\n(\nW3CIISLog\n| where csUserAgent has_any (UserAgentString) or csUserAgent matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent = csUserAgent, SourceIP = cIP, Account = csUserName, Type, sSiteName, csMethod, Url = csUriStem\n),\n(\nAWSCloudTrail\n| where UserAgent has_any (UserAgentString) or UserAgent matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = SourceIpAddress, Account = UserIdentityUserName, Type, EventName\n),\n(SigninLogs\n| where UserAgent has_any (UserAgentString) or UserAgent matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = IPAddress, Account = UserPrincipalName, Type, Operation = OperationName, tostring(LocationDetails), tostring(DeviceDetail),    AppDisplayName, ClientAppUsed\n),\n(AADNonInteractiveUserSignInLogs \n| where UserAgent has_any (UserAgentString) or UserAgent matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = IPAddress, Account = UserPrincipalName, Type, Operation = OperationName, tostring(LocationDetails), tostring(DeviceDetail), AppDisplayName, ClientAppUsed\n),\n(_Im_WebSession (httpuseragent_has_any=array_concat(UserAgentString,UARegexMinimalString))\n| where HttpUserAgent has_any (UserAgentString) or HttpUserAgent matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by HttpUserAgent, SourceIP = SrcIpAddr, DstIpAddr, Account = SrcUsername, Url, Type\n)\n)\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "SquidProxy_CL"
                    ],
                    "connectorId": "SquidProxy"
                  },
                  {
                    "dataTypes": [
                      "CommonSecurityLog"
                    ],
                    "connectorId": "Zscaler"
                  },
                  {
                    "dataTypes": [
                      "AzureDiagnostics"
                    ],
                    "connectorId": "WAF"
                  },
                  {
                    "dataTypes": [
                      "OfficeActivity"
                    ],
                    "connectorId": "Office365"
                  },
                  {
                    "dataTypes": [
                      "SigninLogs"
                    ],
                    "connectorId": "AzureActiveDirectory"
                  },
                  {
                    "dataTypes": [
                      "AADNonInteractiveUserSignInLogs"
                    ],
                    "connectorId": "AzureActiveDirectory"
                  },
                  {
                    "dataTypes": [
                      "AWSCloudTrail"
                    ],
                    "connectorId": "AWS"
                  },
                  {
                    "dataTypes": [
                      "W3CIISLog"
                    ],
                    "connectorId": "AzureMonitor(IIS)"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1190"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "Url",
                        "columnName": "Url"
                      }
                    ],
                    "entityType": "URL"
                  },
                  {
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "SourceIP"
                      }
                    ],
                    "entityType": "IP"
                  },
                  {
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "Account"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject4').analyticRuleId4,'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Analytics Rule 4",
                "parentId": "[variables('analyticRuleObject4').analyticRuleId4]",
                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
        "contentKind": "AnalyticsRule",
        "displayName": "User agent search for log4j exploitation attempt",
        "contentProductId": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "id": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject1').huntingQueryTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "WAF_log4j_vulnerability_HuntingQueries Hunting Query with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject1').huntingQueryVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Apache_Log4j_Vulnerability_Detection_Hunting_Query_1",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Azure WAF Log4j CVE-2021-44228 hunting",
                "category": "Hunting Queries",
                "query": "let log4jcmdstring = dynamic([\"${jndi:ldap\",\"${jndi:dns\",\"${jndi:rmi\",\"${jndi:corba\",\"${jndi:iiop\",\"${jndi:nis\",\"${jndi:nds\"]);\nlet log4jRegex = @'(\\\\$|%24)(\\\\{|%7B)([^jJ]*[jJ])([^nN]*[nN])([^dD]*[dD])([^iI]*[iI])(:|%3A|\\\\$|%24|}|%7D)';\nAzureDiagnostics\n| where Category in~ (\"FrontdoorWebApplicationFirewallLog\", \"FrontdoorAccessLog\", \"ApplicationGatewayFirewallLog\", \"ApplicationGatewayAccessLog\")\n //Extending the columns to aviod failures.\n| extend originalRequestUriWithArgs_s = column_ifexists(\"originalRequestUriWithArgs_s\", \"\"), \n  userAgent_s = column_ifexists(\"userAgent_s\", \"\"), \n  clientIP_s = column_ifexists(\"clientIP_s\", \"\"),  \n  clientPort_d = column_ifexists(\"originalRequestUriWithArgs_s\", \"\"),\n  host_s = column_ifexists(\"host_s\", \"\"),\n  requestUri_s = column_ifexists(\"requestUri_s\", \"\"),\n  httpStatus_d = column_ifexists(\"httpStatus_d\",\"\"),\n  listenerName_s = column_ifexists(\"listenerName_s\", \"\"),\n  httpMethod_s = column_ifexists(\"httpMethod_s\", \"\")\n //The regex and the string matching look for the most common attacks. This is not supposed to be comprehensive.\n| where originalRequestUriWithArgs_s has_any (log4jcmdstring) or originalRequestUriWithArgs_s matches regex log4jRegex or userAgent_s has_any (log4jcmdstring) or  userAgent_s matches regex log4jRegex\n| extend CmdLine = iff(originalRequestUriWithArgs_s has 'Base64/', split(split(originalRequestUriWithArgs_s, \"Base64/\",1)[0], \"}\", 0)[0], split(split(userAgent_s, \"Base64/\",1)[0], \"}\", 0)[0])\n| extend CmdLine = base64_decode_tostring(tostring(CmdLine))\n| where CmdLine has_any (\"wget\",\"curl\")\n| summarize Total = count() by originalRequestUriWithArgs_s, userAgent_s, clientIP_s,clientPort_d, TimeGenerated, host_s, requestUri_s, httpStatus_d,listenerName_s, CmdLine, httpMethod_s, Category\n| extend IP_0_Address = clientIP_s\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This hunting query searches possible exploitation attempts for CVE-2021-44228 involving log4j vulnerability in Azure Web Application Firewall   logs."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1190"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject1')._huntingQuerycontentId1),'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Hunting Query 1",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject1')._huntingQuerycontentId1)]",
                "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject1').huntingQueryVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
        "contentKind": "HuntingQuery",
        "displayName": "Azure WAF Log4j CVE-2021-44228 hunting",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject1')._huntingQuerycontentId1,'-', '1.0.4')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject1')._huntingQuerycontentId1,'-', '1.0.4')))]",
        "version": "1.0.4"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject2').huntingQueryTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "NetworkConnectionldap_log4j_HuntingQueries Hunting Query with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject2').huntingQueryVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Apache_Log4j_Vulnerability_Detection_Hunting_Query_2",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malicious Connection to LDAP port for CVE-2021-44228 vulnerability",
                "category": "Hunting Queries",
                "query": "let Port = dynamic(['389', '1389']); \n(union isfuzzy=true\n(DeviceNetworkEvents\n| where InitiatingProcessFileName has_any (\"javaw.exe\",\"java.exe\")\n| where ActionType has \"ConnectionSuccess\"\n| where RemotePort in ('389', '1389')\n| where InitiatingProcessCommandLine has_any ('curl', 'wget')\n| where RemoteIPType =~ 'Public'\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by ActionType, DestinationIP = RemoteIP, RemoteUrl, DestinationPort = RemotePort, SourceIP = LocalIP, Type, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath,  InitiatingProcessParentFileName, ProcessName = InitiatingProcessFileName, Computer = DeviceName\n),\n(VMConnection\n| where ProcessName has_any (\"javaw\",\"java\")\n| where DestinationPort in ('389', '1389')\n| where ipv4_is_private(DestinationIp) == false\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by TimeGenerated, SourceIP = SourceIp , DestinationIP = DestinationIp, DestinationPort,  BytesReceived, BytesSent, ProcessName, Computer\n)\n)\n| extend HostName = tostring(split(Computer, '.', 0)[0]), DnsDomain = tostring(strcat_array(array_slice(split(Computer, '.'), 1, -1), '.'))\n| extend Host_0_HostName = HostName\n| extend Host_0_DnsDomain = DnsDomain\n| extend IP_0_Address = DestinationIP\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query detects exploitation attempts for CVE-2021-44228 involving log4j vulnerability by looking for connections to default LDAP ports."
                  },
                  {
                    "name": "tactics",
                    "value": "CommandAndControl"
                  },
                  {
                    "name": "techniques",
                    "value": "T1071"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject2')._huntingQuerycontentId2),'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Hunting Query 2",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject2')._huntingQuerycontentId2)]",
                "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject2').huntingQueryVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
        "contentKind": "HuntingQuery",
        "displayName": "Malicious Connection to LDAP port for CVE-2021-44228 vulnerability",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject2')._huntingQuerycontentId2,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject2')._huntingQuerycontentId2,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject3').huntingQueryTemplateSpecName3]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Firewall_Disable_Activity_HuntingQueries Hunting Query with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject3').huntingQueryVersion3]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Apache_Log4j_Vulnerability_Detection_Hunting_Query_3",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Suspicious manipulation of firewall detected via Syslog data",
                "category": "Hunting Queries",
                "query": "Syslog\n| where Facility == 'user'\n| where SyslogMessage has \"AUOMS_EXECVE\"\n| parse SyslogMessage with \"type=\" EventType \" audit(\" * \"): \" EventData\n| where EventType =~ \"AUOMS_EXECVE\"\n| parse EventData with * \"syscall=\" syscall \" syscall_r=\" * \" success=\" success \" exit=\" exit \" a0\" * \" ppid=\" ppid \" pid=\" pid \" audit_user=\" audit_user \" auid=\" auid \" user=\" user \" uid=\" uid \" group=\" group \" gid=\" gid \"effective_user=\" effective_user \" euid=\" euid \" set_user=\" set_user \" suid=\" suid \" filesystem_user=\" filesystem_user \" fsuid=\" fsuid \" effective_group=\" effective_group \" egid=\" egid \" set_group=\" set_group \" sgid=\" sgid \" filesystem_group=\" filesystem_group \" fsgid=\" fsgid \" tty=\" tty \" ses=\" ses \" comm=\\\"\" comm \"\\\" exe=\\\"\" exe \"\\\"\" * \"cwd=\\\"\" cwd \"\\\"\" * \"name=\\\"\" name \"\\\"\" * \"cmdline=\" cmdline\n| extend cmdline = trim_end('redactors=.*',cmdline) \n| where cmdline has_any (\"SuSEfirewall2 stop\",\"reSuSEfirewall2 stop\",\"ufw stop\",\"ufw disable\")\n| project TimeGenerated, Computer, audit_user, user, cmdline\n| extend timestamp = TimeGenerated\n| extend Account_0_Name = user\n| extend Host_0_HostName = Computer\n| sort by TimeGenerated desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for any suspicious manipulation of firewall often performed by attackers after exploiting remote code execution vulnerability in Log4j component of Apache for C2 communications or exfiltration."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject3')._huntingQuerycontentId3),'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Hunting Query 3",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject3')._huntingQuerycontentId3)]",
                "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject3').huntingQueryVersion3]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
        "contentKind": "HuntingQuery",
        "displayName": "Suspicious manipulation of firewall detected via Syslog data",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject3')._huntingQuerycontentId3,'-', '1.0.3')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject3')._huntingQuerycontentId3,'-', '1.0.3')))]",
        "version": "1.0.3"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject4').huntingQueryTemplateSpecName4]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Apache_log4j_Vulnerability_HuntingQueries Hunting Query with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject4').huntingQueryVersion4]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Apache_Log4j_Vulnerability_Detection_Hunting_Query_4",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Possible exploitation of Apache log4j component detected",
                "category": "Hunting Queries",
                "query": "let log4j_execve=()\n{\n  Syslog\n  | where SyslogMessage has \"AUOMS_EXECVE\"\n  | where SyslogMessage has 'jndi' and SyslogMessage has_any ('ldap', 'dns', 'rmi', 'corba', 'iiop', 'nis', 'nds')\n  | parse SyslogMessage with \"type=\" EventType \" audit(\" * \"): \" EventData\n  | where EventType =~ \"AUOMS_EXECVE\"\n  | project TimeGenerated, EventType, Computer, EventData\n  | extend EventData = trim_end('containerid=',EventData)\n  | parse kind=regex EventData with * \"success=\" success \" exit=\" * \"ppid=\" ppid \"pid=\" pid\n  \"audit_user=\" audit_user \"auid=\" * \"user=\" user \" uid=\" uid \" group=\" * \"comm=\\\"\" comm \"\\\" exe=\\\"\" exe\n  \"\\\"\" * \"cwd=\\\"\" cwd \"\\\" name=\\\"\" name \"\\\" (inode|nametype)=\" * \"(proctitle|cmdline)=\" cmdline\n  | extend cmdline = trim_end('redactors=.*',cmdline)\n};\nlog4j_execve\n  | where comm has_any (\"wget\",\"curl\")\n  | where cmdline has_any (\"${jndi:ldap\",\"${jndi:dns\",\"${jndi:rmi\",\"${jndi:corba\",\"${jndi:iiop\",\"${jndi:nis\", \"${jndi:nds\")\n  | project TimeGenerated, Computer, audit_user, user, cmdline\n  | extend Account_0_Name = user\n  | extend Host_0_HostName = Computer\n  | sort by TimeGenerated desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query detects remote code execution vulnerability in the Log4j component of Apache. Attackers may attempt to launch arbitrary code by passing specific commands to a server, which are then logged and executed by the Log4j component."
                  },
                  {
                    "name": "tactics",
                    "value": "Persistence,Execution"
                  },
                  {
                    "name": "techniques",
                    "value": "T1059,T1053"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject4')._huntingQuerycontentId4),'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Hunting Query 4",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject4')._huntingQuerycontentId4)]",
                "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject4').huntingQueryVersion4]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
        "contentKind": "HuntingQuery",
        "displayName": "Possible exploitation of Apache log4j component detected",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject4')._huntingQuerycontentId4,'-', '1.0.3')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject4')._huntingQuerycontentId4,'-', '1.0.3')))]",
        "version": "1.0.3"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject5').huntingQueryTemplateSpecName5]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Process_Termination_Activity_HuntingQueries Hunting Query with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject5').huntingQueryVersion5]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Apache_Log4j_Vulnerability_Detection_Hunting_Query_5",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Linux security related process termination activity detected",
                "category": "Hunting Queries",
                "query": "Syslog\n| where Facility == 'user'\n| where SyslogMessage has \"AUOMS_EXECVE\"\n| parse SyslogMessage with \"type=\" EventType \" audit(\" * \"): \" EventData\n| where EventType =~ \"AUOMS_EXECVE\"\n| parse EventData with * \"syscall=\" syscall \" syscall_r=\" * \" success=\" success \" exit=\" exit \" a0\" * \" ppid=\" ppid \" pid=\" pid \" audit_user=\" audit_user \" auid=\" auid \" user=\" user \" uid=\" uid \" group=\" group \" gid=\" gid \"effective_user=\" effective_user \" euid=\" euid \" set_user=\" set_user \" suid=\" suid \" filesystem_user=\" filesystem_user \" fsuid=\" fsuid \" effective_group=\" effective_group \" egid=\" egid \" set_group=\" set_group \" sgid=\" sgid \" filesystem_group=\" filesystem_group \" fsgid=\" fsgid \" tty=\" tty \" ses=\" ses \" comm=\\\"\" comm \"\\\" exe=\\\"\" exe \"\\\"\" * \"cwd=\\\"\" cwd \"\\\"\" * \"name=\\\"\" name \"\\\"\" * \"cmdline=\" cmdline\n| extend cmdline = trim_end('redactors=.*',cmdline)\n| where cmdline has_any (\"service apparmor stop\",\"service aliyun.service stop\",\"systemctl disable apparmor\",\"systemctl disable aliyun.service\")\nor  (exe has \"pkill\" and cmdline has_any (\"omsagent\",\"auoms\",\"omiagent\",\"waagent\") and cmdline !has \"/omsagent/plugin/pi\"and cmdline !has \"/omsconfig/modules\")\n| project TimeGenerated, Computer, audit_user, user, cmdline\n| extend timestamp = TimeGenerated\n| extend Host_0_HostName = Computer\n| extend Account_0_Name = user\n| sort by TimeGenerated desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query alerts on attempts to terminate security monitoring processes on the host. Attackers often try to terminate such processes post-compromise to exploit the Log4j vulnerability."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1489"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject5')._huntingQuerycontentId5),'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Hunting Query 5",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject5')._huntingQuerycontentId5)]",
                "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject5').huntingQueryVersion5]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
        "contentKind": "HuntingQuery",
        "displayName": "Linux security related process termination activity detected",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject5')._huntingQuerycontentId5,'-', '1.0.3')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject5')._huntingQuerycontentId5,'-', '1.0.3')))]",
        "version": "1.0.3"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject6').huntingQueryTemplateSpecName6]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Suspicious_ShellScript_Activity_HuntingQueries Hunting Query with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject6').huntingQueryVersion6]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Apache_Log4j_Vulnerability_Detection_Hunting_Query_6",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Suspicious Shell script detected",
                "category": "Hunting Queries",
                "query": "Syslog\n| where Facility == 'user'\n| where SyslogMessage has \"AUOMS_EXECVE\"\n| parse SyslogMessage with \"type=\" EventType \" audit(\" * \"): \" EventData\n| where EventType =~ \"AUOMS_EXECVE\"\n| project TimeGenerated, EventType, Computer, EventData\n| parse EventData with * \"syscall=\" syscall \" syscall_r=\" * \" success=\" success \" exit=\" exit \" a0\" * \" ppid=\" ppid \" pid=\" pid \" audit_user=\" audit_user \" auid=\" auid \" user=\" user \" uid=\" uid \" group=\" group \" gid=\" gid \"effective_user=\" effective_user \" euid=\" euid \" set_user=\" set_user \" suid=\" suid \" filesystem_user=\" filesystem_user \" fsuid=\" fsuid \" effective_group=\" effective_group \" egid=\" egid \" set_group=\" set_group \" sgid=\" sgid \" filesystem_group=\" filesystem_group \" fsgid=\" fsgid \" tty=\" tty \" ses=\" ses \" comm=\\\"\" comm \"\\\" exe=\\\"\" exe \"\\\"\" * \"cwd=\\\"\" cwd \"\\\"\" * \"name=\\\"\" name \"\\\"\" * \"cmdline=\" cmdline\n| extend cmdline = trim_end('redactors=.*',cmdline) \n| where exe has_any (\"bash\",\"dash\")\n| where cmdline matches regex  \"[0-9]{1,3}\\\\.[0-9]{1,3}\\\\.[0-9]{1,3}\\\\.[0-9]{1,3}\"\n| where cmdline has \"curl\" and cmdline has \"wget\"\n| project TimeGenerated, Computer, audit_user, user, cmdline\n| extend timestamp = TimeGenerated\n| extend Host_0_HostName = Computer\n| extend Account_0_Name = user\n| sort by TimeGenerated desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query detects post-compromise suspicious shell scripts that attackers use for downloading and executing malicious files. This technique is often used by attackers and was recently used to exploit the Log4j vulnerability."
                  },
                  {
                    "name": "tactics",
                    "value": "Persistence,Execution"
                  },
                  {
                    "name": "techniques",
                    "value": "T1059,T1053"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject6')._huntingQuerycontentId6),'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Hunting Query 6",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject6')._huntingQuerycontentId6)]",
                "contentId": "[variables('huntingQueryObject6')._huntingQuerycontentId6]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject6').huntingQueryVersion6]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject6')._huntingQuerycontentId6]",
        "contentKind": "HuntingQuery",
        "displayName": "Suspicious Shell script detected",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject6')._huntingQuerycontentId6,'-', '1.0.3')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject6')._huntingQuerycontentId6,'-', '1.0.3')))]",
        "version": "1.0.3"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject7').huntingQueryTemplateSpecName7]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Base64_Download_Activity_HuntingQueries Hunting Query with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject7').huntingQueryVersion7]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Apache_Log4j_Vulnerability_Detection_Hunting_Query_7",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Suspicious Base64 download activity detected",
                "category": "Hunting Queries",
                "query": "Syslog\n| where Facility == 'user'\n| where SyslogMessage has \"AUOMS_EXECVE\"\n| parse SyslogMessage with \"type=\" EventType \" audit(\" * \"): \" EventData\n| project TimeGenerated, EventType, Computer, EventData\n| where EventType =~ \"AUOMS_EXECVE\"\n| parse EventData with * \"syscall=\" syscall \" syscall_r=\" * \" success=\" success \" exit=\" exit \" a0\" * \" ppid=\" ppid \" pid=\" pid \" audit_user=\" audit_user \" auid=\" auid \" user=\" user \" uid=\" uid \" group=\" group \" gid=\" gid \"effective_user=\" effective_user \" euid=\" euid \" set_user=\" set_user \" suid=\" suid \" filesystem_user=\" filesystem_user \" fsuid=\" fsuid \" effective_group=\" effective_group \" egid=\" egid \" set_group=\" set_group \" sgid=\" sgid \" filesystem_group=\" filesystem_group \" fsgid=\" fsgid \" tty=\" tty \" ses=\" ses \" comm=\\\"\" comm \"\\\" exe=\\\"\" exe \"\\\"\" * \"cwd=\\\"\" cwd \"\\\"\" * \"name=\\\"\" name \"\\\"\" * \"cmdline=\" cmdline\n| extend cmdline = trim_end('redactors=.*',cmdline) \n| where cmdline has \"/Basic/Command/Base64/\"\n| where exe has_any (\"curl\", \"wget\")\n| parse cmdline with * \"Base64/\" OriginalEncodedCommand:string\n| extend EncodedCommand = extract(\"((?:[A-Za-z0-9+/-]{4})*(?:[A-Za-z0-9+/-]{2}==|[A-Za-z0-9+/-]{3}=|[A-Za-z0-9+/-]{4}))\", 1, OriginalEncodedCommand) \n| extend DecodedCommand = base64_decode_tostring(EncodedCommand) \n| project TimeGenerated, Computer, audit_user, user, cmdline, DecodedCommand, EncodedCommand\n| extend timestamp = TimeGenerated\n| extend Host_0_HostName = Computer\n| extend Account_0_Name = user\n| sort by TimeGenerated desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query detects Base64 obfuscated scripts for malicious file execution. This technique is used by attackers to exploit a remote code execution vulnerability in the Apache Log4j to evade detection."
                  },
                  {
                    "name": "tactics",
                    "value": "Persistence,Execution"
                  },
                  {
                    "name": "techniques",
                    "value": "T1059,T1053"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject7')._huntingQuerycontentId7),'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Hunting Query 7",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject7')._huntingQuerycontentId7)]",
                "contentId": "[variables('huntingQueryObject7')._huntingQuerycontentId7]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject7').huntingQueryVersion7]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject7')._huntingQuerycontentId7]",
        "contentKind": "HuntingQuery",
        "displayName": "Suspicious Base64 download activity detected",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject7')._huntingQuerycontentId7,'-', '1.0.3')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject7')._huntingQuerycontentId7,'-', '1.0.3')))]",
        "version": "1.0.3"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject8').huntingQueryTemplateSpecName8]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Container_Miner_Activity_HuntingQueries Hunting Query with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject8').huntingQueryVersion8]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Apache_Log4j_Vulnerability_Detection_Hunting_Query_8",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Possible Container Miner related artifacts detected",
                "category": "Hunting Queries",
                "query": "Syslog\n| where Facility == 'user'\n| where SyslogMessage has \"AUOMS_EXECVE\"\n| parse SyslogMessage with \"type=\" EventType \" audit(\" * \"): \" EventData\n| where EventType =~ \"AUOMS_EXECVE\"\n| parse EventData with * \"syscall=\" syscall \" syscall_r=\" * \" success=\" success \" exit=\" exit \" a0\" * \" ppid=\" ppid \" pid=\" pid \" audit_user=\" audit_user \" auid=\" auid \" user=\" user \" uid=\" uid \" group=\" group \" gid=\" gid \"effective_user=\" effective_user \" euid=\" euid \" set_user=\" set_user \" suid=\" suid \" filesystem_user=\" filesystem_user \" fsuid=\" fsuid \" effective_group=\" effective_group \" egid=\" egid \" set_group=\" set_group \" sgid=\" sgid \" filesystem_group=\" filesystem_group \" fsgid=\" fsgid \" tty=\" tty \" ses=\" ses \" comm=\\\"\" comm \"\\\" exe=\\\"\" exe \"\\\"\" * \"cwd=\\\"\" cwd \"\\\"\" * \"name=\\\"\" name \"\\\"\" * \"cmdline=\" cmdline \n| extend cmdline = trim_end('redactors=.*',cmdline) \n| where (exe has \"docker\" and cmdline has_any  (\"monero-miner\",\"minergate-cli\",\"aeon-miner\",\"xmr-miner\")) or (exe has_any (\"bash\",\"dash\") and cmdline has \"docker kill\" and cmdline has_any (\"gakeaws\",\"monero\",\"xmr\",\"pocosow\"))\n| project TimeGenerated, Computer, audit_user, user, cmdline\n| extend timestamp = TimeGenerated\n| extend Host_0_HostName = Computer\n| extend Account_0_Name = user\n| sort by TimeGenerated desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query uses syslog data to alert on artifacts from container images used in digital cryptocurrency mining, often seen post Log4j vulnerability (CVE-2021-44228) exploitation."
                  },
                  {
                    "name": "tactics",
                    "value": "Impact,Execution"
                  },
                  {
                    "name": "techniques",
                    "value": "T1496,T1203"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject8')._huntingQuerycontentId8),'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Hunting Query 8",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject8')._huntingQuerycontentId8)]",
                "contentId": "[variables('huntingQueryObject8')._huntingQuerycontentId8]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject8').huntingQueryVersion8]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject8')._huntingQuerycontentId8]",
        "contentKind": "HuntingQuery",
        "displayName": "Possible Container Miner related artifacts detected",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject8')._huntingQuerycontentId8,'-', '1.0.2')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject8')._huntingQuerycontentId8,'-', '1.0.2')))]",
        "version": "1.0.2"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject9').huntingQueryTemplateSpecName9]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Linux_Toolkit_Detected_HuntingQueries Hunting Query with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject9').huntingQueryVersion9]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Apache_Log4j_Vulnerability_Detection_Hunting_Query_9",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Possible Linux attack toolkit detected via Syslog data",
                "category": "Hunting Queries",
                "query": "Syslog\n| where Facility == 'user'\n| where SyslogMessage has \"AUOMS_EXECVE\"\n| parse SyslogMessage with \"type=\" EventType \" audit(\" * \"): \" EventData\n| where EventType =~ \"AUOMS_EXECVE\"\n| parse EventData with * \"syscall=\" syscall \" syscall_r=\" * \" success=\" success \" exit=\" exit \" a0\" * \" ppid=\" ppid \" pid=\" pid \" audit_user=\" audit_user \" auid=\" auid \" user=\" user \" uid=\" uid \" group=\" group \" gid=\" gid \"effective_user=\" effective_user \" euid=\" euid \" set_user=\" set_user \" suid=\" suid \" filesystem_user=\" filesystem_user \" fsuid=\" fsuid \" effective_group=\" effective_group \" egid=\" egid \" set_group=\" set_group \" sgid=\" sgid \" filesystem_group=\" filesystem_group \" fsgid=\" fsgid \" tty=\" tty \" ses=\" ses \" comm=\\\"\" comm \"\\\" exe=\\\"\" exe \"\\\"\" * \"cwd=\\\"\" cwd \"\\\"\" * \"name=\\\"\" name \"\\\"\" * \"cmdline=\" cmdline  \n| extend cmdline = trim_end('redactors=.*',cmdline) \n| where (exe has \"java\" and cmdline has \"JNDI-Injection-Exploit\") or (exe has \"javac\" and cmdline has \"log4j-payload-generator\") or (cmdline has \"LogMePwn\" and cmdline has \"git clone\")\n| project TimeGenerated, Computer, audit_user, user, cmdline\n| extend timestamp = TimeGenerated\n| extend Host_0_HostName = Computer\n| extend Account_0_Name = user\n| sort by TimeGenerated desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for usage of attack toolkits associated with massive scanning or exploitation of remote code execution vulnerability in Log4j component of Apache."
                  },
                  {
                    "name": "tactics",
                    "value": "Reconnaissance,Execution"
                  },
                  {
                    "name": "techniques",
                    "value": "T1595,T1203"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject9')._huntingQuerycontentId9),'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Hunting Query 9",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject9')._huntingQuerycontentId9)]",
                "contentId": "[variables('huntingQueryObject9')._huntingQuerycontentId9]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject9').huntingQueryVersion9]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject9')._huntingQuerycontentId9]",
        "contentKind": "HuntingQuery",
        "displayName": "Possible Linux attack toolkit detected via Syslog data",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject9')._huntingQuerycontentId9,'-', '1.0.2')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject9')._huntingQuerycontentId9,'-', '1.0.2')))]",
        "version": "1.0.2"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject10').huntingQueryTemplateSpecName10]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "NetworkConnectionToNewExternalLDAPServer_HuntingQueries Hunting Query with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject10').huntingQueryVersion10]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Apache_Log4j_Vulnerability_Detection_Hunting_Query_10",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Network Connection to New External LDAP Server",
                "category": "Hunting Queries",
                "query": "let starttime = todatetime('{{StartTimeISO}}');\nlet endtime = todatetime('{{EndTimeISO}}');\nlet lookback = starttime - 14d;\nlet legacy_ldap = (\nCommonSecurityLog\n| where TimeGenerated between(lookback..starttime)\n// Filter to LDAP connections only\n| where ApplicationProtocol =~ \"ldap\"\n// Check LDAP server is external\n| extend private =  ipv4_is_private(DestinationIP)\n| where private == false\n// Filter out events where network connection was blocked - change this to expand hunt\n| where DeviceAction has_any (\"allow\", \"accept\", \"allowed\")\n| summarize by DestinationIP);\nCommonSecurityLog\n| where TimeGenerated between(starttime..endtime)\n| where ApplicationProtocol =~ \"ldap\"\n| extend private =  ipv4_is_private(DestinationIP)\n| where private == false\n| where DestinationIP !in (legacy_ldap)\n| where DeviceAction has_any (\"allow\", \"accept\", \"allowed\")\n| project-reorder TimeGenerated, SourceIP, DestinationIP, ApplicationProtocol, DestinationPort, SentBytes, ReceivedBytes, DeviceAction\n| extend timestamp = TimeGenerated\n| extend IP_0_Address = SourceIP\n| extend IP_1_Address = DestinationIP\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query detects outbound network connections using the LDAP protocol to external IP addresses that have not had an LDAP network connection in the past 14 days. This could indicate exploitation of CVE-2021-44228 vulnerability."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1190"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject10')._huntingQuerycontentId10),'/'))))]",
              "properties": {
                "description": "Apache Log4j Vulnerability Detection Hunting Query 10",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject10')._huntingQuerycontentId10)]",
                "contentId": "[variables('huntingQueryObject10')._huntingQuerycontentId10]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject10').huntingQueryVersion10]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject10')._huntingQuerycontentId10]",
        "contentKind": "HuntingQuery",
        "displayName": "Network Connection to New External LDAP Server",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject10')._huntingQuerycontentId10,'-', '1.0.2')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject10')._huntingQuerycontentId10,'-', '1.0.2')))]",
        "version": "1.0.2"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BatchImportToSentinel Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "BatchImportToSentinel",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "GraphSecurityConnectionName": "[[concat('microsoftgraphsecurity-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/microsoftgraphsecurity')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('GraphSecurityConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('GraphSecurityConnectionName'))]"
              ],
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Batch_messages": {
                      "type": "Batch",
                      "inputs": {
                        "configurations": {
                          "tiIndicators": {
                            "releaseCriteria": {
                              "messageCount": 10,
                              "recurrence": {
                                "frequency": "Hour",
                                "interval": 1
                              }
                            }
                          }
                        },
                        "mode": "Inline"
                      }
                    }
                  },
                  "actions": {
                    "Select": {
                      "type": "Select",
                      "inputs": {
                        "from": "@triggerBody()['items']",
                        "select": "@item()['content']"
                      }
                    },
                    "Submit_multiple_tiIndicators": {
                      "runAfter": {
                        "Select": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "value": "@body('Select')"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['microsoftgraphsecurity']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/beta/security/tiIndicators/submitTiIndicators",
                        "retryPolicy": {
                          "count": 90,
                          "interval": "PT60S",
                          "type": "fixed"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "microsoftgraphsecurity": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('GraphSecurityConnectionName'))]",
                        "connectionName": "[[variables('GraphSecurityConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/microsoftgraphsecurity')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "BatchImportToSentinel",
            "description": "These playbooks automate the ingest of threat indicators into the ThreatIntelligenceIndicator table of an Microsoft Sentinel workspace. Sample data for Log4j IOC can be found at https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Log4j_IOC_List.csv.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-08-03T00:00:00Z",
            "mainSteps": [
              "1. You must deploy the BatchImportToSentinel playbook before deploying the Log4jIndicatorProcessor playbook.",
              "2. During the deployment of Log4jIndicatorProcessor playbook, Playbook2 parameter name should be that of BatchImportToSentinel(default)."
            ],
            "postDeployment": [
              "Deploying these playbooks requires the following steps:",
              "1. BatchImportToSentinel is deployed first, you need to provide following parameters",
              "![image](https://user-images.githubusercontent.com/95622706/151350644-bc46c35d-5e60-412a-a638-48aca963b69f.png)",
              "2. BatchImportToSentinel will need connection for the Submit multiple tiIndicators action as shown below -",
              "![image](https://user-images.githubusercontent.com/95622706/151345549-ff19fd73-7589-4dd4-afb9-00ee8dbea723.png)",
              "Configuring this connection, you will be asked to login to Microsoft Entra ID and consent for the permissions needed for the Playbook to submit threat indicators to the Graph Security API. You need to authenticate with as a user with an Microsoft Entra ID Limited Administrator Role of Global Administrator.",
              "3. Log4jIndicatorProcessor is deployed after BatchImportToSentinel. You need to provide following parameters  ",
              "![image](https://user-images.githubusercontent.com/95622706/151345675-bca4f7f3-5c79-4a3f-ab55-5c635c51e16a.png)",
              "4. Log4jIndicatorProcessor Playbook performs the following steps:",
              " Triggered on a defined schedule",
              " Reads the indicators from GitHub",
              " Transforms the indicators from the text-based source to the appropriate tiIndicator JSON format",
              " Uses the Batch action to send the indicators to the second Playbook (BatchImportToSentinel)",
              "5. Following configuration is needed in Log4jIndicatorProcessor Playbook after deployment",
              "Query  This KQL query will get the external data from https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Log4j_IOC_List.csv. This can be configured to any other data source.",
              "Connection - Configuring this connection, you will be asked to login to Microsoft Entra ID and consent for the permissions needed for the Playbook to submit threat indicators to the Graph Security API. You need to authenticate with as a user with an Microsoft Entra ID Limited Administrator Role of Global Administrator.",
              "6. Managed Identity  If you want to use managed identity to configure logic apps, Create managed identity from connections tab, use following powershell commands to provide required permissions for managed identity on Microsoft graph API  Connect-AzureAD -TenantId <tenantid>",
              "$graph = Get-AzureADServicePrincipal -Filter ''AppId eq '00000003-0000-0000-c000-000000000000''' ",
              "$permissionlist = @('Group.Read.All','SecurityActions.Read.All','SecurityActions.ReadWrite.All','SecurityEvents.Read.All','SecurityEvents.ReadWrite.All','ThreatIndicators.ReadWrite.OwnedBy' ) foreach( $permission in $permissionlist) { $groupReadPermission = $graph.AppRoles ` | where Value -Like ($permission) ` | Select-Object $msi = Get-AzureADServicePrincipal -ObjectId <objid of managed identity> New-AzureADServiceAppRoleAssignment ` -Id $groupReadPermission.Id ` -ObjectId $msi.ObjectId ` -PrincipalId $msi.ObjectId ` -ResourceId $graph.ObjectId }"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "BatchImportToSentinel",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId1')]",
        "contentKind": "Playbook",
        "displayName": "BatchImportToSentinel",
        "contentProductId": "[variables('_playbookcontentProductId1')]",
        "id": "[variables('_playbookcontentProductId1')]",
        "version": "[variables('playbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Log4jIndicatorProcessor Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "MicrosoftSentinelLogAnalyticsWorkspaceName": {
              "defaultValue": "Microsoft Sentinel Workspace Name",
              "type": "string"
            },
            "PlaybookName": {
              "defaultValue": "Log4jIndicatorProcessor",
              "type": "string"
            },
            "Playbook2Name": {
              "defaultValue": "BatchImportToSentinel",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "AzureMonitorLogsConnectionName": "[[concat('azuremonitorlogs-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureMonitorLogsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogsConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Day",
                        "interval": 1
                      },
                      "evaluatedRecurrence": {
                        "frequency": "Day",
                        "interval": 1
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "For_each": {
                      "foreach": "@body('Select_Log4j_indicators_and_transform_to_tiIndicators')",
                      "actions": {
                        "BatchImportToSentinel": {
                          "type": "SendToBatch",
                          "inputs": {
                            "batchName": "tiIndicators",
                            "content": "@items('For_each')",
                            "host": {
                              "triggerName": "Batch_messages",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Playbook2Name'))]"
                              }
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Select_Log4j_indicators_and_transform_to_tiIndicators": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Parse_JSON": {
                      "runAfter": {
                        "Run_query_and_list_results_V2_2": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Run_query_and_list_results_V2_2')",
                        "schema": {
                          "properties": {
                            "value": {
                              "items": {
                                "properties": {
                                  "IPAddress": {
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "IPAddress"
                                ],
                                "type": "object"
                              },
                              "type": "array"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "Run_query_and_list_results_V2_2": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "query": "externaldata(IPAddress: string)[h@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Log4j_IOC_List.csv\"]\nwith (ignoreFirstRecord = true)",
                          "timerange": {
                            "relativeTimeRange": "Last 24 hours"
                          },
                          "timerangetype": "2"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/queryDataV2",
                        "queries": {
                          "resourcegroups": "[[resourceGroup().name]",
                          "resourcename": "[[parameters('MicrosoftSentinelLogAnalyticsWorkspaceName')]",
                          "resourcetype": "Log Analytics Workspace",
                          "subscriptions": "[[subscription().subscriptionId]"
                        }
                      }
                    },
                    "Select_Log4j_indicators_and_transform_to_tiIndicators": {
                      "runAfter": {
                        "Parse_JSON": [
                          "Succeeded"
                        ]
                      },
                      "type": "Select",
                      "inputs": {
                        "from": "@body('Parse_JSON')?['value']",
                        "select": {
                          "action": "alert",
                          "confidence": "100",
                          "description": "Microsoft Log4j threat indicator",
                          "expirationDateTime": "2030-05-01T00:00:00Z",
                          "networkIPv4": "@item()?['IPAddress']",
                          "targetProduct": "Azure Sentinel",
                          "threatType": "WatchList",
                          "tlpLevel": "white"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuremonitorlogs": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogsConnectionName'))]",
                        "connectionName": "[[variables('AzureMonitorLogsConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuremonitorlogs')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Apache Log4j Vulnerability Detection",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "name": "Microsoft Corporation",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Log4jIndicatorProcessor",
            "description": "These playbooks automate the ingest of threat indicators into the ThreatIntelligenceIndicator table of an Microsoft Sentinel workspace. Sample data for Log4j IOC can be found at https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Log4j_IOC_List.csv.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-08-03T00:00:00Z",
            "mainSteps": [
              "1. You must deploy the BatchImportToSentinel playbook before deploying the Log4jIndicatorProcessor playbook.",
              "2. During the deployment of Log4jIndicatorProcessor playbook, Playbook2 parameter name should be that of BatchImportToSentinel(default)."
            ],
            "postDeployment": [
              "Deploying these playbooks requires the following steps:",
              "1. BatchImportToSentinel is deployed first, you need to provide following parameters",
              "![image](https://user-images.githubusercontent.com/95622706/151350644-bc46c35d-5e60-412a-a638-48aca963b69f.png)",
              "2. BatchImportToSentinel will need connection for the Submit multiple tiIndicators action as shown below -",
              "![image](https://user-images.githubusercontent.com/95622706/151345549-ff19fd73-7589-4dd4-afb9-00ee8dbea723.png)",
              "Configuring this connection, you will be asked to login to Microsoft Entra ID and consent for the permissions needed for the Playbook to submit threat indicators to the Graph Security API. You need to authenticate with as a user with an Microsoft Entra ID Limited Administrator Role of Global Administrator.",
              "3. Log4jIndicatorProcessor is deployed after BatchImportToSentinel. You need to provide following parameters ",
              "![image](https://user-images.githubusercontent.com/95622706/151345675-bca4f7f3-5c79-4a3f-ab55-5c635c51e16a.png) ",
              "4. Log4jIndicatorProcessor Playbook performs the following steps: ",
              " Triggered on a defined schedule",
              " Reads the indicators from GitHub",
              " Transforms the indicators from the text-based source to the appropriate tiIndicator JSON format",
              " Uses the Batch action to send the indicators to the second Playbook (BatchImportToSentinel)",
              "5. Following configuration is needed in Log4jIndicatorProcessor Playbook after deployment",
              "Query  This KQL query will get the external data from https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Log4j_IOC_List.csv. This can be configured to any other data source.",
              "Connection - Configuring this connection, you will be asked to login to Microsoft Entra ID and consent for the permissions needed for the Playbook to submit threat indicators to the Graph Security API. You need to authenticate with as a user with an Microsoft Entra ID Limited Administrator Role of Global Administrator.",
              "6. Managed Identity  If you want to use managed identity to configure logic apps, Create managed identity from connections tab, use following powershell commands to provide required permissions for managed identity on Microsoft graph API - Connect-AzureAD -TenantId <tenantid>",
              "$graph = Get-AzureADServicePrincipal -Filter ''AppId eq '00000003-0000-0000-c000-000000000000''' ",
              "$permissionlist = @('Group.Read.All','SecurityActions.Read.All','SecurityActions.ReadWrite.All','SecurityEvents.Read.All','SecurityEvents.ReadWrite.All','ThreatIndicators.ReadWrite.OwnedBy' ) foreach( $permission in $permissionlist) { $groupReadPermission = $graph.AppRoles ` | where Value -Like ($permission) ` | Select-Object $msi = Get-AzureADServicePrincipal -ObjectId <objid of managed identity> New-AzureADServiceAppRoleAssignment ` -Id $groupReadPermission.Id ` -ObjectId $msi.ObjectId ` -PrincipalId $msi.ObjectId ` -ResourceId $graph.ObjectId }"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Log4jIndicatorProcessor",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId2')]",
        "contentKind": "Playbook",
        "displayName": "Log4jIndicatorProcessor",
        "contentProductId": "[variables('_playbookcontentProductId2')]",
        "id": "[variables('_playbookcontentProductId2')]",
        "version": "[variables('playbookVersion2')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('watchlist1-id'))]",
      "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
      "kind": "",
      "properties": {
        "displayName": "Campaign",
        "source": "Log4j.csv",
        "description": "Watchlist provide lookup for IOC of different sources.",
        "provider": "Custom",
        "isDeleted": false,
        "defaultDuration": "P1000Y",
        "contentType": "Text/Csv",
        "numberOfLinesToSkip": 0,
        "itemsSearchKey": "Detection",
        "rawContent": "Detection,Source,OS,Type\r\nTrojan:Win32/Capfetox.AA,MDAV,Windows,\r\nHackTool:Win32/Capfetox.A!dha,MDAV,Windows,\r\nVirTool:Win64/CobaltSrike.A,MDAV,Windows,\r\nTrojanDropper:PowerShell/Cobacis.A,MDAV,Windows,\r\nTrojanDownloader:Win32/CoinMiner,MDAV,Windows,\r\nTrojan:Win32/WebToos.A,MDAV,Windows,\r\nTrojan:Linux/SuspectJavaExploit.A,MDAV,Linux,\r\nTrojan:Linux/SuspectJavaExploit.B,MDAV,Linux,\r\nTrojan:Linux/SuspectJavaExploit.C,MDAV,Linux,\r\nTrojan:Linux/BashMiner.A,MDAV,Linux,\r\nTrojanDownloader:Linux/CoinMiner,MDAV,Linux,\r\nTrojanDownloader:Linux/Tusnami,MDAV,Linux,\r\nBackdoor:Linux/Tusnami.C,MDAV,Linux,\r\nBackdoor:Linux/Setag.C,MDAV,Linux,\r\nExploit:Linux/CVE-2021-44228.A,MDAV,Linux,\r\nExploit:Linux/CVE-2021-44228.B,MDAV,Linux,\r\nNetwork connection seen in CVE-2021-44228 exploitation,ASC,Both,\r\nPossible exploitation of CVE-2021-44228,ASC,Both,\r\nPossible Log4j exploitation,ASC,Both,\r\nSuspicious script launched,ASC,Both,\r\nSuspicious remote PowerShell execution,ASC,,Generic behavioral alerts\r\nDownload of file associated with digital currency mining,ASC,,Generic behavioral alerts\r\nProcess associated with digital currency mining,ASC,,Generic behavioral alerts\r\nCobalt Strike command and control detected,ASC,,Generic behavioral alerts\r\nSuspicious network traffic connection to C2 Server,ASC,,Generic behavioral alerts\r\nOngoing hands-on-keyboard attacker activity detected (Cobalt Strike),ASC,,Generic behavioral alerts\r\nExploitation attempt against Log4j (CVE-2021-4428),ASC,,\r\nDetected obfuscated command line,MDC,Windows,\r\nSuspicious use of PowerShell detected,MDC,Windows,\r\nSuspicious file download,MDC,Linux,\r\nPossible Cryptocoinminer download detected,MDC,Linux,\r\nProcess associated with digital currency mining detected,MDC,Linux,\r\nPotential crypto coin miner started,MDC,Linux,\r\nA history file has been cleared,MDC,Linux,\r\nSuspicious Shell Script Detected,MDC,Linux,\r\nSuspicious domain name reference,MDC,Linux,\r\nDigital currency mining related behavior detected,MDC,Linux,\r\nBehavior similar to common Linux bots detected,MDC,Linux,\r\nPossible exploitation of Apache Log4j component detected,Sentinel,,\r\nCryptocurrency miners EXECVE,Sentinel,,\r\nAzure WAF Log4j CVE-2021-44228 hunting,Sentinel,,\r\nLog4j vulnerability exploit aka Log4Shell IP IOC,Sentinel,,\r\nSuspicious shell script detected,Sentinel,,\r\nAzure WAF matching for Log4j vuln (CVE-2021-44228),Sentinel,,\r\nSuspicious Base64 download activity detected,Sentinel,,\r\nLinux security related process termination activity detected,Sentinel,,\r\nVulnerable Machines related to log4j CVE-2021-44228,Sentinel,,\r\nCVE-2021-44228,MDE,,Vulnerability\r\nlog4j,MDE,,Vulnerability\r\nCVE-2021-45046,ASC,,Vulnerability\r\nCVE-2021-44228,ASC,,Vulnerability\r\nCVE-2021-45105,ASC,,Vulnerability\r\nCVE-2021-45046,ASC,,Vulnerability\r\n"
      },
      "apiVersion": "2022-08-01"
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.1",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Apache Log4j Vulnerability Detection",
        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
        "descriptionHtml": "<p><strong>Note:</strong> <em>There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</em></p>\n<p>Microsoft's security research teams have been tracking threats taking advantage of <a href=\"https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-44228\">CVE-2021-44228</a>, a remote code execution (RCE) vulnerability in <a href=\"https://logging.apache.org/log4j/2.x/\">Apache Log4j 2</a> referred to as Log4Shell. The vulnerability allows unauthenticated remote code execution, and it is triggered when a specially crafted string provided by the attacker through a variety of different input vectors is parsed and processed by the Log4j 2 vulnerable component. For more technical and mitigation information about the vulnerability, please read the <a href=\"https://msrc-blog.microsoft.com/2021/12/11/microsofts-response-to-cve-2021-44228-apache-log4j2/\">Microsoft Security Response Center blog</a>. This solution provides content to monitor, detect and investigate signals related to exploitation of this vulnerability in Microsoft Sentinel.</p>\n<p><strong>Prerequisite :-</strong></p>\n<p>Install one or more of the listed solutions, or develop your custom ASIM parsers to unlock the value provided by this solution.</p>\n<ol>\n<li>Azure Web Application Firewall (WAF)</li>\n<li>Microsoft 365</li>\n<li>Windows Server DNS</li>\n<li>CiscoASA</li>\n<li>PaloAlto-PAN-OS</li>\n<li>Microsoft Entra ID</li>\n<li>Azure Activity</li>\n<li>Amazon Web Services</li>\n<li>Azure Firewall</li>\n<li>SquidProxy</li>\n<li>Zscaler Private Access (ZPA)</li>\n<li>Syslog</li>\n<li>Check Point</li>\n<li>Microsoft Defender XDR</li>\n</ol>\n<p><strong>Workbooks:</strong> 2, <strong>Analytic Rules:</strong> 4, <strong>Hunting Queries:</strong> 10, <strong>Watchlists:</strong> 1, <strong>Playbooks:</strong> 2</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Apache%20Log4j%20Vulnerability%20Detection/Workbooks/Images/Logos/Log4j.svg\" width=\"150px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Apache Log4j Vulnerability Detection",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId2')]",
              "version": "[variables('workbookVersion2')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
              "version": "[variables('huntingQueryObject1').huntingQueryVersion1]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
              "version": "[variables('huntingQueryObject2').huntingQueryVersion2]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
              "version": "[variables('huntingQueryObject3').huntingQueryVersion3]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
              "version": "[variables('huntingQueryObject4').huntingQueryVersion4]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
              "version": "[variables('huntingQueryObject5').huntingQueryVersion5]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject6')._huntingQuerycontentId6]",
              "version": "[variables('huntingQueryObject6').huntingQueryVersion6]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject7')._huntingQuerycontentId7]",
              "version": "[variables('huntingQueryObject7').huntingQueryVersion7]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject8')._huntingQuerycontentId8]",
              "version": "[variables('huntingQueryObject8').huntingQueryVersion8]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject9')._huntingQuerycontentId9]",
              "version": "[variables('huntingQueryObject9').huntingQueryVersion9]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject10')._huntingQuerycontentId10]",
              "version": "[variables('huntingQueryObject10').huntingQueryVersion10]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_BatchImport')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_IndicateProcessor')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Watchlist",
              "contentId": "[variables('_Campaign')]",
              "version": "3.0.1"
            },
			{
              "kind": "Solution",
              "contentId": "azuresentinel.azure-sentinel-solution-azurewebapplicationfirewal"
            },
			{
              "kind": "Solution",
              "contentId": "azuresentinel.azure-sentinel-solution-office365"
            },
			{
              "kind": "Solution",
              "contentId": "azuresentinel.azure-sentinel-solution-dns"
            },
			{
              "kind": "Solution",
              "contentId": "azuresentinel.azure-sentinel-solution-ciscoasa"
            },
			{
              "kind": "Solution",
              "contentId": "azuresentinel.azure-sentinel-solution-paloaltopanos"
            },
			{
              "kind": "Solution",
              "contentId": "azuresentinel.azure-sentinel-solution-azureactivedirectory"
            },
			{
              "kind": "Solution",
              "contentId": "azuresentinel.azure-sentinel-solution-azureactivity"
            },
			{
              "kind": "Solution",
              "contentId": "azuresentinel.azure-sentinel-solution-amazonwebservices"
            },
			{
              "kind": "Solution",
              "contentId": "sentinel4azurefirewall.sentinel4azurefirewall"
            },
			{
              "kind": "Solution",
              "contentId": "azuresentinel.azure-sentinel-solution-squidproxy"
            },
			{
              "kind": "Solution",
              "contentId": "azuresentinel.azure-sentinel-solution-zscalerprivateaccess"
            },
			{
              "kind": "Solution",
              "contentId": "azuresentinel.azure-sentinel-solution-syslog"
            },
			{
              "kind": "Solution",
              "contentId": "checkpoint.checkpoint-sentinel-solutions"
            },
			{
              "kind": "Solution",
              "contentId": "azuresentinel.azure-sentinel-solution-microsoft365defender"
            }
          ]
        },
        "firstPublishDate": "2021-12-15",
        "providers": [
          "Microsoft"
        ],
        "categories": {
          "domains": [
            "Application",
            "Security - Threat Protection",
            "Security - Vulnerability Management",
            "Security - Automation (SOAR)"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
