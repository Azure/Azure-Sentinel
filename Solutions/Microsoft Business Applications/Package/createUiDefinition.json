{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "config": {
            "isWizard": false,
            "basics": {
                "description": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/PowerPlatform.svg\" width=\"75px\" height=\"75px\">\n\n**Note:** Please refer to the following before installing the solution: \n\n• Review the solution [Release Notes](https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Microsoft%20Business%20Applications/ReleaseNotes.md)\n\n • There may be [known issues](https://aka.ms/sentinelsolutionsknownissues) pertaining to this Solution, please refer to them before installing.\n\nMicrosoft Power Platform provides a wide range of tools for citizen developers to build, run and manage low-code and no-code applications quickly, simply and at scale. With that, it also introduces a concern around the risk of security vulnerabilities introduced by citizen developers, some of whom may lack the security awareness of traditional pro-dev community. To counter this, early threat detection is crucial and can complement preventative guardrails to enable frictionless productivity while minimizing cyber risk.\n\nThe Microsoft Sentinel solution for Microsoft Power Platform allows customers to monitor and detect various suspicious or malicious activities in their Power Platform environments.\n\nIt collects activity logs from the different Power Platform components (Power Apps, Power Automate, Power Platform Connectors, Power Platform DLP, Dataverse) as well as the Power Platform inventory data and analyzes those activity logs to detect threats and suspicious activities such as: Power Apps execution from unauthorized geographies, suspicious data destruction by Power Apps, mass deletion of Power Apps, phishing attacks made possible through Power Apps, Power Automate flows activity by departing employees, Microsoft Power Platform connectors added to the an environment, and the update or removal of Microsoft Power Platform data loss prevention policies.\n\nDue to the integration of the Power Platform inventory data, in addition to the activity logs, the solution also allows customers to investigate the detected threats in a full human readable context and understand for example what the name of the suspicious app is, the name of Power Platform environment it belongs to, the details of the user who created or modified the suspicious app, the details of the users using the app, and more.\n\n**Important**\n\n- The Microsoft Sentinel Solution for Power Platform is currently in PREVIEW. The [Azure Preview Supplemental Terms](https://azure.microsoft.com/support/legal/preview-supplemental-terms) include additional legal terms that apply to Azure features that are in beta, preview, or otherwise not yet released into general availability.\n\n- This solution is a premium offering. Pricing information will be available before the solution becomes generally available.\n\nPlease review the solution [documentation](https://learn.microsoft.com/azure/sentinel/business-applications/power-platform-solution-overview) to learn more about deploying, configuring and using this solution.\n\n**Data Connectors:** 4, **Parsers:** 5, **Workbooks:** 1, **Analytic Rules:** 49, **Hunting Queries:** 8, **Watchlists:** 1, **Playbooks:** 8\n\n[Learn more about Microsoft Sentinel](https://aka.ms/azuresentinel) | [Learn more about Solutions](https://aka.ms/azuresentinelsolutionsdoc)",
                "subscription": {
                    "resourceProviders": [
                        "Microsoft.OperationsManagement/solutions",
                        "Microsoft.OperationalInsights/workspaces/providers/alertRules",
                        "Microsoft.Insights/workbooks",
                        "Microsoft.Logic/workflows"
                    ]
                },
                "location": {
                    "metadata": {
                        "hidden": "Hiding location, we get it from the log analytics workspace"
                    },
                    "visible": false
                },
                "resourceGroup": {
                    "allowExisting": true
                }
            }
        },
        "basics": [
            {
                "name": "getLAWorkspace",
                "type": "Microsoft.Solutions.ArmApiControl",
                "toolTip": "This filters by workspaces that exist in the Resource Group selected",
                "condition": "[greater(length(resourceGroup().name),0)]",
                "request": {
                    "method": "GET",
                    "path": "[concat(subscription().id,'/providers/Microsoft.OperationalInsights/workspaces?api-version=2020-08-01')]"
                }
            },
            {
                "name": "workspace",
                "type": "Microsoft.Common.DropDown",
                "label": "Workspace",
                "placeholder": "Select a workspace",
                "toolTip": "This dropdown will list only workspace that exists in the Resource Group selected",
                "constraints": {
                    "allowedValues": "[map(filter(basics('getLAWorkspace').value, (filter) => contains(toLower(filter.id), toLower(resourceGroup().name))), (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
                    "required": true
                },
                "visible": true
            }
        ],
        "steps": [
            {
                "name": "dataconnectors",
                "label": "Data Connectors",
                "bladeTitle": "Data Connectors",
                "elements": [
                    {
                        "name": "dataconnectors1-text",
                        "type": "Microsoft.Common.TextBlock",
                        "options": {
                            "text": "This Solution installs the data connector for Microsoft Business Applications. You can get Microsoft Business Applications data in your Microsoft Sentinel workspace. After installing the solution, configure and enable this data connector by following guidance in Manage solution view."
                        }
                    },
                    {
                        "name": "dataconnectors-link2",
                        "type": "Microsoft.Common.TextBlock",
                        "options": {
                            "link": {
                                "label": "Learn more about connecting data sources",
                                "uri": "https://docs.microsoft.com/azure/sentinel/connect-data-sources"
                            }
                        }
                    }
                ]
            },
            {
                "name": "workbooks",
                "label": "Workbooks",
                "subLabel": {
                    "preValidation": "Configure the workbooks",
                    "postValidation": "Done"
                },
                "bladeTitle": "Workbooks",
                "elements": [
                    {
                        "name": "workbooks-text",
                        "type": "Microsoft.Common.TextBlock",
                        "options": {
                            "text": "This solution installs workbook(s) to help you gain insights into the telemetry collected in Microsoft Sentinel. After installing the solution, start using the workbook in Manage solution view."
                        }
                    },
                    {
                        "name": "workbooks-link",
                        "type": "Microsoft.Common.TextBlock",
                        "options": {
                            "link": {
                                "label": "Learn more",
                                "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-monitor-your-data"
                            }
                        }
                    },
                    {
                        "name": "workbook1",
                        "type": "Microsoft.Common.Section",
                        "label": "Dynamics 365 Activity",
                        "elements": [
                            {
                                "name": "workbook1-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "This workbook brings together queries and visualizations to assist you in identifying potential threats in your Dynamics 365 audit data."
                                }
                            }
                        ]
                    }
                ]
            },
            {
                "name": "analytics",
                "label": "Analytics",
                "subLabel": {
                    "preValidation": "Configure the analytics",
                    "postValidation": "Done"
                },
                "bladeTitle": "Analytics",
                "elements": [
                    {
                        "name": "analytics-text",
                        "type": "Microsoft.Common.TextBlock",
                        "options": {
                            "text": "This solution installs the following analytic rule templates. After installing the solution, create and enable analytic rules in Manage solution view."
                        }
                    },
                    {
                        "name": "analytics-link",
                        "type": "Microsoft.Common.TextBlock",
                        "options": {
                            "link": {
                                "label": "Learn more",
                                "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-detect-threats-custom?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef"
                            }
                        }
                    },
                    {
                        "name": "analytic1",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Anomalous application user activity",
                        "elements": [
                            {
                                "name": "analytic1-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies anomalies in activity patterns of Dataverse application (non-interactive) users, based on activity falling outside the normal pattern of use."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic2",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Audit log data deletion",
                        "elements": [
                            {
                                "name": "analytic2-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies audit log data deletion activity in Dataverse."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic3",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Audit logging disabled",
                        "elements": [
                            {
                                "name": "analytic3-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies a change in system audit configuration whereby audit logging is turned off."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic4",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Bulk record ownership re-assignment or sharing",
                        "elements": [
                            {
                                "name": "analytic4-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies individual record ownership changes including sharing of records with other users/teams or re-assignment of ownership exceeding a pre-defined threshold."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic5",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Executable uploaded to SharePoint document management site",
                        "elements": [
                            {
                                "name": "analytic5-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies executable files and scripts uploaded to SharePoint sites used for Dynamics document management, circumventing native file extension restrictions in Dataverse."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic6",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Export activity from terminated or notified employee",
                        "elements": [
                            {
                                "name": "analytic6-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "This query identifies Dataverse export activity triggered by terminated, or employees about to leave the organization. This analytics rule uses the TerminatedEmployees watchlist template."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic7",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Guest user exfiltration following Power Platform defense impairment",
                        "elements": [
                            {
                                "name": "analytic7-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies a chain of events starting with disablement of Power Platform tenant isolation and removal of an environment's access security group. These events are correlated with Dataverse exfiltration alerts associated with the impacted environment and recently created Microsoft Entra guest users.\n\nNote: Activate other Dataverse analytics rules with the MITRE tactic 'Exfiltration' before enabling this rule."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic8",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Hierarchy security manipulation",
                        "elements": [
                            {
                                "name": "analytic8-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies suspicious behaviors in hierarchy security including:\n- Hierarchy security disabled.\n- User assigns themselves as a manager.\n- User assigns themselves to a monitored position."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic9",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Honeypot instance activity",
                        "elements": [
                            {
                                "name": "analytic9-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies activities in a predefined Honeypot Dataverse instance. Alerts when either sign-in to the Honeypot is detected or when monitored Dataverse tables in the Honeypot are accessed.\n\nNote: Requires a dedicated Honeypot Dataverse instance in Power Platform with auditing enabled."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic10",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Login by a sensitive privileged user",
                        "elements": [
                            {
                                "name": "analytic10-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies Dataverse and Dynamics 365 logons by sensitive users."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic11",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Login from IP in the block list",
                        "elements": [
                            {
                                "name": "analytic11-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies Dataverse sign-in activity from IPv4 addresses which are on a predefined block list. Blocked network ranges are maintained in the NetworkAddresses watchlist template."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic12",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Login from IP not in the allow list",
                        "elements": [
                            {
                                "name": "analytic12-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies logons from IPv4 addresses not matching IPv4 subnets maintained on an allow list. This analytics rule uses the NetworkAddresses watchlist template."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic13",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Malware found in SharePoint document management site",
                        "elements": [
                            {
                                "name": "analytic13-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "This query identifies malware uploaded via Dynamics 365 document management or directly in SharePoint impacting Dataverse associated SharePoint sites."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic14",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Mass deletion of records",
                        "elements": [
                            {
                                "name": "analytic14-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies large scale record delete operations based on a predefined threshold and also detects scheduled bulk deletion jobs."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic15",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Mass download from SharePoint document management",
                        "elements": [
                            {
                                "name": "analytic15-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies mass download (in the last hour) of files from SharePoint sites configured for document management in Dynamics 365. This analytics rule utilizes the MSBizApps-Configuration watchlist to identify SharePoint sites used for Document Management."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic16",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Mass export of records to Excel",
                        "elements": [
                            {
                                "name": "analytic16-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies users exporting a large amount of records from Dynamics 365 to Excel, significantly more records exported than any other recent activity by that user. Large exports from users with no recent activity are identified using a predefined threshold."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic17",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Mass record updates",
                        "elements": [
                            {
                                "name": "analytic17-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "This query detects mass record update changes in Dataverse and Dynamics 365, exceeding a pre-defined threshold."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic18",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - New Dataverse application user activity type",
                        "elements": [
                            {
                                "name": "analytic18-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies new or previously unseen activity types associated with Dataverse application (non-interactive) user."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic19",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - New non-interactive identity granted access",
                        "elements": [
                            {
                                "name": "analytic19-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies API level access grants, either via the delegated permissions of a Microsoft Entra application or direct assignment within Dataverse as an application user."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic20",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - New sign-in from an unauthorized domain",
                        "elements": [
                            {
                                "name": "analytic20-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies Dataverse sign-in activity originating from users with UPN suffixes that have not been seen previously in the last 14 days and are not present on a predefined list of authorized domains. Common internal Power Platform system users are excluded by default."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic21",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - New user agent type that was not used before",
                        "elements": [
                            {
                                "name": "analytic21-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies users accessing Dataverse from a User Agent that has not been seen in any Dataverse instance in the last 14 days."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic22",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - New user agent type that was not used with Office 365",
                        "elements": [
                            {
                                "name": "analytic22-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies users accessing Dynamics with a User Agent that has not been seen in any Office 365 workloads in the last 14 days."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic23",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Organization settings modified",
                        "elements": [
                            {
                                "name": "analytic23-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies changes made at organization level in the Dataverse environment."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic24",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Removal of blocked file extensions",
                        "elements": [
                            {
                                "name": "analytic24-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies modifications to an environment's blocked file extensions and extracts the removed extension."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic25",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - SharePoint document management site added or updated",
                        "elements": [
                            {
                                "name": "analytic25-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies modifications of SharePoint document management integration. Document management allows storage of data located externally to Dataverse. Combine this analytics rule with the MSBizApps-Add-SharePointSite-To-Watchlist Playbook to automatically update the Dataverse-SharePointSites watchlist. This watchlist can be used to correlate events between Dataverse and SharePoint when using the Office 365 data connector."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic26",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Suspicious security role modifications",
                        "elements": [
                            {
                                "name": "analytic26-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies an unusual pattern of events whereby a new role is created followed by the creator adding members to the role and subsequently removing the member or deleting the role after a short time period."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic27",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Suspicious use of TDS endpoint",
                        "elements": [
                            {
                                "name": "analytic27-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies Dataverse TDS (Tabular Data Stream) protocol based queries where the source user or IP address has recent security alerts and the TDS protocol has not been used previously in the target environment."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic28",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Suspicious use of Web API",
                        "elements": [
                            {
                                "name": "analytic28-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies sign-in across multiple Dataverse environments, breaching a predefined threshold, originating from a user with IP address that was used to sign-into the well known Microsoft Entra app registration."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic29",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - TI map IP to DataverseActivity",
                        "elements": [
                            {
                                "name": "analytic29-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies a match in DataverseActivity from any IP IOC from Microsoft Sentinel Threat Intelligence."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic30",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - TI map URL to DataverseActivity",
                        "elements": [
                            {
                                "name": "analytic30-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies a match in DataverseActivity from any URL IOC from Microsoft Sentinel Threat Intelligence."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic31",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Terminated employee exfiltration over email",
                        "elements": [
                            {
                                "name": "analytic31-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "This query identifies Dataverse exfiltration via email by terminated employees."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic32",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Terminated employee exfiltration to USB drive",
                        "elements": [
                            {
                                "name": "analytic32-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies files downloaded from Dataverse by departing or terminated employees which are copied to USB mounted drives."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic33",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Unusual sign-in following disabled IP address-based cookie binding protection",
                        "elements": [
                            {
                                "name": "analytic33-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies previously unseen IP and user agents in a Dataverse instance following disabling of cookie binding protection. See https://docs.microsoft.com/power-platform/admin/block-cookie-replay-attack"
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic34",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - User bulk retrieval outside normal activity",
                        "elements": [
                            {
                                "name": "analytic34-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies users retrieving significantly more records from Dataverse than they have previously in the past 2 weeks."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic35",
                        "type": "Microsoft.Common.Section",
                        "label": "F&O - Bank account change following network alias reassignment",
                        "elements": [
                            {
                                "name": "analytic35-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies changes to user accounts where the network alias was modified to a new value. Shortly afterwards, the updated alias is used to update a bank account number."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic36",
                        "type": "Microsoft.Common.Section",
                        "label": "F&O - Mass update or deletion of user records",
                        "elements": [
                            {
                                "name": "analytic36-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies large delete or update operations on Finance & Operations user records based on predefined thresholds."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic37",
                        "type": "Microsoft.Common.Section",
                        "label": "F&O - Non-interactive account mapped to self or sensitive privileged user",
                        "elements": [
                            {
                                "name": "analytic37-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies changes to Microsoft Entra client apps registered for Finance & Operations, specifically when a new client is mapped to a predefined list of sensitive privileged user accounts, or when a user associates a client app with their own account."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic38",
                        "type": "Microsoft.Common.Section",
                        "label": "F&O - Reverted bank account number modifications",
                        "elements": [
                            {
                                "name": "analytic38-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies changes to bank account numbers in Finance & Operations, whereby a bank account number is modified but then subsequently reverted a short time later."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic39",
                        "type": "Microsoft.Common.Section",
                        "label": "F&O - Unusual sign-in activity using single factor authentication",
                        "elements": [
                            {
                                "name": "analytic39-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies sucessful sign-in events to Finance & Operations and Lifecycle Services using single factor/password authentication. Sign-in events from tenants not using MFA, coming from a Microsoft Entra trusted network location, or from geolocations seen previously in the last 14 days are excluded."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic40",
                        "type": "Microsoft.Common.Section",
                        "label": "Power Apps - App activity from unauthorized geo",
                        "elements": [
                            {
                                "name": "analytic40-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies Power Apps activity from countries in a predefined list of unauthorized countries."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic41",
                        "type": "Microsoft.Common.Section",
                        "label": "Power Apps - Bulk sharing of Power Apps to newly created guest users",
                        "elements": [
                            {
                                "name": "analytic41-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies unusual bulk sharing, based on a predefined threshold in the query, of Power Apps to newly created Microsoft Entra guest users."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic42",
                        "type": "Microsoft.Common.Section",
                        "label": "Power Apps - Multiple apps deleted",
                        "elements": [
                            {
                                "name": "analytic42-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies mass delete activity where multiple Power Apps are deleted, matching a predefined threshold of total apps deleted or app delete events across multiple Power Platform environments."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic43",
                        "type": "Microsoft.Common.Section",
                        "label": "Power Apps - Multiple users access a malicious link after launching new app",
                        "elements": [
                            {
                                "name": "analytic43-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies a chain of events, where a new Power App is created, followed by mulitple users launching the app within the detection window and clicking on the same malicious URL."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic44",
                        "type": "Microsoft.Common.Section",
                        "label": "Power Automate - Departing employee flow activity",
                        "elements": [
                            {
                                "name": "analytic44-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies instances where an employee who has been notified or is already terminated, on the TerminatedEmployees watchlist, creates or modifies a Power Automate flow."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic45",
                        "type": "Microsoft.Common.Section",
                        "label": "Power Automate - Unusual bulk deletion of flow resources",
                        "elements": [
                            {
                                "name": "analytic45-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies bulk deletion of Power Automate flows that exceed a predefined threshold defined in the query and deviate from activity patterns observed in the last 14 days."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic46",
                        "type": "Microsoft.Common.Section",
                        "label": "Power Platform - Account added to privileged Microsoft Entra roles",
                        "elements": [
                            {
                                "name": "analytic46-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies changes to privileged directory roles impacting Power Platform:\n- Dynamics 365 Admins\n- Power Platform Admins\n- Fabric Admins"
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic47",
                        "type": "Microsoft.Common.Section",
                        "label": "Power Platform - Connector added to a sensitive environment",
                        "elements": [
                            {
                                "name": "analytic47-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies occurrences of new API connector creations within Power Platform, specifically targeting a predefined list of sensitive environments."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic48",
                        "type": "Microsoft.Common.Section",
                        "label": "Power Platform - DLP policy updated or removed",
                        "elements": [
                            {
                                "name": "analytic48-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies changes to DLP policy, specifically policies which are updated or removed."
                                }
                            }
                        ]
                    },
                    {
                        "name": "analytic49",
                        "type": "Microsoft.Common.Section",
                        "label": "Power Platform - Possibly compromised user accesses Power Platform services",
                        "elements": [
                            {
                                "name": "analytic49-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Identifies user accounts flagged at risk in Microsoft Entra Identity Protection and correlates these users with sign-in activity in Power Platform, including Power Apps, Power Automate and Power Platform Admin Center."
                                }
                            }
                        ]
                    }
                ]
            },
            {
                "name": "huntingqueries",
                "label": "Hunting Queries",
                "bladeTitle": "Hunting Queries",
                "elements": [
                    {
                        "name": "huntingqueries-text",
                        "type": "Microsoft.Common.TextBlock",
                        "options": {
                            "text": "This solution installs the following hunting queries. After installing the solution, run these hunting queries to hunt for threats in Manage solution view. "
                        }
                    },
                    {
                        "name": "huntingqueries-link",
                        "type": "Microsoft.Common.TextBlock",
                        "options": {
                            "link": {
                                "label": "Learn more",
                                "uri": "https://docs.microsoft.com/azure/sentinel/hunting"
                            }
                        }
                    },
                    {
                        "name": "huntingquery1",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Activity after Microsoft Entra alerts",
                        "elements": [
                            {
                                "name": "huntingquery1-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "This hunting query looks for users conducting Dataverse/Dynamics 365 activity shortly after a Microsoft Entra Identity Protection alert for that user. The query only looks for users not seen before or conducting Dynamics activity not previously seen. This hunting query depends on Dataverse AzureActiveDirectoryIdentityProtection data connector (DataverseActivity SecurityAlert Parser or Table)"
                                }
                            }
                        ]
                    },
                    {
                        "name": "huntingquery2",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Activity after failed logons",
                        "elements": [
                            {
                                "name": "huntingquery2-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "This hunting query looks for users conducting Dataverse/Dynamics 365 activity shortly after a number of failed logons. Use this to look for potential post brute force activity. Adjust the threshold figure based on false positive rate. This hunting query depends on Dataverse AzureActiveDirectory data connector (DataverseActivity SigninLogs Parser or Table)"
                                }
                            }
                        ]
                    },
                    {
                        "name": "huntingquery3",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Cross-environment data export activity",
                        "elements": [
                            {
                                "name": "huntingquery3-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "This query searches for data export activity across a predetermined number of Dataverse instances. Data export activity across multiple environments could indicate suspicious activity as users typically work on a small number of environments. This hunting query depends on Dataverse data connector (DataverseActivity Parser or Table)"
                                }
                            }
                        ]
                    },
                    {
                        "name": "huntingquery4",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Dataverse export copied to USB devices",
                        "elements": [
                            {
                                "name": "huntingquery4-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "This query uses XDR data from M365 Defender to detect files downloaded from a Dataverse instance and copied to USB drive. This hunting query depends on Dataverse MicrosoftThreatProtection data connector (DataverseActivity DeviceInfo DeviceEvents DeviceFileEvents Parser or Table)"
                                }
                            }
                        ]
                    },
                    {
                        "name": "huntingquery5",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Generic client app used to access production environments",
                        "elements": [
                            {
                                "name": "huntingquery5-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "This query detects the use of the built-in \"Dynamics 365 Example Application\" to access production environments. This generic app can not be restricted by Azure AD authorization controls and could be abused to gain unauthorized access via Web API. This hunting query depends on Dataverse AzureActiveDirectory data connector (DataverseActivity SigninLogs Parser or Table)"
                                }
                            }
                        ]
                    },
                    {
                        "name": "huntingquery6",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Identity management activity outside of privileged directory role membership",
                        "elements": [
                            {
                                "name": "huntingquery6-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "This query detects identity administration events in Dataverse/Dynamics 365 made by accounts which are not members of privileged directory roles 'Dynamics 365 Admins', 'Power Platform Admins' or 'Global Admins This hunting query depends on Dataverse IdentityInfo data connector (DataverseActivity IdentityInfo Parser or Table)"
                                }
                            }
                        ]
                    },
                    {
                        "name": "huntingquery7",
                        "type": "Microsoft.Common.Section",
                        "label": "Dataverse - Identity management changes without MFA",
                        "elements": [
                            {
                                "name": "huntingquery7-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "This query is used to show privileged identity administration operations in Dataverse made by accounts that signed in without using MFA This hunting query depends on Dataverse AzureActiveDirectory data connector (DataverseActivity SigninLogs Parser or Table)"
                                }
                            }
                        ]
                    },
                    {
                        "name": "huntingquery8",
                        "type": "Microsoft.Common.Section",
                        "label": "Power Apps - Anomalous bulk sharing of Power App to newly created guest users",
                        "elements": [
                            {
                                "name": "huntingquery8-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "The query detects anomalous attempts to perform bulk sharing of Power App to newly created guest users. This hunting query depends on PowerPlatformAdmin AzureActiveDirectory data connector (PowerPlatformAdminActivity AuditLogs Parser or Table)"
                                }
                            }
                        ]
                    }
                ]
            },
            {
                "name": "watchlists",
                "label": "Watchlists",
                "subLabel": {
                    "preValidation": "Configure the watchlists",
                    "postValidation": "Done"
                },
                "bladeTitle": "Watchlists",
                "elements": [
                    {
                        "name": "watchlists-text",
                        "type": "Microsoft.Common.TextBlock",
                        "options": {
                            "text": "Microsoft Sentinel watchlists enable the collection of data from external data sources for correlation with the events in your Microsoft Sentinel environment. Once created, you can use watchlists in your search, detection rules, threat hunting, and response playbooks. Watchlists are stored in your Microsoft Sentinel workspace as name-value pairs and are cached for optimal query performance and low latency. Once deployment is successful, the installed watchlists will be available in the Watchlists blade under 'My Watchlists'.",
                            "link": {
                                "label": "Learn more",
                                "uri": "https://aka.ms/sentinelwatchlists"
                            }
                        }
                    },
                    {
                        "name": "watchlist1",
                        "type": "Microsoft.Common.Section",
                        "label": "MSBizApps-Configuration",
                        "elements": [
                            {
                                "name": "watchlist1-text",
                                "type": "Microsoft.Common.TextBlock",
                                "options": {
                                    "text": "Configuration for Microsoft Business Applications solution"
                                }
                            }
                        ]
                    }
                ]
            },
            {
                "name": "playbooks",
                "label": "Playbooks",
                "subLabel": {
                    "preValidation": "Configure the playbooks",
                    "postValidation": "Done"
                },
                "bladeTitle": "Playbooks",
                "elements": [
                    {
                        "name": "playbooks-text",
                        "type": "Microsoft.Common.TextBlock",
                        "options": {
                            "text": "This solution installs the Playbook templates to help implement your Security Orchestration, Automation and Response (SOAR) operations. After installing the solution, these will be deployed under Playbook Templates in the Automation blade in Microsoft Sentinel. They can be configured and managed from the Manage solution view in Content Hub."
                        }
                    },
                    {
                        "name": "playbooks-link",
                        "type": "Microsoft.Common.TextBlock",
                        "options": {
                            "link": {
                                "label": "Learn more",
                                "uri": "https://docs.microsoft.com/azure/sentinel/tutorial-respond-threats-playbook?WT.mc_id=Portal-Microsoft_Azure_CreateUIDef"
                            }
                        }
                    }
                ]
            }
        ],
        "outputs": {
            "workspace-location": "[first(map(filter(basics('getLAWorkspace').value, (filter) => and(contains(toLower(filter.id), toLower(resourceGroup().name)),equals(filter.name,basics('workspace')))), (item) => item.location))]",
            "location": "[location()]",
            "workspace": "[basics('workspace')]"
        }
    }
}