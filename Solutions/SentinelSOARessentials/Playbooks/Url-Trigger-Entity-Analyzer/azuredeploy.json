{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "title": "URL Trigger Entity Analyzer",
        "description": "This playbook is triggered manually when a URL entity is selected in a Microsoft Sentinel incident and provides detailed security insights including classification, analysis results, and recommendations.",
        "prerequisites": [
            "1. The user deploying this Logic App needs to have a Contributor Role.",
            "2. The user has permissions to access Microsoft Sentinel workspace.",
            "3. You have the Workspace ID for your Sentinel environment.",
            "4. The SentinelMCP connector is available in your environment.",
            "5. Access to Microsoft Sentinel portal in Azure (not Defender portal)."
        ],
        "postDeployment": [
            "1. Authenticate the connections: Go to the Logic App ‚Üí API connections and authenticate Microsoft Sentinel connection with a user that has Sentinel permissions.",
            "2. Authenticate the SentinelMCP connection with Microsoft Sentinel MCP permissions.",
            "3. The playbook will be available to run manually from incident entities.",
            "4. Results will be automatically added as comments to the relevant incidents."
        ],
        "prerequisitesDeployTemplateFile": "",
        "lastUpdateTime": "2025-12-07T00:00:00.000Z",
        "entities": [
            "URL"
        ],
        "tags": [
            "Enrichment",
            "Utilities",
            "Entity Analysis"
        ],
        "support": {
            "tier": "community"
        },
        "author": {
            "name": "yaniv shasha"
        }
    },
    "parameters": {
        "PlaybookName": {
            "defaultValue": "Entity-analyzer-Url-Trigger",
            "type": "string"
        },
        "lookBackDays": {
            "defaultValue": 7,
            "type": "int",
            "metadata": {
                "description": "Number of days to look back for entity analysis"
            }
        },
        "workspaceId": {
            "type": "string",
            "metadata": {
                "description": "The workspace ID for Microsoft Sentinel"
            }
        }
    },
    "variables": {
        "MicrosoftSentinelConnectionName": "[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
        "SentinelMCPConnectionName": "[concat('SentinelMCP-', parameters('PlaybookName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "[parameters('PlaybookName')]",
            "location": "[resourceGroup().location]",
            "identity": {
                "type": "SystemAssigned"
            },
            "tags": {
                "Created By": "ARM Template"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[resourceId('Microsoft.Web/connections', variables('SentinelMCPConnectionName'))]"
            ],
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"
                        }
                    },
                    "triggers": {
                        "Microsoft_Sentinel_entity": {
                            "type": "ApiConnectionWebhook",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "body": {
                                    "callback_url": "@listCallbackUrl()"
                                },
                                "path": "/entity/@{encodeURIComponent('UrlEntity')}"
                            }
                        }
                    },
                    "actions": {
                        "URL_Analyzer": {
                            "runAfter": {},
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['sentinelmcp']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "body": {
                                    "workspaceId": "[parameters('workspaceId')]",
                                    "lookBackDays": "[parameters('lookBackDays')]",
                                    "properties": {
                                        "entityType": "Url",
                                        "url": "@{triggerBody()?['Entity']?['properties']?['Url']}"
                                    }
                                },
                                "path": "/aiprimitives/analysis"
                            }
                        },
                        "Add_comment_to_incident_(V3)": {
                            "runAfter": {
                                "URL_Analyzer": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "body": {
                                    "incidentArmId": "@triggerBody()?['IncidentArmID']",
                                    "message": "<p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">Security Analysis Report</strong></b><br><br><br><b><strong class=\"editor-text-bold\">Analysis ID: </strong></b>@{body('URL_Analyzer')['id']}<br><br><b><strong class=\"editor-text-bold\">Entity Type:</strong></b> Url<br><br><br>üîó <b><strong class=\"editor-text-bold\">URL Analysis for:</strong></b> @{triggerBody()?['Entity']?['properties']?['Url']}<br><br><br>üè∑Ô∏è <b><strong class=\"editor-text-bold\">Classification: </strong></b>@{body('URL_Analyzer')?['classification']}<br><br><br>üîç <b><strong class=\"editor-text-bold\">Analysis Result: </strong></b>@{body('URL_Analyzer')?['analysis']}<br><br><br>‚úÖ<b><strong class=\"editor-text-bold\"> Recommendation:</strong></b> @{body('URL_Analyzer')?['recommendation']}<br><br><br>üìã <b><strong class=\"editor-text-bold\">Data Sources:</strong></b> @{body('URL_Analyzer')?['dataSourceList']}<br><br><br>‚ùó <b><strong class=\"editor-text-bold\">Disclaimer:</strong></b> @{body('URL_Analyzer')?['disclaimer']}</p>"
                                },
                                "path": "/Incidents/Comment"
                            }
                        }
                    },
                    "outputs": {}
                },
                "parameters": {
                    "$connections": {
                        "value": {
                            "azuresentinel": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                "connectionName": "[variables('MicrosoftSentinelConnectionName')]",
                                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Azuresentinel')]",
                                "connectionProperties": {
                                    "authentication": {
                                        "type": "ManagedServiceIdentity"
                                    }
                                }
                            },
                            "sentinelmcp": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('SentinelMCPConnectionName'))]",
                                "connectionName": "[variables('SentinelMCPConnectionName')]",
                                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/sentinelmcp')]"
                            }
                        }
                    }
                }
            }
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('MicrosoftSentinelConnectionName')]",
            "location": "[resourceGroup().location]",
            "kind": "V1",
            "properties": {
                "displayName": "[variables('MicrosoftSentinelConnectionName')]",
                "customParameterValues": {},
                "parameterValueType": "Alternative",
                "api": {
                    "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Azuresentinel')]"
                }
            }
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('SentinelMCPConnectionName')]",
            "location": "[resourceGroup().location]",
            "kind": "V1",
            "properties": {
                "displayName": "[variables('SentinelMCPConnectionName')]",
                "customParameterValues": {},
                "api": {
                    "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/sentinelmcp')]"
                }
            }
        }
    ]
}