{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for SentinelSOARessentials"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Automation health",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook2-name": {
      "type": "string",
      "defaultValue": "Incident overview",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook3-name": {
      "type": "string",
      "defaultValue": "Security Operations Efficiency",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook4-name": {
      "type": "string",
      "defaultValue": "Incident Tasks Workbook",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "_solutionName": "SentinelSOARessentials",
    "_solutionVersion": "3.0.0",
    "solutionId": "azuresentinel.azure-sentinel-solution-sentinelsoaressentials",
    "_solutionId": "[variables('solutionId')]",
    "Incident-Assignment-Shifts": "Incident-Assignment-Shifts",
    "_Incident-Assignment-Shifts": "[variables('Incident-Assignment-Shifts')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "Incident-Assignment-Shifts",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookId1": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId1'))),variables('playbookVersion1')))]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
    "Notify-IncidentClosed": "Notify-IncidentClosed",
    "_Notify-IncidentClosed": "[variables('Notify-IncidentClosed')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "Notify-IncidentClosed",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))),variables('playbookVersion2')))]",
    "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
    "Notify-IncidentReopened": "Notify-IncidentReopened",
    "_Notify-IncidentReopened": "[variables('Notify-IncidentReopened')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "Notify-IncidentReopened",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3'))),variables('playbookVersion3')))]",
    "_playbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId3'),'-', variables('playbookVersion3'))))]",
    "Notify-IncidentSeverityChanged": "Notify-IncidentSeverityChanged",
    "_Notify-IncidentSeverityChanged": "[variables('Notify-IncidentSeverityChanged')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "Notify-IncidentSeverityChanged",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4'))),variables('playbookVersion4')))]",
    "_playbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId4'),'-', variables('playbookVersion4'))))]",
    "Notify-Owner": "Notify-Owner",
    "_Notify-Owner": "[variables('Notify-Owner')]",
    "playbookVersion5": "1.0",
    "playbookContentId5": "Notify-Owner",
    "_playbookContentId5": "[variables('playbookContentId5')]",
    "playbookId5": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId5'))]",
    "playbookTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId5'))),variables('playbookVersion5')))]",
    "_playbookcontentProductId5": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId5'),'-', variables('playbookVersion5'))))]",
    "Post-Message-Slack-alert-trigger": "Post-Message-Slack-alert-trigger",
    "_Post-Message-Slack-alert-trigger": "[variables('Post-Message-Slack-alert-trigger')]",
    "blanks": "[replace('b', 'b', '')]",
    "playbookVersion6": "1.0",
    "playbookContentId6": "Post-Message-Slack-alert-trigger",
    "_playbookContentId6": "[variables('playbookContentId6')]",
    "playbookId6": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId6'))]",
    "playbookTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId6'))),variables('playbookVersion6')))]",
    "_playbookcontentProductId6": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId6'),'-', variables('playbookVersion6'))))]",
    "Post-Message-Teams-alert-trigger": "Post-Message-Teams-alert-trigger",
    "_Post-Message-Teams-alert-trigger": "[variables('Post-Message-Teams-alert-trigger')]",
    "playbookVersion7": "1.0",
    "playbookContentId7": "Post-Message-Teams-alert-trigger",
    "_playbookContentId7": "[variables('playbookContentId7')]",
    "playbookId7": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId7'))]",
    "playbookTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId7'))),variables('playbookVersion7')))]",
    "_playbookcontentProductId7": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId7'),'-', variables('playbookVersion7'))))]",
    "Post-Message-Teams-incident-trigger": "Post-Message-Teams-incident-trigger",
    "_Post-Message-Teams-incident-trigger": "[variables('Post-Message-Teams-incident-trigger')]",
    "playbookVersion8": "1.0",
    "playbookContentId8": "Post-Message-Teams-incident-trigger",
    "_playbookContentId8": "[variables('playbookContentId8')]",
    "playbookId8": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId8'))]",
    "playbookTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId8'))),variables('playbookVersion8')))]",
    "_playbookcontentProductId8": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId8'),'-', variables('playbookVersion8'))))]",
    "Post-Message-Slack-incident-trigger": "Post-Message-Slack-incident-trigger",
    "_Post-Message-Slack-incident-trigger": "[variables('Post-Message-Slack-incident-trigger')]",
    "playbookVersion9": "1.0",
    "playbookContentId9": "Post-Message-Slack-incident-trigger",
    "_playbookContentId9": "[variables('playbookContentId9')]",
    "playbookId9": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId9'))]",
    "playbookTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId9'))),variables('playbookVersion9')))]",
    "_playbookcontentProductId9": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId9'),'-', variables('playbookVersion9'))))]",
    "relateAlertsToIncident-basedOnIP": "relateAlertsToIncident-basedOnIP",
    "_relateAlertsToIncident-basedOnIP": "[variables('relateAlertsToIncident-basedOnIP')]",
    "TemplateEmptyArray": "[json('[]')]",
    "playbookVersion10": "1.0",
    "playbookContentId10": "relateAlertsToIncident-basedOnIP",
    "_playbookContentId10": "[variables('playbookContentId10')]",
    "playbookId10": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId10'))]",
    "playbookTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId10'))),variables('playbookVersion10')))]",
    "_playbookcontentProductId10": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId10'),'-', variables('playbookVersion10'))))]",
    "Send-basic-email": "Send-basic-email",
    "_Send-basic-email": "[variables('Send-basic-email')]",
    "playbookVersion11": "1.0",
    "playbookContentId11": "Send-basic-email",
    "_playbookContentId11": "[variables('playbookContentId11')]",
    "playbookId11": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId11'))]",
    "playbookTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId11'))),variables('playbookVersion11')))]",
    "_playbookcontentProductId11": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId11'),'-', variables('playbookVersion11'))))]",
    "Send-email-with-formatted-incident-report": "Send-email-with-formatted-incident-report",
    "_Send-email-with-formatted-incident-report": "[variables('Send-email-with-formatted-incident-report')]",
    "playbookVersion12": "1.0",
    "playbookContentId12": "Send-email-with-formatted-incident-report",
    "_playbookContentId12": "[variables('playbookContentId12')]",
    "playbookId12": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId12'))]",
    "playbookTemplateSpecName12": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId12'))),variables('playbookVersion12')))]",
    "_playbookcontentProductId12": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId12'),'-', variables('playbookVersion12'))))]",
    "CreateIncident-MicrosoftForms": "CreateIncident-MicrosoftForms",
    "_CreateIncident-MicrosoftForms": "[variables('CreateIncident-MicrosoftForms')]",
    "playbookVersion13": "1.0",
    "playbookContentId13": "CreateIncident-MicrosoftForms",
    "_playbookContentId13": "[variables('playbookContentId13')]",
    "playbookId13": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId13'))]",
    "playbookTemplateSpecName13": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId13'))),variables('playbookVersion13')))]",
    "_playbookcontentProductId13": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId13'),'-', variables('playbookVersion13'))))]",
    "CreateIncident-SharedMailbox": "CreateIncident-SharedMailbox",
    "_CreateIncident-SharedMailbox": "[variables('CreateIncident-SharedMailbox')]",
    "playbookVersion14": "1.0",
    "playbookContentId14": "CreateIncident-SharedMailbox",
    "_playbookContentId14": "[variables('playbookContentId14')]",
    "playbookId14": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId14'))]",
    "playbookTemplateSpecName14": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId14'))),variables('playbookVersion14')))]",
    "_playbookcontentProductId14": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId14'),'-', variables('playbookVersion14'))))]",
    "M365D_BEC_Playbook_for_SecOps-Tasks": "M365D_BEC_Playbook_for_SecOps-Tasks",
    "_M365D_BEC_Playbook_for_SecOps-Tasks": "[variables('M365D_BEC_Playbook_for_SecOps-Tasks')]",
    "playbookVersion15": "1.0",
    "playbookContentId15": "M365D_BEC_Playbook_for_SecOps-Tasks",
    "_playbookContentId15": "[variables('playbookContentId15')]",
    "playbookId15": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId15'))]",
    "playbookTemplateSpecName15": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId15'))),variables('playbookVersion15')))]",
    "_playbookcontentProductId15": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId15'),'-', variables('playbookVersion15'))))]",
    "M365D_Phishing_Playbook_for_SecOps-Tasks": "M365D_Phishing_Playbook_for_SecOps-Tasks",
    "_M365D_Phishing_Playbook_for_SecOps-Tasks": "[variables('M365D_Phishing_Playbook_for_SecOps-Tasks')]",
    "playbookVersion16": "1.1",
    "playbookContentId16": "M365D_Phishing_Playbook_for_SecOps-Tasks",
    "_playbookContentId16": "[variables('playbookContentId16')]",
    "playbookId16": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId16'))]",
    "playbookTemplateSpecName16": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId16'))),variables('playbookVersion16')))]",
    "_playbookcontentProductId16": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId16'),'-', variables('playbookVersion16'))))]",
    "M365D_Ransomware_Playbook_for_SecOps-Tasks": "M365D_Ransomware_Playbook_for_SecOps-Tasks",
    "_M365D_Ransomware_Playbook_for_SecOps-Tasks": "[variables('M365D_Ransomware_Playbook_for_SecOps-Tasks')]",
    "playbookVersion17": "1.0",
    "playbookContentId17": "M365D_Ransomware_Playbook_for_SecOps-Tasks",
    "_playbookContentId17": "[variables('playbookContentId17')]",
    "playbookId17": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId17'))]",
    "playbookTemplateSpecName17": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId17'))),variables('playbookVersion17')))]",
    "_playbookcontentProductId17": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId17'),'-', variables('playbookVersion17'))))]",
    "Send-Teams-adaptive-card-on-incident-creation": "Send-Teams-adaptive-card-on-incident-creation",
    "_Send-Teams-adaptive-card-on-incident-creation": "[variables('Send-Teams-adaptive-card-on-incident-creation')]",
    "playbookVersion18": "1.0",
    "playbookContentId18": "Send-Teams-adaptive-card-on-incident-creation",
    "_playbookContentId18": "[variables('playbookContentId18')]",
    "playbookId18": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId18'))]",
    "playbookTemplateSpecName18": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId18'))),variables('playbookVersion18')))]",
    "_playbookcontentProductId18": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId18'),'-', variables('playbookVersion18'))))]",
    "workbookVersion1": "2.0.0",
    "workbookContentId1": "AutomationHealth",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))),variables('workbookVersion1')))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "workbookVersion2": "2.1.0",
    "workbookContentId2": "IncidentOverview",
    "workbookId2": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId2'))]",
    "workbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId2'))),variables('workbookVersion2')))]",
    "_workbookContentId2": "[variables('workbookContentId2')]",
    "_workbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId2'),'-', variables('workbookVersion2'))))]",
    "workbookVersion3": "1.5.0",
    "workbookContentId3": "SecurityOperationsEfficiency",
    "workbookId3": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId3'))]",
    "workbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId3'))),variables('workbookVersion3')))]",
    "_workbookContentId3": "[variables('workbookContentId3')]",
    "_workbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId3'),'-', variables('workbookVersion3'))))]",
    "workbookVersion4": "1.1.0",
    "workbookContentId4": "IncidentTasksWorkbook",
    "workbookId4": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId4'))]",
    "workbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId4'))),variables('workbookVersion4')))]",
    "_workbookContentId4": "[variables('workbookContentId4')]",
    "_workbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId4'),'-', variables('workbookVersion4'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Sentinel_Incident_Assignment_Shifts Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Sentinel_Incident_Assignment_Shifts",
              "type": "String"
            },
            "EmailAddress": {
              "defaultValue": "Your email address",
              "type": "string"
            }
          },
          "variables": {
            "AzureMonitorLogs": "[[concat('azuremonitorlogs-', parameters('PlaybookName'))]",
            "AzureSentinel": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "office365": "[[concat('office365-', parameters('PlaybookName'))]",
            "Shifts": "[[concat('shifts-', parameters('PlaybookName'))]",
            "azure": "[[concat('https://management','.azure','.com')]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuremonitorlogs')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/shifts')]",
            "_connection-4": "[[variables('connection-4')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureMonitorLogs')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('EmailAddress')]",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinel')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('EmailAddress')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('office365')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('EmailAddress')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Shifts')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('EmailAddress')]",
                "api": {
                  "id": "[[variables('_connection-4')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "IncidentAssignmentShifts",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogs'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinel'))]",
                "[[resourceId('Microsoft.Web/connections', variables('office365'))]",
                "[[resourceId('Microsoft.Web/connections', variables('Shifts'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation",
                        "retryPolicy": {
                          "type": "none"
                        }
                      },
                      "runtimeConfiguration": {
                        "concurrency": {
                          "runs": 1,
                          "maximumWaitingRuns": 100
                        }
                      }
                    }
                  },
                  "actions": {
                    "Condition_-_Check_Incident_Owner": {
                      "actions": {
                        "Condition_-_Check_User_Array": {
                          "actions": {
                            "Add_comment_to_incident_(V3)": {
                              "runAfter": {
                                "Update_incident": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "message": "<p><span style=\"font-size: 18px\"><strong>Incident assigned to </strong></span><span style=\"color: rgb(85,57,130); font-size: 18px\"><strong></strong></span><span style=\"color: rgb(147,101,184); font-size: 18px\"><strong>@{body('Update_incident')?['properties']?['owner']?['assignedTo']}</strong></span><span style=\"color: rgb(147,101,184); font-size: 18px\"><strong></strong></span><span style=\"color: rgb(147,101,184); font-size: 18px\"><strong> </strong></span><br>\n<span style=\"font-size: 12px; color: rgb(41,105,176)\">Incident assigned to </span><span style=\"font-size: 12px; color: rgb(41,105,176)\"><strong>@{body('Update_incident')?['properties']?['owner']?['assignedTo']}</strong></span><span style=\"font-size: 12px; color: rgb(41,105,176)\"> </span><span style=\"font-size: 12px; color: rgb(41,105,176)\">by '</span><span style=\"font-size: 12px; color: rgb(41,105,176)\"><em>@{workflow().name}</em></span><span style=\"font-size: 12px; color: rgb(41,105,176)\">' Playbook.</span></p>"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/Comment"
                              }
                            },
                            "Compose_HTML_Email": {
                              "runAfter": {
                                "Add_comment_to_incident_(V3)": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<!DOCTYPE html>\n<html>\n<head>    \n<style>\n.header-Informational{background-color: grey;color: white;}.header-Low{background-color: yellow;color: black;}.header-Medium{background-color: orange;color: black;}.header-High{background-color: red;color: white;}\nspan{display: none;}.severity-1{display: inline;text-decoration:none;}\n{display: inline;text-decoration:none;}.cell{float: left;overflow: hidden;text-overflow: ellipsis;white-space: nowrap; max-width: 100%;}\n</style>\n</head>\n<body>\n<table class=\"header-@{triggerBody()?['object']?['properties']?['severity']}\" style=\"table-layout: auto; width: 100%; padding-left: 10px; padding-right:10px;font-size:20px\" ><tr>\n<td class=\"align-middle\" height=\"50\" align=\"left\" style=\"width: 20%;\">Severity:<b><i>@{triggerBody()?['object']?['properties']?['severity']}</b></i></td>\n<td class=\"align-middle\" height=\"50\" align=\"left\" style=\"width: 75%;\">Title: <b><i>@{triggerBody()?['object']?['properties']?['title']}</b></i></td></tr><tr>\n</table>\n<div style=\"margin-top: 20px\">\n\n  The following incident in Azure Sentinel has been assigned to <b>@{body('Update_incident')?['properties']?['owner']?['assignedTo']}</b>.\n\n\n  <h1>Incident Details:</h1>\n\n  <b>Incident Number:</b> @{triggerBody()?['object']?['properties']?['incidentNumber']}<br />\n  <b>Title:</b> @{triggerBody()?['object']?['properties']?['title']} <br />\n  <b>Owner:</b> @{body('Update_incident')?['properties']?['owner']?['assignedTo']} <br />\n  <b>Severity:</b> @{triggerBody()?['object']?['properties']?['severity']}<br />\n  <b>TimeGenerated(UTC):</b> @{triggerBody()?['object']?['properties']?['createdTimeUtc']} <br />\n  <b>Status:</b> @{triggerBody()?['object']?['properties']?['status']} <br />\n  <br />\n  <b>Incident link:</b> <a href=\"https://portal.azure.com/#asset/Microsoft_Azure_Security_Insights/Incident@{triggerBody()?['object']?['id']}\">View Incident</a><br />\n\n  </body>\n  </html>\n\n"
                            },
                            "Run_query_and_list_results_-_Get_user_with_low_assignment_": {
                              "type": "ApiConnection",
                              "inputs": {
                                "body": "let Shifts = datatable ( User:string, Count:string )\n@{replace(string(variables('User')),'\\','')};\nShifts\n| extend Count = toint(Count)\n| sort by User\n| top 1 by Count asc",
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/queryData",
                                "queries": {
                                  "resourcegroups": "@triggerBody()?['workspaceInfo']?['ResourceGroupName']",
                                  "resourcename": "@triggerBody()?['workspaceInfo']?['WorkspaceName']",
                                  "resourcetype": "Log Analytics Workspace",
                                  "subscriptions": "@triggerBody()?['workspaceInfo']?['SubscriptionId']",
                                  "timerange": "Last 24 hours"
                                }
                              }
                            },
                            "Send_an_email_(V2)": {
                              "runAfter": {
                                "Compose_HTML_Email": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "Body": "<p>@{outputs('Compose_HTML_Email')}</p>",
                                  "Subject": "Azure Sentinel Incident Assignment Notification - Incident Number: @{triggerBody()?['object']?['properties']?['incidentNumber']}",
                                  "To": "@body('Update_incident')?['properties']?['owner']?['email']"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['office365']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/v2/Mail"
                              }
                            },
                            "Update_incident": {
                              "runAfter": {
                                "Run_query_and_list_results_-_Get_user_with_low_assignment_": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "owner": "@{body('Run_query_and_list_results_-_Get_user_with_low_assignment_')['value'][0]['User']}",
                                  "ownerAction": "Assign"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              }
                            }
                          },
                          "runAfter": {
                            "For_each_Shifts_list": [
                              "Succeeded"
                            ]
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@length(variables('User'))",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "For_each_Shifts_list": {
                          "foreach": "@body('List_all_shifts')?['value']",
                          "actions": {
                            "Condition_-_Start_and_End_date": {
                              "actions": {
                                "Append_to_User_array_variable": {
                                  "runAfter": {
                                    "Set_variable_-_JsonResult": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "User",
                                    "value": "@{items('For_each_Shifts_list')?['userId']}\",\"@{length(variables('JsonResult'))}"
                                  }
                                },
                                "HTTP_-_Get_total_incidents_for_user": {
                                  "type": "Http",
                                  "inputs": {
                                    "authentication": {
                                      "type": "ManagedServiceIdentity"
                                    },
                                    "method": "GET",
                                    "uri": "[[uriComponentToString(uri(variables('azure'),'subscriptions/@{triggerBody()?[''workspaceInfo'']?[''SubscriptionId'']}/resourceGroups/@{triggerBody()?[''workspaceInfo'']?[''ResourceGroupName'']}/providers/Microsoft.OperationalInsights/workspaces/@{triggerBody()?[''workspaceInfo'']?[''WorkspaceName'']}/providers/Microsoft.SecurityInsights/Incidents?api-version=2020-01-01&$filter=(properties/owner/objectId eq ''@{items(''For_each_Shifts_list'')?[''userId'']}'' and properties/createdTimeUtc ge @{items(''For_each_Shifts_list'')?[''sharedShift'']?[''startDateTime'']})&$top=1000'))]"
                                  }
                                },
                                "Parse_JSON_-_HTTP": {
                                  "runAfter": {
                                    "HTTP_-_Get_total_incidents_for_user": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ParseJson",
                                  "inputs": {
                                    "content": "@body('HTTP_-_Get_total_incidents_for_user')",
                                    "schema": {
                                      "properties": {
                                        "value": {
                                          "items": {
                                            "properties": {
                                              "etag": {
                                                "type": "string"
                                              },
                                              "id": {
                                                "type": "string"
                                              },
                                              "name": {
                                                "type": "string"
                                              },
                                              "properties": {
                                                "properties": {
                                                  "additionalData": {
                                                    "properties": {
                                                      "alertProductNames": {
                                                        "items": {
                                                          "type": "string"
                                                        },
                                                        "type": "array"
                                                      },
                                                      "alertsCount": {
                                                        "type": "integer"
                                                      },
                                                      "bookmarksCount": {
                                                        "type": "integer"
                                                      },
                                                      "commentsCount": {
                                                        "type": "integer"
                                                      },
                                                      "tactics": {
                                                        "items": {
                                                          "type": "string"
                                                        },
                                                        "type": "array"
                                                      }
                                                    },
                                                    "type": "object"
                                                  },
                                                  "classification": {
                                                    "type": "string"
                                                  },
                                                  "createdTimeUtc": {
                                                    "type": "string"
                                                  },
                                                  "description": {
                                                    "type": "string"
                                                  },
                                                  "firstActivityTimeGenerated": {
                                                    "type": "string"
                                                  },
                                                  "firstActivityTimeUtc": {
                                                    "type": "string"
                                                  },
                                                  "incidentNumber": {
                                                    "type": "integer"
                                                  },
                                                  "incidentUrl": {
                                                    "type": "string"
                                                  },
                                                  "labels": {
                                                    "items": {
                                                      "properties": {
                                                        "labelName": {
                                                          "type": "string"
                                                        },
                                                        "labelType": {
                                                          "type": "string"
                                                        }
                                                      },
                                                      "required": [
                                                        "labelName",
                                                        "labelType"
                                                      ],
                                                      "type": "object"
                                                    },
                                                    "type": "array"
                                                  },
                                                  "lastActivityTimeGenerated": {
                                                    "type": "string"
                                                  },
                                                  "lastActivityTimeUtc": {
                                                    "type": "string"
                                                  },
                                                  "lastModifiedTimeUtc": {
                                                    "type": "string"
                                                  },
                                                  "owner": {
                                                    "properties": {
                                                      "assignedTo": {
                                                        "type": "string"
                                                      },
                                                      "email": {
                                                        "type": "string"
                                                      },
                                                      "objectId": {
                                                        "type": "string"
                                                      },
                                                      "userPrincipalName": {
                                                        "type": "string"
                                                      }
                                                    },
                                                    "type": "object"
                                                  },
                                                  "relatedAnalyticRuleIds": {
                                                    "items": {
                                                      "type": "string"
                                                    },
                                                    "type": "array"
                                                  },
                                                  "severity": {
                                                    "type": "string"
                                                  },
                                                  "status": {
                                                    "type": "string"
                                                  },
                                                  "title": {
                                                    "type": "string"
                                                  }
                                                },
                                                "type": "object"
                                              },
                                              "type": {
                                                "type": "string"
                                              }
                                            },
                                            "required": [
                                              "id",
                                              "name",
                                              "etag",
                                              "type",
                                              "properties"
                                            ],
                                            "type": "object"
                                          },
                                          "type": "array"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  }
                                },
                                "Set_variable_-_JsonResult": {
                                  "runAfter": {
                                    "Parse_JSON_-_HTTP": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "JsonResult",
                                    "value": "@body('Parse_JSON_-_HTTP')?['value']"
                                  }
                                }
                              },
                              "expression": {
                                "and": [
                                  {
                                    "lessOrEquals": [
                                      "@ticks(formatDateTime(items('For_each_Shifts_list')?['sharedShift']?['startDateTime']))",
                                      "@ticks(formatDateTime(utcNow()))"
                                    ]
                                  },
                                  {
                                    "greaterOrEquals": [
                                      "@ticks(formatDateTime(items('For_each_Shifts_list')?['sharedShift']?['endDateTime']))",
                                      "@ticks(formatDateTime(addHours(utcNow(),variables('ExpectedWorkHoursPerIncident'))))"
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            }
                          },
                          "runAfter": {
                            "List_all_shifts": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach",
                          "runtimeConfiguration": {
                            "concurrency": {
                              "repetitions": 1
                            }
                          }
                        },
                        "List_all_shifts": {
                          "type": "ApiConnection",
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['shifts']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/v1.0/teams/@{encodeURIComponent('')}/schedule/shifts",
                            "queries": {
                              "endTime": "@{addDays(utcNow(),1)}",
                              "startTime": "@{addDays(utcNow(),-1)}"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Initialize_variable_-_JsonResult": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "equals": [
                              "@triggerBody()?['object']?['properties']?['owner']?['assignedTo']",
                              "@null"
                            ]
                          },
                          {
                            "not": {
                              "equals": [
                                "@triggerBody()?['object']?['properties']?['status']",
                                "Closed"
                              ]
                            }
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Initialize_variable_-_ExpectedWorkHoursPerIncident": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "ExpectedWorkHoursPerIncident",
                            "type": "integer",
                            "value": 1
                          }
                        ]
                      }
                    },
                    "Initialize_variable_-_JsonResult": {
                      "runAfter": {
                        "Initialize_variable_-_User": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "JsonResult",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Initialize_variable_-_User": {
                      "runAfter": {
                        "Initialize_variable_-_ExpectedWorkHoursPerIncident": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "User",
                            "type": "array"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuremonitorlogs": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogs'))]",
                        "connectionName": "[[variables('AzureMonitorLogs')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuremonitorlogs')]"
                      },
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinel'))]",
                        "connectionName": "[[variables('AzureSentinel')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "office365": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('office365'))]",
                        "connectionName": "[[variables('office365')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                      },
                      "shifts": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Shifts'))]",
                        "connectionName": "[[variables('Shifts')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/shifts')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Incident Assignment Shifts",
            "description": "This playbook will assign an Incident to an owner based on the Shifts schedule in Microsoft Teams. When an incident is assigned, the incident owner will be notified via email. Incidents are assigned to users based on the following criteria:<br> *Only users who have started their shifts during the time the Logic App runs will be considered. *Users who still have at least 1 hours left before going off shift (can be configured in playbook) *User with the least incidents assigned on the current Shift will be assigned incident first. <br> Refer to [Automate Incident Assignment with Shifts for Teams](https://techcommunity.microsoft.com/t5/azure-sentinel/automate-incident-assignment-with-shifts-for-teams/ba-p/2297549) for more details.",
            "prerequisites": [
              "1. Have [Shifts](https://support.microsoft.com/office/get-started-in-shifts-5f3e30d8-1821-4904-be26-c3cd25a497d6) schedule setup in Microsoft Teams.",
              "2. Have user account with Owner role in Microsoft Teams",
              "3. Have user account or Service Principal or Managed Identity with Microsoft Sentinel Responder role for HTTP and Microsoft Sentinel connectors",
              "4. Have user account or Service Principal with Log Analytics Reader role on Microsoft Sentinel workspace for Azure Monitor Logs connector",
              "5. Have An O365 account to be used to send email notification"
            ],
            "postDeployment": [
              "**1. Enable Managed Identity and configure role assignment**",
              "- Once deployed, go to the Logic App's blade and click on **Identity** under Settings.",
              "- Select **On** under the **System assigned** tab. Click **Save** and select **Yes** when prompted.",
              "- Click on **Azure role assignments** to assign role to the Managed Identity.",
              "- Click on **+ Add role assignment**.",
              "- Select **Resource group** under Scope and select the **Subscription** and **Resource group** where the Microsoft Sentinel **Workspace** is located.",
              "- Select **Microsoft Sentinel Responder** under Role and click **Save**.",
              "**2. Configure connections**",
              "- Edit the Logic App or go to Logic app designer.",
              "- Expand each step to find the following connectors (6 in total)",
              "1. Incident Trigger\n2. Update Incident\n3. Add comment to incident\n4. List all shifts\n5. Run query and list results\n6. Send an email",
              "- Fix these connectors by adding a new connection to each connector and sign in with the accounts described under pre-requisites.",
              "**3. Select the Shifts schedule**",
              "- Edit the Logic App or go to Logic app designer.",
              "- Find the **List all shifts** connector, click on the **X** sign next to Team field for the drop-down list to appear.",
              "- Select the Teams channel with your Shifts schedule from the drop-down list.",
              "- Save the Logic App once you have completed the above steps."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "tags": [
              "Incident management"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Sentinel_Incident_Assignment_Shifts",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId1')]",
        "contentKind": "Playbook",
        "displayName": "Sentinel_Incident_Assignment_Shifts",
        "contentProductId": "[variables('_playbookcontentProductId1')]",
        "id": "[variables('_playbookcontentProductId1')]",
        "version": "[variables('playbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Notify-IncidentClosed Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Notify-IncidentClosed",
              "type": "string"
            },
            "Notification email": {
              "type": "string",
              "defaultValue": "Notification email",
              "metadata": {
                "description": "Enter value for Notification email"
              }
            },
            "Teams Channel ID": {
              "type": "string",
              "defaultValue": "Teams Channel ID",
              "metadata": {
                "description": "Enter value for Teams Channel ID"
              }
            },
            "Teams Team ID": {
              "type": "string",
              "defaultValue": "Teams Team ID",
              "metadata": {
                "description": "Enter value for Teams Team ID"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
            "Office365ConnectionName": "[[concat('Office365-', parameters('PlaybookName'))]",
            "TeamsConnectionName": "[[concat('Teams-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Office365')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]",
            "_connection-4": "[[variables('connection-4')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "Notification email": {
                      "defaultValue": "[[parameters('Notification email')]",
                      "type": "string"
                    },
                    "Teams Channel ID": {
                      "defaultValue": "[[parameters('Teams Channel ID')]",
                      "type": "string"
                    },
                    "Teams Team ID": {
                      "defaultValue": "[[parameters('Teams Team ID')]",
                      "type": "string"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Compose_-_Incident_URL": {
                      "type": "Compose",
                      "inputs": "<a href=\"@{triggerBody()?['object']?['properties']?['incidentUrl']}\">Click here to view incident</a>"
                    },
                    "Compose_-_Teams_adaptive_card_response": {
                      "runAfter": {
                        "Send_an_email_(V2)": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": {
                        "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                        "body": [
                          {
                            "color": "Good",
                            "size": "Large",
                            "text": "Microsoft Sentinel Incident Closed!",
                            "type": "TextBlock",
                            "weight": "Bolder",
                            "wrap": true
                          },
                          {
                            "text": "Incident details:",
                            "type": "TextBlock",
                            "wrap": true
                          },
                          {
                            "facts": [
                              {
                                "title": "Title",
                                "value": "@{triggerBody()?['object']?['properties']?['title']}"
                              },
                              {
                                "title": "Incident ID",
                                "value": "@{triggerBody()?['object']?['properties']?['incidentNumber']}"
                              },
                              {
                                "title": "Description",
                                "value": "@{triggerBody()?['object']?['properties']?['description']}"
                              },
                              {
                                "title": "Tactics",
                                "value": "@{join(triggerBody()?['object']?['properties']?['additionalData']?['tactics'], '<br />')}"
                              },
                              {
                                "title": "Alert providers",
                                "value": "@{join(triggerBody()?['object']?['properties']?['additionalData']?['alertProductNames'], '<br />')}"
                              },
                              {
                                "title": "Status",
                                "value": "@{triggerBody()?['object']?['properties']?['status']}"
                              },
                              {
                                "title": "Classification",
                                "value": "@{triggerBody()?['object']?['properties']?['classification']}"
                              },
                              {
                                "title": "Classification comment",
                                "value": "@{triggerBody()?['object']?['properties']?['classificationComment']}"
                              },
                              {
                                "title": "Classification reason",
                                "value": "@{triggerBody()?['object']?['properties']?['classificationReason']}"
                              },
                              {
                                "title": "Incident updated by",
                                "value": "@{triggerBody()?['incidentUpdates']?['updatedBy']?['name']}"
                              },
                              {
                                "title": "Incident URL",
                                "value": "[[Click here to view incident](@{triggerBody()?['object']?['properties']?['incidentUrl']})"
                              }
                            ],
                            "type": "FactSet"
                          }
                        ],
                        "type": "AdaptiveCard",
                        "version": "1.4"
                      }
                    },
                    "Post_adaptive_card_in_a_chat_or_channel": {
                      "runAfter": {
                        "Compose_-_Teams_adaptive_card_response": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "messageBody": "@{outputs('Compose_-_Teams_adaptive_card_response')}",
                          "recipient": {
                            "channelId": "@parameters('Teams Channel ID')",
                            "groupId": "@parameters('Teams Team ID')"
                          }
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['teams']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v1.0/teams/conversation/adaptivecard/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                      }
                    },
                    "Send_an_email_(V2)": {
                      "runAfter": {
                        "Compose_-_Incident_URL": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "Body": "<p><span style=\"font-size: 18px\"><strong>Incident details:</strong></span><br>\n<br>\n<strong>Title</strong>: @{triggerBody()?['object']?['properties']?['title']};<br>\n<strong>Incident ID</strong>: @{triggerBody()?['object']?['properties']?['incidentNumber']};<br>\n<strong>Description</strong>: @{triggerBody()?['object']?['properties']?['description']};<br>\n<strong>Tactics</strong>: @{join(triggerBody()?['object']?['properties']?['additionalData']?['tactics'], '<br />')};<br>\n<strong>Alert providers</strong>: @{join(triggerBody()?['object']?['properties']?['additionalData']?['alertProductNames'], '<br />')};<br>\n<strong>Status</strong>: @{triggerBody()?['object']?['properties']?['status']};<br>\n<strong>Classification</strong>: @{triggerBody()?['object']?['properties']?['classification']};<br>\n<strong>Classification comment</strong>: @{triggerBody()?['object']?['properties']?['classificationComment']};<br>\n<strong>Classification reason</strong>: @{triggerBody()?['object']?['properties']?['classificationReason']}<br>\n<strong>Incident updated by</strong>: @{triggerBody()?['incidentUpdates']?['updatedBy']?['name']};<br>\n<strong>Incident URL</strong>: @{outputs('Compose_-_Incident_URL')}</p>",
                          "Subject": "Microsoft Sentinel Incident Closed!",
                          "To": "@parameters('Notification email')"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['office365']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v2/Mail"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "microsoftsentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "office365": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                        "connectionName": "[[variables('Office365ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Office365')]"
                      },
                      "teams": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                        "connectionName": "[[variables('TeamsConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "Notify-IncidentClosed",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Office365ConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('Office365ConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('TeamsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('TeamsConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-4')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Notify When Incident Is Closed",
            "description": "This playbook is utilizing new update trigger to notify person/group on Microsoft Teams/Outlook when incident is closed.",
            "prerequisites": [
              "1. Email address to where notification will be sent to.",
              "2. (Optional) Microsoft Teams Team ID and Channel ID, or choose them in Logic Apps designer after the deployment. [Guidance to get Ids](Instructions to get IDs - https://www.linkedin.com/pulse/3-ways-locate-microsoft-team-id-christopher-barber-/)"
            ],
            "postDeployment": [
              "1. Authorize Microsoft Teams and Microsoft Office 365 Outlook connectors.",
              "2. Add playbook as an action to the automation rule: Trigger = When incident is updated;  Condition = Status Changed To Closed."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "tags": [
              "Notification",
              "Incident Update"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Notify When Incident Is Closed",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId2')]",
        "contentKind": "Playbook",
        "displayName": "Notify-IncidentClosed",
        "contentProductId": "[variables('_playbookcontentProductId2')]",
        "id": "[variables('_playbookcontentProductId2')]",
        "version": "[variables('playbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Notify-IncidentReopened Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Notify-IncidentReopened",
              "type": "string"
            },
            "Notification email": {
              "type": "string",
              "defaultValue": "Notification email",
              "metadata": {
                "description": "Enter value for Notification email"
              }
            },
            "Teams Channel ID": {
              "type": "string",
              "defaultValue": "Teams Channel ID",
              "metadata": {
                "description": "Enter value for Teams Channel ID"
              }
            },
            "Teams Team ID": {
              "type": "string",
              "defaultValue": "Teams Team ID",
              "metadata": {
                "description": "Enter value for Teams Team ID"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
            "Office365ConnectionName": "[[concat('Office365-', parameters('PlaybookName'))]",
            "TeamsConnectionName": "[[concat('Teams-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Office365')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]",
            "_connection-4": "[[variables('connection-4')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "Notification email": {
                      "defaultValue": "[[parameters('Notification email')]",
                      "type": "string"
                    },
                    "Teams Channel ID": {
                      "defaultValue": "[[parameters('Teams Channel ID')]",
                      "type": "string"
                    },
                    "Teams Team ID": {
                      "defaultValue": "[[parameters('Teams Team ID')]",
                      "type": "string"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Compose_-_Incident_URL": {
                      "type": "Compose",
                      "inputs": "<a href=\"@{triggerBody()?['object']?['properties']?['incidentUrl']}\">Click here to view incident</a>"
                    },
                    "Compose_-_Teams_adaptive_card_response": {
                      "runAfter": {
                        "Send_an_email_(V2)": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": {
                        "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                        "body": [
                          {
                            "color": "Attention",
                            "size": "Large",
                            "text": "Microsoft Sentinel Incident Reopened!",
                            "type": "TextBlock",
                            "weight": "Bolder",
                            "wrap": true
                          },
                          {
                            "text": "Incident details:",
                            "type": "TextBlock",
                            "wrap": true
                          },
                          {
                            "facts": [
                              {
                                "title": "Title",
                                "value": "@{triggerBody()?['object']?['properties']?['title']}"
                              },
                              {
                                "title": "Incident ID",
                                "value": "@{triggerBody()?['object']?['properties']?['incidentNumber']}"
                              },
                              {
                                "title": "Description",
                                "value": "@{triggerBody()?['object']?['properties']?['description']}"
                              },
                              {
                                "title": "Severity",
                                "value": "@{triggerBody()?['object']?['properties']?['severity']}"
                              },
                              {
                                "title": "Tactics",
                                "value": "@{join(triggerBody()?['object']?['properties']?['additionalData']?['tactics'], '<br />')}"
                              },
                              {
                                "title": "Alert providers",
                                "value": "@{join(triggerBody()?['object']?['properties']?['additionalData']?['alertProductNames'], '<br />')}"
                              },
                              {
                                "title": "New Status",
                                "value": "@{triggerBody()?['object']?['properties']?['status']}"
                              },
                              {
                                "title": "Incident updated by",
                                "value": "@{triggerBody()?['incidentUpdates']?['updatedBy']?['name']}"
                              },
                              {
                                "title": "Incident URL",
                                "value": "[[Click here to view incident](@{triggerBody()?['object']?['properties']?['incidentUrl']})"
                              }
                            ],
                            "type": "FactSet"
                          }
                        ],
                        "type": "AdaptiveCard",
                        "version": "1.4"
                      }
                    },
                    "Post_adaptive_card_in_a_chat_or_channel": {
                      "runAfter": {
                        "Compose_-_Teams_adaptive_card_response": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "messageBody": "@{outputs('Compose_-_Teams_adaptive_card_response')}",
                          "recipient": {
                            "channelId": "@parameters('Teams Channel ID')",
                            "groupId": "@parameters('Teams Team ID')"
                          }
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['teams']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v1.0/teams/conversation/adaptivecard/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                      }
                    },
                    "Send_an_email_(V2)": {
                      "runAfter": {
                        "Compose_-_Incident_URL": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "Body": "<p><span style=\"font-size: 18px\"><strong>Incident details:</strong></span><br>\n<br>\n<strong>Title</strong>: @{triggerBody()?['object']?['properties']?['title']};<br>\n<strong>Incident ID</strong>: @{triggerBody()?['object']?['properties']?['incidentNumber']};<br>\n<strong>Description</strong>: @{triggerBody()?['object']?['properties']?['description']};<br>\n<strong>Severity</strong>: @{triggerBody()?['object']?['properties']?['severity']};<br>\n<strong>Tactics</strong>: @{join(triggerBody()?['object']?['properties']?['additionalData']?['tactics'], '<br />')};<br>\n<strong>Alert providers</strong>: @{join(triggerBody()?['object']?['properties']?['additionalData']?['alertProductNames'], '<br />')};<br>\n<strong>New Status</strong>: @{triggerBody()?['object']?['properties']?['status']};<br>\n<strong>Incident updated by</strong>: @{triggerBody()?['incidentUpdates']?['updatedBy']?['name']};<br>\n<strong>Incident URL</strong>: @{outputs('Compose_-_Incident_URL')}</p>",
                          "Subject": "Microsoft Sentinel Incident Reopened!",
                          "To": "@parameters('Notification email')"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['office365']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v2/Mail"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "microsoftsentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "office365": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                        "connectionName": "[[variables('Office365ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Office365')]"
                      },
                      "teams": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                        "connectionName": "[[variables('TeamsConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "tags": {
                "hidden-SentinelTemplateName": "Notify-IncidentReopened",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Office365ConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('Office365ConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('TeamsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('TeamsConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-4')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Notify When Incident Is Reopened",
            "description": "This playbook is utilizing new update trigger to notify person/group on Microsoft Teams/Outlook when incident is reopened.",
            "prerequisites": [
              "1. Email address to where notification will be sent to.",
              "2. (Optional) Microsoft Teams Team ID and Channel ID, or choose them in Logic Apps designer after the deployment. [Guidance to get Ids](Instructions to get IDs - https://www.linkedin.com/pulse/3-ways-locate-microsoft-team-id-christopher-barber-/)"
            ],
            "postDeployment": [
              "1. Authorize Microsoft Teams and Microsoft Office 365 Outlook connectors.",
              "2. Add playbook as an action to the automation rule: Trigger = When incident is updated;  Condition = Staus Changed From Closed."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "tags": [
              "Notification",
              "Incident update"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Notify When Incident Is Reopened",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId3')]",
        "contentKind": "Playbook",
        "displayName": "Notify-IncidentReopened",
        "contentProductId": "[variables('_playbookcontentProductId3')]",
        "id": "[variables('_playbookcontentProductId3')]",
        "version": "[variables('playbookVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Notify-IncidentSeverityChanged Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Notify-IncidentSeverityChanged",
              "type": "string"
            },
            "Notification email": {
              "type": "string",
              "defaultValue": "Notification email",
              "metadata": {
                "description": "Enter value for Notification email"
              }
            },
            "Teams Channel ID": {
              "type": "string",
              "defaultValue": "Teams Channel ID",
              "metadata": {
                "description": "Enter value for Teams Channel ID"
              }
            },
            "Teams Team ID": {
              "type": "string",
              "defaultValue": "Teams Team ID",
              "metadata": {
                "description": "Enter value for Teams Team ID"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
            "Office365ConnectionName": "[[concat('Office365-', parameters('PlaybookName'))]",
            "TeamsConnectionName": "[[concat('Teams-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Office365')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]",
            "_connection-4": "[[variables('connection-4')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "Notification email": {
                      "defaultValue": "[[parameters('Notification email')]",
                      "type": "string"
                    },
                    "Teams Channel ID": {
                      "defaultValue": "[[parameters('Teams Channel ID')]",
                      "type": "string"
                    },
                    "Teams Team ID": {
                      "defaultValue": "[[parameters('Teams Team ID')]",
                      "type": "string"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Compose_-_Incident_URL": {
                      "type": "Compose",
                      "inputs": "<a href=\"@{triggerBody()?['object']?['properties']?['incidentUrl']}\">Click here to view incident</a>"
                    },
                    "Compose_-_Teams_adaptive_card_response": {
                      "runAfter": {
                        "Send_an_email_(V2)": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": {
                        "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                        "body": [
                          {
                            "color": "Warning",
                            "size": "Large",
                            "text": "Microsoft Sentinel Incident Severity Changed!",
                            "type": "TextBlock",
                            "weight": "Bolder",
                            "wrap": true
                          },
                          {
                            "text": "Incident details:",
                            "type": "TextBlock",
                            "wrap": true
                          },
                          {
                            "facts": [
                              {
                                "title": "Title",
                                "value": "@{triggerBody()?['object']?['properties']?['title']}"
                              },
                              {
                                "title": "Incident ID",
                                "value": "@{triggerBody()?['object']?['properties']?['incidentNumber']}"
                              },
                              {
                                "title": "Description",
                                "value": "@{triggerBody()?['object']?['properties']?['description']}"
                              },
                              {
                                "title": "Tactics",
                                "value": "@{join(triggerBody()?['object']?['properties']?['additionalData']?['tactics'], '<br />')}"
                              },
                              {
                                "title": "Alert providers",
                                "value": "@{join(triggerBody()?['object']?['properties']?['additionalData']?['alertProductNames'], '<br />')}"
                              },
                              {
                                "title": "New Severity",
                                "value": "@{triggerBody()?['object']?['properties']?['severity']}"
                              },
                              {
                                "title": "Incident updated by",
                                "value": "@{triggerBody()?['incidentUpdates']?['updatedBy']?['name']}"
                              },
                              {
                                "title": "Incident URL",
                                "value": "[[Click here to view incident](@{triggerBody()?['object']?['properties']?['incidentUrl']})"
                              }
                            ],
                            "type": "FactSet"
                          }
                        ],
                        "type": "AdaptiveCard",
                        "version": "1.4"
                      }
                    },
                    "Post_adaptive_card_in_a_chat_or_channel": {
                      "runAfter": {
                        "Compose_-_Teams_adaptive_card_response": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "messageBody": "@{outputs('Compose_-_Teams_adaptive_card_response')}",
                          "recipient": {
                            "channelId": "@parameters('Teams Channel ID')",
                            "groupId": "@parameters('Teams Team ID')"
                          }
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['teams']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v1.0/teams/conversation/adaptivecard/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                      }
                    },
                    "Send_an_email_(V2)": {
                      "runAfter": {
                        "Compose_-_Incident_URL": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "Body": "<p><span style=\"font-size: 18px\"><strong>Incident details:</strong></span><br>\n<br>\n<strong>Title</strong>: @{triggerBody()?['object']?['properties']?['title']};<br>\n<strong>Incident ID</strong>: @{triggerBody()?['object']?['properties']?['incidentNumber']};<br>\n<strong>Description</strong>: @{triggerBody()?['object']?['properties']?['description']};<br>\n<strong>Tactics</strong>: @{join(triggerBody()?['object']?['properties']?['additionalData']?['tactics'], '<br />')};<br>\n<strong>Alert providers</strong>: @{join(triggerBody()?['object']?['properties']?['additionalData']?['alertProductNames'], '<br />')};<br>\n<strong>New Severity</strong>: @{triggerBody()?['object']?['properties']?['severity']};<br>\n<strong>Incident updated by</strong>: @{triggerBody()?['incidentUpdates']?['updatedBy']?['name']};<br>\n<strong>Incident URL</strong>: @{outputs('Compose_-_Incident_URL')}</p>",
                          "Subject": "Microsoft Sentinel Incident Severity Changed!",
                          "To": "@parameters('Notification email')"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['office365']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v2/Mail"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "microsoftsentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "office365": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                        "connectionName": "[[variables('Office365ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Office365')]"
                      },
                      "teams": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                        "connectionName": "[[variables('TeamsConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "Notify-IncidentSeverityChanged",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Office365ConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('Office365ConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('TeamsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('TeamsConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-4')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Notify When Incident Severity Changed",
            "description": "This playbook is utilizing new update trigger to notify person/group on Microsoft Teams/Outlook when incident severity change.",
            "prerequisites": [
              "1. Email address to where notification will be sent to.",
              "2. (Optional) Microsoft Teams Team ID and Channel ID, or choose them in Logic Apps designer after the deployment. [Guidance to get Ids](Instructions to get IDs - https://www.linkedin.com/pulse/3-ways-locate-microsoft-team-id-christopher-barber-/)"
            ],
            "postDeployment": [
              "1. Authorize Microsoft Teams and Microsoft Office 365 Outlook connectors.",
              "2. Add playbook as an action to the automation rule: Trigger = When incident is updated;  Condition = Status Changed To Closed."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "tags": [
              "Notification",
              "Incident Update"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Notify-IncidentSeverityChanged",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId4')]",
        "contentKind": "Playbook",
        "displayName": "Notify-IncidentSeverityChanged",
        "contentProductId": "[variables('_playbookcontentProductId4')]",
        "id": "[variables('_playbookcontentProductId4')]",
        "version": "[variables('playbookVersion4')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "updatetrigger-notifyOwner Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion5')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "updatetrigger-notifyOwner",
              "type": "String",
              "metadata": {
                "description": "Name of the Logic Apps resource to be created"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
            "TeamsConnectionName": "[[concat('teams-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('TeamsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('TeamsConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "notifyOwnerTeams",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Post_message_in_a_chat_or_channel": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "messageBody": "<p><span style=\"font-size: 16px\"><strong>You have been assigned to a Microsoft Sentinel Incident </strong></span><span style=\"font-size: 16px\"><strong>@{triggerBody()?['object']?['properties']?['incidentNumber']}</strong></span><span style=\"font-size: 16px\"><strong>: </strong></span><span style=\"font-size: 16px\"><strong>@{triggerBody()?['object']?['properties']?['title']}</strong></span><span style=\"font-size: 16px\"><strong><br>\n</strong></span><br>\nClick here to view incident:<br>\n@{triggerBody()?['object']?['properties']?['incidentUrl']}<br>\n</p>",
                          "recipient": "@triggerBody()?['object']?['properties']?['owner']?['email']"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['teams']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/beta/teams/conversation/message/poster/Flow bot/location/@{encodeURIComponent('Chat with Flow bot')}"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "microsoftsentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "teams": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                        "connectionName": "[[variables('TeamsConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId5'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId5')]",
                "contentId": "[variables('_playbookContentId5')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Notify Incident Owner in Microsoft Teams",
            "description": "This playbook sends a Teams message to the new incident owner.",
            "prerequisites": [
              "Microsoft Teams account that allows to send messages"
            ],
            "postdeploymentsteps": [
              "1. Authorize Microsoft Teams connector in Logic Apps designer",
              "2. Attach this playbook to an automation rule with trigger: When an incident is updated, condition: Owner Changed."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "tags": [
              "Notification",
              "Update Trigger"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Notify Incident Owner in Microsoft Teams",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId5')]",
        "contentKind": "Playbook",
        "displayName": "updatetrigger-notifyOwner",
        "contentProductId": "[variables('_playbookcontentProductId5')]",
        "id": "[variables('_playbookcontentProductId5')]",
        "version": "[variables('playbookVersion5')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PostMessageSlack-OnAlert Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion6')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "PostMessageSlack-OnAlert",
              "type": "string",
              "metadata": {
                "description": "Name of the Logic Apps resource to be created"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "SlackConnectionName": "[[concat('Slack-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/slack')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('SlackConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "PostMessageSlack_alert",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('SlackConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_alert": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Alert_-_Get_incident": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      }
                    },
                    "Post_message": {
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['slack']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/chat.postMessage",
                        "queries": {
                          "channel": "[variables('blanks')]",
                          "text": "New Incident: @{body('Alert_-_Get_incident')?['properties']?['title']}\nDescription: @{body('Alert_-_Get_incident')?['properties']?['description']}\nIncident Severity: @{body('Alert_-_Get_incident')?['properties']?['severity']}\nSubscription: @{triggerBody()?['WorkspaceSubscriptionId']}\nIncident Entites: @{triggerBody()?['Entities']}\n\nPlease Investigate.\n\n"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "slack": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('SlackConnectionName'))]",
                        "connectionName": "[[variables('SlackConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/slack')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId6'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId6')]",
                "contentId": "[variables('_playbookContentId6')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Post Message Slack",
            "description": "This playbook will post a message in a Slack channel when an alert is created in Microsoft Sentinel",
            "prerequisites": "Slack connector will require a Slack account and user credentials",
            "postDeployment": [
              "After deployment, you can run this playbook manually on an alert or attach it to an **analytics rule** so it will rune when an alert is created."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "tags": [
              "Notification"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "PostMessageSlack-OnAlert",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId6')]",
        "contentKind": "Playbook",
        "displayName": "PostMessageSlack-OnAlert",
        "contentProductId": "[variables('_playbookcontentProductId6')]",
        "id": "[variables('_playbookcontentProductId6')]",
        "version": "[variables('playbookVersion6')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName7')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PostMessageTeams-OnAlert Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion7')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "PostMessageTeams-OnAlert",
              "type": "string",
              "metadata": {
                "description": "Name of the Logic Apps resource to be created"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "TeamsConnectionName": "[[concat('teams-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('TeamsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('TeamsConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "PostMessageTeams",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_alert": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Alert_-_Get_incident": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      }
                    },
                    "Post_a_message_(V3)": {
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "body": {
                            "content": "<p>Severity@{body('Alert_-_Get_incident')?['properties']?['severity']}:<br>\n<br>\nMicrosoft Sentinel Alert;<br>\nTItle:@{body('Alert_-_Get_incident')?['properties']?['title']}<br>\nStatus:@{body('Alert_-_Get_incident')?['properties']?['status']}<br>\nNumber:@{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}<br>\nCreated Time (UTC):@{body('Alert_-_Get_incident')?['properties']?['createdTimeUtc']}<br>\nUrl:@{body('Alert_-_Get_incident')?['properties']?['incidentUrl']}<br>\nEntities:@{triggerBody()?['Entities']}</p>",
                            "contentType": "html"
                          }
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['teams']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v3/beta/teams/@{encodeURIComponent('d05ba55c-593e-4bfa-8011-26e0626b5c14')}/channels/@{encodeURIComponent('19:8e52aee721394ab78563596463c067dc@thread.skype')}/messages"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "teams": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                        "connectionName": "[[variables('TeamsConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId7'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId7')]",
                "contentId": "[variables('_playbookContentId7')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion7')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Post Message Teams",
            "description": "This playbook will post a message in a Microsoft Teams channel when an Alert is created in Microsoft Sentinel.",
            "prerequisites": [
              "MS teams Account that allow to post messages"
            ],
            "lastUpdateTime": "2022-08-04T00:00:00Z",
            "tags": [
              "Notification"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Post Message Teams - Alert Trigger",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId7')]",
        "contentKind": "Playbook",
        "displayName": "PostMessageTeams-OnAlert",
        "contentProductId": "[variables('_playbookcontentProductId7')]",
        "id": "[variables('_playbookcontentProductId7')]",
        "version": "[variables('playbookVersion7')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName8')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PostMessageTeams Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion8')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "PostMessageTeams",
              "type": "string",
              "metadata": {
                "description": "Incident trigger"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "TeamsConnectionName": "[[concat('teams-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('TeamsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('TeamsConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "PostMessageTeams",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Post_a_message_(V3)": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "body": {
                            "content": "<p>Severity: @{triggerBody()?['object']?['properties']?['severity']}<br>\nTItle: @{triggerBody()?['object']?['properties']?['title']}<br>\nStatus: @{triggerBody()?['object']?['properties']?['status']}<br>\nID: @{triggerBody()?['object']?['properties']?['incidentNumber']}<br>\nURL:@{triggerBody()?['object']?['properties']?['incidentUrl']}<br>\n</p>",
                            "contentType": "html"
                          }
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['teams']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v3/beta/teams/@{encodeURIComponent('d05ba55c-593e-4bfa-8011-26e0626b5c14')}/channels/@{encodeURIComponent('19:8e52aee721394ab78563596463c067dc@thread.skype')}/messages"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "teams": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                        "connectionName": "[[variables('TeamsConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId8'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId8')]",
                "contentId": "[variables('_playbookContentId8')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion8')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Post Message Teams",
            "description": "This playbook will post a message in a Microsoft Teams channel when an Incident is created in Microsoft Sentinel.",
            "prerequisites": [
              "MS teams Account that allow to post messages"
            ],
            "postDeployment": [
              "After deployment, attach this playbook to an **automation rule** so it runs when the incident is created."
            ],
            "lastUpdateTime": "2021-07-14T00:00:00Z",
            "tags": [
              "Notification"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "PostMessageTeams-Incident",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId8')]",
        "contentKind": "Playbook",
        "displayName": "PostMessageTeams",
        "contentProductId": "[variables('_playbookcontentProductId8')]",
        "id": "[variables('_playbookcontentProductId8')]",
        "version": "[variables('playbookVersion8')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName9')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PostMessageSlack Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion9')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "PostMessageSlack",
              "type": "string",
              "metadata": {
                "description": "Name of the Logic Apps resource to be created"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "SlackConnectionName": "[[concat('Slack-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/slack')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('SlackConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "PostMessageSlack",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('SlackConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Post_message": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['slack']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/chat.postMessage",
                        "queries": {
                          "channel": "[variables('blanks')]",
                          "text": "New Incident: @{triggerBody()?['object']?['properties']?['title']}\nDescription: @{triggerBody()?['object']?['properties']?['description']}\nIncident Severity: @{triggerBody()?['object']?['properties']?['severity']}\nSubscription: @{triggerBody()?['workspaceInfo']?['SubscriptionId']}\nIncident Entites: @{triggerBody()?['object']?['properties']?['relatedEntities']}\n\nPlease Investigate.\n\n"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "slack": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('SlackConnectionName'))]",
                        "connectionName": "[[variables('SlackConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/slack')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId9'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId9')]",
                "contentId": "[variables('_playbookContentId9')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion9')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Post Message Slack",
            "description": "This playbook will post a message in a Slack channel when an Incident is created in Microsoft Sentinel",
            "prerequisites": "Slack connector will require a Slack account and user credentials",
            "postDeployment": [
              "After deployment, attach this playbook to an **automation rule** so it runs when the incident is created."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "tags": [
              "Notification"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "PostMessageSlack-incident",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId9')]",
        "contentKind": "Playbook",
        "displayName": "PostMessageSlack",
        "contentProductId": "[variables('_playbookcontentProductId9')]",
        "id": "[variables('_playbookcontentProductId9')]",
        "version": "[variables('playbookVersion9')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName10')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "relateAlertsToIncident-basedOnIP Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion10')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "relateAlertsToIncident-basedOnIP",
              "type": "string",
              "metadata": {
                "description": "Name of the playbook (Logic Apps resource) which will be created"
              }
            },
            "WorkspaceName": {
              "defaultValue": "WorkspaceName",
              "type": "String",
              "metadata": {
                "description": "Name of the worksapce where related alerts are found"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "[[concat('microsoftsentinel-', parameters('PlaybookName'))]",
            "azuremonitorlogsConnectionName": "[[concat('azuremonitorlogs-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuremonitorlogs')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('azuremonitorlogsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('azuremonitorlogsConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "relateAlertsToIncident-basedOnIP",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('azuremonitorlogsConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Add_comment_to_incident": {
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "message": "<p>Alerts \"@{string(variables('addedAlerts'))}\" were added by a playbook based on same the IP @{variables('firstIPAddress')}.</p>"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/Incidents/Comment"
                      },
                      "runAfter": {
                        "For_each_alert_found_in_the_query": [
                          "Succeeded",
                          "Failed"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_alert_found_in_the_query": {
                      "actions": {
                        "Add_alert_to_incident": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "relatedResourceId": "@{items('For_each_alert_found_in_the_query')}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Relation/Create"
                          },
                          "runAfter": {
                            "Alert_-_Get_incident": [
                              "Failed"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Alert_-_Get_incident": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['workspaceInfo']?['SubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['workspaceInfo']?['ResourceGroupName'])}/workspaces/@{encodeURIComponent(triggerBody()?['workspaceId'])}/alerts/@{encodeURIComponent(items('For_each_alert_found_in_the_query'))}"
                          },
                          "type": "ApiConnection"
                        },
                        "Append_the_Id_of_the_added_alert_into_\"addedAlerts\"_variable": {
                          "inputs": {
                            "name": "addedAlerts",
                            "value": "@items('For_each_alert_found_in_the_query')"
                          },
                          "runAfter": {
                            "Add_alert_to_incident": [
                              "Succeeded"
                            ]
                          },
                          "type": "AppendToArrayVariable"
                        }
                      },
                      "foreach": "@json(body('Run_query_and_list_results')?['value'][0]['list_SystemAlertId'])",
                      "runAfter": {
                        "Wait_for_3_minutes": [
                          "Succeeded"
                        ]
                      },
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      },
                      "type": "Foreach"
                    },
                    "Initialize_a_string_variable_with_the_first_IP_entity": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "firstIPAddress",
                            "type": "string",
                            "value": "@{first(body('Entities_-_Get_IPs')?['IPs'])?['Address']}"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_an_array_variable_for_logging_added_alerts": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "addedAlerts",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_a_string_variable_with_the_first_IP_entity": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Run_query_and_list_results": {
                      "inputs": {
                        "body": "let excludedAlerts=toscalar ( SecurityIncident |\nwhere IncidentName ==\"@{triggerBody()?['object']?['name']}\" | summarize make_set(AlertIds));\nSecurityAlert\n| where SystemAlertId !in (excludedAlerts)\n| mv-expand entitiesJson = todynamic(Entities)\n| where entitiesJson.Type == \"ip\" and entitiesJson.Address == \"@{variables('firstIPAddress')}\"\n| summarize time_gen = max(TimeGenerated) by SystemAlertId\n| sort by time_gen desc\n| summarize make_list(SystemAlertId, maxSize=149)",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/queryData",
                        "queries": {
                          "resourcegroups": "@triggerBody()?['workspaceInfo']?['ResourceGroupName']",
                          "resourcename": "@parameters('workspaceName')",
                          "resourcetype": "Log Analytics Workspace",
                          "subscriptions": "@triggerBody()?['workspaceInfo']?['SubscriptionId']",
                          "timerange": "Last 7 days"
                        }
                      },
                      "runAfter": {
                        "Initialize_an_array_variable_for_logging_added_alerts": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Wait_for_3_minutes": {
                      "inputs": {
                        "interval": {
                          "count": 3,
                          "unit": "Minute"
                        }
                      },
                      "runAfter": {
                        "Run_query_and_list_results": [
                          "Succeeded"
                        ]
                      },
                      "type": "Wait"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "workspaceName": {
                      "defaultValue": "[[parameters('WorkspaceName')]",
                      "type": "String"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuremonitorlogs": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('azuremonitorlogsConnectionName'))]",
                        "connectionName": "[[variables('azuremonitorlogsConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuremonitorlogs')]"
                      },
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId10'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId10')]",
                "contentId": "[variables('_playbookContentId10')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion10')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Relate alerts to incident by IP",
            "description": "This playbook looks for other alerts with the same IP as the triggered incident. When such an alert is found, this playbook will add the alert to the incident (only if it isn't related to another incident).",
            "mainSteps": [
              "When a new incident is created:",
              "1. Get the first IP entity of the incident",
              "2. Make a list of alerts with the IP fetched in the previous step. Please note we exclude all the alerts with the same IP already related to the triggered incident.",
              "3. For each alert in the list:",
              "3.1 Get the incident of the alert",
              "3.2 If the last step fails (meaning the current alert is not related to another incident): add this alert to the incident.",
              "4. Add a comment to the incident specifying all the alerts added to it by listing their \"SystemAlertId\" field."
            ],
            "lastUpdateTime": "2022-03-20T00:00:00Z",
            "entities": [
              "Ip"
            ],
            "tags": [
              "grouping"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Relate alerts to incident by IP",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId10')]",
        "contentKind": "Playbook",
        "displayName": "relateAlertsToIncident-basedOnIP",
        "contentProductId": "[variables('_playbookcontentProductId10')]",
        "id": "[variables('_playbookcontentProductId10')]",
        "version": "[variables('playbookVersion10')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName11')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Send-basic-email Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion11')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Send-basic-email",
              "type": "String"
            },
            "NotificationEmail": {
              "type": "String",
              "metadata": {
                "description": "Incident details will be sent to this email (ex. soc@xyz.com)"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "o365ConnectionName": "[[concat('o365-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('PlaybookName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('o365ConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('PlaybookName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "Send-basic-email",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('o365ConnectionName'))]"
              ],
              "properties": {
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Compose_Incident_link": {
                      "runAfter": {
                        "Create_HTML_table_with_Entities": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "<a href=\"@{triggerBody()?['object']?['properties']?['incidentUrl']}\">@{triggerBody()?['object']?['properties']?['incidentUrl']}</a>"
                    },
                    "Create_HTML_table_with_Entities": {
                      "runAfter": {
                        "Select_Entities": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@body('Select_Entities')"
                      }
                    },
                    "Select_Entities": {
                      "type": "Select",
                      "inputs": {
                        "from": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "select": {
                          "Entity": "@item()?['properties']?['friendlyName']",
                          "Entity Type": "@item()?['kind']"
                        }
                      }
                    },
                    "Send_an_email_with_Incident_details": {
                      "runAfter": {
                        "Compose_Incident_link": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "Body": "<p><span style=\"font-size: 16px\"><strong>New incident created in Azure Sentinel. Incident details:</strong></span><br>\n<br>\n<span style=\"font-size: 14px\"><strong>Incident title:<br>\n</strong></span>@{triggerBody()?['object']?['properties']?['title']}<br>\n<br>\n<span style=\"font-size: 14px\"><strong>Incident ID:<br>\n</strong></span>@{triggerBody()?['object']?['properties']?['incidentNumber']}<br>\n<br>\n<span style=\"font-size: 14px\"><strong>Creation time:<br>\n</strong></span>@{triggerBody()?['object']?['properties']?['createdTimeUtc']}<br>\n<br>\n<span style=\"font-size: 14px\"><strong>Severity:<br>\n</strong></span>@{triggerBody()?['object']?['properties']?['severity']}<br>\n<br>\n<span style=\"font-size: 14px\"><strong>Alert providers:<br>\n</strong></span>@{join(triggerBody()?['object']?['properties']?['additionalData']?['alertProductNames'], '<br />')}<br>\n<br>\n<span style=\"font-size: 14px\"><strong>Tactics:<br>\n</strong></span>@{join(triggerBody()?['object']?['properties']?['additionalData']?['tactics'], '<br />')}<br>\n<br>\n<span style=\"font-size: 14px\"><strong>Description:<br>\n</strong></span>@{triggerBody()?['object']?['properties']?['description']}<br>\n<br>\n<span style=\"font-size: 14px\"><strong>Entities:<br>\n</strong></span><span style=\"font-size: 12px\"></span><span style=\"font-size: 12px\">@{body('Create_HTML_table_with_Entities')}</span><span style=\"font-size: 12px\"></span><br>\n<br>\n<span style=\"font-size: 14px\"><strong>Incident link:<br>\n</strong></span>@{outputs('Compose_Incident_link')}<br>\n</p>",
                          "Importance": "High",
                          "Subject": "New Azure Sentinel Incident - @{triggerBody()?['object']?['properties']?['title']}",
                          "To": "[[parameters('NotificationEmail')]"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['office365']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v2/Mail"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "office365": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('o365ConnectionName'))]",
                        "connectionName": "[[variables('o365ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId11'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId11')]",
                "contentId": "[variables('_playbookContentId11')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion11')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Send basic email",
            "description": "This playbook will be sending email with basic incidents details (Incident title, severity, tactics, link,) when incident is created in Microsoft Sentinel.",
            "prerequisites": " An O365 account to be used to send email notification (The user account will be used in O365 connector: Send an email step.)",
            "postDeployment": [
              "**1. Configure connections**",
              "Edit the Logic App or go to Logic app designer.",
              "Expand Send an email with Incident details and fix this connector by adding a new connection or signing-in to marked one with user that has mailbox.",
              "Note:  Email sent with this playbook will be from user that creates connection!",
              "**2. Attach the playbook**",
              "Attach the playbook",
              "[Learn more about automation rules](https://docs.microsoft.com/azure/sentinel/automate-incident-handling-with-automation-rules#creating-and-managing-automation-rules)",
              "Note: Playbook is disabled by default. Please enable it before assigning to the Automation rule!"
            ],
            "lastUpdateTime": "2021-07-14T00:00:00Z",
            "tags": [
              "Notification"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Send basic email",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId11')]",
        "contentKind": "Playbook",
        "displayName": "Send-basic-email",
        "contentProductId": "[variables('_playbookcontentProductId11')]",
        "id": "[variables('_playbookcontentProductId11')]",
        "version": "[variables('playbookVersion11')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName12')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Send-email-with-formatted-incident-report Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion12')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Send-email-with-formatted-incident-report",
              "type": "string"
            },
            "NotificationEmail": {
              "type": "string",
              "metadata": {
                "description": "Incident details will be sent to this email (ex. soc@xyz.com)"
              }
            },
            "Company logo link": {
              "defaultValue": "https://azure.microsoft.com/svghandler/azure-sentinel",
              "type": "string",
              "metadata": {
                "description": "Company logo that will be visible in the incident report (size defined in template) (ex. https://azure.microsoft.com/svghandler/azure-sentinel)"
              }
            },
            "Company name": {
              "defaultValue": "Contoso SOC",
              "type": "string",
              "metadata": {
                "description": "Company name that will be visible in the report, you can also add SOC (ex. Contoso SOC)"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "o365ConnectionName": "[[concat('o365-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('PlaybookName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('o365ConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('PlaybookName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "Send-email-with-formatted-incident-report",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('o365ConnectionName'))]"
              ],
              "properties": {
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "Company logo link": {
                      "defaultValue": "[[parameters('Company logo link')]",
                      "type": "String"
                    },
                    "Report name": {
                      "defaultValue": "[[parameters('Company name')]",
                      "type": "String"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Compose_Email_response": {
                      "runAfter": {
                        "Create_HTML_table_with_Alerts": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "<!DOCTYPE html>\n<html>\n\n<table style=\"width: 100%; border-collapse: collapse;\" border=\"1\" width=\"100%\">\n\n<tbody>\n\n<tr>\n<td style=\"width: 19%;\" align=\"center\" width=\"19%\">\n<strong><img src=\"https://azure.microsoft.com/svghandler/azure-sentinel?width=150&amp;height=79\" alt=\"\" /></strong>\n</td>\n\n<td style=\"width: 41.1434%;\" width=\"48%\">\n<p style=\"text-align: center;\"><span style=\"font-size: 16pt;\"><strong>@{parameters('Report name')}</strong></span></p>\n<p style=\"text-align: center;\"><strong>Azure Sentinel incident report</strong></p>\n</td>\n\n<td style=\"width: 20%;\" width=\"20%\">\n<p><span style=\"font-size: 12pt;\"><strong>Incident ID: @{triggerBody()?['object']?['properties']?['incidentNumber']}</strong></span></p>\n<p><span style=\"font-size: 13pt;\"><strong><a href=\"@{triggerBody()?['object']?['properties']?['incidentUrl']}\">View incident</a></strong></span></p>\n</td>\n\n<td style=\"width: 13%;\" align=\"center\" width=\"13%\">\n<strong><img src=\"@{parameters('Company logo link')}?width=150&amp;height=79\" alt=\"\" /></strong>\n</td>\n\n</tr>\n\n<tr>\n<td style=\"width: 93.1434%;\" colspan=\"4\" width=\"100%\">\n<p>Incident title:</p>\n<p><span style=\"font-size: 16pt;\"><strong>@{triggerBody()?['object']?['properties']?['title']}</strong></span></p>\n<p>&nbsp;</p>\n</td>\n</tr>\n\n</tbody>\n</table>\n\n<table style=\"width: 100%; border-collapse: collapse;\" border=\"1\" width=\"100%\">\n\n<tbody>\n\n<tr style=\"vertical-align: top;\">\n<td style=\"width: 23.25%; height: 190px;\">\n<p><span style=\"font-size: 12pt;\"><strong>Creation time</strong></span><br /><br/>\n<span style=\"font-size: 12.0pt;\">@{triggerBody()?['object']?['properties']?['createdTimeUtc']}</span></p>\n</td>\n\n<td style=\"width: 23.25%; height: 190px;\">\n<p><span style=\"font-size: 12pt;\"><strong>Severity</strong></span><br /><br/>\n<span style=\"font-size: 12.0pt;\">@{triggerBody()?['object']?['properties']?['severity']}</span></p>\n</td>\n\n<td style=\"width: 23.3934%; height: 190px;\">\n<p><span style=\"font-size: 12pt;\"><strong>Alert providers</strong></span><br /><br/>\n<span style=\"font-size: 12.0pt;\">@{join(triggerBody()?['object']?['properties']?['additionalData']?['alertProductNames'], '<br />')}</span></p>\n</td>\n\n<td style=\"width: 23.25%; height: 190px;\">\n<p><span style=\"font-size: 12pt;\"><strong>Tactics</strong></span><br /><br/>\n<span style=\"font-size: 12.0pt;\">@{join(triggerBody()?['object']?['properties']?['additionalData']?['tactics'], '<br />')}</span></p>\n</td>\n</tr>\n\n<td style=\"width: 93.1434%;\" colspan=\"4\" width=\"100%\">\n<p><span style=\"font-size: 12pt;\"><strong>Description</strong></span><br /><br />\n<span style=\"font-size: 12.0pt;\">@{triggerBody()?['object']?['properties']?['description']}</span></p>\n</td>\n</tr>\n\n<tr>\n<td style=\"width: 46.5%;\" colspan=\"2\" width=\"50%\">\n<p><span style=\"font-size: 12pt;\"><strong>Entities</strong></span></p>\n<p>@{body('Create_HTML_table_with_Entities')}</p>\n<p>&nbsp;</p>\n</td>\n\n<td style=\"width: 46.6434%;\" colspan=\"2\" width=\"50%\">\n@{body('Create_HTML_table_with_Alerts')}\n</td>\n\n</tr>\n\n</tbody>\n</table>\n</html>"
                    },
                    "Create_HTML_table_with_Alerts": {
                      "runAfter": {
                        "Select_Alerts": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@body('Select_Alerts')"
                      }
                    },
                    "Create_HTML_table_with_Entities": {
                      "runAfter": {
                        "Select_Entities": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@body('Select_Entities')"
                      }
                    },
                    "Select_Alerts": {
                      "runAfter": {
                        "Create_HTML_table_with_Entities": [
                          "Succeeded"
                        ]
                      },
                      "type": "Select",
                      "inputs": {
                        "from": "@triggerBody()?['object']?['properties']?['Alerts']",
                        "select": {
                          "Alerts": "@item()?['properties']?['alertDisplayName']"
                        }
                      }
                    },
                    "Select_Entities": {
                      "type": "Select",
                      "inputs": {
                        "from": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "select": {
                          "Entity": "@item()?['properties']?['friendlyName']",
                          "Entity type": "@item()?['kind']"
                        }
                      }
                    },
                    "Send_an_email_with_Incident_details": {
                      "runAfter": {
                        "Compose_Email_response": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "Body": "<p>@{outputs('Compose_Email_response')}</p>",
                          "Importance": "High",
                          "Subject": "New Azure Sentinel incident - @{triggerBody()?['object']?['properties']?['title']}",
                          "To": "[[parameters('NotificationEmail')]"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['office365']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v2/Mail"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "office365": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('o365ConnectionName'))]",
                        "connectionName": "[[variables('o365ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId12'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId12')]",
                "contentId": "[variables('_playbookContentId12')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion12')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Send email with formatted incident report",
            "description": "This playbook will be sending email with formated incidents report (Incident title, severity, tactics, link,) when incident is created in Microsoft Sentinel. Email notification is made in HTML.",
            "prerequisites": "An O365 account to be used to send email notification (The user account will be used in O365 connector (Send an email).) Link with company logo. No formating since size is defined in the Playbook. Linke example - https://azure.microsoft.com/svghandler/azure-sentinel",
            "postDeployment": [
              "**1.Configure connections**\nEdit the Logic App or go to Logic app designer.\nExpand Send an email with Incident details and fix this connector by adding a new connection or signing-in to marked one with user that has mailbox.\nNote:  Email sent with this playbook will be from user that creates connection!\n**Attach the playbook**\nAttach the playbook\n[Learn more about automation rules](https://docs.microsoft.com/azure/sentinel/automate-incident-handling-with-automation-rules#creating-and-managing-automation-rules)\nNote: Playbook is disabled by default. Please enable it before assigning to the Automation rule!"
            ],
            "lastUpdateTime": "2021-07-14T00:00:00Z",
            "tags": [
              "Notification"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Send email with formatted incident report",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId12')]",
        "contentKind": "Playbook",
        "displayName": "Send-email-with-formatted-incident-report",
        "contentProductId": "[variables('_playbookcontentProductId12')]",
        "id": "[variables('_playbookcontentProductId12')]",
        "version": "[variables('playbookVersion12')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName13')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CreateIncident-MicrosoftForm Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion13')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "CreateIncident-MicrosoftForm",
              "type": "string"
            },
            "Microsoft Forms ID": {
              "type": "string",
              "metadata": {
                "description": "Enter value for Microsoft Forms ID"
              }
            },
            "Subscription": {
              "type": "string",
              "metadata": {
                "description": "Enter value for Subscription"
              }
            },
            "Resource Group": {
              "type": "string",
              "metadata": {
                "description": "Enter value for Resource Group"
              }
            },
            "Workspace Name": {
              "type": "string",
              "metadata": {
                "description": "Enter value for Workspace Name"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
            "MicrosoftformsConnectionName": "[[concat('Microsoftforms-', parameters('PlaybookName'))]",
            "Office365ConnectionName": "[[concat('Office365-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Microsoftforms')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Office365')]",
            "_connection-4": "[[variables('connection-4')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "Microsoft Forms ID": {
                      "type": "string",
                      "defaultValue": "[[parameters('Microsoft Forms ID')]"
                    },
                    "Resource Group": {
                      "type": "string",
                      "defaultValue": "[[parameters('Resource Group')]"
                    },
                    "Subscription": {
                      "type": "string",
                      "defaultValue": "[[parameters('Subscription')]"
                    },
                    "Workspace Name": {
                      "type": "string",
                      "defaultValue": "[[parameters('Workspace Name')]"
                    }
                  },
                  "triggers": {
                    "When_a_new_response_is_submitted": {
                      "splitOn": "@triggerBody()?['value']",
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "eventType": "responseAdded",
                          "notificationUrl": "@{listCallbackUrl()}",
                          "source": "ms-connector"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['microsoftforms']['connectionId']"
                          }
                        },
                        "path": "/formapi/api/forms/@{encodeURIComponent(parameters('Microsoft Forms ID'))}/webhooks"
                      }
                    }
                  },
                  "actions": {
                    "Condition": {
                      "actions": {
                        "Send_an_email_(V2)_-_success": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Body": "<p>New Microsoft Sentinel incident created succesfully using Microsoft Forms!</p>",
                              "Importance": "Normal",
                              "Subject": "New Microsoft Sentinel Incident created sucesfully!",
                              "To": "@body('Get_response_details')?['responder']"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['office365']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/v2/Mail"
                          }
                        }
                      },
                      "runAfter": {
                        "Create_incident": [
                          "Succeeded",
                          "Failed"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Send_an_email_(V2)_-_fail": {
                            "type": "ApiConnection",
                            "inputs": {
                              "body": {
                                "Body": "<p>There was an error while creating a new incident in Microsoft Sentinel using Microsoft Forms.<br>\n<br>\nError details:<br>\n@{body('Create_incident')?['Content']}</p>",
                                "Importance": "Normal",
                                "Subject": "There was an error creating a new incident in Microsoft Sentinel using Microsoft Forms!",
                                "To": "@body('Get_response_details')?['responder']"
                              },
                              "host": {
                                "connection": {
                                  "name": "@parameters('$connections')['office365']['connectionId']"
                                }
                              },
                              "method": "post",
                              "path": "/v2/Mail"
                            }
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "equals": [
                              "@outputs('Create_incident')?['statusCode']",
                              200
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_incident": {
                      "runAfter": {
                        "Get_response_details": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "description": "@body('Get_response_details')?['rf4b64f85b2f149caaca0024a4de6d0ba']",
                          "owner": "@body('Get_response_details')?['rf8ccf431083243f29c380f45a7320a40']",
                          "ownerAction": "@body('Get_response_details')?['r9a38c62424304e16b6f308a59ee28a81']",
                          "severity": "@body('Get_response_details')?['ra6fc61cb93e34e738e0ce60d6dfe61a3']",
                          "status": "@body('Get_response_details')?['reca7bceea54b452eba0fcdc4b54d8b6c']",
                          "tagsToAdd": {
                            "TagsToAdd": [
                              {
                                "Tag": "@body('Get_response_details')?['ra94ba346e3f640e4b68fbab12b518bc8']"
                              }
                            ]
                          },
                          "title": "@body('Get_response_details')?['rd9397c4be5e94bdf882fe71a2263fc96']"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "put",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(parameters('Subscription'))}/resourceGroups/@{encodeURIComponent(parameters('Resource Group'))}/workspaces/@{encodeURIComponent(parameters('Workspace Name'))}"
                      }
                    },
                    "Get_response_details": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['microsoftforms']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/formapi/api/forms('@{encodeURIComponent(parameters('Microsoft Forms ID'))}')/responses",
                        "queries": {
                          "response_id": "@triggerBody()?['resourceData']?['responseId']"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "microsoftforms": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftformsConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftformsConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Microsoftforms')]"
                      },
                      "office365": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                        "connectionName": "[[variables('Office365ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Office365')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "tags": {
                "hidden-SentinelTemplateName": "CreateIncident-MicrosoftForms",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftformsConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftformsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftformsConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Office365ConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('Office365ConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-4')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId13'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId13')]",
                "contentId": "[variables('_playbookContentId13')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion13')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Create Incident From Microsoft Forms Response",
            "description": "This playbook will create a new Microsoft Sentinel incident when Microsoft Forms response is submitted. ",
            "prerequisites": [
              "1. Create Microsoft Forms from [template](https://forms.office.com/Pages/ShareFormPage.aspx?id=b6PlTP9aoEiHWDhi2Ji_bQ9ohJdYaDxFpei_Nyf2P35UQVBRWk83OUhCUjUyU0pUWkdIV1FMNjFCVC4u&sharetoken=7MfhwUMCnEB9pBTvSX7w).",
              "2. Save Microsoft Forms ID as it will be needed to deploy the playbook.",
              "3. Prepare Subscription ID, Resource Group name, and Log Analytics Workspace name as it is needed for template deployment."
            ],
            "postDeployment": [
              "1. Add Microsoft Sentinel Responder role to the playbook's managed identity.",
              "2. Authorize Microsoft Forms, Office 365 Outlook connector, and Conversion Service connector (HTML to text)."
            ],
            "lastUpdateTime": "2022-09-04T00:00:00Z",
            "tags": [
              "Utilities"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId13')]",
        "contentKind": "Playbook",
        "displayName": "CreateIncident-MicrosoftForm",
        "contentProductId": "[variables('_playbookcontentProductId13')]",
        "id": "[variables('_playbookcontentProductId13')]",
        "version": "[variables('playbookVersion13')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName14')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CreateIncident-SharedMailbox Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion14')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "CreateIncident-SharedMailbox",
              "type": "string"
            },
            "Shared Mailbox Address": {
              "type": "string",
              "metadata": {
                "description": "Enter value for Shared Mailbox Address"
              }
            },
            "Subscription": {
              "type": "string",
              "metadata": {
                "description": "Enter value for Subscription"
              }
            },
            "Resource Group": {
              "type": "string",
              "metadata": {
                "description": "Enter value for Resource Group"
              }
            },
            "Workspace Name": {
              "type": "string",
              "metadata": {
                "description": "Enter value for Workspace Name"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
            "ConversionserviceConnectionName": "[[concat('Conversionservice-', parameters('PlaybookName'))]",
            "Office365ConnectionName": "[[concat('Office365-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Conversionservice')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Office365')]",
            "_connection-4": "[[variables('connection-4')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "Resource Group": {
                      "type": "string",
                      "defaultValue": "[[parameters('Resource Group')]"
                    },
                    "Shared Mailbox Address": {
                      "type": "string",
                      "defaultValue": "[[parameters('Shared Mailbox Address')]"
                    },
                    "Subscription": {
                      "type": "string",
                      "defaultValue": "[[parameters('Subscription')]"
                    },
                    "Workspace Name": {
                      "type": "string",
                      "defaultValue": "[[parameters('Workspace Name')]"
                    }
                  },
                  "triggers": {
                    "When_a_new_email_arrives_in_a_shared_mailbox_(V2)": {
                      "recurrence": {
                        "frequency": "Minute",
                        "interval": 3
                      },
                      "evaluatedRecurrence": {
                        "frequency": "Minute",
                        "interval": 3
                      },
                      "splitOn": "@triggerBody()?['value']",
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['office365']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/v2/SharedMailbox/Mail/OnNewEmail",
                        "queries": {
                          "folderId": "Inbox",
                          "hasAttachments": false,
                          "importance": "Any",
                          "includeAttachments": false,
                          "mailboxAddress": "@parameters('Shared Mailbox Address')",
                          "subjectFilter": "incident"
                        }
                      }
                    }
                  },
                  "actions": {
                    "Condition": {
                      "actions": {
                        "Send_an_email_from_a_shared_mailbox_(V2)": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Body": "<p>New Microsoft Sentinel incident created succesfully using shared mailbox.&nbsp;</p>",
                              "Importance": "Normal",
                              "MailboxAddress": "@parameters('Shared Mailbox Address')",
                              "Subject": "New Microsoft Sentinel Incident created sucesfully!",
                              "To": "@triggerBody()?['from']"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['office365']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/v2/SharedMailbox/Mail"
                          }
                        }
                      },
                      "runAfter": {
                        "Create_incident": [
                          "Succeeded",
                          "Failed"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Send_an_email_from_a_shared_mailbox_(V2)_3": {
                            "type": "ApiConnection",
                            "inputs": {
                              "body": {
                                "Body": "<p>There was an error while creating new incident in Microsoft Sentinel using shared mailbox.<br>\n<br>\nError details:<br>\n@{body('Create_incident')?['Content']}</p>",
                                "Importance": "Normal",
                                "MailboxAddress": "@parameters('Shared Mailbox Address')",
                                "Subject": "There was an error creating new incident in Microsoft Sentinel using shared mailbox!",
                                "To": "@triggerBody()?['from']"
                              },
                              "host": {
                                "connection": {
                                  "name": "@parameters('$connections')['office365']['connectionId']"
                                }
                              },
                              "method": "post",
                              "path": "/v2/SharedMailbox/Mail"
                            }
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "equals": [
                              "@outputs('Create_incident')?['statusCode']",
                              200
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_incident": {
                      "runAfter": {
                        "Email_body_to_text": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "description": "@{trim(first(split(last(split(body('Email_body_to_text'),'Incident Description: ')),'Incident Severity: ')))}",
                          "owner": "@{first(skip(split(body('Email_body_to_text'),'Assign Incident to:'),1))}",
                          "ownerAction": "@{trim(first(split(last(split(body('Email_body_to_text'),'Assign Incident: ')),'Assign Incident to: ')))}",
                          "severity": "@{trim(first(split(last(split(body('Email_body_to_text'),'Incident Severity: ')),'Incident Status: ')))}",
                          "status": "@{trim(first(split(last(split(body('Email_body_to_text'),'Incident Status: ')),'Incident tag: ')))}",
                          "tagsToAdd": {
                            "TagsToAdd": [
                              {
                                "Tag": "@{trim(first(split(last(split(body('Email_body_to_text'),'Incident tag: ')),'Assign Incident: ')))}"
                              }
                            ]
                          },
                          "title": "@{trim(first(split(last(split(body('Email_body_to_text'),'Incident title: ')),'Incident Description: ')))}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "put",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(parameters('Subscription'))}/resourceGroups/@{encodeURIComponent(parameters('Resource Group'))}/workspaces/@{encodeURIComponent(parameters('Workspace Name'))}"
                      }
                    },
                    "Email_body_to_text": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "<p>@{triggerBody()?['body']}</p>",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['conversionservice']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/html2text"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "conversionservice": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('ConversionserviceConnectionName'))]",
                        "connectionName": "[[variables('ConversionserviceConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Conversionservice')]"
                      },
                      "office365": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                        "connectionName": "[[variables('Office365ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Office365')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "tags": {
                "hidden-SentinelTemplateName": "CreateIncident-SharedMailbox",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('ConversionserviceConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('ConversionserviceConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('ConversionserviceConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Office365ConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('Office365ConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-4')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId14'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId14')]",
                "contentId": "[variables('_playbookContentId14')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion14')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Create Incident From Shared Mailbox",
            "description": "This playbook will create a new Microsoft Sentinel incident when new email arrives to shared mailbox with 'incident' keyword in the subject.",
            "prerequisites": [
              "1. Create shared mailbox that will be used for incident creation.",
              "2. Prepare Subscription ID, Resource Group name, and Log Analytics Workspace name as it is needed for template deployment."
            ],
            "postDeployment": [
              "1. Add Microsoft Sentinel Responder role to the playbook's managed identity.",
              "2. Authorize Office 365 Outlook connector and Conversion Service connector (HTML to text).",
              "3. Utilize [email template](https://github.com/Azure/Azure-Sentinel/blob/master/Playbooks/CreateIncident-SharedMailbox/NewMicrosoftSentinelIncidentCreationTemplate.oft) to get correct data"
            ],
            "lastUpdateTime": "2022-09-04T00:00:00Z",
            "tags": [
              "Utilities"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId14')]",
        "contentKind": "Playbook",
        "displayName": "CreateIncident-SharedMailbox",
        "contentProductId": "[variables('_playbookcontentProductId14')]",
        "id": "[variables('_playbookcontentProductId14')]",
        "version": "[variables('playbookVersion14')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName15')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "M365D_BEC_Playbook_for_SecOps-Tasks Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion15')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "M365D_BEC_Playbook_for_SecOps-Tasks",
              "type": "string"
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "For_each_-_alert_check_the_keyword": {
                      "foreach": "@triggerBody()?['object']?['properties']?['Alerts']",
                      "actions": {
                        "Condition_-_if_alerts_contain_keywords": {
                          "actions": {
                            "Scope_-_Contain": {
                              "actions": {
                                "Add_task_to_incident_-_Contain": {
                                  "runAfter": {
                                    "Compose_-_Contain": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "taskDescription": "<p>@{outputs('Compose_-_Contain')}</p>",
                                      "taskTitle": "Contain"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/CreateTask"
                                  }
                                },
                                "Compose_-_Contain": {
                                  "type": "Compose",
                                  "inputs": "<dt><b> Which assets are involved?</b></dt>\n<dd> If an endpoint performed any suspicious activity, consider <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/respond-machine-alerts#isolate-devices-from-the-network\">isolating the device</a> in M365D or <a target='_blank' href=\"https://learn.microsoft.com/en-gb/azure/sentinel/respond-threats-during-investigation\">from Microsoft Sentinel</a>.</dd>\n<dt><b> Which user accounts are involved and what are their privileges?</b></dt>\n<dd> To assess the risk, first determine whether the user accounts are priority, management, or administrator accounts.</dd>\n<dt><b> What containments actions were already taken by automated response?</b></dt>\n<dd> What is the evidence remediation status?</dd>\n<dd> Check evidence & response tab in M365D portal for <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/air-review-approve-pending-completed-actions\">pending approval actions</a>.</dd>"
                                }
                              },
                              "runAfter": {
                                "Scope_-_Introduction": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Scope"
                            },
                            "Scope_-_Introduction": {
                              "actions": {
                                "Add_task_to_incident_-_Introduction": {
                                  "runAfter": {
                                    "Compose_-_Introduction": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "taskDescription": "<p>@{outputs('Compose_-_Introduction')}</p>",
                                      "taskTitle": "Introduction"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/CreateTask"
                                  }
                                },
                                "Compose_-_Introduction": {
                                  "type": "Compose",
                                  "inputs": "<dt>This playbook will walk you through four stages of responding to a business email compromise (BEC) incident: containment, investigation, remediation and prevention. The step-by-step instructions will help you take the required remedial action to protect information and minimize further risks.</dt>\n<dt>Click on \"Contain\" task when you're ready to start.</dt>"
                                },
                                "Mark_a_task_as_completed_-_Introduction": {
                                  "runAfter": {
                                    "Add_task_to_incident_-_Introduction": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "taskArmId": "@body('Add_task_to_incident_-_Introduction')?['id']"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/CompleteTask"
                                  }
                                }
                              },
                              "type": "Scope"
                            },
                            "Scope_-_Investigation": {
                              "actions": {
                                "Add_task_to_incident_-_Investigation_-_Step_1": {
                                  "runAfter": {
                                    "Compose_-_Investigation_-_Step_1": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "taskDescription": "<p>@{outputs('Compose_-_Investigation_-_Step_1')}</p>",
                                      "taskTitle": "Investigation - Step 1"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/CreateTask"
                                  }
                                },
                                "Add_task_to_incident_-_Investigation_-_Step_2": {
                                  "runAfter": {
                                    "Compose_-_Investigation_-_Step_2": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "taskDescription": "<p>@{outputs('Compose_-_Investigation_-_Step_2')}</p>",
                                      "taskTitle": "Investigation - Step 2"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/CreateTask"
                                  }
                                },
                                "Add_task_to_incident_-_Investigation_-_Step_3": {
                                  "runAfter": {
                                    "Compose_-_Investigation_-_Step_3": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "taskDescription": "<p>@{outputs('Compose_-_Investigation_-_Step_3')}</p>",
                                      "taskTitle": "Investigation - Step 3"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/CreateTask"
                                  }
                                },
                                "Add_task_to_incident_-_Investigation_-_Step_4": {
                                  "runAfter": {
                                    "Compose_-_Investigation_-_Step_4": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "taskDescription": "<p>@{outputs('Compose_-_Investigation_-_Step_4')}</p>",
                                      "taskTitle": "Investigation - Step 4"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/CreateTask"
                                  }
                                },
                                "Compose_-_Investigation_-_Step_1": {
                                  "type": "Compose",
                                  "inputs": "<dt>For each user involved in the incident:</dt>\n<dt><b>1.\tInvestigate the user account for suspicious actions and determine initial method of compromise:</b>\n<dd>1.\t<a target='_blank' href=\"https://learn.microsoft.com/en-us/azure/sentinel/investigate-with-ueba\">Investigate users with Microsoft Sentinel UEBA</a> and <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender/investigate-users\">Investigate users in Microsoft 365 Defender</a>.</dd>\n<dd>2.\tSearch for recently clicked links by the user: <a target='_blank' href=\"https://learn.microsoft.com/en-us/azure/azure-monitor/reference/tables/urlclickevents\">UrlClickEvents in Microsoft Sentinel Logs</a> or <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender/advanced-hunting-urlclickevents-table\">UrlClickEvents in advanced hunting</a>.</dd>\n<dd>3.\tCheck for risky signs: <a target='_blank' href=\"https://docs.microsoft.com/azure/active-directory/identity-protection/howto-identity-protection-investigate-risk\">Investigate risk in Azure AD Identity Protection</a>.</dd>\n<dd>4.\tCheck for messages reported by the user as spam or phishing: <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/admin-submission#view-user-submissions-to-microsoft\">View user submissions to Microsoft</a>.</dd>\n<dt>Continue to Investigation - Step 2</dt>"
                                },
                                "Compose_-_Investigation_-_Step_2": {
                                  "runAfter": {
                                    "Add_task_to_incident_-_Investigation_-_Step_1": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "Compose",
                                  "inputs": "<dt><b>2.\tWhat is the <a target='_blank' href=\"https://docs.microsoft.com/defender-cloud-apps/tutorial-ueba#understand-the-investigation-priority-score\">investigation priority score</a> of the user account?</b><dt>\n<dt>Continue to Investigation - Step 3</dt>"
                                },
                                "Compose_-_Investigation_-_Step_3": {
                                  "runAfter": {
                                    "Add_task_to_incident_-_Investigation_-_Step_2": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "Compose",
                                  "inputs": "<dt><b>3.\tInvestigate the user's activities: <a target='_blank' href=\"https://learn.microsoft.com/en-us/azure/azure-monitor/reference/tables/cloudappevents\">CloudAppEvents in Microsoft Sentinel Logs</a> or <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender/advanced-hunting-cloudappevents-table\">CloudAppEvents in advanced hunting</a>:</b></dt>\n<dd>\tHave suspicious Inbox rules been recently configured for the mailbox?</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;-\tActivity names: \"New-InboxRule\", \"Set-InboxRule\", or \"UpdateInboxRules\".</dd>\n<dd>\tHas SMTP forwarding been recently configured on the mailbox?</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;-\tActivity name: \"Set-Mailbox\" with the \"ForwardingSmtpAddress\" parameter.</dd>\n<dd>\tHas the user recently registered new devices?</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;-\tActivity name: \"Add registered owner to device\".</dd>\n<dd>\tHas the user recently created new Power Automate tasks?</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;-\tActivity name: \"CreateFlow\".</dd>\n<dd>\tHas a passwordless login method been recently enabled for the user?</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;-\tActivity name: \"Update user\" with the \"SearchableDeviceKey\" property modified.</dd>\n<dd>\tHas a new multi-factor authentication (MFA) method been recently enabled for the user?</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;-\tInvestigate in the <a target='_blank' href=\"https://learn.microsoft.com/en-us/azure/azure-monitor/reference/tables/auditlogs\">AuditLogs in Microsoft Sentinel Logs</a> or <a target='_blank' href=\"https://learn.microsoft.com/en-gb/azure/active-directory/reports-monitoring/concept-audit-logs\">Azure AD audit logs</a>.</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;-\tActivity type: \"User registered security info\".</dd>\n<dt>Continue to Investigation - Step 4</dt>"
                                },
                                "Compose_-_Investigation_-_Step_4": {
                                  "runAfter": {
                                    "Add_task_to_incident_-_Investigation_-_Step_3": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "Compose",
                                  "inputs": "<dt><b>4.\tInvestigate email messages sent by the user.</b></dt>\n<dd>\tUse <a target='_blank' href=\"https://learn.microsoft.com/en-us/azure/azure-monitor/reference/tables/emailevents\"> EmailEvents in Microsoft Sentinel Logs</a> or <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender/advanced-hunting-emailevents-table\">M365D advanced hunting</a>, and filter table by \"SenderObjectId\" to find suspicious messages sent on behalf of the user.</dd>"
                                }
                              },
                              "runAfter": {
                                "Scope_-_Contain": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Scope"
                            },
                            "Scope_-_Prevention": {
                              "actions": {
                                "Add_task_to_incident_-_Prevention": {
                                  "runAfter": {
                                    "Compose_-_Prevention": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "taskDescription": "<p>@{outputs('Compose_-_Prevention')}</p>",
                                      "taskTitle": "Prevention"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/CreateTask"
                                  }
                                },
                                "Compose_-_Prevention": {
                                  "type": "Compose",
                                  "inputs": "<dt>\tIf you haven't already, configure muti-factor authentication (MFA) and conditional access for all users. Follow the recommendations at <a target='_blank' href=\"https://docs.microsoft.com/azure/security/fundamentals/identity-management-best-practices\">Azure Identity Management and access control security best practices</a>.</dt>\n<dt>\tIf the entry vector for this incident was phishing messages, verify that Microsoft Defender for Office 365 is configured according to <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/recommended-settings-for-eop-and-office365\">recommended best practices</a>.</dt>  \n<dt>\tIf external email forwarding and forwarding alerts were involved in this incident, <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/external-email-forwarding\">control automatic external email forwarding</a>.</dt>"
                                }
                              },
                              "runAfter": {
                                "Scope_-_Remediation": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Scope"
                            },
                            "Scope_-_Remediation": {
                              "actions": {
                                "Add_task_to_incident_-_Remediation": {
                                  "runAfter": {
                                    "Compose_-_Remediation": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "taskDescription": "<p>@{outputs('Compose_-_Remediation')}</p>",
                                      "taskTitle": "Remediation"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/CreateTask"
                                  }
                                },
                                "Compose_-_Remediation": {
                                  "type": "Compose",
                                  "inputs": "<dt><b>\tMark the incident as a True Positive.</b></dt>\n<dt><b>\tFor user accounts with suspicious activity, take the following actions:</b></dt>\n<dd>\tContact the affected user.</dd>\n<dd>\tReset the account password.</dd>\n<dd>\tRequire the user to sign out and sign in again.</dd>\n<dd>\tRemove any recent devices or applications that were registered.</dd>\n<dd>\tRemove any recent passwordless authentication methods that were registered.</dd>\n<dd>\tRemove any recent multi-factor authentication (MFA) methods that were registered.</dd>\n<dt><b>\tUse <a target='_blank' href=\"https://security.microsoft.com/threatexplorer\">Threat Explorer</a> to identify malicious messages sent to internal recipients. Submit the messages to Microsoft for analysis and delete them from other mailboxes.</b></dt>\n<dt><b>\tIf a forwarding rule was created during this incident, remove the forwarding rule and block the forwarding address.</b></dt>"
                                }
                              },
                              "runAfter": {
                                "Scope_-_Investigation": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Scope"
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "contains": [
                                  "@items('For_each_-_alert_check_the_keyword')?['properties']?['alertDisplayName']",
                                  "BEC"
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        }
                      },
                      "type": "Foreach"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "microsoftsentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "M365D_BEC_Playbook_for_SecOps-Tasks",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId15'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId15')]",
                "contentId": "[variables('_playbookContentId15')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion15')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Incident tasks - Microsoft 365 Defender BEC Playbook for SecOps",
            "description": "This playbook add Incident Tasks based on Microsoft 365 Defender BEC Playbook for SecOps. This playbook will walk the analyst through four stages of responding to a BEC incident: containment, investigation, remediation and prevention. The step-by-step instructions will help you take the required remedial action to protect information and minimize further risks.",
            "postDeployment": [
              "1. Add Microsoft Sentinel Responder role to the managed identity.",
              "2. Assign playbook to the automation rule."
            ],
            "lastUpdateTime": "2023-02-16T00:00:00Z",
            "tags": [
              "Tasks"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId15')]",
        "contentKind": "Playbook",
        "displayName": "M365D_BEC_Playbook_for_SecOps-Tasks",
        "contentProductId": "[variables('_playbookcontentProductId15')]",
        "id": "[variables('_playbookcontentProductId15')]",
        "version": "[variables('playbookVersion15')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName16')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "M365D_Phishing_Playbook_for_SecOps-Tasks Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion16')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "M365D_Phishing_Playbook_for_SecOps-Tasks",
              "type": "string"
            }
          },
          "variables": {
            "MicrosoftsentinelConnectionName": "[[concat('Microsoftsentinel-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Condition": {
                      "actions": {
                        "Scope_-_Contain": {
                          "actions": {
                            "Add_task_to_incident_-_Contain": {
                              "runAfter": {
                                "Compose_-_Contain": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Contain')}</p>",
                                  "taskTitle": "Contain"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Compose_-_Contain": {
                              "type": "Compose",
                              "inputs": "<dt><b> Which assets are involved?</b></dt>\n<dd> If an endpoint performed any suspicious activity, consider <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/respond-machine-alerts#isolate-devices-from-the-network\">isolating the device</a> in M365D or <a target='_blank' href=\"https://learn.microsoft.com/azure/sentinel/respond-threats-during-investigation\">from Microsoft Sentinel</a>.</dd>\n<dt><b> Which user accounts are involved and what are their privileges?</b></dt>\n<dd> To assess the risk, first determine whether the user accounts are priority, management, or administrator accounts.</dd>\n<dt><b> What containments actions were already taken by automated response?</b></dt>\n<dd> What is the evidence remediation status?</dd>\n<dd> Check evidence & response tab in M365D portal for <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/air-review-approve-pending-completed-actions\">pending approval actions</a>.</dd>"
                            }
                          },
                          "runAfter": {
                            "Scope_-_Introduction": [
                              "Succeeded"
                            ]
                          },
                          "type": "Scope"
                        },
                        "Scope_-_Introduction": {
                          "actions": {
                            "Add_task_to_incident_-_Introduction": {
                              "runAfter": {
                                "Compose_-_Introduction": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Introduction')}</p>",
                                  "taskTitle": "Introduction"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Compose_-_Introduction": {
                              "type": "Compose",
                              "inputs": "<dt>To report phishing messages, <a target='_blank' href=\"https://go.microsoft.com/fwlink/?linkid=2167511\">submit</a> them on Microsoft 365 Defender for analysis. Select \"Should have been blocked\" when prompted. Results are shown in the submissions detail flyout. Follow our <a target='_blank' href=\"https://go.microsoft.com/fwlink/?linkid=2201181\">step-by-step guide</a> for details.</dt>\n<dt><b>This playbook for Security Operations (SecOps/SOC) teams will walk you through four stages of responding to a phishing incident: containment, investigation, remediation and prevention. The step-by-step instructions will help you take the required remedial action to protect information and minimize further risks.</b></dt>\n<dt>Click on \"Contain\" task when you're ready to start.</dt>"
                            },
                            "Mark_a_task_as_completed_-_Introduction": {
                              "runAfter": {
                                "Add_task_to_incident_-_Introduction": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "taskArmId": "@body('Add_task_to_incident_-_Introduction')?['id']"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CompleteTask"
                              }
                            }
                          },
                          "type": "Scope"
                        },
                        "Scope_-_Investigate": {
                          "actions": {
                            "Add_task_to_incident_-_Investigate": {
                              "runAfter": {
                                "Compose_-_Investigate": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Investigate')}</p>",
                                  "taskTitle": "Investigate"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Compose_-_Investigate": {
                              "type": "Compose",
                              "inputs": "<dt><b>\tReview the initial phishing email.</b></dt>\n<dd>\tFrom the incident in the M365D incidents queue, select the Evidence and Response tab.</dd>\n<dd>\tFind the relevant email and open the email page. </dd>\n<dd>\tCheck the email header for the true source of the sender.</dd>\n<dd>\tInvestigate the source IP address of the email. Is the IP address used by attackers or campaigns?</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;- <a target='_blank' href=\"https://security.microsoft.com/threatanalytics3\">Threat analytics</a></dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;- <a target='_blank' href=\"https://security.microsoft.com/campaigns\">Campaigns</a></dd>\n<dt><b>\tDid the email contain a URL?</b></dt>\n<dd>\tGo to the URL page to get the URL reputation.</dd>\n<dt><b>\tDid the email contain an attachment?</b></dt>\n<dd>\tLook for potential malicious content in the attachment, for example, PDF files, obfuscated PowerShell, or other script codes.</dd>\n<dd>\tCheck the device timeline to understand if the payload executed on the endpoint. If so, consider isolating the device. </dd>\n<dt><b>\tIs there a risk that the user opened the email?</b></dt>\n<dd>\tIf yes, perform remediation.</dd>\n<dt><b>\tGet the list of users who got the phishing email.</b><dt>"
                            }
                          },
                          "runAfter": {
                            "Scope_-_Contain": [
                              "Succeeded"
                            ]
                          },
                          "type": "Scope"
                        },
                        "Scope_-_Investigate_involved_users": {
                          "actions": {
                            "Add_task_to_incident_-_Investigate_involved_users": {
                              "runAfter": {
                                "Compose_-_Investigate_involved_users": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Investigate_involved_users')}</p>",
                                  "taskTitle": "Investigate involved users"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Compose_-_Investigate_involved_users": {
                              "type": "Compose",
                              "inputs": "<dt>For each user that is involved in the incident:</dt>\n<dt><b>\tInvestigate the user account for suspicious actions.</b></dt>\n<dd>\t<a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender/investigate-users?view=o365-worldwide\">Investigate users in Microsoft 365 Defender</a>.</dd>\n<dd>\t<a target='_blank' href=\"https://learn.microsoft.com/azure/sentinel/investigate-with-ueba\">Investigate users with Microsoft Sentinel UEBA</a>.</dd>\n<dt><b>\tWhat is the investigation priority score of the user account?</b></dt>\n<dd>\tIf the user performed suspicious activity, consider these steps:</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;- Contact the user assigned the user account.</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;- Reset the user accounts password.</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;- Require the user to sign in again.</dd>\n<dt><b>\tInvestigate the user accounts mailbox.</b></dt>\n<dd>\tGet the latest dates when the user account had access to the mailbox.</dd>\n<dd>\tIs delegated access configured on the mailbox and did it change recently?</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;- Activity names:  'Add-MailboxPermission', 'Add-MailboxFolderPermission', 'Set-MailboxFolderPermission'</dd>\n<dd>\tIs there a forwarding rule configured for the mailbox and was it added recently?</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;- Activity names: \"New-InboxRule\", \"Set-InboxRule\", \"Set-Mailbox\", \"Set-TransportRule\", \"New-TransportRule\".</dd>\n<dt><b>\tIf the email contained a malicious URL, did the user click the link in the email?</b></dt>\n<dd>\tGet more details on the user click from the advanced hunting user clicks table</dd>\n<dt><b>\tIf the email contained an attachment, was the attachment payload executed? Was malicious code executed?</b></dt>\n<dd>\tIf yes, quarantine the file on the device, and consider to isolating the device.</dd>"
                            }
                          },
                          "runAfter": {
                            "Scope_-_Investigate": [
                              "Succeeded"
                            ]
                          },
                          "type": "Scope"
                        },
                        "Scope_-_Prevent": {
                          "actions": {
                            "Add_task_to_incident_-_Prevent": {
                              "runAfter": {
                                "Compose_-_Prevent": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Prevent')}</p>",
                                  "taskTitle": "Prevent"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Compose_-_Prevent": {
                              "type": "Compose",
                              "inputs": "<dt>If the phishing email was received because of a policy override, consider removing the override from the related allow list (Exchange Transport Rule/IP Allow List), and/or enabling ZAP.</dt>\n<dt><b>\tAlerts generated due to policy overrides:</b></dt>\n<dd>\tPhish delivered due to an ETR override.</dd>\n<dd>\tPhish delivered due to an IP allow policy.</dd>\n<dd>\tPhish not zapped because ZAP is disabled.</dd>\n<dt>For more information, see <a target='_blank' href=\"https://learn.microsoft.com/security/compass/incident-response-playbook-phishing\">Phishing investigation IR playbook</a>.</dt>\n<dt>If you received a forwarding alert as part of the incident, use outbound spam policies to <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/external-email-forwarding\">prevent forwarding to external recipients</a>.</dt>\n<dt>Use <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/attack-simulation-training-get-started\">Attack simulation training</a> in the Microsoft 365 Defender portal to run realistic attack scenarios in your organization. These simulated attacks can help you identify vulnerable users.</dt>"
                            }
                          },
                          "runAfter": {
                            "Scope_-_Remediate": [
                              "Succeeded"
                            ]
                          },
                          "type": "Scope"
                        },
                        "Scope_-_Remediate": {
                          "actions": {
                            "Add_task_to_incident_-_Remediate": {
                              "runAfter": {
                                "Compose_-_Remediate": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Remediate')}</p>",
                                  "taskTitle": "Remediate"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Compose_-_Remediate": {
                              "type": "Compose",
                              "inputs": "<dt><b>\tMark the incident as a True Positive.</b></dt>\n<dt><b>\tUse Threat Explorer to remove the malicious emails from all of your inboxes and report the message as phishing to Microsoft.</b><dt>\n<dd>\t<a target='_blank' href=\"https://security.microsoft.com/threatexplorer\">Threat Explorer</a>.</dd>\n<dt><b>\tIf during this incident a forwarding rule is created, remove the forwarding rule and block the forwarding address.</b></dt>\n<dt><b>\t<a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/admin-submission\">Submit</a> the incident evidence to Microsoft.</b></dt>\n<dd>\tEmails</dd>\n<dd>\tAttachments</dd>\n<dd>\tURLs</dd>\n<dd>\tFiles</dd>"
                            }
                          },
                          "runAfter": {
                            "Scope_-_Investigate_involved_users": [
                              "Succeeded"
                            ]
                          },
                          "type": "Scope"
                        }
                      },
                      "runAfter": {
                        "For_each_-_alert_check_the_keywod": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(variables('Alert title'))",
                              0
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "For_each_-_alert_check_the_keywod": {
                      "foreach": "@triggerBody()?['object']?['properties']?['Alerts']",
                      "actions": {
                        "Condition_-_if_alerts_contain_keywords": {
                          "actions": {
                            "Append_to_array_variable": {
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "Alert title",
                                "value": "@items('For_each_-_alert_check_the_keywod')?['properties']?['alertDisplayName']"
                              }
                            }
                          },
                          "expression": {
                            "or": [
                              {
                                "contains": [
                                  "@items('For_each_-_alert_check_the_keywod')?['properties']?['alertDisplayName']",
                                  "Phish"
                                ]
                              },
                              {
                                "contains": [
                                  "@items('For_each_-_alert_check_the_keywod')?['properties']?['alertDisplayName']",
                                  "ZAP"
                                ]
                              },
                              {
                                "contains": [
                                  "@items('For_each_-_alert_check_the_keywod')?['properties']?['alertDisplayName']",
                                  "removed after delivery"
                                ]
                              },
                              {
                                "contains": [
                                  "@items('For_each_-_alert_check_the_keywod')?['properties']?['alertDisplayName']",
                                  "URL click was detected"
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        }
                      },
                      "runAfter": {
                        "Initialize_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Initialize_variable": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Alert title",
                            "type": "array"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "microsoftsentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftsentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftsentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "M365D_Phishing_Playbook_for_SecOps-Tasks",
                "hidden-SentinelTemplateVersion": "1.1",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftsentinelConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftsentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftsentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId16'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId16')]",
                "contentId": "[variables('_playbookContentId16')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion16')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Incident tasks - Microsoft 365 Defender Phishing Playbook for SecOps",
            "description": "This playbook add Incident Tasks based on Microsoft 365 Defender Phishing Playbook for SecOps. This playbook will walk the analyst through four stages of responding to a phishing incident: containment, investigation, remediation and prevention. The step-by-step instructions will help you take the required remedial action to protect information and minimize further risks.",
            "postDeployment": [
              "1. Add Microsoft Sentinel Responder role to the managed identity.",
              "2. Assign playbook to the automation rule."
            ],
            "lastUpdateTime": "2023-02-16T00:00:00Z",
            "tags": [
              "Tasks"
            ],
            "releaseNotes": {
              "version": "1.1",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId16')]",
        "contentKind": "Playbook",
        "displayName": "M365D_Phishing_Playbook_for_SecOps-Tasks",
        "contentProductId": "[variables('_playbookcontentProductId16')]",
        "id": "[variables('_playbookcontentProductId16')]",
        "version": "[variables('playbookVersion16')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName17')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "M365D_Ransomware_Playbook_for_SecOps-Tasks Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion17')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "M365D_Ransomware_Playbook_for_SecOps-Tasks",
              "type": "string"
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Condition_-_if_alert_title_contains_ransomware": {
                      "actions": {
                        "Scope_Containment": {
                          "actions": {
                            "Add_task_to_incident_-_Containment_-_Step_1": {
                              "runAfter": {
                                "Compose_-_Containment_-_Step_1": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Containment_-_Step_1')}</p>",
                                  "taskTitle": "Containment - Step 1: Assess the scope of the incident"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Containment_-_Step_2": {
                              "runAfter": {
                                "Compose_-_Containment_-_Step_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Containment_-_Step_2')}</p>",
                                  "taskTitle": "Containment -Step 2: Preserve existing systems"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Containment_-_Step_3.1": {
                              "runAfter": {
                                "Compose_-_Containment_-_Step_3.1": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Containment_-_Step_3.1')}</p>",
                                  "taskTitle": "Containment -Step 3.1: Prevent the spread"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Containment_-_Step_3.2": {
                              "runAfter": {
                                "Compose_-_Containment_-_Step_3.2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Containment_-_Step_3.2')}</p>",
                                  "taskTitle": "Containment -Step 3.2: Prevent the spread"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Compose_-_Containment_-_Step_1": {
                              "type": "Compose",
                              "inputs": "<dt>Containment and investigation should occur as simultaneously as possible; however, you should focus on quickly achieving containment, so you have more time to investigate. These steps help you determine the scope of the attack and to isolate it to only affected entities, such as user accounts and devices.</dt>\n<dt>Run through this list of questions and tasks to discover the extent of the attack. Microsoft Sentinel and Microsoft 365 Defender can provide a consolidated view of all impacted or at-risk assets to aid in your incident response assessment. See <a target='_blank' href=\"https://learn.microsoft.com/azure/sentinel/respond-threats-during-investigation\">Respond to threat actors while investigating or threat hunting in Microsoft Sentinel</a> or <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender/incidents-overview?view=o365-worldwide\">Incident response with Microsoft 365 Defender</a>. You can use the alerts and the evidence list in the incident to determine:</dt>\n<dt><b>\tWhich user accounts might be compromised?</b></dt>\n<dd>o\tWhich accounts were used to deliver the payload?</dd>\n<dt><b>\tWhich <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/investigate-machines?view=o365-worldwide\">onboarded</a> and <a href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/device-discovery?view=o365-worldwide\">discovered</a> devices are affected and how?</b></dt>\n<dd>o\tOriginating devices</dd>\n<dd>o\tImpacted devices</dd>\n<dd>o\tSuspicious devices</dd>\n<dt><b>\tIdentify any network communication that is associated with the incident.</b></dt>\n<dt><b>\tWhich applications are affected?</b></dt>\n<dt><b>\tWhat payloads were spread?</b></dt>\n<dt><b>\tHow is the attacker communicating with the compromised devices? (Network protection must be <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/enable-network-protection?view=o365-worldwide\">enabled</a>):</b></dt>\n<dd>o\tGo to the <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/indicator-ip-domain?view=o365-worldwide#create-an-indicator-for-ips-urls-or-domains-from-the-settings-page\">indicators page</a> to add a block for the IP and URL (if you have that information).</dd>\n<dd>o\t<a target='_blank' href=\"https://learn.microsoft.com/azure/sentinel/add-entity-to-threat-intelligence?tabs=incidents\">Add entities to threat intelligence in Microsoft Sentinel</a></dd>\n<dt><b>\tWhat was the payload delivery medium?</b></dt>"
                            },
                            "Compose_-_Containment_-_Step_2": {
                              "runAfter": {
                                "Add_task_to_incident_-_Containment_-_Step_1": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt>Run through this list of tasks and questions to protect existing systems from attack:<dt>\n<dt><b>\tIf you have online backups, consider disconnecting the backup system from the network until you are confident that the attack is contained, see <a target='_blank' href=\"https://docs.microsoft.com/security/compass/backup-plan-to-protect-against-ransomware\">Backup and restore plan to protect against ransomware</a>.</b><dt>\n<dt><b>\tIf you are experiencing or expect an imminent and active ransomware deployment:</b><dt>\n<dd>o\t<a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender/investigate-users?view=o365-worldwide\">Suspend privileged and local accounts</a> that you suspect are part of the attack. You can do this from the Users tab in the properties of the incident in the Microsoft 365 Defender portal, or <a target='_blank' href=\"https://learn.microsoft.com/azure/sentinel/investigate-with-ueba\">Investigate users with Microsoft Sentinel UEBA</a>.</dd>\n<dd>o\tStop all <a target='_blank' href=\"https://docs.microsoft.com/defender-for-identity/playbook-domain-dominance\">remote logon sessions</a>.</dd>\n<dd>o\tReset the compromised user account passwords and require the users of compromised user accounts to sign in again - <a target='_blank' href='https://learn.microsoft.com/azure/sentinel/respond-threats-during-investigation'>Respond to threat actors while investigating or threat hunting in Microsoft Sentinel</a></dd>\n<dd>o\tDo the same for user accounts that might be compromised.</dd>\n<dd>o\tIf shared local accounts are compromised, have your IT admin help you to enforce a password change across all exposed devices. Example Kusto query:</dd>\n<dd><code>DeviceLogonEvents | where DeviceName  contains (AccountDomain) | take 10</code></dd>\n<dt><b>\tFor the devices that are not yet isolated and are not part of the critical infrastructure:</b><dt>\n<dd>o\tIsolate compromised devices from the network but do not shut them off  - <a target='_blank' href='https://learn.microsoft.com/azure/sentinel/respond-threats-during-investigation'>Respond to threat actors while investigating or threat hunting in Microsoft Sentinel</a></dd>\n<dd>o\tIf you identify the originating or spreader devices, isolate those first.</dd>\n<dt><b>\tPreserve compromised systems for analysis.</b><dt>"
                            },
                            "Compose_-_Containment_-_Step_3.1": {
                              "runAfter": {
                                "Add_task_to_incident_-_Containment_-_Step_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt>Use this list to keep the attack from spreading to additional entities.</dt>\n<dt><b>\tIf shared local accounts are being used in the attack, consider <a target='_blank' href=\"https://techcommunity.microsoft.com/t5/microsoft-security-baselines/blocking-remote-use-of-local-accounts/ba-p/701042\">Blocking Remote Use of Local Accounts</a>.</b></dt>\n<dd>o\tKusto query for all network logons that are local admins:</dd>\n<dd><code>DeviceLogonEvents\n<br>| where IsLocalAdmin == true and AccountDomain == DeviceName<br>\n| extend IsLocalLogon = tobool(todynamic(AdditionalFields).IsLocalLogon)<br>\n| where IsLocalLogon==false</code></dd>\n<dd>o\tKusto query for non-RDP logons (more realistic for most networks):</dd>\n<dd><code>DeviceLogonEvents<br>\n| where IsLocalAdmin == true and AccountDomain == DeviceName and LogonType != 'RemoteInteractive'<br>\n| extend IsLocalLogon = tobool(todynamic(AdditionalFields).IsLocalLogon)<br>\n| where IsLocalLogon==false</code></dd>\n<dt><b>\tQuarantine and add indicators for files that are infected.</b></dt>\n<dt><b>\tEnsure that your antivirus solution is configurable in its optimal protection state. For Microsoft Defender Antivirus, this includes:</b></dt>\n<dd>o\t<a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/configure-real-time-protection-microsoft-defender-antivirus?view=o365-worldwide#real-time-protection-policy-settings\">Real time protection</a> is enabled.</dd>\n<dd>o\t<a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/prevent-changes-to-security-settings-with-tamper-protection?view=o365-worldwide\">Tamper protection</a> is enabled. In the Microsoft 365 Defender portal, select Settings > Endpoints > Advanced features > Tamper protection.</dd>\n<dd>o\t<a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/enable-attack-surface-reduction?view=o365-worldwide\">Attack surface reduction (ASR)</a> rules are enabled.</dd>\n<dd>o\t<a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/enable-cloud-protection-microsoft-defender-antivirus?view=o365-worldwide\">Cloud protectio</a>n is enabled.</dd>\n<dt>Continue to the task - Containment - Step 3.2: Prevent the spread</dt>"
                            },
                            "Compose_-_Containment_-_Step_3.2": {
                              "runAfter": {
                                "Add_task_to_incident_-_Containment_-_Step_3.1": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt><b>\tDisable Exchange ActiveSync and OneDrive sync.</b></dt>\n<dd>o\tTo disable Exchange ActiveSync for a mailbox, see <a target='_blank' href=\"https://docs.microsoft.com/exchange/recipients-in-exchange-online/manage-user-mailboxes/enable-or-disable-exchange-activesync\">How to disable Exchange ActiveSync for users in Exchange Online</a>.</dd>\n<dd>o\tTo disable other types of access to a mailbox, see:</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;-\t<a target='_blank' href=\"https://docs.microsoft.com/exchange/recipients-in-exchange-online/manage-user-mailboxes/enable-or-disable-mapi\">Enable or disable MAPI for a mailbox</a>.</dd>\n<dd>&nbsp;&nbsp;&nbsp;&nbsp;-\t<a target='_blank' href=\"https://docs.microsoft.com/exchange/clients-and-mobile-in-exchange-online/pop3-and-imap4/enable-or-disable-pop3-or-imap4-access\">Enable or Disable POP3 or IMAP4 access for a user<a/>.</dd>\n<dd>o\tPausing OneDrive sync will help protect your cloud data from being updated by potentially infected devices. For more information, see <a target='_blank' href=\"https://support.microsoft.com/office/how-to-pause-and-resume-sync-in-onedrive-2152bfa4-a2a5-4d3a-ace8-92912fb4421e\">How to Pause and Resume sync in OneDrive</a>.</dd>\n<dt><b>\tApply relevant patches and configuration changes on affected systems.</b></dt>\n<dt><b>\tBlock ransomware communications using internal and external controls.</b></dt>\n<dt><b>\tPurge cached content</b></dt>"
                            }
                          },
                          "runAfter": {
                            "Scope_Introduction": [
                              "Succeeded"
                            ]
                          },
                          "type": "Scope"
                        },
                        "Scope_Eradication_and_recovery": {
                          "actions": {
                            "Add_task_to_incident_-_Eradication_and_recovery_-_S1_-_Verify_your_backups": {
                              "runAfter": {
                                "Compose_-_Eradication_and_recovery_-_S1_-_Verify_your_backups": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Eradication_and_recovery_-_S1_-_Verify_your_backups')}</p>",
                                  "taskTitle": "Eradication and recovery - Step 1: Verify your backups"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Eradication_and_recovery_-_S2_-_Add_indicators": {
                              "runAfter": {
                                "Compose_-_Eradication_and_recovery_-_S2_-_Add_indicators": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Eradication_and_recovery_-_S2_-_Add_indicators')}</p>",
                                  "taskTitle": "Eradication and recovery - Step 2: Add indicators"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Eradication_and_recovery_-_S3_-_Reset_compromised_users": {
                              "runAfter": {
                                "Compose_-_Eradication_and_recovery_-_S3_-_Reset_compromised_users": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Eradication_and_recovery_-_S3_-_Reset_compromised_users')}</p>",
                                  "taskTitle": "Eradication and recovery - Step 3: Reset compromised users"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Eradication_and_recovery_-_S4_-_Isolate_attacker_control": {
                              "runAfter": {
                                "Compose_-_Eradication_and_recovery_-_S4_-_Isolate_attacker_control_points": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Eradication_and_recovery_-_S4_-_Isolate_attacker_control_points')}</p>",
                                  "taskTitle": "Eradication and recovery - Step 4: Isolate attacker control points"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Eradication_and_recovery_-_S5_-_Remove_the_malware": {
                              "runAfter": {
                                "Compose_-_Eradication_and_recovery_-_S5_-_Remove_the_malware": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Eradication_and_recovery_-_S5_-_Remove_the_malware')}</p>",
                                  "taskTitle": "Eradication and recovery - Step 5: Remove the malware"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Eradication_and_recovery_-_S6_-_Recover_files_on_a_clean": {
                              "runAfter": {
                                "Compose_-_Eradication_and_recovery_-_S6_-_Recover_files_on_a_cleaned_device": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Eradication_and_recovery_-_S6_-_Recover_files_on_a_cleaned_device')}</p>",
                                  "taskTitle": "Eradication and recovery - Step 6: Recover files on a cleaned device"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Eradication_and_recovery_-_S7_-_Recover_files_in_OneDrive": {
                              "runAfter": {
                                "Compose_-_Eradication_and_recovery_-_S7_-_Recover_files_in_OneDrive_for_Business": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Eradication_and_recovery_-_S7_-_Recover_files_in_OneDrive_for_Business')}</p>",
                                  "taskTitle": "Eradication and recovery - Step 7: Recover files in OneDrive for Business"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Eradication_and_recovery_-_S8_-_Recover_deleted_email": {
                              "runAfter": {
                                "Compose_-_Eradication_and_recovery_-_S8_-_Recover_deleted_email": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Eradication_and_recovery_-_S8_-_Recover_deleted_email')}</p>",
                                  "taskTitle": "Eradication and recovery - Step 8: Recover deleted email"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Eradication_and_recovery_-_S9_-_Re-enable_Exchange_Act": {
                              "runAfter": {
                                "Compose_-_Eradication_and_recovery_-_S9_-_Re-enable_Exchange_ActiveSync": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Eradication_and_recovery_-_S9_-_Re-enable_Exchange_ActiveSync')}</p>",
                                  "taskTitle": "Eradication and recovery - Step 9: Re-enable Exchange ActiveSync and OneDrive Sync"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Compose_-_Eradication_and_recovery_-_S1_-_Verify_your_backups": {
                              "type": "Compose",
                              "inputs": "<dt>If you have offline backups, you can probably restore the data that has been encrypted after you have removed the ransomware payload (malware) from your environment and after you have verified that there's no unauthorized access in your Microsoft 365 tenant.</dt>\n<dt>Continue to Eradication and recovery - Step 2: Add indicators</dt>"
                            },
                            "Compose_-_Eradication_and_recovery_-_S2_-_Add_indicators": {
                              "runAfter": {
                                "Add_task_to_incident_-_Eradication_and_recovery_-_S1_-_Verify_your_backups": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt>Add any known attacker communication channels as <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/manage-indicators?view=o365-worldwide\">indicators</a>, blocked in firewalls, in your proxy servers, and on endpoints, and <a target='_blank' href='https://learn.microsoft.com/azure/sentinel/add-entity-to-threat-intelligence?tabs=incidents'>add entities to threat intelligence in Microsoft Sentinel</a>.</dt>\n<dt>Continue to Eradication and recovery - Step 3: Reset compromised users</dt>"
                            },
                            "Compose_-_Eradication_and_recovery_-_S3_-_Reset_compromised_users": {
                              "runAfter": {
                                "Add_task_to_incident_-_Eradication_and_recovery_-_S2_-_Add_indicators": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt><b>Reset the passwords of any known compromised user accounts and require a new sign-in.</b></dt>\n<dt>\tConsider resetting the passwords for any privileged account with broad administrative authority, such as the members of the Domain Admins group.</dt>\n<dt>\tIf a user account might have been created by an attacker, disable the account. Do not delete the account unless there are no plans to perform security forensics for the incident.<br></dt>\n<dt><a target='_blank' href='https://learn.microsoft.com/azure/sentinel/respond-threats-during-investigation'>Respond to threat actors while investigating or threat hunting in Microsoft Sentinel</a></dt>\n<dt>Continue to Eradication and recovery - Step 4: Isolate attacker control points</dt>"
                            },
                            "Compose_-_Eradication_and_recovery_-_S4_-_Isolate_attacker_control_points": {
                              "runAfter": {
                                "Add_task_to_incident_-_Eradication_and_recovery_-_S3_-_Reset_compromised_users": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt><b>Isolate any known attacker control points inside the enterprise from the Internet.</b></dt>\n<dt><a target='_blank' href='https://learn.microsoft.com/azure/sentinel/respond-threats-during-investigation'>Respond to threat actors while investigating or threat hunting in Microsoft Sentinel</a></dt>\n<dt>Continue to Eradication and recovery - Step 5: Remove the malware</dt>"
                            },
                            "Compose_-_Eradication_and_recovery_-_S5_-_Remove_the_malware": {
                              "runAfter": {
                                "Add_task_to_incident_-_Eradication_and_recovery_-_S4_-_Isolate_attacker_control": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt><b>Remove the malware from the affected devices.</b></dt>\n<dt>\tRun a full, <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/respond-machine-alerts?view=o365-worldwide#run-microsoft-defender-antivirus-scan-on-devices\">current antivirus scan</a> on all suspected computers and devices to detect and remove the payload that is associated with the ransomware.</dt>\n<dt>\tDo not forget to scan devices that synchronize data or the targets of mapped network drives.</dt>\n<dt>Continue to Eradication and recovery - Step 6: Recover files on a cleaned device</dt>"
                            },
                            "Compose_-_Eradication_and_recovery_-_S6_-_Recover_files_on_a_cleaned_device": {
                              "runAfter": {
                                "Add_task_to_incident_-_Eradication_and_recovery_-_S5_-_Remove_the_malware": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt><b>Recover files on a cleaned device.</b></dt>\n<dt>\tYou can use <a target='_blank' href=\"https://support.microsoft.com/help/17128\">File History</a> in Windows 11, Windows 10, Windows 8.1, and System Protection in Windows 7 to attempt to recover your local files and folders.</dt>\n<dt>Continue to Eradication and recovery - Step 7: Recover files in OneDrive for Business</dt>"
                            },
                            "Compose_-_Eradication_and_recovery_-_S7_-_Recover_files_in_OneDrive_for_Business": {
                              "runAfter": {
                                "Add_task_to_incident_-_Eradication_and_recovery_-_S6_-_Recover_files_on_a_clean": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt><b>Recover files in OneDrive for Business.</b></dt>\n<dt>\tFiles Restore in OneDrive for Business allows you to restore an entire OneDrive to a previous point in time within the last 30 days. For more information, see <a target='_blank' href=\"https://support.microsoft.com/office/restore-your-onedrive-fa231298-759d-41cf-bcd0-25ac53eb8a15\">Restore your OneDrive</a>.</dt>\n<dt>Continue to Eradication and recovery - Step 8: Recover deleted email</dt>"
                            },
                            "Compose_-_Eradication_and_recovery_-_S8_-_Recover_deleted_email": {
                              "runAfter": {
                                "Add_task_to_incident_-_Eradication_and_recovery_-_S7_-_Recover_files_in_OneDrive": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt>In the rare case that the ransomware deleted all your email, you can probably recover the deleted items. See <a target='_blank' href=\"https://docs.microsoft.com/exchange/recipients-in-exchange-online/manage-user-mailboxes/recover-deleted-messages\">Recover deleted messages in a user's mailbox in Exchange Online</a>.</dt>\n<dt>Continue to Eradication and recovery - Step 9: Re-enable Exchange ActiveSync and OneDrive Sync</dt>"
                            },
                            "Compose_-_Eradication_and_recovery_-_S9_-_Re-enable_Exchange_ActiveSync": {
                              "runAfter": {
                                "Add_task_to_incident_-_Eradication_and_recovery_-_S8_-_Recover_deleted_email": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt>After you have cleaned your computers and devices and recovered the data, you can re-enable Exchange ActiveSync and OneDrive sync that you previously disabled in step 3 of containment.</dt>"
                            }
                          },
                          "runAfter": {
                            "Scope_Investigation": [
                              "Succeeded"
                            ]
                          },
                          "type": "Scope"
                        },
                        "Scope_HumOR": {
                          "actions": {
                            "Add_task_to_incident_-_HumOR": {
                              "runAfter": {
                                "Compose_-_HumOR": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_HumOR')}</p>",
                                  "taskTitle": "More data about Human-operated ransomware"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Compose_-_HumOR": {
                              "type": "Compose",
                              "inputs": "<dt>You can get detailed information regards ransomware in <a target='_blank' href=\"https://docs.microsoft.com/security/compass/human-operated-ransomware\">Human-operated ransomware</a>, as Microsoft best practices.</dt>"
                            },
                            "Mark_a_task_as_completed_-_HumOR": {
                              "runAfter": {
                                "Add_task_to_incident_-_HumOR": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "taskArmId": "@body('Add_task_to_incident_-_HumOR')?['id']"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CompleteTask"
                              }
                            }
                          },
                          "runAfter": {
                            "Scope_Prevention": [
                              "Succeeded"
                            ]
                          },
                          "type": "Scope"
                        },
                        "Scope_Introduction": {
                          "actions": {
                            "Add_task_to_incident_-_Introduction": {
                              "runAfter": {
                                "Compose_-_Introduction": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Introduction')}</p>",
                                  "taskTitle": "Introduction"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Compose_-_Introduction": {
                              "type": "Compose",
                              "inputs": "<dt>When you suspect you were or are currently under a ransomware attack, establish secure communications with your incident response team immediately. They can perform the following response phases to disrupt the attack and mitigate the damage:</dt>\n<dt>NOTE: For information about preventing ransomware attacks, see <a target='_blank' href=\"https://docs.microsoft.com/security/compass/protect-against-ransomware\">Rapidly protect against ransomware and extortion</a>.</dt>\n<dt>Click on \"Containment - Step 1: Assess the scope of the incident\" task when you're ready to start.</dt>"
                            },
                            "Mark_a_task_as_completed_-_Introduction": {
                              "runAfter": {
                                "Add_task_to_incident_-_Introduction": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "taskArmId": "@body('Add_task_to_incident_-_Introduction')?['id']"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CompleteTask"
                              }
                            }
                          },
                          "type": "Scope"
                        },
                        "Scope_Investigation": {
                          "actions": {
                            "Add_task_to_incident_-_Investigate_-_Identify_the_line_of_business_(LOB)_apps": {
                              "runAfter": {
                                "Compose_-_Investigate_-_Identify_the_line_of_business_(LOB)_apps": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Investigate_-_Identify_the_line_of_business_(LOB)_apps')}</p>",
                                  "taskTitle": "Investigate - Identify the line of business (LOB) apps that are unavailable due to the incident"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Investigation_-_Assess_the_current_situation": {
                              "runAfter": {
                                "Compose_-_Investigation_-_Assess_the_current_situation": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Investigation_-_Assess_the_current_situation')}</p>",
                                  "taskTitle": "Investigation - Assess the current situation"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Investigation_-_Identify_the_ransomware_process": {
                              "runAfter": {
                                "Compose_-_Investigation_-_Identify_the_ransomware_process": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Investigation_-_Identify_the_ransomware_process')}</p>",
                                  "taskTitle": "Investigation - Identify the ransomware process"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Investigation_-_Look_for_exposed_credentials_": {
                              "runAfter": {
                                "Compose_-_Investigation_-_Look_for_exposed_credentials_in_the_infected_machines": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Investigation_-_Look_for_exposed_credentials_in_the_infected_machines')}</p>",
                                  "taskTitle": "Investigation - Look for exposed credentials in the infected machines"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Compose_-_Investigate_-_Identify_the_line_of_business_(LOB)_apps": {
                              "runAfter": {
                                "Add_task_to_incident_-_Investigation_-_Look_for_exposed_credentials_": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt><b>\tDoes the app require an identity?</b></dt>\n<dd>o\tHow is authentication performed?</dd>\n<dd>o\tHow are credentials such as certificates or secrets stored and managed?</dd>\n<dt><b>\tAre evaluated backups of the application, its configuration, and its data available?</b></dt>\n<dt><b>\tDetermine your compromise recovery process.</b></dt>"
                            },
                            "Compose_-_Investigation_-_Assess_the_current_situation": {
                              "type": "Compose",
                              "inputs": "<dt><b>\tWhat initially made you aware of the ransomware attack?</b></dt>\n<dd>o\tIf IT staff identified the initial threatsuch as noticing backups being deleted, antivirus alerts, endpoint detection and response (EDR) alerts, or suspicious system changesit is often possible to take quick decisive measures to thwart the attack, typically by the containment actions described in this article.</dd>\n<dt><b>\tWhat date and time did you first learn of the incident?</b></dt>\n<dd>o\tWhat system and security updates were not installed on devices on that date? This is important to understand what vulnerabilities might have been leveraged so they can be addressed on other devices.</dd>\n<dd>o\tWhat user accounts were used on that date?</dd>\n<dd>o\tWhat new user accounts were created since that date?</dd>\n<dd>o\tWhat programs were added to automatically start around the time that the incident occurred?</dd>\n<dt><b>\tIs there any indication that the attacker is currently accessing systems?</b></dt>\n<dd>o\tAre there any suspected compromised systems that are experiencing unusual activity?</dd>\n<dd>o\tAre there any suspected compromised accounts that appear to be actively used by the adversary?</dd>\n<dd>o\tIs there any evidence of active command-and-control (C2) servers in EDR, firewall, VPN, web proxy, and other logs?</dd>"
                            },
                            "Compose_-_Investigation_-_Identify_the_ransomware_process": {
                              "runAfter": {
                                "Add_task_to_incident_-_Investigation_-_Assess_the_current_situation": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt>Using advanced hunting, search for this process in the process creation events on other devices.  <a target='_blank' href=\"https://sip.security.microsoft.com/hunting?query=H4sIAAAAAAAEAJVSTUvDUBCcs-B_eIQeFPw8iHgQLKJQKOLBm1qIaZJGkyY0aSpW_7uz85Iq2Is8aOftm53dnc0QOWIs0GCEORKU2MUOPuGwwkwvMfEDMjJy4UsehwC3jPnIlKwSFU9M7BBSyf5zoiVxJCWLJGIWRKZbEDdSyIkishtqlswINl288p4x4jDcdHqDlrEpb6Zt-aUYAzESMo5-sUeq7LseMJIhZT9_OVbxmMdhTL0Sb6qbquuSLEeexXPUxPbW6tZ2s_kuq26muWYJ-W7-ZMxpVPuFjvRTWt-JvDDHajmzIjZvtm2hd_yOnEKRGVHNmgvNneFdm6kYi4ljYtf1vrclu5Djfjt1t5NUmQ5XzJ0w65GcQ3zghL8XeMY-1jjHF57on68xUJV-5_-rElC_V17jFAc4o3bAKja_7_xe30yk7BrXcqno6o3l-o8TphiSa-xKe1jqKwzwDd6nLz7oAgAA&runQuery=true&timeRangeId=month\">Run query in Advanced hunting</a>.</dt>\n<dt>You can use also <a target='_blank' href=\"https://learn.microsoft.com/azure/azure-monitor/reference/tables/deviceprocessevents\">DeviceProcessEvents table in Microsoft Sentinel Logs</a> or in <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender/advanced-hunting-deviceprocessevents-table?view=o365-worldwide\">Microsoft 365 Defender advanced hunting</a>.</dt>"
                            },
                            "Compose_-_Investigation_-_Look_for_exposed_credentials_in_the_infected_machines": {
                              "runAfter": {
                                "Add_task_to_incident_-_Investigation_-_Identify_the_ransomware_process": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt><b>\tFor user accounts whose credentials were potentially compromised, reset the account passwords, and require the users to sign in again.</b></dt>\n<dt><b>\tThe following IOAs might indicate lateral movement:</b></dt>\n<dd>o\tSuspiciousExploratoryCommands</dd>\n<dd>o\tMLFileBasedAlert</dd>\n<dd>o\tIfeoDebuggerPersistence</dd>\n<dd>o\tSuspiciousRemoteFileDropAndExecution</dd>\n<dd>o\tExploratoryWindowsCommands</dd>\n<dd>o\tIoaStickyKeys</dd>\n<dd>o\tMimikatz Defender Amplifier</dd>\n<dd>o\tNetwork scanning tool used by PARINACOTA</dd>\n<dd>o\tDefenderServerAlertMSSQLServer</dd>\n<dd>o\tSuspiciousLowReputationFileDrop</dd>\n<dd>o\tSuspiciousServiceExecution</dd>\n<dd>o\tAdminUserAddition</dd>\n<dd>o\tMimikatzArtifactsDetector</dd>\n<dd>o\tScuba-WdigestEnabledToAccessCredentials</dd>\n<dd>o\tDefenderMalware</dd>\n<dd>o\tMLSuspCmdBehavior</dd>\n<dd>o\tMLSuspiciousRemoteInvocation</dd>\n<dd>o\tSuspiciousRemoteComponentInvocation</dd>\n<dd>o\tSuspiciousWmiProcessCreation</dd>\n<dd>o\tMLCmdBasedWithRemoting</dd>\n<dd>o\tProcess Accesses Lsass</dd>\n<dd>o\tSuspicious Rundll32 Process Execution</dd>\n<dd>o\tBitsAdmin</dd>\n<dd>o\tDefenderCobaltStrikeDetection</dd>\n<dd>o\tDefenderHacktool</dd>\n<dd>o\tIoaSuspPSCommandline</dd>\n<dd>o\tMetasploit</dd>\n<dd>o\tMLSuspToolBehavior</dd>\n<dd>o\tRegistryQueryForPasswords</dd>\n<dd>o\tSuspiciousWdavExclusion</dd>\n<dd>o\tASEPRegKey</dd>\n<dd>o\tCobaltStrikeExecutionDetection</dd>\n<dd>o\tDefenderBackdoor</dd>\n<dd>o\tDefenderBehaviorSuspiciousActivity</dd>\n<dd>o\tDefenderMalwareExecuted</dd>\n<dd>o\tDefenderServerAlertDomainController</dd>\n<dd>o\tDupTokenPrivilegeEscalationDetector</dd>\n<dd>o\tFakeWindowsBinary</dd>\n<dd>o\tIoaMaliciousCmdlets</dd>\n<dd>o\tLivingOffTheLandBinary</dd>\n<dd>o\tMicrosoftSignedBinaryAbuse</dd>\n<dd>o\tMicrosoftSignedBinaryScriptletAbuse</dd>\n<dd>o\tMLFileBasedWithRemoting</dd>\n<dd>o\tMLSuspSvchostBehavior</dd>\n<dd>o\tReadSensitiveMemory</dd>\n<dd>o\tRemoteCodeInjection-IREnabled</dd>\n<dd>o\tScuba-EchoSeenOverPipeOnLocalhost</dd>\n<dd>o\tScuba-SuspiciousWebScriptFileDrop</dd>\n<dd>o\tSuspicious DLL registration by odbcconf</dd>\n<dd>o\tSuspicious DPAPI Activity</dd>\n<dd>o\tSuspicious Exchange Process Execution</dd>\n<dd>o\tSuspicious scheduled task launch</dd>\n<dd>o\tSuspiciousLdapQueryDetector</dd>\n<dd>o\tSuspiciousScheduledTaskRegistration</dd>\n<dd>o\tUntrusted application opens a RDP connection</dd>"
                            }
                          },
                          "runAfter": {
                            "Scope_Containment": [
                              "Succeeded"
                            ]
                          },
                          "type": "Scope"
                        },
                        "Scope_Prevention": {
                          "actions": {
                            "Add_task_to_incident_-_Prevention_-_Device_protection_-_Part_1": {
                              "runAfter": {
                                "Compose_-_Prevention_-_Device_protection_-_Part_1": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Prevention_-_Device_protection_-_Part_1')}</p>",
                                  "taskTitle": "Prevention - Device protection: Part 1"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Prevention_-_Device_protection_-_Part_2": {
                              "runAfter": {
                                "Compose_-_Prevention_-_Device_protection_-_Part_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Prevention_-_Device_protection_-_Part_2')}</p>",
                                  "taskTitle": "Prevention - Device protection: Part 2"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Prevention_-_Email_management": {
                              "runAfter": {
                                "Compose_-_Prevention_-_Email_management": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Prevention_-_Email_management')}</p>",
                                  "taskTitle": "Prevention - Email management"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Prevention_-_Identity_protection": {
                              "runAfter": {
                                "Compose_-_Prevention_-_Identity_protection": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Prevention_-_Identity_protection')}</p>",
                                  "taskTitle": "Prevention - Identity protection"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Prevention_-_Information_protection": {
                              "runAfter": {
                                "Compose_-_Prevention_-_Information_protection": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Prevention_-_Information_protection')}</p>",
                                  "taskTitle": "Prevention - Information protection"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Add_task_to_incident_-_Prevention_-_Vulnerability_management": {
                              "runAfter": {
                                "Compose_-_Prevention_-_Vulnerability_management": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "taskDescription": "<p>@{outputs('Compose_-_Prevention_-_Vulnerability_management')}</p>",
                                  "taskTitle": "Prevention - Vulnerability management"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/CreateTask"
                              }
                            },
                            "Compose_-_Prevention_-_Device_protection_-_Part_1": {
                              "type": "Compose",
                              "inputs": "<dt>The full list of prevention actions can be found in the <a target='_blank' href=\"https://security.microsoft.com/threatanalytics3/05658b6c-dc62-496d-ad3c-c6a795a33c27/analystreport\">ransomware threat analytics report</a>, and in <a target='_blank' href=\"https://docs.microsoft.com/security/compass/protect-against-ransomware\">Rapidly protect against ransomware and extortion | Microsoft Docs</a></dt>\n<dt>\tTurn on Microsoft Defender Antivirus. (Execution)</dt>\n<dt>\tTurn on Microsoft Defender Firewall. (Lateral movement)</dt>\n<dt>\tUse <a target='_blank' href=\"https://docs.microsoft.com/Microsoft-365/security/defender-endpoint/attack-surface-reduction?view=o365-germany#use-advanced-protection-againsttarget='_blank' -ransomware\">advanced protection</a> against ransomware. (Impact)</dt>\n<dt>\tEnable <a href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/network-protection?view=o365-worldwide\">Network Protection</a> in Microsoft Defender for Endpoint and Microsoft 365 Defender. (Initial access)</dt>\n<dt>\tKeep <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/enable-cloud-protection-microsoft-defender-antivirus\">cloud-delivered protection</a> in Microsoft Defender Antivirus turned on. (Defense evasion)</dt>\n<dt>\tKeep Microsoft Defender Antivirus <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/configure-real-time-protection-microsoft-defender-antivirus\">real-time behavior monitoring</a> turned on. (Defense evasion)</dt>\n<dt>\tTurn on <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/configure-real-time-protection-microsoft-defender-antivirus\">real-time protection</a>. (Defense evasion)</dt>\n<dt>\tTurn on <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/prevent-changes-to-security-settings-with-tamper-protection?view=o365-worldwide\">tamper protection</a> in Microsoft Defender for Endpoint, to prevent malicious changes to security settings. (Defense evasion)</dt>\n<dt>\tUpdate Microsoft Defender Antivirus definitions. (Lateral movement)</dt>\n"
                            },
                            "Compose_-_Prevention_-_Device_protection_-_Part_2": {
                              "runAfter": {
                                "Add_task_to_incident_-_Prevention_-_Device_protection_-_Part_1": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt>\tConfigure <a target='_blank' href=\"https://docs.microsoft.com/windows/security/threat-protection/microsoft-defender-smartscreen/microsoft-defender-smartscreen-available-settings\">site and download checking</a> in Microsoft Defender SmartScreen to block or warn. (Initial access)</dt>\n<dt>\tConfigure <a target='_blank' href=\"https://docs.microsoft.com/windows/security/threat-protection/microsoft-defender-smartscreen/microsoft-defender-smartscreen-available-settings\">app and file checking</a> in Microsoft Defender SmartScreen to block or warn. (Initial access)</dt>\n<dt>\tEnable <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/configure-advanced-scan-types-microsoft-defender-antivirus?view=o365-worldwide\">Microsoft Defender Antivirus scanning</a> of downloaded files and attachments. (Initial access)</dt>\n<dt>\tBlock Win32 API calls from Office macros. (Execution)</dt>\n<dt>\tMigrate all legacy workbooks requiring Excel 4.0 macros to the updated VBA macro format using <a target='_blank' href=\"https://www.microsoft.com/microsoft-365/blog/2010/02/16/migrating-excel-4-macros-to-vba/\">this process</a>. (Execution)</dt>\n<dt>\t<a target='_blank' href=\"https://support.microsoft.com/topic/enable-or-disable-macros-in-office-files-12b036fd-d140-4e74-b45e-16fed1a7e5c6\">Disable use of unsigned macros<a/>. Ensure all internal macros with business need are signed and leveraging <a target='_blank' href=\"https://docs.microsoft.com/deployoffice/security/designate-trusted-locations-for-files-in-office\">trusted locations</a> to ensure unknown macros will not run in your environment. (Execution)</dt>\n<dt>\tStop malicious XLM or VBA macros by ensuring runtime macro scanning by Antimalware Scan Interface (<a target='_blank' href=\"https://www.microsoft.com/security/blog/2021/03/03/xlm-amsi-new-runtime-defense-against-excel-4-0-macro-malware/\">AMSI</a>) is on. This featureenabled by defaultis on if the Group Policy setting for Macro Run Time Scan Scope is set to Enable for All Files or Enable for Low Trust Files. Get the <a target='_blank' href=\"https://www.microsoft.com/download/details.aspx?id=49030\">latest group policy template files</a>. (Execution)</dt>\n<dt>\tSet Remote Desktop security level to TLS in Microsoft Defender for Endpoint and Microsoft 365 Defender. (Initial access)</dt>"
                            },
                            "Compose_-_Prevention_-_Email_management": {
                              "runAfter": {
                                "Add_task_to_incident_-_Prevention_-_Information_protection": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt>\tEnable Microsoft Defender Antivirus email scanning. (Initial access)</dt>\n<dt>\tUse Microsoft Defender for Office 365 for <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/anti-phishing-protection\">enhanced phishing protection</a> and coverage against new threats and polymorphic variants. (Initial access)</dt>\n<dt>\tCheck your Office 365 email filtering settings to ensure you block spoofed emails, spam, and emails with malware. Use <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/office-365-atp\">Microsoft Defender for Office 365</a> for enhanced phishing protection and coverage against new threats and polymorphic variants. Configure Microsoft Defender for Office 365 to <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/atp-safe-links\">recheck links on click</a> and <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/zero-hour-auto-purge\">delete delivered mails</a> in response to newly acquired threat intelligence. (Initial access)</dt>\n<dt>\tReview and update to the latest?<a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/recommended-settings-for-eop-and-office365-atp\">recommended settings for EOP and Microsoft Defender for Office 365 security<a/>. (Initial access)</dt>\n<dt>\tConfigure Microsoft Defender for Office 365 to <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/office-365-security/set-up-safe-links-policies\">recheck links on click</a> and delete delivered mails in response to newly acquired threat intelligence. (Initial access)</dt>"
                            },
                            "Compose_-_Prevention_-_Identity_protection": {
                              "runAfter": {
                                "Add_task_to_incident_-_Prevention_-_Device_protection_-_Part_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt>\tIncrease password security by:</dt>\n<dd>o\tUsing <a target='_blank' href=\"https://docs.microsoft.com/azure/active-directory/authentication/concept-password-ban-bad\">Azure AD Identity Protection</a> to prevent and detect attacks and extend blocking of known weak passwords to on-premises Active Directory</dd>\n<dd>o\t<a target='_blank' href=\"https://docs.microsoft.com/azure/active-directory/authentication/concept-password-ban-bad-on-premises\">Extending Azure AD Password Protection</a> to on-premises active directory</dd>\n<dt>\tEnforce strong multi-factor authentication (MFA) or passwordless logon for all users starting with administrators by using one or more of:</dt>\n<dd>o\tPasswordless authentication with <a target='_blank' href=\"https://docs.microsoft.com/windows/security/identity-protection/hello-for-business/hello-identity-verification\">Windows Hello</a> or <a target='_blank' href=\"https://docs.microsoft.com/azure/active-directory/authentication/howto-authentication-phone-sign-in\">Microsoft Authenticator app</a></dd>\n<dd>o\t<a target='_blank' href=\"https://docs.microsoft.com/azure/active-directory/authentication/howto-mfa-userstates\">Azure Multi-Factor Authentication</a></dd>\n<dd>o\tThird-party MFA solutions</dd>\n<dt>\tPractice the principle of least-privilege and maintain credential hygiene. Avoid the use of domain-wide, admin-level service accounts. Restricting local administrative privileges can help limit installation of RATs and other unwanted applications. (Privilege escalation)</dt>\n<dt>\tEnforce end-to-end session security. Explicitly validate the trust of users and workstations before allowing access to administrative interfaces using <a target='_blank' href=\"https://docs.microsoft.com/azure/active-directory/conditional-access/overview\">Azure AD Conditional Access</a>.</dt>\n<dt>\tEnable Local Admin password management (Privilege escalation)</dt>\n<dt>\tDetermine where highly privileged accounts are logging on and exposing credentials. Highly privileged accounts should not be present on workstations. (Privilege escalation)</dt>\n<dt>\tDisable the local storage of passwords and credentials. (Privilege escalation)</dt>"
                            },
                            "Compose_-_Prevention_-_Information_protection": {
                              "runAfter": {
                                "Add_task_to_incident_-_Prevention_-_Identity_protection": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt>\tImplement <a target='_blank' href=\"https://support.microsoft.com/topic/ransomware-protection-in-windows-security-445039d6-537a-488a-ad53-48906f346363\">controlled folder access</a> to help prevent files from being altered or encrypted by ransomware. (Impact)</dt>\n<dd>o\t<a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/enable-controlled-folders?view=o365-worldwide\">Set controlled folder access to Enabled or Audit mode</a>.</dd>\n<dt>\tBack up important files regularly. Use the 3-2-1 rule. Keep three backups of your data, on two different storage types, and at least one backup offsite. (Impact)</dt>\n<dt>\tUse <a target='_blank' href=\"https://www.microsoft.com/microsoft-365/onedrive/onedrive-for-business\">OneDrive cloud storage</a> to protect and back up your files. (Impact)</dt>"
                            },
                            "Compose_-_Prevention_-_Vulnerability_management": {
                              "runAfter": {
                                "Add_task_to_incident_-_Prevention_-_Email_management": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Compose",
                              "inputs": "<dt>\tEnable <a target='_blank' href=\"https://docs.microsoft.com/deployoffice/configure-update-settings-microsoft-365-apps\">Automatic Updates</a>. (Defense evasion)</dt>\n<dt>\tEnsure internet-facing assets have the latest security updates. <a target='_blank' href=\"https://docs.microsoft.com/microsoft-365/compliance/search-the-audit-log-in-security-and-compliance\">Audit</a> these assets regularly for suspicious activity. (Initial access)</dt>"
                            }
                          },
                          "runAfter": {
                            "Scope_Eradication_and_recovery": [
                              "Succeeded"
                            ]
                          },
                          "type": "Scope"
                        }
                      },
                      "runAfter": {
                        "For_each_-_alert": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(variables('Alert title'))",
                              0
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "For_each_-_alert": {
                      "foreach": "@triggerBody()?['object']?['properties']?['Alerts']",
                      "actions": {
                        "Condition": {
                          "actions": {
                            "Append_to_array_variable": {
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "Alert title",
                                "value": "@items('For_each_-_alert')?['properties']?['alertDisplayName']"
                              }
                            }
                          },
                          "expression": {
                            "or": [
                              {
                                "contains": [
                                  "@items('For_each_-_alert')?['properties']?['alertDisplayName']",
                                  "ransomware"
                                ]
                              },
                              {
                                "contains": [
                                  "@items('For_each_-_alert')?['properties']?['alertDisplayName']",
                                  "Ransomware"
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        }
                      },
                      "runAfter": {
                        "Initialize_variable_-_Alert_title": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Initialize_variable_-_Alert_title": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Alert title",
                            "type": "array"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "microsoftsentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "M365D_Ransomware_Playbook_for_SecOps-Tasks",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId17'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId17')]",
                "contentId": "[variables('_playbookContentId17')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion17')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Incident tasks - Microsoft 365 Defender Ransomware Playbook for SecOps",
            "description": "This playbook add Incident Tasks based on Microsoft 365 Defender Ransomware Playbook for SecOps. This playbook will walk the analyst through four stages of responding to a ransomware incident: containment, investigation, eradication and recovery, and prevention. The step-by-step instructions will help you take the required remedial action to protect information and minimize further risks.",
            "postDeployment": [
              "1. Add Microsoft Sentinel Responder role to the managed identity.",
              "2. Assign playbook to the automation rule."
            ],
            "lastUpdateTime": "2023-02-16T00:00:00Z",
            "tags": [
              "Tasks"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId17')]",
        "contentKind": "Playbook",
        "displayName": "M365D_Ransomware_Playbook_for_SecOps-Tasks",
        "contentProductId": "[variables('_playbookcontentProductId17')]",
        "id": "[variables('_playbookcontentProductId17')]",
        "version": "[variables('playbookVersion17')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName18')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Send-Teams-adaptive-card-on-incident-creation Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion18')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Send-Teams-adaptive-card-on-incident-creation",
              "type": "string"
            },
            "Teams Group ID": {
              "defaultValue": "",
              "type": "string"
            },
            "Teams Channel ID": {
              "defaultValue": "",
              "type": "string"
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
            "TeamsConnectionName": "[[concat('Teams-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Compose_-_Adaptive_card_body": {
                      "type": "Compose",
                      "inputs": {
                        "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                        "actions": [
                          {
                            "data": {
                              "x": "confirm"
                            },
                            "title": "Submit response!",
                            "type": "Action.Submit"
                          }
                        ],
                        "body": [
                          {
                            "size": "Large",
                            "text": "New Microsoft Sentinel incident created",
                            "type": "TextBlock",
                            "wrap": true
                          },
                          {
                            "text": "[[Click here to view the Incident](@{triggerBody()?['object']?['properties']?['incidentUrl']})",
                            "type": "TextBlock",
                            "wrap": true
                          },
                          {
                            "facts": [
                              {
                                "size": "medium",
                                "spacing": "large",
                                "title": "Incident Title",
                                "value": "@{triggerBody()?['object']?['properties']?['title']}"
                              },
                              {
                                "spacing": "Medium",
                                "title": "Incident ID",
                                "value": "@{triggerBody()?['object']?['properties']?['incidentNumber']}"
                              },
                              {
                                "spacing": "Medium",
                                "title": "Incident Creation time (UTC)",
                                "value": "@{triggerBody()?['object']?['properties']?['createdTimeUtc']}"
                              },
                              {
                                "spacing": "Medium",
                                "title": "Severity",
                                "value": "@{triggerBody()?['object']?['properties']?['severity']}"
                              },
                              {
                                "spacing": "Medium",
                                "title": "Alert Providers",
                                "value": "@{join(triggerBody()?['object']?['properties']?['additionalData']?['alertProductNames'],'; ')}"
                              },
                              {
                                "spacing": "Medium",
                                "title": "Tactics",
                                "value": "@{join(triggerBody()?['object']?['properties']?['additionalData']?['tactics'], '; ')}"
                              },
                              {
                                "spacing": "Medium",
                                "title": "Description",
                                "value": "@{triggerBody()?['object']?['properties']?['description']}"
                              }
                            ],
                            "type": "FactSet"
                          },
                          {
                            "size": "Large",
                            "spacing": "Large",
                            "text": "Respond:",
                            "type": "TextBlock",
                            "weight": "Bolder"
                          },
                          {
                            "size": "Small",
                            "style": "Person",
                            "type": "Image",
                            "url": "https://connectoricons-prod.azureedge.net/releases/v1.0.1391/1.0.1391.2130/azuresentinel/icon.png"
                          },
                          {
                            "text": "Close Microsoft Sentinel incident?",
                            "type": "TextBlock"
                          },
                          {
                            "choices": [
                              {
                                "isSelected": true,
                                "title": "Close incident - False Positive",
                                "value": "FalsePositive - IncorrectAlertLogic"
                              },
                              {
                                "title": "Close incident - True Positive",
                                "value": "TruePositive - SuspiciousActivity"
                              },
                              {
                                "title": "Close incident - Benign Positive",
                                "value": "BenignPositive - SuspiciousButExpected"
                              },
                              {
                                "title": "Don't close the incident",
                                "value": "no"
                              }
                            ],
                            "id": "incidentStatus",
                            "style": "compact",
                            "type": "Input.ChoiceSet",
                            "value": "no"
                          },
                          {
                            "text": "Change Microsoft Sentinel incident severity?",
                            "type": "TextBlock"
                          },
                          {
                            "choices": [
                              {
                                "isSelected": true,
                                "title": "High",
                                "value": "High"
                              },
                              {
                                "title": "Medium",
                                "value": "Medium"
                              },
                              {
                                "title": "Low",
                                "value": "Low"
                              },
                              {
                                "title": "Informational",
                                "value": "Informational"
                              },
                              {
                                "title": "Don't change",
                                "value": "same"
                              }
                            ],
                            "id": "incidentSeverity",
                            "style": "compact",
                            "type": "Input.ChoiceSet",
                            "value": "same"
                          }
                        ],
                        "type": "AdaptiveCard",
                        "version": "1.4"
                      }
                    },
                    "Condition_-_Change_Severity": {
                      "actions": {
                        "Update_incident_-_update_severity": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "severity": "@{body('Post_Adaptive_Card_and_wait_for_a_response')?['data']?['incidentSeverity']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Incidents"
                          }
                        }
                      },
                      "runAfter": {
                        "Post_adaptive_card_and_wait_for_a_response": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "not": {
                              "equals": [
                                "@body('Post_Adaptive_Card_and_wait_for_a_response')?['data']?['incidentSeverity']",
                                "same"
                              ]
                            }
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Condition_-_Close_incident": {
                      "actions": {
                        "Update_incident_-_close_incident": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "classification": {
                                "ClassificationAndReason": "@{body('Post_Adaptive_Card_and_wait_for_a_response')?['data']?['incidentStatus']}",
                                "ClassificationReasonText": "User choice from Send Teams adaptive card on incident creation playbook."
                              },
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "status": "Closed"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Incidents"
                          }
                        }
                      },
                      "runAfter": {
                        "Condition_-_Change_Severity": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "not": {
                              "equals": [
                                "@body('Post_Adaptive_Card_and_wait_for_a_response')?['data']?['incidentStatus']",
                                "no"
                              ]
                            }
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Post_adaptive_card_and_wait_for_a_response": {
                      "runAfter": {
                        "Compose_-_Adaptive_card_body": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "body": {
                            "messageBody": "@{outputs('Compose_-_Adaptive_card_body')}",
                            "recipient": {
                              "channelId": "[[parameters('Teams Channel ID')]",
                              "groupId": "[[parameters('Teams Group ID')]"
                            },
                            "updateMessage": "Thanks for your response!"
                          },
                          "notificationUrl": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['teams']['connectionId']"
                          }
                        },
                        "path": "/v1.0/teams/conversation/gatherinput/poster/Flow bot/location/@{encodeURIComponent('Channel')}/$subscriptions"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "microsoftsentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "teams": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                        "connectionName": "[[variables('TeamsConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "Send-Teams-adaptive-card-on-incident-creation",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('TeamsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('TeamsConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId18'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId18')]",
                "contentId": "[variables('_playbookContentId18')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion18')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Send Teams Adaptive Card on incident creation",
            "description": "This playbook will send Microsoft Teams Adaptive Card on incident creation, with the option to change the incident's severity and/or status.",
            "prerequisites": [
              "1. Get Teams Group ID and Teams Channel ID. (instructions available on - https://www.linkedin.com/pulse/3-ways-locate-microsoft-team-id-christopher-barber-/). It is possible to choose Teams group and channel after deployment as well."
            ],
            "postDeployment": [
              "1. Assign Microsoft Sentinel Responder role to the Playbook's Managed Identity.",
              "2. Authorize Microsoft Teams connector."
            ],
            "lastUpdateTime": "2022-08-04T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Send Teams Adaptive Card on incident creation",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId18')]",
        "contentKind": "Playbook",
        "displayName": "Send-Teams-adaptive-card-on-incident-creation",
        "contentProductId": "[variables('_playbookcontentProductId18')]",
        "id": "[variables('_playbookcontentProductId18')]",
        "version": "[variables('playbookVersion18')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AutomationHealthWorkbook Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Have a holistic overview of your automation health, gain insights about failures, correlate Microsoft Sentinel health with Logic Apps diagnostics logs and deep dive automation details per incident"
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"193018ae-9d71-428b-97c9-567bc424b446\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"includeAll\":true,\"showDefault\":false},\"value\":[\"value::all\"]},{\"id\":\"56adbf21-6ff1-472e-a1bc-0080686fac66\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| project id\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::all\"]},{\"id\":\"482be6d3-096d-4546-bbdc-a4bbae626160\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time range\",\"type\":4,\"value\":{\"durationMs\":604800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"28ea2c0a-97e1-4978-b7bd-6de29f7c550b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ShowIntro\",\"label\":\"Show workbook introduction?\",\"type\":10,\"typeSettings\":{\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\\"value\\\": \\\"Yes\\\", \\\"label\\\": \\\"Yes\\\"},\\r\\n    {\\\"value\\\": \\\"No\\\", \\\"label\\\": \\\"No\\\"}\\r\\n]\",\"value\":\"Yes\"},{\"id\":\"f4167f82-9569-42c2-ad15-4c48f5816cfe\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ShowHelp\",\"label\":\"Show help?\",\"type\":10,\"jsonData\":\"[\\r\\n    {\\\"value\\\": \\\"Yes\\\", \\\"label\\\": \\\"Yes\\\"},\\r\\n    {\\\"value\\\": \\\"No\\\", \\\"label\\\": \\\"No\\\"}\\r\\n]\",\"value\":\"Yes\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 0\"},{\"type\":1,\"content\":{\"json\":\"This workbook is utilizing SentinelHealth and AzureDiagnostics tables. Please make sure to enable Sentinel Health for Microsoft Sentinel Automation and Diagnostic settings for each playbook you want to monitor.<br><br><br>\\r\\n\\r\\nSentinel Health table contains the following information:\\r\\n\\r\\n1. Automation rule run<br>\\r\\nAny run of automation rule is logged, except those which their conditions not met hence no action performed.<br>\\r\\nPlaybooks triggered by the automation rules, including trigger status, not including the run result\\r\\n\\r\\n2. Playbook was triggered on demand<br>\\r\\nAny trigger of playbook on an incident from portal or API, including trigger status, not including the run result\\r\\n\\r\\nTo enable Sentinel Health for automation, please go to Microsoft Sentinel -> Settings -> Settings -> Auditing and monitoring. Select Enable to enable health monitoring for all resources, or select Configure diagnostic settings for advanced configuration. Health monitoring includes monitoring of Analytics, Automation, and Data Collection - Connectors. Learn more - https://learn.microsoft.com/azure/sentinel/enable-monitoring.\\r\\n\\r\\nSample KQL to find details:<br>\\r\\nSentinelHealth<br>\\r\\n| where SentinelResourceType in (\\\"Playbook\\\", \\\"Automation rule\\\")\\r\\n<br><br><br><br>\\r\\nAzureDiagnostic table will include specifics about each playbook run, and you can compare playbook trigger data with playbook run data using run ID field that is unique for each playbook run.\\r\\n\\r\\nTo enable diagnostic settings for each playbook you want to monitor, please follow these steps - https://docs.microsoft.com/azure/logic-apps/monitor-logic-apps-log-analytics#set-up-azure-monitor-logs.<br>\\r\\nMake sure to select Send to Log Analytics workspace as destination, and choose your Microsoft Sentinel workspace. \\r\\n\\r\\nSample KQL to find details:<br>\\r\\nAzureDiagnostics<br>\\r\\n| where OperationName = \\\"Microsoft.Logic/workflows/workflowRunCompleted\\\"\\r\\n<br><br><br><br>\\r\\nTables used per tab:<br>\\r\\nAutomation Health - SentinelHealth<br>\\r\\nPlaybook Health (Azure Diagnostics) - AzureDiagnostics<br>\\r\\nPlaybooks run by Autoamtion Rules - SentinelHealth<br>\\r\\nAutoamtion per Incident - SentinelHealth<br>\\r\\nPlaybooks Billable Info - Azure Resource Graph, not relying on Microsoft Sentinel tables<br><br><br>\\r\\n\\r\\nHelp information on how to utilize this workbook is positioned below field where we can show more details.<br>\\r\\nIf you want to show or hide help information, please change parameter 'Show help?' above to 'Yes' or 'No'!<br><br><br>\\r\\n\\r\\nIf you want to hide this introduction page, please change parameter 'Show workbook introduction?' above to 'No'!\",\"style\":\"success\"},\"conditionalVisibility\":{\"parameterName\":\"ShowIntro\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 20\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"21bca600-cdf0-45d3-b8b4-f4fdd4791a27\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Automation Health\",\"subTarget\":\"AutomationHealth\",\"preText\":\"Autmation health\",\"style\":\"link\"},{\"id\":\"9c9519fc-9c40-4329-be20-13bd37bd4400\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Playbook Health (Azure Diagnostics)\",\"subTarget\":\"PlaybookHealthAD\",\"style\":\"link\"},{\"id\":\"55a16002-e96e-4e60-a5d3-27b7798e1451\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Playbooks run by Automation Rules\",\"subTarget\":\"AutomationRulePlaybooks\",\"style\":\"link\"},{\"id\":\"31f4c16a-28bf-4ca6-b12c-2df54e138ee3\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Automation per Incident\",\"subTarget\":\"PerIncident\",\"style\":\"link\"},{\"id\":\"70e4ec13-79cf-4689-b903-117a0d702a42\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Playbooks Billable Info\",\"subTarget\":\"BillableInfo\",\"style\":\"link\"}]},\"name\":\"links - 6\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"Automation rule\\\"\\r\\n| where Status == \\\"Failure\\\"\\r\\n| summarize ['Unsuccessful executions']=count(Status) by ['Display name']=SentinelResourceName\\r\\n| top 5 by ['Unsuccessful executions']\",\"size\":1,\"title\":\"Top 5 failed Automation rules\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"30\",\"name\":\"query - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"Playbook\\\"\\r\\n| where Status == \\\"Failure\\\"\\r\\n| summarize ['Unsuccessful executions']=count(Status) by ['Display name']=SentinelResourceName\\r\\n| top 5 by ['Unsuccessful executions']\",\"size\":1,\"title\":\"Top 5 failed Playbooks on-demand (failed triggers)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"30\",\"name\":\"query - 14\"}]},\"name\":\"Top failed automations\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Automation runs by type\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType in (\\\"Playbook\\\", \\\"Automation rule\\\")\\r\\n| summarize Runs=count(Status) by SentinelResourceType\",\"size\":1,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"20\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType in (\\\"Playbook\\\", \\\"Automation rule\\\")\\r\\n| summarize ['Number of executions']=count(Status) by ['Display name']=SentinelResourceType\",\"size\":4,\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Display name\",\"exportParameterName\":\"SentinelResourceType\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"Number of executions\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"Number of executions\",\"sortOrder\":1}]},\"customWidth\":\"30\",\"name\":\"query - 1\"}],\"exportParameters\":true},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"AutomationHealth\"},\"name\":\"Automation runs\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Automation runs by status for selected type\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"{SentinelResourceType}\\\"\\r\\n| summarize Runs=count(SentinelResourceType) by Status\",\"size\":1,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"20\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"{SentinelResourceType}\\\"\\r\\n| summarize ['Number of executions']=count(SentinelResourceType) by Status\",\"size\":4,\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Status\",\"exportParameterName\":\"Status\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"30\",\"name\":\"query - 2\"},{\"type\":1,\"content\":{\"json\":\"Select Playbook or Automation rule from 'Automation runs by type' to show details.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 2\"}],\"exportParameters\":true},\"name\":\"runs per automation type\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"{SentinelResourceType}\\\"\\r\\n| where Status == \\\"{Status}\\\" or \\\"{Status}\\\" == 'All'\\r\\n| project [\\\"Time generated\\\"]=TimeGenerated, ['Display name']=SentinelResourceName, Description, Reason, ['Extended properties']=ExtendedProperties, ['Workspace ID']=WorkspaceId, ['Record ID']=RecordId\\r\\n| sort by [\\\"Time generated\\\"] desc\",\"size\":0,\"title\":\"List of runs per status\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Record ID\",\"exportParameterName\":\"RecordId\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"query - 3\"},{\"type\":1,\"content\":{\"json\":\"Select Status in 'Automation runs by status for selected type' to show details.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"{SentinelResourceType}\\\"\\r\\n| where RecordId == \\\"{RecordId}\\\" or \\\"{RecordId}\\\" == 'All'\\r\\n| project ['Incident ID']=ExtendedProperties.IncidentNumber, Playbook=SentinelResourceId, Description, Reason, ['Triggered on']=ExtendedProperties.TriggeredOn, ['Triggered by']=ExtendedProperties.TriggeredByName.UserDisplayName, UPN=ExtendedProperties.TriggeredByName.UserPrincipalName, ['Playbook run ID']=ExtendedProperties.RunId\",\"size\":4,\"title\":\"Playbook on-demand run details\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Playbook run ID\",\"exportParameterName\":\"runIdP\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"SentinelResourceType\",\"comparison\":\"isEqualTo\",\"value\":\"Playbook\"},\"name\":\"query - 4\"},{\"type\":1,\"content\":{\"json\":\"Select Playbook from 'List of runs per status' to show details.\",\"style\":\"info\"},\"conditionalVisibilities\":[{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},{\"parameterName\":\"SentinelResourceType\",\"comparison\":\"isEqualTo\",\"value\":\"Playbook\"}],\"name\":\"text - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"Playbook\\\"\\r\\n| extend RunId=tostring(ExtendedProperties.RunId)\\r\\n| where RunId == \\\"{runIdP}\\\"\\r\\n| join (AzureDiagnostics\\r\\n| where OperationName == \\\"Microsoft.Logic/workflows/workflowRunCompleted\\\"\\r\\n| project resource_runId_s, playbookName = resource_workflowName_s, playbookRunStatus = status_s, errorMessage = error_message_s) on\\r\\n$left.RunId == $right.resource_runId_s\\r\\n| project [\\\"Time Generated\\\"]=TimeGenerated, Playbook=SentinelResourceId, [\\\"Run status\\\"]=playbookRunStatus, [\\\"Error message\\\"]=errorMessage, [\\\"Record ID\\\"]=RecordId, [\\\"Run ID\\\"] = RunId\",\"size\":4,\"title\":\"Playbook run details (Azure Diagnostic)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"SentinelResourceType\",\"comparison\":\"isEqualTo\",\"value\":\"Playbook\"},\"name\":\"query - 15\"},{\"type\":1,\"content\":{\"json\":\"Select Playbook from 'Playbook on-demand run details' to show Playbook run detials. Please note that Diagnostic settings must be enabled for selected playbook to see the detials!\",\"style\":\"info\"},\"conditionalVisibilities\":[{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},{\"parameterName\":\"SentinelResourceType\",\"comparison\":\"isEqualTo\",\"value\":\"Playbook\"}],\"name\":\"text - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"{SentinelResourceType}\\\"\\r\\n| where RecordId == \\\"{RecordId}\\\" or \\\"{RecordId}\\\" == 'All'\\r\\n| mv-expand TriggeredPlaybooks = ExtendedProperties.TriggeredPlaybooks\\r\\n| project ['Incident ID']=ExtendedProperties.IncidentNumber, Playbook=tostring(TriggeredPlaybooks.WorkflowId), Description, Reason, ['Triggered on']=ExtendedProperties.TriggeredOn, ['Triggered when']=ExtendedProperties.TriggeredWhen, ['Total actions']=ExtendedProperties.TotalActions, ['Playbook run ID']=tostring(TriggeredPlaybooks.RunId)\",\"size\":4,\"title\":\"Automation rule run details\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Playbook run ID\",\"exportParameterName\":\"runId\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"SentinelResourceType\",\"comparison\":\"isEqualTo\",\"value\":\"Automation rule\"},\"name\":\"query - 5\"},{\"type\":1,\"content\":{\"json\":\"Select Automation rule from 'List of runs per status' to show details.\",\"style\":\"info\"},\"conditionalVisibilities\":[{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},{\"parameterName\":\"SentinelResourceType\",\"comparison\":\"isEqualTo\",\"value\":\"Automation rule\"}],\"name\":\"text - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"Automation rule\\\"\\r\\n| mv-expand TriggeredPlaybooks = ExtendedProperties.TriggeredPlaybooks\\r\\n| extend RunId=tostring(TriggeredPlaybooks.RunId)\\r\\n| where RunId == \\\"{runId}\\\"\\r\\n| join (AzureDiagnostics\\r\\n| where OperationName == \\\"Microsoft.Logic/workflows/workflowRunCompleted\\\"\\r\\n| project resource_runId_s, playbookName = resource_workflowName_s, playbookRunStatus = status_s, errorMessage = error_message_s) on\\r\\n$left.RunId == $right.resource_runId_s\\r\\n| project [\\\"Time Generated\\\"]=TimeGenerated, Playbook=tostring(TriggeredPlaybooks.WorkflowId), [\\\"Run status\\\"]=playbookRunStatus, [\\\"Error message\\\"]=errorMessage, [\\\"Record ID\\\"]=RecordId, [\\\"Run ID\\\"] = RunId\",\"size\":4,\"title\":\"Playbook run details (Azure Diagnostic)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"SentinelResourceType\",\"comparison\":\"isEqualTo\",\"value\":\"Automation rule\"},\"name\":\"query - 14\"},{\"type\":1,\"content\":{\"json\":\"Select Playbook from 'Automation rule run details' to show Playbook run detials. Please note that Diagnostic settings must be enabled for selected playbook to see the detials!\",\"style\":\"info\"},\"conditionalVisibilities\":[{\"parameterName\":\"SentinelResourceType\",\"comparison\":\"isEqualTo\",\"value\":\"Automation rule\"},{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"}],\"name\":\"text - 12\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"AutomationHealth\"},\"name\":\"Automation health\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| extend Owner = tostring(Owner.assignedTo)\\r\\n| summarize arg_max([\\\"Time generated\\\"]=TimeGenerated, Title, Severity, Status, [\\\"Provider name\\\"]=ProviderName, Owner, [\\\"Modified by\\\"]=ModifiedBy, [\\\"Incident URL\\\"]=IncidentUrl, [\\\"Workspace ID\\\"]=TenantId) by [\\\"Incident ID\\\"]=IncidentNumber\\r\\n| sort by [\\\"Incident ID\\\"] desc\",\"size\":0,\"title\":\"List of incidents\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Incident ID\",\"exportParameterName\":\"IncidentNumber\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Incident URL\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}}]}},\"name\":\"query - 7\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Automations run on incident\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType in (\\\"Playbook\\\", \\\"Automation rule\\\")\\r\\n| extend IncidentNo = ExtendedProperties.IncidentNumber\\r\\n| where IncidentNo == \\\"{IncidentNumber}\\\" or \\\"{IncidentNumber}\\\" == 'All'\\r\\n| summarize Runs=count(Status) by SentinelResourceType\\r\\n\",\"size\":1,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"20\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType in (\\\"Playbook\\\", \\\"Automation rule\\\")\\r\\n| extend IncidentNo = ExtendedProperties.IncidentNumber\\r\\n| where IncidentNo == \\\"{IncidentNumber}\\\" or \\\"{IncidentNumber}\\\" == 'All'\\r\\n| summarize ['Number of executions']=count(Status) by ['Display name']=SentinelResourceType\\r\\n\",\"size\":4,\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Display name\",\"exportParameterName\":\"SentinelResourceType2\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"30\",\"name\":\"query - 9\"},{\"type\":1,\"content\":{\"json\":\"Select incident from 'List of incidents' to show details.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 2\"}],\"exportParameters\":true},\"name\":\"Automation run on incident\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Automation run statuses\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"{SentinelResourceType2}\\\" or \\\"{SentinelResourceType2}\\\" == 'All'\\r\\n| extend IncidentNo = tostring(ExtendedProperties.IncidentNumber)\\r\\n| where IncidentNo == \\\"{IncidentNumber}\\\" or \\\"{IncidentNumber}\\\" == 'All'\\r\\n| summarize Runs=count(SentinelResourceType) by Status\",\"size\":4,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"20\",\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"{SentinelResourceType2}\\\"\\r\\n| extend IncidentNo = tostring(ExtendedProperties.IncidentNumber)\\r\\n| where IncidentNo == \\\"{IncidentNumber}\\\" or \\\"{IncidentNumber}\\\" == 'All'\\r\\n| summarize ['Number of executions']=count(SentinelResourceType) by Status\",\"size\":4,\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Status\",\"exportParameterName\":\"Status2\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"20\",\"name\":\"query - 1\"},{\"type\":1,\"content\":{\"json\":\"Select Playbook or Automation rule from 'Automation runs by type' to show details.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 2\"}],\"exportParameters\":true},\"name\":\"status by automation type\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"{SentinelResourceType2}\\\" or \\\"{SentinelResourceType2}\\\" == 'All'\\r\\n| where Status == \\\"{Status2}\\\" or \\\"{Status2}\\\" == 'All'\\r\\n| extend IncidentNo = tostring(ExtendedProperties.IncidentNumber)\\r\\n| where IncidentNo == \\\"{IncidentNumber}\\\" or \\\"{IncidentNumber}\\\" == 'All'\\r\\n| project [\\\"Time generated\\\"]=TimeGenerated, [\\\"Incident ID\\\"]=IncidentNo, ['Display name']=SentinelResourceName, Description, Reason, ['Extended properties']=ExtendedProperties, ['Workspace ID']=WorkspaceId, ['Record ID']=RecordId\\r\\n| sort by [\\\"Time generated\\\"] desc\",\"size\":1,\"title\":\"List of runs per status\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Record ID\",\"exportParameterName\":\"RecordId2\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"query - 10\"},{\"type\":1,\"content\":{\"json\":\"Select Status in 'Automation runs by status for selected type' to show details.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"{SentinelResourceType2}\\\" or \\\"{SentinelResourceType2}\\\" == 'All'\\r\\n| where RecordId == \\\"{RecordId2}\\\" or \\\"{RecordId2}\\\" == 'All'\\r\\n| extend IncidentNo = tostring(ExtendedProperties.IncidentNumber)\\r\\n| where IncidentNo == \\\"{IncidentNumber}\\\" or \\\"{IncidentNumber}\\\" == 'All'\\r\\n| project ['Incident ID']=ExtendedProperties.IncidentNumber, Playbook=SentinelResourceId, Description, Reason, ['Triggered on']=ExtendedProperties.TriggeredOn, ['Triggered by']=ExtendedProperties.TriggeredByName.UserDisplayName, UPN=ExtendedProperties.TriggeredByName.UserPrincipalName, ['Playbook run ID']=ExtendedProperties.RunId\",\"size\":4,\"title\":\"Playbook on-demand run details\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Playbook run ID\",\"exportParameterName\":\"RunIdInc\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"SentinelResourceType2\",\"comparison\":\"isEqualTo\",\"value\":\"Playbook\"},\"name\":\"query - 11\"},{\"type\":1,\"content\":{\"json\":\"Select Playbook from 'List of runs per status' to show details.\",\"style\":\"info\"},\"conditionalVisibilities\":[{\"parameterName\":\"SentinelResourceType2\",\"comparison\":\"isEqualTo\",\"value\":\"Playbook\"},{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"}],\"name\":\"text - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"Playbook\\\"\\r\\n| extend RunId=tostring(ExtendedProperties.RunId)\\r\\n| where RunId == \\\"{RunIdInc}\\\"\\r\\n| join (AzureDiagnostics\\r\\n| where OperationName == \\\"Microsoft.Logic/workflows/workflowRunCompleted\\\"\\r\\n| project resource_runId_s, playbookName = resource_workflowName_s, playbookRunStatus = status_s, errorMessage = error_message_s) on\\r\\n$left.RunId == $right.resource_runId_s\\r\\n| project [\\\"Time generated\\\"]=TimeGenerated, Playbook=SentinelResourceId, [\\\"Run status\\\"]=playbookRunStatus, [\\\"Error message\\\"]=errorMessage, [\\\"Record ID\\\"]=RecordId, [\\\"Run ID\\\"] = RunId\",\"size\":4,\"title\":\"Playbook run details (Azure Diagnostic)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"SentinelResourceType2\",\"comparison\":\"isEqualTo\",\"value\":\"Playbook\"},\"name\":\"query - 21\"},{\"type\":1,\"content\":{\"json\":\"Select Playbook from 'Playbook on-demand run details' to show Playbook run detials. Please note that Diagnostic settings must be enabled for selected playbook to see the detials!\",\"style\":\"info\"},\"conditionalVisibilities\":[{\"parameterName\":\"SentinelResourceType2\",\"comparison\":\"isEqualTo\",\"value\":\"Playbook\"},{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"}],\"name\":\"text - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"{SentinelResourceType2}\\\" or \\\"{SentinelResourceType2}\\\" == 'All'\\r\\n| where RecordId == \\\"{RecordId2}\\\" or \\\"{RecordId2}\\\" == 'All'\\r\\n| extend IncidentNo = tostring(ExtendedProperties.IncidentNumber)\\r\\n| where IncidentNo == \\\"{IncidentNumber}\\\" or \\\"{IncidentNumber}\\\" == 'All'\\r\\n| mv-expand TriggeredPlaybooks = ExtendedProperties.TriggeredPlaybooks\\r\\n| project ['Incident ID']=ExtendedProperties.IncidentNumber, Playbook=tostring(TriggeredPlaybooks.WorkflowId), Description, Reason, ['Triggered on']=ExtendedProperties.TriggeredOn, ['Triggered when']=ExtendedProperties.TriggeredWhen, ['Total actions']=ExtendedProperties.TotalActions, ['Playbook run ID']=tostring(TriggeredPlaybooks.RunId)\",\"size\":1,\"title\":\"Automation rule run details\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Playbook run ID\",\"exportParameterName\":\"RunIdIcAR\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"SentinelResourceType2\",\"comparison\":\"isEqualTo\",\"value\":\"Automation rule\"},\"name\":\"query - 12\"},{\"type\":1,\"content\":{\"json\":\"Select Automation rule from 'List of runs per status' to show details.\",\"style\":\"info\"},\"conditionalVisibilities\":[{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},{\"parameterName\":\"SentinelResourceType2\",\"comparison\":\"isEqualTo\",\"value\":\"Automation rule\"}],\"name\":\"text - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"Automation rule\\\"\\r\\n| mv-expand TriggeredPlaybooks = ExtendedProperties.TriggeredPlaybooks\\r\\n| extend RunId=tostring(TriggeredPlaybooks.RunId)\\r\\n| where RunId == \\\"{RunIdIcAR}\\\"\\r\\n| join (AzureDiagnostics\\r\\n| where OperationName == \\\"Microsoft.Logic/workflows/workflowRunCompleted\\\"\\r\\n| project resource_runId_s, playbookName = resource_workflowName_s, playbookRunStatus = status_s, errorMessage = error_message_s) on\\r\\n$left.RunId == $right.resource_runId_s\\r\\n| project [\\\"Time generated\\\"]=TimeGenerated, Playbook=tostring(TriggeredPlaybooks.WorkflowId), [\\\"Run status\\\"]=playbookRunStatus, [\\\"Error message\\\"]=errorMessage, [\\\"Record ID\\\"]=RecordId, [\\\"Run ID\\\"] = RunId\",\"size\":4,\"title\":\"Playbook run details (Azure Diagnostic)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"SentinelResourceType2\",\"comparison\":\"isEqualTo\",\"value\":\"Automation rule\"},\"name\":\"query - 22\"},{\"type\":1,\"content\":{\"json\":\"Select Playbook from 'Automation rule run details' to show Playbook run detials. Please note that Diagnostic settings must be enabled for selected playbook to see the detials!\",\"style\":\"info\"},\"conditionalVisibilities\":[{\"parameterName\":\"SentinelResourceType2\",\"comparison\":\"isEqualTo\",\"value\":\"Automation rule\"},{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"}],\"name\":\"text - 10\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"PerIncident\"},\"name\":\"Automations per Incident\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType in (\\\"Automation rule\\\")\\r\\n| mv-expand TriggeredPlaybooks = ExtendedProperties.TriggeredPlaybooks\\r\\n| extend Playbooks = \\\"Playbooks\\\"\\r\\n| project AutomationRulePlaybook = tostring(TriggeredPlaybooks.WorkflowId), RunId = tostring(TriggeredPlaybooks.RunId), Playbooks\\r\\n| summarize Runs = count() by Playbooks\\r\\n| project Playbooks, [\\\"Number of executions\\\"]=Runs\",\"size\":4,\"title\":\"Playbooks run by Automation rule\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType in (\\\"Automation rule\\\")\\r\\n| mv-expand TriggeredPlaybooks = ExtendedProperties.TriggeredPlaybooks\\r\\n| project Playbook = tostring(TriggeredPlaybooks.WorkflowId)\\r\\n| summarize Runs=count() by Playbook\\r\\n| project Playbook, [\\\"Number of executions\\\"]=Runs\\r\\n| sort by [\\\"Number of executions\\\"] desc\",\"size\":0,\"title\":\"List of Playbooks run by Automation rules\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Playbook\",\"exportParameterName\":\"PlaybookAR\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"query - 19\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType in (\\\"Automation rule\\\")\\r\\n| mv-expand TriggeredPlaybooks = ExtendedProperties.TriggeredPlaybooks\\r\\n| extend Playbook = tostring(TriggeredPlaybooks.WorkflowId)\\r\\n| where Playbook == \\\"{PlaybookAR}\\\"\\r\\n| project [\\\"Incident ID\\\"] = tostring(ExtendedProperties.IncidentNumber), Playbook, [\\\"Triggered on\\\"] = ExtendedProperties.TriggeredOn, [\\\"Triggered when\\\"] = ExtendedProperties.TriggeredWhen, [\\\"Run ID\\\"] = tostring(TriggeredPlaybooks.RunId)\\r\\n| sort by [\\\"Incident ID\\\"] desc\",\"size\":0,\"title\":\"Selected Playbook runs\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Run ID\",\"exportParameterName\":\"RunIdAR\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"query - 20\"},{\"type\":1,\"content\":{\"json\":\"Select Playbook from 'List of Playbooks run by Automation rules' to show detials.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SentinelHealth\\r\\n| where SentinelResourceType == \\\"Automation rule\\\"\\r\\n| mv-expand TriggeredPlaybooks = ExtendedProperties.TriggeredPlaybooks\\r\\n| extend RunId=tostring(TriggeredPlaybooks.RunId)\\r\\n| where RunId == \\\"{RunIdAR}\\\"\\r\\n| join (AzureDiagnostics\\r\\n| where OperationName == \\\"Microsoft.Logic/workflows/workflowRunCompleted\\\"\\r\\n| project resource_runId_s, playbookName = resource_workflowName_s, playbookRunStatus = status_s, errorMessage = error_message_s) on\\r\\n$left.RunId == $right.resource_runId_s\\r\\n| project [\\\"Time generated\\\"]=TimeGenerated, Playbook=tostring(TriggeredPlaybooks.WorkflowId), [\\\"Run status\\\"]=playbookRunStatus, [\\\"Error message\\\"]=errorMessage, [\\\"Record ID\\\"]=RecordId, [\\\"Run ID\\\"] = RunId\",\"size\":4,\"title\":\"Playbook run details from Azure Diagnostics\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"query - 21\"},{\"type\":1,\"content\":{\"json\":\"Select Playbook run from 'Selected Playbook runs' to show details.  Please note that Diagnostic settings must be enabled for selected playbook to see the detials!\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 5\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"AutomationRulePlaybooks\"},\"name\":\"Playbooks run by Automation rule\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Billable info\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"da74f32a-dad8-412f-8cc9-e1bf53d34dc0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ResourceTypes\",\"label\":\"Resource Types\",\"type\":7,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"isHiddenWhenLocked\":true,\"typeSettings\":{\"includeAll\":true,\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"value\":[\"microsoft.logic/workflows\"]},{\"id\":\"b0d1a353-5581-461d-9450-c0f3274703d2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ResourceGroups\",\"label\":\"Resource groups\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| where type in~ ({ResourceTypes})\\r\\n| summarize Count = count() by subscriptionId, resourceGroup\\r\\n| order by Count desc\\r\\n| extend Rank = row_number()\\r\\n| project value = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup), label = resourceGroup, selected = false\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::all\"]},{\"id\":\"3ec48fee-d642-418e-9be1-2b07d143001f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Resources\",\"label\":\"Playbooks\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| where type in~({ResourceTypes})\\r\\n| extend resourceGroupId = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)\\r\\n| where resourceGroupId in~({ResourceGroups}) or '*' in~({ResourceGroups})\\r\\n| order by name asc\\r\\n| extend Rank = row_number()\\r\\n| project value = id, label = tostring(name), selected = Rank <= 10, group = resourceGroup\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::all\"]}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - Billable Info\"},{\"type\":1,\"content\":{\"json\":\"In this section, you can view billable information regarding your Logic Apps. The data is based on Logic Apps' build-in metrics. To view the list of Logic Apps click the \\\">\\\" icon in the subscription column.\\r\\nBy using the calculator link you can insert the \\\"Total billable executions\\\" to estimate the cost of your Logic Apps.\\r\\nAt the top of the grid, you have the total billable executions for the whole subscription. https://azure.microsoft.com/pricing/details/logic-apps/\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 0\"},{\"type\":10,\"content\":{\"chartId\":\"workbook31acc3db-f123-4d4a-bddb-be95869d14e3\",\"version\":\"MetricsItem/2.0\",\"size\":0,\"chartType\":0,\"resourceType\":\"microsoft.logic/workflows\",\"metricScope\":0,\"resourceParameter\":\"Resources\",\"resourceIds\":[\"{Resources}\"],\"timeContextFromParameter\":\"TimeRange\",\"timeContext\":{\"durationMs\":604800000},\"metrics\":[{\"namespace\":\"microsoft.logic/workflows\",\"metric\":\"microsoft.logic/workflows--BillableTriggerExecutions\",\"aggregation\":1},{\"namespace\":\"microsoft.logic/workflows\",\"metric\":\"microsoft.logic/workflows--BillableActionExecutions\",\"aggregation\":1},{\"namespace\":\"microsoft.logic/workflows\",\"metric\":\"microsoft.logic/workflows--TotalBillableExecutions\",\"aggregation\":1},{\"namespace\":\"microsoft.logic/workflows\",\"metric\":\"microsoft.logic/workflows--RunsStarted\",\"aggregation\":1}],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":\"\",\"showIcon\":true}},{\"columnMatch\":\"Group\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":\"\",\"showIcon\":true}},{\"columnMatch\":\"Subscription\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":\"\",\"showIcon\":true}},{\"columnMatch\":\"Name\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true}},{\"columnMatch\":\"microsoft.logic/workflows--BillableTriggerExecutions\",\"formatter\":1,\"numberFormat\":{\"unit\":0,\"options\":\"\"}},{\"columnMatch\":\"microsoft.logic/workflows--BillableTriggerExecutions Timeline\",\"formatter\":5},{\"columnMatch\":\"microsoft.logic/workflows--BillableActionExecutions\",\"formatter\":1,\"numberFormat\":{\"unit\":0,\"options\":\"\"}},{\"columnMatch\":\"microsoft.logic/workflows--BillableActionExecutions Timeline\",\"formatter\":5},{\"columnMatch\":\"microsoft.logic/workflows--TotalBillableExecutions\",\"formatter\":1,\"numberFormat\":{\"unit\":0,\"options\":\"\"}},{\"columnMatch\":\"microsoft.logic/workflows--TotalBillableExecutions Timeline\",\"formatter\":5},{\"columnMatch\":\"microsoft.logic/workflows--RunsStarted\",\"formatter\":1,\"numberFormat\":{\"unit\":0,\"options\":\"\"}},{\"columnMatch\":\"microsoft.logic/workflows--RunsStarted Timeline\",\"formatter\":5}],\"rowLimit\":10000,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Subscription\"]},\"labelSettings\":[{\"columnId\":\"microsoft.logic/workflows--BillableTriggerExecutions\",\"label\":\"Billable Trigger Executions (Sum)\"},{\"columnId\":\"microsoft.logic/workflows--BillableTriggerExecutions Timeline\",\"label\":\"Billable Trigger Executions Timeline\"},{\"columnId\":\"microsoft.logic/workflows--BillableActionExecutions\",\"label\":\"Billable Action Executions (Sum)\"},{\"columnId\":\"microsoft.logic/workflows--BillableActionExecutions Timeline\",\"label\":\"Billable Action Executions Timeline\"},{\"columnId\":\"microsoft.logic/workflows--TotalBillableExecutions\",\"label\":\"Total Billable Executions (Sum)\"},{\"columnId\":\"microsoft.logic/workflows--TotalBillableExecutions Timeline\",\"label\":\"Total Billable Executions Timeline\"},{\"columnId\":\"microsoft.logic/workflows--RunsStarted\",\"label\":\"Runs Started (Sum)\"},{\"columnId\":\"microsoft.logic/workflows--RunsStarted Timeline\",\"label\":\"Runs Started Timeline\"}]}},\"name\":\"metric - 1\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"BillableInfo\"},\"name\":\"BillableInfo\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Playbook Health\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"da74f32a-dad8-412f-8cc9-e1bf53d34dc0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ResourceTypes\",\"label\":\"Resource Types\",\"type\":7,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"isHiddenWhenLocked\":true,\"typeSettings\":{\"includeAll\":true,\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"value\":[\"microsoft.logic/workflows\"]},{\"id\":\"b0d1a353-5581-461d-9450-c0f3274703d2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ResourceGroups\",\"label\":\"Resource groups\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| where type in~ ({ResourceTypes})\\r\\n| summarize Count = count() by subscriptionId, resourceGroup\\r\\n| order by Count desc\\r\\n| extend Rank = row_number()\\r\\n| project value = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup), label = resourceGroup, selected = false\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::all\"]},{\"id\":\"3ec48fee-d642-418e-9be1-2b07d143001f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Resources\",\"label\":\"Playbooks\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| where type in~({ResourceTypes})\\r\\n| extend resourceGroupId = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)\\r\\n| where resourceGroupId in~({ResourceGroups}) or '*' in~({ResourceGroups})\\r\\n| order by name asc\\r\\n| extend Rank = row_number()\\r\\n| project value = id, label = tostring(name), selected = Rank <= 10, group = resourceGroup\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::5\",\"value::10\",\"value::50\",\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::50\"]}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - Billable Info\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let isResouceMatch=(ResourceToMatch:string){\\r\\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\\\",\\\");\\r\\n    iff(strcat(\\\"\\\",{ResourceGroups}) has \\\"*\\\",true, resourceGroupsText contains strcat(\\\"/resourceGroups/\\\",tolower(ResourceToMatch)))\\r\\n};\\r\\nlet isLAMatch=(LAToMatch:string){\\r\\n    let LAGroupsText = strcat_array(dynamic([{Resources}]),\\\",\\\");\\r\\n    iff(strcat(\\\"\\\",{Resources}) has \\\"*\\\",true, LAGroupsText contains strcat(\\\"/workflows/\\\",tolower(LAToMatch)))\\r\\n};\\r\\n\\r\\nAzureDiagnostics\\r\\n| where ResourceProvider == \\\"MICROSOFT.LOGIC\\\" and isResouceMatch(ResourceGroup) == true \\r\\n| where OperationName startswith \\\"Microsoft.Logic/workflows/workflowRun\\\" and isLAMatch(resource_workflowName_s) == true\\r\\n| make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by status_s\\r\\n|join(\\r\\nAzureDiagnostics\\r\\n| where ResourceProvider == \\\"MICROSOFT.LOGIC\\\" and isResouceMatch(ResourceGroup) == true\\r\\n| where OperationName startswith \\\"Microsoft.Logic/workflows/workflowRun\\\" and isLAMatch(resource_workflowName_s) == true\\r\\n| summarize count() by status_s\\r\\n) on status_s\\r\\n| where status_s != \\\"Running\\\"\\r\\n| order by status_s asc, count_\\r\\n| project status_s,Trend, count_\",\"size\":0,\"title\":\"Success and failure over time\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"status_s\",\"exportParameterName\":\"Status\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"status_s\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Succeeded\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Failed\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Blank\",\"text\":\"{0}{1}\"}]},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":false},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Succeeded\",\"color\":\"green\"},{\"seriesName\":\"Failed\",\"color\":\"red\"}]}},\"customWidth\":\"25\",\"name\":\"Success and failure over time\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let isResouceMatch=(ResourceToMatch:string){\\r\\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\\\",\\\");\\r\\n    iff(strcat(\\\"\\\",{ResourceGroups}) has \\\"*\\\",true, resourceGroupsText contains strcat(\\\"/resourceGroups/\\\",tolower(ResourceToMatch)))\\r\\n};\\r\\nlet isLAMatch=(LAToMatch:string){\\r\\n    let LAGroupsText = strcat_array(dynamic([{Resources}]),\\\",\\\");\\r\\n    iff(strcat(\\\"\\\",{Resources}) has \\\"*\\\",true, LAGroupsText contains strcat(\\\"/workflows/\\\",tolower(LAToMatch)))\\r\\n};\\r\\nAzureDiagnostics\\r\\n| where ResourceProvider == \\\"MICROSOFT.LOGIC\\\" and isResouceMatch(ResourceGroup)==true\\r\\n| where OperationName == \\\"Microsoft.Logic/workflows/workflowRunCompleted\\\"\\r\\n| where isLAMatch(resource_workflowName_s) == true\\r\\n| summarize count() by status_s , bin(TimeGenerated, 1h)\\r\\n\",\"size\":0,\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"TimeBrush\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Succeeded\",\"color\":\"green\"},{\"seriesName\":\"Failed\",\"color\":\"red\"}]}},\"customWidth\":\"75\",\"name\":\"query - 2\"},{\"type\":10,\"content\":{\"chartId\":\"workbook0f967a49-5d61-4b0c-96fc-dbd5646b752d\",\"version\":\"MetricsItem/2.0\",\"size\":0,\"chartType\":0,\"resourceType\":\"microsoft.logic/workflows\",\"metricScope\":0,\"resourceParameter\":\"Resources\",\"resourceIds\":[\"{Resources}\"],\"timeContextFromParameter\":\"TimeBrush\",\"timeContext\":{\"durationMs\":0},\"metrics\":[{\"namespace\":\"microsoft.logic/workflows\",\"metric\":\"microsoft.logic/workflows--RunFailurePercentage\",\"aggregation\":1},{\"namespace\":\"microsoft.logic/workflows\",\"metric\":\"microsoft.logic/workflows--RunsStarted\",\"aggregation\":1},{\"namespace\":\"microsoft.logic/workflows\",\"metric\":\"microsoft.logic/workflows--RunsCompleted\",\"aggregation\":1},{\"namespace\":\"microsoft.logic/workflows\",\"metric\":\"microsoft.logic/workflows--RunLatency\",\"aggregation\":4},{\"namespace\":\"microsoft.logic/workflows\",\"metric\":\"microsoft.logic/workflows--RunsSucceeded\",\"aggregation\":1}],\"title\":\"Failure percentage per Logic App\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Subscription\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":\"\",\"showIcon\":true}},{\"columnMatch\":\"Name\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true}},{\"columnMatch\":\"microsoft.logic/workflows--RunFailurePercentage\",\"formatter\":8,\"formatOptions\":{\"min\":10,\"max\":85,\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"microsoft.logic/workflows--RunFailurePercentage Timeline\",\"formatter\":21,\"formatOptions\":{\"palette\":\"redBright\"}},{\"columnMatch\":\"microsoft.logic/workflows--RunsStarted\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"microsoft.logic/workflows--RunsStarted Timeline\",\"formatter\":5},{\"columnMatch\":\"microsoft.logic/workflows--RunsCompleted\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"microsoft.logic/workflows--RunsCompleted Timeline\",\"formatter\":5},{\"columnMatch\":\"microsoft.logic/workflows--RunLatency\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":24,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"microsoft.logic/workflows--RunLatency Timeline\",\"formatter\":5},{\"columnMatch\":\"microsoft.logic/workflows--RunsSucceeded\",\"formatter\":8,\"formatOptions\":{\"palette\":\"green\"},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"microsoft.logic/workflows--RunsSucceeded Timeline\",\"formatter\":21,\"formatOptions\":{\"palette\":\"green\"}}],\"rowLimit\":10000,\"labelSettings\":[{\"columnId\":\"microsoft.logic/workflows--RunFailurePercentage\",\"label\":\"Run Failure Percentage (Sum)\"},{\"columnId\":\"microsoft.logic/workflows--RunFailurePercentage Timeline\",\"label\":\"Run Failure Percentage Timeline\"},{\"columnId\":\"microsoft.logic/workflows--RunsStarted\",\"label\":\"Runs Started (Sum)\"},{\"columnId\":\"microsoft.logic/workflows--RunsStarted Timeline\",\"label\":\"Runs Started Timeline\"},{\"columnId\":\"microsoft.logic/workflows--RunsCompleted\",\"label\":\"Runs Completed (Sum)\"},{\"columnId\":\"microsoft.logic/workflows--RunsCompleted Timeline\",\"label\":\"Runs Completed Timeline\"},{\"columnId\":\"microsoft.logic/workflows--RunLatency\",\"label\":\"Run Latency (Average)\"},{\"columnId\":\"microsoft.logic/workflows--RunLatency Timeline\",\"label\":\"Run Latency Timeline\"},{\"columnId\":\"microsoft.logic/workflows--RunsSucceeded\",\"label\":\"Runs Succeeded (Sum)\"},{\"columnId\":\"microsoft.logic/workflows--RunsSucceeded Timeline\",\"label\":\"Runs Succeeded Timeline\"}]}},\"name\":\"Failure percentage per Logic App\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let isResouceMatch=(ResourceToMatch:string){\\r\\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\\\",\\\");\\r\\n    iff(strcat(\\\"\\\",{ResourceGroups}) has \\\"*\\\",true, resourceGroupsText contains strcat(\\\"/resourceGroups/\\\",tolower(ResourceToMatch)))\\r\\n};\\r\\nlet isLAMatch=(LAToMatch:string){\\r\\n    let LAGroupsText = strcat_array(dynamic([{Resources}]),\\\",\\\");\\r\\n    iff(strcat(\\\"\\\",{Resources}) has \\\"*\\\",true, LAGroupsText contains strcat(\\\"/workflows/\\\",tolower(LAToMatch)))\\r\\n};\\r\\nAzureDiagnostics\\r\\n| where ResourceProvider == \\\"MICROSOFT.LOGIC\\\" and isResouceMatch(ResourceGroup) == true \\r\\n| where OperationName startswith \\\"Microsoft.Logic/workflows/workflowRunCompleted\\\" and isLAMatch(resource_workflowName_s) == true\\r\\n| where status_s =='{Status}' or '{Status}' =='All'\\r\\n| make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by resource_workflowName_s, status_s, error_code_s\\r\\n|join(\\r\\nAzureDiagnostics\\r\\n| where ResourceProvider == \\\"MICROSOFT.LOGIC\\\" and isResouceMatch(ResourceGroup) == true \\r\\n| where OperationName startswith \\\"Microsoft.Logic/workflows/workflowRunCompleted\\\" and isLAMatch(resource_workflowName_s) == true\\r\\n| where status_s =='{Status}' or '{Status}' =='All'\\r\\n| summarize count() by resource_workflowName_s, status_s, error_code_s,ResourceGroup\\r\\n) on resource_workflowName_s, status_s\\r\\n| order by status_s asc, count_\\r\\n| project ResourceGroup, LogicApp = resource_workflowName_s, Status =status_s, Count = count_, Trend, Error = error_code_s\",\"size\":0,\"showAnalytics\":true,\"title\":\"Playbooks by status\",\"timeContextFromParameter\":\"TimeBrush\",\"exportFieldName\":\"LogicApp\",\"exportParameterName\":\"Logic\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"LogicApp\",\"formatter\":13,\"formatOptions\":{\"linkColumn\":\"LogicApp\",\"linkTarget\":\"Resource\",\"showIcon\":true}},{\"columnMatch\":\"Status\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Succeeded\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Failed\",\"representation\":\"failed\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Skipped\",\"representation\":\"1\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Running\",\"representation\":\"pending\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"gray\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"blue\"}}]}},\"name\":\"Playbooks by status\"},{\"type\":1,\"content\":{\"json\":\"Select Success or Failure in 'Success and failure over time' to show details.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let isResouceMatch=(ResourceToMatch:string){\\r\\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\\\",\\\");\\r\\n    iff(strcat(\\\"\\\",{ResourceGroups}) has \\\"*\\\",true, resourceGroupsText contains strcat(\\\"/resourceGroups/\\\",tolower(ResourceToMatch)))\\r\\n};\\r\\nlet isLAMatch=(LAToMatch:string){\\r\\n    let LAGroupsText = strcat_array(dynamic([{Resources}]),\\\",\\\");\\r\\n    iff(strcat(\\\"\\\",{Resources}) has \\\"*\\\",true, LAGroupsText contains strcat(\\\"/workflows/\\\",tolower(LAToMatch)))\\r\\n};\\r\\n\\r\\nAzureDiagnostics\\r\\n| where ResourceProvider == \\\"MICROSOFT.LOGIC\\\" and isResouceMatch(ResourceGroup) == true \\r\\n| where OperationName startswith \\\"Microsoft.Logic/workflows/workflowTrigger\\\" and isLAMatch(resource_workflowName_s) == true\\r\\n| where resource_workflowName_s =='{Logic}' or '{Logic}' =='All'\\r\\n| make-series Trend = count() on TimeGenerated from {TimeBrush:start} to {TimeBrush:end} step {TimeBrush:grain} by resource_triggerName_s, status_s, resource_workflowName_s\\r\\n|join(\\r\\nAzureDiagnostics\\r\\n| where ResourceProvider == \\\"MICROSOFT.LOGIC\\\" and isResouceMatch(ResourceGroup) == true \\r\\n| where OperationName startswith \\\"Microsoft.Logic/workflows/workflowTrigger\\\" and isLAMatch(resource_workflowName_s) == true\\r\\n| summarize count() by resource_triggerName_s, status_s, resource_workflowName_s\\r\\n) on resource_triggerName_s, status_s, resource_workflowName_s\\r\\n| order by status_s asc, count_\\r\\n| where status_s != \\\"Running\\\" \\r\\n| project Trigger = resource_triggerName_s,LogicAppName = resource_workflowName_s,Status =status_s, Count = count_,Trend\",\"size\":0,\"showAnalytics\":true,\"title\":\"Playbooks' Trigger by status\",\"timeContextFromParameter\":\"TimeBrush\",\"exportFieldName\":\"status_s\",\"exportParameterName\":\"Status\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Status\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Succeeded\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Failed\",\"representation\":\"failed\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Skipped\",\"representation\":\"1\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Running\",\"representation\":\"pending\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"gray\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"blue\"}}]}},\"name\":\"Playbooks' Trigger by status\"},{\"type\":1,\"content\":{\"json\":\"Select Playbook in 'Playbooks by status' to show details.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let isResouceMatch=(ResourceToMatch:string){\\r\\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\\\",\\\");\\r\\n    iff(strcat(\\\"\\\",{ResourceGroups}) has \\\"*\\\",true, resourceGroupsText contains strcat(\\\"/resourceGroups/\\\",tolower(ResourceToMatch)))\\r\\n};\\r\\nlet isLAMatch=(LAToMatch:string){\\r\\n    let LAGroupsText = strcat_array(dynamic([{Resources}]),\\\",\\\");\\r\\n    iff(strcat(\\\"\\\",{Resources}) has \\\"*\\\",true, LAGroupsText contains strcat(\\\"/workflows/\\\",tolower(LAToMatch)))\\r\\n};\\r\\n\\r\\nAzureDiagnostics\\r\\n| where ResourceProvider == \\\"MICROSOFT.LOGIC\\\" and isResouceMatch(ResourceGroup) == true \\r\\n| where OperationName startswith \\\"Microsoft.Logic/workflows/workflowAction\\\" and isLAMatch(resource_workflowName_s) == true\\r\\n| where resource_workflowName_s =='{Logic}' or '{Logic}' =='All'\\r\\n| make-series Trend = count() on TimeGenerated from {TimeBrush:start} to {TimeBrush:end} step {TimeBrush:grain} by Resource, status_s, resource_workflowName_s\\r\\n|join(\\r\\nAzureDiagnostics\\r\\n| where ResourceProvider == \\\"MICROSOFT.LOGIC\\\" and isResouceMatch(ResourceGroup) == true \\r\\n| where OperationName startswith \\\"Microsoft.Logic/workflows/workflowAction\\\" and isLAMatch(resource_workflowName_s) == true\\r\\n| summarize count() by Resource, status_s, resource_workflowName_s\\r\\n) on Resource, status_s, resource_workflowName_s\\r\\n| order by status_s asc, count_\\r\\n| where status_s != \\\"Running\\\"\\r\\n| project Action = Resource, LogicAppName = resource_workflowName_s, Status =status_s, Count = count_, Trend\",\"size\":0,\"showAnalytics\":true,\"title\":\"Playbooks' Action by status\",\"timeContextFromParameter\":\"TimeBrush\",\"exportFieldName\":\"status_s\",\"exportParameterName\":\"Status\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Status\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Succeeded\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Failed\",\"representation\":\"failed\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Skipped\",\"representation\":\"1\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Running\",\"representation\":\"pending\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"gray\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"blue\"}}]}},\"name\":\"Playbooks' Action by status\"},{\"type\":1,\"content\":{\"json\":\"Select Playbook in 'Playbooks by status' to show details.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"ShowHelp\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 9\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"PlaybookHealthAD\"},\"name\":\"PlaybookHealthAD\"}],\"fromTemplateId\":\"sentinel-AutomationHealth\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=AutomationHealth; logoFileName=Azure_Sentinel.svg; description=Have a holistic overview of your automation health, gain insights about failures, correlate Microsoft Sentinel health with Logic Apps diagnostics logs and deep dive automation details per incident; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=2.0.0; title=Automation health; templateRelativePath=AutomationHealth.json; subtitle=; provider=Microsoft Sentinel Community}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "SentinelHealth",
                      "kind": "DataType"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "IncidentOverviewWorkbook Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId2')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "The Incident Overview workbook is designed to assist in triaging and investigation by providing in-depth information about the incident, including:\r\n* General information\r\n* Entity data\r\n* Triage time (time between incident creation and first response)\r\n* Mitigation time (time between incident creation and closing)\r\n* Comments\r\n\r\nCustomize this workbook by saving and editing it. \r\nYou can reach this workbook template from the incidents panel as well. Once you have customized it, the link from the incident panel will open the customized workbook instead of the template.\r\n"
              },
              "properties": {
                "displayName": "[parameters('workbook2-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Incident Overview\"},\"customWidth\":\"35\",\"name\":\"Headline\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"9a199167-2dde-49dd-8f01-23e9d1fa8151\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"InternalWSs\",\"type\":1,\"isRequired\":true,\"query\":\"SecurityIncident\\r\\n| take 1\\r\\n| parse IncidentUrl with * \\\"/workspaces/\\\" Workspace \\\"/\\\" *\\r\\n| project Workspace\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"7806fefd-432f-4828-9756-8c0be5c08d07\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"InternalSub\",\"type\":1,\"isRequired\":true,\"query\":\"SecurityIncident\\r\\n| take 1\\r\\n| parse IncidentUrl with * \\\"/subscriptions/\\\" subscriptions \\\"/\\\" *\\r\\n| project subscriptions\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"55d3ab63-6e1f-4d02-8d9e-2225526689c7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"query\":\"summarize by subscriptionId\\r\\n| project subscriptionId, Subscription=strcat(\\\"/subscriptions/\\\", subscriptionId)\\r\\n| extend selected = iff(subscriptionId =~ '{InternalSub}', true, false)\\r\\n\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":\"\"},{\"id\":\"95a45501-31b5-4ea2-bcb3-eb208e0080e2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"//resources | where type =~ 'Microsoft.operationsmanagement/solutions' | where name contains //'SecurityInsights' | project id //= tostring(properties.workspaceResourceId)\\r\\n\\r\\nwhere type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| project value =id, label = name, selected = iff(name =~ '{InternalWSs}', true, false)\\r\\n\\r\\n\\r\\n\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"showDefault\":false},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"7d597ad7-4a2a-45ed-a4fe-7ee32de0fc22\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Incident Creation Time\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":2592000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000}],\"allowCustom\":true}},{\"id\":\"3a87d4f7-42cc-4c62-b543-6b5d9ab8cf27\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Severity\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| summarize Count = count(IncidentNumber) by Severity\\r\\n| project Value = Severity, Label = strcat(Severity, \\\": \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"81085d3a-5aca-488e-b7c6-ecf1167e59f7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Tactics\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| extend Tactics = todynamic(AdditionalData.tactics)\\r\\n| mv-expand Tactics to typeof(string)\\r\\n| summarize Count=count(IncidentNumber) by Tactics\\r\\n| project Value = Tactics, Label = strcat(Tactics, \\\": \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"0f9efb0d-ac34-41d0-8a19-165840eb2a71\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Owner\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| extend owner = tostring(Owner.assignedTo) \\r\\n| summarize Count=count(IncidentNumber) by Owner= case(owner==\\\"\\\", \\\"Unassigned\\\",owner)\\r\\n| project Value = Owner, Label = strcat(Owner, \\\": \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"cf86113b-59ad-4fc9-aeb7-9b44e230641e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Product\",\"label\":\"Product Name\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| extend Product = tostring(parse_json(tostring(AdditionalData.alertProductNames))[0]) \\r\\n| summarize Count=count(IncidentNumber) by Product\\r\\n| project Value = Product, Label = strcat(Product, \\\": \\\", Count)\\r\\n\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"1fea48e7-99b2-4664-8eb6-bd35fc4efaf0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"resourceGroup\",\"type\":1,\"query\":\"resources\\r\\n| where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| where id == \\\"{Workspace:lable}\\\"\\r\\n| project resourceGroup\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"2908f26a-6238-43ed-9aa0-546c9041d918\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Help\",\"label\":\"Show Help\",\"type\":10,\"isRequired\":true,\"jsonData\":\"[{ \\\"value\\\": \\\"Yes\\\", \\\"label\\\": \\\"Yes\\\"},\\r\\n {\\\"value\\\": \\\"No\\\", \\\"label\\\": \\\"No\\\", \\\"selected\\\":true }]\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"100\",\"name\":\"parameters - 6\"},{\"type\":1,\"content\":{\"json\":\"The Incident Overview workbook is designed to assist in triaging and investigation by providing in-depth information about the incident, including:\\r\\n* General information\\r\\n* Entity data\\r\\n* Triage time (time between incident creation and first response)\\r\\n* Mitigation time (time between incident creation and closing)\\r\\n* Comments\\r\\n* Remediation information from the Alerts or from a Watchlist - setup readme: https://github.com/Azure/Azure-Sentinel/wiki/SOC-Process-Framework\\r\\n\\r\\nCustomize this workbook by saving and editing it. \\r\\nYou can reach this workbook template from the incidents panel as well. Once you have customized it, the link from the incident panel will open the customized workbook instead of the template.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"customWidth\":\"100\",\"name\":\"Info\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Workspace}\"],\"parameters\":[{\"id\":\"9aec751b-07bd-43ba-80b9-f711887dce45\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"IncidentNumber\",\"label\":\"Incident Number\",\"type\":1,\"isRequired\":true,\"value\":\"\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\"},{\"id\":\"9ef1a34d-5c8e-42ad-b1d7-1353e0091060\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"testRemediation\",\"type\":1,\"isRequired\":true,\"query\":\"SecurityIncident\\r\\n| where IncidentNumber == '{IncidentNumber:value}' \\r\\n| summarize arg_max(LastModifiedTime,*) by tostring(IncidentNumber)\\r\\n| extend Alerts = extract(\\\"\\\\\\\\[(.*?)\\\\\\\\]\\\", 1, tostring(AlertIds))\\r\\n| mv-expand AlertIds to typeof(string)\\r\\n| join \\r\\n(\\r\\n    SecurityAlert\\r\\n    | extend Remediation_ = parse_json(RemediationSteps)\\r\\n    | mv-expand Remediation_\\r\\n) on $left.AlertIds == $right.SystemAlertId\\r\\n| summarize  Remediation=make_set(tostring(Remediation_)) by IncidentNumber, Title, Severity\\r\\n| mv-expand Remediation to typeof(string)\\r\\n| project value=iif(isempty(Remediation),'0','1')\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"e5d4131c-43a9-4f92-87c9-dbf647530c9c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"watchListExists\",\"type\":1,\"isRequired\":true,\"query\":\"_GetWatchlist('SocRA')\\r\\n| limit 1\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"parameters - 6 - Copy\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Workspace}\"],\"parameters\":[{\"id\":\"f978edb2-9886-4bff-8e12-8280800321c3\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"IncidentID\",\"label\":\"Incident Name\",\"type\":1,\"query\":\"SecurityIncident\\r\\n| where IncidentNumber == {IncidentNumber}\\r\\n| take 1\\r\\n| project IncidentName\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"3b8e6cdd-4578-49cb-a515-1f9dec104fd7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"RuleId\",\"label\":\"Rule Id\",\"type\":1,\"query\":\"SecurityIncident\\r\\n| where IncidentNumber == {IncidentNumber}\\r\\n| summarize arg_max(TimeGenerated, RelatedAnalyticRuleIds) by IncidentNumber\\r\\n| project RelatedAnalyticRuleIds\",\"crossComponentResources\":[\"{Workspace}\"],\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"IncidentNumber\",\"comparison\":\"isEqualTo\",\"value\":\"e\"},\"customWidth\":\"50\",\"name\":\"Invisible parameters\"},{\"type\":1,\"content\":{\"json\":\"## General Incident Information \"},\"customWidth\":\"67\",\"name\":\"Headline - general info\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let incidentNumberToCheck = '{IncidentNumber}';\\r\\nlet incidentWithNoAlertsQuery = SecurityIncident\\r\\n| where IncidentNumber == incidentNumberToCheck\\r\\n| summarize arg_max(TimeGenerated,CreatedTime,Status, Severity, Owner, AdditionalData, IncidentUrl, Comments, Classification,ClassificationReason, ClassificationComment,Labels, Title, AlertIds) by IncidentNumber\\r\\n| where array_length(AlertIds) == 0\\r\\n| where Severity in ({Severity}) or '{Severity:label}' == \\\"All\\\"\\r\\n| extend Tactics = todynamic(AdditionalData.tactics)\\r\\n| extend Owner = todynamic(Owner.assignedTo), IncidentCreated = format_datetime(CreatedTime,'yy-MM-dd HH:mm')\\r\\n| where Owner in ({Owner}) or '{Owner:label}' == \\\"All\\\"\\r\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0]))\\r\\n| where Product in ({Product}) or '{Product:label}' == \\\"All\\\"\\r\\n| extend Tags = extract_all('labelName\\\":\\\"(.*?)\\\"',tostring(Labels))\\r\\n| extend Owner = case(tostring(Owner)==\\\"\\\", \\\"Unassigned\\\",tostring(Owner)), Products = strcat_array(AdditionalData.alertProductNames, \\\", \\\"), Alerts = tostring(AdditionalData.alertsCount), Bookmarks = tostring(AdditionalData.bookmarksCount), Comments = tostring(AdditionalData.commentsCount), Tactics = strcat_array(AdditionalData.tactics, \\\", \\\"), Labels = strcat_array(Tags, \\\", \\\")\\r\\n;\\r\\nlet incidentWithAlertsQuery = SecurityIncident\\r\\n| where IncidentNumber ==  incidentNumberToCheck\\r\\n| summarize arg_max(TimeGenerated,CreatedTime,Status, Severity, Owner, AdditionalData, IncidentUrl, Comments, Classification,ClassificationReason, ClassificationComment,Labels, Title, AlertIds) by IncidentNumber\\r\\n| where array_length(AlertIds) > 0\\r\\n| where Severity in ({Severity}) or '{Severity:label}' == \\\"All\\\"\\r\\n| extend Tactics = todynamic(AdditionalData.tactics)\\r\\n| extend Owner = todynamic(Owner.assignedTo), IncidentCreated = format_datetime(CreatedTime,'yy-MM-dd HH:mm')\\r\\n| where Owner in ({Owner}) or '{Owner:label}' == \\\"All\\\"\\r\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0]))\\r\\n| where Product in ({Product}) or '{Product:label}' == \\\"All\\\"\\r\\n| extend Tags = extract_all('labelName\\\":\\\"(.*?)\\\"',tostring(Labels))\\r\\n| extend Owner = case(tostring(Owner)==\\\"\\\", \\\"Unassigned\\\",tostring(Owner)), Products = strcat_array(AdditionalData.alertProductNames, \\\", \\\"), Alerts = tostring(AdditionalData.alertsCount), Bookmarks = tostring(AdditionalData.bookmarksCount), Comments = tostring(AdditionalData.commentsCount), Tactics = strcat_array(AdditionalData.tactics, \\\", \\\"), Labels = strcat_array(Tags, \\\", \\\")\\r\\n| mv-expand AlertIds to typeof(string)\\r\\n| join kind=leftouter\\r\\n(SecurityAlert\\r\\n| summarize arg_max(TimeGenerated,AlertName, Description, AlertType, Entities) by SystemAlertId) on $left.AlertIds == $right.SystemAlertId\\r\\n| summarize AlertName = makelist(AlertName), AlertType = makelist(AlertType) by Comments, Labels, Title, Products, AlertsCount = Alerts, Bookmarks, Status, Severity, Owner, IncidentCreated, ClassificationComment, Classification, ClassificationReason\\r\\n| extend AlertNames = strcat_array(AlertName, \\\", \\\"), AlertTypes = strcat_array(AlertType, \\\", \\\")\\r\\n;\\r\\nincidentWithNoAlertsQuery\\r\\n| union incidentWithAlertsQuery\\r\\n| project packed = pack_all()\\r\\n| mv-expand packed\\r\\n| parse tostring(packed) with * '\\\"' Field '\\\":\\\"' Value '\\\"}'\\r\\n| where Field in ('Severity', 'Owner','Status', 'AlertsCount','Products','Title', 'IncidentCreated', 'Labels','Bookmarks', 'AlertNames', 'AlertsType', 'Classification','ClassificationComment','ClassificationReason')\\r\\n| extend Field1 = case(Field== \\\"IncidentCreated\\\", \\\"Time created\\\", Field == \\\"AlertsCount\\\", \\\"Alert count\\\", Field == \\\"ClassificationComment\\\", \\\"Classification Comment\\\", Field == \\\"ClassificationReason\\\", \\\"Classification Reason\\\", Field == \\\"AlertNames\\\", \\\"Alert Names\\\", Field)\\r\\n| extend Order = case(Field==\\\"Title\\\", 1,Field==\\\"IncidentCreated\\\", 2,Field==\\\"Severity\\\", 3,Field==\\\"Status\\\", 4,Field==\\\"Owner\\\", 5,Field==\\\"Products\\\", 6,Field==\\\"AlertsType\\\",6,Field==\\\"AlertsCount\\\", 7,Field==\\\"Bookmarks\\\", 8, Field==\\\"Labels\\\", 9,Field==\\\"Classification\\\", 10,Field==\\\"ClassificationReason\\\",11, 100)\",\"size\":0,\"noDataMessage\":\"Enter an incident number\",\"noDataMessageStyle\":5,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Field1\",\"formatter\":1,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":false}}},\"leftContent\":{\"columnMatch\":\"Value\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"green\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"New\",\"representation\":\"blue\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Active\",\"representation\":\"lightBlue\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Closed\",\"representation\":\"gray\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"text\":\"{0}{1}\"}]}},\"secondaryContent\":{\"columnMatch\":\"Remediation_\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}},\"showBorder\":false,\"sortCriteriaField\":\"Order\",\"sortOrderField\":1,\"size\":\"auto\"}},\"customWidth\":\"67\",\"name\":\"general info\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Closing Classifications of Similar Incidents\"},\"name\":\"Headline - classification\"},{\"type\":1,\"content\":{\"json\":\"Closing classifications of incidents that where created from the same rule in the past month\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"Info - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let alertText =  strcat_array(dynamic([{RuleId}]),\\\",\\\");\\r\\nlet getAmountOfIncidentForRuleId = (classification:string){\\r\\n    SecurityIncident\\r\\n    | where TimeGenerated >= ago(30d)\\r\\n    | where Classification == classification\\r\\n    | mv-expand AlertId=AlertIds\\r\\n    | extend AlertId=tostring(AlertId)\\r\\n    | join  (SecurityAlert| where TimeGenerated >=ago(30d)) on $left.AlertId==$right.SystemAlertId\\r\\n    | mv-expand RuleId=RelatedAnalyticRuleIds\\r\\n    | extend RuleId=iff(ProductName!= 'Azure Sentinel', ProductName,RuleId)\\r\\n    | summarize counter=count() by RuleIdentifier=tostring(RuleId)\\r\\n    | extend RuleId=RuleIdentifier\\r\\n    | project-away RuleIdentifier\\r\\n};\\r\\nlet falsePositiveClassificationTable = getAmountOfIncidentForRuleId(\\\"FalsePositive\\\") | extend FalsePositiveCounter=counter | project-away counter;\\r\\nlet undeterminedClassificationTable = getAmountOfIncidentForRuleId(\\\"Undetermined\\\") | extend UndeterminedCounter=counter | project-away counter;\\r\\nlet benignPositiveClassificationTable = getAmountOfIncidentForRuleId(\\\"BenignPositive\\\") | extend BenignPositiveCounter=counter | project-away counter;\\r\\nlet truePositiveClassificationTable = getAmountOfIncidentForRuleId(\\\"TruePositive\\\") | extend TruePositiveCounter=counter | project-away counter;\\r\\nlet closedIncidentTable = SecurityIncident| where TimeGenerated >= ago(30d) |where Status == \\\"Closed\\\" | mv-expand AlertId=AlertIds| extend AlertId=tostring(AlertId)| join  SecurityAlert on $left.AlertId==$right.SystemAlertId| mv-expand RelatedAnalyticRuleIds| extend RuleId= iff(ProductName == 'Azure Sentinel', tostring(RelatedAnalyticRuleIds), ProductName);\\r\\nlet joinByRuleId = (T:(RuleId:string), S:(RuleId:string)){\\r\\n    T \\r\\n    | join kind=fullouter S on $left.RuleId == $right.RuleId\\r\\n    | extend RuleId= iff(RuleId == '', RuleId1,RuleId)\\r\\n    | project-away RuleId1\\r\\n};\\r\\njoinByRuleId(joinByRuleId(joinByRuleId(joinByRuleId(falsePositiveClassificationTable, undeterminedClassificationTable) , benignPositiveClassificationTable), truePositiveClassificationTable),closedIncidentTable)\\r\\n| join kind=leftouter  (SecurityAlert\\r\\n| where TimeGenerated >= ago(30d)\\r\\n| where ProductName  ==  'Azure Sentinel'\\r\\n| extend RuleId = parsejson( tostring(todynamic(ExtendedProperties)['Analytic Rule Ids']))\\r\\n| mv-expand RuleId=RuleId\\r\\n| extend RuleId=tostring(RuleId)\\r\\n| extend RuleName=  tostring(todynamic(ExtendedProperties)['Analytic Rule Name'])\\r\\n| project RuleId,RuleName\\r\\n| distinct RuleId,RuleName)\\r\\n on $left.RuleId==$right.RuleId\\r\\n| extend RuleName=iff(isempty(RuleName),RuleId,RuleName)\\r\\n| project-away RuleId1\\r\\n| where alertText has RuleId \\r\\n| summarize dcount(IncidentNumber) by Classification\",\"size\":0,\"noDataMessage\":\"No recent closed incident were found\",\"noDataMessageStyle\":4,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Field1\",\"formatter\":1,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},\"leftContent\":{\"columnMatch\":\"Value\",\"formatter\":1},\"showBorder\":false,\"sortCriteriaField\":\"Order\",\"sortOrderField\":1,\"size\":\"auto\"},\"chartSettings\":{\"createOtherGroup\":\"\"}},\"name\":\"Closing classification\"}]},\"customWidth\":\"33\",\"name\":\"Similar\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\" Remediations - click to Open\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":1,\"content\":{\"json\":\"## Recommended Actions\"},\"name\":\"text - 15\"},{\"type\":1,\"content\":{\"json\":\"### Remediations and Actions Help\\r\\nIn this section of the Workbook, which only is visiable if an Alert has remediation entries, the default Remediations that are contained in the Alert data will be shown (Basic view). \\r\\nNote, not all Alerts have this data. \\r\\nHowever you can provide you own set of Alerts mapped to the Alert \\\"Title\\\".  This enhanced feature, uses a Watchlist which has an alias name of: SocRA when you import it (Advanced view).\\r\\n\\r\\n \\r\\n### WatchList Instructions\\r\\n\\r\\n* You must download the Watchlist file called:\\r\\n### SOCAnalystActionsByAlert.csv \\r\\n\\r\\n<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" id=\\\"a75e3f3a-2661-410b-82fb-d300d37dea2d\\\" width=\\\"18\\\" height=\\\"18\\\" viewBox=\\\"0 0 18 18\\\"><defs><linearGradient id=\\\"aff60ddf-eec1-40bf-8bf5-f3e3b50e8818\\\" x1=\\\"9\\\" y1=\\\"16.21\\\" x2=\\\"9\\\" y2=\\\"0.62\\\" gradientUnits=\\\"userSpaceOnUse\\\"><stop offset=\\\"0\\\" stop-color=\\\"#1b93eb\\\"/><stop offset=\\\"0.21\\\" stop-color=\\\"#2095eb\\\"/><stop offset=\\\"0.44\\\" stop-color=\\\"#2e9ced\\\"/><stop offset=\\\"0.69\\\" stop-color=\\\"#45a7ef\\\"/><stop offset=\\\"0.95\\\" stop-color=\\\"#64b6f1\\\"/><stop offset=\\\"1\\\" stop-color=\\\"#6bb9f2\\\"/></linearGradient></defs><title>Icon-security-248</title><path d=\\\"M16,8.44c0,4.57-5.53,8.25-6.73,9a.43.43,0,0,1-.46,0C7.57,16.69,2,13,2,8.44V2.94a.44.44,0,0,1,.43-.44C6.77,2.39,5.78.5,9,.5s2.23,1.89,6.53,2a.44.44,0,0,1,.43.44Z\\\" fill=\\\"#1b93eb\\\"/><path d=\\\"M15.38,8.48c0,4.2-5.07,7.57-6.17,8.25a.4.4,0,0,1-.42,0c-1.1-.68-6.17-4.05-6.17-8.25v-5A.41.41,0,0,1,3,3c3.94-.11,3-1.83,6-1.83S11.05,2.93,15,3a.41.41,0,0,1,.39.4Z\\\" fill=\\\"url(#aff60ddf-eec1-40bf-8bf5-f3e3b50e8818)\\\"/><path d=\\\"M9,6.53A2.88,2.88,0,0,1,11.84,9a.49.49,0,0,0,.49.4h1.4a.49.49,0,0,0,.5-.53,5.26,5.26,0,0,0-10.46,0,.49.49,0,0,0,.5.53h1.4A.49.49,0,0,0,6.16,9,2.88,2.88,0,0,1,9,6.53Z\\\" fill=\\\"#c3f1ff\\\"/><circle cx=\\\"9\\\" cy=\\\"9.4\\\" r=\\\"1.91\\\" fill=\\\"#fff\\\"/></svg>(https://github.com/Azure/Azure-Sentinel/blob/master/docs/SOCAnalystActionsByAlert.csv)\\r\\n \\r\\n * Name the Watchlist alias as:  \\r\\n ### SocRA  \\r\\n * Note: SocRA is case sensitive, you need an uppercase S, R and A.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - ra Help text\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| where IncidentNumber == '{IncidentNumber:value}' \\r\\n| summarize arg_max(LastModifiedTime,*) by tostring(IncidentNumber)\\r\\n| extend Alerts = extract(\\\"\\\\\\\\[(.*?)\\\\\\\\]\\\", 1, tostring(AlertIds))\\r\\n| mv-expand AlertIds to typeof(string)\\r\\n| join \\r\\n(\\r\\n    SecurityAlert\\r\\n    | extend Remediation_ = parse_json(RemediationSteps)\\r\\n    | mv-expand Remediation_\\r\\n) on $left.AlertIds == $right.SystemAlertId\\r\\n| summarize  Remediation=make_set(tostring(Remediation_)) by IncidentNumber, Title, Severity\\r\\n| mv-expand Remediation to typeof(string)\\r\\n// extract URL from the string \\r\\n| extend url_ = iif(Remediation contains 'https://',extract (\\\"https://([a-zA-Z0-9-_://@.?%=&# +]*)\\\",0,tostring(Remediation)),\\\"\\\")\\r\\n| serialize\\r\\n| extend IncidentNumber = iif(prev(IncidentNumber) == IncidentNumber,'',IncidentNumber), Title = iif(prev(Title) == Title,'',Title)\\r\\n\",\"size\":1,\"title\":\"Incident and Remediations - Basic View (from Alert) \",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"green\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Informational\",\"representation\":\"gray\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Remediation\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true},\"tooltipFormat\":{\"tooltip\":\"Click to see more details about the Remediation step\"}},{\"columnMatch\":\"url_\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"\",\"linkIsContextBlade\":false},\"tooltipFormat\":{\"tooltip\":\"Open this link (in another Tab)\"}},{\"columnMatch\":\"entityList\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}}],\"labelSettings\":[{\"columnId\":\"url_\",\"label\":\"URL\",\"comment\":\"Show a URL if available \"}]},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"IncidentNumber\"},\"subtitleContent\":{\"columnMatch\":\"Title\"},\"leftContent\":{\"columnMatch\":\"Remediation\"},\"secondaryContent\":{\"columnMatch\":\"url_\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkIsContextBlade\":false}},\"showBorder\":false},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"IncidentNumber\"},\"leftContent\":{\"columnMatch\":\"Title\"},\"centerContent\":{\"columnMatch\":\"url_\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}},\"hivesContent\":{\"columnMatch\":\"Title\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}},\"nodeIdField\":\"Remediation\",\"sourceIdField\":\"Title\",\"targetIdField\":\"Remediation\",\"graphOrientation\":3,\"showOrientationToggles\":false,\"nodeSize\":\"\",\"staticNodeSize\":100,\"colorSettings\":{\"nodeColorField\":\"url_\",\"type\":1,\"colorPalette\":\"default\"},\"groupByField\":\"Title\",\"hivesMargin\":5}},\"conditionalVisibility\":{\"parameterName\":\"watchListExists\",\"comparison\":\"isEqualTo\"},\"name\":\"query - basic View \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"_GetWatchlist('SocRA')\\r\\n| join\\r\\n  (\\r\\n   SecurityIncident | where IncidentNumber == '{IncidentNumber}' \\r\\n   | summarize arg_max(TimeGenerated, CreatedTime, Status, Severity, Owner, AdditionalData, IncidentUrl, Comments, Classification, ClassificationReason, ClassificationComment, Labels, Title, AlertIds) by IncidentNumber\\r\\n  ) on $left.Alert == $right.Title\\r\\n| project-keep  A*, Status, Severity //, A1, A2, A3, A4, A5, A6, A7, A8, A9, A10, A11, A12, A13, A14, A15, A16, A17, A18, A19\\r\\n| project-reorder Alert, Status, Severity, A* asc\\r\\n| project-away AlertIds, AdditionalData\\r\\n| evaluate narrow()\\r\\n| extend url_ = iif(Value contains 'https://',extract (\\\"https://([a-zA-Z0-9-_://@.?%=&# +]*)\\\",0,Value),\\\"\\\")\\r\\n| extend r = iif(Column startswith 'A', extract(@\\\"\\\\d+\\\",0,tostring(Column)),\\\"\\\")\\r\\n| where isnotempty(Value)\\r\\n| project tostring(Column), RemediationStep =Value, URLtoOpen=url_,toint(r)\\r\\n| order by Column desc, r asc \\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":0,\"title\":\"Incident and Remediations - Advanced View (from Watchlist, \\\"SocRA\\\") Incident Number:{IncidentNumber}\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Remediation\",\"formatter\":18,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true,\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"green\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"text\":\"{0}{1}\"}]},\"tooltipFormat\":{\"tooltip\":\"Click to see more details about the Remediation step\"}},{\"columnMatch\":\"URLtoOpen\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}},{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"green\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Informational\",\"representation\":\"gray\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"url_\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"\",\"linkIsContextBlade\":false},\"tooltipFormat\":{\"tooltip\":\"Open this link (in another Tab)\"}},{\"columnMatch\":\"entityList\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}}],\"filter\":true,\"sortBy\":[{\"itemKey\":\"r\",\"sortOrder\":1}],\"labelSettings\":[{\"columnId\":\"r\",\"label\":\"AlertOrder\"}]},\"sortBy\":[{\"itemKey\":\"r\",\"sortOrder\":1}],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"IncidentNumber\"},\"subtitleContent\":{\"columnMatch\":\"Title\"},\"leftContent\":{\"columnMatch\":\"Remediation\"},\"secondaryContent\":{\"columnMatch\":\"url_\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkIsContextBlade\":false}},\"showBorder\":false},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"IncidentNumber\"},\"leftContent\":{\"columnMatch\":\"Title\"},\"centerContent\":{\"columnMatch\":\"url_\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}},\"hivesContent\":{\"columnMatch\":\"Title\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}},\"nodeIdField\":\"Remediation\",\"sourceIdField\":\"Title\",\"targetIdField\":\"Remediation\",\"graphOrientation\":3,\"showOrientationToggles\":false,\"nodeSize\":\"\",\"staticNodeSize\":100,\"colorSettings\":{\"nodeColorField\":\"url_\",\"type\":1,\"colorPalette\":\"default\"},\"groupByField\":\"Title\",\"hivesMargin\":5}},\"conditionalVisibility\":{\"parameterName\":\"watchListExists\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - advanced View\"}]},\"name\":\"RecActions\"},{\"type\":1,\"content\":{\"json\":\"## Incident Entities\"},\"name\":\"text - 2 - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"method\\\":\\\"POST\\\",\\\"path\\\":\\\"/subscriptions/{Subscription:id}/resourceGroups/{resourceGroup}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/incidents/{IncidentID}/entities\\\",\\\"urlParams\\\":[{\\\"key\\\":\\\"api-version\\\",\\\"value\\\":\\\"2021-04-01\\\"}],\\\"batchDisabled\\\":false,\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.metaData\\\"}}]}\",\"size\":2,\"noDataMessage\":\"No entities were found\",\"noDataMessageStyle\":4,\"queryType\":12,\"visualization\":\"piechart\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"entityKind\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"}},\"leftContent\":{\"columnMatch\":\"count\",\"formatter\":1,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},\"showBorder\":false,\"sortCriteriaField\":\"Order\",\"sortOrderField\":1,\"size\":\"auto\"}},\"customWidth\":\"30\",\"name\":\"Entities\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"method\\\":\\\"POST\\\",\\\"path\\\":\\\"/subscriptions/{Subscription:id}/resourceGroups/{resourceGroup}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/incidents/{IncidentID}/entities\\\",\\\"urlParams\\\":[{\\\"key\\\":\\\"api-version\\\",\\\"value\\\":\\\"2021-04-01\\\"}],\\\"batchDisabled\\\":false,\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.entities\\\",\\\"columns\\\":[{\\\"path\\\":\\\"$.kind\\\",\\\"columnid\\\":\\\"Kind\\\"},{\\\"path\\\":\\\"$.properties.friendlyName\\\",\\\"columnid\\\":\\\"Name\\\"}]}}]}\",\"size\":2,\"noDataMessage\":\"No entities were found\",\"noDataMessageStyle\":4,\"queryType\":12,\"visualization\":\"table\",\"gridSettings\":{\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Kind\"],\"expandTopLevel\":true}},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"kind\",\"formatter\":1,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},\"subtitleContent\":{\"columnMatch\":\"properties\",\"formatter\":1},\"showBorder\":false,\"sortCriteriaField\":\"kind\",\"sortOrderField\":1,\"size\":\"auto\"}},\"customWidth\":\"70\",\"name\":\"Entities List\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Recent activities\"},\"name\":\"text - 2 - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where Severity in ({Severity}) or '{Severity:label}' ==  \\\"All\\\"\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \\\"All\\\"\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or '{Owner:label}' ==  \\\"All\\\"\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or '{Product:label}' ==  \\\"All\\\"\\n| where IncidentNumber == '{IncidentNumber}' or '{IncidentNumber}' ==  ''\\n| order by LastModifiedTime \\n| project LastModifiedTime,IncidentNumber, Title, Product, IncidentUrl, ModifiedBy,Status, Severity, Owner\\n| take 250\\n\\n\\n\",\"size\":1,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"IncidentUrl\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Go to incident >\"}}],\"labelSettings\":[{\"columnId\":\"LastModifiedTime\",\"label\":\"Last Modified Time\"},{\"columnId\":\"IncidentNumber\",\"label\":\"Incident Number\"},{\"columnId\":\"IncidentUrl\",\"label\":\"Link to incident\"},{\"columnId\":\"ModifiedBy\",\"label\":\"Modified By\"}]},\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Column1\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"IncidentNumber\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"name\":\"query - 2 - Copy - Copy - Copy - Copy\"}]},\"name\":\"Incidents tactic over time\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Incident's Comments\"},\"name\":\"text - 2 - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where IncidentNumber == '{IncidentNumber}' or '{IncidentNumber}' ==  ''\\n| summarize arg_max(TimeGenerated,Status, Severity, Owner, AdditionalData, IncidentUrl, Comments) by IncidentNumber\\n| where Severity in ({Severity}) or '{Severity:label}' ==  \\\"All\\\"\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \\\"All\\\"\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or '{Owner:label}' ==  \\\"All\\\"\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or '{Product:label}' ==  \\\"All\\\"\\n| mv-expand Comments to typeof(string)\\n| extend Message = extract('message\\\":\\\"(.*?)\\\"',1,tostring(Comments)), Author = extract('name\\\":\\\"(.*?)\\\"',1,tostring(Comments)), CreatedTimeUTC = extract('createdTimeUtc\\\":\\\"(.*?)\\\"',1,tostring(Comments))\\n| project CreatedTimeUTC, Author, Message, IncidentNumber, Owner\\n| take 250\\n\\n\\n\",\"size\":1,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"IncidentUrl\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Go to incident >\"}}],\"sortBy\":[{\"itemKey\":\"IncidentNumber\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"IncidentNumber\",\"sortOrder\":2}],\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Column1\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"IncidentNumber\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"name\":\"query - 2 - Copy - Copy - Copy - Copy\"}]},\"name\":\"Incidents tactic over time - Copy\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Time to closure\\r\\n\"},\"name\":\"text - 2 - Copy\"},{\"type\":1,\"content\":{\"json\":\"The mean time between the incident creation and first modification by owner\\r\\n\\r\\n\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 2 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where IncidentNumber == '{IncidentNumber}' or '{IncidentNumber}' ==  ''\\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| where Severity in ({Severity}) or '{Severity:label}' ==  \\\"All\\\"\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \\\"All\\\"\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or '{Owner:label}' ==  \\\"All\\\"\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or '{Product:label}' ==  \\\"All\\\"\\n| summarize arg_max(TimeGenerated,Title, ClosedTime, CreatedTime) by IncidentNumber \\n| where isnotnull(ClosedTime)\\n| extend TimeToClosure =  (ClosedTime - CreatedTime)/1h\\n\",\"size\":1,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"series\",\"exportParameterName\":\"Status\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"IncidentNumber\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"TimeToClosure\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":26,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":3}}},\"showBorder\":false}},\"name\":\"query - 2 - Copy\"}]},\"name\":\"Time to mitigate\",\"styleSettings\":{\"margin\":\"0\",\"padding\":\"0\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Time to triage \\r\\n\"},\"name\":\"text - 2 - Copy\"},{\"type\":1,\"content\":{\"json\":\"The mean time between the incident creation and first modification by owner\\r\\n\\r\\n\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 2 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where IncidentNumber == '{IncidentNumber}' or '{IncidentNumber}' ==  ''\\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| where Severity in ({Severity}) or '{Severity:label}' ==  \\\"All\\\"\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \\\"All\\\"\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or '{Owner:label}' ==  \\\"All\\\"\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or '{Product:label}' ==  \\\"All\\\"\\n| where ModifiedBy != 'Incident created from alert'\\n| summarize arg_max(LastModifiedTime,*) by IncidentNumber \\n| where isnotnull(FirstModifiedTime)\\n| extend TimeToTriage =  FirstModifiedTime - CreatedTime\\n| project IncidentNumber, MeanToTriage = TimeToTriage/1h\\n\",\"size\":1,\"timeContext\":{\"durationMs\":94608000000,\"endTime\":\"2023-06-01T17:13:00Z\"},\"exportFieldName\":\"series\",\"exportParameterName\":\"Status\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"IncidentNumber\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"MeanToTriage\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":26,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":3}}},\"showBorder\":false}},\"name\":\"query - 2 - Copy\"}]},\"name\":\"Time to close\",\"styleSettings\":{\"margin\":\"0\",\"padding\":\"0\"}}],\"fromTemplateId\":\"sentinel-IncidentOverview\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId2'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=IncidentOverview; logoFileName=Azure_Sentinel.svg; description=The Incident Overview workbook is designed to assist in triaging and investigation by providing in-depth information about the incident, including:\r\n* General information\r\n* Entity data\r\n* Triage time (time between incident creation and first response)\r\n* Mitigation time (time between incident creation and closing)\r\n* Comments\r\n\r\nCustomize this workbook by saving and editing it. \r\nYou can reach this workbook template from the incidents panel as well. Once you have customized it, the link from the incident panel will open the customized workbook instead of the template.\r\n; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=2.1.0; title=Incident overview; templateRelativePath=IncidentOverview.json; subtitle=; provider=Microsoft}.description",
                "parentId": "[variables('workbookId2')]",
                "contentId": "[variables('_workbookContentId2')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "SecurityAlert",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "SecurityIncident",
                      "kind": "DataType"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId2')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook2-name')]",
        "contentProductId": "[variables('_workbookcontentProductId2')]",
        "id": "[variables('_workbookcontentProductId2')]",
        "version": "[variables('workbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SecurityOperationsEfficiencyWorkbook Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId3')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Security operations center managers can view overall efficiency metrics and measures regarding the performance of their team. They can find operations by multiple indicators over time including severity, MITRE tactics, mean time to triage, mean time to resolve and more. The SOC manager can develop a picture of the performance in both general and specific areas over time and use it to improve efficiency."
              },
              "properties": {
                "displayName": "[parameters('workbook3-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Security Operations Efficiency\"},\"customWidth\":\"35\",\"name\":\"Main headline\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"9a199167-2dde-49dd-8f01-23e9d1fa8151\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"InternalWSs\",\"type\":1,\"isRequired\":true,\"query\":\"SecurityIncident\\r\\n| take 1\\r\\n| parse IncidentUrl with * \\\"/workspaces/\\\" Workspace \\\"/\\\" *\\r\\n| project Workspace\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"7806fefd-432f-4828-9756-8c0be5c08d07\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"InternalSub\",\"type\":1,\"isRequired\":true,\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| take 1\\r\\n| project subscriptionId\",\"crossComponentResources\":[\"value::selected\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"55d3ab63-6e1f-4d02-8d9e-2225526689c7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"query\":\"Resources\\r\\n| summarize Count = count() by subscriptionId\\r\\n| order by Count desc\\r\\n| extend Rank = row_number()\\r\\n| project value = subscriptionId, label = subscriptionId, selected = Rank == 1\",\"crossComponentResources\":[\"value::selected\"],\"typeSettings\":{\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"95a45501-31b5-4ea2-bcb3-eb208e0080e2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"//resources | where type =~ 'Microsoft.operationsmanagement/solutions' | where name contains //'SecurityInsights' | project id //= tostring(properties.workspaceResourceId)\\r\\n\\r\\nwhere type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| project value =id, label = name, selected = iff(name =~ '{InternalWSs}', true, false)\\r\\n\\r\\n\\r\\n\",\"crossComponentResources\":[\"value::all\"],\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"7d597ad7-4a2a-45ed-a4fe-7ee32de0fc22\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Incident Creation Time\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":2592000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000}],\"allowCustom\":true}},{\"id\":\"3a87d4f7-42cc-4c62-b543-6b5d9ab8cf27\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Severity\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| summarize Count = count(IncidentNumber) by Severity\\r\\n| project Value = Severity, Label = strcat(Severity, \\\": \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"81085d3a-5aca-488e-b7c6-ecf1167e59f7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Tactics\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| extend Tactics = todynamic(AdditionalData.tactics)\\r\\n| mvexpand Tactics to typeof(string)\\r\\n| summarize Count=count(IncidentNumber) by Tactics\\r\\n| project Value = Tactics, Label = strcat(Tactics, \\\": \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"0f9efb0d-ac34-41d0-8a19-165840eb2a71\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Owner\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| extend owner = tostring(Owner.assignedTo) \\r\\n| summarize Count=count(IncidentNumber) by Owner= case(owner==\\\"\\\", \\\"Unassigned\\\",owner)\\r\\n| project Value = Owner, Label = strcat(Owner, \\\": \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"cf86113b-59ad-4fc9-aeb7-9b44e230641e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Product\",\"label\":\"Product Name\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| extend Product = tostring(parse_json(tostring(AdditionalData.alertProductNames))[0]) \\r\\n| summarize Count=count(IncidentNumber) by Product\\r\\n| project Value = Product, Label = strcat(Product, \\\": \\\", Count)\\r\\n\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"baa92cd2-7ade-41c3-a07c-a11f5ce3e0e6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Help\",\"label\":\"Show Help\",\"type\":10,\"isRequired\":true,\"jsonData\":\"[{ \\\"value\\\": \\\"Yes\\\", \\\"label\\\": \\\"Yes\\\"},\\r\\n {\\\"value\\\": \\\"No\\\", \\\"label\\\": \\\"No\\\", \\\"selected\\\":true }]\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"customWidth\":\"100\",\"name\":\"parameters - 6\"},{\"type\":1,\"content\":{\"json\":\"## Incidents created over time\"},\"customWidth\":\"67\",\"name\":\"Incidents over time - headline\"},{\"type\":1,\"content\":{\"json\":\"## Incidents by closing classification\"},\"customWidth\":\"32\",\"name\":\"Incidents by classification - headline\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident \\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| summarize arg_max(TimeGenerated, Status, Severity, Owner, AdditionalData,CreatedTime) by IncidentNumber\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize count() by bin(CreatedTime, 1h)\\n\\n\\n\\n\",\"size\":1,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"TimeBrush\",\"exportFieldName\":\"CreatedTime\",\"exportParameterName\":\"TimePicker\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"unstackedbar\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"CreatedTime\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"CreatedTime\",\"sortOrder\":2}],\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"count_\",\"label\":\"Incidents\"}]}},\"customWidth\":\"67\",\"name\":\"Incidents over time \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where CreatedTime >= {TimeBrush:start} and CreatedTime <= {TimeBrush:end}\\n| where Status == 'Closed'\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| extend feedback =strcat(Classification,\\\" \\\",ClassificationReason)\\n| summarize dcount(IncidentNumber) by feedback\\n\",\"size\":1,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"Incidents by classification - headline\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident \\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| summarize arg_max(TimeGenerated,Status, Severity, Owner, AdditionalData) by IncidentNumber\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize dcount(IncidentNumber) by Severity\",\"size\":1,\"title\":\"Incidents created by severity\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Classification\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"dcount_IncidentNumber\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Informational\",\"color\":\"gray\"},{\"seriesName\":\"Low\",\"color\":\"yellow\"},{\"seriesName\":\"Medium\",\"color\":\"orange\"},{\"seriesName\":\"High\",\"color\":\"red\"}]}},\"customWidth\":\"22\",\"name\":\"By severity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| summarize arg_max(TimeGenerated, Status, Severity, Owner, AdditionalData) by IncidentNumber\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize count() by case(tostring(Owner)==\\\"\\\", \\\"Unassigned\\\",tostring(Owner))\\n\\n\",\"size\":1,\"title\":\"Incidents created by owner\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Classification\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"dcount_IncidentNumber\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"22\",\"name\":\"By owner\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| summarize arg_max(TimeGenerated, Status, Severity, Owner, AdditionalData) by IncidentNumber\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize count() by Status\\n\",\"size\":1,\"title\":\"Incidents created by status\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Classification\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"dcount_IncidentNumber\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"22\",\"name\":\"By status\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"Time to triage, is the time between the incident creation and its first update.\",\"style\":\"info\"},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"Help1\"},{\"type\":1,\"content\":{\"json\":\"Time to closure, is the time between the incident creation and its last closure.\",\"style\":\"info\"},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"Help1 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where FirstModifiedTime  >= {TimeRange:start} and FirstModifiedTime  <= {TimeRange:end}\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize arg_max(LastModifiedTime,*) by IncidentNumber \\n| extend TimeToTriage =  (FirstModifiedTime - CreatedTime)/1h\\n| summarize AvgTTT=avg(TimeToTriage) \\n\",\"size\":1,\"title\":\"Mean time to triage\",\"timeContext\":{\"durationMs\":94608000000,\"endTime\":\"2023-06-01T16:58:00Z\"},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"formatter\":1},\"leftContent\":{\"columnMatch\":\"AvgTTT\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":26,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":3}}},\"showBorder\":false,\"size\":\"auto\"}},\"customWidth\":\"50\",\"name\":\"MTTT\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where ClosedTime >= {TimeRange:start} and ClosedTime <= {TimeRange:end}\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize arg_max(TimeGenerated,*) by IncidentNumber \\n| extend TimeToClosure =  (ClosedTime - CreatedTime)/1h\\n| summarize AvgTTC=avg(TimeToClosure)\",\"size\":1,\"title\":\"Mean time to closure \",\"timeContext\":{\"durationMs\":94608000000,\"endTime\":\"2023-06-01T16:33:00Z\"},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Classification\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"AvgTTC\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":26,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":3}}},\"showBorder\":false,\"size\":\"auto\"}},\"customWidth\":\"50\",\"name\":\"MTTM\"}]},\"customWidth\":\"34\",\"name\":\"Mean times\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Incidents created by severity over time \"},\"name\":\"text - 2 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident \\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize Incidents=dcount(IncidentNumber) by Severity, bin(CreatedTime, 1d)\",\"size\":1,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"name\":\"query - 2 - Copy - Copy\"}]},\"name\":\"Incidents severity over time\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Incidents created by owner over time \"},\"name\":\"text - 2 - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident \\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize Incidents=dcount(IncidentNumber) by case(tostring(Owner)==\\\"\\\", \\\"Unassigned\\\",tostring(Owner)), bin(CreatedTime, 1d)\\n\",\"size\":1,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"name\":\"query - 2 - Copy - Copy - Copy\"}]},\"name\":\"Incident owner over time\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Incidents created by status over time\"},\"name\":\"text - 2 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident \\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize Incidents=dcount(IncidentNumber) by Status, bin(CreatedTime, 1d)\",\"size\":1,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"series\",\"exportParameterName\":\"Status\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"name\":\"query - 2 - Copy\"}]},\"name\":\"Incident status over time\",\"styleSettings\":{\"margin\":\"0\",\"padding\":\"0\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Incidents created by product over time\"},\"name\":\"text - 2 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident \\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize Incidents=dcount(IncidentNumber) by tostring(Product), bin(CreatedTime, 1d)\",\"size\":1,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"series\",\"exportParameterName\":\"Status\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"name\":\"query - 2 - Copy\"}]},\"name\":\"Incident status over time - Copy\",\"styleSettings\":{\"margin\":\"0\",\"padding\":\"0\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Incidents created by tactics over time \"},\"name\":\"text - 2 - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident \\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| mvexpand Tactics to typeof(string)\\n| summarize Incidents=dcount(IncidentNumber) by Tactics, bin(CreatedTime, 1d)\",\"size\":1,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"unstackedbar\"},\"name\":\"query - 2 - Copy - Copy - Copy - Copy\"}]},\"name\":\"Incidents tactic over time\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Incidents created by tags over time \"},\"name\":\"text - 2 - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident \\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| extend Tags = extract_all('labelName\\\":\\\"(.*?)\\\"',tostring(Labels))\\n| mvexpand Tags to typeof(string)\\n| summarize Incidents=dcount(IncidentNumber) by Tags, bin(CreatedTime, 1d)\",\"size\":1,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"unstackedbar\"},\"name\":\"query - 2 - Copy - Copy - Copy - Copy\"}]},\"name\":\"Incidents tactic over time - Copy\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Incidents created by name\"},\"name\":\"text - 2 - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident \\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| summarize arg_max(TimeGenerated, Status, Severity, Owner, AdditionalData,CreatedTime) by IncidentNumber, Title\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize count() by bin(CreatedTime, 1h), Title\\n| order by count_ desc\",\"size\":1,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"name\":\"query - 2 - Copy - Copy - Copy - Copy\"}]},\"name\":\"Incidents tactic over time - Copy - Copy\"}]},\"customWidth\":\"50\",\"name\":\"Over time left panel\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Time to triage (percentiles)\"},\"name\":\"text - 2 - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"Time to triage, is the time between the incident creation and its first update.\",\"style\":\"info\"},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"Help2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where FirstModifiedTime  >= {TimeRange:start} and FirstModifiedTime  <= {TimeRange:end}\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize arg_max(LastModifiedTime,*) by IncidentNumber \\n| extend TimeToTriage =  (FirstModifiedTime - CreatedTime)/1h\\n| summarize 5th_Percentile=max_of(percentile(TimeToTriage, 5),0),50th_Percentile=percentile(TimeToTriage, 50), 90th_Percentile=percentile(TimeToTriage, 90),99th_Percentile=percentile(TimeToTriage, 99) by bin(FirstModifiedTime, 1d)\\n\",\"size\":1,\"aggregation\":3,\"timeContext\":{\"durationMs\":94608000000,\"endTime\":\"2023-06-01T16:45:00Z\"},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":26,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":3}}}}},\"name\":\"query - 2 - Copy - Copy\"}]},\"name\":\"Incidents severity over time\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Time to closure (percentiles)\\r\\n\"},\"name\":\"text - 2 - Copy - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"Time to closure, is the time between the incident creation and its last closure.\",\"style\":\"info\"},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"Help3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where ClosedTime  >= {TimeRange:start} and ClosedTime  <= {TimeRange:end}\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize arg_max(LastModifiedTime,*) by IncidentNumber \\n| extend TimeToClosure =  (ClosedTime - CreatedTime)/1h\\n| summarize 5th_Percentile=percentile(TimeToClosure, 5),50th_Percentile=percentile(TimeToClosure, 50), 90th_Percentile=percentile(TimeToClosure, 90),99th_Percentile=percentile(TimeToClosure, 99) by bin(ClosedTime, 1d)\\n\",\"size\":1,\"aggregation\":3,\"timeContext\":{\"durationMs\":94608000000,\"endTime\":\"2023-06-01T16:47:00Z\"},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"percentile_MinToTriage_5\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"percentile_MinToTriage_5\",\"sortOrder\":2}],\"tileSettings\":{\"showBorder\":false},\"chartSettings\":{\"ySettings\":{\"numberFormatSettings\":{\"unit\":26,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":3}},\"min\":0}}},\"name\":\"query - 2 - Copy - Copy - Copy\"}]},\"name\":\"Incident owner over time\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Mean time to closure per owner\\r\\n\"},\"name\":\"text - 2 - Copy\"},{\"type\":1,\"content\":{\"json\":\"The mean time between the incident creation and last closure by owner\",\"style\":\"info\"},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"Help3 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where CreatedTime >= {TimeBrush:start} and CreatedTime <= {TimeBrush:end}\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n|where Status == 'Closed'  \\n| extend Ownerr = case(tostring(Owner)==\\\"\\\", \\\"Unassigned\\\",tostring(Owner))\\n| summarize arg_min(LastModifiedTime,*) by IncidentNumber, Owner = Ownerr\\n| extend TimeToTriage = LastModifiedTime - CreatedTime, Owner\\n| summarize avg(TimeToTriage/1h) by Owner\\n\",\"size\":4,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"series\",\"exportParameterName\":\"Status\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Owner\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"avg_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":26,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":3}}},\"showBorder\":false}},\"name\":\"query - 2 - Copy\"}]},\"name\":\"Incident status over time\",\"styleSettings\":{\"margin\":\"0\",\"padding\":\"0\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Mean time to triage per owner\\r\\n\"},\"name\":\"text - 2 - Copy\"},{\"type\":1,\"content\":{\"json\":\"The mean time between the incident creation and first modification by owner\",\"style\":\"info\"},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"Help3 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize arg_max(FirstModifiedTime,*) by IncidentNumber \\n| extend TimeToTriage =  FirstModifiedTime - CreatedTime\\n| extend MinToTriage = TimeToTriage/1h\\n| summarize avg(TimeToTriage/1h) by owner=case(tostring(Owner)==\\\"\\\", \\\"Unassigned\\\",tostring(Owner))\\n\\n\",\"size\":4,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"series\",\"exportParameterName\":\"Status\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"owner\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"avg_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":26,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":3}}},\"showBorder\":false}},\"name\":\"query - 2 - Copy\"}]},\"name\":\"Incident status triage\",\"styleSettings\":{\"margin\":\"0\",\"padding\":\"0\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Actions per user\"},\"name\":\"text - 2 - Copy\"},{\"type\":1,\"content\":{\"json\":\"The number of actions taken on incidents per incident modifier\",\"style\":\"info\"},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"Help3 - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where CreatedTime >= {TimeBrush:start} and CreatedTime <= {TimeBrush:end}\\n| where ModifiedBy !in(\\\"Alert Grouping\\\",\\\"Fusion\\\",\\\"Incident created from alert\\\")\\n| where ModifiedBy !contains(\\\"Automation rule\\\")\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| summarize count() by ModifiedBy\\n\",\"size\":4,\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"series\",\"exportParameterName\":\"Status\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ModifiedBy\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":false,\"sortCriteriaField\":\"count_\",\"sortOrderField\":2}},\"name\":\"query - 2 - Copy\"}]},\"name\":\"Incident status over time - Copy\",\"styleSettings\":{\"margin\":\"0\",\"padding\":\"0\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Recent activities\"},\"name\":\"text - 2 - Copy - Copy - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"Most recent activities taken on incidents\",\"style\":\"info\"},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"Help3 - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| order by LastModifiedTime \\n| project LastModifiedTime,IncidentNumber, Title, Product, IncidentUrl, ModifiedBy,Status, Severity, Owner\\n| take 250\\n\\n\\n\",\"size\":1,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"IncidentUrl\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Go to incident >\"}}],\"labelSettings\":[{\"columnId\":\"LastModifiedTime\",\"label\":\"Last Modified Time\"},{\"columnId\":\"IncidentNumber\",\"label\":\"Incident Number\"},{\"columnId\":\"Title\"},{\"columnId\":\"Product\"},{\"columnId\":\"IncidentUrl\",\"label\":\"Link to incident\"},{\"columnId\":\"ModifiedBy\",\"label\":\"Modified By\"},{\"columnId\":\"Status\"},{\"columnId\":\"Severity\"}]},\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Column1\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"IncidentNumber\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"name\":\"query - 2 - Copy - Copy - Copy - Copy\"}]},\"name\":\"Incidents tactic over time - Copy\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Recent incident closing classification\"},\"name\":\"text - 2 - Copy - Copy - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"Recent closing classifications and comments of incidents\",\"style\":\"info\"},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"Help3 - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| extend Tactics = todynamic(AdditionalData.tactics)\\n| where Tactics in ({Tactics}) or \\\"*\\\" in ({Tactics})\\n| extend Owner = todynamic(Owner.assignedTo) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\n| where Product in ({Product}) or \\\"*\\\" in ({Product})\\n| where Status == 'Closed'\\n| order by LastModifiedTime \\n| project LastModifiedTime,IncidentNumber, Title, Classification, ClassificationReason,ClassificationComment, Product, IncidentUrl, ModifiedBy,Status, Severity,Owner\\n| take 250\\n\\n\\n\",\"size\":1,\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"IncidentUrl\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Go to incident >\"}}],\"labelSettings\":[{\"columnId\":\"LastModifiedTime\",\"label\":\"Last Modified Time\"},{\"columnId\":\"IncidentNumber\",\"label\":\"Incident Number\"},{\"columnId\":\"Title\"},{\"columnId\":\"Classification\"},{\"columnId\":\"ClassificationReason\",\"label\":\"Classification Reason\"},{\"columnId\":\"ClassificationComment\",\"label\":\"Classification Comment\"},{\"columnId\":\"Product\"},{\"columnId\":\"IncidentUrl\",\"label\":\"Link to incident\"},{\"columnId\":\"ModifiedBy\",\"label\":\"Modified By\"},{\"columnId\":\"Status\"},{\"columnId\":\"Severity\"}]},\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Column1\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"IncidentNumber\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"name\":\"query - 2 - Copy - Copy - Copy - Copy\"}]},\"name\":\"Incidents tactic over time - Copy\"}]},\"customWidth\":\"50\",\"name\":\"Over time right panel\"}],\"fromTemplateId\":\"sentinel-SecurityOperationsEfficiency\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId3'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=SecurityOperationsEfficiency; logoFileName=Azure_Sentinel.svg; description=Security operations center managers can view overall efficiency metrics and measures regarding the performance of their team. They can find operations by multiple indicators over time including severity, MITRE tactics, mean time to triage, mean time to resolve and more. The SOC manager can develop a picture of the performance in both general and specific areas over time and use it to improve efficiency.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.5.0; title=Security Operations Efficiency; templateRelativePath=SecurityOperationsEfficiency.json; subtitle=; provider=Microsoft}.description",
                "parentId": "[variables('workbookId3')]",
                "contentId": "[variables('_workbookContentId3')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "SecurityAlert",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "SecurityIncident",
                      "kind": "DataType"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId3')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook3-name')]",
        "contentProductId": "[variables('_workbookcontentProductId3')]",
        "id": "[variables('_workbookcontentProductId3')]",
        "version": "[variables('workbookVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "IncidentTasksWorkbookWorkbook Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion4')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId4')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Use this workbook to review and modify existing incidents with tasks. This workbook provides views that higlight incident tasks that are open, closed, or deleted, as well as incidents with tasks that are either owned or unassigned. The workbook also provides SOC metrics around incident task performance, such as percentage of incidents without tasks, average time to close tasks, and more."
              },
              "properties": {
                "displayName": "[parameters('workbook4-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"\"],\"parameters\":[{\"id\":\"b747fcd2-3083-4db5-b417-bb3d20d12bb2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"query\":\"resources\\r\\n| where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| project id, name\",\"crossComponentResources\":[\"value::selected\"],\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":\"\"},{\"id\":\"31433d20-d3a7-4fc4-ada7-974de005b1a9\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Time\",\"type\":4,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":2592000000}},{\"id\":\"17ea99e0-281a-4fba-91d7-41f60dbe644d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Help\",\"type\":10,\"isRequired\":true,\"jsonData\":\"[\\\"Yes\\\", \\\"No\\\"]\",\"value\":\"No\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 1\"},{\"type\":1,\"content\":{\"json\":\"### Help\\r\\n\\r\\nThis workbook is meant to highlight tasks and incidents with tasks. The workbook is broken up into two main sections: </br>\\r\\n- Incident view: The view that will highlight incidents with tasks that are open, closed, or deleted, as well as who is owning incidents with tasks.\\r\\n- Metric view: The view that will highlight metrics around SOC performance with tasks that may provide insights into what is working well vs. not well.\\r\\n\\r\\n\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 4\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"2ea9d7ae-e260-407b-8f46-52cd14f08999\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Incident View\",\"subTarget\":\"1\",\"style\":\"link\",\"tabWidth\":\"500px\"},{\"id\":\"fbfea602-d24d-4fa8-ac8d-21d8db3d31c5\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Metric View\",\"subTarget\":\"2\",\"style\":\"link\",\"tabWidth\":\"500px\"}]},\"name\":\"links - 4\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"c79f5958-de0b-49c9-a4a3-5bae1fd834a4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Filter\",\"label\":\"Filter By\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"showDefault\":false},\"jsonData\":\"[\\\"Incident\\\", \\\"Owner\\\"]\",\"timeContext\":{\"durationMs\":86400000},\"value\":\"Owner\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 3\"},{\"type\":1,\"content\":{\"json\":\"### Help\\r\\n\\r\\n*If using the Incident view* </br>\\r\\nThis view will show the latest 250 incidents that have or have had tasks. Incidents are grouped together by title to help show which are most common. Incidents are arranged in the amount of time open from oldest to newest.\\r\\n\\r\\n*If using the Owner view*</br>\\r\\nThis view will show both unassigned incidents that contain tasks and incidents that are owned. Incidents that are unassigned are grouped by title while the owned incidents are grouped by owner.</br>\\r\\n\\r\\nTo see task details on an incident: </br>\\r\\n1. Click on the arrow next to a title to expand the group.\\r\\n2. Click on the arrow next to the incident number to expand the log for the incident.\\r\\n3. Click on the incident log to populate the task information below the incident list.\\r\\n4. Review the tasks information in the sections below.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| summarize arg_max(TimeGenerated,*) by tostring(IncidentNumber)\\r\\n| extend TimeOpen = datetime_diff('minute', now(), CreatedTime)\\r\\n| project IncidentNumber, Title, Description, TimeGenerated, Severity, Status, TimeOpen, Tasks, TaskCount = array_length(Tasks), ProviderName, IncidentName\\r\\n| where Status != 'Closed'\\r\\n| where TaskCount > 0\\r\\n| order by TimeOpen desc\",\"size\":2,\"title\":\"Incidents in {Workspace:name}\",\"timeContextFromParameter\":\"Time\",\"exportedParameters\":[{\"fieldName\":\"IncidentNumber\",\"parameterName\":\"IncidentNumber\"},{\"fieldName\":\"IncidentName\",\"parameterName\":\"IncidentName\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"98.8571ch\"}},{\"columnMatch\":\"Group\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"98.8571ch\"}},{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Informational\",\"representation\":\"gray\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"red\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"TimeOpen\",\"formatter\":0,\"numberFormat\":{\"unit\":25,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Tasks\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"98.8571ch\"}}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Title\",\"IncidentNumber\"]}}},\"conditionalVisibility\":{\"parameterName\":\"Filter\",\"comparison\":\"isEqualTo\",\"value\":\"Incident\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| summarize arg_max(TimeGenerated,*) by tostring(IncidentNumber)\\r\\n| extend TimeOpen = datetime_diff('minute', now(), CreatedTime)\\r\\n| project IncidentNumber, Title, Owner = iff(isempty(Owner.email), 'Unassigned', Owner.email), Description, TimeGenerated, Severity, Status, TimeOpen, Tasks, TaskCount = array_length(Tasks), ProviderName, IncidentName\\r\\n| where TaskCount > 0\\r\\n| where Owner == 'Unassigned'\\r\\n| where Status !has 'Closed'\\r\\n| order by TimeOpen desc\",\"size\":2,\"showAnalytics\":true,\"title\":\"Unassigned Incidents with Tasks\",\"timeContextFromParameter\":\"Time\",\"showRefreshButton\":true,\"exportedParameters\":[{\"fieldName\":\"IncidentNumber\",\"parameterName\":\"IncidentNumber\"},{\"fieldName\":\"IncidentName\",\"parameterName\":\"IncidentName\",\"parameterType\":1}],\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"68.5714ch\"}},{\"columnMatch\":\"Group\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"68.5714ch\"}},{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Informational\",\"representation\":\"gray\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"red\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"TimeOpen\",\"formatter\":0,\"numberFormat\":{\"unit\":25,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Tasks\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"68.5714ch\"}}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Title\",\"IncidentNumber\"]}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Filter\",\"comparison\":\"isEqualTo\",\"value\":\"Owner\"},\"name\":\"query - 0 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| summarize arg_max(TimeGenerated,*) by tostring(IncidentNumber)\\r\\n| extend TimeOpen = datetime_diff('minute', now(), CreatedTime)\\r\\n| project IncidentNumber, Title, Owner = iff(isempty(Owner.email), 'Unassigned', Owner.email), Description, TimeGenerated, Severity, Status, TimeOpen, Tasks, TaskCount = array_length(Tasks), ProviderName, IncidentName\\r\\n| where TaskCount > 0\\r\\n| where Owner != 'Unassigned'\\r\\n| where Status !has 'Closed'\\r\\n| order by IncidentNumber desc\",\"size\":2,\"showAnalytics\":true,\"title\":\"Owned Incidents with Tasks\",\"timeContextFromParameter\":\"Time\",\"showRefreshButton\":true,\"exportedParameters\":[{\"fieldName\":\"IncidentNumber\",\"parameterName\":\"IncidentNumber\"},{\"fieldName\":\"IncidentName\",\"parameterName\":\"IncidentName\",\"parameterType\":1}],\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"89ch\"}},{\"columnMatch\":\"Group\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"89ch\"}},{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Informational\",\"representation\":\"gray\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"red\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"TimeOpen\",\"formatter\":0,\"numberFormat\":{\"unit\":25,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Tasks\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"89ch\"}}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Owner\",\"Title\"]}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Filter\",\"comparison\":\"isEqualTo\",\"value\":\"Owner\"},\"name\":\"query - 0 - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Help\\r\\n\\r\\nThis section will provide logs on tasks that belonged to the select incident above. If it is saying to select an IncidentNumber, follow the steps above to find and select an incident. </br>\\r\\n\\r\\nIf looking take action on the selected incident or tasks, there are 3 buttons available:\\r\\n1. Open incident: This button will open the incident blade for the selected incident, allowing users to get access to the full picture of the incident while being able to act on tasks, logs, and automation.\\r\\n2. Open Tasks: This button will open the sub-menu from the incident blade to show all tasks of the selected incident. Users can view, update, or add tasks from this menu.\\r\\n3. Run automation: This button will open the run automation sub-menu from the incident blade. This allows users to run automation on the incident directly from the workbook without having to leave.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| where IncidentNumber in ({IncidentNumber})\\r\\n| project Tasks\\r\\n| mv-expand Tasks\\r\\n| evaluate bag_unpack(Tasks)\\r\\n| summarize arg_max(lastModifiedTimeUtc, *) by taskId\\r\\n| where status != 'Completed'\\r\\n| order by lastModifiedTimeUtc desc\\r\\n| extend TimeOpen = datetime_diff('minute', now(), createdTimeUtc)\\r\\n| project Title = ['title'], Status = ['status'], createdTimeUtc, lastModifiedTimeUtc, TimeOpen, Creator = ['createdBy'].name, lastModifiedBy, ModifiedBy = ['lastModifiedBy'].name\\r\\n| order by createdTimeUtc desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Open Tasks for Selected Incident\",\"timeContextFromParameter\":\"Time\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeOpen\",\"formatter\":0,\"numberFormat\":{\"unit\":25,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Group\",\"formatter\":1}],\"filter\":true}},\"showPin\":false,\"name\":\"query - 2\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"paragraph\",\"links\":[{\"id\":\"be028955-0e47-4c00-8470-0d438689b031\",\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"Open Incident\",\"style\":\"primary\",\"bladeOpenContext\":{\"bladeName\":\"IncidentPage.ReactView\",\"extensionName\":\"Microsoft_Azure_Security_Insights\",\"bladeJsonParameters\":\"{\\r\\n    \\\"incidentArmId\\\": \\\"{Workspace}/providers/Microsoft.SecurityInsights/Incidents/{IncidentName}\\\"\\r\\n}\"}},{\"id\":\"b4c2c3a2-3d9a-4ff7-8ff4-963186e8a765\",\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"Open Incident Tasks\",\"style\":\"primary\",\"linkIsContextBlade\":true,\"bladeOpenContext\":{\"bladeName\":\"IncidentTasksPage.ReactView\",\"extensionName\":\"Microsoft_Azure_Security_Insights\",\"bladeJsonParameters\":\"{\\r\\n    \\\"incidentArmId\\\": \\\"{Workspace}/providers/Microsoft.SecurityInsights/Incidents/{IncidentName}\\\"\\r\\n}\"}},{\"id\":\"4d829d94-3c0f-41f9-8a4f-c105373aaa2b\",\"cellValue\":\"\",\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"Open Workspace\",\"subTarget\":\"logs\",\"style\":\"primary\",\"linkIsContextBlade\":true,\"bladeOpenContext\":{\"bladeName\":\"LogsBlade\",\"extensionName\":\"Microsoft_Azure_Monitoring_Logs\",\"bladeJsonParameters\":\"{\\r\\n    \\\"scope\\\": {\\r\\n        \\\"resources\\\": [\\r\\n            {\\r\\n                \\\"resourceId\\\": \\\"{Workspace}\\\"\\r\\n            }\\r\\n        ]\\r\\n    },\\r\\n    \\\"source\\\": \\\"LogsBlade.Log Analytics\\\"\\r\\n}\"}},{\"id\":\"216e30bb-4f27-4434-981d-aa1abfce8591\",\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"Run Automation\",\"style\":\"primary\",\"linkIsContextBlade\":true,\"bladeOpenContext\":{\"bladeName\":\"ManualTriggerBlade\",\"extensionName\":\"Microsoft_Azure_Security_Insights\",\"bladeJsonParameters\":\"{\\r\\n    \\\"targetObjectType\\\": 0,\\r\\n    \\\"targetObjectArmId\\\": \\\"{Workspace}/providers/Microsoft.SecurityInsights/Incidents/{IncidentName}\\\"\\r\\n}\"}}]},\"name\":\"links - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| where IncidentNumber in ({IncidentNumber})\\r\\n| project Tasks\\r\\n| mv-expand Tasks\\r\\n| evaluate bag_unpack(Tasks)\\r\\n| summarize arg_max(lastModifiedTimeUtc, *) by taskId\\r\\n| where status == 'Completed'\\r\\n| extend TimeOpen = datetime_diff('minute', now(), createdTimeUtc)\\r\\n| project Title = ['title'], Status = ['status'], createdTimeUtc, lastCompletedTimeUtc = column_ifexists(\\\"lastCompletedTimeUtc\\\", datetime(null)), lastModifiedTimeUtc = column_ifexists(\\\"lastModifiedTimeUtc\\\", datetime(null)), TimeOpen, Creator = ['createdBy'].name, lastModifiedBy, Closer = ['lastModifiedBy'].name\\r\\n| order by lastCompletedTimeUtc desc\\r\\n\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Closed Tasks for Selected Incident\",\"noDataMessage\":\"No Completed Tasks for This Incident.\",\"timeContextFromParameter\":\"Time\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeOpen\",\"formatter\":0,\"numberFormat\":{\"unit\":25,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Group\",\"formatter\":1}],\"filter\":true}},\"name\":\"query - 2 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| where IncidentNumber in ({IncidentNumber})\\r\\n| project Tasks\\r\\n| mv-expand Tasks\\r\\n| evaluate bag_unpack(Tasks)\\r\\n| summarize arg_max(lastModifiedTimeUtc, *) by taskId\\r\\n| where status == 'Deleted'\\r\\n| extend TimeOpen = datetime_diff('minute', now(), createdTimeUtc)\\r\\n| project Title = ['title'], Status = ['status'], createdTimeUtc, lastModifiedTimeUtc = column_ifexists(\\\"lastModifiedTimeUtc\\\", datetime(null)), TimeOpen, Creator = ['createdBy'].name, lastModifiedBy, Closer = ['lastModifiedBy'].name\\r\\n| order by lastModifiedTimeUtc desc\\r\\n\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Deleted Tasks for Selected Incident\",\"timeContextFromParameter\":\"Time\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Group\",\"formatter\":1}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"title\"]}}},\"showPin\":false,\"name\":\"query - 2 - Copy - Copy\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"1\"},\"name\":\"Incident\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"### Help\\r\\n\\r\\nThis tab will highlight metrics around tasks within this workspace. The goal is to highlight key areas such as:\\r\\n- how many incidents do not have tasks\\r\\n- how many tasks have been completed\\r\\n- number of tasks per owner\\r\\n- average time to completion per task title\\r\\n\\r\\nThese metrics may assist in finding if there are areas that need to be improved.\\r\\n\\r\\nThe timeline below highlights the trend of incident creation over the selected time period. Time brushing is enabled on the timechart so a period can be highlighted and the metrics below will change to reflect the highlighted period. \\r\\n\\r\\n#### Please note: There may be errors that appear in the metrics if the selected workspace does not have any tasks that have been created. These will go away once tasks begin to populate the metrics.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 14\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident \\r\\n| where CreatedTime >= {Time:start} and CreatedTime <= {Time:end}\\r\\n| summarize arg_max(TimeGenerated, Status, Severity, Owner, AdditionalData,CreatedTime) by IncidentNumber\\r\\n| extend Tactics = todynamic(AdditionalData.tactics)\\r\\n| extend Owner = todynamic(Owner.assignedTo) \\r\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \\r\\n| summarize count() by bin(CreatedTime, 1h)\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Incidents Over Time\",\"timeContextFromParameter\":\"Time\",\"timeBrushParameterName\":\"TimeBrush\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"timechart\"},\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| project Tasks\\r\\n| mv-expand Tasks\\r\\n| evaluate bag_unpack(Tasks)\\r\\n| extend taskId = column_ifexists(\\\"taskId\\\", \\\"null\\\"), lastModifiedTimeUtc = column_ifexists(\\\"lastCompletedTimeUtc\\\", datetime(null))\\r\\n| order by lastModifiedTimeUtc desc\\r\\n| summarize arg_max(lastModifiedTimeUtc, *) by taskId\\r\\n| summarize Tasks = count()\",\"size\":0,\"title\":\"Total Number of Tasks During Time Period\",\"timeContextFromParameter\":\"TimeBrush\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"card\",\"textSettings\":{\"style\":\"bignumber\"}},\"customWidth\":\"20\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| project Tasks\\r\\n| mv-expand Tasks\\r\\n| evaluate bag_unpack(Tasks)\\r\\n| extend taskId = column_ifexists(\\\"taskId\\\", \\\"null\\\"), lastModifiedTimeUtc = column_ifexists(\\\"lastCompletedTimeUtc\\\", datetime(null)), status = column_ifexists(\\\"status\\\", \\\"null\\\")\\r\\n| where status == 'Completed'\\r\\n| order by lastModifiedTimeUtc desc\\r\\n| summarize arg_max(lastModifiedTimeUtc, *) by taskId\\r\\n| summarize Tasks = count()\",\"size\":0,\"title\":\"Total Number of Tasks Closed During Time Period\",\"timeContextFromParameter\":\"TimeBrush\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"card\",\"textSettings\":{\"style\":\"bignumber\"}},\"customWidth\":\"20\",\"name\":\"query - 5 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let TCount = (SecurityIncident\\r\\n| summarize arg_max(TimeGenerated, *) by IncidentName\\r\\n| summarize TCount = count());\\r\\nlet WOCount = (SecurityIncident\\r\\n| summarize arg_max(TimeGenerated, *) by IncidentName\\r\\n| where Tasks == '[]'\\r\\n| summarize WOCount = count());\\r\\nlet Percent = (WOTask:double, Total:double) {\\r\\n    print Percentage = (WOTask/Total) * 100\\r\\n};\\r\\nPercent(toscalar(WOCount),toscalar(TCount))\\r\\n\",\"size\":0,\"title\":\"Percent of Incidents without Tasks\",\"timeContextFromParameter\":\"TimeBrush\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Percentage\",\"formatter\":0,\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"print_0\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"minimumIntegerDigits\":3,\"minimumFractionDigits\":3,\"maximumFractionDigits\":3,\"minimumSignificantDigits\":3}}}]},\"tileSettings\":{\"leftContent\":{\"columnMatch\":\"Percentage\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},\"showBorder\":false},\"textSettings\":{\"style\":\"bignumber\"}},\"customWidth\":\"20\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| where Tasks != '[]'\\r\\n| project Tasks\\r\\n| mv-expand Tasks\\r\\n| evaluate bag_unpack(Tasks)\\r\\n| extend lastModifiedTimeUtc = column_ifexists(\\\"lastCompletedTimeUtc\\\", datetime(null)), taskId = column_ifexists(\\\"taskId\\\", \\\"null\\\"), createdBy = column_ifexists(\\\"createdBy\\\", \\\"null\\\")\\r\\n| extend createdBy = todynamic(createdBy)\\r\\n| summarize arg_max(lastModifiedTimeUtc, *) by taskId\\r\\n| extend Creator = iff(isempty(createdBy.email), 'Empty', tostring(createdBy.email))\\r\\n| summarize Tasks = count() by Creator\\r\\n| order by Tasks desc\",\"size\":0,\"title\":\"Number of Tasks Created by Owner\",\"timeContextFromParameter\":\"TimeBrush\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"20\",\"name\":\"query - 5 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| where Tasks != '[]'\\r\\n| project Tasks\\r\\n| mv-expand Tasks\\r\\n| evaluate bag_unpack(Tasks)\\r\\n| extend lastModifiedTimeUtc = column_ifexists(\\\"lastCompletedTimeUtc\\\", datetime(null)), taskId = column_ifexists(\\\"taskId\\\", \\\"null\\\"), status = column_ifexists(\\\"status\\\", \\\"null\\\")\\r\\n| summarize arg_max(lastModifiedTimeUtc, *) by taskId\\r\\n| summarize Tasks = count() by status\\r\\n| order by Tasks desc\",\"size\":0,\"title\":\"Number of Tasks by Status\",\"timeContextFromParameter\":\"TimeBrush\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"20\",\"name\":\"query - 5 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| where ClosedTime >= {Time:start} and ClosedTime <= {Time:end}\\r\\n| where Tasks != '[]'\\r\\n| project Tasks\\r\\n| mv-expand Tasks\\r\\n| evaluate bag_unpack(Tasks)\\r\\n| extend lastModifiedTimeUtc = column_ifexists(\\\"lastModifiedTimeUtc\\\", datetime(null)), taskId = column_ifexists(\\\"taskId\\\", \\\"null\\\"), status = column_ifexists(\\\"status\\\", \\\"null\\\"),lastCompletedTimeUtc = column_ifexists(\\\"lastCompletedTimeUtc\\\", datetime(null)), createdTimeUtc = column_ifexists(\\\"createdTimeUtc\\\", datetime(null))\\r\\n| summarize arg_max(lastModifiedTimeUtc, *) by taskId\\r\\n| extend TimeToClosure =  (lastCompletedTimeUtc - createdTimeUtc)/1h\\r\\n| summarize 50th_Percentile=percentile(TimeToClosure, 50)\",\"size\":0,\"title\":\"Mean time to closure \",\"timeContextFromParameter\":\"TimeBrush\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"leftContent\":{\"columnMatch\":\"50th_Percentile\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":26,\"options\":{\"style\":\"decimal\"}}},\"showBorder\":false},\"textSettings\":{\"style\":\"bignumber\"}},\"customWidth\":\"20\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let TaskCount = SecurityIncident\\r\\n| project Tasks\\r\\n| mv-expand Tasks\\r\\n| evaluate bag_unpack(Tasks)\\r\\n| extend lastModifiedTimeUtc = column_ifexists(\\\"lastModifiedTimeUtc\\\", datetime(null)), taskId = column_ifexists(\\\"taskId\\\", \\\"null\\\"), status = column_ifexists(\\\"status\\\", \\\"null\\\"),lastCompletedTimeUtc = column_ifexists(\\\"lastCompletedTimeUtc\\\", datetime(null)), createdTimeUtc = column_ifexists(\\\"createdTimeUtc\\\", datetime(null)), title = column_ifexists(\\\"title\\\", \\\"null\\\")\\r\\n| summarize arg_max(lastModifiedTimeUtc, *) by taskId\\r\\n| where isnotempty(lastCompletedTimeUtc)\\r\\n| summarize Count = count() by Title = ['title'];\\r\\nlet TotalTime = SecurityIncident\\r\\n| project Tasks\\r\\n| mv-expand Tasks\\r\\n| evaluate bag_unpack(Tasks)\\r\\n| extend lastModifiedTimeUtc = column_ifexists(\\\"lastModifiedTimeUtc\\\", datetime(null)), taskId = column_ifexists(\\\"taskId\\\", \\\"null\\\"), status = column_ifexists(\\\"status\\\", \\\"null\\\"),lastCompletedTimeUtc = column_ifexists(\\\"lastCompletedTimeUtc\\\", datetime(null)), createdTimeUtc = column_ifexists(\\\"createdTimeUtc\\\", datetime(null)), title = column_ifexists(\\\"title\\\", \\\"null\\\")\\r\\n| summarize arg_max(lastModifiedTimeUtc, *) by taskId\\r\\n| where isnotempty(lastCompletedTimeUtc)\\r\\n| extend Time = datetime_diff('minute', lastCompletedTimeUtc, createdTimeUtc)\\r\\n| summarize TotalTime = sum(Time) by Title = ['title'];\\r\\nTaskCount\\r\\n| join kind=leftouter TotalTime on Title\\r\\n| extend AvgTime = TotalTime/Count\\r\\n| project Title, AvgTime\\r\\n| order by AvgTime desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Average Time to Completion per Task\",\"timeContextFromParameter\":\"TimeBrush\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"AvgTime\",\"formatter\":0,\"numberFormat\":{\"unit\":25,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Completion Time\",\"formatter\":0,\"numberFormat\":{\"unit\":25,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"AvComp\",\"formatter\":0,\"numberFormat\":{\"unit\":25,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"25\",\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| project Tasks\\r\\n| mv-expand Tasks\\r\\n| evaluate bag_unpack(Tasks)\\r\\n| extend lastModifiedTimeUtc = column_ifexists(\\\"lastModifiedTimeUtc\\\", datetime(null)), taskId = column_ifexists(\\\"taskId\\\", \\\"null\\\"), status = column_ifexists(\\\"status\\\", \\\"null\\\"),lastCompletedTimeUtc = column_ifexists(\\\"lastCompletedTimeUtc\\\", datetime(null)), createdTimeUtc = column_ifexists(\\\"createdTimeUtc\\\", datetime(null)), title = column_ifexists(\\\"title\\\", \\\"null\\\"), createdBy = column_ifexists(\\\"createdBy\\\", \\\"null\\\")\\r\\n| summarize arg_max(lastModifiedTimeUtc, *) by taskId\\r\\n| extend Creator = todynamic(createdBy).name\\r\\n| where Creator !has 'automation rule' \\r\\n| where Creator !has 'playbook'\\r\\n| summarize Count = count() by Title = ['title'], tostring(Creator)\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Count per Task Added Manually\",\"timeContextFromParameter\":\"TimeBrush\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"filter\":true}},\"customWidth\":\"30\",\"name\":\"query - 11\"},{\"type\":1,\"content\":{\"json\":\"### Potentially Useful Tools\\r\\n---------------------------------------------------\"},\"name\":\"text - 12\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a9b3932a-e140-498f-97f4-da4ffcad5a4a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"selectedWorkbook\",\"label\":\"Select Workbook\",\"type\":2,\"isGlobal\":true,\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"[\\\\r\\\\n    {\\\\\\\"value\\\\\\\": \\\\\\\"SecurityOperationsEfficiency.json\\\\\\\", \\\\\\\"label\\\\\\\": \\\\\\\"SOC Efficiency Report\\\\\\\", \\\\\\\"tags\\\\\\\": [\\\\\\\"SOC\\\\\\\"]},\\\\r\\\\n\\\\t{\\\\\\\"value\\\\\\\": \\\\\\\"InvestigationInsights.json\\\\\\\", \\\\\\\"label\\\\\\\": \\\\\\\"Investigation Insights\\\\\\\", \\\\\\\"tags\\\\\\\" : [\\\\\\\"incident\\\\\\\"]}\\\\r\\\\n]\\\"}\",\"typeSettings\":{\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":8,\"value\":\"InvestigationInsights.json\"},{\"id\":\"1772f659-c2b1-4882-a26b-63feb82ab734\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"WorkbookRenderWhere\",\"label\":\"Where to Open\",\"type\":10,\"description\":\"Select the area where to render the selected workbook\",\"isRequired\":true,\"isGlobal\":true,\"typeSettings\":{\"showDefault\":false},\"jsonData\":\"[\\\"Context Pane\\\",\\\"Tab\\\",\\\"Full Screen\\\", \\\"Close Workbook\\\"]\",\"value\":\"Context Pane\"},{\"id\":\"49ce5797-eb8c-4616-94a6-14b9a92606b4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"templateBaseUrl\",\"type\":1,\"isHiddenWhenLocked\":true,\"criteriaData\":[{\"criteriaContext\":{\"operator\":\"Default\",\"resultValType\":\"static\",\"resultVal\":\"https://securityinsights.hosting.portal.azure.net/securityinsights/Content/Workbooks\"}}]}],\"style\":\"above\",\"queryType\":8},\"name\":\"parameters - 3\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"nav\",\"links\":[{\"id\":\"6587fa50-dc9c-46b7-ba95-b2b48b6c9733\",\"cellValue\":\"{templateBaseUrl}/{selectedWorkbook}\",\"linkTarget\":\"WorkbookTemplate\",\"linkLabel\":\"Open Workbook\",\"preText\":\"\",\"style\":\"secondary\",\"linkIsContextBlade\":true,\"workbookContext\":{\"componentIdSource\":\"workbook\",\"resourceIdsSource\":\"workbook\",\"templateIdSource\":\"cell\",\"typeSource\":\"static\",\"type\":\"sentinel\",\"gallerySource\":\"static\",\"gallery\":\"sentinel\",\"locationSource\":\"workbook\",\"passSpecificParams\":true,\"templateParameters\":[{\"name\":\"Workspace\",\"source\":\"parameter\",\"value\":\"workspace\"},{\"name\":\"Subscription\",\"source\":\"parameter\",\"value\":\"subscriptionId\"},{\"name\":\"subscriptionId\",\"source\":\"parameter\",\"value\":\"subscriptionId\"},{\"name\":\"resourceGroup\",\"source\":\"parameter\",\"value\":\"resourceGroup\"}]}}]},\"conditionalVisibility\":{\"parameterName\":\"WorkbookRenderWhere\",\"comparison\":\"isEqualTo\",\"value\":\"Context Pane\"},\"name\":\"links - 4\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"template\",\"loadFromTemplateId\":\"https://securityinsights.hosting.portal.azure.net/securityinsights/Content/Workbooks/AMAmigrationTracker.json\"},\"conditionalVisibility\":{\"parameterName\":\"selectedWorkbook\",\"comparison\":\"isEqualTo\",\"value\":\"AMAmigrationTracker.json\"},\"name\":\"AMA Migration Tracker\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"template\",\"loadFromTemplateId\":\"https://securityinsights.hosting.portal.azure.net/securityinsights/Content/Workbooks/MicrosoftSentinelDeploymentandMigrationTracker.json\"},\"conditionalVisibility\":{\"parameterName\":\"selectedWorkbook\",\"comparison\":\"isEqualTo\",\"value\":\"MicrosoftSentinelDeploymentandMigrationTracker.json\"},\"name\":\"Microosft Sentinel Deployment and Migration Tracker\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"template\",\"loadFromTemplateId\":\"https://securityinsights.hosting.portal.azure.net/securityinsights/Content/Workbooks/WorkspaceUsage.json\"},\"conditionalVisibility\":{\"parameterName\":\"selectedWorkbook\",\"comparison\":\"isEqualTo\",\"value\":\"WorkspaceUsage.json\"},\"name\":\"Microosft Sentinel Deployment and Migration Tracker - Copy\"}]},\"conditionalVisibility\":{\"parameterName\":\"WorkbookRenderWhere\",\"comparison\":\"isEqualTo\",\"value\":\"Tab\"},\"name\":\"Workbook Tabs Group\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"nav\",\"links\":[{\"id\":\"023a9468-b62b-479e-8cbe-d1f2d4c90303\",\"cellValue\":\"{templateBaseUrl}/{selectedWorkbook}\",\"linkTarget\":\"WorkbookTemplate\",\"linkLabel\":\"Open Workbook\",\"preText\":\"\",\"style\":\"secondary\",\"workbookContext\":{\"componentIdSource\":\"workbook\",\"resourceIdsSource\":\"workbook\",\"templateIdSource\":\"cell\",\"typeSource\":\"static\",\"type\":\"sentinel\",\"gallerySource\":\"static\",\"gallery\":\"sentinel\",\"locationSource\":\"workbook\",\"passSpecificParams\":true,\"templateParameters\":[{\"name\":\"Workspace\",\"source\":\"parameter\",\"value\":\"workspace\"},{\"name\":\"Subscription\",\"source\":\"parameter\",\"value\":\"subscriptionId\"},{\"name\":\"subscriptionId\",\"source\":\"parameter\",\"value\":\"subscriptionId\"},{\"name\":\"resourceGroup\",\"source\":\"parameter\",\"value\":\"resourceGroup\"}]}}]},\"conditionalVisibility\":{\"parameterName\":\"WorkbookRenderWhere\",\"comparison\":\"isEqualTo\",\"value\":\"Full Screen\"},\"name\":\"Open Workbook - Full Screen\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"Metrics\"}],\"fallbackResourceIds\":[\"\"],\"fromTemplateId\":\"sentinel-IncidentTasksWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId4'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=IncidentTasksWorkbook; logoFileName=; description=Use this workbook to review and modify existing incidents with tasks. This workbook provides views that higlight incident tasks that are open, closed, or deleted, as well as incidents with tasks that are either owned or unassigned. The workbook also provides SOC metrics around incident task performance, such as percentage of incidents without tasks, average time to close tasks, and more.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.1.0; title=Incident Tasks Workbook; templateRelativePath=IncidentTasksWorkbook.json; subtitle=; provider=Microsoft}.description",
                "parentId": "[variables('workbookId4')]",
                "contentId": "[variables('_workbookContentId4')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "SentinelSOARessentials",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId4')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook4-name')]",
        "contentProductId": "[variables('_workbookcontentProductId4')]",
        "id": "[variables('_workbookcontentProductId4')]",
        "version": "[variables('workbookVersion4')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "SentinelSOARessentials",
        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
        "descriptionHtml": "<p><strong>Note:</strong> <em>There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</em></p>\n<p>The Sentinel SOAR Essentials solution for Microsoft Sentinel contains Playbooks that can help you get started with basic notification and orchestration scenarios for common use cases. These include Playbooks for sending notifications over email and/or collaboration platforms such as MS Teams, Slack, etc.</p>\n<p><strong>Workbooks:</strong> 4, <strong>Playbooks:</strong> 18</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Azure_Sentinel.svg\"width=\"75px\"height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "SentinelSOARessentials",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Playbook",
              "contentId": "[variables('_Incident-Assignment-Shifts')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Notify-IncidentClosed')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Notify-IncidentReopened')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Notify-IncidentSeverityChanged')]",
              "version": "[variables('playbookVersion4')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Notify-Owner')]",
              "version": "[variables('playbookVersion5')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Post-Message-Slack-alert-trigger')]",
              "version": "[variables('playbookVersion6')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Post-Message-Teams-alert-trigger')]",
              "version": "[variables('playbookVersion7')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Post-Message-Teams-incident-trigger')]",
              "version": "[variables('playbookVersion8')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Post-Message-Slack-incident-trigger')]",
              "version": "[variables('playbookVersion9')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_relateAlertsToIncident-basedOnIP')]",
              "version": "[variables('playbookVersion10')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Send-basic-email')]",
              "version": "[variables('playbookVersion11')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Send-email-with-formatted-incident-report')]",
              "version": "[variables('playbookVersion12')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CreateIncident-MicrosoftForms')]",
              "version": "[variables('playbookVersion13')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CreateIncident-SharedMailbox')]",
              "version": "[variables('playbookVersion14')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_M365D_BEC_Playbook_for_SecOps-Tasks')]",
              "version": "[variables('playbookVersion15')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_M365D_Phishing_Playbook_for_SecOps-Tasks')]",
              "version": "[variables('playbookVersion16')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_M365D_Ransomware_Playbook_for_SecOps-Tasks')]",
              "version": "[variables('playbookVersion17')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Send-Teams-adaptive-card-on-incident-creation')]",
              "version": "[variables('playbookVersion18')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId2')]",
              "version": "[variables('workbookVersion2')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId3')]",
              "version": "[variables('workbookVersion3')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId4')]",
              "version": "[variables('workbookVersion4')]"
            }
          ]
        },
        "firstPublishDate": "2022-06-27",
        "providers": [
          "Microsoft"
        ],
        "categories": {
          "domains": [
            "Security - Automation (SOAR)"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
