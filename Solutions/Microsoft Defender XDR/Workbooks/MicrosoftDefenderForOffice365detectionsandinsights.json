{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "\n<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#ffffff;\">\n  <tr style=\"border:none;\">\n    <td style=\"text-align:left; border:none; font-size:28px; font-weight:bold;width:1%;background-color:#ffffff;\">\n      Microsoft Defender for Office 365 Detections and Insights\n    </td>\n    <td style=\"text-align:right; border:none;width:1%;background-color:#ffffff;\">\n      <img height=\"40\" src=\"https://img-prod-cms-rt-microsoft-com.akamaized.net/cms/api/am/imageFileData/RE1Mu3b\">\n\t</td>\n  </tr>\n</table>\n<table>\n<tr>\n<td style=\"text-align:left; border:none; font-size:16px; width:10%;background-color:#ffffff;\">This workbook template provides an example of how to visualise and gain insights into Microsoft Defender for Office 365.<br>It allows you to visualise Microsoft Defender for Office 365 (MDO) data based on your organisation needs.<br> The workbook uses data from hunting tables streamed from <a href=\"https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-schema-tables\">Microsoft Defender XDR</a> via the Microsoft Sentinel Connector. Keep the data in the <a href=\"https://learn.microsoft.com/en-us/azure/sentinel/configure-data-retention\">Log Analytics workspace</a> for as long as necessary to get insights over an extended period, based on your organisation's needs.</td>\n</tr>\n</table>\n\n> \n**Please note:** *The workbook has a total of 13 tabs. If not all tabs are visible, you can access the remaining tabs using the \"...\" located at the end of the tab list on the right side.*\n> \n\n---\n\n"
      },
      "name": "text - 2"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "6e647d99-1a32-4bca-8147-403b5d37d773",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "isRequired": true,
            "value": "",
            "typeSettings": {
              "includeAll": false,
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "TimeRange"
          },
          {
            "id": "d57bcdf5-aec7-4f86-904c-67171864919b",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "isRequired": true,
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.operationalinsights/workspaces": true
              },
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "value": ""
          },
          {
            "id": "2e238f92-709c-410b-93e0-60eab6150a75",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "isRequired": true,
            "isGlobal": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "value": {
              "durationMs": 7776000000
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 1"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "3d26d949-bba8-486c-9af7-2b85bd5c8ab0",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Detection Dashboard",
            "subTarget": "1",
            "style": "link"
          },
          {
            "id": "a5f95467-84c1-4d8b-858c-7819339af748",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Email - Malware Detections",
            "subTarget": "2",
            "style": "link"
          },
          {
            "id": "b6c93de8-16d9-4c90-999b-837935de5645",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Email - Phish Detections",
            "subTarget": "3",
            "style": "link"
          },
          {
            "id": "df2c53b4-b6ed-4151-95fb-b3f08b849b84",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Email - Spam Detections",
            "subTarget": "4",
            "style": "link"
          },
          {
            "id": "9df30067-3266-48a8-b9e3-d65952098d46",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "URL Detections and Clicks",
            "subTarget": "5",
            "style": "link"
          },
          {
            "id": "b4be0ac3-3f48-44a8-b4b6-b46e17c710cd",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Email - Top Users/Senders/Forwarders",
            "subTarget": "6",
            "style": "link"
          },
          {
            "id": "e1d34091-7b3c-4e2d-a032-8be82a989313",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Email - Detection Overrides",
            "subTarget": "7",
            "style": "link"
          },
          {
            "id": "08c43a4f-f502-4813-9b8d-3f6b0b62b2fd",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "False Negative(FN) Submissions",
            "subTarget": "8",
            "style": "link"
          },
          {
            "id": "638d931f-f319-4914-b72d-8d68e914c7d4",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "False Positive(FP) Submissions",
            "subTarget": "10",
            "style": "link"
          },
          {
            "id": "ee01f95a-c5f7-4864-82e8-54a164741ba2",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "File - Malware Detections (SharePoint, Teams and OneDrive)",
            "subTarget": "9",
            "style": "link"
          },
          {
            "id": "a1e6264d-8f85-4a94-9ffd-eee36c04a0d5",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Post Delivery Detections",
            "subTarget": "11",
            "style": "link"
          },
          {
            "id": "85dd7ba0-d15f-4fc4-90ac-a4ecf734fb52",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Quarantine Insights",
            "subTarget": "12",
            "style": "link"
          },
          {
            "id": "b2920bee-c32a-4fdd-9d32-b004db2f3ac8",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Security Operations Center (SOC) Insights",
            "subTarget": "13",
            "style": "link"
          }
        ]
      },
      "name": "links - 14"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:28px; font-weight:bold;color:white;width:1%\">Threat Landscape\r\n</td>\r\n</tr>\r\n</table>\r\n\r\n**Microsoft Defender for Office 365** is a comprehensive security solution designed to protect organizations from **advanced threats targeting their email and collaboration** tools. It leverages a multi-layered approach to safeguard against phishing, malware, business email compromise (BEC), and other sophisticated attacks. <br>\r\nThis summary provides an overview of how Microsoft Defender for Office 365 addresses the **evolving threat landscape** and **implements robust protections**. <br>\r\n"
            },
            "name": "text - 13",
            "styleSettings": {
              "margin": "0",
              "padding": "0"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "//This query shows the number behind the effectiveness of phish and malware false positives including post delivery events but without edge data detections.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\n\r\n// Get all mailflow detected as clean at time of delivery \r\nlet EmailEventsClean = materialize( \r\n    EmailEvents \r\n    | where Timestamp between (toscalar(minTime) .. toscalar(maxTime)) and EmailDirection == \"Inbound\" \r\n    | where ThreatTypes !contains \"Phish\" and ThreatTypes !contains \"Malware\" // UN-comment this when using sentinel or another streaming SIEM (line 10).\r\n    // this alteration is due to the threat types being updated directly within advanced hunting.\r\n    //| where DeliveryLocation != \"Quarantine\" // comment out this line if you uncomment line 10, as it's only required for advanced hunting.\r\n    | project NetworkMessageId,ThreatTypes \r\n); \r\n// Get all mailflow detected as phish or malware at time of delivery \r\nlet EmailEventsThreats = materialize( \r\n    EmailEvents \r\n    | where Timestamp between (toscalar(minTime) .. toscalar(maxTime)) and EmailDirection == \"Inbound\" \r\n    | where ThreatTypes contains \"Phish\" or ThreatTypes contains \"Malware\" \r\n    | extend MDO_detection = parse_json(DetectionMethods) \r\n    | extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n    | extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n    | project NetworkMessageId,FirstDetection,FirstSubcategory,MDO_detection,ThreatTypes \r\n); \r\n// Get all post delivery ZAP / Redelivery events, and arg_max them to ensure we have the latest verdict to work with for each \r\nlet EmailPostDeliveryFiltered = materialize( \r\n    EmailPostDeliveryEvents \r\n    | where Timestamp between (toscalar(minTime) .. datetime_add('day', 7, toscalar(maxTime))) \r\n    | where ActionType in (\"Malware ZAP\",\"Phish ZAP\",\"Redelivery\") \r\n    | extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n    | summarize arg_max(Timestamp, *) by Key \r\n    | project Action,ActionType,ActionResult,ThreatTypes,NetworkMessageId \r\n); \r\n// Optional - get all admin submissions for malware or phish, so we can also count these in the miss bucket. \r\nlet CloudAppEventsFiltered = materialize( \r\n    CloudAppEvents \r\n    | where Timestamp between (toscalar(minTime) .. datetime_add('day', 7, toscalar(maxTime)))\r\n    | where ActionType == \"AdminSubmissionSubmitted\" \r\n    | extend SubmissionType = tostring(parse_json(RawEventData).SubmissionType) \r\n    | extend NetworkMessageId = tostring(parse_json(RawEventData).ObjectId) \r\n    | where SubmissionType in (\"1\", \"2\") \r\n    | project SubmissionType,NetworkMessageId \r\n); \r\n// get the number of threats caught in mailflow \r\nlet Mal_Phish_Mailflow = toscalar( \r\n    EmailEventsThreats \r\n    | summarize count() \r\n); \r\n// get the number of threats caught in mailflow which turned out to be false positives (FPs) so we can correct the calculation \r\nlet FP_ZAP = toscalar( \r\n    EmailPostDeliveryFiltered \r\n    | where ThreatTypes !contains \"Phish\" and ThreatTypes !contains \"Malware\" and ActionType == \"Redelivery\" \r\n    | join kind=leftsemi (EmailEventsThreats) on NetworkMessageId \r\n    | summarize count() \r\n); \r\n// get the number of threats successfully cleaned up post delivery, ignoring where administrative policy stopped action \r\nlet FN_ZAP_Successful = toscalar( \r\n    EmailPostDeliveryFiltered \r\n    | where ActionType in (\"Malware ZAP\",\"Phish ZAP\") and ActionResult in (\"Success\",\"AdminPolicy\") \r\n    | join kind=leftsemi (EmailEventsClean) on NetworkMessageId \r\n    | summarize count() \r\n); \r\n// get the number of threats unsuccessfully cleaned up post delivery. \r\nlet FN_ZAP_Unsuccessful = toscalar( \r\n    EmailPostDeliveryFiltered \r\n    | where ActionType in (\"Malware ZAP\",\"Phish ZAP\") and ActionResult !in (\"Success\",\"AdminPolicy\") \r\n    | join kind=leftsemi (EmailEventsClean) on NetworkMessageId \r\n    | summarize count() \r\n); \r\n// join the administrative submissions to clean mailflow to find the additional miss \r\nlet FN_Admin_Submissions = toscalar( \r\n    CloudAppEventsFiltered \r\n    | join kind=rightsemi (EmailEventsClean) on NetworkMessageId \r\n    | summarize count() \r\n    ); \r\n    // print each result, and run the calculation to work out effectiveness at time of delivery and post delivery. \r\n\r\nprint StatisticName=\"Effectiveness Post Delivery\", Value=abs(round(((toreal(toscalar(FN_Admin_Submissions))+toreal(toscalar(FN_ZAP_Unsuccessful)))/(toreal(toscalar(Mal_Phish_Mailflow))+toreal(toscalar(FN_ZAP_Successful))+toreal(toscalar(FN_ZAP_Unsuccessful))+toreal(toscalar(FN_Admin_Submissions))-toreal(toscalar(FP_ZAP)))*100-100),2))",
                    "size": 1,
                    "showAnalytics": true,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "stat",
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "StatisticName",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "Value",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "graphSettings": {
                      "type": 0,
                      "topContent": {
                        "columnMatch": "StatisticName",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "Value",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "statSettings": {
                      "valueField": "Value",
                      "valueAggregation": "None",
                      "colorSettings": {
                        "type": "thresholds",
                        "mode": "foreground",
                        "heatmapPalette": "greenRed",
                        "thresholdsGrid": [
                          {
                            "operator": ">",
                            "thresholdValue": "95",
                            "representation": "green"
                          },
                          {
                            "operator": "<=",
                            "thresholdValue": "95",
                            "representation": "orange"
                          },
                          {
                            "operator": "<=",
                            "thresholdValue": "90",
                            "representation": "red"
                          }
                        ]
                      },
                      "iconSettings": {
                        "thresholdsGrid": []
                      },
                      "numberFormatSettings": {
                        "unit": 1,
                        "options": {
                          "style": "decimal"
                        }
                      },
                      "tagText": "Phish / Malware Effectiveness - Post Delivery",
                      "valueFontStyle": "superLarge",
                      "tagTextPosition": "bottom"
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 5"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "//This query visualises the percentage of emails released from quarantine out of the total ammount of quarantined emails\r\nlet Quarantine_Releases = toscalar(EmailPostDeliveryEvents\r\n| where Action == \"Quarantine release\"\r\n| join kind=leftouter (EmailEvents | where DeliveryLocation == \"Quarantine\") on NetworkMessageId\r\n| summarize count());\r\nlet Quarantined_Mailfow = toscalar(EmailEvents | where DeliveryLocation == \"Quarantine\"\r\n| summarize count());\r\nprint\r\nQuarantine_Releases = toreal(Quarantine_Releases),\r\nQuarantined_Mailflow = toreal(Quarantined_Mailfow),\r\nRelease_Percentage = abs(round(((toreal(Quarantine_Releases)/toreal(Quarantined_Mailfow))*100),2))",
                    "size": 1,
                    "showAnalytics": true,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "stat",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Release_Percentage",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "none"
                        },
                        "numberFormat": {
                          "unit": 1,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "Release_Percentage",
                      "size": "auto"
                    },
                    "graphSettings": {
                      "type": 0,
                      "topContent": {
                        "columnMatch": "StatisticName",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "Value",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "statSettings": {
                      "valueField": "Release_Percentage",
                      "valueAggregation": "None",
                      "colorSettings": {
                        "type": "thresholds",
                        "mode": "foreground",
                        "heatmapPalette": "greenRed",
                        "thresholdsGrid": [
                          {
                            "operator": "<",
                            "thresholdValue": "5",
                            "representation": "green"
                          },
                          {
                            "operator": ">",
                            "thresholdValue": "5",
                            "representation": "redDark"
                          }
                        ]
                      },
                      "iconSettings": {
                        "thresholdsGrid": []
                      },
                      "numberFormatSettings": {
                        "unit": 1,
                        "options": {
                          "style": "decimal"
                        }
                      },
                      "tagText": "Quarantine Release Percentage",
                      "valueFontStyle": "superLarge",
                      "tagTextPosition": "bottom"
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 1"
                }
              ]
            },
            "name": "TopNr"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "**Effectiveness visually represents the protection given by Defender for Office 365 against phishing and malware in email messages.** <br>\r\nWe consider messages that your users report, as well as decisions that are made after delivery."
                  },
                  "name": "text - 9",
                  "styleSettings": {
                    "margin": "1px"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "//This query shows the number behind the effectiveness of phish and malware false positives including post delivery events but without edge data detections.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\n\r\n// Get all mailflow detected as clean at time of delivery \r\nlet EmailEventsClean = materialize( \r\n    EmailEvents \r\n    | where Timestamp between (toscalar(minTime) .. toscalar(maxTime)) and EmailDirection == \"Inbound\" \r\n    | where ThreatTypes !contains \"Phish\" and ThreatTypes !contains \"Malware\" // UN-comment this when using sentinel or another streaming SIEM (line 10).\r\n    // this alteration is due to the threat types being updated directly within advanced hunting.\r\n    //| where DeliveryLocation != \"Quarantine\" // comment out this line if you uncomment line 10, as it's only required for advanced hunting.\r\n    | project NetworkMessageId,ThreatTypes \r\n); \r\n// Get all mailflow detected as phish or malware at time of delivery \r\nlet EmailEventsThreats = materialize( \r\n    EmailEvents \r\n    | where Timestamp between (toscalar(minTime) .. toscalar(maxTime)) and EmailDirection == \"Inbound\" \r\n    | where ThreatTypes contains \"Phish\" or ThreatTypes contains \"Malware\" \r\n    | extend MDO_detection = parse_json(DetectionMethods) \r\n    | extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n    | extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n    | project NetworkMessageId,FirstDetection,FirstSubcategory,MDO_detection,ThreatTypes \r\n); \r\n// Get all post delivery ZAP / Redelivery events, and arg_max them to ensure we have the latest verdict to work with for each \r\nlet EmailPostDeliveryFiltered = materialize( \r\n    EmailPostDeliveryEvents \r\n    | where Timestamp between (toscalar(minTime) .. datetime_add('day', 7, toscalar(maxTime))) \r\n    | where ActionType in (\"Malware ZAP\",\"Phish ZAP\",\"Redelivery\") \r\n    | extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n    | summarize arg_max(Timestamp, *) by Key \r\n    | project Action,ActionType,ActionResult,ThreatTypes,NetworkMessageId \r\n); \r\n// Optional - get all admin submissions for malware or phish, so we can also count these in the miss bucket. \r\nlet CloudAppEventsFiltered = materialize( \r\n    CloudAppEvents \r\n    | where Timestamp between (toscalar(minTime) .. datetime_add('day', 7, toscalar(maxTime)))\r\n    | where ActionType == \"AdminSubmissionSubmitted\" \r\n    | extend SubmissionType = tostring(parse_json(RawEventData).SubmissionType) \r\n    | extend NetworkMessageId = tostring(parse_json(RawEventData).ObjectId) \r\n    | where SubmissionType in (\"1\", \"2\") \r\n    | project SubmissionType,NetworkMessageId \r\n); \r\n// get the number of threats caught in mailflow \r\nlet Mal_Phish_Mailflow = toscalar( \r\n    EmailEventsThreats \r\n    | summarize count() \r\n); \r\n// get the number of threats caught in mailflow which turned out to be false positives (FPs) so we can correct the calculation \r\nlet FP_ZAP = toscalar( \r\n    EmailPostDeliveryFiltered \r\n    | where ThreatTypes !contains \"Phish\" and ThreatTypes !contains \"Malware\" and ActionType == \"Redelivery\" \r\n    | join kind=leftsemi (EmailEventsThreats) on NetworkMessageId \r\n    | summarize count() \r\n); \r\n// get the number of threats successfully cleaned up post delivery, ignoring where administrative policy stopped action \r\nlet FN_ZAP_Successful = toscalar( \r\n    EmailPostDeliveryFiltered \r\n    | where ActionType in (\"Malware ZAP\",\"Phish ZAP\") and ActionResult in (\"Success\",\"AdminPolicy\") \r\n    | join kind=leftsemi (EmailEventsClean) on NetworkMessageId \r\n    | summarize count() \r\n); \r\n// get the number of threats unsuccessfully cleaned up post delivery. \r\nlet FN_ZAP_Unsuccessful = toscalar( \r\n    EmailPostDeliveryFiltered \r\n    | where ActionType in (\"Malware ZAP\",\"Phish ZAP\") and ActionResult !in (\"Success\",\"AdminPolicy\") \r\n    | join kind=leftsemi (EmailEventsClean) on NetworkMessageId \r\n    | summarize count() \r\n); \r\n// join the administrative submissions to clean mailflow to find the additional miss \r\nlet FN_Admin_Submissions = toscalar( \r\n    CloudAppEventsFiltered \r\n    | join kind=rightsemi (EmailEventsClean) on NetworkMessageId \r\n    | summarize count() \r\n    ); \r\n    // print each result, and run the calculation to work out effectiveness at time of delivery and post delivery. \r\nunion withsource=Table \r\n    (print StatisticName=\"Mal/Phish Mailflow totals - Minus FPs\", Value=toreal(Mal_Phish_Mailflow) - toreal(FP_ZAP)), \r\n    (print StatisticName=\"Admin Mal/Phish FNs Submitted\", Value=toreal(FN_Admin_Submissions)), \r\n    (print StatisticName=\"Mal/Phish FPs Reverse Zapped\", Value=toreal(FP_ZAP)), \r\n    (print StatisticName=\"Mal / Phish Successfully Zapped\", Value=toreal(FN_ZAP_Successful)), \r\n    (print StatisticName=\"Mal / Phish UN-Successfully Zapped\", Value=toreal(FN_ZAP_Unsuccessful)), \r\n    (print StatisticName=\"Effectiveness Post Delivery\", Value=abs(round(((toreal(FN_Admin_Submissions)+toreal(FN_ZAP_Unsuccessful))/(toreal(Mal_Phish_Mailflow)+toreal(FN_ZAP_Successful)+toreal(FN_ZAP_Unsuccessful)+toreal(FN_Admin_Submissions)-toreal(FP_ZAP))*100-100),2))), \r\n    (print StatisticName=\"Effectiveness Pre-Delivery\", Value=abs(round(((toreal(FN_Admin_Submissions)+toreal(FN_ZAP_Unsuccessful)+toreal(FN_ZAP_Successful))/(toreal(Mal_Phish_Mailflow)+toreal(FN_ZAP_Successful)+toreal(FN_ZAP_Unsuccessful)+toreal(FN_Admin_Submissions)-toreal(FP_ZAP))*100-100),2))) \r\n| project StatisticName, Value",
                    "size": 0,
                    "showAnalytics": true,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Value",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 17,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        }
                      ]
                    },
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "StatisticName",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "Value",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "graphSettings": {
                      "type": 2,
                      "topContent": {
                        "columnMatch": "StatisticName",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "Value",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      },
                      "nodeIdField": "StatisticName",
                      "sourceIdField": "Value",
                      "targetIdField": "Value",
                      "graphOrientation": 3,
                      "showOrientationToggles": false,
                      "nodeSize": null,
                      "staticNodeSize": 100,
                      "colorSettings": null,
                      "hivesMargin": 5,
                      "edgeColorSettings": null
                    }
                  },
                  "name": "query - 7"
                }
              ]
            },
            "customWidth": "50",
            "name": "Effectiveness Nr",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "**Quarantine Release Percentage takes all emails quarantined during mail flow and divides it by the amount of mail released from quarantine.** \r\n<br>\r\nQuarantine release actions can be initiated by end-user or administrators."
                  },
                  "name": "text - 1",
                  "styleSettings": {
                    "margin": "1px"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "//This query visualises emails released from quarantine and summarizing the result by the original filter verdict - detection method\r\nlet totalQuery = \r\n    EmailPostDeliveryEvents \r\n    | where Action == \"Quarantine release\" \r\n    | join kind=inner (EmailEvents | where DeliveryLocation == \"Quarantine\") on NetworkMessageId \r\n    | extend MDO_detection = parse_json(DetectionMethods1) \r\n    | extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n    | extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n    | where FirstSubcategory contains \"Malware\" or FirstSubcategory contains \"Phish\" or FirstSubcategory contains \"Spam\"\r\n    | count;\r\nEmailPostDeliveryEvents \r\n| where Action == \"Quarantine release\" \r\n| join kind=inner (EmailEvents | where DeliveryLocation == \"Quarantine\") on NetworkMessageId \r\n| extend MDO_detection = parse_json(DetectionMethods1) \r\n| extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n| extend DetectionTechnology= iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n| where DetectionTechnology contains \"Malware\" or DetectionTechnology contains \"Phish\" or DetectionTechnology contains \"Spam\" \r\n| summarize count_messages = count(NetworkMessageId) by DetectionTechnology\r\n| extend percentage = round((count_messages * 100.0 / toscalar(totalQuery)), 2)\r\n| project DetectionTechnology, count_messages, percentage\r\n| order by percentage desc\r\n| take 7 ",
                    "size": 0,
                    "showAnalytics": true,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "count_messages",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 17,
                            "options": {
                              "style": "decimal"
                            }
                          }
                        }
                      ]
                    }
                  },
                  "name": "query - 2"
                }
              ]
            },
            "customWidth": "50",
            "name": "Quarantine Overview Relese",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:28px; font-weight:bold;color:white;width:1%\">Protection\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis is an overview of protection numbers for **Microsoft Defender for Office 365** including Malware, Phish, Spam detections, post delivery detections and user/admin reported messages."
            },
            "name": "text - 13"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Total Emails",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "EmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key \r\n| summarize Count = count()\r\n| extend Details = \"Total Inbound Emails\";",
                    "size": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Count",
                          "formatter": 4,
                          "formatOptions": {
                            "palette": "greenRed"
                          }
                        }
                      ]
                    },
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Details",
                        "formatter": 1,
                        "formatOptions": {
                          "compositeBarSettings": {
                            "labelText": "",
                            "columnSettings": []
                          }
                        }
                      },
                      "secondaryContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 1,
                          "palette": "blue",
                          "compositeBarSettings": {
                            "labelText": "",
                            "columnSettings": []
                          }
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "showBorder": true,
                      "size": "full",
                      "styleSettings": {
                        "borderStyle": "rounded",
                        "backgroundColor": "colorGray100"
                      }
                    },
                    "chartSettings": {
                      "xAxis": "Count",
                      "createOtherGroup": 0
                    },
                    "mapSettings": {
                      "locInfo": "LatLong",
                      "sizeSettings": "Count",
                      "sizeAggregation": "Sum",
                      "legendMetric": "Count",
                      "legendAggregation": "Sum",
                      "itemColorSettings": {
                        "type": "heatmap",
                        "colorAggregation": "Sum",
                        "nodeColorField": "Count",
                        "heatmapPalette": "greenRed"
                      }
                    }
                  },
                  "name": "query - 1"
                }
              ]
            },
            "name": "Total Inbound"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Pre-Delivery Filtering Totals",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "EmailEvents\r\n| where isnotempty(ThreatTypes) and EmailDirection == \"Inbound\" and DeliveryAction != 'Delivered'\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key \r\n| summarize Count = count()\r\n| extend Details = \"Filtering Totals\";",
                    "size": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Details",
                        "formatter": 1,
                        "formatOptions": {
                          "compositeBarSettings": {
                            "labelText": "",
                            "columnSettings": []
                          }
                        }
                      },
                      "secondaryContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 1,
                          "palette": "redDark",
                          "compositeBarSettings": {
                            "labelText": "",
                            "columnSettings": []
                          }
                        }
                      },
                      "showBorder": true,
                      "size": "full",
                      "styleSettings": {
                        "borderStyle": "rounded",
                        "backgroundColor": "colorGray100"
                      }
                    }
                  },
                  "name": "query - 1"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "//This query visualises Total emails detected as Malware\r\nEmailEvents\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key \r\n| where ThreatTypes has ('Malware') and EmailDirection == \"Inbound\"\r\n| summarize Count= count()\r\n| extend Details = \"Emails Filtered as Malware\"",
                    "size": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Details",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 1,
                          "palette": "red"
                        }
                      },
                      "showBorder": true,
                      "size": "full",
                      "styleSettings": {
                        "borderStyle": "rounded",
                        "backgroundColor": "colorGray100"
                      }
                    }
                  },
                  "customWidth": "33.3",
                  "name": "query - 4"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "//This query visualises Total emails detected as Phish\r\nEmailEvents\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key \r\n| where ThreatTypes has \"Phish\" and not(ThreatTypes has \"Malware\") and EmailDirection == \"Inbound\" and DeliveryAction != 'Delivered'\r\n| summarize Count= count()\r\n| extend Details = \"Emails Filtered as Phish\"",
                    "size": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Details",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 1,
                          "palette": "orange"
                        }
                      },
                      "showBorder": true,
                      "size": "full",
                      "styleSettings": {
                        "borderStyle": "rounded",
                        "backgroundColor": "colorGray100"
                      }
                    }
                  },
                  "customWidth": "33.3",
                  "name": "query - 4"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "//This query visualises Total emails by detected as Spam\r\nEmailEvents\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key \r\n| where ThreatTypes == 'Spam' and EmailDirection == \"Inbound\" and DeliveryAction != 'Delivered'\r\n| summarize Count= count()\r\n| extend Details = \"Emails Filtered as Spam\"",
                    "size": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Details",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 1,
                          "palette": "yellow"
                        }
                      },
                      "showBorder": true,
                      "size": "full",
                      "styleSettings": {
                        "borderStyle": "rounded",
                        "backgroundColor": "colorGray100"
                      }
                    }
                  },
                  "customWidth": "33.3",
                  "name": "query - 4"
                }
              ]
            },
            "customWidth": "50",
            "name": "group - 9"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": " ",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "EmailEvents\r\n| where EmailDirection == \"Inbound\" and isnotempty(ThreatTypes) and DeliveryAction == 'Delivered'\r\n| where isnotempty(OrgLevelAction) or isnotempty(UserLevelAction)\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key \r\n| summarize Count= count()\r\n| extend Details = \"Emails Delivered with Detection\"",
                    "size": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Details",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "red"
                        }
                      },
                      "showBorder": true,
                      "size": "full",
                      "styleSettings": {
                        "borderStyle": "rounded",
                        "backgroundColor": "colorGray100"
                      }
                    }
                  },
                  "customWidth": "33.3",
                  "name": "query - 3"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "EmailEvents\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where EmailDirection == \"Inbound\" and isempty(ThreatTypes) \r\n| where isnotempty(OrgLevelAction) or isnotempty(UserLevelAction)\r\n| where DeliveryAction != 'Delivered'\r\n| summarize Count= count()\r\n| extend Details = \"User/Admin Blocked\"",
                    "size": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Details",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 1,
                          "palette": "gray"
                        },
                        "tooltipFormat": {
                          "tooltip": "Emails blocked from being delivered because of User or Admin overriddes"
                        }
                      },
                      "showBorder": true,
                      "size": "full",
                      "styleSettings": {
                        "borderStyle": "rounded",
                        "backgroundColor": "colorGray100"
                      }
                    }
                  },
                  "customWidth": "33.3",
                  "name": "query - 3"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "EmailEvents\r\n| where isempty(ThreatTypes) and EmailDirection == \"Inbound\" and DeliveryAction == 'Delivered'\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key \r\n| summarize Count= count()\r\n| extend Details = \"Clean Emails\"",
                    "size": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Details",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 1,
                          "palette": "gray"
                        }
                      },
                      "showBorder": true,
                      "size": "full",
                      "styleSettings": {
                        "borderStyle": "rounded",
                        "backgroundColor": "colorGray100"
                      }
                    }
                  },
                  "customWidth": "33.3",
                  "name": "query - 3"
                }
              ]
            },
            "customWidth": "50",
            "name": "group - 8"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Post Delivery FIltering Totals",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "EmailPostDeliveryEvents\r\n| where ActionResult == \"Success\"\r\n| where ActionType == \"Malware ZAP\"\r\n| summarize Count= count()\r\n| extend Details = \"Total Emails Removed by Malware ZAP\"\r\n",
                    "size": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Details",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 1,
                          "palette": "red"
                        }
                      },
                      "showBorder": true,
                      "size": "full",
                      "styleSettings": {
                        "borderStyle": "rounded",
                        "backgroundColor": "colorGray100"
                      }
                    }
                  },
                  "customWidth": "33.3",
                  "name": "query - 3"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "EmailPostDeliveryEvents\r\n| where ActionResult == \"Success\"\r\n| where ActionType == \"Phish ZAP\"\r\n| summarize Count= count()\r\n| extend Details = \"Total Emails Removed by Phish ZAP\"",
                    "size": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Details",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 1,
                          "palette": "orange"
                        }
                      },
                      "showBorder": true,
                      "size": "full",
                      "styleSettings": {
                        "borderStyle": "rounded",
                        "backgroundColor": "colorGray100"
                      }
                    }
                  },
                  "customWidth": "33.3",
                  "name": "query - 3"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "EmailPostDeliveryEvents\r\n| where ActionResult == \"Success\"\r\n| where ActionType == \"Spam ZAP\"\r\n| summarize Count= count()\r\n| extend Details = \"Total Emails Removed by Spam ZAP\"",
                    "size": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Details",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 1,
                          "palette": "yellow"
                        }
                      },
                      "showBorder": true,
                      "size": "full",
                      "styleSettings": {
                        "borderStyle": "rounded",
                        "backgroundColor": "colorGray100"
                      }
                    }
                  },
                  "customWidth": "33.3",
                  "name": "query - 3"
                }
              ]
            },
            "name": "Post Delivery"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "//This query visualises total emails reported by user and total emails reported by Admins as false positive or false negative detection\r\nCloudAppEvents\r\n| extend Record= (parse_json(RawEventData)).RecordType\r\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\"\r\n| summarize Count= count()\r\n| extend Details = \"Total Emails Reported by Admins\"",
                    "size": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Details",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "none"
                        }
                      },
                      "showBorder": true,
                      "size": "full",
                      "styleSettings": {
                        "borderStyle": "rounded",
                        "backgroundColor": "colorGray100"
                      }
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 3"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "//This query visualises total emails reported by user and total emails reported by Admins as false positive or false negative detection\r\nCloudAppEvents\r\n| extend Record= (parse_json(RawEventData)).RecordType\r\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState\r\n| where Record == 29 and ActionType == \"UserSubmission\"\r\n| summarize Count= count()\r\n| extend Details = \"Total Emails Reported by Users\"\r\n",
                    "size": 3,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Details",
                        "formatter": 1
                      },
                      "secondaryContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "none"
                        }
                      },
                      "showBorder": true,
                      "size": "full",
                      "styleSettings": {
                        "borderStyle": "rounded",
                        "backgroundColor": "colorGray100"
                      }
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 2"
                }
              ]
            },
            "name": "Reported"
          },
          {
            "type": 1,
            "content": {
              "json": "## Detection trend over time\r\n**Represents total emails, total detections, total user submissions and admin email submissions over time summarizing the data daily**"
            },
            "name": "text - 14"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails, total detections, total user, and admin email submissions over time summarizing the data daily\r\n\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\n\r\nlet baseQuery = EmailEvents\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key \r\n| where isnotempty(Timestamp);\r\n\r\nlet totalinbound = baseQuery\r\n| where EmailDirection == \"Inbound\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Total Inbound Emails\";\r\n\r\nlet totalintraorg = baseQuery\r\n| where EmailDirection == \"Intra-org\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Total Intra-org Emails\";\r\n\r\nlet totaloutbound = baseQuery\r\n| where EmailDirection == \"Outbound\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Total Outbound Emails\";\r\n\r\nlet totalwiththreat = baseQuery\r\n| where isnotempty(ThreatTypes) \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Total Emails with Threat\";\r\n\r\nlet phishingcount = baseQuery\r\n| where ThreatTypes has ('Phish')\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Emails Detected as Phish\";\r\n\r\nlet malwarecount = baseQuery\r\n| where ThreatTypes has ('Malware')\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Emails Detected as Malware\";\r\n\r\nlet spamcount = baseQuery\r\n| where ThreatTypes has ('Spam')\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Emails Detected as Spam\";\r\n\r\nlet usersubmissioncount = CloudAppEvents\r\n| extend Record= (parse_json(RawEventData)).RecordType\r\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState\r\n| where Record == 29 | where ActionType == \"UserSubmission\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Total Emails Reported by Users\";\r\n\r\nlet adminsubmissioncount = CloudAppEvents\r\n| extend Record= (parse_json(RawEventData)).RecordType\r\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Total Emails Reported by Admins\";\r\n\r\nlet zapcount = EmailPostDeliveryEvents\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key \r\n| where ActionResult == \"Success\"\r\n| where ActionType == \"Phish ZAP\" or ActionType == \"Malware ZAP\" or ActionType == \"Spam ZAP\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Total Emails Removed by ZAP\";\r\n\r\nunion totalinbound, phishingcount, malwarecount, spamcount, totalintraorg, totaloutbound, totalwiththreat, usersubmissioncount, zapcount, adminsubmissioncount",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "xAxis": "Timestamp",
                "seriesLabelSettings": [
                  {
                    "seriesName": "Total Inbound Emails",
                    "label": "Inbound Emails",
                    "color": "green"
                  },
                  {
                    "seriesName": "Total Emails with Threat",
                    "label": "Emails with Threat",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Emails Detected as Phish",
                    "label": "Emails with Phish",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "Emails Detected as Malware",
                    "label": "Emails with Malware",
                    "color": "red"
                  },
                  {
                    "seriesName": "Total Intra-org Emails",
                    "label": "Intra-org Emails",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "Emails Detected as Spam",
                    "label": "Emails with Spam",
                    "color": "gray"
                  },
                  {
                    "seriesName": "Total Outbound Emails",
                    "label": "Outbound Emails",
                    "color": "greenDarkDark"
                  },
                  {
                    "seriesName": "Total Emails Removed by ZAP",
                    "label": "Emails ZAP-d",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "Total Emails Reported by Users",
                    "label": "User Reported Emails",
                    "color": "lightBlue"
                  },
                  {
                    "seriesName": "Total Emails Reported by Admins",
                    "color": "blueDark"
                  }
                ]
              }
            },
            "customWidth": "100",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "## Bad traffic percentage (%) - Inbound Emails\r\n**This represents bad traffic (% of emails with threats) compared to total inbound emails, summarized daily over time.**"
            },
            "name": "text - 15"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises bad traffic (% of emails with threats) compared to total inbound emails over time summarising the data daily.\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| summarize TotalEmailCount = count(),\r\n            BadEmailCount = countif(isnotempty(ThreatTypes)) by bin(Timestamp, 1d)\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(BadEmailCount / todouble(TotalEmailCount) * 100, 2))\r\n| project Timestamp,Bad_Traffic_Percentage_Inbound",
              "size": 0,
              "aggregation": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:28px; font-weight:bold;color:white;width:1%\">Emerging Threats\r\n</td>\r\n</tr>\r\n</table>\r\n\r\n<p style=\"font-size:16px;\">With more sophisticated adversaries and new threats emerging frequently and prevalently, it's critical to be able to quickly identify and react to these threats.</p>\r\n\r\n[<p style=\"font-size:16px;\"><b>Activity Profile: Recent OSINT trends in ransomware</b></p>](https://security.microsoft.com/threatanalytics3/7f22cb98-1a75-4288-b2f6-f429c21f6d82)\r\n[<p style=\"font-size:16px;\"><b>Activity Profile: Vulnerability threat landscape, July to September 2025</p>](https://security.microsoft.com/threatanalytics3/cc065001-85d1-4ef5-9aa1-589727a9c473)\r\n[<p style=\"font-size:16px;\"><b>Activity Profile: Email threat landscape, September 2025</p>](https://security.microsoft.com/threatanalytics3/343aec4e-38ff-4a48-ad02-284744402840)\r\n[<p style=\"font-size:16px;\"><b>Actor Profile: Storm-2657</p>](https://security.microsoft.com/threatanalytics3/ee708c69-c676-4221-a2a7-1b90f7a5ebca)\r\n[<p style=\"font-size:16px;\"><b>Activity Profile: Targeted payroll pirate attacks affecting US universities</p>](https://security.microsoft.com/threatanalytics3/efc971b5-8159-46cf-b944-015090923411)\r\n\r\n<br>\r\n<a href=\"https://go.microsoft.com/fwlink/?linkid=2323913\" target=\"_blank\" style=\"font-size:14px; padding:10px 20px; background-color:#003366; color:white; border:none; border-radius:5px;\">\r\n<b>View all\r\n \r\n</a>\r\n"
            },
            "name": "text - 10",
            "styleSettings": {
              "margin": "0",
              "padding": "0"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:28px; font-weight:bold;color:white;width:1%\">Microsoft 365 Secure Email Gateway Performance\r\n</td>\r\n</tr>\r\n</table>\r\n\r\n<p style=\"font-size:16px;\">Using multiple vendor email security products can offer diverse detections. However, our comprehensive end-to-end approachspanning prevention, detection, posture, investigation, response, and user trainingdelivers a unified and effective defense that matches or exceeds the efficacy of siloed Secure Email Gateway solutions.</p>\r\n\r\n[<p style=\"font-size:18px;\"><b>Learn more</b></p>](https://go.microsoft.com/fwlink/?linkid=2326674) \r\n\r\n<br>\r\n<p style=\"font-size:16px;\"><b>High confidence Phish / Malware miss per 1,000 active users - Last Updated by Microsoft on 1st July 2025 (Q2 CY2025 Results)</b></p>"
            },
            "name": "text - 12"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "datatable(Index:int, Name:string, Value:int)\r\n[\r\n    1, \"Defender for Office 365\", \"154\",\r\n    2, \"Proofpoint\", \"433\",\r\n    3, \"HornetSecurity\", \"564\",\r\n    4, \"Mimecast\", \"674\",\r\n    5, \"Trend Micro\", \"790\",\r\n    7, \"Ironport\", \"931\",\r\n    8, \"Barracuda\", \"936\",\r\n    9, \"Trellix\", \"1700\"\r\n]\r\n| project Name, Value, Index\r\n| order by Index asc\r\n",
              "size": 0,
              "timeContext": {
                "durationMs": 86400000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart",
              "chartSettings": {
                "xAxis": "Name",
                "yAxis": [
                  "Value"
                ],
                "sortBy": "query",
                "seriesLabelSettings": [
                  {
                    "seriesName": "Trellix",
                    "color": "gray"
                  },
                  {
                    "seriesName": "Barracuda",
                    "color": "gray"
                  },
                  {
                    "seriesName": "Ironport",
                    "color": "gray"
                  },
                  {
                    "seriesName": "Trend Micro",
                    "color": "gray"
                  },
                  {
                    "seriesName": "Mimecast",
                    "color": "gray"
                  },
                  {
                    "seriesName": "HornetSecurity",
                    "color": "gray"
                  },
                  {
                    "seriesName": "Proofpoint",
                    "color": "gray"
                  },
                  {
                    "seriesName": "Defender for Office 365",
                    "color": "blueDark"
                  }
                ],
                "xSettings": {
                  "numberFormatSettings": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "name": "query - 11",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ],
        "exportParameters": true
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "1"
      },
      "customWidth": "100",
      "name": "Detection Overview",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px"
      }
    },
    {
      "type": 1,
      "content": {
        "json": "# Malware detection insights\r\n\r\n---\r\n\r\nThis tab provides insights into email message **detections** by Microsoft Defender for Office 365 where the message contained a **malware threat** (such as viruses, spyware, or ransomware) within its **URLs** or **attachments**."
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "2"
      },
      "name": "text - 13",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Malware Detection Trends, Threat Classes, and Malware Names\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and explain malware detections in inbound email as identified by Microsoft Defender for Office 365 focusing on daily trend, threat classes and Malware types. \r\n"
            },
            "name": "text - 14"
          },
          {
            "type": 1,
            "content": {
              "json": "### Malware Detection Trend\r\n**This visual displays a daily trend of email malware detections identified by Microsoft Defender for Office 365. The line chart summarises the number of messages flagged for malware threats.**"
            },
            "name": "text - 14 - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections over time summarizing the data daily.\r\nEmailEvents \r\n| where ThreatTypes has \"Malware\" \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| make-series MalwareDetections = count(Key) default = 0 on Timestamp step 1d \r\n\r\n",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Malware Detection Trend - Advanced Threats\r\n**Not all threats are going to be easily recognisable, that's why Microsoft Defender for Office 365 has advanced threat detection methods, that use virtual sandbox environments to detonate URLs and Files. These virtual sandbox technologies look for known patterns, such as a recognisable login page in a URL, or a file accessing command and control infrastructure. This visual displays a daily trend of Malware detections of these advanced threats**"
            },
            "name": "text - 14 - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections over time summarizing the data daily by Malware detection technologies/controls used for detecting unknown-unique malware.\r\nEmailEvents\r\n| where DetectionMethods has 'Malware'\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend ParsedMethods = parse_json(DetectionMethods)\r\n| mv-expand MalwareMethod = ParsedMethods.Malware\r\n| where MalwareMethod in ('File detonation','URL detonation')\r\n| make-series Count= count(Key) default = 0 on Timestamp step 1d by tostring(MalwareMethod)",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "File detonation",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "URL detonation",
                    "color": "orangeDark"
                  }
                ]
              }
            },
            "customWidth": "100",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 9",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Malware Detections by Threat Classification\r\n**Summary of email messages detected by Microsoft Defender for Office 365 as malware, grouped by type of malware (Adware, Downloader, Hack tool, Ransomware, Remote access trojan, Spyware).**"
            },
            "customWidth": "33",
            "name": "text - 15",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top Attacked Users by Malware Threat Classification\r\n**Displays the recipient most frequently targeted for each malware type (Adware, Downloader, Hack tool, Ransomware, Remote access trojan, Spyware) in inbound email detections.**"
            },
            "customWidth": "33",
            "name": "text - 15 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Malware Detections by Threat Name\r\n**Summarises email messages flagged by Microsoft Defender for Office 365, grouped by specific malware names detected in URLs or attachments.**"
            },
            "customWidth": "33",
            "name": "text - 15 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections summarizing the data by threat classification of the malware threat in the message.\r\nEmailEvents \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where ThreatTypes has 'Malware' and ThreatClassification  has_any(\"Adware\",\"Downloader\",\"Hack tool\",\"Ransomware\",\"Remote access trojan\",\"Spyware\")\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize Count = count(Key) by ThreatClassification\r\n| sort by Count desc",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 11",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises Malware detections in emails summarizing by various Threat classes showing the top attacked user for each threat classification type.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where ThreatTypes has \"Malware\" and EmailDirection == \"Inbound\" and ThreatClassification has_any(\"Adware\",\"Downloader\",\"Hack tool\",\"Ransomware\",\"Remote access trojan\",\"Spyware\")\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize EmailCount=count() by ThreatClassification, RecipientEmailAddress\r\n| summarize Count = arg_max(EmailCount, RecipientEmailAddress) by ThreatClassification\r\n| sort by Count desc",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    }
                  },
                  {
                    "columnMatch": "TopEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    }
                  }
                ],
                "filter": true
              },
              "statSettings": {
                "valueField": "RecipientEmailAddress",
                "valueAggregation": "None",
                "colorSettings": {
                  "type": "static",
                  "mode": "background",
                  "heatmapPalette": "greenRed",
                  "thresholdsGrid": []
                },
                "iconSettings": {
                  "thresholdsGrid": []
                },
                "tagText": "",
                "valueFontStyle": "auto"
              },
              "chartSettings": {
                "xAxis": "RecipientEmailAddress"
              }
            },
            "customWidth": "33",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 5 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections summarizing the data by ThreatNames of the malware detected.\r\nEmailEvents \r\n| where isnotempty(ThreatNames) and ThreatTypes has \"Malware\" \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize Count = count() by ThreatNames \r\n| sort by Count",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "chartSettings": {
                "xAxis": "ThreatNames",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "2"
      },
      "name": "group - 3",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Malware Detections by Delivery Location, Detection Technology and Sender Infrastructure Insights\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and explain malware detections delivery locations, detection technologies used for detections, sender infrastructure insights in inbound email identified by Microsoft Defender for Office 365 as Malware. \r\n"
            },
            "name": "text - 14 - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Malware Detections by delivery location\r\n**Visualizes daily counts of malware detections of inbound emails by delivery location: Quarantine or Failed (rejected with or without NDR)**"
            },
            "name": "text - 14 - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections over time summarizing the data daily by Delivery Location\r\nEmailEvents\r\n| where DetectionMethods has 'Malware' and EmailDirection == 'Inbound'\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| make-series TotalMalwareDetections=count(Key),Quarantine = countif(DeliveryLocation == 'Quarantine'), Failed=countif(DeliveryLocation == 'Failed') default = 0 on Timestamp step 1d ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalMalwareDetections",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Quarantine",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "Failed",
                    "color": "redDark"
                  }
                ]
              }
            },
            "customWidth": "100",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 10",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Malware Detections by Detection Technology\r\n**Visualizes daily counts of Malware detections of inbound emails by various Microsoft Defender for Office 365 detection technologies.**"
            },
            "name": "text - 14 - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections over time summarizing the data daily by various Malware detection technologies/controls in Microsoft Defender for Office 365.\r\nEmailEvents\r\n| where DetectionMethods has 'Malware'\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend ParsedMethods = parse_json(DetectionMethods)\r\n| mv-expand MalwareMethod = ParsedMethods.Malware\r\n| project Timestamp, Key, MalwareMethod\r\n| make-series Count= count(Key) default = 0 on Timestamp step 1d by tostring(MalwareMethod)",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "66",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections summarizing the data by various Malware detection technologies/controls in Microsoft Defender for Office 365.\r\nEmailEvents \r\n| where DetectionMethods has 'Malware'\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend ParsedMethods = parse_json(DetectionMethods)\r\n| mv-expand MalwareMethod = ParsedMethods.Malware\r\n| summarize Count = count() by tostring(MalwareMethod)\r\n| sort by Count desc",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "xAxis": "Malware"
              }
            },
            "customWidth": "33",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Malware Detections by SenderIPv4 Geo Location\r\n**Visualizes the email sending infrastructure sender IPv4 addresses associated with inbound emails detected as Malware, along with the IPv4 address geographic coordinates (latitude, longitude) and country information. Helps identify high-risk regions and sources for targeted threat mitigation.**"
            },
            "name": "text - 14 - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections summarizing the data by email sender IP address (SenderIPv4).\r\nEmailEvents \r\n| where ThreatTypes has 'Malware' and isnotempty(SenderIPv4)\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize count() by SenderIPv4\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\r\n| project SenderIPv4, Latitude, Longitude, count_\r\n\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Malware Detections-Sender Heatmap (IPv4)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "map",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "count_",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "count_",
                  "sortOrder": 2
                }
              ],
              "mapSettings": {
                "locInfo": "LatLong",
                "locInfoColumn": "GeoInfo",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections summarizing the data by email sender IP address and IP address country information (SenderIPv4).\r\nEmailEvents \r\n| where ThreatTypes has 'Malware' and isnotempty(SenderIPv4)\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Country = tostring(GeoInfo.country)\r\n| summarize count() by Country\r\n| project Country, MalwareEmailCount=count_\r\n| sort by MalwareEmailCount desc\r\n\r\n\r\n",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "MalwareEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": [],
              "mapSettings": {
                "locInfo": "LatLong",
                "locInfoColumn": "GeoInfo",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 1 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "2"
      },
      "name": "Malware-Detectiontech-Deliverylocation-SendingInfra",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Malware Detections Top attacked users and top senders\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and explain malware detections in inbound email as identified by Microsoft Defender for Office 365 focusing on top attacked users and top senders. \r\n"
            },
            "name": "text - 14 - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Malware Detections top attacked users\r\n**Displays the top 10 recipient email addresses that received inbound emails flagged as Malware. These users may be at higher risk and should be prioritised for targeted cybersecurity awareness training. Training should cover the specific threat types and techniques they are exposed to, and reinforce best practices for promptly reporting any suspicious messages that might bypass security controls and reach their inbox.**"
            },
            "customWidth": "50",
            "name": "text - 14 - Copy - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Sender Domains with Malware Detections (Inbound)\r\n**Displays the top 10 sender domains sending inbound emails detected as Malware. Helps identify external sources most frequently associated with malicious content for prioritised threat monitoring and mitigation.**"
            },
            "customWidth": "50",
            "name": "text - 14 - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Malware detections summarizing the data by the top 10 recipient email address (RecipientEmailAddress).\r\nEmailEvents \r\n| where ThreatTypes has 'Malware' and EmailDirection == 'Inbound'\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize count() by RecipientEmailAddress\r\n| sort by count_ \r\n| top 10 by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "xAxis": "RecipientEmailAddress",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 5",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Malware detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain).\r\nEmailEvents \r\n| where ThreatTypes has 'Malware' and EmailDirection == 'Inbound'\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize count() by SenderFromDomain\r\n| sort by count_ \r\n| top 10 by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "SenderFromDomain",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "SenderFromDomain",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "count_",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "xAxis": "SenderFromDomain",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Malware detections summarizing the data by the top 15 recipient email address (RecipientEmailAddress).\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(ThreatTypes has \"Malware\") by RecipientEmailAddress\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(MalwareEmailCount / todouble(TotalEmailCount) *100, 2))\r\n| where MalwareEmailCount !=0\r\n| sort by MalwareEmailCount desc\r\n| project RecipientEmailAddress,MalwareEmailCount, TotalEmailCount,Bad_Traffic_Percentage_Inbound\r\n| top 15 by MalwareEmailCount\r\n",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "MalwareEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": []
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 18",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections summarizing the data by the top 15 email sender P2 domain (SenderFromDomain). Adding additional insights for total inbound emails and bad traffic percentage for each sender domain.\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmailCount = count(), MalwareEmailCount = countif(ThreatTypes has \"Malware\") by SenderFromDomain\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(MalwareEmailCount / todouble(TotalEmailCount) *100, 2))\r\n| where MalwareEmailCount !=0\r\n| sort by MalwareEmailCount desc \r\n| project SenderFromDomain,MalwareEmailCount,TotalEmailCount,Bad_Traffic_Percentage_Inbound\r\n| top 15 by MalwareEmailCount",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "MalwareEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  },
                  {
                    "columnMatch": "BadEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": []
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 18",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "2"
      },
      "name": "MalwareTopAttackedUser-TopSenders",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "# Phishing Detection Insights\r\n\r\n---\r\nThis tab provides insights into email message **detections** by Microsoft Defender for Office 365 where the message contained a **Phishing threat** within its **email content**, **URLs**, or **attachments**."
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "3"
      },
      "name": "text - 24",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%;\">Phishing Detection Trend, LLM Content Analysis, Advanced Threats, and Threat Classes\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and explain Phish detections in inbound email as identified by Microsoft Defender for Office 365 focusing on daily trends, advanced threat detections, LLM-based content analysis, and threat classes."
            },
            "name": "text - 13"
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detection Trend<br>\r\n\r\n**This visual displays a daily trend of email Phish detections identified by Microsoft Defender for Office 365. The line chart summarises the number of messages flagged for Phish threats.**"
            },
            "name": "text - 13 - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections over time summarizing the data daily.\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where ThreatTypes has \"Phish\"\r\n| make-series PhishDetections = count() default = 0 on Timestamp step 1d \r\n",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detection Trend - Advanced Threats<br>\r\n\r\n**Not all threats are easily recognizable, which is why Microsoft Defender for Office 365 uses advanced detection methods, including virtual sandbox environments to detonate URLs and files. These virtual sandbox technologies look for known patterns, such as a recognisable login page in a URL, or a file accessing command and control infrastructure. This visual displays a daily trend of Phish detections of these advanced threats.**"
            },
            "name": "text - 13 - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections over time summarizing the data daily by Phish detection technologies/controls used for detecting unknown-unique phish.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where DetectionMethods has \"Phish\";\r\nlet fd=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'File detonation' and Phish !has 'File detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"File detonation\";\r\nlet ud=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL detonation' and Phish !has 'URL detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL detonation\";\r\nunion fd,ud\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "URL detonation",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "File detonation",
                    "color": "redDark"
                  }
                ]
              }
            },
            "customWidth": "100",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detection - LLM content analysis<br>\r\n\r\n**Microsoft Defender for Office 365 uses Language AI for Phish  and Business Email Compromise (BEC) detection. These models are progressively learning from thousands of real-world phishing attempts and analyzing all messages classified as phish. Furthermore, it incorporates advanced Machine Learning and Natural Language Processing (NLP) techniques to read, process, and understand email content the way a human analyst might, yet in a fraction of the time and at a large scale. [Learn more](https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/microsoft-defender-for-office-365s-language-ai-for-phish-enhancing-email-securit/4410446)**"
            },
            "customWidth": "33",
            "name": "text - 13 - Copy - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections - LLM Threat Classifications<br>\r\n\r\n**Microsoft Defender for Office 365 uses purpose-built Large Language Models (LLM) at scale to provide AI-powered email and collaboration security. Our solution now parses language to understand and identify attacker intent and classifies threats at machine speed  keeping malicious emails out of your inbox and giving security operations (SOC) teams a new level of insight into adversary techniques. [Learn more](https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/microsoft-ignite-redefining-email-security-with-llms-to-tackle-a-new-era-of-soci/4302421)**"
            },
            "customWidth": "33",
            "name": "text - 13 - Copy - Copy - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Top Attacked Users by LLM Threat classes (Phish)<br>\r\n\r\n**Displays recipients most frequently targeted by inbound phishing emails, grouped by threat classification (e.g., Gift Card, Invoice, Payroll). Helps identify users at higher risk for phishing attacks. These users may be at higher risk and should be prioritised for targeted cybersecurity awareness training. Training should cover the specific threat types and techniques they are exposed to, and reinforce best practices for promptly reporting any suspicious messages that might bypass security controls and reach their inbox.**"
            },
            "customWidth": "33",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of emails detected as Phish by LLM content analysis detection technology in Microsoft Defender for Office 365. \r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where ThreatTypes has 'Phish' and DetectionMethods contains \"LLM content analysis\"\r\n| summarize count()\r\n| sort by count_ desc",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "stat",
              "statSettings": {
                "valueAggregation": "None",
                "colorSettings": {
                  "type": "static",
                  "mode": "background",
                  "heatmapPalette": "greenRed",
                  "thresholdsGrid": []
                },
                "iconSettings": {
                  "thresholdsGrid": []
                },
                "tagText": "",
                "valueFontStyle": "auto",
                "tagTextPosition": "bottom"
              }
            },
            "customWidth": "33",
            "name": "query - 12",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px",
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections summarizing the data by intent of the message.\r\n// Microsoft Defender for Office 365 LLM analysis is analyzing email messages to understand the intent of the messages. These threat classifications are then used in filtering decisions.\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where ThreatTypes has 'Phish' and ThreatClassification  has_any(\"Business intelligence\",\"Contact establishment\",\"Gift card\",\"Invoice\",\"Payroll\",\"PII gathering\",\"Task\")\r\n| summarize count() by ThreatClassification\r\n| sort by count_ desc",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 10",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises Phish detections in emails summarizing by various Threat classes showing the top attacked user for each threat classification type.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where ThreatTypes has \"Phish\" and EmailDirection == \"Inbound\" and ThreatClassification has_any(\"Business intelligence\",\"Contact establishment\",\"Gift card\",\"Invoice\",\"Payroll\",\"PII gathering\",\"Task\")\r\n| summarize EmailCount=count() by ThreatClassification, RecipientEmailAddress\r\n| summarize Emails = arg_max(EmailCount, RecipientEmailAddress) by ThreatClassification\r\n| sort by Emails desc",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "33",
            "name": "query - 11",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "3"
      },
      "name": "group - 5",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Phish Detections by Delivery location, Detection technology and Sender infrastructure insights\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and explain Phish detections delivery locations, detection technologies used for detections, sender infrastructure insights in inbound email identified by Microsoft Defender for Office 365 as Phish."
            },
            "name": "text - 13 - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections by delivery location<br>\r\n\r\n**Visualizes daily counts of Phish detections of inbound emails by various delivery locations: Quarantine, Junk folder or Failed (rejected with or without NDR)**"
            },
            "name": "text - 13 - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections over time summarizing the data daily by Delivery Location.\r\n//The comment in the query excludes deliveries to the SecOps Mailboxes and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where DetectionMethods has \"Phish\" and EmailDirection == \"Inbound\"\r\n| make-series TotalPhishDetections=count(),Quarantine=countif(DeliveryLocation == \"Quarantine\"),Junkfolder=countif(DeliveryLocation == \"Junk folder\") ,Inbox=countif(DeliveryLocation == \"Inbox/folder\"),Failed=countif(DeliveryLocation == \"Failed\"),Dropped=countif(DeliveryLocation == \"Dropped\") default = 0 on Timestamp step 1d \r\n",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Quarantine",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "Failed",
                    "color": "green"
                  },
                  {
                    "seriesName": "Dropped",
                    "color": "green"
                  },
                  {
                    "seriesName": "Junk folder",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "Inbox",
                    "color": "redBright"
                  }
                ]
              }
            },
            "customWidth": "100",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 9",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish detections by Detection Technology<br>\r\n\r\n**Visualizes daily counts of Phish detections of inbound emails by various Microsoft Defender for Office 365 detection technologies.**"
            },
            "name": "text - 13 - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections over time summarizing the data daily by various Phish Detection technologies/controls in Microsoft Defender for Office 365.\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where DetectionMethods has \"Phish\";\r\nlet llm=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'LLM content analysis'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"LLM content analysis\";\r\nlet ml=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Advanced filter'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Advanced filter\";\r\nlet camp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Campaign'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Campaign\";\r\nlet fd=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'File detonation' and Phish !has 'File detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"File detonation\";\r\nlet fdr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'File detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"File detonation reputation\";\r\nlet frp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Fingerprint matching' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Fingerprint matching\";\r\nlet gf=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'General filter' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"General filter\";\r\nlet bimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation brand' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation brand\";\r\nlet dimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation domain' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation domain\";\r\nlet uimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation user' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation user\";\r\nlet mimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Mailbox intelligence impersonation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Mailbox intelligence impersonation\";\r\nlet sdmarc=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof DMARC' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof DMARC\";\r\nlet spoofe=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof external domain' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof external domain\";\r\nlet spoofi=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof intra-org' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof intra-org\";\r\nlet ud=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL detonation' and Phish !has 'URL detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL detonation\";\r\nlet udr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL detonation reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL detonation reputation\";\r\nlet umr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL malicious reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL malicious reputation\";\r\nunion llm,ml,camp,fd,fdr,frp,gf,bimp,dimp,uimp,mimp,sdmarc,spoofe,spoofi,ud,udr,umr\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "66",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 7",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections summarizing the data by various Phish detection technologies/controls in Microsoft Defender for Office 365.\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where ThreatTypes has 'Phish' \r\n| project Timestamp, DT=parse_json(DetectionMethods) \r\n| evaluate bag_unpack(DT) \r\n| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\r\n| sort by count_ desc",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "Phish",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "Detections",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "xAxis": "Phish",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 20
              }
            },
            "customWidth": "33",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections by SenderIPv4 Geo Location<br>\r\n\r\n**Visualizes the email sending infrastructure sender IPv4 addresses associated with inbound emails detected as Phish, along with the IPv4 address geographic coordinates (latitude, longitude) and country information. Helps identify high-risk regions and sources for targeted threat mitigation.**"
            },
            "name": "text - 13 - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections summarizing the data by email sender IP address (SenderIPv4).\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\" \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where ThreatTypes has \"Phish\" and isnotempty(SenderIPv4)\r\n| summarize count() by SenderIPv4\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\r\n| project SenderIPv4, Latitude, Longitude, count_",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections summarizing the data by email sender IP address and IP address country information (SenderIPv4).\r\nEmailEvents \r\n| where ThreatTypes has 'Phish' and isnotempty(SenderIPv4)\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Country = tostring(GeoInfo.country)\r\n| summarize count() by Country\r\n| project Country, PhishEmailCount=count_\r\n| sort by PhishEmailCount desc",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "PhishEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ]
              },
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 4 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "3"
      },
      "name": "group - 25- Phish delivery locations-detecion tech-sender infra",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Phish Detections Top attacked users and top senders\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and explain phish detections in inbound email as identified by Microsoft Defender for Office 365 focusing on top attacked users and top senders."
            },
            "name": "text - 13 - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections top attacked users\r\n**Displays the top 10 recipient email addresses that received inbound emails flagged as Phish. These users may be at higher risk and should be prioritised for targeted cybersecurity awareness training. Training should cover the specific threat types and techniques they are exposed to, and reinforce best practices for promptly reporting any suspicious messages that might bypass security controls and reach their inbox.**"
            },
            "customWidth": "50",
            "name": "text - 14 - Copy - Copy - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Sender Domains with Phish Detections (Inbound)\r\n**Displays the top 10 sender domains sending inbound emails detected as Phish. Helps identify external sources most frequently associated with malicious content for prioritised threat monitoring and mitigation.**"
            },
            "customWidth": "50",
            "name": "text - 14 - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Phish detections summarizing the data by the top 10 recipient email address (RecipientEmailAddress).\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where ThreatTypes has \"Phish\" and EmailDirection == \"Inbound\"\r\n| summarize count() by RecipientEmailAddress\r\n| sort by count_\r\n| top 10 by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "xAxis": "RecipientEmailAddress",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Phish detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain).\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where ThreatTypes has \"Phish\" and EmailDirection == \"Inbound\"\r\n| summarize count() by SenderFromDomain\r\n| sort by count_\r\n| top 10 by count_\r\n",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "SenderFromDomain",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "xAxis": "SenderFromDomain",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Phish detections summarizing the data by the top 15 recipient email address (RecipientEmailAddress).\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmailCount=count(),PhishEmailCount = countif(ThreatTypes has \"Phish\") by RecipientEmailAddress\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(PhishEmailCount / todouble(TotalEmailCount), 2))\r\n| where PhishEmailCount !=0\r\n| sort by PhishEmailCount desc\r\n| project RecipientEmailAddress,PhishEmailCount, TotalEmailCount,Bad_Traffic_Percentage_Inbound\r\n| top 15 by PhishEmailCount",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "PhishEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": []
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 18",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections summarizing the data by the top 15 email sender P2 domain (SenderFromDomain). Adding additional insights for total inbound emails and bad traffic percentage for each sender domain.\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where EmailDirection == \"Inbound\"\r\n| summarize TotalEmailCount = count(),\r\n            PhishEmailCount = countif(ThreatTypes has \"Phish\") by SenderFromDomain\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(PhishEmailCount / todouble(TotalEmailCount) * 100, 2))\r\n| where PhishEmailCount !=0\r\n| sort by PhishEmailCount desc \r\n| project SenderFromDomain,PhishEmailCount,TotalEmailCount,Bad_Traffic_Percentage_Inbound\r\n| top 15 by PhishEmailCount\r\n",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "PhishEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "BadEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": []
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 18",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "3"
      },
      "name": "group - 26-PhishDetectionsTopattackedusers-topsenders",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "# Spam Detection Insights\r\n\r\n---\r\nThis tab provides insights into email message **detections** by Microsoft Defender for Office 365 where the message contained a **Spam threat** within its **email content**, **URLs**, or **attachments**."
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "4"
      },
      "name": "text - 24 - Copy",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Spam Detection Effectiveness and Trends\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and explain Spam detections in inbound email as identified by Microsoft Defender for Office 365 focusing on Effectiveness and daily trend. For effectiveness, we consider messages reported by your admins and decisions made post-delivery."
            },
            "name": "text - 13 - Copy"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "//This query calculates the effectiveness of spam detections without edge data.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\n// baseQuery _FN_Admin_Submissions_SPM\r\nlet _FN_Admin_Submissions_SPM = toscalar(\r\nCloudAppEvents\r\n| where Timestamp between (minTime .. maxTime)\r\n| where ActionType == \"AdminSubmissionSubmitted\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType)\r\n| extend NetworkMessageId = tostring((parse_json(RawEventData)).ObjectId)\r\n| where SubmissionType in (\"3\")\r\n| summarize count()\r\n);\r\n// baseQuery _FN_ZAP_Successful_Spam\r\nlet _FN_ZAP_Successful_Spam = toscalar(\r\nEmailPostDeliveryEvents\r\n| where ActionTrigger == \"SpecialAction\" and ActionType == \"Spam ZAP\" and ActionResult == \"Success\" and Timestamp between (minTime .. maxTime)\r\n| summarize count()\r\n    //Take all our Spam ZAP, and count how many messages we missed and successfully cleaned up.\r\n);\r\n// baseQuery _FN_ZAP_Unsuccessful_Spam\r\nlet _FN_ZAP_Unsuccessful_Spam = toscalar(\r\nEmailPostDeliveryEvents\r\n| where ActionTrigger == \"SpecialAction\" and ActionType == \"Spam ZAP\" and ActionResult != \"Success\"\r\n| summarize count()\r\n//Take all our Spam ZAP, and count how many messages we failed to clean up due to error or users/admins/API vendors getting to the message first.\r\n);\r\n// baseQuery _SPAM_ZAP_FP\r\nlet _SPAM_ZAP_FP = toscalar(\r\nEmailPostDeliveryEvents\r\n| where ActionTrigger == \"SpecialAction\" and ActionType == \"Redelivery\" and Timestamp between (minTime .. maxTime)\r\n| join kind=leftsemi (\r\n            EmailEvents\r\n            | where Timestamp between (minTime ..maxTime )\r\n            | where ThreatTypes contains \"Spam\"\r\n            | project NetworkMessageId, ThreatTypes)\r\n            on NetworkMessageId\r\n| summarize count()\r\n// count all the FPs which were originally Spam, and when we TT'd them were not so we can subtract that from our mailfow catch, and therefore the total true bad.\r\n);\r\n// baseQuery _Spam_Mailflow\r\nlet _Spam_Mailflow = toscalar(\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\" and ThreatTypes == \"Spam\" and Timestamp between (minTime .. maxTime)\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize count()\r\n// Get all the mailflow detected as SPM, then count all the NMIDs (not distinct)\r\n);\r\nprint\r\nEffectiveness_PostDelivery = abs(round(((toreal(toscalar(_FN_Admin_Submissions_SPM))+toreal(toscalar(_FN_ZAP_Unsuccessful_Spam)))/(toreal(toscalar(_Spam_Mailflow))+toreal(toscalar(_FN_ZAP_Successful_Spam))+toreal(toscalar(_FN_ZAP_Unsuccessful_Spam))+toreal(toscalar(_FN_Admin_Submissions_SPM))-toreal(toscalar(_SPAM_ZAP_FP)))*100-100),2))",
                    "size": 1,
                    "showAnalytics": true,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "stat",
                    "statSettings": {
                      "valueAggregation": "None",
                      "colorSettings": {
                        "type": "thresholds",
                        "mode": "foreground",
                        "heatmapPalette": "greenRed",
                        "thresholdsGrid": [
                          {
                            "operator": ">",
                            "thresholdValue": "95",
                            "representation": "green"
                          },
                          {
                            "operator": "<=",
                            "thresholdValue": "95",
                            "representation": "orange"
                          },
                          {
                            "operator": "<=",
                            "thresholdValue": "90",
                            "representation": "red"
                          }
                        ]
                      },
                      "iconSettings": {
                        "thresholdsGrid": []
                      },
                      "numberFormatSettings": {
                        "unit": 1,
                        "options": {
                          "style": "decimal"
                        }
                      },
                      "tagText": "Spam Effectiveness (without Edge data)",
                      "valueFontStyle": "superLarge",
                      "tagTextPosition": "bottom"
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 11",
                  "styleSettings": {
                    "margin": "10px",
                    "padding": "10px"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\n// baseQuery _FN_Admin_Submissions_SPM\r\nlet _FN_Admin_Submissions_SPM = toscalar(\r\nCloudAppEvents\r\n| where Timestamp between (minTime .. maxTime)\r\n| where ActionType == \"AdminSubmissionSubmitted\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType)\r\n| extend NetworkMessageId = tostring((parse_json(RawEventData)).ObjectId)\r\n| where SubmissionType in (\"3\")\r\n| summarize count()\r\n);\r\n// baseQuery _FN_ZAP_Successful_Spam\r\nlet _FN_ZAP_Successful_Spam = toscalar(\r\nEmailPostDeliveryEvents\r\n| where ActionTrigger == \"SpecialAction\" and ActionType == \"Spam ZAP\" and ActionResult == \"Success\" and Timestamp between (minTime .. maxTime)\r\n| summarize count()\r\n    //Take all our Spam ZAP, and count how many messages we missed and successfully cleaned up.\r\n);\r\n// baseQuery _FN_ZAP_Unsuccessful_Spam\r\nlet _FN_ZAP_Unsuccessful_Spam = toscalar(\r\nEmailPostDeliveryEvents\r\n| where ActionTrigger == \"SpecialAction\" and ActionType == \"Spam ZAP\" and ActionResult != \"Success\"\r\n| summarize count()\r\n//Take all our Spam ZAP, and count how many messages we failed to clean up due to error or users/admins/API vendors getting to the message first.\r\n);\r\n// baseQuery _SPAM_ZAP_FP\r\nlet _SPAM_ZAP_FP = toscalar(\r\nEmailPostDeliveryEvents\r\n| where ActionTrigger == \"SpecialAction\" and ActionType == \"Redelivery\" and Timestamp between (minTime .. maxTime)\r\n| join kind=leftsemi (\r\n            EmailEvents\r\n            | where Timestamp between (minTime ..maxTime )\r\n            | where ThreatTypes contains \"Spam\"\r\n            | project NetworkMessageId, ThreatTypes)\r\n            on NetworkMessageId\r\n| summarize count()\r\n// count all the FPs which were originally Spam, and when we TT'd them were not so we can subtract that from our mailfow catch, and therefore the total true bad.\r\n);\r\n// baseQuery _Spam_Mailflow\r\nlet _Spam_Mailflow = toscalar(\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\" and ThreatTypes == \"Spam\" and Timestamp between (minTime .. maxTime)\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize count()\r\n// Get all the mailflow detected as SPM, then count all the NMIDs (not distinct)\r\n);\r\nprint StatisticName=\"Spam Mailflow Minus FPs\", Value=toreal((toscalar(_Spam_Mailflow)) - toreal(toscalar(_SPAM_ZAP_FP)))\r\n| union (print StatisticName=\"Spam Admin FNs Submitted\", Value=toreal(toscalar(_FN_Admin_Submissions_SPM)))\r\n| union (print StatisticName=\"Spam FPs Reverse Zapped\", Value=toreal(toscalar(_SPAM_ZAP_FP)))\r\n| union (print StatisticName=\"Spam Zapped Sucessfully\", Value=toreal(toscalar(_FN_ZAP_Successful_Spam)))\r\n| union (print StatisticName=\"Spam NotZapped\", Value=toreal(toscalar(_FN_ZAP_Unsuccessful_Spam)))\r\n| union (print StatisticName=\"Spam Effectiveness Post Delivery %\", Value=abs(round(((toreal(toscalar(_FN_Admin_Submissions_SPM)) + toreal(toscalar(_FN_ZAP_Unsuccessful_Spam))) / (toreal(toscalar(_Spam_Mailflow)) + toreal(toscalar(_FN_ZAP_Successful_Spam)) + toreal(toscalar(_FN_ZAP_Unsuccessful_Spam)) + toreal(toscalar(_FN_Admin_Submissions_SPM)) - toreal(toscalar(_SPAM_ZAP_FP)))) * 100 - 100, 2)))\r\n| union (print StatisticName=\"Spam Effectiveness Pre-Delivery %\", Value=abs(round(((toreal(toscalar(_FN_Admin_Submissions_SPM)) + toreal(toscalar(_FN_ZAP_Unsuccessful_Spam)) + (toscalar(_FN_ZAP_Successful_Spam))) / (toreal(toscalar(_Spam_Mailflow)) + toreal(toscalar(_FN_ZAP_Successful_Spam)) + toreal(toscalar(_FN_ZAP_Unsuccessful_Spam)) + toreal(toscalar(_FN_Admin_Submissions_SPM)) - toreal(toscalar(_SPAM_ZAP_FP)))) * 100 - 100, 2 )))",
                    "size": 0,
                    "showAnalytics": true,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "table",
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "StatisticName",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "Value",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 12",
                  "styleSettings": {
                    "margin": "10px",
                    "padding": "10px"
                  }
                }
              ]
            },
            "customWidth": "100",
            "name": "Spam Effectiveness"
          },
          {
            "type": 1,
            "content": {
              "json": "### Spam Detection Trend<br>\r\n\r\n**This visual displays a daily trend of email Spam detections identified by Microsoft Defender for Office 365. The line chart summarises the number of messages flagged for Spam threats.**"
            },
            "name": "text - 13 - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spam detections over time summarizing the data daily.\r\nEmailEvents \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where ThreatTypes has \"Spam\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| make-series Count = count() default = 0 on Timestamp step 1d \r\n| extend Details = \"SpamDetections\";",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Emails",
                    "color": "redDark"
                  }
                ]
              }
            },
            "customWidth": "100",
            "name": "query - 13",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "4"
      },
      "name": "group - 6-Spam-detections-trend",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Spam Detections by Delivery location, Detection technology, Sender infrastructure and Bulk insights\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and explain Spam detections delivery locations, detection technologies used for detections, sender infrastructure and Bulk insights in inbound email identified by Microsoft Defender for Office 365 as Spam."
            },
            "name": "text - 13 - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Spam Detections by delivery location<br>\r\n\r\n**Visualizes daily counts of Spam detections of inbound emails by various delivery locations Quarantine, Junk folder or Failed (rejected with or without NDR)**"
            },
            "name": "text - 13 - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spam detections over time summarizing the data daily by Delivery Location.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where DetectionMethods has \"Spam\" and EmailDirection == \"Inbound\"\r\n| make-series TotalSpamDetections=count(),Quarantine = countif(DeliveryLocation == \"Quarantine\"),Junkfolder=countif(DeliveryLocation == \"Junk folder\") ,Inbox=countif(DeliveryLocation == \"Inbox/folder\"),Failed=countif(DeliveryLocation == \"Failed\"),Dropped=countif(DeliveryLocation == \"Dropped\") default = 0 on Timestamp step 1d ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalSpamDetections",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Quarantine",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "Junkfolder",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "Inbox",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "Failed",
                    "color": "red"
                  },
                  {
                    "seriesName": "Dropped",
                    "color": "redDark"
                  }
                ]
              }
            },
            "customWidth": "100",
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Spam Detections Detection Technology<br>\r\n\r\n**Visualizes daily counts of Spam detections of inbound emails by various Microsoft Defender for Office 365 detection technologies.**"
            },
            "name": "text - 13 - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spam detections over time summarizing the data daily by various Spam Detection technologies/controls in Microsoft Defender for Office 365.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where DetectionMethods has \"Spam\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key;\r\nlet mailbombing=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Mail bombing'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Mail bombing\";\r\nlet ml=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Advanced filter'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Advanced filter\";\r\nlet gf=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'General filter'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"General filter\";\r\nlet bl=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'BulkFilter'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"BulkFilter\";\r\nlet mx=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Mixed analysis detection'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Mixed analysis detection\";\r\nlet frp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Fingerprint matching'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Fingerprint matching\";\r\nlet umr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'URL malicious reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL malicious reputation\";\r\nlet dr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Domain reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Domain reputation\";\r\nlet ipr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'IP reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"IP reputation\";\r\nunion ml,gf,bl,mx,frp,umr,dr,ipr,mailbombing\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "66",
            "name": "query - 7",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spam detections summarizing the data by various Spam detection technologies/controls in Microsoft Defender for Office 365.\r\nEmailEvents \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where DetectionMethods has 'Spam' \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| project Timestamp, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) | summarize count() by Spam=tostring(column_ifexists('Spam', ''))\r\n| sort by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "xAxis": "Spam",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 8
              }
            },
            "customWidth": "33",
            "name": "query - 15",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Spam Detections by SenderIPv4 Geo Location<br>\r\n\r\n**Visualizes the email sending infrastructure sender IPv4 addresses associated with inbound emails detected as Spam, along with the IPv4 address geographic coordinates (latitude, longitude) and country information. Helps identify high-risk regions and sources for targeted threat mitigation.**"
            },
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spam detections summarizing the data by email sender IP address (SenderIPv4).\r\nEmailEvents \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where ThreatTypes has \"Spam\" and isnotempty(SenderIPv4)\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize count() by SenderIPv4\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\r\n| project SenderIPv4, Latitude, Longitude, count_  ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "locInfoColumn": "SenderIPv4",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "name": "query - 14",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections summarizing the data by email sender IP address and IP address country information (SenderIPv4).\r\nEmailEvents \r\n| where ThreatTypes has 'Spam' and isnotempty(SenderIPv4)\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Country = tostring(GeoInfo.country)\r\n| summarize count() by Country\r\n| project Country, SpamEmailCount=count_\r\n| sort by SpamEmailCount desc",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SpamEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ]
              },
              "mapSettings": {
                "locInfo": "LatLong",
                "locInfoColumn": "SenderIPv4",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "name": "query - 14 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Spam Detections Bulk Insights<br>\r\n\r\n**Displays the distribution of inbound emails across different Bulk Complaint Levels together with Top 10 domains sending Bulk email (grey mail). Helps identify patterns in bulk email complaints and assess potential spam or unwanted message trends.**"
            },
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails which has any Bulk complaint level. It is summarizing the data by the various Bulk Complaint levels to understand how many messages are detected with each Bulk Complaint level.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where EmailDirection == \"Inbound\" and BulkComplaintLevel !=\"\"\r\n| summarize count() by BulkComplaintLevel\r\n| sort by BulkComplaintLevel desc\r\n| project BulkComplaintLevel,Emails=count_",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "blueDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 9",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails which has any Bulk complaint level. It is summarizing the data by the various Bulk Complaint levels and SenderFromDomain of the email sender. It provides insights how many messages are detected with each Bulk Complaint level for each sender domain.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where EmailDirection == \"Inbound\" and BulkComplaintLevel !=\"\"\r\n| summarize count() by BulkComplaintLevel, SenderFromDomain\r\n| sort by count_ desc\r\n| project SenderFromDomain,BulkComplaintLevel,Emails=count_\r\n| take 10",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 10",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "4"
      },
      "name": "group - 28-Spam-Delivery location-Detection technology-Sender infrastructure insights",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "\r\n<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Spam Detections Top attacked users and top senders\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and explain spam detections in inbound email as identified by Microsoft Defender for Office 365 focusing on top attacked users and top senders."
            },
            "name": "text - 13 - Copy - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Spam Detections top attacked users<br>\r\n\r\n**Displays the top 10 recipient email addresses that received inbound emails flagged as Spam. These users may be at higher risk and should be prioritised for targeted cybersecurity awareness training. Training should cover the specific threat types and techniques they are exposed to, and reinforce best practices for promptly reporting any suspicious messages that might bypass security controls and reach their inbox.**"
            },
            "customWidth": "50",
            "name": "text - 13 - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Sender Domains with Spam Detections (Inbound)<br>\r\n\r\n**Displays the top 10 sender domains sending inbound emails detected as Spam. Helps identify external sources most frequently associated with spam content for prioritised monitoring and mitigation.**"
            },
            "customWidth": "50",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Spam detections summarizing the data by the top 10 recipient email address (RecipientEmailAddress).\r\nEmailEvents \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where ThreatTypes has \"Spam\" and EmailDirection ==\"Inbound\" \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize count() by RecipientEmailAddress \r\n| sort by count_ desc\r\n| take 10",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "group": "RecipientEmailAddress",
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 17 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Spam detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain).\r\nEmailEvents \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where ThreatTypes has \"Spam\" and EmailDirection ==\"Inbound\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize count() by SenderFromDomain\r\n| sort by count_ desc \r\n| take 10",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "group": "SenderFromDomain",
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 17",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Spam detections summarizing the data by the top 15 recipient email address (RecipientEmailAddress).\r\nEmailEvents \r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where EmailDirection ==\"Inbound\" \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmailCount=count(),SpamEmailCount = countif(ThreatTypes has \"Spam\") by RecipientEmailAddress\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(SpamEmailCount / todouble(TotalEmailCount)* 100, 2))\r\n| where SpamEmailCount !=0\r\n| sort by SpamEmailCount desc\r\n| project RecipientEmailAddress,SpamEmailCount, TotalEmailCount,Bad_Traffic_Percentage_Inbound\r\n| top 15 by SpamEmailCount",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SpamEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "blue"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": []
            },
            "customWidth": "50",
            "name": "query - 18 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Spam detections summarizing the data by the top 15 email sender P2 domain (SenderFromDomain). Adding additional insights for total inbound emails and bad traffic percentage for each sender domain.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where EmailDirection == \"Inbound\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmailCount = count(),\r\n            SpamEmailCount = countif(ThreatTypes has \"Spam\") by SenderFromDomain\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(SpamEmailCount / todouble(TotalEmailCount) * 100, 2))\r\n| where SpamEmailCount !=0\r\n| sort by SpamEmailCount desc \r\n| project SenderFromDomain,SpamEmailCount,TotalEmailCount,Bad_Traffic_Percentage_Inbound\r\n| top 15 by SpamEmailCount",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SpamEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": []
            },
            "customWidth": "50",
            "name": "query - 18",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "4"
      },
      "name": "group - 29-Spam Detections Top attacked users and top senders",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Phish Detections Business Email Compromise (BEC) detections\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and explain phish detections in inbound email as identified by Microsoft Defender for Office 365 focusing on Business Email Compromise (BEC) detections Impersonation and Spoof."
            },
            "name": "text - 13 - Copy - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections - Impersonation detections Trend\r\n**Displays daily counts of inbound emails flagged for Business Email Compromise (BEC) using Impersonation detection methods by Microsoft Defender for Office 365. Helps track impersonation attack patterns over time.**"
            },
            "customWidth": "100",
            "name": "text - 14 - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Impersonation detections over time summarizing the data daily.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where DetectionMethods has 'Impersonation' \r\n| make-series Count = count() default = 0 on Timestamp step 1d \r\n| extend Details = \"ImpersonatedEmails\";",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "name": "query - 5",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections - Impersonation detections by Detection Technology\r\n**Visualizes daily counts of Phish detections of inbound emails by various Microsoft Defender for Office 365 detection technologies used for detecting Impersonations.**"
            },
            "customWidth": "100",
            "name": "text - 14 - Copy - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Impersonation detections over time summarizing the data daily by various Impersonation Detection technologies/controls in Microsoft Defender for Office 365.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where DetectionMethods has \"Phish\";\r\nlet bimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation brand' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation brand\";\r\nlet dimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation domain' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation domain\";\r\nlet uimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation user' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation user\";\r\nlet mimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Mailbox intelligence impersonation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Mailbox intelligence impersonation\";\r\nunion bimp,dimp,uimp,mimp\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "66",
            "name": "query - 7",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Impersonation detections summarizing the data by various Impersonation detection technologies/controls in Microsoft Defender for Office 365.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where DetectionMethods has 'Impersonation' \r\n| project Timestamp, DT=parse_json(DetectionMethods) \r\n| evaluate bag_unpack(DT) \r\n| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\r\n| sort by count_ desc\r\n",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false
              },
              "graphSettings": {
                "type": 0
              }
            },
            "customWidth": "33",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px",
              "showBorder": true
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections - Impersonation detections by SenderIPv4 Geo Location\r\n**Visualizes the email sending infrastructure sender IPv4 addresses associated with inbound emails detected as Phish - Impersonation, along with the IPv4 address geographic coordinates (latitude, longitude) and country information. Helps identify high-risk regions and sources for targeted threat mitigation.**"
            },
            "customWidth": "100",
            "name": "text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Impersonation detections summarizing the data by email sender IP address (SenderIPv4).\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where DetectionMethods contains 'Impersonation' and isnotempty(SenderIPv4)\r\n//| project Timestamp, EmailDirection, SenderFromAddress, AdditionalFields, SenderIPv4 \r\n| summarize count()by SenderIPv4\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\r\n| project SenderIPv4, Latitude, Longitude, count_  ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "name": "query - 6",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections summarizing the data by email sender IP address and IP address country information (SenderIPv4).\r\nEmailEvents \r\n| where DetectionMethods contains 'Impersonation' and isnotempty(SenderIPv4)\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Country = tostring(GeoInfo.country)\r\n| summarize count() by Country\r\n| project Country, PhishImpersonationEmailCount=count_\r\n| sort by PhishImpersonationEmailCount desc",
              "size": 0,
              "showAnalytics": true,
              "title": "Impersonation Detections-Sender Heatmap (IPv4)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "PhishImpersonationEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ]
              },
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "name": "query - 6 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections - Spoof detections Trend\r\n**Displays daily counts of inbound emails flagged for Business Email Compromise (BEC) using Spoof detection methods by Microsoft Defender for Office 365. Helps track Spoofing based attack patterns over time.**"
            },
            "customWidth": "100",
            "name": "text - 14 - Copy - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Spoof detections over time summarizing the data daily.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where DetectionMethods has 'Spoof' \r\n| make-series Count = count() default = 0 on Timestamp step 1d \r\n| extend Details = \"SpoofEmails\";",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections - Spoof detections Trend by Detection Technology\r\n**Visualizes daily counts of Phish detections of inbound emails by various Microsoft Defender for Office 365 detection technologies used for detecting Spoofing.**"
            },
            "customWidth": "100",
            "name": "text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Spoof detections over time summarizing the data daily by various Spoof Detection technologies/controls in Microsoft Defender for Office 365.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where DetectionMethods has \"Phish\";\r\nlet sdmarc=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof DMARC' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof DMARC\";\r\nlet spoofe=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof external domain' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof external domain\";\r\nlet spoofi=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof intra-org' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof intra-org\";\r\nunion sdmarc, spoofe, spoofi\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "[\"Spoof external domain\"]",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "[\"Spoof intra-org\"]",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "[\"Spoof DMARC\"]",
                    "color": "yellowDark"
                  }
                ]
              }
            },
            "customWidth": "66",
            "name": "query - 20",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Spoof detections detections summarizing the data by various Spoof detection technologies/controls in Microsoft Defender for Office 365.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where DetectionMethods has 'Spoof' \r\n| project Timestamp, DT=parse_json(DetectionMethods) \r\n| evaluate bag_unpack(DT) \r\n| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\r\n| sort by count_ desc",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "xAxis": "Phish",
                "yAxis": [
                  "count_"
                ]
              }
            },
            "customWidth": "33",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px",
              "showBorder": true
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections - Spoof detections by SenderIPv4 Geo Location\r\n**Visualizes the email sending infrastructure sender IPv4 addresses associated with inbound emails detected as Phish - Spoofing, along with the IPv4 address geographic coordinates (latitude, longitude) and country information. Helps identify high-risk regions and sources for targeted threat mitigation.**"
            },
            "customWidth": "100",
            "name": "text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Spoof detections summarizing the data by email sender IP address (SenderIPv4).\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where DetectionMethods contains 'spoof' and isnotempty(SenderIPv4)\r\n//| project Timestamp, EmailDirection, SenderFromAddress, AdditionalFields, SenderIPv4 \r\n| summarize count()by SenderIPv4\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\r\n| project SenderIPv4, Latitude, Longitude, count_  ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "name": "query - 3",
            "styleSettings": {
              "margin": "15px",
              "padding": "15px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections summarizing the data by email sender IP address and IP address country information (SenderIPv4).\r\nEmailEvents \r\n| where DetectionMethods contains 'Spoof' and isnotempty(SenderIPv4)\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Country = tostring(GeoInfo.country)\r\n| summarize count() by Country\r\n| project Country, PhishSpoofEmailCount=count_\r\n| sort by PhishSpoofEmailCount desc",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "PhishSpoofEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ]
              },
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "name": "query - 3 - Copy",
            "styleSettings": {
              "margin": "15px",
              "padding": "15px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections - Top Outbound Recipient Domains with Inbound Threat Correlation (Possible Partner compromise)\r\n**Visualizes the domains most frequently targeted by outbound emails and correlates them with inbound emails carrying threats from the same domains in Inbound emails. Helps identify risky communication channels and potential compromise points.**"
            },
            "customWidth": "100",
            "name": "text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises top outbound recipient domains by outbound email volume and shows total number of inbound emails with Threats from the same domains (as inbound senders) \r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where EmailDirection == \"Outbound\"\r\n| project RecipientDomain = tostring(split(RecipientEmailAddress, \"@\")[1])\r\n| summarize count() by RecipientDomain\r\n| project OutboundCount=count_, RecipientDomain, SenderFromDomain=RecipientDomain\r\n| join (EmailEvents | where EmailDirection == \"Inbound\" and isempty(ThreatTypes)==false) on SenderFromDomain\r\n| summarize max(OutboundCount),count() by SenderFromDomain\r\n| project SenderFromDomain, OutboundEmails=max_OutboundCount, IncomingEmailsWithThreats=count_\r\n| extend Bad_Traffic_Percentage = todouble(round(IncomingEmailsWithThreats / todouble(OutboundEmails), 2))\r\n| project SenderFromDomain, OutboundEmails, IncomingEmailsWithThreats, Bad_Traffic_Percentage\r\n| sort by OutboundEmails",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "OutboundEmails",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "IncomingEmailsWithThreats",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "60ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "100",
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "3"
      },
      "name": "group - 7 - Phish-BEC-Insights",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Phish Detections Sender Authentication details (DMARC, DKIM, SPF, CompAuth)\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and explain Sender Authentication checks details in inbound email by Microsoft Defender for Office 365 focusing on the various Sender Authentication standards: DMARC, DKIM, SPF, CompAuth."
            },
            "name": "text - 13 - Copy - Copy - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections Sender Authentication Trend (DMARC, DKIM, SPF, CompAuth)\r\n**Shows daily counts of sender authentication check outcomes (DMARC, DKIM, SPF, CompAuth) performed by Microsoft Defender for Office 365 on inbound emails. Useful for monitoring authentication success and failure patterns over time to identify anomalies or potential phishing risks.**"
            },
            "customWidth": "100",
            "name": "text - 14 - Copy - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spoof- DMARC fails summarizing the data daily.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend DMARCFail = AuthenticationDetails has_any ('DMARC\":\"fail') \r\n| summarize DMARCFail = sum(DMARCFail) by bin (Timestamp,1d)",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "DMARCFail",
                    "color": "orangeDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 22",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spoof- DKIM fails summarizing the data daily.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend DKIMFail = AuthenticationDetails has_any ('DKIM\":\"fail') \r\n| summarize DKIMCFail = sum(DKIMFail) by bin (Timestamp,1d)",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "DKIMCFail",
                    "color": "yellowDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 24",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spoof- SPF fails summarizing the data daily.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend SPFFail = AuthenticationDetails has_any ('SPF\":\"fail') \r\n| summarize SPFFail = sum(SPFFail) by bin (Timestamp,1d)",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "SPFFail",
                    "color": "purpleDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 23",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spoof- Composite Authentication fails summarizing the data daily.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend CompAuthFail = AuthenticationDetails has_any ('CompAuth\":\"fail') \r\n| summarize CompAuthFail = sum(CompAuthFail) by bin (Timestamp,1d)",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "CompAuthFail",
                    "color": "blueDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 21",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections Top Sender Domains with DMARC Failures (Inbound)\r\n**Displays the top 10 sender domains (P1 and P2) for inbound emails where Spoof-DMARC detection triggered. Includes total inbound email volume and calculates DMARC fail traffic percentage per domain to highlight high-risk sources.**"
            },
            "customWidth": "100",
            "name": "text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spoof-DMARC fails detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain) and sender P1 domain (SenderMailFromDomain). Adding additional insights for total inbound emails and DMARC fail traffic percentage for each sender domain.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where EmailDirection == \"Inbound\"\r\n| summarize TotalEmailCount = count(),\r\n            DMARCFailCount = countif(DetectionMethods has_any ('Phish\":[\"Spoof DMARC\"]')) by P1Sender=SenderMailFromDomain, P2Sender=SenderFromDomain\r\n| extend DMARCFail_Traffic_Percentage = todouble(round(DMARCFailCount / todouble(TotalEmailCount) * 100, 2))\r\n| where DMARCFailCount !=0\r\n| sort by DMARCFailCount desc \r\n| project P1Sender,P2Sender,DMARCFailCount,TotalEmailCount,DMARCFail_Traffic_Percentage\r\n| top 10 by DMARCFailCount",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "DMARCFail",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "DMARCFail_Traffic_Percentage",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "100",
            "name": "query - 26",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections Top Sender Domains with Spoof External Domain Detections (Inbound)\r\n**Displays the top 10 sender domains (P1 and P2) for inbound emails flagged for Spoof External Domain detection. Includes total inbound email volume and calculates spoof traffic percentage per domain to highlight high-risk sources.**"
            },
            "customWidth": "50",
            "name": "text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phish Detections Top Sender Domains with Spoof Internal Domain Detections (Inbound)\r\n**Displays the top 10 sender domains (P1 and P2) for inbound emails flagged for Spoof Internal Domain detection. Includes total inbound email volume and calculates spoof traffic percentage per domain to highlight high-risk sources.**"
            },
            "customWidth": "50",
            "name": "text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish-Spoof-external domain detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain) and sender P1 domain (SenderMailFromDomain). Adding additional insights for total inbound emails and Spoof external domain detection traffic percentage for each sender domain.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where EmailDirection == \"Inbound\"\r\n| summarize TotalEmailCount = count(),\r\n            SpoofExternalCount = countif(DetectionMethods has_any ('Phish\":[\"Spoof external domain\"]')) by P1Sender=SenderMailFromDomain, P2Sender=SenderFromDomain\r\n| extend SpoofExternal_Traffic_Percentage = todouble(round(SpoofExternalCount / todouble(TotalEmailCount) * 100, 2))\r\n| where SpoofExternalCount !=0\r\n| sort by SpoofExternalCount desc \r\n| project P1Sender,P2Sender,SpoofExternalCount,TotalEmailCount,SpoofExternal_Traffic_Percentage\r\n| top 10 by SpoofExternalCount",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SpoofExternalCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "SpoofExternal_Traffic_Percentage",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "SpoofExternalFail",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 26 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish-Spoof-internal domain detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain) and sender P1 domain (SenderMailFromDomain). Adding additional insights for total inbound emails and Spoof internal domain detection traffic percentage for each sender domain.\r\nEmailEvents\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where EmailDirection == \"Inbound\"\r\n| summarize TotalEmailCount = count(),\r\n            SpoofInternalCount = countif(DetectionMethods has_any ('Phish\":[\"Spoof intra-org\"]')) by P1Sender=SenderMailFromDomain, P2Sender=SenderFromDomain\r\n| extend SpoofInternal_Traffic_Percentage = todouble(round(SpoofInternalCount / todouble(TotalEmailCount) * 100, 2))\r\n| where SpoofInternalCount !=0\r\n| sort by SpoofInternalCount desc \r\n| project P1Sender,P2Sender,SpoofInternalCount,TotalEmailCount,SpoofInternal_Traffic_Percentage\r\n| top 10 by SpoofInternalCount",
              "size": 3,
              "showAnalytics": true,
              "title": "Top 10 Spoof intra-org detections by Sender domain (P1/P2)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SpoofInternalCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "SpoofInternal_Traffic_Percentage",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "SpoofIntraorgFail",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 26 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "3"
      },
      "name": "group - 8-Phish-SenderAuth",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "# URL Detections and URL Click Insights\r\n\r\n---\r\nThis tab provides insights into **URL-based detections** in email messages and details about URL clicks performed by end users on URLs identified as **malicious**."
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "5"
      },
      "name": "text - 24 - Copy - Copy",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Insights on URL-Based Threat Detections\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and explain URL based threat detections in inbound email as identified by Microsoft Defender for Office 365 focusing on daily trends of URL-based threat detections, QR code detections, and URL scans activity by locations."
            },
            "name": "text - 13 - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Trend of URL-Based Malware Threat Detections<br>\r\n\r\n**This visual displays a daily trend of emails with URL based Malware threat detections identified by Microsoft Defender for Office 365. The line chart summarises the number of messages flagged for malware threats.**"
            },
            "name": "text - 13 - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections over time summarizing the data daily by various Malware URL threat based detection technologies/controls in Microsoft Defender for Office 365.\r\nEmailEvents\r\n| where DetectionMethods has 'Malware'\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend ParsedMethods = parse_json(DetectionMethods)\r\n| mv-expand MalwareMethod = ParsedMethods.Malware\r\n| where MalwareMethod contains \"URL\"\r\n| project Timestamp, Key, MalwareMethod\r\n| make-series Count= count(Key) default = 0 on Timestamp step 1d by tostring(MalwareMethod)",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "name": "query - 8 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### URL based Phish threat detections Trend<br>\r\n\r\n**This visual displays a daily trend of emails with URL based Phish threat detections identified by Microsoft Defender for Office 365. The line chart summarises the number of messages flagged for Phish threats.**"
            },
            "name": "text - 13 - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections over time summarizing the data daily by various Malware URL threat based detection technologies/controls in Microsoft Defender for Office 365.\r\nEmailEvents\r\n| where DetectionMethods has 'Phish'\r\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend ParsedMethods = parse_json(DetectionMethods)\r\n| mv-expand PhishMethod = ParsedMethods.Phish\r\n| where PhishMethod contains \"URL\"\r\n| project Timestamp, Key, PhishMethod\r\n| make-series Count= count(Key) default = 0 on Timestamp step 1d by tostring(PhishMethod)",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "name": "query - 8 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Daily Trend of QR Code-Based Threat Detections<br>\r\n\r\n**Displays daily counts of inbound emails containing QR codes flagged for Phish, Malware, or Spam via URL-based detection methods. Helps track QR code abuse patterns over time.**"
            },
            "customWidth": "50",
            "name": "text - 13 - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Daily URL Scan activity by Location<br>\r\n\r\n**Displays daily counts of URLs scanned from various locations within emails (e.g., body, attachments, QR codes). Helps identify where malicious URLs are most commonly embedded.**"
            },
            "customWidth": "50",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\n\r\nlet baseQuery = EmailEvents\r\n| where EmailDirection == \"Inbound\" \r\n| where DetectionMethods has \"Url\"\r\n| join EmailUrlInfo on NetworkMessageId\r\n| where UrlLocation == \"QRCode\";\r\n\r\nlet qrphishh = baseQuery\r\n| where parse_json(DetectionMethods).Phish has \"URL\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"Phish QR Detection\";\r\n\r\nlet qrmalww = baseQuery\r\n| where parse_json(DetectionMethods).Malware has \"URL\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Malware QR Detection\";\r\n\r\nlet qrspamm = baseQuery\r\n| where parse_json(DetectionMethods).Spam has \"URL\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spam QR Detection\";\r\n\r\nunion qrphishh, qrmalww, qrspamm\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "graphSettings": {
                "type": 0
              },
              "chartSettings": {
                "xAxis": "Timestamp",
                "xSettings": {
                  "dateFormatSettings": {
                    "formatName": "shortDatePattern",
                    "showUtcTime": false
                  }
                }
              }
            },
            "customWidth": "50",
            "name": "query - 6",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises where URL's have been scanned identified from various locations in emails\r\nEmailUrlInfo\r\n| summarize  count() by UrlLocation, bin (Timestamp,1d)",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 5",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "5"
      },
      "name": "group - 9-URL detections",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">URL click based threat detections insights\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and explain URL click based threat detections in emails as identified by Microsoft Defender for Office 365 focusing on daily trend of blocked URL clicks, time-of-click URL scans by workload, malicious clicks allowed, top clicks on malicious URLs, and more."
            },
            "name": "text - 13 - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Daily Trend of Blocked URL Click Events<br>\r\n\r\n**Shows the daily count of blocked URL click attempts and click attempts on URLs with detections, grouped by threat types (e.g., Phish, Malware, Spam). Helps track user interaction with malicious links over time across various threat types.**"
            },
            "name": "text - 13 - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Generates a time-series analysis for blocked URL click events from the 'UrlClickEvents' table\r\n\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\n\r\nlet baseQuery = UrlClickEvents\r\n| where isnotempty(ActionType);\r\n\r\nlet Blocked = baseQuery\r\n| where ActionType has_any(\"ClickBlocked\")\r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"ClickBlocked\";\r\n\r\nBlocked",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "xAxis": "Timestamp"
              }
            },
            "customWidth": "66",
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of click attempts on URL's with detections split by the different threat types identified\r\nUrlClickEvents\r\n| where isnotempty(ThreatTypes)\r\n| summarize count() by ThreatTypes,bin(Timestamp, 1d)",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Daily Trend of URL Click Actions by Type<br>\r\n\r\n**Displays daily counts of URL click events categorised by action type: Blocked, Allowed, Pending Verdict, Error Page, and Clicked Through. Helps identify risky user behaviour and policy gaps.**"
            },
            "customWidth": "66",
            "name": "text - 13 - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### URL Clicks by Workload<br>\r\n\r\n**DisplaysdailycountsofURLclickeventsgroupedbyWorkload(e.g.,Outlook,Teams,Copilot,OfficeApps: Word, Excel,PowerPoint) HelpsidentifywhichapplicationsaremostfrequentlyusedforURLinteractionsandpotentialriskexposure.**"
            },
            "customWidth": "33",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises different URL click event types by action (e.g., blocked, allowed, pending verdict, error pages, and clicked through), summarizing the data daily\r\n\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\n\r\nlet baseQuery = UrlClickEvents\r\n| where isnotempty(ActionType);\r\n\r\nlet Blocked = baseQuery\r\n| where ActionType has_any(\"ClickBlocked\")\r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"ClickBlocked\";\r\n\r\nlet Allowed = baseQuery\r\n| where ActionType has_any(\"ClickAllowed\")\r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"ClickAllowed\";\r\n\r\nlet PendingVerdict = baseQuery\r\n| where ActionType has_any(\"UrlScanInProgress\")\r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"PendingVerdict\";\r\n\r\nlet ErrorPage = baseQuery\r\n| where ActionType has_any(\"UrlErrorPage\")\r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"ErrorPage\";\r\n\r\nlet ClickedThrough = baseQuery\r\n| where IsClickedThrough == true\r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"ClickedThrough\";\r\n\r\nunion Blocked, Allowed, PendingVerdict, ErrorPage, ClickedThrough",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "xAxis": "Timestamp"
              }
            },
            "customWidth": "66",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises where URL clicks scanned by the Workload the click happened from\r\nUrlClickEvents\r\n| summarize  count() by Workload, bin (Timestamp,1d)",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - 5 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Daily Blocked URL Clicks by Workload<br>\r\n\r\n**Displays daily counts of blocked URL click attempts grouped by Workload (Email, Teams, Office, Microsoft 365 Copilot). Helps identify which platforms are most exposed to malicious link interactions and where user awareness or policy enforcement should be strengthened.**"
            },
            "customWidth": "66",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Click-Through Activity on Detected URLs by Workload<br>\r\n\r\n**Displays counts of clickthrough actions on URLs already identified with detections, grouped by Workload where the click happened. Helps identify clients/platforms where users are most likely to proceed to risky URLs and prioritise awareness training or policy tuning for those workloads**"
            },
            "customWidth": "33",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises blocked URL click event types by Workload (e.g., Email, Teams, Office, Microsoft 365 Copilot), summarizing the data daily\r\n\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\n\r\nlet baseQuery = UrlClickEvents\r\n| where ActionType ==\"ClickBlocked\";\r\n\r\nlet Teams = baseQuery\r\n| where Workload==\"Teams\" \r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"Teams\";\r\n\r\nlet Office = baseQuery\r\n| where Workload==\"Office\" \r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"Office\";\r\n\r\nlet Email = baseQuery\r\n| where Workload==\"Email\" \r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"Email\";\r\n\r\nlet Copilot = baseQuery\r\n| where Workload==\"Copilot\" \r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"Copilot\";\r\n\r\nunion Teams, Office, Email, Copilot",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "66",
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of click-through activities on URL's with detections split by the source client\r\nUrlClickEvents \r\n| where IsClickedThrough !=\"0\"\r\n| where isnotempty(ThreatTypes) \r\n| summarize count() by Workload",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top clicks on Malicious URLs<br>\r\n\r\n**Displays the top 20 URLs associated with detections that registered the highest number of clicks. Includes ThreatTypes, ActionType, and Workload to provide context on the nature of the threat and where user interaction occurred.**"
            },
            "customWidth": "100",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query shows the top 20 URL's that have a detection associated with the most ammount of clicks registered \r\nUrlClickEvents\r\n| where ThreatTypes !=\"\"\r\n| summarize count() by Url, ThreatTypes, ActionType, Workload\r\n| project Url, ThreatTypes, ActionType, Workload, ClickCount=count_\r\n| top 20 by ClickCount",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "ClickCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "100",
            "name": "query - 10 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "5"
      },
      "name": "group - 31-URL clicks",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Top Risky Users Clicking on URLs with Threats\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track and identify users who have clicked on malicious URLs detected by Microsoft Defender for Office 365."
            },
            "name": "text - 13 - Copy - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Users Clicking on URLs with Malware Threat<br>\r\n\r\n**Displays the top 10 user accounts with the highest number of click attempts on URLs flagged as Malware. Helps identify individuals at greater risk and prioritise targeted security awareness training.**"
            },
            "customWidth": "33",
            "name": "text - 13 - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Users Clicking on URLs with Phish Threat<br>\r\n\r\n**Displays the top 10 user accounts with the highest number of click attempts on URLs flagged as Phish. Helps identify individuals at greater risk and prioritise targeted security awareness training.**"
            },
            "customWidth": "33",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Users Clicking on URLs with Spam Threat<br>\r\n\r\n**Displays the top 10 user accounts with the highest number of click attempts on URLs flagged as Spam. Helps identify individuals at greater risk and prioritise targeted security awareness training.**"
            },
            "customWidth": "33",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 users with click attempts on URL's with malware detections\r\nUrlClickEvents\r\n| where ThreatTypes == \"Malware\"\r\n| summarize count() by AccountUpn\r\n| top 10 by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 4 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 users with click attempts on URL's with phishing detections\r\nUrlClickEvents\r\n| where ThreatTypes == \"Phish\"\r\n| summarize count() by AccountUpn\r\n| top 10 by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 4 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 users with click attempts on URL's with spam detections\r\nUrlClickEvents\r\n| where ThreatTypes == \"Spam\"\r\n| summarize count() by AccountUpn\r\n| top 10 by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 4 - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 users with click attempts on URL's with malware detections\r\nUrlClickEvents\r\n| summarize TotalClickCount=count(),MalwareClickCount = countif(ThreatTypes has \"Malware\") by AccountUpn\r\n| extend Bad_Click_Percentage = todouble(round(MalwareClickCount / todouble(TotalClickCount) *100, 2))\r\n| where MalwareClickCount !=0\r\n| sort by MalwareClickCount desc\r\n| project AccountUpn,MalwareClickCount, TotalClickCount,Bad_Click_Percentage\r\n| top 15 by MalwareClickCount",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "MalwareClickCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "25ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalClickCount",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Click_Percentage",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "25ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "MalwareEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": []
            },
            "customWidth": "33",
            "name": "query - 18 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 users with click attempts on URL's with Phish detections\r\nUrlClickEvents\r\n| summarize TotalClickCount=count(),PhishClickCount = countif(ThreatTypes has \"Phish\") by AccountUpn\r\n| extend Bad_Click_Percentage = todouble(round(PhishClickCount / todouble(TotalClickCount) *100, 2))\r\n| where PhishClickCount !=0\r\n| sort by PhishClickCount desc\r\n| project AccountUpn,PhishClickCount, TotalClickCount,Bad_Click_Percentage\r\n| top 15 by PhishClickCount",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "PhishClickCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "25ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalClickCount",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Click_Percentage",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "25ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "MalwareClickCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "MalwareEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": []
            },
            "customWidth": "33",
            "name": "query - 18 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 users with click attempts on URL's with Spam detections\r\nUrlClickEvents\r\n| summarize TotalClickCount=count(),SpamClickCount = countif(ThreatTypes has \"Spam\") by AccountUpn\r\n| extend Bad_Click_Percentage = todouble(round(SpamClickCount / todouble(TotalClickCount) *100, 2))\r\n| where SpamClickCount !=0\r\n| sort by SpamClickCount desc\r\n| project AccountUpn,SpamClickCount, TotalClickCount,Bad_Click_Percentage\r\n| top 15 by SpamClickCount",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SpamClickCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "25ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalClickCount",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Click_Percentage",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "25ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "PhishClickCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "MalwareClickCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "MalwareEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": []
            },
            "customWidth": "33",
            "name": "query - 18 - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "5"
      },
      "name": "group - 32-Top clickers",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "# Top Attacked Users, Top Senders, and Automatic External Email Forwarding\r\n\r\n---\r\nThis tab provides insights into **Top attacked users, Top Senders** in inbound email messages and details about **automatic external email forwarding**."
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "6"
      },
      "name": "text - 24 - Copy - Copy - Copy",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Top attacked users and Top Senders insights\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section provides key visuals that highlight top attacked users  individuals most frequently targeted by inbound email threats as detected by Microsoft Defender for Office 365. Offers insights into top email senders and sender domains across inbound email traffic, helping identify patterns and potential risk sources."
            },
            "name": "text - 13 - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Top Attacked Users<br>\r\n\r\n**Displays the top 10 recipient email addresses that received inbound emails flagged as Spam, Phishing, or Malware. Helps identify high-risk users for targeted security awareness and policy enforcement.**"
            },
            "name": "text - 13 - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 users that are receiving Spam, Phishing or Malware emails\r\nEmailEvents \r\n| where  OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\" and EmailDirection ==\"Inbound\"\r\n| extend MDO_detection = parse_json(DetectionMethods) \r\n| extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n| extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(FirstDetection == \"Malware\"),PhishEmailCount = countif(FirstDetection ==  \"Phish\"),SpamEmailCount = countif(FirstDetection ==  \"Spam\") by RecipientEmailAddress\r\n| extend ThreatEmailCount=(MalwareEmailCount+PhishEmailCount+SpamEmailCount)\r\n| project RecipientEmailAddress,ThreatEmailCount\r\n| sort by ThreatEmailCount  | take 10",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "RecipientEmailAddress",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "RecipientEmailAddress",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "count_",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 27",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 users that are receiving Spam, Phishing or Malware emails\r\nEmailEvents \r\n| where  OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\" and EmailDirection ==\"Inbound\"\r\n| extend MDO_detection = parse_json(DetectionMethods) \r\n| extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n| extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(FirstDetection == \"Malware\"),PhishEmailCount = countif(FirstDetection ==  \"Phish\"),SpamEmailCount = countif(FirstDetection ==  \"Spam\") by RecipientEmailAddress\r\n| extend ThreatEmailCount=(MalwareEmailCount+PhishEmailCount+SpamEmailCount)\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(ThreatEmailCount / todouble(TotalEmailCount) *100, 2))\r\n| project RecipientEmailAddress,TotalEmailCount,ThreatEmailCount, MalwareEmailCount, PhishEmailCount, SpamEmailCount, Bad_Traffic_Percentage_Inbound\r\n| sort by ThreatEmailCount  | take 15",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "ThreatEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "MalwareEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "PhishEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "SpamEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "$gen_bar_ThreatEmailCount_2",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_bar_ThreatEmailCount_2",
                  "sortOrder": 2
                }
              ],
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "66",
            "name": "query - 28",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Senders of Inbound Emails<br>\r\n\r\n**Displays the top 10 sender email addresses from external sources delivering inbound emails. Helps identify high-volume external senders for monitoring and policy enforcement.**"
            },
            "name": "text - 13 - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 senders by inbound email sending volume\r\nEmailEvents \r\n| where  OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\" and EmailDirection ==\"Inbound\"\r\n| extend MDO_detection = parse_json(DetectionMethods) \r\n| extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n| extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(FirstDetection == \"Malware\"),PhishEmailCount = countif(FirstDetection ==  \"Phish\"),SpamEmailCount = countif(FirstDetection ==  \"Spam\") by SenderFromAddress\r\n| extend ThreatEmailCount=(MalwareEmailCount+PhishEmailCount+SpamEmailCount)\r\n| project SenderFromAddress,TotalEmailCount\r\n| sort by TotalEmailCount  | take 10",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "TotalEmailCount"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 30",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 senders by inbound email sending volume\r\nEmailEvents \r\n| where  OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\" and EmailDirection ==\"Inbound\"\r\n| extend MDO_detection = parse_json(DetectionMethods) \r\n| extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n| extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(FirstDetection == \"Malware\"),PhishEmailCount = countif(FirstDetection ==  \"Phish\"),SpamEmailCount = countif(FirstDetection ==  \"Spam\") by SenderFromAddress\r\n| extend ThreatEmailCount=(MalwareEmailCount+PhishEmailCount+SpamEmailCount)\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(ThreatEmailCount / todouble(TotalEmailCount) *100, 2))\r\n| project SenderFromAddress,TotalEmailCount,ThreatEmailCount, MalwareEmailCount, PhishEmailCount, SpamEmailCount, Bad_Traffic_Percentage_Inbound\r\n| sort by TotalEmailCount  | take 15",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "ThreatEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "MalwareEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "PhishEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "SpamEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "66",
            "name": "query - 28 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Sender domains of Inbound Emails<br>\r\n\r\n**Displays the top 10 sender domains from external sources delivering inbound emails. Helps identify high-volume external sender domains for monitoring and policy enforcement.**"
            },
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 senders by inbound email sending volume\r\nEmailEvents \r\n| where  OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\" and EmailDirection ==\"Inbound\"\r\n| extend MDO_detection = parse_json(DetectionMethods) \r\n| extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n| extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(FirstDetection == \"Malware\"),PhishEmailCount = countif(FirstDetection ==  \"Phish\"),SpamEmailCount = countif(FirstDetection ==  \"Spam\") by SenderFromDomain\r\n| extend ThreatEmailCount=(MalwareEmailCount+PhishEmailCount+SpamEmailCount)\r\n| project SenderFromDomain,TotalEmailCount\r\n| sort by TotalEmailCount  | take 10",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "TotalEmailCount"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 30 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 senders by inbound email sending volume\r\nEmailEvents \r\n| where  OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\" and EmailDirection ==\"Inbound\"\r\n| extend MDO_detection = parse_json(DetectionMethods) \r\n| extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n| extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(FirstDetection == \"Malware\"),PhishEmailCount = countif(FirstDetection ==  \"Phish\"),SpamEmailCount = countif(FirstDetection ==  \"Spam\") by SenderFromDomain\r\n| extend ThreatEmailCount=(MalwareEmailCount+PhishEmailCount+SpamEmailCount)\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(ThreatEmailCount / todouble(TotalEmailCount) *100, 2))\r\n| project SenderFromDomain,TotalEmailCount,ThreatEmailCount, MalwareEmailCount, PhishEmailCount, SpamEmailCount, Bad_Traffic_Percentage_Inbound\r\n| sort by TotalEmailCount  | take 15",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "ThreatEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "MalwareEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "PhishEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "SpamEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "66",
            "name": "query - 28 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "6"
      },
      "name": "group - 10-Top attacked users and top senders",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Automatic External Email Forwarding Insights\r\n</td>\r\n</tr>\r\n</table>\r\n\r\n**Email forwarding can be useful, but can also pose a security risk due to the potential disclosure of information.**\r\n<br>\r\n\r\nUsers can configure [<b>Inbox rules</b>](https://cus.prod.support.services.microsoft.com/en-us/office/use-rules-to-automatically-forward-messages-45aa9664-4911-4f96-9663-ece42816d746) in Outlook or set up [<b>SMTP forwarding</b>](https://support.microsoft.com/en-us/office/turn-on-automatic-forwarding-in-outlook-7f2670a1-7fff-4475-8a3c-5822d63b0c8e) to automatically forward messages to external recipients. You can control automatic external email forwarding from cloud mailboxes using [<b>Outbound spam policies</b>](https://learn.microsoft.com/en-us/defender-office-365/outbound-spam-policies-external-email-forwarding) in Microsoft Defender for Office 365. \r\n**Attackers might exploit this capability to compromise your organization or its partners.**"
            },
            "name": "text - 8"
          },
          {
            "type": 1,
            "content": {
              "json": "### Automatic Email Forwarding by Type<br>\r\n\r\n**Displays counts of outbound emails automatically forwarded to external addresses, grouped by forwarding type (e.g., SMTP forwarding, inbox rules). Helps identify forwarding behaviors that may pose data exfiltration risks.**"
            },
            "customWidth": "50",
            "name": "text - 13 - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Internal Users Forwarding Emails Externally<br>\r\n\r\n**Displays the top 10 internal user accounts that have automatically forwarded emails to external addresses (regardless of the forwarding type used). Helps identify potential data exfiltration risks and enforce forwarding policies.**"
            },
            "customWidth": "50",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises automatic email forwarding to external email addresses by forwarding type\r\nEmailEvents \r\n| where EmailDirection == \"Outbound\" and ForwardingInformation !=\"\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser)\r\n| summarize count() by ForwardingType\r\n| sort by count_ desc \r\n",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 30 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 internal senders who are automatically forwarding emails to external email addresses\r\nEmailEvents \r\n| where EmailDirection == \"Outbound\" and ForwardingInformation !=\"\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser)\r\n| summarize TotalForwardedMessages = count() by ForwardingUser\r\n| sort by TotalForwardedMessages desc \r\n| top 10 by TotalForwardedMessages\r\n\r\n",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalForwardedMessages",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "chartSettings": {
                "yAxis": [
                  "TotalForwardedMessages"
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 30 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Internal Users Forwarding Emails Using Mailbox Rules<br>\r\n\r\n**Displays the top 10 internal user accounts that have automatically forwarded outbound emails to external addresses using Mailbox Rules. Helps identify potential data exfiltration risks and enforce forwarding restrictions.**"
            },
            "customWidth": "50",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 External domains Receiving Auto-Forwarded Emails (Mailbox Rules)<br>\r\n\r\n**Displays the top 10 external recipient email domains that received automatically forwarded emails from internal users via Mailbox Rules. Helps identify potential data exfiltration risks and enforce forwarding restrictions.**"
            },
            "customWidth": "25",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 External Recipients Receiving Auto-Forwarded Emails (Mailbox Rules)<br>\r\n\r\n**Displays the top 10 external recipient email addresses that received automatically forwarded emails from internal users via Mailbox Rules. Helps identify potential data exfiltration risks and enforce forwarding restrictions.**"
            },
            "customWidth": "25",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 internal senders who are automatically forwarding emails to external email addresses using Mailbox Rules\r\nEmailEvents \r\n| where EmailDirection == \"Outbound\" and ForwardingInformation !=\"\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser)\r\n| where ForwardingType ==\"MbxRule\"\r\n| summarize TotalForwardedMessages = count() by ForwardingUser\r\n| sort by TotalForwardedMessages desc \r\n| take 10",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalForwardedMessages",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    }
                  }
                ]
              },
              "chartSettings": {
                "yAxis": [
                  "TotalForwardedMessages"
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 30 - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 external domains who are recieving automatically forwarded emails using Mailbox Rules\r\nEmailEvents \r\n| where EmailDirection == \"Outbound\" and ForwardingInformation !=\"\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser),RecipientDomain = tostring(split(RecipientEmailAddress, \"@\")[1])\r\n| where ForwardingType ==\"MbxRule\"\r\n| summarize TotalForwardedMessages = count() by RecipientDomain\r\n| sort by TotalForwardedMessages desc \r\n| take 10",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalForwardedMessages",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "chartSettings": {
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "25",
            "name": "query - 30 - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 external recipients who are recieving automatically forwarded emails using Mailbox Rules\r\nEmailEvents \r\n| where EmailDirection == \"Outbound\" and ForwardingInformation !=\"\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser)\r\n| where ForwardingType ==\"MbxRule\"\r\n| summarize TotalForwardedMessages = count() by RecipientEmailAddress\r\n| sort by TotalForwardedMessages desc \r\n| take 10",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalForwardedMessages",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "chartSettings": {
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "25",
            "name": "query - 30 - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Internal Users Forwarding Emails via SMTP Forwarding<br>\r\n\r\n**Displays the top 10 internal user accounts that have automatically forwarded outbound emails to external addresses using SMTP Forwarding. Helps identify potential data exfiltration risks and enforce forwarding restrictions.**"
            },
            "customWidth": "50",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 External domains receiving Auto-Forwarded Emails (SMTP Forwarding)<br>\r\n\r\n**Displays the top 10 external recipient email domains that received automatically forwarded emails from internal users using SMTP Forwarding. Helps identify potential data exfiltration risks and enforce forwarding restrictions.**"
            },
            "customWidth": "25",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 External Recipients Receiving Auto-Forwarded Emails (SMTP Forwarding)<br>\r\n\r\n**Displays the top 10 external recipient email addresses that received automatically forwarded emails from internal users using SMTP Forwarding. Helps identify potential data exfiltration risks and enforce forwarding restrictions.**"
            },
            "customWidth": "25",
            "name": "text - 13 - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 internal senders who are automatically forwarding emails to external email addresses using SmtpForwarding\r\nEmailEvents \r\n| where EmailDirection == \"Outbound\" and ForwardingInformation !=\"\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser)\r\n| where ForwardingType ==\"SmtpForwarding\"\r\n| summarize count() by ForwardingUser\r\n| sort by count_ desc \r\n| take 10",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 30 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 external recipients who are recieving automatically forwarded emails using SmtpForwarding\r\nEmailEvents \r\n| where EmailDirection == \"Outbound\" and ForwardingInformation !=\"\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser),RecipientDomain = tostring(split(RecipientEmailAddress, \"@\")[1])\r\n| where ForwardingType ==\"SmtpForwarding\"\r\n| summarize TotalForwardedMessages = count() by RecipientDomain\r\n| sort by TotalForwardedMessages desc \r\n| take 10",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalForwardedMessages",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "chartSettings": {
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "25",
            "name": "query - 30 - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 external recipients who are recieving automatically forwarded emails using SmtpForwarding\r\nEmailEvents \r\n| where EmailDirection == \"Outbound\" and ForwardingInformation !=\"\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser)\r\n| where ForwardingType ==\"SmtpForwarding\"\r\n| summarize TotalForwardedMessages = count() by RecipientEmailAddress\r\n| sort by TotalForwardedMessages desc \r\n| take 10",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalForwardedMessages",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "chartSettings": {
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "25",
            "name": "query - 30 - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "6"
      },
      "name": "group - 34 - Automatic email forwarding",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "# Email detection action overrides\r\n\r\n---\r\n\r\nThis tab provides insights into admin or end-user configured **detection overrides** where the message was detected as a threat by Microsoft Defender for Office 365, however an admin-configured policy or end-user setting overrode the detection action.[<p><b>Learn more</b></p>](https://learn.microsoft.com/en-us/defender-office-365/step-by-step-guides/understand-overrides-in-email-entity) "
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "7"
      },
      "name": "text - 13 - Copy",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Admin configured Detection Overrides (Allow)\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track emails subject to administrator policies (e.g., Transport Rules, Tenant Allow/Block List) with an \"Allow\" action, overriding Microsoft Defender for Office 365 detections (excluding SecOps Mailbox overrides)."
            },
            "name": "text - AdminOverridesAllowHeader"
          },
          {
            "type": 1,
            "content": {
              "json": "### Admin Overrides (Allow) Trend\r\n**Displays the daily count of emails where an administrator policy with an \"Allow\" action overrode detections (excluding SecOps Mailbox). Helps track the frequency of admin overrides over time.**"
            },
            "name": "text - AdminOverridesAllowTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to an admin policy with action of allow independent of action taken, summarizing the data daily\r\nEmailEvents\r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelPolicy!=\"SecOps Mailbox\" and OrgLevelAction == \"Allow\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| make-series TotalAdminOverrides = count() default = 0 on Timestamp step 1d",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Total Emails by Admin Override type (Allow)\r\n**Summarizes the total count of emails subject to administrator policies with an \"Allow\" action, grouped by the type of override. Helps identify which policies are most frequently allowing emails.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowByType"
          },
          {
            "type": 1,
            "content": {
              "json": "### Admin Overrides (Allow) by Override Type and Threat Type\r\n**Details the count of emails allowed by administrator policies, categorized by the override type and the detected threat type. Helps assess the risk associated with allowed emails.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowByTypeAndThreat"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of emails subject to an admin policy with action of allow, independent of action taken, summarizing the data by type of override\r\nEmailEvents \r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelPolicy!=\"SecOps Mailbox\" and OrgLevelAction == \"Allow\" \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize count() by OrgLevelPolicy",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 16",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to an admin policy with action of allow, independent of action taken, summarizing the data by type of override and threats type found\r\nEmailEvents \r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelPolicy!=\"SecOps Mailbox\" and OrgLevelAction == \"Allow\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmails=count() by OrgLevelAction,OrgLevelPolicy,ThreatTypes\r\n| sort by TotalEmails",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalEmails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### SecOps Mailbox Overrides (Allow)\r\nThis section focuses on emails allowed specifically due to the SecOps Mailbox override policy, typically used for investigation and analysis.[<p><b>Learn more</b></p>](https://learn.microsoft.com/en-us/defender-office-365/advanced-delivery-policy-configure) "
            },
            "name": "text - SecOpsOverridesHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of emails subject to the \r\nEmailEvents \r\n| where OrgLevelPolicy==\"SecOps Mailbox\" and OrgLevelAction == \"Allow\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize count() by OrgLevelPolicy",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "stat",
              "statSettings": {
                "valueAggregation": "None",
                "colorSettings": {
                  "type": "static",
                  "mode": "background",
                  "heatmapPalette": "greenRed",
                  "thresholdsGrid": []
                },
                "iconSettings": {
                  "thresholdsGrid": []
                },
                "tagText": "",
                "valueFontStyle": "auto",
                "tagTextPosition": "bottom"
              }
            },
            "customWidth": "50",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails delivered to the SecOps Mailbox by threat type\r\nEmailEvents \r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelPolicy==\"SecOps Mailbox\" and OrgLevelAction == \"Allow\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmails=count() by OrgLevelAction,OrgLevelPolicy,ThreatTypes\r\n| sort by TotalEmails",
              "size": 1,
              "showAnalytics": true,
              "title": " ",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalEmails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "7"
      },
      "name": "group - 15 - Admin Detection Overrides - Allow",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Admin configured Detection Overrides (Block)\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section provides insights into email messages blocked by administrative policies (e.g. Tenant allow/block list, Antimalware policy file type block), overriding detection actions defined by Microsoft Defender for Office 365."
            },
            "name": "text - AdminOverridesBlockHeader"
          },
          {
            "type": 1,
            "content": {
              "json": "### Admin Overrides (Block) Trend\r\n**Displays the daily count of emails where an administrator policy with a \"Block\" action overrode detections. Helps track the frequency of admin blocks over time.**"
            },
            "name": "text - AdminOverridesBlockTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to an admin policy with action of block, summarizing the data daily\r\nEmailEvents\r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelAction == \"Block\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| make-series TotalAdminOverrides = count() default = 0 on Timestamp step 1d",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "name": "query - 5",
            "styleSettings": {
              "margin": "10",
              "padding": "10"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Total Emails by Admin Override Type (Block)\r\n**Summarizes the total count of emails subject to administrator policies with a \"Block\" action, grouped by the type of override.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesBlockByType"
          },
          {
            "type": 1,
            "content": {
              "json": "### Admin Overrides (Block) by Override Type and Threat Type\r\n**Details the count of emails blocked by administrator policies, categorized by the override type and the detected threat type.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesBlockByTypeAndThreat"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of emails subject to an admin policy with action of block, summarizing the data by type of override\r\nEmailEvents \r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelAction == \"Block\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize count() by OrgLevelPolicy",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 6",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to an admin policy with action of block, summarizing the data by type of override and threats type found\r\nEmailEvents \r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelAction == \"Block\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmails=count() by OrgLevelAction,OrgLevelPolicy,ThreatTypes\r\n| sort by TotalEmails",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalEmails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 7",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "7"
      },
      "name": "group - 36-Admin Detection Overrides - Block",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">User configured Detection Overrides (Allow)\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section consolidates key visuals that track email messages subject to user policies (e.g. [Safe Senders list defined in Outlook](https://learn.microsoft.com/en-us/defender-office-365/create-safe-sender-lists-in-office-365#use-outlook-safe-senders)) with an \"Allow\" action, overriding Microsoft Defender for Office 365 detections."
            },
            "name": "text - UserOverridesAllowHeader"
          },
          {
            "type": 1,
            "content": {
              "json": "### User Overrides (Allow) Trend\r\n**Displays the daily count of emails where a user policy with an \"Allow\" action overrode detections. Helps track the frequency of user overrides over time.**"
            },
            "name": "text - UserOverridesAllowTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to a user type policy with action of allow, summarizing the data daily\r\nEmailEvents\r\n| where UserLevelPolicy!=\"\"\"\" and UserLevelAction == \"Allow\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| make-series TotalUserOverrides = count() default = 0 on Timestamp step 1d",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Total Emails by User Override Type (Allow)\r\n**Summarizes the total count of emails subject to user policies with an \"Allow\" action, grouped by the type of override.**"
            },
            "customWidth": "50",
            "name": "text - UserOverridesAllowByType"
          },
          {
            "type": 1,
            "content": {
              "json": "### User Overrides (Allow) by Override Type and Threat Type\r\n**Details the count of emails allowed by user policies, categorized by the override type and the detected threat type. Helps assess the risk associated with user-allowed emails.**"
            },
            "customWidth": "50",
            "name": "text - UserOverridesAllowByTypeAndThreat"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of emails subject to a user type policy with action of allow, summarizing the data by type of override\r\nEmailEvents \r\n| where UserLevelPolicy!=\"\"\"\" and UserLevelAction == \"Allow\" \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize count() by UserLevelPolicy",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 16",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to a user type policy with action of allow, summarizing the data by type of override and threats type found\r\nEmailEvents \r\n| where UserLevelPolicy!=\"\"\"\" and UserLevelAction == \"Allow\" \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmails=count() by UserLevelAction,UserLevelPolicy,ThreatTypes\r\n| sort by TotalEmails",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalEmails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ]
              },
              "sortBy": []
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "7"
      },
      "name": "group - 15 - User Detection Overrides - Allow",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">User configured Detection Overrides (Block)\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section provides insights into emails blocked by user-configured policies (e.g., [Blocked Senders list in Outlook](https://support.microsoft.com/en-us/office/block-or-unblock-senders-in-outlook-9bf812d4-6995-4d19-901a-76d6e26939b0))."
            },
            "name": "text - UserOverridesBlockHeader"
          },
          {
            "type": 1,
            "content": {
              "json": "### User Overrides (Block) Trend\r\n**Displays the daily count of emails where a user policy with a \"Block\" action overrode detections. Helps track the frequency of user blocks over time.**"
            },
            "name": "text - UserOverridesBlockTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to a user type policy with action of block, summarizing the data daily\r\nEmailEvents\r\n| where UserLevelPolicy!=\"\"\"\" and UserLevelAction == \"Block\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| make-series TotalUserOverrides = count() default = 0 on Timestamp step 1d",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "name": "query - 5",
            "styleSettings": {
              "margin": "10",
              "padding": "10"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Total Emails by User Override Type (Block)\r\n**Summarizes the total count of emails subject to user policies with a \"Block\" action, grouped by the type of override.**"
            },
            "customWidth": "50",
            "name": "text - UserOverridesBlockByType"
          },
          {
            "type": 1,
            "content": {
              "json": "### User Overrides (Block) by Override Type and Threat Type\r\n**Details the count of emails blocked by user policies, categorized by the override type and the detected threat type.**"
            },
            "customWidth": "50",
            "name": "text - UserOverridesBlockByTypeAndThreat"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of emails subject to a user type policy with action of block, summarizing the data by type of override\r\nEmailEvents \r\n| where UserLevelPolicy!=\"\"\"\" and UserLevelAction == \"Block\" \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize count() by UserLevelPolicy",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 6",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to a user type policy with action of block, summarizing the data by type of override and threats type found\r\nEmailEvents \r\n| where UserLevelPolicy!=\"\"\"\" and UserLevelAction == \"Block\" \r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize TotalEmails=count() by UserLevelAction,UserLevelPolicy,ThreatTypes\r\n| sort by TotalEmails",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalEmails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 7",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "7"
      },
      "name": "group - 37-User Detection Overrides - Block",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "# False Negative(FN) Submissions insights\r\n\r\n---\r\n\r\nThis tab provides insights into email message **False Negative(FN) Submissions** performed by users or administrators in Microsoft Defender for Office 365 where the message reported to have **Malware, Phish or Spam threat** within its **content, URLs or attachments**."
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "8"
      },
      "name": "text - 13 - Copy",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">False Negative(FN) Admin submissions\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section provides insights into email message **False Negative(FN) Submissions performed by administrators** in Microsoft Defender for Office 365 where the message reported to have Malware, Phish or Spam threat within its content, URLs or attachments."
            },
            "name": "text - AdminOverridesAllowHeader - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### False Negative(FN) Admin Submissions daily trend by submission types \r\n**Displays daily counts of False Negative(FN) Admin Submissions grouped by submission type (Spam, Phish, Malware) and content type (Mail, URL, Attachment). Helps to monitor where detections were missed and later submitted by admins as false negatives to Microsoft.**"
            },
            "name": "text - AdminOverridesAllowTrend - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of admin false negative submission by submission type.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = CloudAppEvents\r\n| where ActionType contains \"Submission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType);\r\nlet Admin_Malware_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Malware_FN\";\r\nlet Admin_Phish_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Phish_FN\";\r\nlet Admin_Spam_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"0\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Spam_FN\";\r\nlet Admin_Malware_URL_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Malware_URL_FN\";\r\nlet Admin_Malware_Attach_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Malware_Attach_FN\";\r\nlet Admin_Phish_URL_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Phish_URL_FN\";\r\nlet Admin_Phish_Attach_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Phish_Attach_FN\";\r\nunion Admin_Malware_FN,Admin_Phish_FN,Admin_Spam_FN,Admin_Malware_URL_FN,Admin_Malware_Attach_FN,Admin_Phish_URL_FN,Admin_Phish_Attach_FN\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalAdminSubmissions",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Admin_Phish_FN",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "Admin_Spam_FN",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Admin_Malware_FN",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Admin_Phish_URL_FN",
                    "color": "purple"
                  },
                  {
                    "seriesName": "Admin_Malware_Attach_FN",
                    "color": "yellowDark"
                  },
                  {
                    "seriesName": "Admin_Phish_Attach_FN",
                    "color": "purpleDark"
                  },
                  {
                    "seriesName": "Admin_Malware_URL_FN",
                    "color": "yellow"
                  }
                ]
              }
            },
            "name": "query - 4 - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### False Negative(FN) Admin Submissions by submission types \r\n**Displays daily counts of False Negative(FN) Admin Submissions grouped by submission type (Spam, Phish, Malware) and content type (Mail, URL, Attachment).**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### False Negative(FN) Admin Submissions by submission State\r\n**Displays the total count of False Negative(FN) Admin Submissions by submission State (e.g., Pending, Completed, Failed). Helps track the processing status of admin submissions and identify bottlenecks or errors.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of admin false negative submission by submission type.\r\nCloudAppEvents \r\n| where ActionType contains \"Submission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| extend Admin_SubmissionType=\r\niff(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Malware_FN\",\r\niff(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Spam_FN\",\r\niff(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\",\"Admin_Malware_URL_FN\",\r\niff(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\",\"Admin_Malware_Attach_FN\",\r\niff(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\",\"Admin_Phish_URL_FN\",\r\niff(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\",\"Admin_Phish_Attach_FN\",\r\n\"Other\")))))))\r\n| where Admin_SubmissionType!=\"Other\"\r\n| summarize count() by Admin_SubmissionType",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of admin false negative submissions by the state of the submission.\r\nCloudAppEvents \r\n| where ActionType contains \"AdminSubmission\" \r\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and SubmissionType in (\"0\",\"1\",\"2\")\r\n| summarize count() by tostring(SubmissionState)",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### False Negative(FN)/False Positive(FP) Admin Submissions by Triage Verdict\r\n**Displays the total count of False Negative(FN)/False Positive(FP) Admin Submissions grouped by TriageVerdict (e.g., Malware, Spam, Phish, Clean). Helps assess how submissions were graded during triage and identify detection gaps.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top Admins Submitting False Negatives \r\n**Displays the top 15 admin accounts that submitted the highest number of false negative messages (missed detections) via AdminSubmission. Helps identify key contributors to threat remediation and potential patterns in detection gaps.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of admin false negative or false positive submissions by the verdict of the submission grading.\r\nCloudAppEvents \r\n| where ActionType contains \"AdminSubmissionTriage\" \r\n| extend UserKey = (parse_json(RawEventData)).UserKey, SubmissionState = (parse_json(RawEventData)).SubmissionState,  SubmissionId=(parse_json(RawEventData)).SubmissionId, TriageVerdict=(parse_json(RawEventData)).GradingResult.TriageVerdict \r\n| summarize count() by tostring(TriageVerdict)",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 0 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top admins performing false negative submissions\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend Record= (parse_json(RawEventData)).RecordType,SubmissionState = (parse_json(RawEventData)).SubmissionState, UserId = (parse_json(RawEventData)).UserId,SubmissionType = parse_json(RawEventData).SubmissionType  \r\n| where Record == 29 and SubmissionType in (\"0\",\"1\",\"2\")\r\n| summarize count() by tostring(UserId) | sort by count_\r\n| top 15 by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### False Negative(FN) Admin Submissions by Top Sender domains of messages\r\n**Displays the top 10 sender domains of emails that were submitted by admins as false negatives (e.g., Malware, Spam, Phish). Helps identify external sources frequently associated with undetected threats and prioritise domain-level security measures.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### False Negative(FN) Admin Submissions by admin Detection override types\r\n**Displays the top 10 cases where emails were submitted as false negatives by admins, even though they were initially detected by Microsoft Defender for Office 365 but delivered due to an admin policy override. Includes details on PolicyOverride, PolicySource, and DetectionVerdict for deeper insight into override behaviour.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises emails submitted by admins as false negatives, summarizing the data by top 10 sender domains of those emails\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"2\",\"1\",\"0\")\r\n| summarize count() by P2SenderDomain\r\n| project P2SenderDomain, TotalEmails = count_\r\n| top 10 by TotalEmails desc ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises emails submitted as false negatives by admins where emails where already detected by MDO but there was a admin policy override\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| extend Admin_SubmissionType=\r\niff(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Malware_FN\",\r\niff(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Spam_FN\",\"Other\"))),\r\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"2\",\"1\",\"0\") and PolicyOverride !=\"NoOverride\"\r\n| summarize count() by PolicyOverride, PolicyPolicyOverrideType,DetectionVerdict,Admin_SubmissionType\r\n| project PolicyOverride, PolicyPolicyOverrideType,DetectionVerdict,Admin_SubmissionType, Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "8"
      },
      "name": "group - 11-Fn Admin Submissions",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">False Negative(FN) User submissions\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section provides insights into email message **False Negative(FN) Submissions performed by end users** in Microsoft Defender for Office 365 where the message reported as having Phish, Spam threat within its content, URLs or attachments."
            },
            "name": "text - AdminOverridesAllowHeader - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### False Negative(FN) User Submissions daily trend by submission types \r\n**Displays daily counts of False Negative(FN) User Submissions grouped by submission type (Spam, Phish and Attack simulations) . Helps to monitor where detections were missed and later submitted by users as false negatives.**"
            },
            "name": "text - AdminOverridesAllowTrend - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of users false negative submission by submission type, including phish simulations reported by users.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = CloudAppEvents\r\n| where ActionType contains \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType);\r\nlet User_Phish_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"User_Phish_FN\";\r\nlet User_Spam_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"User_Spam_FN\";\r\nlet User_AttackSim_Submission=baseQuery\r\n| make-series Count= countif(ActionType == \"AttackSimUserSubmission\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"User_AttackSim_Submission\";\r\nunion User_Phish_FN,User_Spam_FN,User_AttackSim_Submission\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalAdminSubmissions",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "User_Phish_FN",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "User_AttackSim_Submission",
                    "color": "green"
                  },
                  {
                    "seriesName": "User_Spam_FN",
                    "color": "orangeDark"
                  }
                ]
              }
            },
            "name": "query - 4 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### False Negative(FN) User Submissions by submission State\r\n**Displays the total count of False Negative(FN) User Submissions by submission State (e.g., Pending, Completed, Failed). Helps track the processing status of user submissions and identify bottlenecks or errors.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### False Negative(FN) User Submissions by Triage Verdict\r\n**Displays the total count of False Negative(FN)/False Positive(FP) User Submissions grouped by TriageVerdict (e.g., Malware, Spam, Phish, Clean). Helps assess how submissions were graded during triage and identify detection gaps.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of user false negative submissions by the state of the submission.\r\nCloudAppEvents \r\n| where ActionType contains \"UserSubmission\" \r\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and SubmissionType in (\"0\",\"1\")\r\n| summarize count() by tostring(SubmissionState)",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of user false negative or false positive submissions by the verdict of the submission grading.\r\nCloudAppEvents \r\n| where ActionType contains \"UserSubmissionTriage\" \r\n| extend UserKey = (parse_json(RawEventData)).UserKey, SubmissionState = (parse_json(RawEventData)).SubmissionState,  SubmissionId=(parse_json(RawEventData)).SubmissionId, TriageVerdict=(parse_json(RawEventData)).GradingResult.TriageVerdict \r\n| summarize count() by tostring(TriageVerdict)",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 0 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### False Negative(FN) User Submissions of already detected Emails (from Junk folder)\r\n**Displays the total count of False Negative(FN) User Submissions where the email message was already detected by Microsoft Defender for Office 365 and the detection action was configured to deliver the message into the Junk folder of the user mailbox. It breaks down the result based on the original detection verdict determined by Microsoft Defender for Office 365. Helps track the user submissions of messages that already had a detection. Consider changing the detection action to Quarantine to avoid these submissions.**"
            },
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of user false negative submissions that are already detected by MDO and already delivered in the junk folder\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where DeliveryLocation == \"Junk folder\"\r\n| summarize count() by ThreatTypes,User_SubmissionType\r\n| project ThreatTypes,User_SubmissionType, Emails = count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 0 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of user false negative submissions that are already detected by MDO and already delivered in the junk folder\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId,UserId = (parse_json(RawEventData)).UserId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where DeliveryLocation == \"Junk folder\"\r\n| extend MDO_detection = parse_json(DetectionMethods) \r\n| extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n| extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n| summarize TotalJunkSubmittedEmailCount=count(),PhishEmailCount = countif(FirstDetection ==  \"Phish\"),SpamEmailCount = countif(FirstDetection ==  \"Spam\") by tostring(UserId)\r\n| project UserId,TotalJunkSubmittedEmailCount, PhishEmailCount, SpamEmailCount\r\n| sort by TotalJunkSubmittedEmailCount desc \r\n| take 15",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalJunkSubmittedEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "PhishEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "SpamEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 0 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### False Negative(FN) User Submissions - Admin review status (Mark and Notify)\r\n**Displays counts of False Negative(FN) User Submissions that were reviewed by admins and marked with a notify action. The Mark and Notify action also can be taken automatically with Automated investigation and response (AIR). Helps track cases where admins confirmed user reports and communicated the outcome, supporting transparency and user trust.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### False Negative(FN) User Submissions accuracy vs Admin review verdict\r\n**Displays counts of False Negative(FN) User Submissions (Phish, Junk, NotJunk) compared to admin review results. Highlights whether submissions were Correct, Not Correct, or misclassified comparing user submission type with the Admin decision using Mark and Notify action in Microsoft Defender for Office 365 (e.g., Phish reported as Junk, Reported but not malicious).**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises user submissions where admin also performed 'mark and notify' action on the submission\r\nlet ReviewResults = CloudAppEvents | where ActionType == \"SubmissionNotification\" \r\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId)\r\n| extend Properties = parse_json(RawEventData.ExtendedProperties)\r\n| mv-expand element = Properties\r\n| where element.Name == \"AdminReviewResult\"\r\n| project SubmissionId, AdminReviewResult = element.Value;\r\nCloudAppEvents\r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId), SubmissionType = parse_json(RawEventData).SubmissionType\r\n| join kind=leftouter ReviewResults on SubmissionId\r\n| extend UserReportedAs=iif(SubmissionType == 1, \"Phish\",iif(SubmissionType == 2, \"Junk\",iif(SubmissionType == 3, \"NotJunk\",\"\")))\r\n| extend ReviewedAccuracy=iif(UserReportedAs==AdminReviewResult, 1,0)\r\n| extend Reviewed=iif(isempty(AdminReviewResult),\"Not Reviewed\",\"Reviewed\")\r\n| project SubmissionId,UserReportedAs,Reviewed,AdminReviewResult, ReviewedAccuracy\r\n| summarize count() by Reviewed",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 5",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises user submissions type compared to admin review verdict. \r\n//Eg. User reporting a phish but admin review is 'not threat found'\r\nlet ReviewResults = CloudAppEvents | where ActionType == \"SubmissionNotification\" \r\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId)\r\n| extend Properties = parse_json(RawEventData.ExtendedProperties)\r\n| mv-expand element = Properties\r\n| where element.Name == \"AdminReviewResult\"\r\n| project SubmissionId, AdminReviewResult = element.Value;\r\nCloudAppEvents\r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId), SubmissionType = parse_json(RawEventData).SubmissionType\r\n| join kind=leftouter ReviewResults on SubmissionId\r\n| extend UserReportedAs=iif(SubmissionType == 1, \"Phish\",iif(SubmissionType == 2, \"Junk\",iif(SubmissionType == 3, \"NotJunk\",\"\")))\r\n| extend ReviewedAccuracy=iif(AdminReviewResult==UserReportedAs, \"Correct\", iif(AdminReviewResult==\"Phish\" and UserReportedAs == \"Junk\", \"Phish reported as junk\",iif(AdminReviewResult==\"Junk\" and UserReportedAs == \"Phish\",\"Junk reported as Phish\",iif(AdminReviewResult==\"NotJunk\",\"Reported but not malicious or spam\",iif(isempty(AdminReviewResult),\"Not Reviewed\",\"Not correct\")))))\r\n| extend Reviewed=iif(isempty(AdminReviewResult),\"Not Reviewed\",\"Reviewed\")\r\n| project SubmissionId,UserReportedAs,Reviewed,AdminReviewResult, ReviewedAccuracy\r\n| where Reviewed==\"Reviewed\"\r\n| summarize count() by ReviewedAccuracy",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 6",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 P2 Email Senders domains in False Negative(FN) User Submissions \r\n**Displays the top 10 P2 email sender domains of inbound emails reported by users as false negatives (missed detections). Includes total inbound email volume and calculates the percentage of user submissions per domain to highlight high-risk sources.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 P2 Individual Email Senders in False Negative(FN) User Submissions \r\n**Displays the top 10 P2 individual email sender addresses of inbound emails reported by users as false negatives (missed detections). Includes total inbound email volume and calculates the percentage of user submissions per sender to highlight high-risk sources.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises top 10 sender domains of inbound emails submitted as false negatives by users.\r\nlet TotalInboundbySender=\r\nEmailEvents\r\n| where EmailDirection ==\"Inbound\"\r\n| summarize count() by SenderFromDomain;\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),RecipientObjectId=AccountObjectId,NetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Inbound\"\r\n| summarize UserSubmissions=count() by SenderFromDomain\r\n| join TotalInboundbySender on SenderFromDomain\r\n| extend UserSubmissions_Percentage = todouble(round(UserSubmissions / todouble(count_) * 100, 2))\r\n| project SenderFromDomain, UserSubmissions, TotalInboundEmail=count_,UserSubmissions_Percentage\r\n| top 10 by UserSubmissions desc ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "UserSubmissions",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalInboundEmail",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "UserSubmissions_Percentage",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises top 10 sender email addresses of inbound emails submitted as false negatives by users.\r\nlet TotalInboundbySender=\r\nEmailEvents\r\n| where EmailDirection ==\"Inbound\"\r\n| summarize count() by SenderFromAddress;\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),RecipientObjectId=AccountObjectId,NetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Inbound\"\r\n| summarize UserSubmissions=count() by SenderFromAddress\r\n| join TotalInboundbySender on SenderFromAddress\r\n| extend UserSubmissions_Percentage = todouble(round(UserSubmissions / todouble(count_) * 100, 2))\r\n| project SenderFromAddress, UserSubmissions, TotalInboundEmail=count_,UserSubmissions_Percentage\r\n| top 10 by UserSubmissions desc ",
              "size": 0,
              "showAnalytics": true,
              "title": "User Email Submissions (FN)- Top 10 Inbound P2 Senders",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "UserSubmissions",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalInboundEmail",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "UserSubmissions_Percentage",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Intra-org Email Senders in False Negative(FN) User Submissions \r\n**Displays the top 10 email senders of intra-org emails reported by users as false negatives (missed detections). Includes total intra-org email volume and calculates the percentage of user submissions per sender to highlight high-risk sources.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Intra-org Email Subjects in False Negative(FN) User Submissions \r\n**Displays the top 10 Email Subjects of intra-org emails reported by users as false negatives (missed detections). Helps to highlight high-risk intra-org email sources.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises top 10 sender email address of intra-org emails submitted as false negatives by users.\r\nlet TotalInboundbySender=\r\nEmailEvents\r\n| where EmailDirection ==\"Intra-org\"\r\n| summarize count() by SenderFromAddress;\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),RecipientObjectId=AccountObjectId,NetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Intra-org\"\r\n| summarize UserSubmissions=count() by SenderFromAddress\r\n| join TotalInboundbySender on SenderFromAddress\r\n| extend UserSubmissions_Percentage = todouble(round(UserSubmissions / todouble(count_) * 100, 2))\r\n| project SenderFromAddress, UserSubmissions, TotalIntraorgEmail=count_, UserSubmissions_Percentage\r\n| top 10 by UserSubmissions desc ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "UserSubmissions",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalIntraorgEmail",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "UserSubmissions_Percentage",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises top 10 subjects of intra-org emails submitted as false negatives by users.\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Intra-org\"\r\n| summarize count() by Subject\r\n| project Subject,UserSubmissions = count_\r\n| top 10 by UserSubmissions desc ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Subject",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "70ch"
                    }
                  },
                  {
                    "columnMatch": "UserSubmissions",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Detection Overrides defined by Admins in False Negative(FN) User Submissions \r\n**Displays the top 10 use cases where users submitted emails as false negatives (Spam or Phish) that were already detected by Microsoft Defender for Office 365 but delivered due to an admin-defined policy override. Includes details on OrgLevelAction, OrgLevelPolicy, and ThreatTypes for deeper insight into override behaviour.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Detection Overrides defined by Users in False Negative(FN) User Submissions \r\n**Displays the top 10 use cases where users submitted emails as false negatives (Spam or Phish) that were already detected by Microsoft Defender for Office 365 but delivered due to a user-defined override. Includes details on UserLevelAction, UserLevelPolicy, and ThreatTypes for deeper insight into override behaviour.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises emails submitted as false negatives by users where emails where already detected by MDO but there was an admin definded policy override.\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where ThreatTypes !=\"\"and OrgLevelAction!=\"\"\r\n| summarize count() by OrgLevelAction, OrgLevelPolicy,ThreatTypes,User_SubmissionType\r\n| project OrgLevelAction, OrgLevelPolicy,ThreatTypes,User_SubmissionType, UserSubmissions = count_\r\n| top 10 by UserSubmissions desc ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "OrgLevelPolicy",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "48ch"
                    }
                  },
                  {
                    "columnMatch": "UserSubmissions",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises emails submitted as false negatives by users where emails where already detected by MDO but there was an policy override.\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where ThreatTypes !=\"\"and UserLevelAction!=\"\"\r\n| summarize count() by UserLevelAction, UserLevelPolicy,ThreatTypes,User_SubmissionType\r\n| project UserLevelAction, UserLevelPolicy,ThreatTypes,User_SubmissionType, UserSubmissions = count_\r\n| top 10 by UserSubmissions desc ",
              "size": 0,
              "showAnalytics": true,
              "title": "User Email Submissions (FN)- Top 10 Detection Overrides by Users",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "UserLevelPolicy",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "48ch"
                    }
                  },
                  {
                    "columnMatch": "UserSubmissions",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 users performing the most False Negative(FN) User Submissions\r\n**Displays the Top 10 user accounts that performed the highest number of False Negative(FN) User Submissions (missed detections). Helps identify individuals most engaged in reporting suspicious, malicious messages and potential patterns in detection gaps.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 users performing the most User Submissions of Attack simulation messages\r\n**Displays the top 10 user accounts that reported phishing simulation emails during cyber security awareness campaigns. Supports evaluation of cyber security awareness programme effectiveness and identifies highly engaged users.**"
            },
            "customWidth": "50",
            "name": "text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 users performing false negative submissions\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\" \r\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and SubmissionType in (\"0\",\"1\")\r\n| extend UserId = (parse_json(RawEventData)).UserId\r\n| summarize count() by tostring(UserId) | sort by count_\r\n| top 10 by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top users reporting the phishing simulation emails.\r\nCloudAppEvents \r\n| extend Record= (parse_json(RawEventData)).RecordType \r\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState \r\n| extend UserId = (parse_json(RawEventData)).UserId\r\n| where Record == 29\r\n| where ActionType == \"AttackSimUserSubmission\" \r\n| summarize count() by tostring(UserId) | sort by count_\r\n| top 10 by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "50",
            "name": "query - 2 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "8"
      },
      "name": "group - 11 - FN User submissions",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "# False Positive(FP) Submissions insights\r\n\r\n---\r\n\r\nThis tab provides insights into email message **False Positive(FP) Submissions** performed by users or administrators in Microsoft Defender for Office 365 where the message was flagged as a threat by Microsoft Defender for Office 365 but was later reported as No Threat by administrators or users."
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "10"
      },
      "name": "FP Description",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">False Positive(FP) Admin Submissions\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nAdministrator submissions represent escalated false positive reports submitted by security team members rather than end users. These typically involve more complex cases requiring expert review, such as recurring issues affecting multiple users, business-critical communications being blocked, or suspected policy misconfigurations. Admin submissions carry higher priority and can result in actions as allow-list additions or global policy changes to prevent widespread user impact."
            },
            "name": "text - 5"
          },
          {
            "type": 1,
            "content": {
              "json": "<br>\r\n### Admin Submission Volume and Type Breakdown\r\n\r\n**These charts track the volume and composition of administrator-initiated false positive submissions. The trend chart shows daily submission patterns across Email, URL, and Attachment types, while the pie chart reveals the distribution among these categories. Spikes in admin submissions often signal systemic issues requiring immediate policy review, as admins typically escalate only the most impactful or recurring problems.**"
            },
            "name": "text - 6"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of admin false positive submission by submission type.\r\nlet minTime = toscalar(CloudAppEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(CloudAppEvents | summarize max(Timestamp));\r\nlet baseQuery = CloudAppEvents\r\n| where ActionType contains \"Submission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType);\r\nlet Admin_Email_FP=baseQuery\r\n| make-series Count= countif(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Email_FP\";\r\nlet Admin_URL_FP=baseQuery\r\n| make-series Count= countif(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_URL_FP\";\r\nlet Admin_Attach_FP=baseQuery\r\n| make-series Count= countif(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Attach_FP\";\r\nunion Admin_Email_FP,Admin_URL_FP,Admin_Attach_FP\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalAdminSubmissions",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Admin_Phish_FN",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "Admin_Spam_FN",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Admin_Malware_FN",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Admin_Phish_URL_FN",
                    "color": "purple"
                  },
                  {
                    "seriesName": "Admin_Malware_Attach_FN",
                    "color": "yellowDark"
                  },
                  {
                    "seriesName": "Admin_Phish_Attach_FN",
                    "color": "purpleDark"
                  },
                  {
                    "seriesName": "Admin_Malware_URL_FN",
                    "color": "yellow"
                  },
                  {
                    "seriesName": "Admin_Email_FP",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Admin_URL_FP",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "Admin_Attach_FP",
                    "color": "yellow"
                  }
                ]
              }
            },
            "customWidth": "66",
            "name": "query - 4 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of admin false positive submission by submission type.\r\nCloudAppEvents \r\n| where ActionType contains \"Submission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| extend Admin_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Email_FP\",\r\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\",\"Admin_URL_FP\",\r\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\",\"Admin_Attach_FP\",\r\n\"Other\")))\r\n| where Admin_SubmissionType!=\"Other\"\r\n| summarize count() by Admin_SubmissionType",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### False Positive(FP) Admin Submissions by submission state<br>\r\n\r\n**Displays the total count of False Positive(FP) Admin Submissions by submission State (e.g., Pending, Completed, Failed). Helps track the processing status of admin submissions and identify bottlenecks or errors.**"
            },
            "customWidth": "50",
            "name": "text - 7",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top Admins Submitting False Positives<br>\r\n\r\n**Displays the top 15 admin accounts that submitted the highest number of false positive messages via AdminSubmission.**"
            },
            "customWidth": "50",
            "name": "text - 7 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of admin false positive submissions by the state of the submission.\r\nCloudAppEvents \r\n| where ActionType contains \"AdminSubmission\" \r\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and SubmissionType == \"3\"\r\n| summarize count() by tostring(SubmissionState)",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top admins performing false positive submissions.\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend Record= (parse_json(RawEventData)).RecordType,SubmissionState = (parse_json(RawEventData)).SubmissionState, UserId = (parse_json(RawEventData)).UserId,SubmissionType = parse_json(RawEventData).SubmissionType  \r\n| where Record == 29 and SubmissionType ==\"3\"\r\n| summarize count() by tostring(UserId) | sort by count_\r\n| top 15 by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Admin False Positive Phish Detection Breakdown<br>\r\n\r\n**Displays the count of administrator-submitted false positive email reports (legitimate emails flagged as phishing) grouped by detection method. Helps identify which filtering technologies contribute most to misclassification.**"
            },
            "customWidth": "50",
            "name": "text - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Admin False Positive Spam Detection Breakdown<br>\r\n\r\n**Shows the count of administrator-submitted false positive email reports (legitimate emails flagged as spam) grouped by detection method. Helps identify which filtering technologies most often misclassify valid messages.**"
            },
            "customWidth": "50",
            "name": "text - 8 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| extend Admin_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ,\"Admin_Email_FP\",\r\n\"Other\"),DetectionMethod=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdictControlSource),\r\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType == \"3\" and DetectionVerdict ==\"Phish\" \r\n| summarize count() by DetectionMethod\r\n| project DetectionMethod,Emails = count_\r\n",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 0 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the original detection technology of emails submitted as spam false positive by admins\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| extend Admin_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ,\"Admin_Email_FP\",\r\n\"Other\"),DetectionMethod=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdictControlSource),\r\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType == \"3\" and DetectionVerdict ==\"Spam\" \r\n| summarize count() by DetectionMethod\r\n| project DetectionMethod,Emails = count_\r\n",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 0 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Sender Domains for Admin False Positive Submissions<br>\r\n\r\n**Lists the top 10 sender domains of emails reported as false positives by administrators (legitimate messages incorrectly flagged as spam or phishing). Helps identify domains frequently misclassified.**"
            },
            "customWidth": "50",
            "name": "text - 9",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Admin False Positive Submissions by Original Threat Verdict<br>\r\n\r\n**Displays all administrator-submitted false positive emails by their original filter verdict (e.g., spam, phishing) and policy override details. Helps identify which threat categories are most often misclassified.**"
            },
            "customWidth": "50",
            "name": "text - 9 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 sender domains of emails which are submitted as false positive by admins\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType ==\"3\"\r\n| summarize count() by P2SenderDomain\r\n| project P2SenderDomain, Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises all emails submitted as false positive by admins summarizing by the original filter verdict threat type\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| extend Admin_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ,\"Admin_Email_FP\",\r\n\"Other\"),\r\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType == \"3\"\r\n| summarize count() by PolicyOverride,DetectionVerdict,Admin_SubmissionType\r\n| project PolicyOverride, DetectionVerdict,Admin_SubmissionType, Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "10"
      },
      "name": "group - 11 - Copy",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">False Positive (FP) User Submissions\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section provides insights into email message False Postive(FP) Submissions performed by end users in Microsoft Defender for Office 365 where the message was flagged as a threat by Microsoft Defender for Office 365 but was later reported as No Threat by users. User submissions are critical feedback mechanisms that help security teams identify overly aggressive detection rules, refine security policies, and reduce user friction. High false positive rates can erode user trust and lead to security fatigue, so monitoring these metrics helps balance protection with productivity."
            },
            "name": "text - 0"
          },
          {
            "type": 1,
            "content": {
              "json": "<br>\r\n### User Submission Trend\r\n\r\n**Displays the daily volume of false positive submissions from end users. A sudden spike may indicate a new detection rule causing widespread misclassification, while a declining trend suggests improving detection accuracy. Monitoring this trend helps security teams respond quickly to detection issues before they impact user productivity.**"
            },
            "name": "text - 1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of user false positive submission by submission type.\r\nlet minTime = toscalar(CloudAppEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(CloudAppEvents | summarize max(Timestamp));\r\nlet User_Email_FP=CloudAppEvents\r\n| where ActionType contains \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| make-series Count= countif(SubmissionType == \"3\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"User_Email_FP\";\r\nUser_Email_FP\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalAdminSubmissions",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "User_Phish_FN",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "User_AttackSim_Submission",
                    "color": "green"
                  },
                  {
                    "seriesName": "User_Spam_FN",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "User_Email_FP",
                    "color": "green"
                  }
                ]
              }
            },
            "customWidth": "100",
            "name": "query - 4 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### User False Positive Submissions by State<br>\r\n\r\n**Displays the total number of user-reported false positive email submissions grouped by their processing state (e.g., pending, completed). Helps track submission workflow and resolution progress.**"
            },
            "customWidth": "50",
            "name": "text - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top Users Performing False Positive Submissions<br>\r\n\r\n**Lists the top 15 users who reported emails as false positives (legitimate messages incorrectly flagged as threats). Helps identify frequent reporters and potential training or policy adjustment needs.**"
            },
            "customWidth": "50",
            "name": "text - 2 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of user false positive submission by submission state.\r\nCloudAppEvents \r\n| where ActionType contains \"UserSubmission\" \r\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and SubmissionType == \"3\"\r\n| summarize count() by tostring(SubmissionState)",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top users performing false positive submissions.\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\" \r\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and SubmissionType == \"3\"\r\n| extend UserId = (parse_json(RawEventData)).UserId\r\n| summarize count() by tostring(UserId) | sort by count_\r\n| top 15 by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### User False Positive Submissions by Original Phish Detection Verdict<br>\r\n\r\n**Shows the number of user-reported false positive emails originally flagged by phishing detection filters, grouped by verdict type. Helps identify which phishing detection methods most often misclassify legitimate messages.**"
            },
            "customWidth": "50",
            "name": "text - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### User False Positive Submissions by Original Spam Detection Verdict<br>\r\n\r\n**Shows the number of user-reported false positive emails originally flagged by spam detection filters, grouped by verdict type. Helps identify which spam detection methods most often misclassify legitimate messages.**"
            },
            "customWidth": "50",
            "name": "text - 3 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of user false positive submission by original phish filter detected verdict.\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Email_FP\",\r\n\"Other\"),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType ==\"3\"\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Inbound\" and DetectionMethods has 'Phish'\r\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Phish=tostring(column_ifexists('Phish', ''))",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "50",
            "name": "query - 2 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of user false positive submission by original spam filter detected verdict.\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Email_FP\",\r\n\"Other\"),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType ==\"3\"\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Inbound\" and DetectionMethods has 'Spam'\r\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Spam=tostring(column_ifexists('Spam', ''))",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "50",
            "name": "query - 2 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Sender Domains for User False Positive Submissions<br>\r\n\r\n**Lists the top 10 sender domains of emails reported as false positives by users (legitimate messages incorrectly flagged as threats). Helps identify domains frequently misclassified.**"
            },
            "customWidth": "50",
            "name": "text - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Senders in User False Positive Submissions<br>\r\n\r\n**Displays the top 10 email senders whose messages were reported as false positives by users (legitimate emails incorrectly flagged as threats). Helps identify senders frequently misclassified.**"
            },
            "customWidth": "50",
            "name": "text - 4 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CloudAppEvents \r\n| where ActionType == \"UserSubmission\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType == \"3\"\r\n| summarize count() by P2SenderDomain\r\n| project P2SenderDomain, Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 senders seen in false positive user submission\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Email_FP\",\r\n\"Other\"),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType == \"3\"\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Inbound\"\r\n| summarize count() by SenderMailFromAddress\r\n| project SenderMailFromAddress,Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Subjects in User False Positive Submissions<br>\r\n\r\n**Displays the top 10 email subjects reported as false positives by users (legitimate messages incorrectly flagged as threats). Helps identify common patterns in misclassified emails.**"
            },
            "customWidth": "50",
            "name": "text - 4 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Top 10 Intra-Org Senders in User False Positive Submissions<br>\r\n\r\n**Displays the top 10 internal senders whose emails were reported as false positives by users (legitimate intra-org messages incorrectly flagged as threats). Helps identify internal communication patterns causing misclassification.**"
            },
            "customWidth": "50",
            "name": "text - 4 - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 subjects seen in false positive user submission\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Email_FP\",\r\n\"Other\"),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType ==\"3\"\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Inbound\"\r\n| summarize count() by Subject\r\n| project Subject,Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Subject",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "70ch"
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 senders seen in intra-org false positive user submission\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Email_FP\",\r\n\"Other\"),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType ==\"3\"\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Intra-org\"\r\n| summarize count() by SenderMailFromAddress\r\n| project SenderMailFromAddress,Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "10"
      },
      "name": "group - 11 - Copy - Copy",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "# File Malware Detections (SharePoint, Teams and OneDrive)\r\n\r\n---\r\n\r\nThis tab provides insights into malicious file detections across Microsoft collaboration platforms such as SharePoint, OneDrive, and Teams.\r\n\r\n[<p><b>Safe Attachments for SharePoint, OneDrive, and Microsoft Teams</b></p>](https://learn.microsoft.com/en-us/defender-office-365/safe-attachments-for-spo-odfb-teams-about)\r\n[<p><b>Built-in virus protection in SharePoint, SharePoint Embedded, OneDrive, and Microsoft Teams</b></p>](https://learn.microsoft.com/en-us/defender-office-365/anti-malware-protection-for-spo-odfb-teams-about) "
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "9"
      },
      "name": "File Malware Description",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">File Malware Detection (SharePoint, OneDrive, and Teams)\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section monitors malware detections in files stored across Microsoft 365 collaboration platforms. Microsoft Defender for Office 365 and built-in SharePoint Online antivirus work together to scan files uploaded to SharePoint, OneDrive, and Teams. Understanding file-based malware patterns helps protect collaborative workspaces and identify potential security risks in shared content."
            },
            "name": "text - 0"
          },
          {
            "type": 1,
            "content": {
              "json": "### File Malware Detection Trend<br>\r\n\r\n**This visual tracks the daily volume of malware detections in files across all Microsoft 365 workloads. Spikes in detection activity may indicate targeted attacks or emerging malware campaigns affecting collaborative platforms. Regular monitoring helps identify unusual patterns that require investigation.**"
            },
            "name": "text - 1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total files located on SharePoint, OneDrive and Teams with Malware detections over time summarizing the data daily. \r\nCloudAppEvents\r\n| where ActionType == 'FileMalwareDetected'\r\n| make-series Count = count() default = 0 on Timestamp step 1d ",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "tileSettings": {
                "showBorder": false
              },
              "graphSettings": {
                "type": 0
              },
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "FileMalwareDetections",
                    "color": "redDark"
                  }
                ],
                "showDataPoints": true
              }
            },
            "customWidth": "100",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Malware Family Analysis - Defender for Office 365<br>\r\n\r\n**Provides a visual breakdown of malware detections in files scanned by Microsoft Defender for Office 365 across SharePoint, OneDrive, and Teams. The pie chart shows the distribution of malware families, while the table lists total detections per family, helping identify dominant threats and trends in collaboration platforms.**"
            },
            "customWidth": "50",
            "name": "text - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Malware Family Analysis - SharePoint AV<br>\r\n\r\n**Provides a visual summary of malware detections in files across SharePoint, OneDrive, and Teams using built-in SharePoint antivirus. The pie chart shows the distribution of malware families, while the table lists total detections per family, helping identify prevalent threats and trends in collaboration environments.**"
            },
            "customWidth": "50",
            "name": "text - 2 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CloudAppEvents\r\n| where ActionType == 'FileMalwareDetected' and UserAgent =~ 'MS Scanner ATP'\r\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\r\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "RawinfoVirusInfo",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "RawinfoVirusInfo",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "count_",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "xAxis": "RawinfoVirusInfo",
                "createOtherGroup": 20,
                "showMetrics": false
              }
            },
            "customWidth": "25",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total Malware detections of files located on SharePoint, OneDrive and Teams over time summarizing the data by the various Malware families detected focusing on Defender for Office 365 detections (detonations). \r\nCloudAppEvents\r\n| where ActionType == 'FileMalwareDetected' and UserAgent =~ 'MS Scanner ATP'\r\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\r\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_\r\n| project RawinfoVirusInfo, Files=count_",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Files",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "RawinfoVirusInfo",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "RawinfoVirusInfo",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "count_",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "xAxis": "RawinfoVirusInfo",
                "createOtherGroup": 15
              }
            },
            "customWidth": "25",
            "name": "query - 1 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total Malware detections of files located on SharePoint, OneDrive and Teams over time summarizing the data by the various Malware families detected focusing on built-in SharePoint AV detections. \r\nCloudAppEvents\r\n| where ActionType == 'FileMalwareDetected' and isempty(UserAgent)\r\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\r\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "xAxis": "RawinfoVirusInfo",
                "createOtherGroup": 20,
                "showMetrics": false
              }
            },
            "customWidth": "25",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CloudAppEvents\r\n| where ActionType == 'FileMalwareDetected' and isempty(UserAgent)\r\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\r\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_\r\n| project RawinfoVirusInfo, Files=count_",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Files",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "chartSettings": {
                "xAxis": "RawinfoVirusInfo",
                "createOtherGroup": 10
              }
            },
            "customWidth": "25",
            "name": "query - 2 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Malware Detections by Location<br>\r\n\r\n**Displays the number of malware detections grouped by specific SharePoint sites or OneDrive locations. Helps identify which sites have the highest volume of detected threats for targeted remediation and security hardening.**"
            },
            "customWidth": "50",
            "name": "text - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Malware Detections by Application<br>\r\n\r\n**Summarizes malware detections across Microsoft collaboration apps, including SharePoint, OneDrive, and Teams. Helps identify which applications experience the highest volume of detected threats for targeted security measures.**"
            },
            "customWidth": "50",
            "name": "text - 3 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CloudAppEvents\r\n| where ActionType == 'FileMalwareDetected'\r\n| project location=(split(RawEventData.SiteUrl, '/')[4])\r\n| summarize count() by tostring(location)\r\n| sort by count_ desc",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "location",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CloudAppEvents\r\n| where ActionType == 'FileMalwareDetected'\r\n| extend Appwithteams = iff(Application =~ 'Microsoft SharePoint Online',strcat(Application,' / Teams Files'),Application)\r\n| extend Appwithteams = trim_start('Microsoft',Appwithteams) | summarize count() by Appwithteams\r\n| sort by count_ desc",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "9"
      },
      "name": "group - 4",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "# Post Delivery Detections\r\n\r\n---\r\n\r\nThis tab provides insights into threats detected after email delivery to user mailboxes by mechanisms such as Zero-hour auto purge (ZAP) in Microsoft Defender for Office 365.\r\n\r\n[<p><b>Learn more</b></p>](https://learn.microsoft.com/en-us/defender-office-365/zero-hour-auto-purge)"
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "11"
      },
      "name": "Post Delivery Tab Description",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Post Delivery Protection offered by ZAP\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section provides insights into Microsoft Defender for Office 365's post-delivery protection capabilities through Zero-Hour Auto Purge (ZAP). ZAP is a critical security feature that continuously monitors delivered emails and automatically removes messages that are later identified as malicious. These visuals help track ZAP effectiveness, response times, and remediation patterns."
            },
            "name": "text - 0"
          },
          {
            "type": 1,
            "content": {
              "json": "### Daily ZAP Post-Delivery Actions<br>\r\n\r\n**Shows the daily count of emails that were remediated post-delivery by Zero-Hour Auto Purge (ZAP). Helps track how often threats are detected and removed after reaching user mailboxes.**"
            },
            "customWidth": "50",
            "name": "text - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Daily ZAP Actions by Detection Type<br>\r\n\r\n**Visualizes the daily count of post-delivery remediation actions performed by Zero-Hour Auto Purge (ZAP), broken down by detection type (Spam ZAP, Phish ZAP, Malware ZAP). Helps track which threat categories are most frequently remediated after delivery.**"
            },
            "customWidth": "50",
            "name": "text - 1 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of emails that had a post delivery action from zero-hour auto purge.\r\nEmailPostDeliveryEvents \r\n| where ActionType has \"ZAP\"\r\n| make-series Count = count() default = 0 on Timestamp step 1d \r\n| extend Details = \"Zapped Emails\";",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of emails that had a post delivery action from zero-hour auto purge, summarizing by phish,spam or malware detection action\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailPostDeliveryEvents\r\n| where ActionType has \"ZAP\";\r\nlet szap=baseQuery\r\n| where ActionType has 'Spam ZAP' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spam ZAP\";\r\nlet pzap=baseQuery\r\n| where ActionType has 'Phish ZAP' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Phish ZAP\";\r\nlet mzap=baseQuery\r\n| where ActionType has 'Malware ZAP' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Malware ZAP\";\r\nunion szap,pzap,mzap\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "50",
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### ZAP Remediation by Destination<br>\r\n\r\n**This visual shows where ZAP moves malicious emails during remediation. Post-delivery actions can send emails to different locations: Quarantine (isolated for admin review), Deleted Items (soft delete), Junk Email folder, or back to Inbox (for false positive corrections). Understanding these patterns helps evaluate ZAP policy configurations and ensures malicious content is properly isolated from users.**"
            },
            "name": "text - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails that had a post delivery action, summarizing the data daily by the final location as a result of the action\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet quarantine=EmailPostDeliveryEvents\r\n| where DeliveryLocation has 'Quarantine' and ActionType contains \"ZAP\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Quarantine\";\r\nlet delete=EmailPostDeliveryEvents\r\n| where DeliveryLocation has 'Delete' and ActionType contains \"ZAP\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Delete\";\r\nlet junk=EmailPostDeliveryEvents\r\n| where DeliveryLocation has 'Junk' and ActionType contains \"ZAP\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Junk\";\r\nlet inbox=EmailPostDeliveryEvents\r\n| where DeliveryLocation has 'Inbox' and ActionType contains \"ZAP\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Inbox\";\r\nunion quarantine,delete,junk,inbox\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "11"
      },
      "name": "group - 13",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "# Quarantine Insights\r\n\r\n---\r\n\r\nThis tab provides insights into emails that were quarantined by Microsoft Defender for Office 365 due to security policies or threat detections. This tab includes data on quarantined messages by threat type (phish, spam, malware), sender domains, and user interactions such as release requests. These insights help security teams monitor quarantined items, identify patterns in false positives, and ensure timely remediation to maintain productivity and security.\r\n\r\n[<p><b>Learn more</b></p>](https://learn.microsoft.com/en-us/defender-office-365/quarantine-about)"
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "12"
      },
      "name": "Quarantine Tab Description",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Quarantine Management and Insights\r\n</td>\r\n</tr>\r\n</table>\r\n\r\nThis section provides comprehensive insights into quarantine operations, including release patterns, detection methods, and threat categorization. It helps security teams understand what types of threats are being quarantined and monitor quarantine release activity to identify potential false positives or security policy effectiveness."
            },
            "name": "text - 0"
          },
          {
            "type": 1,
            "content": {
              "json": "### Quarantine Release Trend<br>\r\n\r\n**This visual displays the daily trend of emails released from quarantine by administrators. Monitoring this metric helps identify patterns in quarantine management and potential areas where policy adjustments may be needed to reduce unnecessary quarantines.**"
            },
            "name": "text - 1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of emails released from quarantine\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet qrel = EmailPostDeliveryEvents\r\n| where ActionTrigger has \"AdminAction\" and Action has 'Quarantine release' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Quarantine release\";\r\nqrel\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Quarantine Release Percentage<br>\r\n\r\n**Calculates the percentage of quarantined emails that were successfully released compared to the total quarantined messages. This metric helps measure engagement with quarantine and assess the effectiveness of quarantine policies.**"
            },
            "customWidth": "66",
            "name": "text - 2 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Quarantine Release Analysis by Detection Type<br>\r\n\r\n**This visual shows the distribution of quarantine release attempts categorized by the original detection method (Malware, Phish, or Spam). Understanding which detection types result in the most release attempts can help identify potential false positives and areas where detection rules may need tuning.**"
            },
            "customWidth": "33",
            "name": "text - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the percentage of emails released from quarantine out of the total ammount of quarantined emails\r\nlet Quarantine_Releases = toscalar(EmailPostDeliveryEvents\r\n| where Action == \"Quarantine release\"\r\n| join kind=leftouter (EmailEvents | where DeliveryLocation == \"Quarantine\") on NetworkMessageId\r\n| summarize count());\r\nlet Quarantined_Mailfow = toscalar(EmailEvents | where DeliveryLocation == \"Quarantine\"\r\n| summarize count());\r\nprint\r\nQuarantine_Releases = toreal(Quarantine_Releases),\r\nQuarantined_Mailflow = toreal(Quarantined_Mailfow),\r\nRelease_Percentage = abs(round(((toreal(Quarantine_Releases)/toreal(Quarantined_Mailfow))*100),2))",
              "size": 0,
              "showAnalytics": true,
              "title": " ",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "stat",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Release_Percentage",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "none"
                  },
                  "numberFormat": {
                    "unit": 1,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                "showBorder": true,
                "sortCriteriaField": "Release_Percentage",
                "size": "auto"
              },
              "statSettings": {
                "valueField": "Release_Percentage",
                "valueAggregation": "None",
                "colorSettings": {
                  "type": "thresholds",
                  "mode": "foreground",
                  "heatmapPalette": "greenRed",
                  "thresholdsGrid": [
                    {
                      "operator": "<",
                      "thresholdValue": "5",
                      "representation": "green"
                    },
                    {
                      "operator": ">",
                      "thresholdValue": "5",
                      "representation": "redDark"
                    }
                  ]
                },
                "iconSettings": {
                  "thresholdsGrid": []
                },
                "numberFormatSettings": {
                  "unit": 1,
                  "options": {
                    "style": "decimal"
                  }
                },
                "tagText": "Quarantine Release Percentage",
                "valueFontStyle": "mega",
                "tagTextPosition": "bottom"
              }
            },
            "customWidth": "66",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises emails released from quarantine and summarizing the result by the original filter verdict - detection method\r\nlet totalQuery = \r\n    EmailPostDeliveryEvents \r\n    | where Action == \"Quarantine release\" \r\n    | join kind=inner (EmailEvents | where DeliveryLocation == \"Quarantine\") on NetworkMessageId \r\n    | extend MDO_detection = parse_json(DetectionMethods1) \r\n    | extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n    | extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n    | where FirstSubcategory contains \"Malware\" or FirstSubcategory contains \"Phish\" or FirstSubcategory contains \"Spam\"\r\n    | count;\r\nEmailPostDeliveryEvents \r\n| where Action == \"Quarantine release\" \r\n| join kind=inner (EmailEvents | where DeliveryLocation == \"Quarantine\") on NetworkMessageId \r\n| extend MDO_detection = parse_json(DetectionMethods1) \r\n| extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n| extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n| where FirstSubcategory contains \"Malware\" or FirstSubcategory contains \"Phish\" or FirstSubcategory contains \"Spam\" \r\n| summarize count_messages = count(NetworkMessageId) by FirstSubcategory\r\n| extend percentage = round((count_messages * 100.0 / toscalar(totalQuery)), 2)\r\n| project FirstSubcategory, count_messages, percentage\r\n| order by percentage desc",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "percentage"
                ],
                "createOtherGroup": 20,
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "33",
            "name": "query - 6",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Phishing Email Quarantine Analysis<br>\r\n\r\n**These visuals break down quarantined phishing emails by their specific detection methods. Microsoft Defender for Office 365 employs multiple phishing detection techniques including impersonation protection, URL detonation, spoof detection, and advanced filters. Understanding which detection methods are most frequently triggered helps optimize anti-phishing policies and identify emerging phishing tactics.<br>The line chart shows daily trends across all phishing detection methods, while the pie chart provides an overall distribution of detection reasons.**"
            },
            "name": "text - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of phish emails that are quarantined, summarized daily by the detection method\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n| where DetectionMethods has \"Phish\" and DeliveryLocation == \"Quarantine\";\r\nlet ml=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Advanced filter'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Advanced filter\";\r\nlet camp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Campaign'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Campaign\";\r\nlet fd=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'File detonation' and Phish !has 'File detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"File detonation\";\r\nlet fdr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'File detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"File detonation reputation\";\r\nlet frp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Fingerprint matching' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Fingerprint matching\";\r\nlet gf=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'General filter' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"General filter\";\r\nlet bimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation brand' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation brand\";\r\nlet dimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation domain' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation domain\";\r\nlet uimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation user' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation user\";\r\nlet mimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Mailbox intelligence impersonation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Mailbox intelligence impersonation\";\r\nlet sdmarc=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof DMARC' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof DMARC\";\r\nlet spoofe=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof external domain' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof external domain\";\r\nlet spoofi=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof intra-org' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof intra-org\";\r\nlet ud=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL detonation' and Phish !has 'URL detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL detonation\";\r\nlet udr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL detonation reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL detonation reputation\";\r\nlet umr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL malicious reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL malicious reputation\";\r\nunion ml,camp,fd,fdr,frp,gf,bimp,dimp,uimp,mimp,sdmarc,spoofe,spoofi,ud,udr,umr\r\n| project Count, Details, Timestamp\r\n\r\n\r\n",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "66",
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of phish emails that are quarantined, summarized by the detection method\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\" and DetectionMethods has 'Phish' and DeliveryLocation == \"Quarantine\"\r\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Phish=tostring(column_ifexists('Phish', ''))",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 20
              }
            },
            "customWidth": "33",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Spam Email Quarantine Analysis<br>\r\n\r\n**These visuals provide detailed insights into quarantined spam emails categorized by detection methods. Spam detection technologies include advanced filters, general filters, bulk email filtering, reputation-based systems (IP, domain, URL), and mixed analysis detection. Analyzing spam quarantine patterns helps fine-tune spam filtering policies to balance security with user productivity and reduce false positives.<br>The line chart displays daily trends for each spam detection method, while the pie chart shows the overall distribution.**"
            },
            "name": "text - 4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of spam emails that are quarantined, summarized daily by the detection method\r\nlet baseQuery = EmailEvents\r\n| where DetectionMethods has \"Spam\" and DeliveryLocation == \"Quarantine\";\r\nlet timerange = \r\nbaseQuery\r\n| summarize minTime = min(Timestamp), maxTime = max(Timestamp);\r\nlet ml=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Advanced filter'\r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"Advanced filter\";\r\nlet gf=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'General filter'\r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"General filter\";\r\nlet bl=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'BulkFilter'\r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"BulkFilter\";\r\nlet mx=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Mixed analysis detection'\r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"Mixed analysis detection\";\r\nlet frp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Fingerprint matching'\r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"Fingerprint matching\";\r\nlet umr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'URL malicious reputation' \r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"URL malicious reputation\";\r\nlet dr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Domain reputation' \r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"Domain reputation\";\r\nlet ipr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'IP reputation' \r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"IP reputation\";\r\nunion ml,gf,bl,mx,frp,umr,dr,ipr\r\n| project Count, Details, Timestamp",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "66",
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of spam emails that are quarantined, summarized by the detection method\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\" and DetectionMethods has 'Spam' and DeliveryLocation == \"Quarantine\"\r\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Spam=tostring(column_ifexists('Spam', ''))",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 20
              }
            },
            "customWidth": "33",
            "name": "query - 2 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "12"
      },
      "name": "group - 19"
    },
    {
      "type": 1,
      "content": {
        "json": "# Security Operations Center (SOC) Insights \r\n\r\n---\r\n\r\nThis tab provides a view for security operations. Combines incident response metrics with investigation insights to evaluate the effectiveness of both automated systems and manual interventions."
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "13"
      },
      "name": "text - 13 - Copy",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Security Incident Response Metrics\r\n</td>\r\n</tr>\r\n</table>\r\n\r\n**Operational efficiency insights.** Tracks incident volume, resolution speed, automation efficacy, and classification accuracy to evaluate SOC performance."
            },
            "name": "text - 8"
          },
          {
            "type": 1,
            "content": {
              "json": "### Email Security Incidents<br>\r\n\r\n**These visuals display the daily trend of email-related security incidents, as well as the proportion of email incidents compared to the total number of incidents in Defender.**"
            },
            "name": "text - 6"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Filter for incidents that have at least one Email Security alert\r\nlet OfficeEmailAlerts = SecurityAlert\r\n    | where ProductName contains \"Office 365 Advanced Threat Protection\" or ProductName contains \"Microsoft 365 Defender\"\r\n    | project SystemAlertId;\r\nSecurityIncident\r\n| summarize arg_max(TimeGenerated, *) by IncidentNumber\r\n| mv-expand AlertIds\r\n| where isnotempty(AlertIds) and not(Title startswith \"CC_\")\r\n| extend AlertId = tostring(AlertIds) \r\n| join kind=inner\r\n    (OfficeEmailAlerts | extend SystemAlertId = tostring(SystemAlertId))\r\n    on $left.AlertId == $right.SystemAlertId\r\n| summarize arg_max(TimeGenerated, *), AlertCount = dcount(AlertId) by IncidentNumber\r\n| make-series Incidents_Number = count() default = 0 on TimeGenerated step 1d",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "75",
            "name": "query - 6"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Categorize incidents: Email Security vs Other\r\nlet AllAlerts = SecurityAlert\r\n    | extend SystemAlertId = tostring(SystemAlertId)\r\n    | project SystemAlertId, ProductName;\r\nSecurityIncident\r\n| summarize arg_max(TimeGenerated, *) by IncidentNumber\r\n| mv-expand AlertIds\r\n| where isnotempty(AlertIds) and not(Title startswith \"CC_\")\r\n| extend AlertId = tostring(AlertIds)\r\n| join kind=inner\r\n    (AllAlerts)\r\n    on $left.AlertId == $right.SystemAlertId\r\n| summarize AlertSystems = make_set(ProductName) by IncidentNumber\r\n| extend HasEmailSecurity = \r\n    AlertSystems has \"Office 365 Advanced Threat Protection\" or \r\n    AlertSystems has \"Microsoft 365 Defender\"\r\n| extend Category = iff(HasEmailSecurity, \"Email Security\", \"Other\")\r\n| summarize IncidentCount = count() by Category\r\n",
              "size": 3,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "25",
            "name": "query - 7"
          },
          {
            "type": 1,
            "content": {
              "json": "### Average Incident Time To Close<br>\r\n\r\n**This visual displays the average time taken to close email-related security incidents, showing daily trends and providing insight into how resolution speed changes over time.**"
            },
            "name": "text - 6 - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SLA thresholds by severity for email-security (MDO) incidents\r\nlet SLA_Variables = datatable (Severity:string, TimeToResolve:int) [\r\n    \"High\", 60,\r\n    \"Medium\", 120,\r\n    \"Low\", 240,\r\n    \"Informational\", 480\r\n];\r\n\r\n// Identify MDO-related incidents via alert correlation\r\nlet EmailSecurityIncidents = \r\n    SecurityIncident\r\n    | mv-expand AlertIds\r\n    | where isnotempty(AlertIds)\r\n    | extend AlertId = tostring(AlertIds)\r\n    | join kind=inner (\r\n        SecurityAlert\r\n        | where ProductName in (\"Office 365 Advanced Threat Protection\", \"Microsoft 365 Defender\")\r\n        | extend AlertId = tostring(SystemAlertId)\r\n        | project AlertId\r\n    ) on AlertId\r\n    | distinct ProviderIncidentId;\r\n\r\n// Get latest incident state for each MDO-related incident\r\nlet LatestMdoIncidents =\r\n    SecurityIncident\r\n    | summarize arg_max(TimeGenerated, Classification, Status, Severity, CreatedTime, ClosedTime, Title) by ProviderIncidentId\r\n    | where ProviderIncidentId in (EmailSecurityIncidents)\r\n    | where not(Title startswith \"CC_\");  // Exclude non-email incidents as needed\r\n\r\nLatestMdoIncidents\r\n| where Status == \"Closed\"\r\n| extend TimeToResolveIncident = datetime_diff('minute', ClosedTime, CreatedTime)\r\n| join kind=inner SLA_Variables on Severity\r\n| summarize\r\n    AvgTimeToCloseMinutes = avg(TimeToResolveIncident),\r\n    CountIncidents = count()\r\n    by Day = bin(ClosedTime, 1d), Severity\r\n| order by Day asc, Severity asc",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "xAxis": "Day",
                "yAxis": [
                  "AvgTimeToCloseMinutes"
                ],
                "group": "Severity",
                "createOtherGroup": null
              }
            },
            "name": "query - 8"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "### Closed Incident Classification (True Positive vs False Positive)\r\n\r\nThis visual shows the distribution of closed email-related incidents classified as True Positive versus False Positive. It helps assess detection accuracy and provides insight into validation trends."
                  },
                  "customWidth": "33.3",
                  "name": "text - 6 - Copy - Copy",
                  "styleSettings": {
                    "margin": "10px"
                  }
                },
                {
                  "type": 1,
                  "content": {
                    "json": "### True Positive Incident Classification Rate\r\n\r\nThis visual displays the percentage of email-related incidents confirmed as True Positive. It offers a clear measure of classification accuracy and highlights changes in detection effectiveness over time."
                  },
                  "customWidth": "33.3",
                  "name": "text - 6 - Copy - Copy - Copy",
                  "styleSettings": {
                    "margin": "10px"
                  }
                },
                {
                  "type": 1,
                  "content": {
                    "json": "### Incidents Automated vs Manual Closure\r\n\r\nThis visual illustrates the proportion of email-related incidents closed automatically versus manually. It provides visibility into operational efficiency and the impact of automation on incident resolution.\r\n<br>  *You will have to review the underlying query and add any automation system specific to your organization.*"
                  },
                  "customWidth": "33.3",
                  "name": "text - 6 - Copy - Copy - Copy - Copy",
                  "styleSettings": {
                    "margin": "10px"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "// Build a list of MDO-related incidents by cross-referencing SecurityAlert\r\nlet EmailSecurityIncidents = SecurityIncident\r\n    | mv-expand AlertIds\r\n    | where isnotempty(AlertIds)\r\n    | extend AlertId = tostring(AlertIds)\r\n    | join kind=inner (\r\n        SecurityAlert\r\n        | where ProductName in (\"Office 365 Advanced Threat Protection\", \"Microsoft 365 Defender\")\r\n        | extend AlertId = tostring(SystemAlertId)\r\n        | project AlertId\r\n    ) on AlertId\r\n    | distinct ProviderIncidentId;\r\n\r\n// Get only the most recent state of each incident, ensuring it's MDO-related\r\nlet LatestIncidents = SecurityIncident\r\n    | summarize arg_max(TimeGenerated, Classification, Status, Title) by ProviderIncidentId\r\n    | where ProviderIncidentId in (EmailSecurityIncidents)\r\n    | where not(Title startswith \"CC_\");  // Exclude incidents unrelated to MDO (e.g., DSPM)\r\n\r\nLatestIncidents\r\n| where Status == 'Closed'                                     // (Optional) Limit to closed/fully classified incidents\r\n| summarize Count = count() by Classification = iif(\r\n    isnull(Classification) or trim(\" \", Classification) == \"\",\r\n    \"Not Set\", \r\n    Classification\r\n  )\r\n| order by Count desc",
                    "size": 3,
                    "showAnalytics": true,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "piechart"
                  },
                  "customWidth": "33.3",
                  "name": "query - 4",
                  "styleSettings": {
                    "margin": "10px"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "// Identify MDO-related SecurityIncident IDs via alert correlation\r\nlet EmailSecurityIncidents = \r\n    SecurityIncident\r\n    | mv-expand AlertIds\r\n    | where isnotempty(AlertIds)\r\n    | extend AlertId = tostring(AlertIds)\r\n    | join kind=inner (\r\n        SecurityAlert\r\n        | where ProductName in (\"Office 365 Advanced Threat Protection\", \"Microsoft 365 Defender\")\r\n        | extend AlertId = tostring(SystemAlertId)\r\n        | project AlertId\r\n    ) on AlertId\r\n    | distinct ProviderIncidentId;\r\n\r\n// Get latest incident state for MDO-related incidents\r\nlet LatestMdoIncidents =\r\n    SecurityIncident\r\n    | summarize arg_max(TimeGenerated, Classification, Status, IncidentName) by ProviderIncidentId\r\n    | where ProviderIncidentId in (EmailSecurityIncidents)\r\n    // Exclude other non-email incidents (e.g., DSPM with specific naming pattern)\r\n    | where not(IncidentName startswith \"CC_\");\r\n\r\n// Compute true positive rate among closed MDO incidents\r\nLatestMdoIncidents\r\n| where Status == \"Closed\"\r\n| summarize\r\n    TruePositiveCount = countif(Classification == \"TruePositive\"),\r\n    TotalClosed       = count()\r\n| extend TruePositiveRate = iff(\r\n    TotalClosed > 0,\r\n    TruePositiveCount * 100.0 / TotalClosed,\r\n    real(null)\r\n)",
                    "size": 1,
                    "showAnalytics": true,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "stat",
                    "statSettings": {
                      "valueField": "TruePositiveRate",
                      "valueAggregation": "None",
                      "colorSettings": {
                        "type": "static",
                        "mode": "background",
                        "heatmapPalette": "greenRed",
                        "thresholdsGrid": []
                      },
                      "iconSettings": {
                        "thresholdsGrid": []
                      },
                      "numberFormatSettings": {
                        "unit": 1,
                        "options": {
                          "style": "decimal",
                          "maximumFractionDigits": 2
                        }
                      },
                      "tagText": "True Positive Rate",
                      "valueFontStyle": "xxLarge",
                      "tagTextPosition": "bottom"
                    }
                  },
                  "customWidth": "33.3",
                  "name": "query - 5",
                  "styleSettings": {
                    "margin": "10px"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "//This queries shows the last activity on the Incident and attempts to display auto resolved incidents vs manual interaction.\r\n//Add strings for your automations if you rely on any other application/system\r\n//Fewer human-closed incidents (and a higher automated closure rate) generally indicates greater SecOps efficiency, as automation is successfully handling more work.\r\n\r\n// Identify MDO-related incidents by joining SecurityIncident and SecurityAlert\r\nlet EmailSecurityIncidents = SecurityIncident\r\n    | mv-expand AlertIds\r\n    | where isnotempty(AlertIds)\r\n    | extend AlertId = tostring(AlertIds)\r\n    | join kind=inner (\r\n        SecurityAlert\r\n        | where ProductName in (\"Office 365 Advanced Threat Protection\", \"Microsoft 365 Defender\")\r\n        | extend AlertId = tostring(SystemAlertId)\r\n        | project AlertId\r\n    ) on AlertId\r\n    | distinct ProviderIncidentId;\r\n\r\n// Get latest status of each incident and count closed incidents by who closed them\r\nSecurityIncident\r\n| summarize arg_max(TimeGenerated, *) by ProviderIncidentId\r\n| where ProviderIncidentId in (EmailSecurityIncidents)\r\n| where Status == 'Closed'\r\n| where not(Title startswith \"CC_\")          // Exclude non-MDO incidents from DSPM policies\r\n| extend ClosedBy = iff(                       // Add strings for your automation systems\r\n        tolower(ModifiedBy) has_any (\"system\",\"azure\",\"automation\",\"playbook\",\"microsoft xdr\",\"microsoft defender xdr\",\"created from alert\"),\r\n        \"Automated\",\r\n        \"Human\"\r\n    )\r\n| summarize ClosedCount = count() by ClosedBy",
                    "size": 3,
                    "showAnalytics": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "piechart"
                  },
                  "customWidth": "33.3",
                  "name": "query - 1",
                  "styleSettings": {
                    "margin": "10px"
                  }
                }
              ]
            },
            "name": "Incident Insights Group"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "13"
      },
      "name": "group - 20",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<table style=\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\">\r\n<tr>\r\n<td style=\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\">Investigation & Response Actions\r\n</td>\r\n</tr>\r\n</table>\r\n\r\n**Remediation efficacy analysis.** Compares automated (AIR) and manual admin actions to evaluate response times and investigation outcomes.\r\n"
            },
            "name": "text - 1"
          },
          {
            "type": 1,
            "content": {
              "json": "### Automated Investigation and Response (AIR) Actions Daily\r\n\r\nThis visual shows the daily trend of Automated Investigation and Response (AIR) actions, including the number of successful and failed attempts (because of prior remediation)."
            },
            "customWidth": "50",
            "name": "text - 4",
            "styleSettings": {
              "margin": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Daily Automated Investigation and Response (AIR) Response Time After Email Delivery\r\n\r\nThis visual displays the daily average, 80th percentile (p80), 90th percentile (p90) and 99th percentile (p99) time needed, measured in minutes, from email delivery to AIR action. It serves as a SOC metric to monitor responsiveness (security team members reviewing and manually approving AIR Pending Actions) and identify potential latency in automated incident handling. If the latency is high focus on reviewing why reviwing AIR Pending Actions takes longer time for admins and consider <a href='https://learn.microsoft.com/en-us/defender-office-365/air-auto-remediation#configure-automated-remediation'>auto-aproval of URL, Files and Email clusters. </a>\r\n"
            },
            "customWidth": "50",
            "name": "text - 4 - Copy",
            "styleSettings": {
              "margin": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query attempts to show AIR Efficiency Over Time by displaying the number of successes and failures over time\r\nEmailPostDeliveryEvents\r\n| where ActionType =~ \"Automated Remediation\"\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| summarize Count = count() by bin(Timestamp, 1d), ActionResult",
              "size": 0,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "AlertId",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "Count",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "xAxis": "Timestamp"
              }
            },
            "customWidth": "50",
            "name": "query - 0 - Copy",
            "styleSettings": {
              "margin": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SOC metric: Daily average/p75 delay (in minutes) from email delivery to AIR action\r\nlet deliveries = EmailEvents\r\n  | where DeliveryAction == \"Delivered\"// delivered emails\r\n  | extend MsgKey = strcat(NetworkMessageId, \"-\", RecipientEmailAddress)\r\n  | summarize FirstDelivery = min(Timestamp) by MsgKey, Threat = tostring(ThreatTypes);\r\nlet remediations = EmailPostDeliveryEvents\r\n  | where ActionType =~ \"Automated Remediation\"// automated remediation events\r\n  | extend MsgKey = strcat(NetworkMessageId, \"-\", RecipientEmailAddress)\r\n  | summarize FirstRemediation = min(Timestamp) by MsgKey;\r\ndeliveries\r\n| join kind=inner remediations on MsgKey\r\n| extend DelayMinutes = datetime_diff(\"minute\", FirstRemediation, FirstDelivery)\r\n| where DelayMinutes >= 0\r\n| summarize AvgLatencyMinutes = avg(DelayMinutes),\r\n            P80LatencyMinutes = percentile(DelayMinutes, 80),\r\n            P90LatencyMinutes = percentile(DelayMinutes, 90),\r\n            P99LatencyMinutes = percentile(DelayMinutes, 99),\r\n            CountEmails = count()\r\n   by bin(FirstRemediation, 1d) ",
              "size": 0,
              "aggregation": 3,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "areachart",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "FirstRemediation",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "FirstRemediation",
                  "sortOrder": 1
                }
              ],
              "chartSettings": {
                "xAxis": "FirstRemediation",
                "yAxis": [
                  "P99LatencyMinutes",
                  "P90LatencyMinutes",
                  "P80LatencyMinutes",
                  "AvgLatencyMinutes"
                ],
                "showLegend": true
              }
            },
            "customWidth": "50",
            "name": "query - 9",
            "styleSettings": {
              "margin": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Investigation Actions Taken: Automated Investigation and Response (AIR) vs Manual (Human)\r\n\r\nThis visual shows whether actions taken after an Automated Investigation and Response (AIR) required manual approval by an administrator or were executed automatically. It provides insight into the level of automation versus human intervention in post-investigation remediation."
            },
            "customWidth": "50",
            "name": "text - 4 - Copy - Copy",
            "styleSettings": {
              "margin": "10px"
            }
          },
          {
            "type": 1,
            "content": {
              "json": "### Automated Investigation and Response (AIR) Investigation Results Trend\r\n\r\nThis visual displays the daily trend of AIR investigation outcomes, categorized as **Threat Detected** or **Clean**. It helps track the effectiveness of automated investigations over time and highlights patterns in threat detection."
            },
            "customWidth": "50",
            "name": "text - 4 - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query shows if the action taken after an Automated Investigation required manual approval by and admin or was automatically taken\r\nEmailPostDeliveryEvents\r\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \r\n| summarize arg_max(Timestamp, *) by Key\r\n| where ActionType == \"Automated Remediation\"\r\n| summarize count() by ActionTrigger",
              "size": 3,
              "showAnalytics": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 1 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AIR investigation outcomes by day: ThreatDetected vs. Clean\r\n\r\n// Step 1: Deduplicate automated remediation events by message and recipient\r\nlet AutoRemediations = \r\n    EmailPostDeliveryEvents\r\n    | where ActionType == \"Automated Remediation\"\r\n    | summarize arg_max(Timestamp, ActionResult) by NetworkMessageId, RecipientEmailAddress\r\n    | project NetworkMessageId, RecipientEmailAddress, Timestamp;\r\n\r\n// Step 2: Derive threat verdicts using AlertEvidence\r\nlet EvidenceVerdicts =\r\n    AlertEvidence\r\n    | where EntityType in (\"MailMessage\", \"MailCluster\")\r\n    | extend extra = todynamic(AdditionalFields)\r\n    // If this is a mail cluster, use provided NetworkMessageIds array; otherwise wrap NetworkMessageId as a single-item array\r\n    | extend networkIds = iff(\r\n      isnull(extra.NetworkMessageIds) or array_length(extra.NetworkMessageIds) == 0,\r\n      pack_array(NetworkMessageId),          // create a single-element array using pack_array\r\n      extra.NetworkMessageIds                // use the array as-is if it exists\r\n    )\r\n    | mv-expand nmID = networkIds                // expand to individual message IDs\r\n    // Derive verdict from LastVerdict, ThreatAnalysisSummary, and ThreatIntelligence\r\n    | extend \r\n        lastVerdict = tolower(tostring(extra.LastVerdict)),\r\n        threatAIList = extra.ThreatAnalysisSummary,\r\n        threatInt   = extra.ThreatIntelligence\r\n    | extend verdictFromAnalysis = iff(array_length(threatAIList) > 0, tolower(tostring(threatAIList[0].Verdict)), \"\"),\r\n             verdictTI          = iff(array_length(threatInt) > 0, \"malicious\", \"\")   // any item in ThreatIntelligence indicates malicious\r\n    // Mark as threat-detected if verdict is malicious/suspicious or threat evidence is present\r\n    | extend ThreatDetectedFlag = \r\n        case(\r\n            lastVerdict in (\"malicious\",\"suspicious\") or verdictFromAnalysis in (\"malicious\",\"suspicious\")\r\n                or verdictTI == \"malicious\",\r\n            true,\r\n            false\r\n        )\r\n    // Weight mail clusters by MailCount; default to 1 for single messages\r\n    | extend MailCountInt = toint(extra.MailCount)\r\n    | extend Weight = iff(EntityType == \"MailCluster\", \r\n                        coalesce(MailCountInt, 1), // default to 1 if MailCount is missing\r\n                        1)\r\n    | summarize IsThreatDetected = any(ThreatDetectedFlag), \r\n                WeightSum       = sum(Weight) \r\n    by nmID = tostring(nmID);\r\n\r\n// Step 3: Join remediation events with verdicts and aggregate by day\r\nAutoRemediations\r\n| join kind=leftouter EvidenceVerdicts on $left.NetworkMessageId == $right.nmID\r\n| extend isThreat      = coalesce(IsThreatDetected, false), \r\n         effectiveWeight= coalesce(WeightSum, 1)\r\n| extend InvestigationOutcome = iif(isThreat, \"ThreatDetected\", \"Clean\")\r\n| summarize PreventionCount = sum(effectiveWeight) by Day = bin(Timestamp, 1d), InvestigationOutcome\r\n| order by Day asc, InvestigationOutcome asc",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "50",
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "### Post-Delivery Actions by Admin\r\n\r\nThis visual displays the daily number of emails where an administrator performed a post-delivery action. Actions are summarized by type, including **Soft Delete**, **Hard Delete**, **Moved to Junk Folder**, **Moved to Inbox**, and **Quarantine Release**, providing insight into manual intervention trends after email delivery."
                  },
                  "name": "text - 8",
                  "styleSettings": {
                    "margin": "10px"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "//This query visualises the daily ammount of emails that had an admin post delivery action, summarizing the data by action type\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailPostDeliveryEvents\r\n| where ActionTrigger has \"AdminAction\";\r\nlet sdelete=baseQuery\r\n| where Action has 'Soft Delete' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Soft Delete\";\r\nlet hdelete=baseQuery\r\n| where Action has 'Hard Delete' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Hard Delete\";\r\nlet mtojunk=baseQuery\r\n| where Action has 'Moved to junk folder' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Moved to junk folder\";\r\nlet mtoinbox=baseQuery\r\n| where Action has 'Moved to inbox' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Moved to inbox\";\r\nlet qrel=baseQuery\r\n| where Action has 'Quarantine release' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Quarantine release\";\r\nunion sdelete,hdelete,mtojunk,mtoinbox,qrel\r\n| project Count, Details, Timestamp\r\n",
                    "size": 0,
                    "showAnalytics": true,
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspace}"
                    ],
                    "visualization": "linechart"
                  },
                  "name": "query - 3",
                  "styleSettings": {
                    "margin": "10px"
                  }
                }
              ]
            },
            "customWidth": "50",
            "name": "group - 15"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "13"
      },
      "name": "AIRGroup",
      "styleSettings": {
        "margin": "10px",
        "padding": "10px",
        "showBorder": true
      }
    }
  ],
  "fallbackResourceIds": [],
  "fromTemplateId": "sentinel-MicrosoftDefenderForOffice365detectionsandinsights",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
