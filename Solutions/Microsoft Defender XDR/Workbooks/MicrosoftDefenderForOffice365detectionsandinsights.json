{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# Microsoft Defender for Office 365 Detections and Insights | <img height=\"20\" src=\"https://img-prod-cms-rt-microsoft-com.akamaized.net/cms/api/am/imageFileData/RE1Mu3b\">\n\n### This workbook template will give you an example how to visualise and get insights for Microsoft Defender for Office 365. It allows you to visualise Microsoft Defender for Office 365 (MDO) data based on your organisation needs. The workbook using data from hunting tables streamed from [Microsoft Defender XDR](https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-schema-tables) using the Sentinel Connector. Keep the data as long as needed in the [Log Analytics workspace](https://learn.microsoft.com/en-us/azure/sentinel/configure-data-retention) to get insights over a long period of time based on your organisation needs.\n> \n**Please note:** *The workbook has a total of 12 tabs. If not all tabs are visible, you can access the remaining tabs using the \"...\" located at the end of the tab list on the right side.*\n> \n\n---\n\n"
      },
      "name": "text - 2"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "6e647d99-1a32-4bca-8147-403b5d37d773",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "isRequired": true,
            "value": "",
            "typeSettings": {
              "includeAll": false,
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "TimeRange"
          },
          {
            "id": "d57bcdf5-aec7-4f86-904c-67171864919b",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "isRequired": true,
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.operationalinsights/workspaces": true
              },
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "value": ""
          },
          {
            "id": "2e238f92-709c-410b-93e0-60eab6150a75",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "isRequired": true,
            "isGlobal": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "value": {
              "durationMs": 7776000000
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 1"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "3d26d949-bba8-486c-9af7-2b85bd5c8ab0",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Detection Overview",
            "subTarget": "1",
            "style": "link"
          },
          {
            "id": "a5f95467-84c1-4d8b-858c-7819339af748",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Email - Malware Detections",
            "subTarget": "2",
            "style": "link"
          },
          {
            "id": "b6c93de8-16d9-4c90-999b-837935de5645",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Email - Phish Detections",
            "subTarget": "3",
            "style": "link"
          },
          {
            "id": "df2c53b4-b6ed-4151-95fb-b3f08b849b84",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Email - Spam Detections",
            "subTarget": "4",
            "style": "link"
          },
          {
            "id": "9df30067-3266-48a8-b9e3-d65952098d46",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "URL Detections and Clicks",
            "subTarget": "5",
            "style": "link"
          },
          {
            "id": "b4be0ac3-3f48-44a8-b4b6-b46e17c710cd",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Email - Top Users/Senders",
            "subTarget": "6",
            "style": "link"
          },
          {
            "id": "e1d34091-7b3c-4e2d-a032-8be82a989313",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Email - Detection Overrides",
            "subTarget": "7",
            "style": "link"
          },
          {
            "id": "08c43a4f-f502-4813-9b8d-3f6b0b62b2fd",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "False Negative(FN) Submissions",
            "subTarget": "8",
            "style": "link"
          },
          {
            "id": "638d931f-f319-4914-b72d-8d68e914c7d4",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "False Positive(FP) Submissions",
            "subTarget": "10",
            "style": "link"
          },
          {
            "id": "ee01f95a-c5f7-4864-82e8-54a164741ba2",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "File - Malware Detections (SharePoint, Teams and OneDrive)",
            "subTarget": "9",
            "style": "link"
          },
          {
            "id": "a1e6264d-8f85-4a94-9ffd-eee36c04a0d5",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Post Delivery Detections and Admin Actions",
            "subTarget": "11",
            "style": "link"
          },
          {
            "id": "85dd7ba0-d15f-4fc4-90ac-a4ecf734fb52",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Quarantine Insights",
            "subTarget": "12",
            "style": "link"
          }
        ]
      },
      "name": "links - 14"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises Total emails by email directionality and total emails with any threat detection.\r\nlet totalinbound = EmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| summarize Count = count()\r\n| extend Details = \"Total Inbound Emails\";\r\nlet totalintraorg = EmailEvents\r\n| where EmailDirection == \"Intra-org\"\r\n| summarize Count = count()\r\n| extend Details = \"Total Intra-org Emails\";\r\nlet totaloutbound = EmailEvents\r\n| where EmailDirection == \"Outbound\"\r\n| summarize Count = count()\r\n| extend Details = \"Total Outbound Emails\";\r\nlet totalwiththreat = EmailEvents\r\n| where isnotempty(ThreatTypes) \r\n| summarize Count = count()\r\n| extend Details = \"Total Emails with Threats\";\r\nunion totalinbound, totalintraorg, totaloutbound, totalwiththreat\r\n| project Count, Details\r\n| order by Count desc",
              "size": 3,
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "NetworkMessageIds",
              "exportParameterName": "NetworkMessageIdsDomain",
              "exportDefaultValue": "[]",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "tiles",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Count",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "greenRed"
                    }
                  }
                ]
              },
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Details",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "none",
                    "compositeBarSettings": {
                      "labelText": "",
                      "columnSettings": [
                        {
                          "columnName": "Count",
                          "color": "lightBlue"
                        }
                      ]
                    }
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": true,
                "size": "full"
              },
              "chartSettings": {
                "xAxis": "Count",
                "createOtherGroup": 0
              },
              "mapSettings": {
                "locInfo": "LatLong",
                "sizeSettings": "Count",
                "sizeAggregation": "Sum",
                "legendMetric": "Count",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "type": "heatmap",
                  "colorAggregation": "Sum",
                  "nodeColorField": "Count",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "33",
            "name": "query1",
            "styleSettings": {
              "maxWidth": "33"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises Total emails by detected threat types (Malware, Phish, Spam) and total emails acted on by post-delivery detection based on new Malware, Phish, Spam ZAP signals.\r\nlet phishingcount = EmailEvents\r\n| where ThreatTypes has ('Phish')\r\n| summarize Count= count()\r\n| extend Details = \"Emails Detected as Phish\";\r\nlet malwarecount = EmailEvents\r\n| where ThreatTypes has ('Malware')\r\n| summarize Count= count()\r\n| extend Details = \"Emails Detected as Malware\";\r\nlet spamcount = EmailEvents\r\n| where ThreatTypes has ('Spam')\r\n| summarize Count= count()\r\n| extend Details = \"Emails Detected as Spam\";\r\nlet zapcount = EmailPostDeliveryEvents\r\n| where ActionResult == \"Success\"\r\n| where ActionType == \"Phish ZAP\" or ActionType == \"Malware ZAP\" or ActionType == \"Spam ZAP\"\r\n| summarize Count= count()\r\n| extend Details = \"Total Emails Removed by ZAP\";\r\nunion phishingcount, malwarecount, spamcount, zapcount\r\n| project Count, Details\r\n| order by Count desc",
              "size": 3,
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "NetworkMessageIds",
              "exportParameterName": "NetworkMessageIdsDomain",
              "exportDefaultValue": "[]",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "tiles",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Count",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "greenRed"
                    }
                  }
                ]
              },
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Details",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "none",
                    "compositeBarSettings": {
                      "labelText": "",
                      "columnSettings": [
                        {
                          "columnName": "Count",
                          "color": "lightBlue"
                        }
                      ]
                    }
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": true,
                "size": "full"
              },
              "chartSettings": {
                "xAxis": "Count",
                "createOtherGroup": 0
              },
              "mapSettings": {
                "locInfo": "LatLong",
                "sizeSettings": "Count",
                "sizeAggregation": "Sum",
                "legendMetric": "Count",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "type": "heatmap",
                  "colorAggregation": "Sum",
                  "nodeColorField": "Count",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "33",
            "name": "query1 - 2",
            "styleSettings": {
              "maxWidth": "33"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails reported by user and total emails reported by Admins as false positive or false negative detection\r\nlet usersubmissioncount = CloudAppEvents\r\n| extend Record= (parse_json(RawEventData)).RecordType\r\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState\r\n| where Record == 29 and ActionType == \"UserSubmission\"\r\n| summarize Count= count()\r\n| extend Details = \"Total Emails Reported by Users\";\r\nlet adminsubmissioncount = CloudAppEvents\r\n| extend Record= (parse_json(RawEventData)).RecordType\r\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\"\r\n| summarize Count= count()\r\n| extend Details = \"Total Emails Reported by Admins\";\r\nunion usersubmissioncount, adminsubmissioncount\r\n| project Count, Details\r\n| order by Count desc",
              "size": 3,
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "NetworkMessageIds",
              "exportParameterName": "NetworkMessageIdsDomain",
              "exportDefaultValue": "[]",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "tiles",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Count",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "greenRed"
                    }
                  }
                ]
              },
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Details",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "none",
                    "compositeBarSettings": {
                      "labelText": "",
                      "columnSettings": [
                        {
                          "columnName": "Count",
                          "color": "lightBlue"
                        }
                      ]
                    }
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": true,
                "size": "full"
              },
              "chartSettings": {
                "xAxis": "Count",
                "createOtherGroup": 0
              },
              "mapSettings": {
                "locInfo": "LatLong",
                "sizeSettings": "Count",
                "sizeAggregation": "Sum",
                "legendMetric": "Count",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "type": "heatmap",
                  "colorAggregation": "Sum",
                  "nodeColorField": "Count",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "33",
            "name": "query1 - 3",
            "styleSettings": {
              "maxWidth": "33"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails, total detections, total user, and admin email submissions over time summarizing the data daily\r\nlet baseQuery = EmailEvents\r\n| where isnotempty(Timestamp);\r\n\r\nlet timerange = baseQuery\r\n| summarize minTime = min(Timestamp), maxTime = max(Timestamp);\r\n\r\nlet totalinbound = baseQuery\r\n| where EmailDirection == \"Inbound\"\r\n| make-series Count= count() default = 0 on Timestamp from toscalar(timerange | project minTime) to toscalar(timerange | project maxTime) step 1d \r\n| extend Details = \"Total Inbound Emails\";\r\n\r\nlet totalintraorg = baseQuery\r\n| where EmailDirection == \"Intra-org\"\r\n| make-series Count= count() default = 0 on Timestamp from toscalar(timerange | project minTime) to toscalar(timerange | project maxTime) step 1d \r\n| extend Details = \"Total Intra-org Emails\";\r\n\r\nlet totaloutbound = baseQuery\r\n| where EmailDirection == \"Outbound\"\r\n| make-series Count= count() default = 0 on Timestamp from toscalar(timerange | project minTime) to toscalar(timerange | project maxTime) step 1d \r\n| extend Details = \"Total Outbound Emails\";\r\n\r\nlet totalwiththreat = baseQuery\r\n| where isnotempty(ThreatTypes) \r\n| make-series Count= count() default = 0 on Timestamp from toscalar(timerange | project minTime) to toscalar(timerange | project maxTime) step 1d \r\n| extend Details = \"Total Emails with Threat\";\r\n\r\nlet phishingcount = baseQuery\r\n| where ThreatTypes has ('Phish')\r\n| make-series Count= count() default = 0 on Timestamp from toscalar(timerange | project minTime) to toscalar(timerange | project maxTime) step 1d \r\n| extend Details = \"Emails Detected as Phish\";\r\n\r\nlet malwarecount = baseQuery\r\n| where ThreatTypes has ('Malware')\r\n| make-series Count= count() default = 0 on Timestamp from toscalar(timerange | project minTime) to toscalar(timerange | project maxTime) step 1d \r\n| extend Details = \"Emails Detected as Malware\";\r\n\r\nlet spamcount = baseQuery\r\n| where ThreatTypes has ('Spam')\r\n| make-series Count= count() default = 0 on Timestamp from toscalar(timerange | project minTime) to toscalar(timerange | project maxTime) step 1d \r\n| extend Details = \"Emails Detected as Spam\";\r\n\r\nlet usersubmissioncount = CloudAppEvents\r\n| extend Record= (parse_json(RawEventData)).RecordType\r\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState\r\n| where Record == 29 | where ActionType == \"UserSubmission\"\r\n| make-series Count= count() default = 0 on Timestamp from toscalar(timerange | project minTime) to toscalar(timerange | project maxTime) step 1d \r\n| extend Details = \"Total Emails Reported by Users\";\r\n\r\nlet adminsubmissioncount = CloudAppEvents\r\n| extend Record= (parse_json(RawEventData)).RecordType\r\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\"\r\n| make-series Count= count() default = 0 on Timestamp from toscalar(timerange | project minTime) to toscalar(timerange | project maxTime) step 1d \r\n| extend Details = \"Total Emails Reported by Admins\";\r\n\r\nlet zapcount = EmailPostDeliveryEvents\r\n| where ActionResult == \"Success\"\r\n| where ActionType == \"Phish ZAP\" or ActionType == \"Malware ZAP\" or ActionType == \"Spam ZAP\"\r\n| make-series Count= count() default = 0 on Timestamp from toscalar(timerange | project minTime) to toscalar(timerange | project maxTime) step 1d \r\n| extend Details = \"Total Emails Removed by ZAP\";\r\n\r\nunion totalinbound, phishingcount, malwarecount, spamcount, totalintraorg, totaloutbound, totalwiththreat, usersubmissioncount, zapcount, adminsubmissioncount",
              "size": 0,
              "title": "Detection trend over time",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "xAxis": "Timestamp",
                "seriesLabelSettings": [
                  {
                    "seriesName": "Total Inbound Emails",
                    "label": "Inbound Emails",
                    "color": "green"
                  },
                  {
                    "seriesName": "Total Emails with Threat",
                    "label": "Emails with Threat",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Emails Detected as Phish",
                    "label": "Emails with Phish",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "Emails Detected as Malware",
                    "label": "Emails with Malware",
                    "color": "red"
                  },
                  {
                    "seriesName": "Total Intra-org Emails",
                    "label": "Intra-org Emails",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "Emails Detected as Spam",
                    "label": "Emails with Spam",
                    "color": "gray"
                  },
                  {
                    "seriesName": "Total Outbound Emails",
                    "label": "Outbound Emails",
                    "color": "greenDarkDark"
                  },
                  {
                    "seriesName": "Total Emails Removed by ZAP",
                    "label": "Emails ZAP-d",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "Total Emails Reported by Users",
                    "label": "User Reported Emails",
                    "color": "lightBlue"
                  },
                  {
                    "seriesName": "Total Emails Reported by Admins",
                    "color": "blueDark"
                  }
                ]
              }
            },
            "customWidth": "100",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises bad traffic (% of emails with threats) compared to total inbound emails over time summarising the data daily.\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| summarize TotalEmailCount = count(),\r\n            BadEmailCount = countif(isnotempty(ThreatTypes)) by bin(Timestamp, 1d)\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(BadEmailCount / todouble(TotalEmailCount) * 100, 2))\r\n| project Timestamp,Bad_Traffic_Percentage_Inbound",
              "size": 0,
              "aggregation": 3,
              "title": "Bad traffic percentage (%) - Inbound Emails",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ],
        "exportParameters": true
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "1"
      },
      "customWidth": "100",
      "name": "Detection Overview (Dan)"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections over time summarizing the data daily.\r\nEmailEvents \r\n| where ThreatTypes has \"Malware\" \r\n| make-series MalwareDetections = count() default = 0 on Timestamp step 1d ",
              "size": 0,
              "title": "Malware Detections Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections over time summarizing the data daily by various Malware detection technologies/controls in Microsoft Defender for Office 365.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n| where DetectionMethods has \"Malware\";\r\nlet av=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Malware has 'Antimalware engine'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Antimalware engine\";\r\nlet fd=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Malware has 'File detonation' and Malware !has 'File detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"File detonation\";\r\nlet fdr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Malware has 'File detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"File detonation reputation\";\r\nlet ud=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Malware has 'URL detonation' and Malware !has 'URL detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL detonation\";\r\nlet udr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Malware has 'URL detonation reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL detonation reputation\";\r\nlet umr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Malware has 'URL malicious reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL malicious reputation\";\r\nunion av,fd,fdr,ud,udr,umr\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "Malware Detections by Detection technology",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "66",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections summarizing the data by various Malware detection technologies/controls in Microsoft Defender for Office 365.\r\nEmailEvents \r\n| where DetectionMethods has 'Malware' \r\n| project Timestamp, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) | summarize count() by Malware=tostring(column_ifexists('Malware', ''))\r\n| sort by count_ desc",
              "size": 3,
              "title": "Detection Technologies used for Malware Detections",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "xAxis": "Malware",
                "yAxis": [
                  "count_"
                ],
                "xSettings": {
                  "label": ""
                },
                "ySettings": {
                  "label": ""
                }
              }
            },
            "customWidth": "33",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections over time summarizing the data daily by Malware detection technologies/controls used for detecting unknown-unique malware.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n| where DetectionMethods has \"Malware\";\r\nlet fd=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Malware has 'File detonation' and Malware !has 'File detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"File detonation\";\r\nlet ud=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Malware has 'URL detonation' and Malware !has 'URL detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL detonation\";\r\nunion fd,ud\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "Zero Day Malware detections (URL & Attachment detonation)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "File detonation",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "URL detonation",
                    "color": "orangeDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 9",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections over time summarizing the data daily by Delivery Location\r\nEmailEvents\r\n| where DetectionMethods has \"Malware\" and EmailDirection == \"Inbound\"\r\n| make-series TotalMalwareDetections=count(),Quarantine = countif(DeliveryLocation == \"Quarantine\"), Failed=countif(DeliveryLocation == \"Failed\") default = 0 on Timestamp step 1d ",
              "size": 0,
              "title": "Malware Detections by delivery location",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalMalwareDetections",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Quarantine",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "Failed",
                    "color": "redDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 10",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections summarizing the data by email sender IP address (SenderIPv4).\r\nEmailEvents \r\n| where ThreatTypes has \"Malware\" \r\n| summarize count() by SenderIPv4\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\r\n| project SenderIPv4, Latitude, Longitude, count_\r\n\r\n",
              "size": 0,
              "title": "Malware Detections-Sender Heatmap (IPv4)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "map",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "count_",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "count_",
                  "sortOrder": 2
                }
              ],
              "mapSettings": {
                "locInfo": "LatLong",
                "locInfoColumn": "GeoInfo",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections summarizing the data by ThreatNames of the malware detected.\r\nEmailEvents \r\n| where isnotempty(ThreatNames) and ThreatTypes has \"Malware\" \r\n| summarize count() by ThreatNames \r\n| project ThreatNames,Emails=count_\r\n| sort by Emails",
              "size": 0,
              "title": "Top Malware Families",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "chartSettings": {
                "xAxis": "ThreatNames",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Malware detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain).\r\nEmailEvents | where ThreatTypes has \"Malware\" and EmailDirection == \"Inbound\" | summarize count() by SenderFromDomain | sort by count_ | top 10 by count_",
              "size": 3,
              "title": "Email Top 10 Domains sending Malware",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "SenderFromDomain",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "SenderFromDomain",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "count_",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "xAxis": "SenderFromDomain",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Malware detections summarizing the data by the top 10 recipient email address (RecipientEmailAddress).\r\nEmailEvents | where ThreatTypes has \"Malware\" and EmailDirection == \"Inbound\" | summarize count() by RecipientEmailAddress | sort by count_ | top 10 by count_",
              "size": 3,
              "title": "Email Top 10 Targeted Users (Malware)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "xAxis": "RecipientEmailAddress",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 5",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Malware detections summarizing the data by the top 15 email sender P2 domain (SenderFromDomain). Adding additional insights for total inbound emails and bad traffic percentage for each sender domain.\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| summarize TotalEmailCount = count(),\r\n            MalwareEmailCount = countif(ThreatTypes has \"Malware\") by SenderFromDomain\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(MalwareEmailCount / todouble(TotalEmailCount), 2))\r\n| where MalwareEmailCount !=0\r\n| sort by MalwareEmailCount desc \r\n| project SenderFromDomain,MalwareEmailCount,TotalEmailCount,Bad_Traffic_Percentage_Inbound\r\n| top 15 by MalwareEmailCount",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "MalwareEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "percent",
                        "useGrouping": true,
                        "minimumSignificantDigits": 3
                      }
                    }
                  },
                  {
                    "columnMatch": "BadEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": []
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 18",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Malware detections summarizing the data by the top 15 recipient email address (RecipientEmailAddress).\r\nEmailEvents\r\n| where ThreatTypes has \"Malware\" and EmailDirection == \"Inbound\"\r\n| summarize count() by RecipientEmailAddress\r\n| sort by count_\r\n| top 15 by count_\r\n| project RecipientEmailAddress,MalwareEmails=count_",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": []
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "2"
            },
            "name": "query - 18",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "2"
      },
      "name": "group - 3"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Phish Detections",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections over time summarizing the data daily.\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents\r\n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where ThreatTypes has \"Phish\"\r\n| make-series PhishDetections = count() default = 0 on Timestamp step 1d \r\n",
              "size": 0,
              "title": "Phish Detections Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections over time summarizing the data daily by various Phish Detection technologies/controls in Microsoft Defender for Office 365.\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where DetectionMethods has \"Phish\";\r\nlet ml=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Advanced filter'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Advanced filter\";\r\nlet camp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Campaign'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Campaign\";\r\nlet fd=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'File detonation' and Phish !has 'File detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"File detonation\";\r\nlet fdr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'File detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"File detonation reputation\";\r\nlet frp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Fingerprint matching' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Fingerprint matching\";\r\nlet gf=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'General filter' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"General filter\";\r\nlet bimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation brand' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation brand\";\r\nlet dimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation domain' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation domain\";\r\nlet uimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation user' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation user\";\r\nlet mimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Mailbox intelligence impersonation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Mailbox intelligence impersonation\";\r\nlet sdmarc=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof DMARC' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof DMARC\";\r\nlet spoofe=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof external domain' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof external domain\";\r\nlet spoofi=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof intra-org' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof intra-org\";\r\nlet ud=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL detonation' and Phish !has 'URL detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL detonation\";\r\nlet udr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL detonation reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL detonation reputation\";\r\nlet umr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL malicious reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL malicious reputation\";\r\nunion ml,camp,fd,fdr,frp,gf,bimp,dimp,uimp,mimp,sdmarc,spoofe,spoofi,ud,udr,umr\r\n| project Count, Details, Timestamp\r\n",
              "size": 0,
              "title": "Phish Detections by Detection technology",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "66",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 7",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections summarizing the data by various Phish detection technologies/controls in Microsoft Defender for Office 365.\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents \r\n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where ThreatTypes has 'Phish' \r\n| project Timestamp, DT=parse_json(DetectionMethods) \r\n| evaluate bag_unpack(DT) \r\n| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\r\n| sort by count_ desc",
              "size": 3,
              "title": "Detection Technologies used for Phish Detections",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "Phish",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "Detections",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "xAxis": "Phish",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 20
              }
            },
            "customWidth": "33",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections over time summarizing the data daily by Phish detection technologies/controls used for detecting unknown-unique phish.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n| where DetectionMethods has \"Phish\";\r\nlet fd=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'File detonation' and Phish !has 'File detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"File detonation\";\r\nlet ud=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL detonation' and Phish !has 'URL detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL detonation\";\r\nunion fd,ud\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "Zero Day Phish detections (URL & Attachment detonation)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "URL detonation",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "File detonation",
                    "color": "redDark"
                  }
                ]
              }
            },
            "customWidth": "100",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections over time summarizing the data daily by Delivery Location.\r\n//The comment in the query excludes deliveries to the SecOps Mailboxes and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents\r\n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where DetectionMethods has \"Phish\" and EmailDirection == \"Inbound\"\r\n| make-series TotalPhishDetections=count(),Quarantine = countif(DeliveryLocation == \"Quarantine\"),Junkfolder=countif(DeliveryLocation == \"Junk folder\") ,Inbox=countif(DeliveryLocation == \"Inbox/folder\"),Failed=countif(DeliveryLocation == \"Failed\"),Dropped=countif(DeliveryLocation == \"Dropped\") default = 0 on Timestamp step 1d ",
              "size": 0,
              "title": "Phish Detections by delivery location",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalPhishDetections",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Quarantine",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "Junkfolder",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "Inbox",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "Failed",
                    "color": "red"
                  },
                  {
                    "seriesName": "Dropped",
                    "color": "redDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 9",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections summarizing the data by email sender IP address (SenderIPv4).\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents \r\n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where ThreatTypes has \"Phish\" \r\n| summarize count() by SenderIPv4\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\r\n| project SenderIPv4, Latitude, Longitude, count_",
              "size": 0,
              "title": "Phish Detections-Sender Heatmap (IPv4)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Phish detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain).\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents \r\n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where ThreatTypes has \"Phish\" and EmailDirection == \"Inbound\"\r\n| summarize count() by SenderFromDomain\r\n| sort by count_\r\n| top 10 by count_\r\n",
              "size": 3,
              "title": "Email Top 10 Domains sending Phish",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "SenderFromDomain",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "xAxis": "SenderFromDomain",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Phish detections summarizing the data by the top 10 recipient email address (RecipientEmailAddress).\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents\r\n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where ThreatTypes has \"Phish\" and EmailDirection == \"Inbound\"\r\n| summarize count() by RecipientEmailAddress\r\n| sort by count_\r\n| top 10 by count_",
              "size": 3,
              "title": "Email Top 10 Targeted Users (Phish)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "xAxis": "RecipientEmailAddress",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish detections summarizing the data by the top 15 email sender P2 domain (SenderFromDomain). Adding additional insights for total inbound emails and bad traffic percentage for each sender domain.\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents\r\n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where EmailDirection == \"Inbound\"\r\n| summarize TotalEmailCount = count(),\r\n            PhishEmailCount = countif(ThreatTypes has \"Phish\") by SenderFromDomain\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(PhishEmailCount / todouble(TotalEmailCount) * 100, 2))\r\n| where PhishEmailCount !=0\r\n| sort by PhishEmailCount desc \r\n| project SenderFromDomain,PhishEmailCount,TotalEmailCount,Bad_Traffic_Percentage_Inbound\r\n| top 15 by PhishEmailCount\r\n",
              "size": 3,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "PhishEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "BadEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": []
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 18",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Phish detections summarizing the data by the top 15 recipient email address (RecipientEmailAddress).\r\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \"//\" to apply the exclusion.\r\nEmailEvents\r\n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\r\n| where ThreatTypes has \"Phish\" and EmailDirection == \"Inbound\"\r\n| summarize count() by RecipientEmailAddress\r\n| sort by count_\r\n| top 15 by count_\r\n| project RecipientEmailAddress,PhishEmails=count_",
              "size": 3,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "$gen_bar_Emails_1",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_bar_Emails_1",
                  "sortOrder": 2
                }
              ]
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "3"
            },
            "name": "query - 18",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "3"
      },
      "name": "group - 5",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spam detections over time summarizing the data daily.\r\nEmailEvents \r\n| where ThreatTypes has \"Spam\" \r\n| make-series Count = count() default = 0 on Timestamp step 1d \r\n| extend Details = \"SpamDetections\";",
              "size": 0,
              "title": "Spam Detection Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Emails",
                    "color": "redDark"
                  }
                ]
              }
            },
            "customWidth": "100",
            "name": "query - 13",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spam detections over time summarizing the data daily by various Spam Detection technologies/controls in Microsoft Defender for Office 365.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n| where DetectionMethods has \"Spam\";\r\nlet ml=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Advanced filter'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Advanced filter\";\r\nlet gf=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'General filter'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"General filter\";\r\nlet bl=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'BulkFilter'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"BulkFilter\";\r\nlet mx=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Mixed analysis detection'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Mixed analysis detection\";\r\nlet frp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Fingerprint matching'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Fingerprint matching\";\r\nlet umr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'URL malicious reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL malicious reputation\";\r\nlet dr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Domain reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Domain reputation\";\r\nlet ipr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'IP reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"IP reputation\";\r\nunion ml,gf,bl,mx,frp,umr,dr,ipr\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "Spam Detections by Detection technology",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "66",
            "name": "query - 7",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spam detections summarizing the data by various Spam detection technologies/controls in Microsoft Defender for Office 365.\r\nEmailEvents \r\n| where DetectionMethods has 'Spam' \r\n| project Timestamp, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) | summarize count() by Spam=tostring(column_ifexists('Spam', ''))\r\n| sort by count_",
              "size": 3,
              "title": "Detection Technologies used for Spam Detections",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "xAxis": "Spam",
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 8
              }
            },
            "customWidth": "33",
            "name": "query - 15",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spam detections over time summarizing the data daily by Delivery Location.\r\nEmailEvents\r\n| where DetectionMethods has \"Spam\" and EmailDirection == \"Inbound\"\r\n| make-series TotalSpamDetections=count(),Quarantine = countif(DeliveryLocation == \"Quarantine\"),Junkfolder=countif(DeliveryLocation == \"Junk folder\") ,Inbox=countif(DeliveryLocation == \"Inbox/folder\"),Failed=countif(DeliveryLocation == \"Failed\"),Dropped=countif(DeliveryLocation == \"Dropped\") default = 0 on Timestamp step 1d ",
              "size": 0,
              "title": "Spam Detections by delivery location",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalSpamDetections",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Quarantine",
                    "color": "greenDark"
                  },
                  {
                    "seriesName": "Junkfolder",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "Inbox",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "Failed",
                    "color": "red"
                  },
                  {
                    "seriesName": "Dropped",
                    "color": "redDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spam detections summarizing the data by email sender IP address (SenderIPv4).\r\nEmailEvents \r\n| where ThreatTypes has \"Spam\" \r\n| summarize count() by SenderIPv4\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\r\n| project SenderIPv4, Latitude, Longitude, count_  ",
              "size": 0,
              "title": "Spam Detections-Sender Heatmap (IPv4)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "locInfoColumn": "SenderIPv4",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "name": "query - 14",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails which has any Bulk complaint level. It is summarizing the data by the various Bulk Complaint levels to understand how many messages are detected with each Bulk Complaint level.\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\" and BulkComplaintLevel !=\"\"\r\n| summarize count() by BulkComplaintLevel\r\n| sort by BulkComplaintLevel desc\r\n| project BulkComplaintLevel,Emails=count_",
              "size": 0,
              "title": "Bulk Emails (grey mail) by Sender Bulk Complaint level",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 9",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails which has any Bulk complaint level. It is summarizing the data by the various Bulk Complaint levels and SenderFromDomain of the email sender. It provides insights how many messages are detected with each Bulk Complaint level for each sender domain.\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\" and BulkComplaintLevel !=\"\"\r\n| summarize count() by BulkComplaintLevel, SenderFromDomain\r\n| sort by count_ desc\r\n| project SenderFromDomain,BulkComplaintLevel,Emails=count_\r\n| take 10",
              "size": 0,
              "title": "Top 10 domains sending Bulk email (grey mail)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 10",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Spam detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain).\r\nEmailEvents \r\n| where ThreatTypes has \"Spam\" and EmailDirection ==\"Inbound\"\r\n| summarize count() by SenderFromDomain\r\n| sort by count_ desc \r\n| take 10",
              "size": 3,
              "title": "Email Top 10 Domains sending Spam",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "group": "SenderFromDomain",
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 17",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Spam detections summarizing the data by the top 10 recipient email address (RecipientEmailAddress).\r\nEmailEvents \r\n| where ThreatTypes has \"Spam\" and EmailDirection ==\"Inbound\" \r\n| summarize count() by RecipientEmailAddress \r\n| sort by count_ desc\r\n| take 10",
              "size": 3,
              "title": "Email Top 10 Targeted Users (Spam)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "group": "RecipientEmailAddress",
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 17 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Spam detections summarizing the data by the top 15 email sender P2 domain (SenderFromDomain). Adding additional insights for total inbound emails and bad traffic percentage for each sender domain.\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| summarize TotalEmailCount = count(),\r\n            SpamEmailCount = countif(ThreatTypes has \"Spam\") by SenderFromDomain\r\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(SpamEmailCount / todouble(TotalEmailCount) * 100, 2))\r\n| where SpamEmailCount !=0\r\n| sort by SpamEmailCount desc \r\n| project SenderFromDomain,SpamEmailCount,TotalEmailCount,Bad_Traffic_Percentage_Inbound\r\n| top 15 by SpamEmailCount",
              "size": 3,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SpamEmailCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Bad_Traffic_Percentage_Inbound",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "sortBy": []
            },
            "customWidth": "50",
            "name": "query - 18",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total inbound emails with Spam detections summarizing the data by the top 15 recipient email address (RecipientEmailAddress).\r\nEmailEvents | where ThreatTypes has \"Spam\" and EmailDirection ==\"Inbound\" | summarize count() by RecipientEmailAddress| sort by count_ desc| take 15\r\n| project RecipientEmailAddress,Emails=count_",
              "size": 3,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "count_",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "blue"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "$gen_bar_Emails_1",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_bar_Emails_1",
                  "sortOrder": 2
                }
              ]
            },
            "customWidth": "50",
            "name": "query - 18 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "4"
      },
      "name": "group - 6"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Phish Detections - Business Email Compromise (BEC)",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Impersonation detections over time summarizing the data daily.\r\nEmailEvents \r\n| where DetectionMethods has 'Impersonation' \r\n| make-series Count = count() default = 0 on Timestamp step 1d \r\n| extend Details = \"ImpersonatedEmails\";",
              "size": 0,
              "title": "Impersonation Detections Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "50",
            "name": "query - 5",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Impersonation detections over time summarizing the data daily by various Impersonation Detection technologies/controls in Microsoft Defender for Office 365.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n| where DetectionMethods has \"Phish\";\r\nlet bimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation brand' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation brand\";\r\nlet dimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation domain' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation domain\";\r\nlet uimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation user' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation user\";\r\nlet mimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Mailbox intelligence impersonation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Mailbox intelligence impersonation\";\r\nunion bimp,dimp,uimp,mimp\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "Impersonation Detections by Detection technology",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "50",
            "name": "query - 7",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Impersonation detections summarizing the data by various Impersonation detection technologies/controls in Microsoft Defender for Office 365.\r\nEmailEvents \r\n| where DetectionMethods has 'Impersonation' \r\n| project Timestamp, DT=parse_json(DetectionMethods) \r\n| evaluate bag_unpack(DT) \r\n| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\r\n| sort by count_ desc\r\n",
              "size": 3,
              "title": "Detection Technologies used for Impersonation Detections",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false
              },
              "graphSettings": {
                "type": 0
              }
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Impersonation detections summarizing the data by email sender IP address (SenderIPv4).\r\nEmailEvents\r\n| where DetectionMethods contains 'Impersonation'\r\n//| project Timestamp, EmailDirection, SenderFromAddress, AdditionalFields, SenderIPv4 \r\n| summarize count()by SenderIPv4\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\r\n| project SenderIPv4, Latitude, Longitude, count_  ",
              "size": 0,
              "title": "Impersonation Detections-Sender Heatmap (IPv4)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "name": "query - 6",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Spoof detections over time summarizing the data daily.\r\nEmailEvents \r\n| where DetectionMethods has 'Spoof' \r\n| make-series Count = count() default = 0 on Timestamp step 1d \r\n| extend Details = \"SpoofEmails\";",
              "size": 0,
              "title": "Spoof Detections Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "50",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Spoof detections over time summarizing the data daily by various Spoof Detection technologies/controls in Microsoft Defender for Office 365.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n| where DetectionMethods has \"Phish\";\r\nlet sdmarc=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof DMARC' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof DMARC\";\r\nlet spoofe=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof external domain' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof external domain\";\r\nlet spoofi=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof intra-org' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof intra-org\";\r\nunion sdmarc, spoofe, spoofi\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "Spoof Detections by Detection technology",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "yAxis": [
                  "Count"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "[\"Spoof external domain\"]",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "[\"Spoof intra-org\"]",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "[\"Spoof DMARC\"]",
                    "color": "yellowDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 20",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Spoof detections detections summarizing the data by various Spoof detection technologies/controls in Microsoft Defender for Office 365.\r\nEmailEvents \r\n| where DetectionMethods has 'Spoof' \r\n| project Timestamp, DT=parse_json(DetectionMethods) \r\n| evaluate bag_unpack(DT) \r\n| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\r\n| sort by count_ desc",
              "size": 3,
              "title": "Detection Technologies used for Spoof Detections",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "xAxis": "Phish",
                "yAxis": [
                  "count_"
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish  Business Email Compromise (BEC)  Spoof detections summarizing the data by email sender IP address (SenderIPv4).\r\nEmailEvents\r\n| where DetectionMethods contains 'spoof'\r\n//| project Timestamp, EmailDirection, SenderFromAddress, AdditionalFields, SenderIPv4 \r\n| summarize count()by SenderIPv4\r\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\r\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\r\n| project SenderIPv4, Latitude, Longitude, count_  ",
              "size": 0,
              "title": "Spoof Detections-Sender Heatmap (IPv4)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "SenderIPv4",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "customWidth": "50",
            "name": "query - 3",
            "styleSettings": {
              "margin": "15px",
              "padding": "15px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises top outbound recipient domains by outbound email volume and shows total number of inbound emails with Threats from the same domains (as inbound senders) \r\nEmailEvents\r\n| where EmailDirection == \"Outbound\"\r\n| project RecipientDomain = tostring(split(RecipientEmailAddress, \"@\")[1])\r\n| summarize count() by RecipientDomain\r\n| project OutboundCount=count_, RecipientDomain, SenderFromDomain=RecipientDomain\r\n| join (EmailEvents | where EmailDirection == \"Inbound\" and isempty(ThreatTypes)==false) on SenderFromDomain\r\n| summarize max(OutboundCount),count() by SenderFromDomain\r\n| project SenderFromDomain, OutboundEmails=max_OutboundCount, IncomingEmailsWithThreats=count_\r\n| sort by OutboundEmails",
              "size": 0,
              "title": "Top Domains Outbound with  Emails with Threats Inbound (Partner BEC)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "OutboundEmails",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "IncomingEmailsWithThreats",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "60ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 8"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "3"
      },
      "name": "group - 7",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Phish Detections- Sender Authentication",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spoof- Composite Authentication fails summarizing the data daily.\r\nEmailEvents\r\n| extend CompAuthFail = AuthenticationDetails has_any ('CompAuth\":\"fail') \r\n| summarize CompAuthFail = sum(CompAuthFail) by bin (Timestamp,1d)",
              "size": 0,
              "title": "CompAuth Fail Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "CompAuthFail",
                    "color": "blueDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 21",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spoof- DMARC fails summarizing the data daily.\r\nEmailEvents\r\n| extend DMARCFail = AuthenticationDetails has_any ('DMARC\":\"fail') \r\n| summarize DMARCFail = sum(DMARCFail) by bin (Timestamp,1d)",
              "size": 0,
              "title": "DMARC Fail Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "DMARCFail",
                    "color": "orangeDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 22",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spoof- SPF fails summarizing the data daily.\r\nEmailEvents\r\n| extend SPFFail = AuthenticationDetails has_any ('SPF\":\"fail') \r\n| summarize SPFFail = sum(SPFFail) by bin (Timestamp,1d)",
              "size": 0,
              "title": "SPF Fail Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "SPFFail",
                    "color": "purpleDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 23",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spoof- DKIM fails summarizing the data daily.\r\nEmailEvents\r\n| extend DKIMFail = AuthenticationDetails has_any ('DKIM\":\"fail') \r\n| summarize DKIMCFail = sum(DKIMFail) by bin (Timestamp,1d)",
              "size": 0,
              "title": "DKIM Fail Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "DKIMCFail",
                    "color": "yellowDark"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 24",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Spoof-DMARC fails detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain) and sender P1 domain (SenderMailFromDomain). Adding additional insights for total inbound emails and DMARC fail traffic percentage for each sender domain.\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| summarize TotalEmailCount = count(),\r\n            DMARCFailCount = countif(DetectionMethods has_any ('Phish\":[\"Spoof DMARC\"]')) by P1Sender=SenderMailFromDomain, P2Sender=SenderFromDomain\r\n| extend DMARCFail_Traffic_Percentage = todouble(round(DMARCFailCount / todouble(TotalEmailCount) * 100, 2))\r\n| where DMARCFailCount !=0\r\n| sort by DMARCFailCount desc \r\n| project P1Sender,P2Sender,DMARCFailCount,TotalEmailCount,DMARCFail_Traffic_Percentage\r\n| top 10 by DMARCFailCount",
              "size": 3,
              "title": "Top 10 Spoof DMARC detections by Sender domain (P1/P2)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "DMARCFail",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "DMARCFail_Traffic_Percentage",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 26",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish-Spoof-external domain detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain) and sender P1 domain (SenderMailFromDomain). Adding additional insights for total inbound emails and Spoof external domain detection traffic percentage for each sender domain.\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| summarize TotalEmailCount = count(),\r\n            SpoofExternalCount = countif(DetectionMethods has_any ('Phish\":[\"Spoof external domain\"]')) by P1Sender=SenderMailFromDomain, P2Sender=SenderFromDomain\r\n| extend SpoofExternal_Traffic_Percentage = todouble(round(SpoofExternalCount / todouble(TotalEmailCount) * 100, 2))\r\n| where SpoofExternalCount !=0\r\n| sort by SpoofExternalCount desc \r\n| project P1Sender,P2Sender,SpoofExternalCount,TotalEmailCount,SpoofExternal_Traffic_Percentage\r\n| top 10 by SpoofExternalCount",
              "size": 3,
              "title": "Top 10 Spoof external domain detections by Sender domain (P1/P2)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SpoofExternalCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "SpoofExternal_Traffic_Percentage",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "SpoofExternalFail",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 26 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total emails with Phish-Spoof-internal domain detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain) and sender P1 domain (SenderMailFromDomain). Adding additional insights for total inbound emails and Spoof internal domain detection traffic percentage for each sender domain.\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| summarize TotalEmailCount = count(),\r\n            SpoofInternalCount = countif(DetectionMethods has_any ('Phish\":[\"Spoof intra-org\"]')) by P1Sender=SenderMailFromDomain, P2Sender=SenderFromDomain\r\n| extend SpoofInternal_Traffic_Percentage = todouble(round(SpoofInternalCount / todouble(TotalEmailCount) * 100, 2))\r\n| where SpoofInternalCount !=0\r\n| sort by SpoofInternalCount desc \r\n| project P1Sender,P2Sender,SpoofInternalCount,TotalEmailCount,SpoofInternal_Traffic_Percentage\r\n| top 10 by SpoofInternalCount",
              "size": 3,
              "title": "Top 10 Spoof intra-org detections by Sender domain (P1/P2)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SpoofInternalCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalEmailCount",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "SpoofInternal_Traffic_Percentage",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "SpoofIntraorgFail",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 26 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "3"
      },
      "name": "group - 8",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises where URL's have been identified in emails\r\nEmailUrlInfo\r\n| summarize  count() by UrlLocation, bin (Timestamp,1d)",
              "size": 3,
              "title": "URLs by location",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 5",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\n\r\nlet baseQuery = EmailEvents\r\n| where EmailDirection == \"Inbound\" \r\n| where DetectionMethods has \"Url\"\r\n| join EmailUrlInfo on NetworkMessageId\r\n| where UrlLocation == \"QRCode\";\r\n\r\nlet qrphishh = baseQuery\r\n| where parse_json(DetectionMethods).Phish has \"URL\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"Phish QR Detection\";\r\n\r\nlet qrmalww = baseQuery\r\n| where parse_json(DetectionMethods).Malware has \"URL\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Malware QR Detection\";\r\n\r\nlet qrspamm = baseQuery\r\n| where parse_json(DetectionMethods).Spam has \"URL\"\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spam QR Detection\";\r\n\r\nunion qrphishh, qrmalww, qrspamm\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "Malicious Emails with QR code Urls",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "graphSettings": {
                "type": 0
              },
              "chartSettings": {
                "xAxis": "Timestamp",
                "xSettings": {
                  "dateFormatSettings": {
                    "formatName": "shortDatePattern",
                    "showUtcTime": false
                  }
                }
              }
            },
            "customWidth": "50",
            "name": "query - 6",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Generates a time-series analysis for blocked URL click events from the 'UrlClickEvents' table\r\n\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\n\r\nlet baseQuery = UrlClickEvents\r\n| where isnotempty(ActionType);\r\n\r\nlet Blocked = baseQuery\r\n| where ActionType has_any(\"ClickBlocked\")\r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"ClickBlocked\";\r\n\r\nBlocked",
              "size": 0,
              "title": "Blocked Clicks Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "xAxis": "Timestamp"
              }
            },
            "customWidth": "50",
            "name": "query - 4",
            "styleSettings": {
              "margin": "15px",
              "padding": "15px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises different URL click event types by action (e.g., blocked, allowed, pending verdict, error pages, and clicked through), summarizing the data daily\r\n\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\n\r\nlet baseQuery = UrlClickEvents\r\n| where isnotempty(ActionType);\r\n\r\nlet Blocked = baseQuery\r\n| where ActionType has_any(\"ClickBlocked\")\r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"ClickBlocked\";\r\n\r\nlet Allowed = baseQuery\r\n| where ActionType has_any(\"ClickAllowed\")\r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"ClickAllowed\";\r\n\r\nlet PendingVerdict = baseQuery\r\n| where ActionType has_any(\"UrlScanInProgress\")\r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"PendingVerdict\";\r\n\r\nlet ErrorPage = baseQuery\r\n| where ActionType has_any(\"UrlErrorPage\")\r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"ErrorPage\";\r\n\r\nlet ClickedThrough = baseQuery\r\n| where IsClickedThrough == true\r\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\r\n| extend Details = \"ClickedThrough\";\r\n\r\nunion Blocked, Allowed, PendingVerdict, ErrorPage, ClickedThrough",
              "size": 0,
              "title": "URL Clicks by Action",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "xAxis": "Timestamp"
              }
            },
            "customWidth": "50",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of click-through activities on URL's with detections split by the source client\r\nUrlClickEvents \r\n| where ActionType == \"ClickAllowed\" or IsClickedThrough !=\"0\"\r\n| where isnotempty(ThreatTypes) \r\n| summarize count() by Workload",
              "size": 3,
              "title": "Malicious Clicks allowed (click-through)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of click attempts on URL's with detections split by the source client\r\nUrlClickEvents \r\n| where isnotempty(ThreatTypes) \r\n| summarize count() by Workload, bin(Timestamp, 1d)",
              "size": 3,
              "title": "Malicious URL Clicks by workload",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of click attempts on URL's with detections split by the different threat types identified\r\nUrlClickEvents\r\n| where isnotempty(ThreatTypes)\r\n| summarize count() by ThreatTypes,bin(Timestamp, 1d)",
              "size": 3,
              "title": "URL Click attempts by threat type",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 users with click attempts on URL's with malware detections\r\nUrlClickEvents\r\n| where ThreatTypes == \"Malware\"\r\n| summarize count() by AccountUpn\r\n| top 10 by count_",
              "size": 3,
              "title": "Top 10 Users clicking on Malicious URLs (Malware)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 4 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 users with click attempts on URL's with phishing detections\r\nUrlClickEvents\r\n| where ThreatTypes == \"Phish\"\r\n| summarize count() by AccountUpn\r\n| top 10 by count_",
              "size": 3,
              "title": "Top 10 Users clicking on Malicious URLs (Phish)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 4 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 users with click attempts on URL's with spam detections\r\nUrlClickEvents\r\n| where ThreatTypes == \"Spam\"\r\n| summarize count() by AccountUpn\r\n| top 10 by count_",
              "size": 3,
              "title": "Top 10 Users clicking on Malicious URLs (Spam)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 4 - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query shows the top 20 URL's that have a detection associated with the most ammount of clicks registered \r\nUrlClickEvents\r\n| where ThreatTypes !=\"\"\r\n| summarize count() by Url, ThreatTypes, ActionType, Workload\r\n| project Url, ThreatTypes, ActionType, Workload, ClickCount=count_\r\n| top 20 by ClickCount",
              "size": 3,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "ClickCount",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "50ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "name": "query - 10"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "5"
      },
      "name": "group - 9"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 users that are receiving Spam, Phishing or Malware emails\r\nEmailEvents \r\n| where (ThreatTypes has \"Malware\" or ThreatTypes has \"Phish\" or ThreatTypes has \"Spam\") and EmailDirection == \"Inbound\"\r\n| summarize count() by RecipientEmailAddress | sort by count_  | take 10",
              "size": 3,
              "title": "Top 10 Targeted Users (Malware+Phish+Spam)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "RecipientEmailAddress",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "RecipientEmailAddress",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "count_",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 27",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 users that are clicking on URL's in emails classified as Spam, Phishing or Malware\r\nUrlClickEvents\r\n| where ThreatTypes has \"Malware\" or ThreatTypes has \"Phish\" or ThreatTypes has \"Spam\"\r\n| summarize count() by AccountUpn \r\n| sort by count_ desc\r\n| take 10",
              "size": 3,
              "title": "Top 10 Users clicking on Malicious URLs (Malware+Phish+Spam)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 28",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 domains that are used in sending Spam, Phishing and Malware\r\nEmailEvents \r\n| where isnotempty(ThreatTypes) and EmailDirection == \"Inbound\"\r\n| summarize count() by SenderFromDomain\r\n| sort by count_ desc  \r\n| take 10",
              "size": 3,
              "title": "Top 10 Domains sending Malicious Emails (Malware+Phish+Spam)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 29",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 internet senders of emails\r\nEmailEvents \r\n| where EmailDirection == \"Inbound\" \r\n| summarize count() by SenderFromAddress \r\n| sort by count_ desc \r\n| take 10",
              "size": 3,
              "title": "Top 10 External Senders",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 30",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 internet senders used to send Malware detected emails\r\nEmailEvents \r\n| where EmailDirection == \"Inbound\" and ThreatTypes has \"Malware\"\r\n| summarize count() by SenderFromAddress \r\n| sort by count_ desc \r\n| take 10",
              "size": 3,
              "title": "Top 10 External Senders (Malware)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 30 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 internet senders used to send Phishing detected emails\r\nEmailEvents \r\n| where EmailDirection == \"Inbound\" and ThreatTypes has \"Phish\"\r\n| summarize count() by SenderFromAddress \r\n| sort by count_ desc \r\n| take 10",
              "size": 3,
              "title": "Top 10 External Senders (Phish)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 30 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// This query visualises the top 10 internet senders used to send Spam detected emails\r\nEmailEvents \r\n| where EmailDirection == \"Inbound\" and ThreatTypes has \"Spam\"\r\n| summarize count() by SenderFromAddress \r\n| sort by count_ desc \r\n| take 10",
              "size": 3,
              "title": "Top 10 External Senders (Spam)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "count_"
                ],
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 30 - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "6"
      },
      "name": "group - 10"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "User overrides",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to a user type policy with action of allow, summarizing the data daily\r\nEmailEvents\r\n| where UserLevelPolicy!=\"\"\"\" and UserLevelAction == \"Allow\"\r\n| make-series TotalUserOverrides = count() default = 0 on Timestamp step 1d",
              "size": 0,
              "title": "User Overrides (Allow)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of emails subject to a user type policy with action of allow, summarizing the data by type of override\r\nEmailEvents \r\n| where UserLevelPolicy!=\"\"\"\" and UserLevelAction == \"Allow\" \r\n| summarize count() by UserLevelPolicy",
              "size": 3,
              "title": "Total Emails by User Override type (Allow)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 16",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to a user type policy with action of allow, summarizing the data by type of override and threats type found\r\nEmailEvents \r\n| where UserLevelPolicy!=\"\"\"\" and UserLevelAction == \"Allow\" \r\n| summarize Emails=count() by UserLevelAction,UserLevelPolicy,ThreatTypes\r\n| sort by Emails",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "sortBy": []
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to a user type policy with action of block, summarizing the data daily\r\nEmailEvents\r\n| where UserLevelPolicy!=\"\"\"\" and UserLevelAction == \"Block\"\r\n| make-series TotalUserOverrides = count() default = 0 on Timestamp step 1d",
              "size": 0,
              "title": "User Overrides (Block)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "name": "query - 5",
            "styleSettings": {
              "margin": "10",
              "padding": "10"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of emails subject to a user type policy with action of block, summarizing the data by type of override\r\nEmailEvents \r\n| where UserLevelPolicy!=\"\"\"\" and UserLevelAction == \"Block\" \r\n| summarize count() by UserLevelPolicy",
              "size": 3,
              "title": "Total Emails by User Override type (Block)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 6",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to a user type policy with action of block, summarizing the data by type of override and threats type found\r\nEmailEvents \r\n| where UserLevelPolicy!=\"\"\"\" and UserLevelAction == \"Block\" \r\n| summarize Emails=count() by UserLevelAction,UserLevelPolicy,ThreatTypes\r\n| sort by Emails",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "customWidth": "50",
            "name": "query - 7",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "7"
      },
      "name": "group - 15 - Copy",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Admin overrides",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to an admin policy with action of allow independent of action taken, summarizing the data daily\r\nEmailEvents\r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelPolicy!=\"SecOps Mailbox\" and OrgLevelAction == \"Allow\"\r\n| make-series TotalAdminOverrides = count() default = 0 on Timestamp step 1d",
              "size": 0,
              "title": "Admin Overrides (Allow)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of emails subject to an admin policy with action of allow, independent of action taken, summarizing the data by type of override\r\nEmailEvents \r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelPolicy!=\"SecOps Mailbox\" and OrgLevelAction == \"Allow\" \r\n| summarize count() by OrgLevelPolicy",
              "size": 3,
              "title": "Total Emails by Admin Override type (Allow)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 16",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to an admin policy with action of allow, independent of action taken, summarizing the data by type of override and threats type found\r\nEmailEvents \r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelPolicy!=\"SecOps Mailbox\" and OrgLevelAction == \"Allow\" \r\n| summarize Emails=count() by OrgLevelAction,OrgLevelPolicy,ThreatTypes\r\n| sort by Emails",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of emails subject to the \r\nEmailEvents \r\n| where OrgLevelPolicy==\"SecOps Mailbox\" and OrgLevelAction == \"Allow\" \r\n| summarize count() by OrgLevelPolicy",
              "size": 4,
              "title": "Total Emails with SecOps Mailbox override (Allow)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "stat",
              "statSettings": {
                "valueAggregation": "None",
                "colorSettings": {
                  "type": "static",
                  "mode": "background",
                  "heatmapPalette": "greenRed",
                  "thresholdsGrid": []
                },
                "iconSettings": {
                  "thresholdsGrid": []
                },
                "tagText": "",
                "valueFontStyle": "auto"
              }
            },
            "customWidth": "50",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10",
              "padding": "10"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails delivered to the SecOps Mailbox by threat type\r\nEmailEvents \r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelPolicy==\"SecOps Mailbox\" and OrgLevelAction == \"Allow\" \r\n| summarize Emails=count() by OrgLevelAction,OrgLevelPolicy,ThreatTypes\r\n| sort by Emails",
              "size": 4,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "customWidth": "50",
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to an admin policy with action of block, summarizing the data daily\r\nEmailEvents\r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelAction == \"Block\"\r\n| make-series TotalAdminOverrides = count() default = 0 on Timestamp step 1d",
              "size": 0,
              "title": "Admin Overrides (Block)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "name": "query - 5",
            "styleSettings": {
              "margin": "10",
              "padding": "10"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of emails subject to an admin policy with action of block, summarizing the data by type of override\r\nEmailEvents \r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelAction == \"Block\" \r\n| summarize count() by OrgLevelPolicy",
              "size": 3,
              "title": "Total Emails by Admin Override type (Block)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 6",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails subject to an admin policy with action of block, summarizing the data by type of override and threats type found\r\nEmailEvents \r\n| where OrgLevelPolicy!=\"\"\"\" and OrgLevelAction == \"Block\" \r\n| summarize Emails=count() by OrgLevelAction,OrgLevelPolicy,ThreatTypes\r\n| sort by Emails",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "customWidth": "50",
            "name": "query - 7",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "7"
      },
      "name": "group - 15",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "False negative (FN) Admin Submissions ",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of admin false negative submission by submission type.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = CloudAppEvents\r\n| where ActionType contains \"Submission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType);\r\nlet Admin_Malware_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Malware_FN\";\r\nlet Admin_Phish_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Phish_FN\";\r\nlet Admin_Spam_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"0\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Spam_FN\";\r\nlet Admin_Malware_URL_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Malware_URL_FN\";\r\nlet Admin_Malware_Attach_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Malware_Attach_FN\";\r\nlet Admin_Phish_URL_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Phish_URL_FN\";\r\nlet Admin_Phish_Attach_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Phish_Attach_FN\";\r\nunion Admin_Malware_FN,Admin_Phish_FN,Admin_Spam_FN,Admin_Malware_URL_FN,Admin_Malware_Attach_FN,Admin_Phish_URL_FN,Admin_Phish_Attach_FN\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "Admin Submission Trend (FN)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalAdminSubmissions",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Admin_Phish_FN",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "Admin_Spam_FN",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Admin_Malware_FN",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Admin_Phish_URL_FN",
                    "color": "purple"
                  },
                  {
                    "seriesName": "Admin_Malware_Attach_FN",
                    "color": "yellowDark"
                  },
                  {
                    "seriesName": "Admin_Phish_Attach_FN",
                    "color": "purpleDark"
                  },
                  {
                    "seriesName": "Admin_Malware_URL_FN",
                    "color": "yellow"
                  }
                ]
              }
            },
            "customWidth": "66",
            "name": "query - 4 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of admin false negative submission by submission type.\r\nCloudAppEvents \r\n| where ActionType contains \"Submission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| extend Admin_SubmissionType=\r\niff(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Malware_FN\",\r\niff(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Spam_FN\",\r\niff(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\",\"Admin_Malware_URL_FN\",\r\niff(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\",\"Admin_Malware_Attach_FN\",\r\niff(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\",\"Admin_Phish_URL_FN\",\r\niff(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\",\"Admin_Phish_Attach_FN\",\r\n\"Other\")))))))\r\n| where Admin_SubmissionType!=\"Other\"\r\n| summarize count() by Admin_SubmissionType",
              "size": 0,
              "title": "Admin Submissions (FN) by Submission Type",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of admin false negative submissions by the state of the submission.\r\nCloudAppEvents \r\n| where ActionType contains \"AdminSubmission\" \r\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and SubmissionType in (\"0\",\"1\",\"2\")\r\n| summarize count() by tostring(SubmissionState)",
              "size": 0,
              "title": "Admin Submissions (FN) by Submission State",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of admin false negative or false positive submissions by the verdict of the submission grading.\r\nCloudAppEvents \r\n| where ActionType contains \"AdminSubmissionTriage\" \r\n| extend UserKey = (parse_json(RawEventData)).UserKey, SubmissionState = (parse_json(RawEventData)).SubmissionState,  SubmissionId=(parse_json(RawEventData)).SubmissionId, TriageVerdict=(parse_json(RawEventData)).GradingResult.TriageVerdict \r\n| summarize count() by tostring(TriageVerdict)",
              "size": 0,
              "title": "Admin Submissions (FN-FP) by Grading verdict",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - 0 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top admins performing false negative submissions\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend Record= (parse_json(RawEventData)).RecordType,SubmissionState = (parse_json(RawEventData)).SubmissionState, UserId = (parse_json(RawEventData)).UserId,SubmissionType = parse_json(RawEventData).SubmissionType  \r\n| where Record == 29 and SubmissionType in (\"0\",\"1\",\"2\")\r\n| summarize count() by tostring(UserId) | sort by count_\r\n| top 15 by count_",
              "size": 0,
              "title": "Top Submitters - Admin Submissions (FN)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "33",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises emails submitted by admins as false negatives, summarizing the data by top 10 sender domains of those emails\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"2\",\"1\",\"0\")\r\n| summarize count() by P2SenderDomain\r\n| project P2SenderDomain, Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "title": "Admin Email Submissions (FN)- Top 10 Senders domains",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises emails submitted as false negatives by admins where emails where already detected by MDO but there was a admin policy override\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| extend Admin_SubmissionType=\r\niff(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Malware_FN\",\r\niff(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Spam_FN\",\"Other\"))),\r\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"2\",\"1\",\"0\") and PolicyOverride !=\"NoOverride\"\r\n| summarize count() by PolicyOverride, PolicyPolicyOverrideType,DetectionVerdict,Admin_SubmissionType\r\n| project PolicyOverride, PolicyPolicyOverrideType,DetectionVerdict,Admin_SubmissionType, Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "title": "Admin Email Submissions (FN)- Top 10 Detection Overrides",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "8"
      },
      "name": "group - 11",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "False negative (FP) Admin Submissions ",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of admin false positive submission by submission type.\r\nlet minTime = toscalar(CloudAppEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(CloudAppEvents | summarize max(Timestamp));\r\nlet baseQuery = CloudAppEvents\r\n| where ActionType contains \"Submission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType);\r\nlet Admin_Email_FP=baseQuery\r\n| make-series Count= countif(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Email_FP\";\r\nlet Admin_URL_FP=baseQuery\r\n| make-series Count= countif(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_URL_FP\";\r\nlet Admin_Attach_FP=baseQuery\r\n| make-series Count= countif(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\") default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Admin_Attach_FP\";\r\nunion Admin_Email_FP,Admin_URL_FP,Admin_Attach_FP\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "Admin Submission Trend (FP)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalAdminSubmissions",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Admin_Phish_FN",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "Admin_Spam_FN",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Admin_Malware_FN",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Admin_Phish_URL_FN",
                    "color": "purple"
                  },
                  {
                    "seriesName": "Admin_Malware_Attach_FN",
                    "color": "yellowDark"
                  },
                  {
                    "seriesName": "Admin_Phish_Attach_FN",
                    "color": "purpleDark"
                  },
                  {
                    "seriesName": "Admin_Malware_URL_FN",
                    "color": "yellow"
                  },
                  {
                    "seriesName": "Admin_Email_FP",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "Admin_URL_FP",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "Admin_Attach_FP",
                    "color": "yellow"
                  }
                ]
              }
            },
            "customWidth": "66",
            "name": "query - 4 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of admin false positive submission by submission type.\r\nCloudAppEvents \r\n| where ActionType contains \"Submission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| extend Admin_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Email_FP\",\r\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\",\"Admin_URL_FP\",\r\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\",\"Admin_Attach_FP\",\r\n\"Other\")))\r\n| where Admin_SubmissionType!=\"Other\"\r\n| summarize count() by Admin_SubmissionType",
              "size": 0,
              "title": "Admin Submissions (FP) by Submission Type",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of admin false positive submissions by the state of the submission.\r\nCloudAppEvents \r\n| where ActionType contains \"AdminSubmission\" \r\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and SubmissionType == \"3\"\r\n| summarize count() by tostring(SubmissionState)",
              "size": 0,
              "title": "Admin Submissions (FP) by Submission State",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top admins performing false positive submissions.\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend Record= (parse_json(RawEventData)).RecordType,SubmissionState = (parse_json(RawEventData)).SubmissionState, UserId = (parse_json(RawEventData)).UserId,SubmissionType = parse_json(RawEventData).SubmissionType  \r\n| where Record == 29 and SubmissionType ==\"3\"\r\n| summarize count() by tostring(UserId) | sort by count_\r\n| top 15 by count_",
              "size": 0,
              "title": "Top Submitters - Admin Submissions (FP)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| extend Admin_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ,\"Admin_Email_FP\",\r\n\"Other\"),DetectionMethod=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdictControlSource),\r\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType == \"3\" and DetectionVerdict ==\"Phish\" \r\n| summarize count() by DetectionMethod\r\n| project DetectionMethod,Emails = count_\r\n",
              "size": 0,
              "title": "Admin Submissions (Phish FP) by DetectionMethod",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 0 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the original detection technology of emails submitted as spam false positive by admins\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| extend Admin_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ,\"Admin_Email_FP\",\r\n\"Other\"),DetectionMethod=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdictControlSource),\r\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType == \"3\" and DetectionVerdict ==\"Spam\" \r\n| summarize count() by DetectionMethod\r\n| project DetectionMethod,Emails = count_\r\n",
              "size": 0,
              "title": "Admin Submissions (Spam FP) by DetectionMethod",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 0 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 sender domains of emails which are submitted as false positive by admins\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType ==\"3\"\r\n| summarize count() by P2SenderDomain\r\n| project P2SenderDomain, Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "title": "Admin Email Submissions (FP)- Top 10 Senders domains",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises all emails submitted as false positive by admins summarizing by the original filter verdict threat type\r\nCloudAppEvents \r\n| where ActionType == \"AdminSubmissionSubmitted\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| extend Admin_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ,\"Admin_Email_FP\",\r\n\"Other\"),\r\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType == \"3\"\r\n| summarize count() by PolicyOverride,DetectionVerdict,Admin_SubmissionType\r\n| project PolicyOverride, DetectionVerdict,Admin_SubmissionType, Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "title": "Admin Email Submissions (FP)- by Detection Types",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "10"
      },
      "name": "group - 11 - Copy",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "False negative (FN) User Submissions ",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of users false negative submission by submission type, including phish simulations reported by users.\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = CloudAppEvents\r\n| where ActionType contains \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType);\r\nlet User_Phish_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"User_Phish_FN\";\r\nlet User_Spam_FN=baseQuery\r\n| make-series Count= countif(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"User_Spam_FN\";\r\nlet User_AttackSim_Submission=baseQuery\r\n| make-series Count= countif(ActionType == \"AttackSimUserSubmission\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"User_AttackSim_Submission\";\r\nunion User_Phish_FN,User_Spam_FN,User_AttackSim_Submission\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "User Email Submission Trend (FN)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalAdminSubmissions",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "User_Phish_FN",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "User_AttackSim_Submission",
                    "color": "green"
                  },
                  {
                    "seriesName": "User_Spam_FN",
                    "color": "orangeDark"
                  }
                ]
              }
            },
            "customWidth": "66",
            "name": "query - 4 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of user false negative submission by submission type, including the phish simulations reported emails\r\nCloudAppEvents \r\n| where ActionType contains \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\r\niff(ActionType == \"AttackSimUserSubmission\" and SubmissionContentType==\"Mail\",\"User_AttackSim_Submission\",\r\n\"Other\")))\r\n| where User_SubmissionType!=\"Other\"\r\n| summarize count() by User_SubmissionType",
              "size": 0,
              "title": "User Email Submissions (FN) by Submission Type",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "33",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of user false negative submissions by the state of the submission.\r\nCloudAppEvents \r\n| where ActionType contains \"UserSubmission\" \r\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and SubmissionType in (\"0\",\"1\")\r\n| summarize count() by tostring(SubmissionState)",
              "size": 0,
              "title": "User Email Submissions (FN) by Submission State",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of user false negative or false positive submissions by the verdict of the submission grading.\r\nCloudAppEvents \r\n| where ActionType contains \"UserSubmissionTriage\" \r\n| extend UserKey = (parse_json(RawEventData)).UserKey, SubmissionState = (parse_json(RawEventData)).SubmissionState,  SubmissionId=(parse_json(RawEventData)).SubmissionId, TriageVerdict=(parse_json(RawEventData)).GradingResult.TriageVerdict \r\n| summarize count() by tostring(TriageVerdict)",
              "size": 0,
              "title": "User Email Submissions (FN-FP) by Grading verdict",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - 0 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of user false negative submissions that are already detected by MDO and already delivered in the junk folder\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where DeliveryLocation == \"Junk folder\"\r\n| summarize count() by ThreatTypes,User_SubmissionType\r\n| project ThreatTypes,User_SubmissionType, Emails = count_",
              "size": 0,
              "title": "User Email Submissions (FN) from Junk folder",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - 0 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises user submissions type compared to admin review verdict. \r\n//Eg. User reporting a phish but admin review is 'not threat found'\r\nlet ReviewResults = CloudAppEvents | where ActionType == \"SubmissionNotification\" \r\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId)\r\n| extend Properties = parse_json(RawEventData.ExtendedProperties)\r\n| mv-expand element = Properties\r\n| where element.Name == \"AdminReviewResult\"\r\n| project SubmissionId, AdminReviewResult = element.Value;\r\nCloudAppEvents\r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId), SubmissionType = parse_json(RawEventData).SubmissionType\r\n| join kind=leftouter ReviewResults on SubmissionId\r\n| extend UserReportedAs=iif(SubmissionType == 1, \"Phish\",iif(SubmissionType == 2, \"Junk\",iif(SubmissionType == 3, \"NotJunk\",\"\")))\r\n| extend ReviewedAccuracy=iif(AdminReviewResult==UserReportedAs, \"Correct\", iif(AdminReviewResult==\"Phish\" and UserReportedAs == \"Junk\", \"Phish reported as junk\",iif(AdminReviewResult==\"Junk\" and UserReportedAs == \"Phish\",\"Junk reported as Phish\",iif(AdminReviewResult==\"NotJunk\",\"Reported but not malicious or spam\",iif(isempty(AdminReviewResult),\"Not Reviewed\",\"Not correct\")))))\r\n| extend Reviewed=iif(isempty(AdminReviewResult),\"Not Reviewed\",\"Reviewed\")\r\n| project SubmissionId,UserReportedAs,Reviewed,AdminReviewResult, ReviewedAccuracy\r\n| where Reviewed==\"Reviewed\"\r\n| summarize count() by ReviewedAccuracy",
              "size": 0,
              "title": "User  Email Submissions accuracy vs Admin review verdict",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 6",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises user submissions where admin also performed 'mark and notify' action on the submission\r\nlet ReviewResults = CloudAppEvents | where ActionType == \"SubmissionNotification\" \r\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId)\r\n| extend Properties = parse_json(RawEventData.ExtendedProperties)\r\n| mv-expand element = Properties\r\n| where element.Name == \"AdminReviewResult\"\r\n| project SubmissionId, AdminReviewResult = element.Value;\r\nCloudAppEvents\r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId), SubmissionType = parse_json(RawEventData).SubmissionType\r\n| join kind=leftouter ReviewResults on SubmissionId\r\n| extend UserReportedAs=iif(SubmissionType == 1, \"Phish\",iif(SubmissionType == 2, \"Junk\",iif(SubmissionType == 3, \"NotJunk\",\"\")))\r\n| extend ReviewedAccuracy=iif(UserReportedAs==AdminReviewResult, 1,0)\r\n| extend Reviewed=iif(isempty(AdminReviewResult),\"Not Reviewed\",\"Reviewed\")\r\n| project SubmissionId,UserReportedAs,Reviewed,AdminReviewResult, ReviewedAccuracy\r\n| summarize count() by Reviewed",
              "size": 0,
              "title": "User Email  Submissions - Admin rewiew status (Mark and Notify)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 5",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 15 users performing false negative submissions\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\" \r\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and SubmissionType in (\"0\",\"1\")\r\n| extend UserId = (parse_json(RawEventData)).UserId\r\n| summarize count() by tostring(UserId) | sort by count_\r\n| top 15 by count_",
              "size": 0,
              "title": "Top Submitters - User Email Submissions (FN)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top users reporting the phishing simulation emails.\r\nCloudAppEvents \r\n| extend Record= (parse_json(RawEventData)).RecordType \r\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState \r\n| extend UserId = (parse_json(RawEventData)).UserId\r\n| where Record == 29\r\n| where ActionType == \"AttackSimUserSubmission\" \r\n| summarize count() by tostring(UserId) | sort by count_\r\n| top 15 by count_",
              "size": 0,
              "title": "Top Submitters - AttackSim Submissions",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "50",
            "name": "query - 2 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises top 10 sender domains of inbound emails submitted as false negatives by users.\r\nlet TotalInboundbySender=\r\nEmailEvents\r\n| where EmailDirection ==\"Inbound\"\r\n| summarize count() by SenderFromDomain;\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),RecipientObjectId=AccountObjectId,NetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Inbound\"\r\n| summarize UserSubmissions=count() by SenderFromDomain\r\n| join TotalInboundbySender on SenderFromDomain\r\n| extend UserSubmissions_Percentage = todouble(round(UserSubmissions / todouble(count_) * 100, 2))\r\n| project SenderFromDomain, UserSubmissions, TotalInboundEmail=count_,UserSubmissions_Percentage\r\n| top 10 by UserSubmissions desc ",
              "size": 0,
              "title": "User Email Submissions (FN)- Top 10 Inbound P2 Senders domains",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "UserSubmissions",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalInboundEmail",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "UserSubmissions_Percentage",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises top 10 sender email addresses of inbound emails submitted as false negatives by users.\r\nlet TotalInboundbySender=\r\nEmailEvents\r\n| where EmailDirection ==\"Inbound\"\r\n| summarize count() by SenderFromAddress;\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),RecipientObjectId=AccountObjectId,NetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Inbound\"\r\n| summarize UserSubmissions=count() by SenderFromAddress\r\n| join TotalInboundbySender on SenderFromAddress\r\n| extend UserSubmissions_Percentage = todouble(round(UserSubmissions / todouble(count_) * 100, 2))\r\n| project SenderFromAddress, UserSubmissions, TotalInboundEmail=count_,UserSubmissions_Percentage\r\n| top 10 by UserSubmissions desc ",
              "size": 0,
              "title": "User Email Submissions (FN)- Top 10 Inbound P2 Senders",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "UserSubmissions",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "TotalInboundEmail",
                    "formatter": 0,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "UserSubmissions_Percentage",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 1,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises top 10 sender email address of intra-org emails submitted as false negatives by users.\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Intra-org\"\r\n| summarize count() by SenderMailFromAddress\r\n| project SenderMailFromAddress,UserSubmissions = count_\r\n| top 10 by UserSubmissions desc ",
              "size": 0,
              "title": "User Email Submissions (FN)- Top 10 Intra-org P2 Senders",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "UserSubmissions",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises top 10 subjects of intra-org emails submitted as false negatives by users.\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Intra-org\"\r\n| summarize count() by Subject\r\n| project Subject,UserSubmissions = count_\r\n| top 10 by UserSubmissions desc ",
              "size": 0,
              "title": "User Email Submissions (FN)- Top 10 Intra-org Subject",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Subject",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "70ch"
                    }
                  },
                  {
                    "columnMatch": "UserSubmissions",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises emails submitted as false negatives by users where emails where already detected by MDO but there was an admin definded policy override.\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where ThreatTypes !=\"\"and OrgLevelAction!=\"\"\r\n| summarize count() by OrgLevelAction, OrgLevelPolicy,ThreatTypes,User_SubmissionType\r\n| project OrgLevelAction, OrgLevelPolicy,ThreatTypes,User_SubmissionType, UserSubmissions = count_\r\n| top 10 by UserSubmissions desc ",
              "size": 0,
              "title": "User Email Submissions (FN)- Top 10 Detection Overrides by Admins",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "OrgLevelPolicy",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "48ch"
                    }
                  },
                  {
                    "columnMatch": "UserSubmissions",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises emails submitted as false negatives by users where emails where already detected by MDO but there was an policy override.\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\r\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where ThreatTypes !=\"\"and UserLevelAction!=\"\"\r\n| summarize count() by UserLevelAction, UserLevelPolicy,ThreatTypes,User_SubmissionType\r\n| project UserLevelAction, UserLevelPolicy,ThreatTypes,User_SubmissionType, UserSubmissions = count_\r\n| top 10 by UserSubmissions desc ",
              "size": 0,
              "title": "User Email Submissions (FN)- Top 10 Detection Overrides by Users",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "UserLevelPolicy",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "48ch"
                    }
                  },
                  {
                    "columnMatch": "UserSubmissions",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "30ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "8"
      },
      "name": "group - 11 - Copy",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "False negative (FP) User Submissions ",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of user false positive submission by submission type.\r\nlet minTime = toscalar(CloudAppEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(CloudAppEvents | summarize max(Timestamp));\r\nlet User_Email_FP=CloudAppEvents\r\n| where ActionType contains \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| make-series Count= countif(SubmissionType == \"3\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"User_Email_FP\";\r\nUser_Email_FP\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "User Email Submission Trend (FP)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "TotalAdminSubmissions",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "User_Phish_FN",
                    "color": "redDark"
                  },
                  {
                    "seriesName": "User_AttackSim_Submission",
                    "color": "green"
                  },
                  {
                    "seriesName": "User_Spam_FN",
                    "color": "orangeDark"
                  },
                  {
                    "seriesName": "User_Email_FP",
                    "color": "green"
                  }
                ]
              }
            },
            "customWidth": "100",
            "name": "query - 4 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of user false positive submission by submission state.\r\nCloudAppEvents \r\n| where ActionType contains \"UserSubmission\" \r\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and SubmissionType == \"3\"\r\n| summarize count() by tostring(SubmissionState)",
              "size": 0,
              "title": "User Email Submissions (FP) by Submission State",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top users performing false positive submissions.\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\" \r\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\r\n| where Record == 29 and SubmissionType == \"3\"\r\n| extend UserId = (parse_json(RawEventData)).UserId\r\n| summarize count() by tostring(UserId) | sort by count_\r\n| top 15 by count_",
              "size": 0,
              "title": "Top Submitters - User Email Submissions (FP)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of user false positive submission by original phish filter detected verdict.\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Email_FP\",\r\n\"Other\"),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType ==\"3\"\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Inbound\" and DetectionMethods has 'Phish'\r\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Phish=tostring(column_ifexists('Phish', ''))",
              "size": 0,
              "title": "User Submissions (Phish FP) by DetectionMethod",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "50",
            "name": "query - 2 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of user false positive submission by original spam filter detected verdict.\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Email_FP\",\r\n\"Other\"),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType ==\"3\"\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Inbound\" and DetectionMethods has 'Spam'\r\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Spam=tostring(column_ifexists('Spam', ''))",
              "size": 0,
              "title": "User Submissions (Spam FP) by DetectionMethod",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 15
              }
            },
            "customWidth": "50",
            "name": "query - 2 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CloudAppEvents \r\n| where ActionType == \"UserSubmission\" \r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain)\r\n| where SubmissionContentType == \"Mail\" and SubmissionType == \"3\"\r\n| summarize count() by P2SenderDomain\r\n| project P2SenderDomain, Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "title": "User Email Submissions (FP)- Top 10 Senders domains",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 senders seen in false positive user submission\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Email_FP\",\r\n\"Other\"),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType == \"3\"\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Inbound\"\r\n| summarize count() by SenderMailFromAddress\r\n| project SenderMailFromAddress,Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "title": "User Email Submissions (FP)- Top 10 Inbound P2 Senders",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 subjects seen in false positive user submission\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Email_FP\",\r\n\"Other\"),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType ==\"3\"\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Inbound\"\r\n| summarize count() by Subject\r\n| project Subject,Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "title": "User Email Submissions (FP)- Top 10 Inbound Subject",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Subject",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "70ch"
                    }
                  },
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the top 10 senders seen in intra-org false positive user submission\r\nCloudAppEvents \r\n| where ActionType == \"UserSubmission\"\r\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\r\n| extend User_SubmissionType=\r\niff(SubmissionType == \"3\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Email_FP\",\r\n\"Other\"),\r\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\r\n| where SubmissionContentType == \"Mail\" and SubmissionType ==\"3\"\r\n| join EmailEvents on NetworkMessageId, RecipientObjectId\r\n| where EmailDirection == \"Intra-org\"\r\n| summarize count() by SenderMailFromAddress\r\n| project SenderMailFromAddress,Emails = count_\r\n| top 10 by Emails desc ",
              "size": 0,
              "title": "User Email Submissions (FP)- Top 10 Intra-org P2 Senders",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Emails",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "query - 8 - Copy - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "10"
      },
      "name": "group - 11 - Copy - Copy",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total files located on SharePoint, OneDrive and Teams with Malware detections over time summarizing the data daily. \r\nCloudAppEvents\r\n| where ActionType == 'FileMalwareDetected'\r\n| make-series Count = count() default = 0 on Timestamp step 1d ",
              "size": 0,
              "title": "File Malware Detection Trend ",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "tileSettings": {
                "showBorder": false
              },
              "graphSettings": {
                "type": 0
              },
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "FileMalwareDetections",
                    "color": "redDark"
                  }
                ],
                "showDataPoints": true
              }
            },
            "customWidth": "100",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CloudAppEvents\r\n| where ActionType == 'FileMalwareDetected' and UserAgent =~ 'MS Scanner ATP'\r\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\r\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_",
              "size": 0,
              "title": "Top Malware families - Defender for Office 365 detections",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "RawinfoVirusInfo",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "RawinfoVirusInfo",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "count_",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "xAxis": "RawinfoVirusInfo",
                "createOtherGroup": 20,
                "showMetrics": false
              }
            },
            "customWidth": "25",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total Malware detections of files located on SharePoint, OneDrive and Teams over time summarizing the data by the various Malware families detected focusing on Defender for Office 365 detections (detonations). \r\nCloudAppEvents\r\n| where ActionType == 'FileMalwareDetected' and UserAgent =~ 'MS Scanner ATP'\r\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\r\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_\r\n| project RawinfoVirusInfo, Files=count_",
              "size": 0,
              "title": "Top Malware families - Defender for Office 365 detections",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Files",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "RawinfoVirusInfo",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "RawinfoVirusInfo",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "count_",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "xAxis": "RawinfoVirusInfo",
                "createOtherGroup": 15
              }
            },
            "customWidth": "25",
            "name": "query - 1 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises total Malware detections of files located on SharePoint, OneDrive and Teams over time summarizing the data by the various Malware families detected focusing on built-in SharePoint AV detections. \r\nCloudAppEvents\r\n| where ActionType == 'FileMalwareDetected' and isempty(UserAgent)\r\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\r\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_",
              "size": 0,
              "title": "Top Malware families - Sharepoint Online AV detections",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "xAxis": "RawinfoVirusInfo",
                "createOtherGroup": 20,
                "showMetrics": false
              }
            },
            "customWidth": "25",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CloudAppEvents\r\n| where ActionType == 'FileMalwareDetected' and isempty(UserAgent)\r\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\r\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_\r\n| project RawinfoVirusInfo, Files=count_",
              "size": 0,
              "title": "Top Malware families - Sharepoint Online AV detections",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Files",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "redDark",
                      "customColumnWidthSetting": "40ch"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              },
              "chartSettings": {
                "xAxis": "RawinfoVirusInfo",
                "createOtherGroup": 10
              }
            },
            "customWidth": "25",
            "name": "query - 2 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CloudAppEvents\r\n| where ActionType == 'FileMalwareDetected'\r\n| project location=(split(RawEventData.SiteUrl, '/')[4])\r\n| summarize count() by tostring(location)\r\n| sort by count_ desc",
              "size": 3,
              "title": "Malware detection - top targeted workload locations",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "location",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "createOtherGroup": 10
              }
            },
            "customWidth": "50",
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CloudAppEvents\r\n| where ActionType == 'FileMalwareDetected'\r\n| extend Appwithteams = iff(Application =~ 'Microsoft SharePoint Online',strcat(Application,' / Teams Files'),Application)\r\n| extend Appwithteams = trim_start('Microsoft',Appwithteams) | summarize count() by Appwithteams\r\n| sort by count_ desc",
              "size": 3,
              "title": "Malware detection - by workload type",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "9"
      },
      "name": "group - 4"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of emails that had a post delivery action from zero-hour auto purge.\r\nEmailPostDeliveryEvents \r\n| where ActionType has \"ZAP\"\r\n| make-series Count = count() default = 0 on Timestamp step 1d \r\n| extend Details = \"Zapped Emails\";",
              "size": 0,
              "title": "Post Delivery Actions by ZAP",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of emails that had a post delivery action from zero-hour auto purge, summarizing by phish,spam or malware detection action\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailPostDeliveryEvents\r\n| where ActionType has \"ZAP\";\r\nlet szap=baseQuery\r\n| where ActionType has 'Spam ZAP' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spam ZAP\";\r\nlet pzap=baseQuery\r\n| where ActionType has 'Phish ZAP' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Phish ZAP\";\r\nlet mzap=baseQuery\r\n| where ActionType has 'Malware ZAP' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Malware ZAP\";\r\nunion szap,pzap,mzap\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "Post Delivery Actions by ZAP Type",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "50",
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of emails that had an admin post delivery action, summarizing the data by action type\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailPostDeliveryEvents\r\n| where ActionTrigger has \"AdminAction\";\r\nlet sdelete=baseQuery\r\n| where Action has 'Soft Delete' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Soft Delete\";\r\nlet hdelete=baseQuery\r\n| where Action has 'Hard Delete' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Hard Delete\";\r\nlet mtojunk=baseQuery\r\n| where Action has 'Moved to junk folder' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Moved to junk folder\";\r\nlet mtoinbox=baseQuery\r\n| where Action has 'Moved to inbox' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Moved to inbox\";\r\nlet qrel=baseQuery\r\n| where Action has 'Quarantine release' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Quarantine release\";\r\nunion sdelete,hdelete,mtojunk,mtoinbox,qrel\r\n| project Count, Details, Timestamp\r\n",
              "size": 0,
              "title": "Post Delivery Actions by Admin",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "50",
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of emails that had a post delivery action, summarizing the data daily by the final location as a result of the action\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet quarantine=EmailPostDeliveryEvents\r\n| where DeliveryLocation has 'Quarantine' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Quarantine\";\r\nlet delete=EmailPostDeliveryEvents\r\n| where DeliveryLocation has 'Delete' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Delete\";\r\nlet junk=EmailPostDeliveryEvents\r\n| where DeliveryLocation has 'Junk' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Junk\";\r\nlet inbox=EmailPostDeliveryEvents\r\n| where DeliveryLocation has 'Inbox' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Inbox\";\r\nunion quarantine,delete,junk,inbox\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "Post Delivery Actions by Location ",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "50",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "11"
      },
      "name": "group - 13"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Quarantine insights",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the daily ammount of emails released from quarantine\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet qrel = EmailPostDeliveryEvents\r\n| where ActionTrigger has \"AdminAction\" and Action has 'Quarantine release' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Quarantine release\";\r\nqrel\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "Quarantine Release Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "100",
            "name": "query - 0",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the percentage of emails released from quarantine out of the total ammount of quarantined emails\r\nlet Quarantine_Releases = toscalar(EmailPostDeliveryEvents\r\n| where Action == \"Quarantine release\"\r\n| join kind=leftouter (EmailEvents | where DeliveryLocation == \"Quarantine\") on NetworkMessageId\r\n| summarize count());\r\nlet Quarantined_Mailfow = toscalar(EmailEvents | where DeliveryLocation == \"Quarantine\"\r\n| summarize count());\r\nprint\r\nQuarantine_Releases = toreal(Quarantine_Releases),\r\nQuarantined_Mailflow = toreal(Quarantined_Mailfow),\r\nRelease_Percentage = abs(round(((toreal(Quarantine_Releases)/toreal(Quarantined_Mailfow))*100),2))",
              "size": 0,
              "title": " ",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "stat",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Release_Percentage",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "none"
                  },
                  "numberFormat": {
                    "unit": 1,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                "showBorder": true,
                "sortCriteriaField": "Release_Percentage",
                "size": "auto"
              },
              "statSettings": {
                "valueField": "Release_Percentage",
                "valueAggregation": "None",
                "colorSettings": {
                  "type": "thresholds",
                  "mode": "foreground",
                  "heatmapPalette": "greenRed",
                  "thresholdsGrid": [
                    {
                      "operator": "<",
                      "thresholdValue": "5",
                      "representation": "green"
                    },
                    {
                      "operator": ">",
                      "thresholdValue": "5",
                      "representation": "redDark"
                    }
                  ]
                },
                "iconSettings": {
                  "thresholdsGrid": []
                },
                "numberFormatSettings": {
                  "unit": 1,
                  "options": {
                    "style": "decimal"
                  }
                },
                "tagText": "Quarantine Release Percentage",
                "valueFontStyle": "mega"
              }
            },
            "customWidth": "66",
            "name": "query - 1",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises emails released from quarantine and summarizing the result by the original filter verdict - detection method\r\nlet totalQuery = \r\n    EmailPostDeliveryEvents \r\n    | where Action == \"Quarantine release\" \r\n    | join kind=inner (EmailEvents | where DeliveryLocation == \"Quarantine\") on NetworkMessageId \r\n    | extend MDO_detection = parse_json(DetectionMethods1) \r\n    | extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n    | extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n    | where FirstSubcategory contains \"Malware\" or FirstSubcategory contains \"Phish\" or FirstSubcategory contains \"Spam\"\r\n    | count;\r\nEmailPostDeliveryEvents \r\n| where Action == \"Quarantine release\" \r\n| join kind=inner (EmailEvents | where DeliveryLocation == \"Quarantine\") on NetworkMessageId \r\n| extend MDO_detection = parse_json(DetectionMethods1) \r\n| extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \r\n| extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \r\n| where FirstSubcategory contains \"Malware\" or FirstSubcategory contains \"Phish\" or FirstSubcategory contains \"Spam\" \r\n| summarize count_messages = count(NetworkMessageId) by FirstSubcategory\r\n| extend percentage = round((count_messages * 100.0 / toscalar(totalQuery)), 2)\r\n| project FirstSubcategory, count_messages, percentage\r\n| order by percentage desc",
              "size": 0,
              "title": "Quarantine release attempts by detection types",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "percentage"
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "customWidth": "33",
            "name": "query - 6",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of phish emails that are quarantined, summarized daily by the detection method\r\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\r\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\r\nlet baseQuery = EmailEvents\r\n| where DetectionMethods has \"Phish\" and DeliveryLocation == \"Quarantine\";\r\nlet ml=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Advanced filter'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Advanced filter\";\r\nlet camp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Campaign'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Campaign\";\r\nlet fd=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'File detonation' and Phish !has 'File detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"File detonation\";\r\nlet fdr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'File detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"File detonation reputation\";\r\nlet frp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Fingerprint matching' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Fingerprint matching\";\r\nlet gf=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'General filter' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"General filter\";\r\nlet bimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation brand' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation brand\";\r\nlet dimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation domain' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation domain\";\r\nlet uimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Impersonation user' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Impersonation user\";\r\nlet mimp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Mailbox intelligence impersonation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Mailbox intelligence impersonation\";\r\nlet sdmarc=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof DMARC' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof DMARC\";\r\nlet spoofe=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof external domain' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof external domain\";\r\nlet spoofi=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'Spoof intra-org' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"Spoof intra-org\";\r\nlet ud=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL detonation' and Phish !has 'URL detonation reputation'\r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL detonation\";\r\nlet udr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL detonation reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL detonation reputation\";\r\nlet umr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Phish has 'URL malicious reputation' \r\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \r\n| extend Details = \"URL malicious reputation\";\r\nunion ml,camp,fd,fdr,frp,gf,bimp,dimp,uimp,mimp,sdmarc,spoofe,spoofi,ud,udr,umr\r\n| project Count, Details, Timestamp\r\n\r\n\r\n",
              "size": 0,
              "title": "Quarantine Phish Reason Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "66",
            "name": "query - 3",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of phish emails that are quarantined, summarized by the detection method\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\" and DetectionMethods has 'Phish' and DeliveryLocation == \"Quarantine\"\r\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Phish=tostring(column_ifexists('Phish', ''))",
              "size": 0,
              "title": "Quarantine Phish Reason",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 20
              }
            },
            "customWidth": "33",
            "name": "query - 2",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the ammount of spam emails that are quarantined, summarized daily by the detection method\r\nlet baseQuery = EmailEvents\r\n| where DetectionMethods has \"Spam\" and DeliveryLocation == \"Quarantine\";\r\nlet timerange = \r\nbaseQuery\r\n| summarize minTime = min(Timestamp), maxTime = max(Timestamp);\r\nlet ml=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Advanced filter'\r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"Advanced filter\";\r\nlet gf=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'General filter'\r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"General filter\";\r\nlet bl=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'BulkFilter'\r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"BulkFilter\";\r\nlet mx=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Mixed analysis detection'\r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"Mixed analysis detection\";\r\nlet frp=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Fingerprint matching'\r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"Fingerprint matching\";\r\nlet umr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'URL malicious reputation' \r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"URL malicious reputation\";\r\nlet dr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'Domain reputation' \r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"Domain reputation\";\r\nlet ipr=baseQuery\r\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \r\n| where Spam has 'IP reputation' \r\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \r\n| extend Details = \"IP reputation\";\r\nunion ml,gf,bl,mx,frp,umr,dr,ipr\r\n| project Count, Details, Timestamp",
              "size": 0,
              "title": "Quarantine Spam Reason Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart"
            },
            "customWidth": "66",
            "name": "query - 4",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//This query visualises the total ammount of spam emails that are quarantined, summarized by the detection method\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\" and DetectionMethods has 'Spam' and DeliveryLocation == \"Quarantine\"\r\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Spam=tostring(column_ifexists('Spam', ''))",
              "size": 0,
              "title": "Quarantine Spam Reason",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "createOtherGroup": 20
              }
            },
            "customWidth": "33",
            "name": "query - 2 - Copy",
            "styleSettings": {
              "margin": "10px",
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "12"
      },
      "name": "group - 19"
    }
  ],
  "fallbackResourceIds": [],
  "fromTemplateId": "sentinel-MicrosoftDefenderForOffice365detectionsandinsights",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
