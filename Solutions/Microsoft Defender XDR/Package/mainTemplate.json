{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for Microsoft Defender XDR"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Microsoft Defender for Office 365 Detection and Insights",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook2-name": {
      "type": "string",
      "defaultValue": "Microsoft Defender For EndPoint",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook3-name": {
      "type": "string",
      "defaultValue": "Microsoft Defender For Identity",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "_solutionName": "Microsoft Defender XDR",
    "_solutionVersion": "3.0.13",
    "solutionId": "azuresentinel.azure-sentinel-solution-microsoft365defender",
    "_solutionId": "[variables('solutionId')]",
    "uiConfigId1": "MicrosoftThreatProtection",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "MicrosoftThreatProtection",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1'))))]",
    "dataConnectorVersion1": "1.0.0",
    "_dataConnectorcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentId1'),'-', variables('dataConnectorVersion1'))))]",
    "analyticRuleObject1": {
      "analyticRuleVersion1": "1.1.2",
      "_analyticRulecontentId1": "6c3a1258-bcdd-4fcd-b753-1a9bc826ce12",
      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '6c3a1258-bcdd-4fcd-b753-1a9bc826ce12')]",
      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('6c3a1258-bcdd-4fcd-b753-1a9bc826ce12')))]",
      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','6c3a1258-bcdd-4fcd-b753-1a9bc826ce12','-', '1.1.2')))]"
    },
    "analyticRuleObject2": {
      "analyticRuleVersion2": "1.0.2",
      "_analyticRulecontentId2": "53e936c6-6c30-4d12-8343-b8a0456e8429",
      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '53e936c6-6c30-4d12-8343-b8a0456e8429')]",
      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('53e936c6-6c30-4d12-8343-b8a0456e8429')))]",
      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','53e936c6-6c30-4d12-8343-b8a0456e8429','-', '1.0.2')))]"
    },
    "analyticRuleObject3": {
      "analyticRuleVersion3": "1.1.0",
      "_analyticRulecontentId3": "1bf6e165-5e32-420e-ab4f-0da8558a8be2",
      "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '1bf6e165-5e32-420e-ab4f-0da8558a8be2')]",
      "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('1bf6e165-5e32-420e-ab4f-0da8558a8be2')))]",
      "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','1bf6e165-5e32-420e-ab4f-0da8558a8be2','-', '1.1.0')))]"
    },
    "analyticRuleObject4": {
      "analyticRuleVersion4": "1.0.6",
      "_analyticRulecontentId4": "738702fd-0a66-42c7-8586-e30f0583f8fe",
      "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '738702fd-0a66-42c7-8586-e30f0583f8fe')]",
      "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('738702fd-0a66-42c7-8586-e30f0583f8fe')))]",
      "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','738702fd-0a66-42c7-8586-e30f0583f8fe','-', '1.0.6')))]"
    },
    "analyticRuleObject5": {
      "analyticRuleVersion5": "1.0.5",
      "_analyticRulecontentId5": "ce1e7025-866c-41f3-9b08-ec170e05e73e",
      "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'ce1e7025-866c-41f3-9b08-ec170e05e73e')]",
      "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('ce1e7025-866c-41f3-9b08-ec170e05e73e')))]",
      "_analyticRulecontentProductId5": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','ce1e7025-866c-41f3-9b08-ec170e05e73e','-', '1.0.5')))]"
    },
    "analyticRuleObject6": {
      "analyticRuleVersion6": "1.0.7",
      "_analyticRulecontentId6": "a3c144f9-8051-47d4-ac29-ffb0c312c910",
      "analyticRuleId6": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'a3c144f9-8051-47d4-ac29-ffb0c312c910')]",
      "analyticRuleTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('a3c144f9-8051-47d4-ac29-ffb0c312c910')))]",
      "_analyticRulecontentProductId6": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','a3c144f9-8051-47d4-ac29-ffb0c312c910','-', '1.0.7')))]"
    },
    "analyticRuleObject7": {
      "analyticRuleVersion7": "1.1.3",
      "_analyticRulecontentId7": "b6685757-3ed1-4b05-a5bd-2cacadc86c2a",
      "analyticRuleId7": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'b6685757-3ed1-4b05-a5bd-2cacadc86c2a')]",
      "analyticRuleTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('b6685757-3ed1-4b05-a5bd-2cacadc86c2a')))]",
      "_analyticRulecontentProductId7": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','b6685757-3ed1-4b05-a5bd-2cacadc86c2a','-', '1.1.3')))]"
    },
    "analyticRuleObject8": {
      "analyticRuleVersion8": "1.0.4",
      "_analyticRulecontentId8": "1785d372-b9fe-4283-96a6-3a1d83cabfd1",
      "analyticRuleId8": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '1785d372-b9fe-4283-96a6-3a1d83cabfd1')]",
      "analyticRuleTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('1785d372-b9fe-4283-96a6-3a1d83cabfd1')))]",
      "_analyticRulecontentProductId8": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','1785d372-b9fe-4283-96a6-3a1d83cabfd1','-', '1.0.4')))]"
    },
    "analyticRuleObject9": {
      "analyticRuleVersion9": "1.0.3",
      "_analyticRulecontentId9": "3bd33158-3f0b-47e3-a50f-7c20a1b88038",
      "analyticRuleId9": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '3bd33158-3f0b-47e3-a50f-7c20a1b88038')]",
      "analyticRuleTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('3bd33158-3f0b-47e3-a50f-7c20a1b88038')))]",
      "_analyticRulecontentProductId9": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','3bd33158-3f0b-47e3-a50f-7c20a1b88038','-', '1.0.3')))]"
    },
    "analyticRuleObject10": {
      "analyticRuleVersion10": "1.1.2",
      "_analyticRulecontentId10": "26e81021-2de6-4442-a74a-a77885e96911",
      "analyticRuleId10": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '26e81021-2de6-4442-a74a-a77885e96911')]",
      "analyticRuleTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('26e81021-2de6-4442-a74a-a77885e96911')))]",
      "_analyticRulecontentProductId10": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','26e81021-2de6-4442-a74a-a77885e96911','-', '1.1.2')))]"
    },
    "analyticRuleObject11": {
      "analyticRuleVersion11": "1.0.0",
      "_analyticRulecontentId11": "c25a8cd4-5b4a-45a8-9ba0-3b753a652f6b",
      "analyticRuleId11": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'c25a8cd4-5b4a-45a8-9ba0-3b753a652f6b')]",
      "analyticRuleTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('c25a8cd4-5b4a-45a8-9ba0-3b753a652f6b')))]",
      "_analyticRulecontentProductId11": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','c25a8cd4-5b4a-45a8-9ba0-3b753a652f6b','-', '1.0.0')))]"
    },
    "analyticRuleObject12": {
      "analyticRuleVersion12": "1.0.0",
      "_analyticRulecontentId12": "bb46dd86-e642-48a4-975c-44f5ac2b5033",
      "analyticRuleId12": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'bb46dd86-e642-48a4-975c-44f5ac2b5033')]",
      "analyticRuleTemplateSpecName12": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('bb46dd86-e642-48a4-975c-44f5ac2b5033')))]",
      "_analyticRulecontentProductId12": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','bb46dd86-e642-48a4-975c-44f5ac2b5033','-', '1.0.0')))]"
    },
    "analyticRuleObject13": {
      "analyticRuleVersion13": "1.0.0",
      "_analyticRulecontentId13": "2c81c0a0-9823-4a14-b21a-2b4acd3335d2",
      "analyticRuleId13": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2c81c0a0-9823-4a14-b21a-2b4acd3335d2')]",
      "analyticRuleTemplateSpecName13": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('2c81c0a0-9823-4a14-b21a-2b4acd3335d2')))]",
      "_analyticRulecontentProductId13": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','2c81c0a0-9823-4a14-b21a-2b4acd3335d2','-', '1.0.0')))]"
    },
    "analyticRuleObject14": {
      "analyticRuleVersion14": "1.0.0",
      "_analyticRulecontentId14": "7ce00cba-f76f-4026-ab7f-7e4f1b67bd18",
      "analyticRuleId14": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '7ce00cba-f76f-4026-ab7f-7e4f1b67bd18')]",
      "analyticRuleTemplateSpecName14": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('7ce00cba-f76f-4026-ab7f-7e4f1b67bd18')))]",
      "_analyticRulecontentProductId14": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','7ce00cba-f76f-4026-ab7f-7e4f1b67bd18','-', '1.0.0')))]"
    },
    "analyticRuleObject15": {
      "analyticRuleVersion15": "1.0.0",
      "_analyticRulecontentId15": "1be34fb9-f81b-47ae-84fb-465e6686d76c",
      "analyticRuleId15": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '1be34fb9-f81b-47ae-84fb-465e6686d76c')]",
      "analyticRuleTemplateSpecName15": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('1be34fb9-f81b-47ae-84fb-465e6686d76c')))]",
      "_analyticRulecontentProductId15": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','1be34fb9-f81b-47ae-84fb-465e6686d76c','-', '1.0.0')))]"
    },
    "analyticRuleObject16": {
      "analyticRuleVersion16": "1.0.0",
      "_analyticRulecontentId16": "c332b840-61e4-462e-a201-0e2d69bad45d",
      "analyticRuleId16": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'c332b840-61e4-462e-a201-0e2d69bad45d')]",
      "analyticRuleTemplateSpecName16": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('c332b840-61e4-462e-a201-0e2d69bad45d')))]",
      "_analyticRulecontentProductId16": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','c332b840-61e4-462e-a201-0e2d69bad45d','-', '1.0.0')))]"
    },
    "analyticRuleObject17": {
      "analyticRuleVersion17": "1.0.0",
      "_analyticRulecontentId17": "5bdc1504-880c-4b30-a39c-7c746535928d",
      "analyticRuleId17": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '5bdc1504-880c-4b30-a39c-7c746535928d')]",
      "analyticRuleTemplateSpecName17": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('5bdc1504-880c-4b30-a39c-7c746535928d')))]",
      "_analyticRulecontentProductId17": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','5bdc1504-880c-4b30-a39c-7c746535928d','-', '1.0.0')))]"
    },
    "analyticRuleObject18": {
      "analyticRuleVersion18": "1.0.0",
      "_analyticRulecontentId18": "47c02e21-3949-4e05-a28e-576cd75ff6f6",
      "analyticRuleId18": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '47c02e21-3949-4e05-a28e-576cd75ff6f6')]",
      "analyticRuleTemplateSpecName18": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('47c02e21-3949-4e05-a28e-576cd75ff6f6')))]",
      "_analyticRulecontentProductId18": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','47c02e21-3949-4e05-a28e-576cd75ff6f6','-', '1.0.0')))]"
    },
    "analyticRuleObject19": {
      "analyticRuleVersion19": "1.0.0",
      "_analyticRulecontentId19": "36fbd4e7-5630-4414-aa42-702a7fdded21",
      "analyticRuleId19": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '36fbd4e7-5630-4414-aa42-702a7fdded21')]",
      "analyticRuleTemplateSpecName19": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('36fbd4e7-5630-4414-aa42-702a7fdded21')))]",
      "_analyticRulecontentProductId19": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','36fbd4e7-5630-4414-aa42-702a7fdded21','-', '1.0.0')))]"
    },
    "analyticRuleObject20": {
      "analyticRuleVersion20": "1.0.0",
      "_analyticRulecontentId20": "2624fc55-0998-4897-bb48-1c6422befce4",
      "analyticRuleId20": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2624fc55-0998-4897-bb48-1c6422befce4')]",
      "analyticRuleTemplateSpecName20": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('2624fc55-0998-4897-bb48-1c6422befce4')))]",
      "_analyticRulecontentProductId20": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','2624fc55-0998-4897-bb48-1c6422befce4','-', '1.0.0')))]"
    },
    "analyticRuleObject21": {
      "analyticRuleVersion21": "1.0.0",
      "_analyticRulecontentId21": "fa2f7d8a-6726-465a-aa72-6f6e3d4c99d7",
      "analyticRuleId21": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'fa2f7d8a-6726-465a-aa72-6f6e3d4c99d7')]",
      "analyticRuleTemplateSpecName21": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('fa2f7d8a-6726-465a-aa72-6f6e3d4c99d7')))]",
      "_analyticRulecontentProductId21": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','fa2f7d8a-6726-465a-aa72-6f6e3d4c99d7','-', '1.0.0')))]"
    },
    "analyticRuleObject22": {
      "analyticRuleVersion22": "1.0.0",
      "_analyticRulecontentId22": "2a1dc4c2-a8d6-4a0e-8539-9b971c851195",
      "analyticRuleId22": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2a1dc4c2-a8d6-4a0e-8539-9b971c851195')]",
      "analyticRuleTemplateSpecName22": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('2a1dc4c2-a8d6-4a0e-8539-9b971c851195')))]",
      "_analyticRulecontentProductId22": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','2a1dc4c2-a8d6-4a0e-8539-9b971c851195','-', '1.0.0')))]"
    },
    "analyticRuleObject23": {
      "analyticRuleVersion23": "1.0.0",
      "_analyticRulecontentId23": "174de33b-107b-4cd8-a85d-b4025a35453f",
      "analyticRuleId23": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '174de33b-107b-4cd8-a85d-b4025a35453f')]",
      "analyticRuleTemplateSpecName23": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('174de33b-107b-4cd8-a85d-b4025a35453f')))]",
      "_analyticRulecontentProductId23": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','174de33b-107b-4cd8-a85d-b4025a35453f','-', '1.0.0')))]"
    },
    "analyticRuleObject24": {
      "analyticRuleVersion24": "1.0.0",
      "_analyticRulecontentId24": "12134de5-361b-427c-a1a0-d43f40a593c4",
      "analyticRuleId24": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '12134de5-361b-427c-a1a0-d43f40a593c4')]",
      "analyticRuleTemplateSpecName24": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('12134de5-361b-427c-a1a0-d43f40a593c4')))]",
      "_analyticRulecontentProductId24": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','12134de5-361b-427c-a1a0-d43f40a593c4','-', '1.0.0')))]"
    },
    "analyticRuleObject25": {
      "analyticRuleVersion25": "1.0.0",
      "_analyticRulecontentId25": "3ab04acf-e0e7-4f7c-8995-748ab4c848c2",
      "analyticRuleId25": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '3ab04acf-e0e7-4f7c-8995-748ab4c848c2')]",
      "analyticRuleTemplateSpecName25": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('3ab04acf-e0e7-4f7c-8995-748ab4c848c2')))]",
      "_analyticRulecontentProductId25": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','3ab04acf-e0e7-4f7c-8995-748ab4c848c2','-', '1.0.0')))]"
    },
    "analyticRuleObject26": {
      "analyticRuleVersion26": "1.0.0",
      "_analyticRulecontentId26": "506f4d6b-3864-4bb1-8f75-a13fb066f97a",
      "analyticRuleId26": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '506f4d6b-3864-4bb1-8f75-a13fb066f97a')]",
      "analyticRuleTemplateSpecName26": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('506f4d6b-3864-4bb1-8f75-a13fb066f97a')))]",
      "_analyticRulecontentProductId26": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','506f4d6b-3864-4bb1-8f75-a13fb066f97a','-', '1.0.0')))]"
    },
    "analyticRuleObject27": {
      "analyticRuleVersion27": "1.0.1",
      "_analyticRulecontentId27": "e5f8e196-3544-4a8b-96a9-17c1b6a49710",
      "analyticRuleId27": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'e5f8e196-3544-4a8b-96a9-17c1b6a49710')]",
      "analyticRuleTemplateSpecName27": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('e5f8e196-3544-4a8b-96a9-17c1b6a49710')))]",
      "_analyticRulecontentProductId27": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','e5f8e196-3544-4a8b-96a9-17c1b6a49710','-', '1.0.1')))]"
    },
    "analyticRuleObject28": {
      "analyticRuleVersion28": "1.0.0",
      "_analyticRulecontentId28": "35ab0d58-baab-4154-87ed-fa2f69797e9e",
      "analyticRuleId28": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '35ab0d58-baab-4154-87ed-fa2f69797e9e')]",
      "analyticRuleTemplateSpecName28": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('35ab0d58-baab-4154-87ed-fa2f69797e9e')))]",
      "_analyticRulecontentProductId28": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','35ab0d58-baab-4154-87ed-fa2f69797e9e','-', '1.0.0')))]"
    },
    "analyticRuleObject29": {
      "analyticRuleVersion29": "1.0.0",
      "_analyticRulecontentId29": "d29cc957-0ddb-4d00-8d6f-ad1bb345ff9a",
      "analyticRuleId29": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'd29cc957-0ddb-4d00-8d6f-ad1bb345ff9a')]",
      "analyticRuleTemplateSpecName29": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('d29cc957-0ddb-4d00-8d6f-ad1bb345ff9a')))]",
      "_analyticRulecontentProductId29": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','d29cc957-0ddb-4d00-8d6f-ad1bb345ff9a','-', '1.0.0')))]"
    },
    "analyticRuleObject30": {
      "analyticRuleVersion30": "1.0.0",
      "_analyticRulecontentId30": "450f4e56-5bba-4070-b9d9-9204ba9d777d",
      "analyticRuleId30": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '450f4e56-5bba-4070-b9d9-9204ba9d777d')]",
      "analyticRuleTemplateSpecName30": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('450f4e56-5bba-4070-b9d9-9204ba9d777d')))]",
      "_analyticRulecontentProductId30": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','450f4e56-5bba-4070-b9d9-9204ba9d777d','-', '1.0.0')))]"
    },
    "analyticRuleObject31": {
      "analyticRuleVersion31": "1.0.2",
      "_analyticRulecontentId31": "63aa43c2-e88e-4102-aea5-0432851c541a",
      "analyticRuleId31": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '63aa43c2-e88e-4102-aea5-0432851c541a')]",
      "analyticRuleTemplateSpecName31": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('63aa43c2-e88e-4102-aea5-0432851c541a')))]",
      "_analyticRulecontentProductId31": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','63aa43c2-e88e-4102-aea5-0432851c541a','-', '1.0.2')))]"
    },
    "analyticRuleObject32": {
      "analyticRuleVersion32": "1.0.0",
      "_analyticRulecontentId32": "91a451e3-178f-41b2-9e5d-da97d75b9971",
      "analyticRuleId32": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '91a451e3-178f-41b2-9e5d-da97d75b9971')]",
      "analyticRuleTemplateSpecName32": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('91a451e3-178f-41b2-9e5d-da97d75b9971')))]",
      "_analyticRulecontentProductId32": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','91a451e3-178f-41b2-9e5d-da97d75b9971','-', '1.0.0')))]"
    },
    "analyticRuleObject33": {
      "analyticRuleVersion33": "1.0.0",
      "_analyticRulecontentId33": "32b29155-3fd3-4a9e-a0ca-a67e2593b60b",
      "analyticRuleId33": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '32b29155-3fd3-4a9e-a0ca-a67e2593b60b')]",
      "analyticRuleTemplateSpecName33": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('32b29155-3fd3-4a9e-a0ca-a67e2593b60b')))]",
      "_analyticRulecontentProductId33": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','32b29155-3fd3-4a9e-a0ca-a67e2593b60b','-', '1.0.0')))]"
    },
    "analyticRuleObject34": {
      "analyticRuleVersion34": "1.0.0",
      "_analyticRulecontentId34": "03caa992-477f-4b19-8e2a-8cd58f8f9652",
      "analyticRuleId34": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '03caa992-477f-4b19-8e2a-8cd58f8f9652')]",
      "analyticRuleTemplateSpecName34": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('03caa992-477f-4b19-8e2a-8cd58f8f9652')))]",
      "_analyticRulecontentProductId34": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','03caa992-477f-4b19-8e2a-8cd58f8f9652','-', '1.0.0')))]"
    },
    "analyticRuleObject35": {
      "analyticRuleVersion35": "1.0.0",
      "_analyticRulecontentId35": "7d0d3050-8dac-4b83-bfae-902f7dc0c21c",
      "analyticRuleId35": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '7d0d3050-8dac-4b83-bfae-902f7dc0c21c')]",
      "analyticRuleTemplateSpecName35": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('7d0d3050-8dac-4b83-bfae-902f7dc0c21c')))]",
      "_analyticRulecontentProductId35": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','7d0d3050-8dac-4b83-bfae-902f7dc0c21c','-', '1.0.0')))]"
    },
    "analyticRuleObject36": {
      "analyticRuleVersion36": "1.0.0",
      "_analyticRulecontentId36": "515d0bba-b297-4f83-8280-20ff7f27ecb1",
      "analyticRuleId36": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '515d0bba-b297-4f83-8280-20ff7f27ecb1')]",
      "analyticRuleTemplateSpecName36": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('515d0bba-b297-4f83-8280-20ff7f27ecb1')))]",
      "_analyticRulecontentProductId36": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','515d0bba-b297-4f83-8280-20ff7f27ecb1','-', '1.0.0')))]"
    },
    "analyticRuleObject37": {
      "analyticRuleVersion37": "1.0.0",
      "_analyticRulecontentId37": "4dd31bd5-11a3-4b9c-a7c5-4927ab4f2a77",
      "analyticRuleId37": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4dd31bd5-11a3-4b9c-a7c5-4927ab4f2a77')]",
      "analyticRuleTemplateSpecName37": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('4dd31bd5-11a3-4b9c-a7c5-4927ab4f2a77')))]",
      "_analyticRulecontentProductId37": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','4dd31bd5-11a3-4b9c-a7c5-4927ab4f2a77','-', '1.0.0')))]"
    },
    "analyticRuleObject38": {
      "analyticRuleVersion38": "1.0.1",
      "_analyticRulecontentId38": "4bd9ce9d-8586-4beb-8fdb-bd018cacbe7d",
      "analyticRuleId38": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4bd9ce9d-8586-4beb-8fdb-bd018cacbe7d')]",
      "analyticRuleTemplateSpecName38": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('4bd9ce9d-8586-4beb-8fdb-bd018cacbe7d')))]",
      "_analyticRulecontentProductId38": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','4bd9ce9d-8586-4beb-8fdb-bd018cacbe7d','-', '1.0.1')))]"
    },
    "analyticRuleObject39": {
      "analyticRuleVersion39": "1.0.0",
      "_analyticRulecontentId39": "ba9db6b2-3d05-42ae-8aee-3a15bbe29f27",
      "analyticRuleId39": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'ba9db6b2-3d05-42ae-8aee-3a15bbe29f27')]",
      "analyticRuleTemplateSpecName39": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('ba9db6b2-3d05-42ae-8aee-3a15bbe29f27')))]",
      "_analyticRulecontentProductId39": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','ba9db6b2-3d05-42ae-8aee-3a15bbe29f27','-', '1.0.0')))]"
    },
    "analyticRuleObject40": {
      "analyticRuleVersion40": "1.0.0",
      "_analyticRulecontentId40": "28c63a44-2d35-48b7-831b-3ed24af17c7e",
      "analyticRuleId40": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '28c63a44-2d35-48b7-831b-3ed24af17c7e')]",
      "analyticRuleTemplateSpecName40": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('28c63a44-2d35-48b7-831b-3ed24af17c7e')))]",
      "_analyticRulecontentProductId40": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','28c63a44-2d35-48b7-831b-3ed24af17c7e','-', '1.0.0')))]"
    },
    "huntingQueryObject1": {
      "huntingQueryVersion1": "1.1.0",
      "_huntingQuerycontentId1": "cdac93ef-56c0-45bf-9e7f-9cbf0ad06808",
      "huntingQueryTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('cdac93ef-56c0-45bf-9e7f-9cbf0ad06808')))]"
    },
    "huntingQueryObject2": {
      "huntingQueryVersion2": "1.0.0",
      "_huntingQuerycontentId2": "4d11f63f-5b64-416e-8d77-266e4c6d382e",
      "huntingQueryTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('4d11f63f-5b64-416e-8d77-266e4c6d382e')))]"
    },
    "huntingQueryObject3": {
      "huntingQueryVersion3": "1.0.0",
      "_huntingQuerycontentId3": "d7b7dcad-d806-4a61-b8fc-0d7c9c45bdec",
      "huntingQueryTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('d7b7dcad-d806-4a61-b8fc-0d7c9c45bdec')))]"
    },
    "huntingQueryObject4": {
      "huntingQueryVersion4": "1.0.0",
      "_huntingQuerycontentId4": "fe9edc77-1b6c-4f1e-a223-64b580b50187",
      "huntingQueryTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('fe9edc77-1b6c-4f1e-a223-64b580b50187')))]"
    },
    "huntingQueryObject5": {
      "huntingQueryVersion5": "1.0.0",
      "_huntingQuerycontentId5": "147c4c0a-7241-4ce9-9b71-0aecb8a2b59f",
      "huntingQueryTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('147c4c0a-7241-4ce9-9b71-0aecb8a2b59f')))]"
    },
    "huntingQueryObject6": {
      "huntingQueryVersion6": "1.0.0",
      "_huntingQuerycontentId6": "8fe88892-3a55-4220-9141-939a8e7a15c5",
      "huntingQueryTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8fe88892-3a55-4220-9141-939a8e7a15c5')))]"
    },
    "huntingQueryObject7": {
      "huntingQueryVersion7": "1.0.0",
      "_huntingQuerycontentId7": "e7791695-c103-4d20-a75a-53e90788616b",
      "huntingQueryTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('e7791695-c103-4d20-a75a-53e90788616b')))]"
    },
    "huntingQueryObject8": {
      "huntingQueryVersion8": "1.0.0",
      "_huntingQuerycontentId8": "846bf25e-3d2d-4122-9b60-adfadd2fc616",
      "huntingQueryTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('846bf25e-3d2d-4122-9b60-adfadd2fc616')))]"
    },
    "huntingQueryObject9": {
      "huntingQueryVersion9": "1.0.0",
      "_huntingQuerycontentId9": "1850a459-b009-43d0-a575-8284b737eef8",
      "huntingQueryTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('1850a459-b009-43d0-a575-8284b737eef8')))]"
    },
    "huntingQueryObject10": {
      "huntingQueryVersion10": "1.0.0",
      "_huntingQuerycontentId10": "d6991ef1-b225-4780-b6a6-cfe9b5278f5e",
      "huntingQueryTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('d6991ef1-b225-4780-b6a6-cfe9b5278f5e')))]"
    },
    "huntingQueryObject11": {
      "huntingQueryVersion11": "1.0.0",
      "_huntingQuerycontentId11": "4713d763-122d-419c-bf6f-bdef111cd8e2",
      "huntingQueryTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('4713d763-122d-419c-bf6f-bdef111cd8e2')))]"
    },
    "huntingQueryObject12": {
      "huntingQueryVersion12": "1.0.0",
      "_huntingQuerycontentId12": "b3470e40-39ae-4c28-9282-440038f6f964",
      "huntingQueryTemplateSpecName12": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b3470e40-39ae-4c28-9282-440038f6f964')))]"
    },
    "huntingQueryObject13": {
      "huntingQueryVersion13": "1.0.0",
      "_huntingQuerycontentId13": "a18e8bcf-e05d-4e45-bc6e-2c5004729fbd",
      "huntingQueryTemplateSpecName13": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a18e8bcf-e05d-4e45-bc6e-2c5004729fbd')))]"
    },
    "huntingQueryObject14": {
      "huntingQueryVersion14": "1.1.0",
      "_huntingQuerycontentId14": "cdac93ef-56c0-45bf-9e7f-9cbf0ad034234",
      "huntingQueryTemplateSpecName14": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('cdac93ef-56c0-45bf-9e7f-9cbf0ad034234')))]"
    },
    "huntingQueryObject15": {
      "huntingQueryVersion15": "1.0.0",
      "_huntingQuerycontentId15": "f78255b6-8f91-4cf3-a25c-e1144b7b5425",
      "huntingQueryTemplateSpecName15": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f78255b6-8f91-4cf3-a25c-e1144b7b5425')))]"
    },
    "huntingQueryObject16": {
      "huntingQueryVersion16": "1.0.0",
      "_huntingQuerycontentId16": "76c14475-9a22-4cc1-922c-437d7f614a36",
      "huntingQueryTemplateSpecName16": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('76c14475-9a22-4cc1-922c-437d7f614a36')))]"
    },
    "huntingQueryObject17": {
      "huntingQueryVersion17": "1.0.0",
      "_huntingQuerycontentId17": "89b31213-4350-4730-8d27-26667ce53894",
      "huntingQueryTemplateSpecName17": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('89b31213-4350-4730-8d27-26667ce53894')))]"
    },
    "huntingQueryObject18": {
      "huntingQueryVersion18": "1.0.0",
      "_huntingQuerycontentId18": "79f9bb6b-6d31-412e-b3bc-6e5ad1303112",
      "huntingQueryTemplateSpecName18": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('79f9bb6b-6d31-412e-b3bc-6e5ad1303112')))]"
    },
    "huntingQueryObject19": {
      "huntingQueryVersion19": "1.0.0",
      "_huntingQuerycontentId19": "0b985ed8-aacd-41ba-9b17-489be9224159",
      "huntingQueryTemplateSpecName19": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0b985ed8-aacd-41ba-9b17-489be9224159')))]"
    },
    "huntingQueryObject20": {
      "huntingQueryVersion20": "1.0.0",
      "_huntingQuerycontentId20": "6284b962-ab0d-46d8-a47f-1eb1ac1be463",
      "huntingQueryTemplateSpecName20": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('6284b962-ab0d-46d8-a47f-1eb1ac1be463')))]"
    },
    "huntingQueryObject21": {
      "huntingQueryVersion21": "1.0.0",
      "_huntingQuerycontentId21": "abf42310-51c7-4d7f-98d2-e5af09859aab",
      "huntingQueryTemplateSpecName21": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('abf42310-51c7-4d7f-98d2-e5af09859aab')))]"
    },
    "huntingQueryObject22": {
      "huntingQueryVersion22": "1.0.0",
      "_huntingQuerycontentId22": "63ecff0f-3a86-468b-8c9e-a7a88fe33ebb",
      "huntingQueryTemplateSpecName22": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('63ecff0f-3a86-468b-8c9e-a7a88fe33ebb')))]"
    },
    "huntingQueryObject23": {
      "huntingQueryVersion23": "1.0.0",
      "_huntingQuerycontentId23": "b1f8aac2-766d-47ec-8787-84bc7692ff77",
      "huntingQueryTemplateSpecName23": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b1f8aac2-766d-47ec-8787-84bc7692ff77')))]"
    },
    "huntingQueryObject24": {
      "huntingQueryVersion24": "1.0.0",
      "_huntingQuerycontentId24": "54ea2379-28e7-48e1-8dfd-aaf8fb1331ba",
      "huntingQueryTemplateSpecName24": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('54ea2379-28e7-48e1-8dfd-aaf8fb1331ba')))]"
    },
    "huntingQueryObject25": {
      "huntingQueryVersion25": "1.0.1",
      "_huntingQuerycontentId25": "cdac93ef-56c0-45bf-9e7f-9cbf0ad06567",
      "huntingQueryTemplateSpecName25": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('cdac93ef-56c0-45bf-9e7f-9cbf0ad06567')))]"
    },
    "huntingQueryObject26": {
      "huntingQueryVersion26": "1.0.0",
      "_huntingQuerycontentId26": "fa2f7d8a-6726-465a-aa72-6f6e3d4c99d7",
      "huntingQueryTemplateSpecName26": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('fa2f7d8a-6726-465a-aa72-6f6e3d4c99d7')))]"
    },
    "huntingQueryObject27": {
      "huntingQueryVersion27": "1.0.0",
      "_huntingQuerycontentId27": "29683151-e15d-4c0c-845b-892be89bf080",
      "huntingQueryTemplateSpecName27": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('29683151-e15d-4c0c-845b-892be89bf080')))]"
    },
    "huntingQueryObject28": {
      "huntingQueryVersion28": "1.0.0",
      "_huntingQuerycontentId28": "518e6938-10ef-4165-af19-82f1287141bc",
      "huntingQueryTemplateSpecName28": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('518e6938-10ef-4165-af19-82f1287141bc')))]"
    },
    "huntingQueryObject29": {
      "huntingQueryVersion29": "1.0.0",
      "_huntingQuerycontentId29": "b6392f39-a1f4-4ec8-8689-4cb9d28c295a",
      "huntingQueryTemplateSpecName29": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b6392f39-a1f4-4ec8-8689-4cb9d28c295a')))]"
    },
    "huntingQueryObject30": {
      "huntingQueryVersion30": "1.0.0",
      "_huntingQuerycontentId30": "16eda414-1550-4cdc-8512-0769901d3f05",
      "huntingQueryTemplateSpecName30": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('16eda414-1550-4cdc-8512-0769901d3f05')))]"
    },
    "huntingQueryObject31": {
      "huntingQueryVersion31": "1.0.0",
      "_huntingQuerycontentId31": "7fbf7687-5ded-4c39-9fe9-f4f6aa6fc422",
      "huntingQueryTemplateSpecName31": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('7fbf7687-5ded-4c39-9fe9-f4f6aa6fc422')))]"
    },
    "huntingQueryObject32": {
      "huntingQueryVersion32": "1.0.0",
      "_huntingQuerycontentId32": "eb560458-d96f-4c68-acbb-14b3c706ebe7",
      "huntingQueryTemplateSpecName32": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('eb560458-d96f-4c68-acbb-14b3c706ebe7')))]"
    },
    "huntingQueryObject33": {
      "huntingQueryVersion33": "1.0.0",
      "_huntingQuerycontentId33": "14d47b2a-62b3-4c7b-819c-699e264c581d",
      "huntingQueryTemplateSpecName33": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('14d47b2a-62b3-4c7b-819c-699e264c581d')))]"
    },
    "huntingQueryObject34": {
      "huntingQueryVersion34": "1.0.0",
      "_huntingQuerycontentId34": "62d6a2e6-4583-4538-a476-a5b3c672657b",
      "huntingQueryTemplateSpecName34": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('62d6a2e6-4583-4538-a476-a5b3c672657b')))]"
    },
    "huntingQueryObject35": {
      "huntingQueryVersion35": "1.0.0",
      "_huntingQuerycontentId35": "79755078-7be8-4f13-a8e7-1ce87cb7d5c0",
      "huntingQueryTemplateSpecName35": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('79755078-7be8-4f13-a8e7-1ce87cb7d5c0')))]"
    },
    "huntingQueryObject36": {
      "huntingQueryVersion36": "1.0.0",
      "_huntingQuerycontentId36": "5971f2e7-1bb2-4170-aa7a-577ed8a45c72",
      "huntingQueryTemplateSpecName36": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('5971f2e7-1bb2-4170-aa7a-577ed8a45c72')))]"
    },
    "huntingQueryObject37": {
      "huntingQueryVersion37": "1.0.0",
      "_huntingQuerycontentId37": "3dbaa9c1-5e69-40a9-bacb-8cbdb4a0e6cb",
      "huntingQueryTemplateSpecName37": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('3dbaa9c1-5e69-40a9-bacb-8cbdb4a0e6cb')))]"
    },
    "huntingQueryObject38": {
      "huntingQueryVersion38": "1.0.0",
      "_huntingQuerycontentId38": "23b646e8-b885-4cde-a9ab-1e35fa5e37a7",
      "huntingQueryTemplateSpecName38": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('23b646e8-b885-4cde-a9ab-1e35fa5e37a7')))]"
    },
    "huntingQueryObject39": {
      "huntingQueryVersion39": "1.0.0",
      "_huntingQuerycontentId39": "ba97d6b9-f82e-4917-9c07-4c0028bbd32d",
      "huntingQueryTemplateSpecName39": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('ba97d6b9-f82e-4917-9c07-4c0028bbd32d')))]"
    },
    "huntingQueryObject40": {
      "huntingQueryVersion40": "1.0.0",
      "_huntingQuerycontentId40": "4c021477-38f0-409e-869b-11056fcd47f1",
      "huntingQueryTemplateSpecName40": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('4c021477-38f0-409e-869b-11056fcd47f1')))]"
    },
    "huntingQueryObject41": {
      "huntingQueryVersion41": "1.0.0",
      "_huntingQuerycontentId41": "a8c66aec-2000-45d8-8481-36aaa17f1033",
      "huntingQueryTemplateSpecName41": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a8c66aec-2000-45d8-8481-36aaa17f1033')))]"
    },
    "huntingQueryObject42": {
      "huntingQueryVersion42": "1.0.0",
      "_huntingQuerycontentId42": "08113d6f-3c95-45ba-94df-4fdd7f35d944",
      "huntingQueryTemplateSpecName42": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('08113d6f-3c95-45ba-94df-4fdd7f35d944')))]"
    },
    "huntingQueryObject43": {
      "huntingQueryVersion43": "1.0.0",
      "_huntingQuerycontentId43": "1b56831b-3713-4c9c-ac75-a7e330623076",
      "huntingQueryTemplateSpecName43": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('1b56831b-3713-4c9c-ac75-a7e330623076')))]"
    },
    "huntingQueryObject44": {
      "huntingQueryVersion44": "1.0.0",
      "_huntingQuerycontentId44": "ba1a91ad-1f99-4386-b191-06a76ef213f8",
      "huntingQueryTemplateSpecName44": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('ba1a91ad-1f99-4386-b191-06a76ef213f8')))]"
    },
    "huntingQueryObject45": {
      "huntingQueryVersion45": "1.0.0",
      "_huntingQuerycontentId45": "242561f3-568a-4864-be15-fbc85b2e77f9",
      "huntingQueryTemplateSpecName45": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('242561f3-568a-4864-be15-fbc85b2e77f9')))]"
    },
    "huntingQueryObject46": {
      "huntingQueryVersion46": "1.0.0",
      "_huntingQuerycontentId46": "ff56a21d-fc95-4c11-8f9d-cc59c48cd4e6",
      "huntingQueryTemplateSpecName46": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('ff56a21d-fc95-4c11-8f9d-cc59c48cd4e6')))]"
    },
    "huntingQueryObject47": {
      "huntingQueryVersion47": "1.0.0",
      "_huntingQuerycontentId47": "0d5ae69d-bdb2-404d-8c8c-50ebe68b6a5b",
      "huntingQueryTemplateSpecName47": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0d5ae69d-bdb2-404d-8c8c-50ebe68b6a5b')))]"
    },
    "huntingQueryObject48": {
      "huntingQueryVersion48": "1.0.0",
      "_huntingQuerycontentId48": "e55e178e-48ba-4313-918a-2d3e16a95441",
      "huntingQueryTemplateSpecName48": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('e55e178e-48ba-4313-918a-2d3e16a95441')))]"
    },
    "huntingQueryObject49": {
      "huntingQueryVersion49": "1.0.0",
      "_huntingQuerycontentId49": "bc2d8214-afb6-4876-b210-25b69325b9b2",
      "huntingQueryTemplateSpecName49": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('bc2d8214-afb6-4876-b210-25b69325b9b2')))]"
    },
    "huntingQueryObject50": {
      "huntingQueryVersion50": "1.0.0",
      "_huntingQuerycontentId50": "712ffdd8-ddce-4372-85dd-063029b418cf",
      "huntingQueryTemplateSpecName50": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('712ffdd8-ddce-4372-85dd-063029b418cf')))]"
    },
    "huntingQueryObject51": {
      "huntingQueryVersion51": "1.0.0",
      "_huntingQuerycontentId51": "81ede5df-2ec3-40a5-9dff-1fe6a841079d",
      "huntingQueryTemplateSpecName51": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('81ede5df-2ec3-40a5-9dff-1fe6a841079d')))]"
    },
    "huntingQueryObject52": {
      "huntingQueryVersion52": "1.0.0",
      "_huntingQuerycontentId52": "63c799bc-7567-4e4d-97be-e143fcfaa333",
      "huntingQueryTemplateSpecName52": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('63c799bc-7567-4e4d-97be-e143fcfaa333')))]"
    },
    "huntingQueryObject53": {
      "huntingQueryVersion53": "1.0.0",
      "_huntingQuerycontentId53": "deb4b2c6-c10e-4044-8cf4-84243e40db73",
      "huntingQueryTemplateSpecName53": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('deb4b2c6-c10e-4044-8cf4-84243e40db73')))]"
    },
    "huntingQueryObject54": {
      "huntingQueryVersion54": "1.0.0",
      "_huntingQuerycontentId54": "92b76a34-502e-4a53-93ec-9fc37c3b358c",
      "huntingQueryTemplateSpecName54": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('92b76a34-502e-4a53-93ec-9fc37c3b358c')))]"
    },
    "huntingQueryObject55": {
      "huntingQueryVersion55": "1.0.0",
      "_huntingQuerycontentId55": "af183f01-6d98-4fca-8ca4-63577b78a26e",
      "huntingQueryTemplateSpecName55": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('af183f01-6d98-4fca-8ca4-63577b78a26e')))]"
    },
    "huntingQueryObject56": {
      "huntingQueryVersion56": "1.0.0",
      "_huntingQuerycontentId56": "530ef5e4-7ee4-4d70-a8e2-a06459605c02",
      "huntingQueryTemplateSpecName56": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('530ef5e4-7ee4-4d70-a8e2-a06459605c02')))]"
    },
    "huntingQueryObject57": {
      "huntingQueryVersion57": "1.0.0",
      "_huntingQuerycontentId57": "db9789ab-0636-4ea6-b779-1b72b4b64aac",
      "huntingQueryTemplateSpecName57": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('db9789ab-0636-4ea6-b779-1b72b4b64aac')))]"
    },
    "huntingQueryObject58": {
      "huntingQueryVersion58": "1.0.0",
      "_huntingQuerycontentId58": "86c7d21b-2081-419d-bc2e-7bc909d61eef",
      "huntingQueryTemplateSpecName58": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('86c7d21b-2081-419d-bc2e-7bc909d61eef')))]"
    },
    "huntingQueryObject59": {
      "huntingQueryVersion59": "1.0.0",
      "_huntingQuerycontentId59": "6f606826-b995-4a8d-8c2c-ee08e3d1194a",
      "huntingQueryTemplateSpecName59": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('6f606826-b995-4a8d-8c2c-ee08e3d1194a')))]"
    },
    "huntingQueryObject60": {
      "huntingQueryVersion60": "1.0.0",
      "_huntingQuerycontentId60": "b8330f6e-fc47-40ce-b225-5d3b055c6446",
      "huntingQueryTemplateSpecName60": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b8330f6e-fc47-40ce-b225-5d3b055c6446')))]"
    },
    "huntingQueryObject61": {
      "huntingQueryVersion61": "1.0.0",
      "_huntingQuerycontentId61": "7d7a3d3f-22db-4cdf-ba67-c57215777a3c",
      "huntingQueryTemplateSpecName61": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('7d7a3d3f-22db-4cdf-ba67-c57215777a3c')))]"
    },
    "huntingQueryObject62": {
      "huntingQueryVersion62": "1.0.0",
      "_huntingQuerycontentId62": "eb0e4edb-f423-49f8-a02a-4ededdd30dd5",
      "huntingQueryTemplateSpecName62": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('eb0e4edb-f423-49f8-a02a-4ededdd30dd5')))]"
    },
    "huntingQueryObject63": {
      "huntingQueryVersion63": "1.0.0",
      "_huntingQuerycontentId63": "0717b136-a1ef-4af0-a911-e189d0064099",
      "huntingQueryTemplateSpecName63": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0717b136-a1ef-4af0-a911-e189d0064099')))]"
    },
    "huntingQueryObject64": {
      "huntingQueryVersion64": "1.0.0",
      "_huntingQuerycontentId64": "0955f477-6471-468a-9b13-fc5fa96d7db2",
      "huntingQueryTemplateSpecName64": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0955f477-6471-468a-9b13-fc5fa96d7db2')))]"
    },
    "huntingQueryObject65": {
      "huntingQueryVersion65": "1.0.0",
      "_huntingQuerycontentId65": "85dea577-1c76-44ff-8cad-b47182874ddb",
      "huntingQueryTemplateSpecName65": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('85dea577-1c76-44ff-8cad-b47182874ddb')))]"
    },
    "huntingQueryObject66": {
      "huntingQueryVersion66": "1.0.0",
      "_huntingQuerycontentId66": "da745698-da8a-40c5-b527-2e9328c2cefe",
      "huntingQueryTemplateSpecName66": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('da745698-da8a-40c5-b527-2e9328c2cefe')))]"
    },
    "huntingQueryObject67": {
      "huntingQueryVersion67": "1.0.0",
      "_huntingQuerycontentId67": "c1cac5ad-7aaa-40de-89aa-954f5a33a578",
      "huntingQueryTemplateSpecName67": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('c1cac5ad-7aaa-40de-89aa-954f5a33a578')))]"
    },
    "huntingQueryObject68": {
      "huntingQueryVersion68": "1.0.0",
      "_huntingQuerycontentId68": "8e9a96dd-f85d-4f5e-a65f-dcc55d6d9935",
      "huntingQueryTemplateSpecName68": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8e9a96dd-f85d-4f5e-a65f-dcc55d6d9935')))]"
    },
    "huntingQueryObject69": {
      "huntingQueryVersion69": "1.0.0",
      "_huntingQuerycontentId69": "11cc0e3f-9718-4ab5-be7b-d9c036ed6b0a",
      "huntingQueryTemplateSpecName69": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('11cc0e3f-9718-4ab5-be7b-d9c036ed6b0a')))]"
    },
    "huntingQueryObject70": {
      "huntingQueryVersion70": "1.0.0",
      "_huntingQuerycontentId70": "e6259b03-622e-4e11-9c54-94987dad7c14",
      "huntingQueryTemplateSpecName70": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('e6259b03-622e-4e11-9c54-94987dad7c14')))]"
    },
    "huntingQueryObject71": {
      "huntingQueryVersion71": "1.0.0",
      "_huntingQuerycontentId71": "dd4a480b-aa24-4b62-b1f3-f538d8abbdfb",
      "huntingQueryTemplateSpecName71": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('dd4a480b-aa24-4b62-b1f3-f538d8abbdfb')))]"
    },
    "huntingQueryObject72": {
      "huntingQueryVersion72": "1.0.0",
      "_huntingQuerycontentId72": "fb46ca1b-0b46-4d9c-b3b3-2f8f807e9f72",
      "huntingQueryTemplateSpecName72": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('fb46ca1b-0b46-4d9c-b3b3-2f8f807e9f72')))]"
    },
    "huntingQueryObject73": {
      "huntingQueryVersion73": "1.0.0",
      "_huntingQuerycontentId73": "0da830c3-5d0e-4b98-bfa1-d5131a8d0ebe",
      "huntingQueryTemplateSpecName73": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0da830c3-5d0e-4b98-bfa1-d5131a8d0ebe')))]"
    },
    "huntingQueryObject74": {
      "huntingQueryVersion74": "1.0.0",
      "_huntingQuerycontentId74": "57f95ba7-938d-4a76-b411-c01034c0d167",
      "huntingQueryTemplateSpecName74": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('57f95ba7-938d-4a76-b411-c01034c0d167')))]"
    },
    "huntingQueryObject75": {
      "huntingQueryVersion75": "1.0.0",
      "_huntingQuerycontentId75": "54569b06-47fc-41ae-9b00-f7d9b61337b6",
      "huntingQueryTemplateSpecName75": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('54569b06-47fc-41ae-9b00-f7d9b61337b6')))]"
    },
    "huntingQueryObject76": {
      "huntingQueryVersion76": "1.0.0",
      "_huntingQuerycontentId76": "430a9c0d-f3ce-46a3-a994-92b3ada0d1b2",
      "huntingQueryTemplateSpecName76": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('430a9c0d-f3ce-46a3-a994-92b3ada0d1b2')))]"
    },
    "huntingQueryObject77": {
      "huntingQueryVersion77": "1.0.0",
      "_huntingQuerycontentId77": "f840db5b-87c9-43c8-a8c3-5b6b83838cd4",
      "huntingQueryTemplateSpecName77": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f840db5b-87c9-43c8-a8c3-5b6b83838cd4')))]"
    },
    "huntingQueryObject78": {
      "huntingQueryVersion78": "1.0.0",
      "_huntingQuerycontentId78": "b95994d1-1008-4c42-a74f-9f2967e39ed6",
      "huntingQueryTemplateSpecName78": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b95994d1-1008-4c42-a74f-9f2967e39ed6')))]"
    },
    "huntingQueryObject79": {
      "huntingQueryVersion79": "1.0.0",
      "_huntingQuerycontentId79": "a96c1571-1f7d-48dc-8287-7df5a5f0d987",
      "huntingQueryTemplateSpecName79": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a96c1571-1f7d-48dc-8287-7df5a5f0d987')))]"
    },
    "huntingQueryObject80": {
      "huntingQueryVersion80": "1.0.0",
      "_huntingQuerycontentId80": "2c6e7f75-d83c-4344-afdc-83335fe550e6",
      "huntingQueryTemplateSpecName80": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('2c6e7f75-d83c-4344-afdc-83335fe550e6')))]"
    },
    "huntingQueryObject81": {
      "huntingQueryVersion81": "1.0.0",
      "_huntingQuerycontentId81": "38d6e2fb-a804-4170-8d32-d251ecd6bcd2",
      "huntingQueryTemplateSpecName81": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('38d6e2fb-a804-4170-8d32-d251ecd6bcd2')))]"
    },
    "huntingQueryObject82": {
      "huntingQueryVersion82": "1.0.0",
      "_huntingQuerycontentId82": "1c51e10e-7f77-40bc-bd37-6aa55cdf94d6",
      "huntingQueryTemplateSpecName82": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('1c51e10e-7f77-40bc-bd37-6aa55cdf94d6')))]"
    },
    "huntingQueryObject83": {
      "huntingQueryVersion83": "1.0.0",
      "_huntingQuerycontentId83": "da7b973a-0045-4fd6-9161-269369336d24",
      "huntingQueryTemplateSpecName83": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('da7b973a-0045-4fd6-9161-269369336d24')))]"
    },
    "huntingQueryObject84": {
      "huntingQueryVersion84": "1.0.0",
      "_huntingQuerycontentId84": "6b478186-da3b-4d71-beaa-aa5b42908499",
      "huntingQueryTemplateSpecName84": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('6b478186-da3b-4d71-beaa-aa5b42908499')))]"
    },
    "huntingQueryObject85": {
      "huntingQueryVersion85": "1.0.0",
      "_huntingQuerycontentId85": "da932998-81dd-4be4-963c-f4890cb4192e",
      "huntingQueryTemplateSpecName85": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('da932998-81dd-4be4-963c-f4890cb4192e')))]"
    },
    "huntingQueryObject86": {
      "huntingQueryVersion86": "1.0.0",
      "_huntingQuerycontentId86": "b2beec6a-2c1c-4319-a191-e70c2ee42857",
      "huntingQueryTemplateSpecName86": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b2beec6a-2c1c-4319-a191-e70c2ee42857')))]"
    },
    "huntingQueryObject87": {
      "huntingQueryVersion87": "1.0.0",
      "_huntingQuerycontentId87": "45c47684-6650-44b6-81c0-951522d0c435",
      "huntingQueryTemplateSpecName87": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('45c47684-6650-44b6-81c0-951522d0c435')))]"
    },
    "huntingQueryObject88": {
      "huntingQueryVersion88": "1.0.0",
      "_huntingQuerycontentId88": "99e1246e-c1a9-4794-8e96-eb906c73c529",
      "huntingQueryTemplateSpecName88": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('99e1246e-c1a9-4794-8e96-eb906c73c529')))]"
    },
    "huntingQueryObject89": {
      "huntingQueryVersion89": "1.0.0",
      "_huntingQuerycontentId89": "12225f50-9d41-4b78-8269-cc127d98654c",
      "huntingQueryTemplateSpecName89": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('12225f50-9d41-4b78-8269-cc127d98654c')))]"
    },
    "huntingQueryObject90": {
      "huntingQueryVersion90": "1.0.0",
      "_huntingQuerycontentId90": "cadf6e78-2a9a-4fb5-b788-30a592d699d3",
      "huntingQueryTemplateSpecName90": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('cadf6e78-2a9a-4fb5-b788-30a592d699d3')))]"
    },
    "huntingQueryObject91": {
      "huntingQueryVersion91": "1.0.0",
      "_huntingQuerycontentId91": "95b0c7ed-2853-4343-80a9-ab076cf31e51",
      "huntingQueryTemplateSpecName91": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('95b0c7ed-2853-4343-80a9-ab076cf31e51')))]"
    },
    "huntingQueryObject92": {
      "huntingQueryVersion92": "1.0.0",
      "_huntingQuerycontentId92": "439f817c-845c-4dda-a8d9-5c1f6831cee9",
      "huntingQueryTemplateSpecName92": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('439f817c-845c-4dda-a8d9-5c1f6831cee9')))]"
    },
    "huntingQueryObject93": {
      "huntingQueryVersion93": "1.0.0",
      "_huntingQuerycontentId93": "07c85687-6dee-4266-9345-1e34de85d989",
      "huntingQueryTemplateSpecName93": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('07c85687-6dee-4266-9345-1e34de85d989')))]"
    },
    "huntingQueryObject94": {
      "huntingQueryVersion94": "1.0.0",
      "_huntingQuerycontentId94": "23dbd58b-23ce-42ae-b4d1-0dfdd35871ea",
      "huntingQueryTemplateSpecName94": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('23dbd58b-23ce-42ae-b4d1-0dfdd35871ea')))]"
    },
    "huntingQueryObject95": {
      "huntingQueryVersion95": "1.0.0",
      "_huntingQuerycontentId95": "817043be-4b30-4e66-a742-8f601a78b08f",
      "huntingQueryTemplateSpecName95": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('817043be-4b30-4e66-a742-8f601a78b08f')))]"
    },
    "huntingQueryObject96": {
      "huntingQueryVersion96": "1.0.0",
      "_huntingQuerycontentId96": "a924de5a-89ce-43c7-8adc-b130e5f1924c",
      "huntingQueryTemplateSpecName96": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a924de5a-89ce-43c7-8adc-b130e5f1924c')))]"
    },
    "huntingQueryObject97": {
      "huntingQueryVersion97": "1.0.0",
      "_huntingQuerycontentId97": "2de2de5d-87a3-4e13-9b97-5f42e44d0954",
      "huntingQueryTemplateSpecName97": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('2de2de5d-87a3-4e13-9b97-5f42e44d0954')))]"
    },
    "huntingQueryObject98": {
      "huntingQueryVersion98": "1.0.0",
      "_huntingQuerycontentId98": "e1dbe1d2-785a-4ecd-a1c0-233fc0e990bc",
      "huntingQueryTemplateSpecName98": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('e1dbe1d2-785a-4ecd-a1c0-233fc0e990bc')))]"
    },
    "huntingQueryObject99": {
      "huntingQueryVersion99": "1.0.0",
      "_huntingQuerycontentId99": "b3a4b803-06f6-46d8-9220-b3a53e85ce4f",
      "huntingQueryTemplateSpecName99": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b3a4b803-06f6-46d8-9220-b3a53e85ce4f')))]"
    },
    "huntingQueryObject100": {
      "huntingQueryVersion100": "1.0.0",
      "_huntingQuerycontentId100": "db79eb5a-785a-400a-a7ef-7285dde8e116",
      "huntingQueryTemplateSpecName100": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('db79eb5a-785a-400a-a7ef-7285dde8e116')))]"
    },
    "huntingQueryObject101": {
      "huntingQueryVersion101": "1.0.0",
      "_huntingQuerycontentId101": "15d255f7-57a6-4b23-bd89-376930d3a305",
      "huntingQueryTemplateSpecName101": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('15d255f7-57a6-4b23-bd89-376930d3a305')))]"
    },
    "huntingQueryObject102": {
      "huntingQueryVersion102": "1.0.0",
      "_huntingQuerycontentId102": "ef29d6b6-9192-46aa-b16a-082c2da2f78f",
      "huntingQueryTemplateSpecName102": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('ef29d6b6-9192-46aa-b16a-082c2da2f78f')))]"
    },
    "huntingQueryObject103": {
      "huntingQueryVersion103": "1.0.0",
      "_huntingQuerycontentId103": "af541ae2-9bb4-4737-a8ea-4fa261bc3866",
      "huntingQueryTemplateSpecName103": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('af541ae2-9bb4-4737-a8ea-4fa261bc3866')))]"
    },
    "huntingQueryObject104": {
      "huntingQueryVersion104": "1.0.0",
      "_huntingQuerycontentId104": "a2a7bede-cf55-47ed-9aeb-7b4c97079f4f",
      "huntingQueryTemplateSpecName104": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a2a7bede-cf55-47ed-9aeb-7b4c97079f4f')))]"
    },
    "huntingQueryObject105": {
      "huntingQueryVersion105": "1.0.0",
      "_huntingQuerycontentId105": "0d16e85e-82ec-460a-bf48-e90164464f7c",
      "huntingQueryTemplateSpecName105": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0d16e85e-82ec-460a-bf48-e90164464f7c')))]"
    },
    "huntingQueryObject106": {
      "huntingQueryVersion106": "1.0.0",
      "_huntingQuerycontentId106": "c6bbcac2-a6b8-4537-a32a-6f1367e6aa44",
      "huntingQueryTemplateSpecName106": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('c6bbcac2-a6b8-4537-a32a-6f1367e6aa44')))]"
    },
    "huntingQueryObject107": {
      "huntingQueryVersion107": "1.0.0",
      "_huntingQuerycontentId107": "a370ad6f-e7fa-4740-ab9e-cb5560e3599f",
      "huntingQueryTemplateSpecName107": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a370ad6f-e7fa-4740-ab9e-cb5560e3599f')))]"
    },
    "huntingQueryObject108": {
      "huntingQueryVersion108": "1.0.0",
      "_huntingQuerycontentId108": "c3a6f568-8200-4f2f-88b8-a4df5eb54ba9",
      "huntingQueryTemplateSpecName108": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('c3a6f568-8200-4f2f-88b8-a4df5eb54ba9')))]"
    },
    "huntingQueryObject109": {
      "huntingQueryVersion109": "1.0.0",
      "_huntingQuerycontentId109": "12eeae9e-8f0a-4b8c-b437-31c998f15af8",
      "huntingQueryTemplateSpecName109": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('12eeae9e-8f0a-4b8c-b437-31c998f15af8')))]"
    },
    "huntingQueryObject110": {
      "huntingQueryVersion110": "1.0.0",
      "_huntingQuerycontentId110": "18fee342-8209-4270-9198-711646867e71",
      "huntingQueryTemplateSpecName110": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('18fee342-8209-4270-9198-711646867e71')))]"
    },
    "huntingQueryObject111": {
      "huntingQueryVersion111": "1.0.0",
      "_huntingQuerycontentId111": "9cb4a6eb-c7ae-44ac-b12b-c16ec63da385",
      "huntingQueryTemplateSpecName111": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('9cb4a6eb-c7ae-44ac-b12b-c16ec63da385')))]"
    },
    "huntingQueryObject112": {
      "huntingQueryVersion112": "1.0.0",
      "_huntingQuerycontentId112": "28c79831-120c-4028-8a2b-4e4ae3082148",
      "huntingQueryTemplateSpecName112": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('28c79831-120c-4028-8a2b-4e4ae3082148')))]"
    },
    "huntingQueryObject113": {
      "huntingQueryVersion113": "1.0.0",
      "_huntingQuerycontentId113": "f304b75a-a2a0-45fb-814c-40b6e08211f0",
      "huntingQueryTemplateSpecName113": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f304b75a-a2a0-45fb-814c-40b6e08211f0')))]"
    },
    "huntingQueryObject114": {
      "huntingQueryVersion114": "1.0.0",
      "_huntingQuerycontentId114": "b3470167-2608-44a2-bd2f-8ebad88a27d5",
      "huntingQueryTemplateSpecName114": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b3470167-2608-44a2-bd2f-8ebad88a27d5')))]"
    },
    "huntingQueryObject115": {
      "huntingQueryVersion115": "1.0.0",
      "_huntingQuerycontentId115": "3cb281a9-34e5-4864-8303-6c07e096818b",
      "huntingQueryTemplateSpecName115": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('3cb281a9-34e5-4864-8303-6c07e096818b')))]"
    },
    "huntingQueryObject116": {
      "huntingQueryVersion116": "1.0.0",
      "_huntingQuerycontentId116": "b8eb3e2e-0f95-458e-b6d1-fe36a0ee8310",
      "huntingQueryTemplateSpecName116": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b8eb3e2e-0f95-458e-b6d1-fe36a0ee8310')))]"
    },
    "huntingQueryObject117": {
      "huntingQueryVersion117": "l.0.0",
      "_huntingQuerycontentId117": "dc230eec-acc2-482f-8601-25125c8ff122",
      "huntingQueryTemplateSpecName117": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('dc230eec-acc2-482f-8601-25125c8ff122')))]"
    },
    "huntingQueryObject118": {
      "huntingQueryVersion118": "l.0.0",
      "_huntingQuerycontentId118": "489ad959-48eb-4c34-bed6-764cfd39214d",
      "huntingQueryTemplateSpecName118": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('489ad959-48eb-4c34-bed6-764cfd39214d')))]"
    },
    "huntingQueryObject119": {
      "huntingQueryVersion119": "1.0.0",
      "_huntingQuerycontentId119": "f094e9f1-2d55-450d-af1a-0fdcd290f8c4",
      "huntingQueryTemplateSpecName119": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f094e9f1-2d55-450d-af1a-0fdcd290f8c4')))]"
    },
    "huntingQueryObject120": {
      "huntingQueryVersion120": "1.0.0",
      "_huntingQuerycontentId120": "01cf63bd-debd-4d03-847c-d19c31844501",
      "huntingQueryTemplateSpecName120": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('01cf63bd-debd-4d03-847c-d19c31844501')))]"
    },
    "huntingQueryObject121": {
      "huntingQueryVersion121": "1.0.0",
      "_huntingQuerycontentId121": "8d25156b-2ac4-4528-b1b1-f8427267f9f2",
      "huntingQueryTemplateSpecName121": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8d25156b-2ac4-4528-b1b1-f8427267f9f2')))]"
    },
    "huntingQueryObject122": {
      "huntingQueryVersion122": "1.0.0",
      "_huntingQuerycontentId122": "b2a36ca5-b6a4-4f27-a7d8-7f044885cccf",
      "huntingQueryTemplateSpecName122": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b2a36ca5-b6a4-4f27-a7d8-7f044885cccf')))]"
    },
    "huntingQueryObject123": {
      "huntingQueryVersion123": "1.0.0",
      "_huntingQuerycontentId123": "02bdbd93-02b7-40e4-9468-d501463e57af",
      "huntingQueryTemplateSpecName123": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('02bdbd93-02b7-40e4-9468-d501463e57af')))]"
    },
    "huntingQueryObject124": {
      "huntingQueryVersion124": "1.0.0",
      "_huntingQuerycontentId124": "fc47e222-c348-43ca-ba11-b4628fe243cd",
      "huntingQueryTemplateSpecName124": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('fc47e222-c348-43ca-ba11-b4628fe243cd')))]"
    },
    "huntingQueryObject125": {
      "huntingQueryVersion125": "1.0.0",
      "_huntingQuerycontentId125": "b2a6440b-6ebd-4d86-aa33-cfe11f9defcf",
      "huntingQueryTemplateSpecName125": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b2a6440b-6ebd-4d86-aa33-cfe11f9defcf')))]"
    },
    "huntingQueryObject126": {
      "huntingQueryVersion126": "1.0.0",
      "_huntingQuerycontentId126": "20c9d89a-ad65-48f4-ba14-605715af640a",
      "huntingQueryTemplateSpecName126": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('20c9d89a-ad65-48f4-ba14-605715af640a')))]"
    },
    "huntingQueryObject127": {
      "huntingQueryVersion127": "1.0.0",
      "_huntingQuerycontentId127": "71117505-5a71-431e-8605-8896960affe5",
      "huntingQueryTemplateSpecName127": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('71117505-5a71-431e-8605-8896960affe5')))]"
    },
    "huntingQueryObject128": {
      "huntingQueryVersion128": "1.0.0",
      "_huntingQuerycontentId128": "4684afc7-3d05-4ec1-8fb0-342707d0ac5d",
      "huntingQueryTemplateSpecName128": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('4684afc7-3d05-4ec1-8fb0-342707d0ac5d')))]"
    },
    "huntingQueryObject129": {
      "huntingQueryVersion129": "1.0.0",
      "_huntingQuerycontentId129": "45d955e0-0e34-4ce7-833d-c14b43d69677",
      "huntingQueryTemplateSpecName129": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('45d955e0-0e34-4ce7-833d-c14b43d69677')))]"
    },
    "huntingQueryObject130": {
      "huntingQueryVersion130": "1.0.0",
      "_huntingQuerycontentId130": "8b7a84e9-5831-4e90-9b98-bd57493c6cc9",
      "huntingQueryTemplateSpecName130": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8b7a84e9-5831-4e90-9b98-bd57493c6cc9')))]"
    },
    "huntingQueryObject131": {
      "huntingQueryVersion131": "1.0.0",
      "_huntingQuerycontentId131": "f6f317c4-8ebe-4f93-9068-720705a75c65",
      "huntingQueryTemplateSpecName131": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f6f317c4-8ebe-4f93-9068-720705a75c65')))]"
    },
    "huntingQueryObject132": {
      "huntingQueryVersion132": "1.0.0",
      "_huntingQuerycontentId132": "5515296b-8f4c-42f1-a5ad-0574fbf99f23",
      "huntingQueryTemplateSpecName132": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('5515296b-8f4c-42f1-a5ad-0574fbf99f23')))]"
    },
    "huntingQueryObject133": {
      "huntingQueryVersion133": "1.0.0",
      "_huntingQuerycontentId133": "abd7e757-7737-4c9f-af7a-92e87172ff4f",
      "huntingQueryTemplateSpecName133": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('abd7e757-7737-4c9f-af7a-92e87172ff4f')))]"
    },
    "huntingQueryObject134": {
      "huntingQueryVersion134": "1.0.0",
      "_huntingQuerycontentId134": "fea3f03b-0723-4f3e-9f6a-c8a6a67fbde0",
      "huntingQueryTemplateSpecName134": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('fea3f03b-0723-4f3e-9f6a-c8a6a67fbde0')))]"
    },
    "huntingQueryObject135": {
      "huntingQueryVersion135": "1.0.0",
      "_huntingQuerycontentId135": "008ff55b-0588-4d39-af03-c08f1bb519d7",
      "huntingQueryTemplateSpecName135": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('008ff55b-0588-4d39-af03-c08f1bb519d7')))]"
    },
    "huntingQueryObject136": {
      "huntingQueryVersion136": "1.0.0",
      "_huntingQuerycontentId136": "161b163c-0805-46fd-abda-2fe5f0a5185e",
      "huntingQueryTemplateSpecName136": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('161b163c-0805-46fd-abda-2fe5f0a5185e')))]"
    },
    "huntingQueryObject137": {
      "huntingQueryVersion137": "1.0.0",
      "_huntingQuerycontentId137": "68aaf2af-83ac-4f9e-9680-4050700b93f9",
      "huntingQueryTemplateSpecName137": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('68aaf2af-83ac-4f9e-9680-4050700b93f9')))]"
    },
    "huntingQueryObject138": {
      "huntingQueryVersion138": "l.0.0",
      "_huntingQuerycontentId138": "ace8e98a-660b-4fa9-a877-60644eb83344",
      "huntingQueryTemplateSpecName138": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('ace8e98a-660b-4fa9-a877-60644eb83344')))]"
    },
    "huntingQueryObject139": {
      "huntingQueryVersion139": "1.0.0",
      "_huntingQuerycontentId139": "b1fa5bb7-9c4e-4d4f-826a-afc1fbe8c2cf",
      "huntingQueryTemplateSpecName139": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b1fa5bb7-9c4e-4d4f-826a-afc1fbe8c2cf')))]"
    },
    "huntingQueryObject140": {
      "huntingQueryVersion140": "1.0.0",
      "_huntingQuerycontentId140": "8b3bd5c3-1f37-4131-8b3a-a0f6d540e56d",
      "huntingQueryTemplateSpecName140": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8b3bd5c3-1f37-4131-8b3a-a0f6d540e56d')))]"
    },
    "huntingQueryObject141": {
      "huntingQueryVersion141": "1.0.0",
      "_huntingQuerycontentId141": "511406e2-2bdf-4b4d-a436-17dadbf4829f",
      "huntingQueryTemplateSpecName141": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('511406e2-2bdf-4b4d-a436-17dadbf4829f')))]"
    },
    "huntingQueryObject142": {
      "huntingQueryVersion142": "1.0.0",
      "_huntingQuerycontentId142": "0bd46e27-9d5a-4abd-889b-829a8b4d29a4",
      "huntingQueryTemplateSpecName142": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0bd46e27-9d5a-4abd-889b-829a8b4d29a4')))]"
    },
    "huntingQueryObject143": {
      "huntingQueryVersion143": "l.0.0",
      "_huntingQuerycontentId143": "132dffdf-3ee0-4748-8509-fbd3a92e5c9f",
      "huntingQueryTemplateSpecName143": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('132dffdf-3ee0-4748-8509-fbd3a92e5c9f')))]"
    },
    "huntingQueryObject144": {
      "huntingQueryVersion144": "l.0.0",
      "_huntingQuerycontentId144": "bebb6652-3c52-4358-a946-ecd63cddf082",
      "huntingQueryTemplateSpecName144": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('bebb6652-3c52-4358-a946-ecd63cddf082')))]"
    },
    "huntingQueryObject145": {
      "huntingQueryVersion145": "l.0.0",
      "_huntingQuerycontentId145": "2d8448f5-c0a2-46d7-a004-e062970ccb7b",
      "huntingQueryTemplateSpecName145": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('2d8448f5-c0a2-46d7-a004-e062970ccb7b')))]"
    },
    "huntingQueryObject146": {
      "huntingQueryVersion146": "l.0.0",
      "_huntingQuerycontentId146": "49071a21-fbb6-472f-932f-5b6ca1a25883",
      "huntingQueryTemplateSpecName146": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('49071a21-fbb6-472f-932f-5b6ca1a25883')))]"
    },
    "huntingQueryObject147": {
      "huntingQueryVersion147": "l.0.0",
      "_huntingQuerycontentId147": "f82f3d63-b7f2-494d-8254-612405702dd4",
      "huntingQueryTemplateSpecName147": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f82f3d63-b7f2-494d-8254-612405702dd4')))]"
    },
    "huntingQueryObject148": {
      "huntingQueryVersion148": "1.0.0",
      "_huntingQuerycontentId148": "b3b507e9-9f92-4751-8463-fc77394fed91",
      "huntingQueryTemplateSpecName148": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b3b507e9-9f92-4751-8463-fc77394fed91')))]"
    },
    "huntingQueryObject149": {
      "huntingQueryVersion149": "l.0.0",
      "_huntingQuerycontentId149": "0a29c9f0-e8d4-4339-a196-52bb3a090a79",
      "huntingQueryTemplateSpecName149": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0a29c9f0-e8d4-4339-a196-52bb3a090a79')))]"
    },
    "huntingQueryObject150": {
      "huntingQueryVersion150": "l.0.0",
      "_huntingQuerycontentId150": "9ffbd78f-c87c-4fd2-96ec-fd46e27bbd21",
      "huntingQueryTemplateSpecName150": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('9ffbd78f-c87c-4fd2-96ec-fd46e27bbd21')))]"
    },
    "huntingQueryObject151": {
      "huntingQueryVersion151": "1.0.0",
      "_huntingQuerycontentId151": "ab2f1fd6-1023-425e-a429-ff74db5709be",
      "huntingQueryTemplateSpecName151": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('ab2f1fd6-1023-425e-a429-ff74db5709be')))]"
    },
    "huntingQueryObject152": {
      "huntingQueryVersion152": "1.0.0",
      "_huntingQuerycontentId152": "74b581fc-e8cb-4b50-9d82-7b91d3a88a08",
      "huntingQueryTemplateSpecName152": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('74b581fc-e8cb-4b50-9d82-7b91d3a88a08')))]"
    },
    "huntingQueryObject153": {
      "huntingQueryVersion153": "1.0.0",
      "_huntingQuerycontentId153": "90cd91d1-7b90-421c-a5c9-0479b6b7e6a2",
      "huntingQueryTemplateSpecName153": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('90cd91d1-7b90-421c-a5c9-0479b6b7e6a2')))]"
    },
    "huntingQueryObject154": {
      "huntingQueryVersion154": "1.0.0",
      "_huntingQuerycontentId154": "0c68250b-44b5-46f4-8cac-f3e7149e8c61",
      "huntingQueryTemplateSpecName154": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0c68250b-44b5-46f4-8cac-f3e7149e8c61')))]"
    },
    "huntingQueryObject155": {
      "huntingQueryVersion155": "1.0.0",
      "_huntingQuerycontentId155": "0c829a3c-ead1-4ebc-92c9-2e85abb1edeb",
      "huntingQueryTemplateSpecName155": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0c829a3c-ead1-4ebc-92c9-2e85abb1edeb')))]"
    },
    "huntingQueryObject156": {
      "huntingQueryVersion156": "1.0.0",
      "_huntingQuerycontentId156": "6610945e-9496-4ef4-9bc4-a511a3f2a477",
      "huntingQueryTemplateSpecName156": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('6610945e-9496-4ef4-9bc4-a511a3f2a477')))]"
    },
    "huntingQueryObject157": {
      "huntingQueryVersion157": "1.0.0",
      "_huntingQuerycontentId157": "75ade06c-7326-4e0d-9dfb-27e05043525b",
      "huntingQueryTemplateSpecName157": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('75ade06c-7326-4e0d-9dfb-27e05043525b')))]"
    },
    "huntingQueryObject158": {
      "huntingQueryVersion158": "1.0.0",
      "_huntingQuerycontentId158": "2ae448b1-b27d-4043-a92f-ef10202cdb7a",
      "huntingQueryTemplateSpecName158": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('2ae448b1-b27d-4043-a92f-ef10202cdb7a')))]"
    },
    "huntingQueryObject159": {
      "huntingQueryVersion159": "1.0.0",
      "_huntingQuerycontentId159": "02e237ed-f7b5-49dd-92e6-1b340d5e37fb",
      "huntingQueryTemplateSpecName159": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('02e237ed-f7b5-49dd-92e6-1b340d5e37fb')))]"
    },
    "huntingQueryObject160": {
      "huntingQueryVersion160": "1.0.0",
      "_huntingQuerycontentId160": "b1f797d1-6ea4-4f8f-b663-6c8a1c1018e9",
      "huntingQueryTemplateSpecName160": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b1f797d1-6ea4-4f8f-b663-6c8a1c1018e9')))]"
    },
    "huntingQueryObject161": {
      "huntingQueryVersion161": "1.0.0",
      "_huntingQuerycontentId161": "c73ae295-d120-4f79-aaed-de005f766ad2",
      "huntingQueryTemplateSpecName161": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('c73ae295-d120-4f79-aaed-de005f766ad2')))]"
    },
    "huntingQueryObject162": {
      "huntingQueryVersion162": "1.0.0",
      "_huntingQuerycontentId162": "fe2cb53e-4eb3-4676-87c1-f80d2813f542",
      "huntingQueryTemplateSpecName162": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('fe2cb53e-4eb3-4676-87c1-f80d2813f542')))]"
    },
    "huntingQueryObject163": {
      "huntingQueryVersion163": "1.0.0",
      "_huntingQuerycontentId163": "8f8fd7c8-277a-48c3-ad67-c80b3037c5af",
      "huntingQueryTemplateSpecName163": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8f8fd7c8-277a-48c3-ad67-c80b3037c5af')))]"
    },
    "huntingQueryObject164": {
      "huntingQueryVersion164": "1.0.0",
      "_huntingQuerycontentId164": "bd6aae91-6233-430b-a5af-15c6406a7770",
      "huntingQueryTemplateSpecName164": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('bd6aae91-6233-430b-a5af-15c6406a7770')))]"
    },
    "huntingQueryObject165": {
      "huntingQueryVersion165": "1.0.0",
      "_huntingQuerycontentId165": "e6b3edc5-ec6f-44ae-9bb4-60c9ea49154e",
      "huntingQueryTemplateSpecName165": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('e6b3edc5-ec6f-44ae-9bb4-60c9ea49154e')))]"
    },
    "huntingQueryObject166": {
      "huntingQueryVersion166": "1.0.0",
      "_huntingQuerycontentId166": "74e076da-58e8-436d-b7bc-68888dbb6091",
      "huntingQueryTemplateSpecName166": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('74e076da-58e8-436d-b7bc-68888dbb6091')))]"
    },
    "huntingQueryObject167": {
      "huntingQueryVersion167": "1.0.0",
      "_huntingQuerycontentId167": "fbe7a9d2-507e-4974-9e9a-d1cba3907f67",
      "huntingQueryTemplateSpecName167": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('fbe7a9d2-507e-4974-9e9a-d1cba3907f67')))]"
    },
    "huntingQueryObject168": {
      "huntingQueryVersion168": "1.0.0",
      "_huntingQuerycontentId168": "76c77c8a-bd2a-489a-af52-97291211e4e4",
      "huntingQueryTemplateSpecName168": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('76c77c8a-bd2a-489a-af52-97291211e4e4')))]"
    },
    "huntingQueryObject169": {
      "huntingQueryVersion169": "1.0.0",
      "_huntingQuerycontentId169": "4d86021c-cad7-489b-a8c8-dddecb87a2ef",
      "huntingQueryTemplateSpecName169": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('4d86021c-cad7-489b-a8c8-dddecb87a2ef')))]"
    },
    "huntingQueryObject170": {
      "huntingQueryVersion170": "1.0.0",
      "_huntingQuerycontentId170": "b20e56b8-e335-43d9-b7b3-43c034c43aea",
      "huntingQueryTemplateSpecName170": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b20e56b8-e335-43d9-b7b3-43c034c43aea')))]"
    },
    "huntingQueryObject171": {
      "huntingQueryVersion171": "1.0.0",
      "_huntingQuerycontentId171": "dd6efecd-7fe5-41b1-a122-8e0a15de9451",
      "huntingQueryTemplateSpecName171": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('dd6efecd-7fe5-41b1-a122-8e0a15de9451')))]"
    },
    "huntingQueryObject172": {
      "huntingQueryVersion172": "1.0.0",
      "_huntingQuerycontentId172": "4c30fab1-db4f-4a64-b66b-51478e43a477",
      "huntingQueryTemplateSpecName172": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('4c30fab1-db4f-4a64-b66b-51478e43a477')))]"
    },
    "huntingQueryObject173": {
      "huntingQueryVersion173": "1.0.0",
      "_huntingQuerycontentId173": "ad76e484-f159-4d23-99ee-e734f0b8b60b",
      "huntingQueryTemplateSpecName173": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('ad76e484-f159-4d23-99ee-e734f0b8b60b')))]"
    },
    "huntingQueryObject174": {
      "huntingQueryVersion174": "1.0.0",
      "_huntingQuerycontentId174": "0b197e26-7899-47ff-9be9-f7ba6dc949ea",
      "huntingQueryTemplateSpecName174": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0b197e26-7899-47ff-9be9-f7ba6dc949ea')))]"
    },
    "huntingQueryObject175": {
      "huntingQueryVersion175": "1.0.0",
      "_huntingQuerycontentId175": "87846aad-624c-4e18-b963-81bedd7123a2",
      "huntingQueryTemplateSpecName175": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('87846aad-624c-4e18-b963-81bedd7123a2')))]"
    },
    "huntingQueryObject176": {
      "huntingQueryVersion176": "1.0.0",
      "_huntingQuerycontentId176": "80f357a6-6bb4-4b2b-a88c-265fccafc794",
      "huntingQueryTemplateSpecName176": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('80f357a6-6bb4-4b2b-a88c-265fccafc794')))]"
    },
    "huntingQueryObject177": {
      "huntingQueryVersion177": "1.0.0",
      "_huntingQuerycontentId177": "25150085-015a-4673-9b67-bc6ad9475500",
      "huntingQueryTemplateSpecName177": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('25150085-015a-4673-9b67-bc6ad9475500')))]"
    },
    "huntingQueryObject178": {
      "huntingQueryVersion178": "1.0.0",
      "_huntingQuerycontentId178": "9b086a51-e396-4718-90d7-f7b3646e6581",
      "huntingQueryTemplateSpecName178": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('9b086a51-e396-4718-90d7-f7b3646e6581')))]"
    },
    "huntingQueryObject179": {
      "huntingQueryVersion179": "1.0.0",
      "_huntingQuerycontentId179": "516046e8-a460-4f7b-86eb-421d3a9cdff1",
      "huntingQueryTemplateSpecName179": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('516046e8-a460-4f7b-86eb-421d3a9cdff1')))]"
    },
    "huntingQueryObject180": {
      "huntingQueryVersion180": "1.0.0",
      "_huntingQuerycontentId180": "594fe5a1-53b6-466b-86df-028366c3994e",
      "huntingQueryTemplateSpecName180": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('594fe5a1-53b6-466b-86df-028366c3994e')))]"
    },
    "huntingQueryObject181": {
      "huntingQueryVersion181": "1.0.0",
      "_huntingQuerycontentId181": "706b711a-7622-40f1-9ebb-331d1a0ff697",
      "huntingQueryTemplateSpecName181": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('706b711a-7622-40f1-9ebb-331d1a0ff697')))]"
    },
    "huntingQueryObject182": {
      "huntingQueryVersion182": "1.0.0",
      "_huntingQuerycontentId182": "f708c866-073a-4107-a60b-ba6f86e54caa",
      "huntingQueryTemplateSpecName182": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f708c866-073a-4107-a60b-ba6f86e54caa')))]"
    },
    "huntingQueryObject183": {
      "huntingQueryVersion183": "1.0.0",
      "_huntingQuerycontentId183": "68aa199c-259b-4bb0-8e7a-8ed6f96c5525",
      "huntingQueryTemplateSpecName183": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('68aa199c-259b-4bb0-8e7a-8ed6f96c5525')))]"
    },
    "huntingQueryObject184": {
      "huntingQueryVersion184": "1.0.0",
      "_huntingQuerycontentId184": "8c852f12-499f-499b-afc1-25c50aa9b462",
      "huntingQueryTemplateSpecName184": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8c852f12-499f-499b-afc1-25c50aa9b462')))]"
    },
    "huntingQueryObject185": {
      "huntingQueryVersion185": "1.0.0",
      "_huntingQuerycontentId185": "f6354c94-3a95-4235-8530-414f016a7bf6",
      "huntingQueryTemplateSpecName185": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f6354c94-3a95-4235-8530-414f016a7bf6')))]"
    },
    "huntingQueryObject186": {
      "huntingQueryVersion186": "1.0.0",
      "_huntingQuerycontentId186": "dc7e1eb5-16f5-4ad5-96a1-794970f4b310",
      "huntingQueryTemplateSpecName186": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('dc7e1eb5-16f5-4ad5-96a1-794970f4b310')))]"
    },
    "huntingQueryObject187": {
      "huntingQueryVersion187": "1.0.0",
      "_huntingQuerycontentId187": "54d3455d-27e0-4ceb-99f9-375abd620151",
      "huntingQueryTemplateSpecName187": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('54d3455d-27e0-4ceb-99f9-375abd620151')))]"
    },
    "huntingQueryObject188": {
      "huntingQueryVersion188": "1.0.0",
      "_huntingQuerycontentId188": "8d298b5c-feca-4add-bd42-e43e0a317a88",
      "huntingQueryTemplateSpecName188": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8d298b5c-feca-4add-bd42-e43e0a317a88')))]"
    },
    "huntingQueryObject189": {
      "huntingQueryVersion189": "1.0.0",
      "_huntingQuerycontentId189": "3131d0ba-32c9-483e-a25c-82e26a07e116",
      "huntingQueryTemplateSpecName189": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('3131d0ba-32c9-483e-a25c-82e26a07e116')))]"
    },
    "huntingQueryObject190": {
      "huntingQueryVersion190": "1.0.0",
      "_huntingQuerycontentId190": "a12cac64-ea6d-46d4-91a6-262b165fb9ad",
      "huntingQueryTemplateSpecName190": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a12cac64-ea6d-46d4-91a6-262b165fb9ad')))]"
    },
    "huntingQueryObject191": {
      "huntingQueryVersion191": "1.0.0",
      "_huntingQuerycontentId191": "9e8faa62-7222-48a5-a78f-ef2d22f866dc",
      "huntingQueryTemplateSpecName191": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('9e8faa62-7222-48a5-a78f-ef2d22f866dc')))]"
    },
    "huntingQueryObject192": {
      "huntingQueryVersion192": "1.0.0",
      "_huntingQuerycontentId192": "79bed402-09bc-453b-ab92-8b1411e683fa",
      "huntingQueryTemplateSpecName192": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('79bed402-09bc-453b-ab92-8b1411e683fa')))]"
    },
    "huntingQueryObject193": {
      "huntingQueryVersion193": "1.0.0",
      "_huntingQuerycontentId193": "36cf7ce5-7264-46d9-9f47-57b59049b44f",
      "huntingQueryTemplateSpecName193": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('36cf7ce5-7264-46d9-9f47-57b59049b44f')))]"
    },
    "huntingQueryObject194": {
      "huntingQueryVersion194": "1.0.0",
      "_huntingQuerycontentId194": "6f96f6d7-d972-421e-a59f-6b9a8de81324",
      "huntingQueryTemplateSpecName194": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('6f96f6d7-d972-421e-a59f-6b9a8de81324')))]"
    },
    "huntingQueryObject195": {
      "huntingQueryVersion195": "1.0.0",
      "_huntingQuerycontentId195": "9f135aef-ad25-4df2-bdab-8399978a36a2",
      "huntingQueryTemplateSpecName195": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('9f135aef-ad25-4df2-bdab-8399978a36a2')))]"
    },
    "huntingQueryObject196": {
      "huntingQueryVersion196": "1.0.0",
      "_huntingQuerycontentId196": "23e6d66b-511a-43fd-9863-6924da60319a",
      "huntingQueryTemplateSpecName196": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('23e6d66b-511a-43fd-9863-6924da60319a')))]"
    },
    "huntingQueryObject197": {
      "huntingQueryVersion197": "1.0.0",
      "_huntingQuerycontentId197": "32a981ad-cd5a-4d80-8c6c-d59b9893c019",
      "huntingQueryTemplateSpecName197": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('32a981ad-cd5a-4d80-8c6c-d59b9893c019')))]"
    },
    "huntingQueryObject198": {
      "huntingQueryVersion198": "1.0.0",
      "_huntingQuerycontentId198": "bde9d9fc-e166-4628-91f7-fb86ace93af0",
      "huntingQueryTemplateSpecName198": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('bde9d9fc-e166-4628-91f7-fb86ace93af0')))]"
    },
    "huntingQueryObject199": {
      "huntingQueryVersion199": "1.0.0",
      "_huntingQuerycontentId199": "77104824-b41e-412d-8e50-26971fe97ab0",
      "huntingQueryTemplateSpecName199": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('77104824-b41e-412d-8e50-26971fe97ab0')))]"
    },
    "huntingQueryObject200": {
      "huntingQueryVersion200": "1.0.0",
      "_huntingQuerycontentId200": "99713387-9d61-49eb-8edc-f51153d8bb01",
      "huntingQueryTemplateSpecName200": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('99713387-9d61-49eb-8edc-f51153d8bb01')))]"
    },
    "huntingQueryObject201": {
      "huntingQueryVersion201": "1.0.0",
      "_huntingQuerycontentId201": "147131b3-8b57-4c50-b981-5a951ed82272",
      "huntingQueryTemplateSpecName201": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('147131b3-8b57-4c50-b981-5a951ed82272')))]"
    },
    "huntingQueryObject202": {
      "huntingQueryVersion202": "1.0.0",
      "_huntingQuerycontentId202": "7e93ce37-0cc5-4aa9-b30a-07772affa481",
      "huntingQueryTemplateSpecName202": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('7e93ce37-0cc5-4aa9-b30a-07772affa481')))]"
    },
    "huntingQueryObject203": {
      "huntingQueryVersion203": "1.0.0",
      "_huntingQuerycontentId203": "316f8777-09fd-480b-a726-21f521fa990f",
      "huntingQueryTemplateSpecName203": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('316f8777-09fd-480b-a726-21f521fa990f')))]"
    },
    "huntingQueryObject204": {
      "huntingQueryVersion204": "1.0.0",
      "_huntingQuerycontentId204": "2e903da3-32fe-46b0-8df7-5f39e55db17e",
      "huntingQueryTemplateSpecName204": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('2e903da3-32fe-46b0-8df7-5f39e55db17e')))]"
    },
    "huntingQueryObject205": {
      "huntingQueryVersion205": "1.0.0",
      "_huntingQuerycontentId205": "f290d544-c499-4b23-8a7e-c4cbb7ab6316",
      "huntingQueryTemplateSpecName205": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f290d544-c499-4b23-8a7e-c4cbb7ab6316')))]"
    },
    "huntingQueryObject206": {
      "huntingQueryVersion206": "1.0.0",
      "_huntingQuerycontentId206": "6fe463ca-4cd3-4d97-a099-6b736f28a128",
      "huntingQueryTemplateSpecName206": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('6fe463ca-4cd3-4d97-a099-6b736f28a128')))]"
    },
    "huntingQueryObject207": {
      "huntingQueryVersion207": "1.0.0",
      "_huntingQuerycontentId207": "9e4b7553-1113-4d40-bb6b-7daca7d7d255",
      "huntingQueryTemplateSpecName207": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('9e4b7553-1113-4d40-bb6b-7daca7d7d255')))]"
    },
    "huntingQueryObject208": {
      "huntingQueryVersion208": "1.0.0",
      "_huntingQuerycontentId208": "c03e13ee-0e7a-4d05-b3f4-790b01bb30a5",
      "huntingQueryTemplateSpecName208": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('c03e13ee-0e7a-4d05-b3f4-790b01bb30a5')))]"
    },
    "huntingQueryObject209": {
      "huntingQueryVersion209": "1.0.0",
      "_huntingQuerycontentId209": "86f2b124-8caf-4b53-845a-87de3ffccbdf",
      "huntingQueryTemplateSpecName209": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('86f2b124-8caf-4b53-845a-87de3ffccbdf')))]"
    },
    "huntingQueryObject210": {
      "huntingQueryVersion210": "1.0.0",
      "_huntingQuerycontentId210": "ae690d6f-0ea5-4617-95cf-1ed9a5fcb329",
      "huntingQueryTemplateSpecName210": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('ae690d6f-0ea5-4617-95cf-1ed9a5fcb329')))]"
    },
    "huntingQueryObject211": {
      "huntingQueryVersion211": "1.0.0",
      "_huntingQuerycontentId211": "16cfa413-238f-4355-9f8a-4b97ce7572ac",
      "huntingQueryTemplateSpecName211": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('16cfa413-238f-4355-9f8a-4b97ce7572ac')))]"
    },
    "huntingQueryObject212": {
      "huntingQueryVersion212": "1.0.0",
      "_huntingQuerycontentId212": "6a570927-8638-4a6f-ac09-72a7d51ffa3c",
      "huntingQueryTemplateSpecName212": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('6a570927-8638-4a6f-ac09-72a7d51ffa3c')))]"
    },
    "huntingQueryObject213": {
      "huntingQueryVersion213": "1.0.0",
      "_huntingQuerycontentId213": "418e8859-b22a-4fd4-b273-5433e054cdc7",
      "huntingQueryTemplateSpecName213": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('418e8859-b22a-4fd4-b273-5433e054cdc7')))]"
    },
    "huntingQueryObject214": {
      "huntingQueryVersion214": "1.0.0",
      "_huntingQuerycontentId214": "15a17150-811d-4829-a3d6-489139c9ff5e",
      "huntingQueryTemplateSpecName214": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('15a17150-811d-4829-a3d6-489139c9ff5e')))]"
    },
    "huntingQueryObject215": {
      "huntingQueryVersion215": "1.0.0",
      "_huntingQuerycontentId215": "416cd270-6327-441a-9304-940c832cf361",
      "huntingQueryTemplateSpecName215": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('416cd270-6327-441a-9304-940c832cf361')))]"
    },
    "huntingQueryObject216": {
      "huntingQueryVersion216": "1.0.0",
      "_huntingQuerycontentId216": "cdc4da1c-64a1-4941-be59-1f5cc85481ab",
      "huntingQueryTemplateSpecName216": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('cdc4da1c-64a1-4941-be59-1f5cc85481ab')))]"
    },
    "huntingQueryObject217": {
      "huntingQueryVersion217": "1.0.0",
      "_huntingQuerycontentId217": "b3180ac0-6d94-494a-8b8c-fcc84319ea6e",
      "huntingQueryTemplateSpecName217": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b3180ac0-6d94-494a-8b8c-fcc84319ea6e')))]"
    },
    "huntingQueryObject218": {
      "huntingQueryVersion218": "1.0.0",
      "_huntingQuerycontentId218": "011c3d48-f6ca-405f-9763-66c7856ad2ba",
      "huntingQueryTemplateSpecName218": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('011c3d48-f6ca-405f-9763-66c7856ad2ba')))]"
    },
    "huntingQueryObject219": {
      "huntingQueryVersion219": "1.0.0",
      "_huntingQuerycontentId219": "1dce39ec-8a64-4e49-9d6e-926ee6f04c39",
      "huntingQueryTemplateSpecName219": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('1dce39ec-8a64-4e49-9d6e-926ee6f04c39')))]"
    },
    "huntingQueryObject220": {
      "huntingQueryVersion220": "1.0.0",
      "_huntingQuerycontentId220": "53139a92-eb64-46d2-be97-e752a71e7021",
      "huntingQueryTemplateSpecName220": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('53139a92-eb64-46d2-be97-e752a71e7021')))]"
    },
    "huntingQueryObject221": {
      "huntingQueryVersion221": "1.0.0",
      "_huntingQuerycontentId221": "09b263e1-9c73-4585-a55c-bc209e148e14",
      "huntingQueryTemplateSpecName221": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('09b263e1-9c73-4585-a55c-bc209e148e14')))]"
    },
    "huntingQueryObject222": {
      "huntingQueryVersion222": "1.0.0",
      "_huntingQuerycontentId222": "f9442d20-eff8-4751-9a75-6451aeace687",
      "huntingQueryTemplateSpecName222": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f9442d20-eff8-4751-9a75-6451aeace687')))]"
    },
    "huntingQueryObject223": {
      "huntingQueryVersion223": "1.0.0",
      "_huntingQuerycontentId223": "e90345b3-439c-44e1-a85d-8ae84ad9c65b",
      "huntingQueryTemplateSpecName223": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('e90345b3-439c-44e1-a85d-8ae84ad9c65b')))]"
    },
    "huntingQueryObject224": {
      "huntingQueryVersion224": "1.0.0",
      "_huntingQuerycontentId224": "c51b0367-573a-42c3-a4a2-2d8b1ef6bea9",
      "huntingQueryTemplateSpecName224": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('c51b0367-573a-42c3-a4a2-2d8b1ef6bea9')))]"
    },
    "huntingQueryObject225": {
      "huntingQueryVersion225": "1.0.0",
      "_huntingQuerycontentId225": "e3a11181-3ff9-4ba0-908d-3e229b476ce3",
      "huntingQueryTemplateSpecName225": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('e3a11181-3ff9-4ba0-908d-3e229b476ce3')))]"
    },
    "huntingQueryObject226": {
      "huntingQueryVersion226": "1.0.0",
      "_huntingQuerycontentId226": "515a98db-49a5-4592-80b7-8227998da9ed",
      "huntingQueryTemplateSpecName226": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('515a98db-49a5-4592-80b7-8227998da9ed')))]"
    },
    "huntingQueryObject227": {
      "huntingQueryVersion227": "1.0.0",
      "_huntingQuerycontentId227": "5cb9399f-e4d7-46c1-bdfa-d66eec278bf2",
      "huntingQueryTemplateSpecName227": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('5cb9399f-e4d7-46c1-bdfa-d66eec278bf2')))]"
    },
    "huntingQueryObject228": {
      "huntingQueryVersion228": "1.0.0",
      "_huntingQuerycontentId228": "8f82894a-1b18-4d1e-a580-1dcaff739a32",
      "huntingQueryTemplateSpecName228": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8f82894a-1b18-4d1e-a580-1dcaff739a32')))]"
    },
    "huntingQueryObject229": {
      "huntingQueryVersion229": "1.0.0",
      "_huntingQuerycontentId229": "8425234b-f09d-490e-be3d-a7ecf081c5d0",
      "huntingQueryTemplateSpecName229": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8425234b-f09d-490e-be3d-a7ecf081c5d0')))]"
    },
    "huntingQueryObject230": {
      "huntingQueryVersion230": "1.0.0",
      "_huntingQuerycontentId230": "60cddbbb-2244-4a61-ad73-b20b1c6f5027",
      "huntingQueryTemplateSpecName230": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('60cddbbb-2244-4a61-ad73-b20b1c6f5027')))]"
    },
    "huntingQueryObject231": {
      "huntingQueryVersion231": "1.0.0",
      "_huntingQuerycontentId231": "354d78b3-91b7-4219-9079-57e63e281077",
      "huntingQueryTemplateSpecName231": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('354d78b3-91b7-4219-9079-57e63e281077')))]"
    },
    "huntingQueryObject232": {
      "huntingQueryVersion232": "1.0.0",
      "_huntingQuerycontentId232": "a7f2dae2-2e33-4744-b013-37dc5628d939",
      "huntingQueryTemplateSpecName232": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a7f2dae2-2e33-4744-b013-37dc5628d939')))]"
    },
    "huntingQueryObject233": {
      "huntingQueryVersion233": "1.0.0",
      "_huntingQuerycontentId233": "de074419-2ec5-4c7f-a7f6-0a49178b314c",
      "huntingQueryTemplateSpecName233": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('de074419-2ec5-4c7f-a7f6-0a49178b314c')))]"
    },
    "huntingQueryObject234": {
      "huntingQueryVersion234": "1.0.0",
      "_huntingQuerycontentId234": "d236f728-8b0f-4b4f-acf7-e4707993b841",
      "huntingQueryTemplateSpecName234": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('d236f728-8b0f-4b4f-acf7-e4707993b841')))]"
    },
    "huntingQueryObject235": {
      "huntingQueryVersion235": "1.0.0",
      "_huntingQuerycontentId235": "8b0bae20-687f-47ca-bc2e-8dabbed9cbae",
      "huntingQueryTemplateSpecName235": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8b0bae20-687f-47ca-bc2e-8dabbed9cbae')))]"
    },
    "huntingQueryObject236": {
      "huntingQueryVersion236": "1.0.0",
      "_huntingQuerycontentId236": "47506508-dee4-4d4d-93a8-1c78d63cd2eb",
      "huntingQueryTemplateSpecName236": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('47506508-dee4-4d4d-93a8-1c78d63cd2eb')))]"
    },
    "huntingQueryObject237": {
      "huntingQueryVersion237": "1.0.0",
      "_huntingQuerycontentId237": "72f939fe-c77b-4c25-91b4-3f784c9c58c3",
      "huntingQueryTemplateSpecName237": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('72f939fe-c77b-4c25-91b4-3f784c9c58c3')))]"
    },
    "huntingQueryObject238": {
      "huntingQueryVersion238": "1.0.0",
      "_huntingQuerycontentId238": "da7eecca-ecb8-4b8e-a111-62d2b48e2e69",
      "huntingQueryTemplateSpecName238": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('da7eecca-ecb8-4b8e-a111-62d2b48e2e69')))]"
    },
    "huntingQueryObject239": {
      "huntingQueryVersion239": "1.0.0",
      "_huntingQuerycontentId239": "4c786e9a-b570-47bc-877f-7f3da87a4673",
      "huntingQueryTemplateSpecName239": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('4c786e9a-b570-47bc-877f-7f3da87a4673')))]"
    },
    "huntingQueryObject240": {
      "huntingQueryVersion240": "1.0.0",
      "_huntingQuerycontentId240": "53c58a33-668d-46e1-9714-5892c87650d9",
      "huntingQueryTemplateSpecName240": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('53c58a33-668d-46e1-9714-5892c87650d9')))]"
    },
    "huntingQueryObject241": {
      "huntingQueryVersion241": "1.0.0",
      "_huntingQuerycontentId241": "8cde246b-7ed1-429c-933a-f7d0363dbbc0",
      "huntingQueryTemplateSpecName241": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8cde246b-7ed1-429c-933a-f7d0363dbbc0')))]"
    },
    "huntingQueryObject242": {
      "huntingQueryVersion242": "1.0.0",
      "_huntingQuerycontentId242": "0bd33643-c517-48b1-8211-25a7fbd15a50",
      "huntingQueryTemplateSpecName242": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0bd33643-c517-48b1-8211-25a7fbd15a50')))]"
    },
    "huntingQueryObject243": {
      "huntingQueryVersion243": "1.0.0",
      "_huntingQuerycontentId243": "d78bad8c-3d94-4a73-bdbe-1c567e3d6d62",
      "huntingQueryTemplateSpecName243": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('d78bad8c-3d94-4a73-bdbe-1c567e3d6d62')))]"
    },
    "huntingQueryObject244": {
      "huntingQueryVersion244": "1.0.0",
      "_huntingQuerycontentId244": "58acf93f-27de-4af4-8a5f-d87ee59326f9",
      "huntingQueryTemplateSpecName244": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('58acf93f-27de-4af4-8a5f-d87ee59326f9')))]"
    },
    "huntingQueryObject245": {
      "huntingQueryVersion245": "1.0.0",
      "_huntingQuerycontentId245": "0a9385bc-2ef9-4b0e-8834-12f796b08ca8",
      "huntingQueryTemplateSpecName245": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0a9385bc-2ef9-4b0e-8834-12f796b08ca8')))]"
    },
    "huntingQueryObject246": {
      "huntingQueryVersion246": "1.0.0",
      "_huntingQuerycontentId246": "385aca1d-2135-40c6-af8e-030c9e086cf5",
      "huntingQueryTemplateSpecName246": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('385aca1d-2135-40c6-af8e-030c9e086cf5')))]"
    },
    "huntingQueryObject247": {
      "huntingQueryVersion247": "1.0.0",
      "_huntingQuerycontentId247": "12798858-1916-4b59-a85e-8a7a4f7b43cf",
      "huntingQueryTemplateSpecName247": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('12798858-1916-4b59-a85e-8a7a4f7b43cf')))]"
    },
    "huntingQueryObject248": {
      "huntingQueryVersion248": "1.0.0",
      "_huntingQuerycontentId248": "b78eddd9-ebe5-42ab-95b4-928a782b52b5",
      "huntingQueryTemplateSpecName248": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('b78eddd9-ebe5-42ab-95b4-928a782b52b5')))]"
    },
    "huntingQueryObject249": {
      "huntingQueryVersion249": "1.0.0",
      "_huntingQuerycontentId249": "cbf3abc0-2b2d-4852-ab7a-9f7a1231997e",
      "huntingQueryTemplateSpecName249": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('cbf3abc0-2b2d-4852-ab7a-9f7a1231997e')))]"
    },
    "huntingQueryObject250": {
      "huntingQueryVersion250": "1.0.0",
      "_huntingQuerycontentId250": "201cb524-b4b4-479a-9637-da35cfa1e30a",
      "huntingQueryTemplateSpecName250": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('201cb524-b4b4-479a-9637-da35cfa1e30a')))]"
    },
    "huntingQueryObject251": {
      "huntingQueryVersion251": "1.0.0",
      "_huntingQuerycontentId251": "abdca3e6-c198-404a-b95c-f09ddfed2027",
      "huntingQueryTemplateSpecName251": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('abdca3e6-c198-404a-b95c-f09ddfed2027')))]"
    },
    "huntingQueryObject252": {
      "huntingQueryVersion252": "1.0.0",
      "_huntingQuerycontentId252": "289283e9-9f63-488c-8d62-fe9c598f3cd5",
      "huntingQueryTemplateSpecName252": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('289283e9-9f63-488c-8d62-fe9c598f3cd5')))]"
    },
    "huntingQueryObject253": {
      "huntingQueryVersion253": "1.0.0",
      "_huntingQuerycontentId253": "300b0d05-e99e-4349-ab2b-ec12ff5c2da1",
      "huntingQueryTemplateSpecName253": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('300b0d05-e99e-4349-ab2b-ec12ff5c2da1')))]"
    },
    "huntingQueryObject254": {
      "huntingQueryVersion254": "1.0.0",
      "_huntingQuerycontentId254": "9c4359a1-0bf9-45b3-9a1a-f333c437a061",
      "huntingQueryTemplateSpecName254": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('9c4359a1-0bf9-45b3-9a1a-f333c437a061')))]"
    },
    "huntingQueryObject255": {
      "huntingQueryVersion255": "1.0.0",
      "_huntingQuerycontentId255": "de480ca4-4095-4fef-b3e7-2a3f17f24e78",
      "huntingQueryTemplateSpecName255": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('de480ca4-4095-4fef-b3e7-2a3f17f24e78')))]"
    },
    "huntingQueryObject256": {
      "huntingQueryVersion256": "1.0.0",
      "_huntingQuerycontentId256": "a8ccbf35-4c6d-4a8f-8c42-04fd9b000a27",
      "huntingQueryTemplateSpecName256": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a8ccbf35-4c6d-4a8f-8c42-04fd9b000a27')))]"
    },
    "huntingQueryObject257": {
      "huntingQueryVersion257": "1.0.0",
      "_huntingQuerycontentId257": "e3b7b5c1-0e50-4dfb-b73a-c226636eaf58",
      "huntingQueryTemplateSpecName257": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('e3b7b5c1-0e50-4dfb-b73a-c226636eaf58')))]"
    },
    "huntingQueryObject258": {
      "huntingQueryVersion258": "1.0.0",
      "_huntingQuerycontentId258": "27ee28e7-423b-48c9-a410-cbc6c8e21d25",
      "huntingQueryTemplateSpecName258": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('27ee28e7-423b-48c9-a410-cbc6c8e21d25')))]"
    },
    "huntingQueryObject259": {
      "huntingQueryVersion259": "1.0.0",
      "_huntingQuerycontentId259": "9d6c8c17-06b0-4044-b18e-35eb3dfc5cf2",
      "huntingQueryTemplateSpecName259": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('9d6c8c17-06b0-4044-b18e-35eb3dfc5cf2')))]"
    },
    "huntingQueryObject260": {
      "huntingQueryVersion260": "1.0.0",
      "_huntingQuerycontentId260": "a1664330-810a-473b-b354-acbaa751a294",
      "huntingQueryTemplateSpecName260": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a1664330-810a-473b-b354-acbaa751a294')))]"
    },
    "huntingQueryObject261": {
      "huntingQueryVersion261": "1.0.0",
      "_huntingQuerycontentId261": "d24e9c4a-b72a-4a85-89cd-83760ae61155",
      "huntingQueryTemplateSpecName261": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('d24e9c4a-b72a-4a85-89cd-83760ae61155')))]"
    },
    "huntingQueryObject262": {
      "huntingQueryVersion262": "1.0.0",
      "_huntingQuerycontentId262": "3f007cdc-86bf-4657-9015-05101a3e54f5",
      "huntingQueryTemplateSpecName262": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('3f007cdc-86bf-4657-9015-05101a3e54f5')))]"
    },
    "huntingQueryObject263": {
      "huntingQueryVersion263": "1.0.0",
      "_huntingQuerycontentId263": "efe27064-6d35-4720-b7f5-e0326695613d",
      "huntingQueryTemplateSpecName263": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('efe27064-6d35-4720-b7f5-e0326695613d')))]"
    },
    "huntingQueryObject264": {
      "huntingQueryVersion264": "1.0.0",
      "_huntingQuerycontentId264": "bc46e331-3cb0-483d-9c90-989d2a59457f",
      "huntingQueryTemplateSpecName264": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('bc46e331-3cb0-483d-9c90-989d2a59457f')))]"
    },
    "huntingQueryObject265": {
      "huntingQueryVersion265": "1.0.0",
      "_huntingQuerycontentId265": "03e61096-20d0-46eb-b8e0-a507dd00a19f",
      "huntingQueryTemplateSpecName265": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('03e61096-20d0-46eb-b8e0-a507dd00a19f')))]"
    },
    "huntingQueryObject266": {
      "huntingQueryVersion266": "1.0.0",
      "_huntingQuerycontentId266": "f075d4c4-cf76-4e5d-9c2d-9ed524286316",
      "huntingQueryTemplateSpecName266": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f075d4c4-cf76-4e5d-9c2d-9ed524286316')))]"
    },
    "huntingQueryObject267": {
      "huntingQueryVersion267": "1.0.0",
      "_huntingQuerycontentId267": "891f4865-75e5-4d40-bc24-ebf97da3ca9a",
      "huntingQueryTemplateSpecName267": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('891f4865-75e5-4d40-bc24-ebf97da3ca9a')))]"
    },
    "huntingQueryObject268": {
      "huntingQueryVersion268": "1.0.0",
      "_huntingQuerycontentId268": "d823da0e-1334-4a66-8ff4-2c2c40d26295",
      "huntingQueryTemplateSpecName268": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('d823da0e-1334-4a66-8ff4-2c2c40d26295')))]"
    },
    "huntingQueryObject269": {
      "huntingQueryVersion269": "1.0.0",
      "_huntingQuerycontentId269": "ba4f7e56-a2f8-4a30-b848-200fdc7fc3a2",
      "huntingQueryTemplateSpecName269": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('ba4f7e56-a2f8-4a30-b848-200fdc7fc3a2')))]"
    },
    "huntingQueryObject270": {
      "huntingQueryVersion270": "1.0.0",
      "_huntingQuerycontentId270": "13260191-fb10-4a36-9ca1-2bbc0aaf77d0",
      "huntingQueryTemplateSpecName270": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('13260191-fb10-4a36-9ca1-2bbc0aaf77d0')))]"
    },
    "huntingQueryObject271": {
      "huntingQueryVersion271": "1.0.0",
      "_huntingQuerycontentId271": "08aff8c6-b983-43a3-be95-68a10c3d35e6",
      "huntingQueryTemplateSpecName271": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('08aff8c6-b983-43a3-be95-68a10c3d35e6')))]"
    },
    "huntingQueryObject272": {
      "huntingQueryVersion272": "1.0.0",
      "_huntingQuerycontentId272": "492f1ea1-37c3-410a-a2f2-4e4eae2ff7f9",
      "huntingQueryTemplateSpecName272": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('492f1ea1-37c3-410a-a2f2-4e4eae2ff7f9')))]"
    },
    "huntingQueryObject273": {
      "huntingQueryVersion273": "1.0.0",
      "_huntingQuerycontentId273": "5a84e13a-bb17-4124-9564-d74cdb84c124",
      "huntingQueryTemplateSpecName273": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('5a84e13a-bb17-4124-9564-d74cdb84c124')))]"
    },
    "huntingQueryObject274": {
      "huntingQueryVersion274": "1.0.0",
      "_huntingQuerycontentId274": "a937905e-ee5c-406c-ab86-8e2581240112",
      "huntingQueryTemplateSpecName274": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a937905e-ee5c-406c-ab86-8e2581240112')))]"
    },
    "huntingQueryObject275": {
      "huntingQueryVersion275": "1.0.0",
      "_huntingQuerycontentId275": "3a2fdf32-ebe7-4f65-a1c3-fc7faf23ae90",
      "huntingQueryTemplateSpecName275": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('3a2fdf32-ebe7-4f65-a1c3-fc7faf23ae90')))]"
    },
    "huntingQueryObject276": {
      "huntingQueryVersion276": "1.0.0",
      "_huntingQuerycontentId276": "3eef362d-3aee-4950-9208-4afa6f7afbe9",
      "huntingQueryTemplateSpecName276": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('3eef362d-3aee-4950-9208-4afa6f7afbe9')))]"
    },
    "huntingQueryObject277": {
      "huntingQueryVersion277": "1.0.0",
      "_huntingQuerycontentId277": "4620ece3-dceb-4151-8621-5a56351c97cd",
      "huntingQueryTemplateSpecName277": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('4620ece3-dceb-4151-8621-5a56351c97cd')))]"
    },
    "huntingQueryObject278": {
      "huntingQueryVersion278": "1.0.0",
      "_huntingQuerycontentId278": "ab006655-d723-4844-9d5d-91cb3b020555",
      "huntingQueryTemplateSpecName278": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('ab006655-d723-4844-9d5d-91cb3b020555')))]"
    },
    "huntingQueryObject279": {
      "huntingQueryVersion279": "1.0.0",
      "_huntingQuerycontentId279": "21bafecb-ae8f-4667-b7d6-144e047cb602",
      "huntingQueryTemplateSpecName279": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('21bafecb-ae8f-4667-b7d6-144e047cb602')))]"
    },
    "huntingQueryObject280": {
      "huntingQueryVersion280": "1.0.0",
      "_huntingQuerycontentId280": "5e8d5202-ffdc-4d16-ad33-d56eb319c175",
      "huntingQueryTemplateSpecName280": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('5e8d5202-ffdc-4d16-ad33-d56eb319c175')))]"
    },
    "huntingQueryObject281": {
      "huntingQueryVersion281": "1.0.0",
      "_huntingQuerycontentId281": "dbc25434-bbe7-4517-bf4b-48ad9cb4e980",
      "huntingQueryTemplateSpecName281": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('dbc25434-bbe7-4517-bf4b-48ad9cb4e980')))]"
    },
    "huntingQueryObject282": {
      "huntingQueryVersion282": "1.0.0",
      "_huntingQuerycontentId282": "dd9df55e-79b7-48e0-9d19-965fcadae5e9",
      "huntingQueryTemplateSpecName282": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('dd9df55e-79b7-48e0-9d19-965fcadae5e9')))]"
    },
    "huntingQueryObject283": {
      "huntingQueryVersion283": "1.0.1",
      "_huntingQuerycontentId283": "cdac93ef-56c0-45bf-9e7f-9cbf0ad06123",
      "huntingQueryTemplateSpecName283": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('cdac93ef-56c0-45bf-9e7f-9cbf0ad06123')))]"
    },
    "huntingQueryObject284": {
      "huntingQueryVersion284": "1.0.0",
      "_huntingQuerycontentId284": "14694b88-a6e9-4cd1-9c4a-e382bdd82d8d",
      "huntingQueryTemplateSpecName284": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('14694b88-a6e9-4cd1-9c4a-e382bdd82d8d')))]"
    },
    "huntingQueryObject285": {
      "huntingQueryVersion285": "1.0.0",
      "_huntingQuerycontentId285": "bba7bbbe-5aa3-4c08-bd23-dd6cd8ccaf20",
      "huntingQueryTemplateSpecName285": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('bba7bbbe-5aa3-4c08-bd23-dd6cd8ccaf20')))]"
    },
    "huntingQueryObject286": {
      "huntingQueryVersion286": "1.0.0",
      "_huntingQuerycontentId286": "7a5597de-7e99-470d-944f-acb163b9cb14",
      "huntingQueryTemplateSpecName286": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('7a5597de-7e99-470d-944f-acb163b9cb14')))]"
    },
    "huntingQueryObject287": {
      "huntingQueryVersion287": "1.0.0",
      "_huntingQuerycontentId287": "58e6170e-0512-4485-9638-463fdde85b0e",
      "huntingQueryTemplateSpecName287": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('58e6170e-0512-4485-9638-463fdde85b0e')))]"
    },
    "huntingQueryObject288": {
      "huntingQueryVersion288": "1.0.0",
      "_huntingQuerycontentId288": "fe912310-32f5-4256-933b-d4b45e7e6e54",
      "huntingQueryTemplateSpecName288": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('fe912310-32f5-4256-933b-d4b45e7e6e54')))]"
    },
    "huntingQueryObject289": {
      "huntingQueryVersion289": "1.0.0",
      "_huntingQuerycontentId289": "35ca729c-04b4-4f6c-b383-caed1b85226e",
      "huntingQueryTemplateSpecName289": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('35ca729c-04b4-4f6c-b383-caed1b85226e')))]"
    },
    "huntingQueryObject290": {
      "huntingQueryVersion290": "1.0.0",
      "_huntingQuerycontentId290": "3842e70d-45be-43b1-8206-4ebc4c305f34",
      "huntingQueryTemplateSpecName290": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('3842e70d-45be-43b1-8206-4ebc4c305f34')))]"
    },
    "huntingQueryObject291": {
      "huntingQueryVersion291": "1.0.0",
      "_huntingQuerycontentId291": "761230a3-71ad-4522-bfbc-1dca698ffc42",
      "huntingQueryTemplateSpecName291": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('761230a3-71ad-4522-bfbc-1dca698ffc42')))]"
    },
    "huntingQueryObject292": {
      "huntingQueryVersion292": "1.0.0",
      "_huntingQuerycontentId292": "81f02314-2ff5-45cb-a35d-0deb546a0104",
      "huntingQueryTemplateSpecName292": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('81f02314-2ff5-45cb-a35d-0deb546a0104')))]"
    },
    "huntingQueryObject293": {
      "huntingQueryVersion293": "1.0.0",
      "_huntingQuerycontentId293": "f350f0e7-0e52-434c-a113-197883219f00",
      "huntingQueryTemplateSpecName293": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f350f0e7-0e52-434c-a113-197883219f00')))]"
    },
    "huntingQueryObject294": {
      "huntingQueryVersion294": "1.0.0",
      "_huntingQuerycontentId294": "c5b3e559-7c44-442c-9e73-c753abb02c13",
      "huntingQueryTemplateSpecName294": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('c5b3e559-7c44-442c-9e73-c753abb02c13')))]"
    },
    "huntingQueryObject295": {
      "huntingQueryVersion295": "1.0.0",
      "_huntingQuerycontentId295": "0efbcea0-1dc0-4844-8a9c-3a1d98fc1697",
      "huntingQueryTemplateSpecName295": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0efbcea0-1dc0-4844-8a9c-3a1d98fc1697')))]"
    },
    "huntingQueryObject296": {
      "huntingQueryVersion296": "1.0.0",
      "_huntingQuerycontentId296": "3cc2127f-d9ca-46a0-9628-89f702be82b3",
      "huntingQueryTemplateSpecName296": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('3cc2127f-d9ca-46a0-9628-89f702be82b3')))]"
    },
    "huntingQueryObject297": {
      "huntingQueryVersion297": "1.0.0",
      "_huntingQuerycontentId297": "0b5b076b-9a1c-440c-a11f-8471a75f46fd",
      "huntingQueryTemplateSpecName297": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0b5b076b-9a1c-440c-a11f-8471a75f46fd')))]"
    },
    "huntingQueryObject298": {
      "huntingQueryVersion298": "1.0.0",
      "_huntingQuerycontentId298": "2d16b6fc-eb63-491c-a2c2-1160e2e41dcf",
      "huntingQueryTemplateSpecName298": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('2d16b6fc-eb63-491c-a2c2-1160e2e41dcf')))]"
    },
    "huntingQueryObject299": {
      "huntingQueryVersion299": "1.0.0",
      "_huntingQuerycontentId299": "084a6349-b3d6-4528-91e4-4de5d52424e5",
      "huntingQueryTemplateSpecName299": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('084a6349-b3d6-4528-91e4-4de5d52424e5')))]"
    },
    "huntingQueryObject300": {
      "huntingQueryVersion300": "1.0.0",
      "_huntingQuerycontentId300": "8f404352-c4ff-44d1-8d70-c50ee2fad8f8",
      "huntingQueryTemplateSpecName300": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8f404352-c4ff-44d1-8d70-c50ee2fad8f8')))]"
    },
    "huntingQueryObject301": {
      "huntingQueryVersion301": "1.0.0",
      "_huntingQuerycontentId301": "daa347a4-8251-43a7-9730-32f22aa741ab",
      "huntingQueryTemplateSpecName301": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('daa347a4-8251-43a7-9730-32f22aa741ab')))]"
    },
    "huntingQueryObject302": {
      "huntingQueryVersion302": "1.0.0",
      "_huntingQuerycontentId302": "8722489a-d6f1-4b66-98e9-e3dfda902019",
      "huntingQueryTemplateSpecName302": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('8722489a-d6f1-4b66-98e9-e3dfda902019')))]"
    },
    "huntingQueryObject303": {
      "huntingQueryVersion303": "1.0.1",
      "_huntingQuerycontentId303": "2bdd260c-c687-4cb2-9992-87e5ce677678",
      "huntingQueryTemplateSpecName303": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('2bdd260c-c687-4cb2-9992-87e5ce677678')))]"
    },
    "huntingQueryObject304": {
      "huntingQueryVersion304": "1.0.0",
      "_huntingQuerycontentId304": "e17ddfc6-7478-443b-99ff-286f3d09b8aa",
      "huntingQueryTemplateSpecName304": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('e17ddfc6-7478-443b-99ff-286f3d09b8aa')))]"
    },
    "huntingQueryObject305": {
      "huntingQueryVersion305": "1.0.0",
      "_huntingQuerycontentId305": "4095e430-d3f4-426f-92c5-aa5c5e137ca0",
      "huntingQueryTemplateSpecName305": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('4095e430-d3f4-426f-92c5-aa5c5e137ca0')))]"
    },
    "huntingQueryObject306": {
      "huntingQueryVersion306": "1.0.0",
      "_huntingQuerycontentId306": "a7214393-9da7-432e-9b41-fb02b4f740bd",
      "huntingQueryTemplateSpecName306": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a7214393-9da7-432e-9b41-fb02b4f740bd')))]"
    },
    "huntingQueryObject307": {
      "huntingQueryVersion307": "1.0.0",
      "_huntingQuerycontentId307": "cedc5bfa-01f6-4e54-b87b-1edbe430e27a",
      "huntingQueryTemplateSpecName307": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('cedc5bfa-01f6-4e54-b87b-1edbe430e27a')))]"
    },
    "huntingQueryObject308": {
      "huntingQueryVersion308": "1.0.0",
      "_huntingQuerycontentId308": "d0585c34-1b03-473c-938d-11fe73f7e053",
      "huntingQueryTemplateSpecName308": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('d0585c34-1b03-473c-938d-11fe73f7e053')))]"
    },
    "huntingQueryObject309": {
      "huntingQueryVersion309": "1.0.0",
      "_huntingQuerycontentId309": "63142c12-5d8b-48cf-a0f6-b523c855497c",
      "huntingQueryTemplateSpecName309": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('63142c12-5d8b-48cf-a0f6-b523c855497c')))]"
    },
    "huntingQueryObject310": {
      "huntingQueryVersion310": "1.0.0",
      "_huntingQuerycontentId310": "96976bb1-1993-45b8-a477-8236ee93976b",
      "huntingQueryTemplateSpecName310": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('96976bb1-1993-45b8-a477-8236ee93976b')))]"
    },
    "huntingQueryObject311": {
      "huntingQueryVersion311": "1.0.0",
      "_huntingQuerycontentId311": "1ddee78f-7508-4f4a-9b6b-d2927724217d",
      "huntingQueryTemplateSpecName311": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('1ddee78f-7508-4f4a-9b6b-d2927724217d')))]"
    },
    "huntingQueryObject312": {
      "huntingQueryVersion312": "1.0.0",
      "_huntingQuerycontentId312": "1299962c-804e-459a-8d3d-41d68bc45ba2",
      "huntingQueryTemplateSpecName312": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('1299962c-804e-459a-8d3d-41d68bc45ba2')))]"
    },
    "huntingQueryObject313": {
      "huntingQueryVersion313": "1.0.0",
      "_huntingQuerycontentId313": "cb2fb8f9-89bd-485e-8422-da8cb6c7bc23",
      "huntingQueryTemplateSpecName313": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('cb2fb8f9-89bd-485e-8422-da8cb6c7bc23')))]"
    },
    "huntingQueryObject314": {
      "huntingQueryVersion314": "1.0.0",
      "_huntingQuerycontentId314": "4f669adc-2c00-4bc8-896b-e59f068dcb18",
      "huntingQueryTemplateSpecName314": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('4f669adc-2c00-4bc8-896b-e59f068dcb18')))]"
    },
    "huntingQueryObject315": {
      "huntingQueryVersion315": "1.0.0",
      "_huntingQuerycontentId315": "06ea5081-cdea-40c8-b829-240ece951243",
      "huntingQueryTemplateSpecName315": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('06ea5081-cdea-40c8-b829-240ece951243')))]"
    },
    "huntingQueryObject316": {
      "huntingQueryVersion316": "1.0.0",
      "_huntingQuerycontentId316": "f086d58b-c44b-4fae-903b-f65ad042a4ee",
      "huntingQueryTemplateSpecName316": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f086d58b-c44b-4fae-903b-f65ad042a4ee')))]"
    },
    "huntingQueryObject317": {
      "huntingQueryVersion317": "1.0.0",
      "_huntingQuerycontentId317": "88707168-d4a4-4ca7-a516-b2ee0310af1b",
      "huntingQueryTemplateSpecName317": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('88707168-d4a4-4ca7-a516-b2ee0310af1b')))]"
    },
    "huntingQueryObject318": {
      "huntingQueryVersion318": "1.0.0",
      "_huntingQuerycontentId318": "853bacff-45cf-42f2-b2a6-6727fcf183ef",
      "huntingQueryTemplateSpecName318": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('853bacff-45cf-42f2-b2a6-6727fcf183ef')))]"
    },
    "huntingQueryObject319": {
      "huntingQueryVersion319": "1.0.0",
      "_huntingQuerycontentId319": "829cf5ba-39d5-4986-814e-d46f8437c27b",
      "huntingQueryTemplateSpecName319": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('829cf5ba-39d5-4986-814e-d46f8437c27b')))]"
    },
    "huntingQueryObject320": {
      "huntingQueryVersion320": "1.0.0",
      "_huntingQuerycontentId320": "3dd9ab09-0ea3-4f47-ba10-f84045ab52c3",
      "huntingQueryTemplateSpecName320": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('3dd9ab09-0ea3-4f47-ba10-f84045ab52c3')))]"
    },
    "huntingQueryObject321": {
      "huntingQueryVersion321": "1.0.0",
      "_huntingQuerycontentId321": "4dd31bd5-11a3-4b9c-a7c5-4927ab4f2a77",
      "huntingQueryTemplateSpecName321": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('4dd31bd5-11a3-4b9c-a7c5-4927ab4f2a77')))]"
    },
    "huntingQueryObject322": {
      "huntingQueryVersion322": "1.0.0",
      "_huntingQuerycontentId322": "74cc0176-3900-440e-b179-45d6a957145a",
      "huntingQueryTemplateSpecName322": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('74cc0176-3900-440e-b179-45d6a957145a')))]"
    },
    "huntingQueryObject323": {
      "huntingQueryVersion323": "1.0.0",
      "_huntingQuerycontentId323": "e18109aa-f252-48ec-b115-1b7c16e1174f",
      "huntingQueryTemplateSpecName323": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('e18109aa-f252-48ec-b115-1b7c16e1174f')))]"
    },
    "huntingQueryObject324": {
      "huntingQueryVersion324": "1.0.0",
      "_huntingQuerycontentId324": "aa3a8508-c0ff-404d-8d5c-4e7f548b0d86",
      "huntingQueryTemplateSpecName324": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('aa3a8508-c0ff-404d-8d5c-4e7f548b0d86')))]"
    },
    "huntingQueryObject325": {
      "huntingQueryVersion325": "1.0.0",
      "_huntingQuerycontentId325": "9674f529-f0e9-4305-862d-479ccc9e28f1",
      "huntingQueryTemplateSpecName325": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('9674f529-f0e9-4305-862d-479ccc9e28f1')))]"
    },
    "huntingQueryObject326": {
      "huntingQueryVersion326": "1.0.0",
      "_huntingQuerycontentId326": "180bacfd-18de-450a-8e0c-7d2fa399ca49",
      "huntingQueryTemplateSpecName326": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('180bacfd-18de-450a-8e0c-7d2fa399ca49')))]"
    },
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "MicrosoftDefenderForOffice365detectionsandinsights",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "workbookVersion2": "1.0.0",
    "workbookContentId2": "MicrosoftDefenderForEndPoint",
    "workbookId2": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId2'))]",
    "workbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId2'))))]",
    "_workbookContentId2": "[variables('workbookContentId2')]",
    "_workbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId2'),'-', variables('workbookVersion2'))))]",
    "workbookVersion3": "1.0.0",
    "workbookContentId3": "MicrosoftDefenderForIdentity",
    "workbookId3": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId3'))]",
    "workbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId3'))))]",
    "_workbookContentId3": "[variables('workbookContentId3')]",
    "_workbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId3'),'-', variables('workbookVersion3'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Microsoft Defender XDR data connector with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "StaticUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "Microsoft Defender XDR",
                  "publisher": "Microsoft",
                  "descriptionMarkdown": "Microsoft Defender XDR is a unified, natively integrated, pre- and post-breach enterprise defense suite that protects endpoint, identity, email, and applications and helps you detect, prevent, investigate, and automatically respond to sophisticated threats.\n\nMicrosoft Defender XDR suite includes: \n- Microsoft Defender for Endpoint\n- Microsoft Defender for Identity\n- Microsoft Defender for Office 365\n- Threat & Vulnerability Management\n- Microsoft Defender for Cloud Apps\n\nFor more information, see the [Microsoft Sentinel documentation](https://go.microsoft.com/fwlink/p/?linkid=2220004&wt.mc_id=sentinel_dataconnectordocs_content_cnl_csasci).",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "Incidents",
                      "baseQuery": "SecurityIncident \n| where ProviderName == \"Microsoft 365 Defender\""
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "Alerts",
                      "baseQuery": "SecurityAlert \n| where ProductName in(\"Microsoft Defender Advanced Threat Protection\",\"Office 365 Advanced Threat Protection\",\"Azure Advanced Threat Protection\",\"Microsoft Cloud App Security\",\"Microsoft 365 Defender\")"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "Endpoint Events",
                      "baseQuery": "DeviceEvents| union isfuzzy=true DeviceFileEvents| union isfuzzy=true DeviceImageLoadEvents| union isfuzzy=true DeviceInfo| union isfuzzy=true DeviceLogonEvents| union isfuzzy=true DeviceNetworkEvents| union isfuzzy=true DeviceNetworkInfo| union isfuzzy=true DeviceProcessEvents| union isfuzzy=true DeviceRegistryEvents| union isfuzzy=true DeviceFileCertificateInfo"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "Office Events",
                      "baseQuery": "EmailEvents| union isfuzzy=true EmailUrlInfo| union isfuzzy=true EmailAttachmentInfo| union isfuzzy=true EmailPostDeliveryEvents"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "Identity Events",
                      "baseQuery": "IdentityLogonEvents| union isfuzzy=true IdentityQueryEvents| union isfuzzy=true IdentityDirectoryEvents"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "Cloud app Events",
                      "baseQuery": "CloudAppEvents"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "Defender Alert Evidence",
                      "baseQuery": "AlertEvidence"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "SentinelKinds",
                      "value": [
                        "MicrosoftThreatProtection"
                      ]
                    },
                    {
                      "type": "MtpAlerts",
                      "value": [
                        "AzureAdvancedThreatProtection",
                        "MicrosoftCloudAppSecurity",
                        "MicrosoftThreatProtection",
                        "OfficeATP",
                        "MicrosoftDefenderAdvancedThreatProtection",
                        "AzureActiveDirectory",
                        "OfficeIRM"
                      ]
                    },
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "DeviceEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "DeviceFileEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "DeviceImageLoadEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "DeviceInfo\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "DeviceLogonEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "DeviceNetworkEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "DeviceNetworkInfo\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "DeviceProcessEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "DeviceRegistryEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "DeviceFileCertificateInfo\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    },
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "EmailEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "EmailUrlInfo\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "EmailAttachmentInfo\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "EmailPostDeliveryEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "UrlClickEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    },
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "IdentityLogonEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "IdentityQueryEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                        "IdentityDirectoryEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    },
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CloudAppEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    },
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "AlertEvidence\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "SecurityIncident",
                      "lastDataReceivedQuery": "SecurityIncident \n| where ProviderName == \"Microsoft 365 Defender\"\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "SecurityAlert",
                      "lastDataReceivedQuery": "SecurityAlert \n| where ProductName in(\"Microsoft Defender Advanced Threat Protection\",\"Office 365 Advanced Threat Protection\",\"Azure Advanced Threat Protection\",\"Microsoft Cloud App Security\",\"Microsoft 365 Defender\")\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "DeviceEvents",
                      "lastDataReceivedQuery": "DeviceEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "DeviceFileEvents",
                      "lastDataReceivedQuery": "DeviceFileEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "DeviceImageLoadEvents",
                      "lastDataReceivedQuery": "DeviceImageLoadEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "DeviceInfo",
                      "lastDataReceivedQuery": "DeviceInfo\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "DeviceLogonEvents",
                      "lastDataReceivedQuery": "DeviceLogonEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "DeviceNetworkEvents",
                      "lastDataReceivedQuery": "DeviceNetworkEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "DeviceNetworkInfo",
                      "lastDataReceivedQuery": "DeviceNetworkInfo\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "DeviceProcessEvents",
                      "lastDataReceivedQuery": "DeviceProcessEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "DeviceRegistryEvents",
                      "lastDataReceivedQuery": "DeviceRegistryEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "DeviceFileCertificateInfo",
                      "lastDataReceivedQuery": "DeviceFileCertificateInfo\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "EmailEvents",
                      "lastDataReceivedQuery": "EmailEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "EmailUrlInfo",
                      "lastDataReceivedQuery": "EmailUrlInfo\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "EmailAttachmentInfo",
                      "lastDataReceivedQuery": "EmailAttachmentInfo\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "EmailPostDeliveryEvents",
                      "lastDataReceivedQuery": "EmailPostDeliveryEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "UrlClickEvents",
                      "lastDataReceivedQuery": "UrlClickEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "IdentityLogonEvents",
                      "lastDataReceivedQuery": "IdentityLogonEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "IdentityQueryEvents",
                      "lastDataReceivedQuery": "IdentityQueryEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "IdentityDirectoryEvents",
                      "lastDataReceivedQuery": "IdentityDirectoryEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "CloudAppEvents",
                      "lastDataReceivedQuery": "CloudAppEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "AlertEvidence",
                      "lastDataReceivedQuery": "AlertEvidence\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2023-04-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "contentKind": "DataConnector",
        "displayName": "Microsoft Defender XDR",
        "contentProductId": "[variables('_dataConnectorcontentProductId1')]",
        "id": "[variables('_dataConnectorcontentProductId1')]",
        "version": "[variables('dataConnectorVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Microsoft Defender XDR",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "StaticUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Microsoft Defender XDR",
          "publisher": "Microsoft",
          "descriptionMarkdown": "Microsoft Defender XDR is a unified, natively integrated, pre- and post-breach enterprise defense suite that protects endpoint, identity, email, and applications and helps you detect, prevent, investigate, and automatically respond to sophisticated threats.\n\nMicrosoft Defender XDR suite includes: \n- Microsoft Defender for Endpoint\n- Microsoft Defender for Identity\n- Microsoft Defender for Office 365\n- Threat & Vulnerability Management\n- Microsoft Defender for Cloud Apps\n\nFor more information, see the [Microsoft Sentinel documentation](https://go.microsoft.com/fwlink/p/?linkid=2220004&wt.mc_id=sentinel_dataconnectordocs_content_cnl_csasci).",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "Incidents",
              "baseQuery": "SecurityIncident \n| where ProviderName == \"Microsoft 365 Defender\""
            },
            {
              "metricName": "Total data received",
              "legend": "Alerts",
              "baseQuery": "SecurityAlert \n| where ProductName in(\"Microsoft Defender Advanced Threat Protection\",\"Office 365 Advanced Threat Protection\",\"Azure Advanced Threat Protection\",\"Microsoft Cloud App Security\",\"Microsoft 365 Defender\")"
            },
            {
              "metricName": "Total data received",
              "legend": "Endpoint Events",
              "baseQuery": "DeviceEvents| union isfuzzy=true DeviceFileEvents| union isfuzzy=true DeviceImageLoadEvents| union isfuzzy=true DeviceInfo| union isfuzzy=true DeviceLogonEvents| union isfuzzy=true DeviceNetworkEvents| union isfuzzy=true DeviceNetworkInfo| union isfuzzy=true DeviceProcessEvents| union isfuzzy=true DeviceRegistryEvents| union isfuzzy=true DeviceFileCertificateInfo"
            },
            {
              "metricName": "Total data received",
              "legend": "Office Events",
              "baseQuery": "EmailEvents| union isfuzzy=true EmailUrlInfo| union isfuzzy=true EmailAttachmentInfo| union isfuzzy=true EmailPostDeliveryEvents"
            },
            {
              "metricName": "Total data received",
              "legend": "Identity Events",
              "baseQuery": "IdentityLogonEvents| union isfuzzy=true IdentityQueryEvents| union isfuzzy=true IdentityDirectoryEvents"
            },
            {
              "metricName": "Total data received",
              "legend": "Cloud app Events",
              "baseQuery": "CloudAppEvents"
            },
            {
              "metricName": "Total data received",
              "legend": "Defender Alert Evidence",
              "baseQuery": "AlertEvidence"
            }
          ],
          "dataTypes": [
            {
              "name": "SecurityIncident",
              "lastDataReceivedQuery": "SecurityIncident \n| where ProviderName == \"Microsoft 365 Defender\"\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "SecurityAlert",
              "lastDataReceivedQuery": "SecurityAlert \n| where ProductName in(\"Microsoft Defender Advanced Threat Protection\",\"Office 365 Advanced Threat Protection\",\"Azure Advanced Threat Protection\",\"Microsoft Cloud App Security\",\"Microsoft 365 Defender\")\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "DeviceEvents",
              "lastDataReceivedQuery": "DeviceEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "DeviceFileEvents",
              "lastDataReceivedQuery": "DeviceFileEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "DeviceImageLoadEvents",
              "lastDataReceivedQuery": "DeviceImageLoadEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "DeviceInfo",
              "lastDataReceivedQuery": "DeviceInfo\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "DeviceLogonEvents",
              "lastDataReceivedQuery": "DeviceLogonEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "DeviceNetworkEvents",
              "lastDataReceivedQuery": "DeviceNetworkEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "DeviceNetworkInfo",
              "lastDataReceivedQuery": "DeviceNetworkInfo\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "DeviceProcessEvents",
              "lastDataReceivedQuery": "DeviceProcessEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "DeviceRegistryEvents",
              "lastDataReceivedQuery": "DeviceRegistryEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "DeviceFileCertificateInfo",
              "lastDataReceivedQuery": "DeviceFileCertificateInfo\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "EmailEvents",
              "lastDataReceivedQuery": "EmailEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "EmailUrlInfo",
              "lastDataReceivedQuery": "EmailUrlInfo\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "EmailAttachmentInfo",
              "lastDataReceivedQuery": "EmailAttachmentInfo\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "EmailPostDeliveryEvents",
              "lastDataReceivedQuery": "EmailPostDeliveryEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "UrlClickEvents",
              "lastDataReceivedQuery": "UrlClickEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "IdentityLogonEvents",
              "lastDataReceivedQuery": "IdentityLogonEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "IdentityQueryEvents",
              "lastDataReceivedQuery": "IdentityQueryEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "IdentityDirectoryEvents",
              "lastDataReceivedQuery": "IdentityDirectoryEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "CloudAppEvents",
              "lastDataReceivedQuery": "CloudAppEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "AlertEvidence",
              "lastDataReceivedQuery": "AlertEvidence\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "SentinelKinds",
              "value": [
                "MicrosoftThreatProtection"
              ]
            },
            {
              "type": "MtpAlerts",
              "value": [
                "AzureAdvancedThreatProtection",
                "MicrosoftCloudAppSecurity",
                "MicrosoftThreatProtection",
                "OfficeATP",
                "MicrosoftDefenderAdvancedThreatProtection",
                "AzureActiveDirectory",
                "OfficeIRM"
              ]
            },
            {
              "type": "IsConnectedQuery",
              "value": [
                "DeviceEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "DeviceFileEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "DeviceImageLoadEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "DeviceInfo\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "DeviceLogonEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "DeviceNetworkEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "DeviceNetworkInfo\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "DeviceProcessEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "DeviceRegistryEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "DeviceFileCertificateInfo\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            },
            {
              "type": "IsConnectedQuery",
              "value": [
                "EmailEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "EmailUrlInfo\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "EmailAttachmentInfo\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "EmailPostDeliveryEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "UrlClickEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            },
            {
              "type": "IsConnectedQuery",
              "value": [
                "IdentityLogonEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "IdentityQueryEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                "IdentityDirectoryEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            },
            {
              "type": "IsConnectedQuery",
              "value": [
                "CloudAppEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            },
            {
              "type": "IsConnectedQuery",
              "value": [
                "AlertEvidence\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "id": "[variables('_uiConfigId1')]"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PossiblePhishingwithCSL&NetworkSession_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query looks for malicious URL clicks in phishing email recognized by MDO in correlation with CommonSecurityLogs(CSL) & NetworkSession events. \nIf your workspace doesnt have one of the many data sources required for ASIM it may give informational error which can be safely ignored.",
                "displayName": "Possible Phishing with CSL and Network Sessions",
                "enabled": false,
                "query": "//SuspiciousUrlClicked\nAlertEvidence\n| where ServiceSource =~ \"Microsoft Defender for Office 365\"\n| where EntityType =~ \"Url\"\n| project AlertId, RemoteUrl\n| join kind=inner (\nAlertEvidence\n| where ServiceSource =~ \"Microsoft Defender for Office 365\"\n| where EntityType =~ \"MailMessage\"\n| project AlertId, NetworkMessageId\n)\non AlertId\n| distinct RemoteUrl, NetworkMessageId\n| join EmailEvents on NetworkMessageId\n| distinct RemoteUrl, NetworkMessageId, RecipientEmailAddress, RecipientObjectId\n| join kind = inner IdentityInfo on $left.RecipientObjectId  == $right.AccountObjectId\n| distinct RemoteUrl, NetworkMessageId, RecipientEmailAddress , RecipientObjectId, AccountSID\n| join kind = inner  \n(DeviceEvents\n| where ActionType =~ \"BrowserLaunchedToOpenUrl\"| where isnotempty(RemoteUrl)\n| project  UrlClickedByUserSid = RemoteUrl,\nInitiatingProcessAccountSid, DeviceName, DeviceId, InitiatingProcessFileName,\nInitiatingProcessAccountUpn, InitiatingProcessAccountName, InitiatingProcessAccountDomain\n)\non $left.AccountSID == $right.InitiatingProcessAccountSid and $left.RemoteUrl == $right.UrlClickedByUserSid\n| distinct  RemoteUrl, NetworkMessageId, RecipientEmailAddress, RecipientObjectId,\n AccountSID, UrlClickedByUserSid, DeviceName, DeviceId, InitiatingProcessFileName,\n InitiatingProcessAccountUpn, InitiatingProcessAccountName, InitiatingProcessAccountDomain\n|  join kind=inner\n(\n//Suspicious url clicked found in common security logs\nCommonSecurityLog\n| project TimeGenerated, DeviceVendor, DeviceProduct, DeviceAction, DestinationDnsDomain, DestinationIP, RequestURL, SourceIP, SourceHostName, RequestClientApplication\n) on $left.RemoteUrl== $right.RequestURL\n|  join kind=inner\n(\n//Find the relevant network sessions\n_Im_NetworkSession\n| where isnotempty(DstIpAddr)\n| where not(ipv4_is_private(DstIpAddr))\n| project TimeGenerated, SrcIpAddr, SrcPortNumber, DstIpAddr, DstPortNumber, DstBytes, SrcBytes\n) on  $left.DestinationIP == $right.DstIpAddr //The relevant network session being projected \n| summarize count() by TimeGenerated, RecipientEmailAddress, UrlClickedByUserSid, InitiatingProcessAccountUpn, InitiatingProcessAccountName, InitiatingProcessAccountDomain,\nDeviceName, InitiatingProcessFileName, DeviceProduct, DeviceAction, SourceIP, DestinationIP, RequestClientApplication\n| extend HostName = tostring(split(DeviceName, \".\")[0]), DomainIndex = toint(indexof(DeviceName, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(DeviceName, DomainIndex + 1), DeviceName)\n| extend RecipientEmailName = tostring(split(RecipientEmailAddress,'@',0)[0]), RecipientEmailUPNSuffix = tostring(split(RecipientEmailAddress,'@',1)[0])\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "AlertEvidence",
                      "EmailEvents",
                      "IdentityInfo",
                      "DeviceEvents",
                      "DeviceNetworkEvents"
                    ]
                  },
                  {
                    "connectorId": "Zscaler",
                    "dataTypes": [
                      "CommonSecurityLog"
                    ]
                  },
                  {
                    "connectorId": "Fortinet",
                    "dataTypes": [
                      "CommonSecurityLog"
                    ]
                  },
                  {
                    "connectorId": "CheckPoint",
                    "dataTypes": [
                      "CommonSecurityLog"
                    ]
                  },
                  {
                    "connectorId": "PaloAltoNetworks",
                    "dataTypes": [
                      "CommonSecurityLog"
                    ]
                  },
                  {
                    "connectorId": "AWSS3",
                    "datatypes": [
                      "AWSVPCFlow"
                    ]
                  },
                  {
                    "connectorId": "WindowsForwardedEvents",
                    "dataTypes": [
                      "WindowsEvent"
                    ]
                  },
                  {
                    "connectorId": "SecurityEvents",
                    "dataTypes": [
                      "SecurityEvent"
                    ]
                  },
                  {
                    "connectorId": "WindowsSecurityEvents",
                    "dataTypes": [
                      "SecurityEvent"
                    ]
                  },
                  {
                    "connectorId": "MicrosoftSysmonForLinux",
                    "dataTypes": [
                      "Syslog"
                    ]
                  },
                  {
                    "connectorId": "AzureNSG",
                    "dataTypes": [
                      "AzureDiagnostics"
                    ]
                  },
                  {
                    "connectorId": "AzureMonitor(VMInsights)",
                    "dataTypes": [
                      "VMConnection"
                    ]
                  },
                  {
                    "connectorId": "AIVectraStream",
                    "dataTypes": [
                      "VectraStream_CL"
                    ]
                  }
                ],
                "tactics": [
                  "InitialAccess",
                  "CommandAndControl"
                ],
                "techniques": [
                  "T1566",
                  "T1102"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "InitiatingProcessAccountUpn",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "InitiatingProcessAccountName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "InitiatingProcessAccountDomain",
                        "identifier": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "RecipientEmailAddress",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "RecipientEmailName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "RecipientEmailUPNSuffix",
                        "identifier": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "HostNameDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "SourceIP",
                        "identifier": "Address"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "DestinationIP",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 1",
                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
        "contentKind": "AnalyticsRule",
        "displayName": "Possible Phishing with CSL and Network Sessions",
        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SUNSPOTHashes_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query uses Microsoft Defender for Endpoint data to look for IoCs associated with the SUNSPOT malware shared by Crowdstrike.\nMore details: \n  - https://www.crowdstrike.com/blog/sunspot-malware-technical-analysis/ \n  - https://techcommunity.microsoft.com/t5/azure-sentinel/monitoring-your-software-build-process-with-azure-sentinel/ba-p/2140807",
                "displayName": "SUNSPOT malware hashes",
                "enabled": false,
                "query": "let SUNSPOT_Hashes = dynamic([\"c45c9bda8db1d470f1fd0dcc346dc449839eb5ce9a948c70369230af0b3ef168\", \"0819db19be479122c1d48743e644070a8dc9a1c852df9a8c0dc2343e904da389\"]);\nunion isfuzzy=true(\nDeviceEvents\n| where InitiatingProcessSHA256 in (SUNSPOT_Hashes)),\n(DeviceImageLoadEvents\n| where InitiatingProcessSHA256 in (SUNSPOT_Hashes))\n| extend timestamp=TimeGenerated\n| extend HostName = tostring(split(DeviceName, \".\")[0]), DomainIndex = toint(indexof(DeviceName, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(DeviceName, DomainIndex + 1), DeviceName)\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceImageLoadEvents",
                      "DeviceEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "techniques": [
                  "T1554"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "HostNameDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "InitiatingProcessAccountUpn",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "InitiatingProcessAccountName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "InitiatingProcessAccountDomain",
                        "identifier": "UPNSuffix"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 2",
                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
        "contentKind": "AnalyticsRule",
        "displayName": "SUNSPOT malware hashes",
        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject3').analyticRuleTemplateSpecName3]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PotentialBuildProcessCompromiseMDE_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject3').analyticRuleVersion3]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "The query looks for source code files being modified immediately after a build process is started. The purpose of this is to look for malicious code injection during the build process. This query uses Microsoft Defender for Endpoint telemetry.\nMore details: https://techcommunity.microsoft.com/t5/azure-sentinel/monitoring-the-software-supply-chain-with-azure-sentinel/ba-p/2176463",
                "displayName": "Potential Build Process Compromise - MDE",
                "enabled": false,
                "query": "// How far back to look for events from\nlet timeframe = 1d;\n// How close together build events and file modifications should occur to alert (make this smaller to reduce FPs)\nlet time_window = 5m;\n// Edit this to include build processes used\nlet build_processes = dynamic([\"MSBuild.exe\", \"dotnet.exe\", \"VBCSCompiler.exe\"]);\n// Include any processes that you want to allow to edit files during/around the build process\nlet allow_list = dynamic([]);\nDeviceProcessEvents\n| where TimeGenerated > ago(timeframe)\n// Look for build process starts\n| where FileName has_any (build_processes)\n| summarize by BuildParentProcess=InitiatingProcessFileName, BuildProcess=FileName, BuildAccount = AccountName, DeviceName, BuildCommand=ProcessCommandLine, \ntimekey= bin(TimeGenerated, time_window), BuildProcessTime=TimeGenerated\n| join kind=inner(\nDeviceFileEvents\n| where TimeGenerated > ago(timeframe)\n| where InitiatingProcessFileName !in (allow_list)\n| where ActionType == \"FileCreated\"  or ActionType == \"FileModified\"\n// Look for code files, edit this to include file extensions used in build.\n| where FileName endswith \".cs\" or FileName endswith \".cpp\"\n| summarize by FileEditParentProcess=InitiatingProcessParentFileName, FileEditAccount = InitiatingProcessAccountName, FileEditDomain = InitiatingProcessAccountDomain, FileEditUpn = InitiatingProcessAccountUpn, \nDeviceName, FileEdited=FileName, FileEditProcess=InitiatingProcessFileName, timekey= bin(TimeGenerated, time_window), FileEditTime=TimeGenerated)\n// join where build processes and file modifications seen at same time on same host\non timekey, DeviceName\n// Limit to only where the file edit happens after the build process starts\n| where BuildProcessTime <= FileEditTime\n| summarize make_set(FileEdited), make_set(FileEditProcess) by timekey, DeviceName, BuildParentProcess, BuildProcess, FileEditAccount, FileEditDomain, FileEditUpn\n| extend HostName = tostring(split(DeviceName, \".\")[0]), DomainIndex = toint(indexof(DeviceName, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(DeviceName, DomainIndex + 1), DeviceName)\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents",
                      "DeviceFileEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "techniques": [
                  "T1554"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "HostNameDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "FileEditUpn",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "FileEditAccount",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "FileEditDomain",
                        "identifier": "UPNSuffix"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject3').analyticRuleId3,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 3",
                "parentId": "[variables('analyticRuleObject3').analyticRuleId3]",
                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
        "contentKind": "AnalyticsRule",
        "displayName": "Potential Build Process Compromise - MDE",
        "contentProductId": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "id": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject4').analyticRuleTemplateSpecName4]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SolarWinds_TEARDROP_Process-IOCs_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject4').analyticRuleVersion4]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies SolarWinds TEARDROP memory-only dropper IOCs in Window's defender Exploit Guard activity\nReferences:\n- https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html\n- https://gist.github.com/olafhartong/71ffdd4cab4b6acd5cbcd1a0691ff82f",
                "displayName": "TEARDROP memory-only dropper",
                "enabled": false,
                "query": "DeviceEvents\n| where ActionType has \"ExploitGuardNonMicrosoftSignedBlocked\"\n| where InitiatingProcessFileName has \"svchost.exe\" and FileName has \"NetSetupSvc.dll\"\n| extend HashAlgorithm = \"SHA1\"\n| extend HostName = tostring(split(DeviceName, \".\")[0]), DomainIndex = toint(indexof(DeviceName, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(DeviceName, DomainIndex + 1), DeviceName)\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Execution",
                  "Persistence",
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1543",
                  "T1059",
                  "T1027"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "HostNameDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "InitiatingProcessAccountUpn",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "InitiatingProcessAccountName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "InitiatingProcessAccountDomain",
                        "identifier": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "FileHash",
                    "fieldMappings": [
                      {
                        "columnName": "HashAlgorithm",
                        "identifier": "Algorithm"
                      },
                      {
                        "columnName": "InitiatingProcessSHA1",
                        "identifier": "Value"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject4').analyticRuleId4,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 4",
                "parentId": "[variables('analyticRuleObject4').analyticRuleId4]",
                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
        "contentKind": "AnalyticsRule",
        "displayName": "TEARDROP memory-only dropper",
        "contentProductId": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "id": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject5').analyticRuleTemplateSpecName5]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SolarWinds_SUNBURST_Network-IOCs_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject5').analyticRuleVersion5]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies SolarWinds SUNBURST domain beacon IOCs in DeviceNetworkEvents\nReferences:\n- https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html\n- https://gist.github.com/olafhartong/71ffdd4cab4b6acd5cbcd1a0691ff82f",
                "displayName": "SUNBURST network beacons",
                "enabled": false,
                "query": "let SunburstURL=dynamic([\"panhardware.com\",\"databasegalore.com\",\"avsvmcloud.com\",\"freescanonline.com\",\"thedoccloud.com\",\"deftsecurity.com\"]);\nDeviceNetworkEvents\n| where ActionType == \"ConnectionSuccess\"\n| where RemoteUrl in(SunburstURL)\n| extend HashAlgorithm = 'MD5'\n| extend HostName = tostring(split(DeviceName, \".\")[0]), DomainIndex = toint(indexof(DeviceName, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(DeviceName, DomainIndex + 1), DeviceName)\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceNetworkEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Execution",
                  "Persistence",
                  "InitialAccess"
                ],
                "techniques": [
                  "T1195",
                  "T1059",
                  "T1546"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "HostNameDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "InitiatingProcessAccountUpn",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "InitiatingProcessAccountName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "InitiatingProcessAccountDomain",
                        "identifier": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "RemoteIP",
                        "identifier": "Address"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "RemoteUrl",
                        "identifier": "Url"
                      }
                    ]
                  },
                  {
                    "entityType": "FileHash",
                    "fieldMappings": [
                      {
                        "columnName": "HashAlgorithm",
                        "identifier": "Algorithm"
                      },
                      {
                        "columnName": "InitiatingProcessMD5",
                        "identifier": "Value"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject5').analyticRuleId5,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 5",
                "parentId": "[variables('analyticRuleObject5').analyticRuleId5]",
                "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
        "contentKind": "AnalyticsRule",
        "displayName": "SUNBURST network beacons",
        "contentProductId": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
        "id": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
        "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject6').analyticRuleTemplateSpecName6]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SolarWinds_SUNBURST_&_SUPERNOVA_File-IOCs_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject6').analyticRuleVersion6]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies SolarWinds SUNBURST and SUPERNOVA backdoor file hash IOCs in DeviceFileEvents\nReferences:\n- https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html\n- https://gist.github.com/olafhartong/71ffdd4cab4b6acd5cbcd1a0691ff82f",
                "displayName": "SUNBURST and SUPERNOVA backdoor hashes",
                "enabled": false,
                "query": "let SunburstMD5=dynamic([\"b91ce2fa41029f6955bff20079468448\",\"02af7cec58b9a5da1c542b5a32151ba1\",\"2c4a910a1299cdae2a4e55988a2f102e\",\"846e27a652a5e1bfbd0ddd38a16dc865\",\"4f2eb62fa529c0283b28d05ddd311fae\"]);\nlet SupernovaMD5=\"56ceb6d0011d87b6e4d7023d7ef85676\";\nDeviceFileEvents\n| where MD5 in(SunburstMD5) or MD5 in(SupernovaMD5)\n| extend HashAlgorithm = \"MD5\"\n| extend HostName = tostring(split(DeviceName, \".\")[0]), DomainIndex = toint(indexof(DeviceName, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(DeviceName, DomainIndex + 1), DeviceName)\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceFileEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Execution",
                  "Persistence",
                  "InitialAccess"
                ],
                "techniques": [
                  "T1195",
                  "T1059",
                  "T1546"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "HostNameDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "InitiatingProcessAccountUpn",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "InitiatingProcessAccountName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "InitiatingProcessAccountDomain",
                        "identifier": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "FileHash",
                    "fieldMappings": [
                      {
                        "columnName": "HashAlgorithm",
                        "identifier": "Algorithm"
                      },
                      {
                        "columnName": "MD5",
                        "identifier": "Value"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject6').analyticRuleId6,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 6",
                "parentId": "[variables('analyticRuleObject6').analyticRuleId6]",
                "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject6').analyticRuleVersion6]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
        "contentKind": "AnalyticsRule",
        "displayName": "SUNBURST and SUPERNOVA backdoor hashes",
        "contentProductId": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
        "id": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
        "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject7').analyticRuleTemplateSpecName7]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AVdetectionsrelatedtoUkrainebasedthreats_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject7').analyticRuleVersion7]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query looks for Microsoft Defender AV detections for malware observed in relation to the war in Ukraine.\n  Ref: https://msrc-blog.microsoft.com/2022/02/28/analysis-resources-cyber-threat-activity-ukraine/ ",
                "displayName": "AV detections related to Ukraine threats",
                "enabled": false,
                "query": "let UA_threats = dynamic([\"FoxBlade\", \"WhisperGate\", \"Lasainraw\", \"SonicVote\", \"CaddyWiper\", \"AprilAxe\", \"FiberLake\", \"Industroyer\", \"DesertBlade\"]);\nSecurityAlert\n| where ProviderName =~ \"MDATP\"\n| extend ThreatFamilyName = tostring(parse_json(ExtendedProperties).ThreatFamilyName)\n| where ThreatFamilyName in~ (UA_threats)\n| extend HostName = tostring(split(CompromisedEntity, \".\")[0]), DomainIndex = toint(indexof(CompromisedEntity, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(CompromisedEntity, DomainIndex + 1), CompromisedEntity)\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "SecurityAlert"
                    ]
                  }
                ],
                "tactics": [
                  "Impact"
                ],
                "techniques": [
                  "T1485"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "CompromisedEntity",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "HostNameDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject7').analyticRuleId7,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 7",
                "parentId": "[variables('analyticRuleObject7').analyticRuleId7]",
                "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject7').analyticRuleVersion7]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
        "contentKind": "AnalyticsRule",
        "displayName": "AV detections related to Ukraine threats",
        "contentProductId": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
        "id": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
        "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject8').analyticRuleTemplateSpecName8]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AVTarrask_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject8').analyticRuleVersion8]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query looks for Microsoft Defender AV detections related to Tarrask malware. In Microsoft Sentinel, the SecurityAlerts table includes only the Device Name of the affected device, this query joins the DeviceInfo table to clearly connect other information such as Device group, ip, logged-on users etc. \n This would allow the Microsoft Sentinel analyst to have more context related to the alert, if available.\n Reference: https://www.microsoft.com/security/blog/2022/04/12/tarrask-malware-uses-scheduled-tasks-for-defense-evasion/",
                "displayName": "AV detections related to Tarrask malware",
                "enabled": false,
                "query": "let Tarrask_threats = dynamic([\"HackTool:Win64/Tarrask!MS\", \"HackTool:Win64/Ligolo!MSR\", \"Behavior:Win32/ScheduledTaskHide.A\", \"Tarrask\"]);\nDeviceInfo\n| extend DeviceName = tolower(DeviceName)\n| join kind=rightouter ( SecurityAlert\n| where ProviderName =~ \"MDATP\"\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n| extend ThreatFamilyName = tostring(parse_json(ExtendedProperties).ThreatFamilyName)\n| where ThreatName in~ (Tarrask_threats) or ThreatFamilyName in~ (Tarrask_threats)\n| extend CompromisedEntity = tolower(CompromisedEntity)\n) on $left.DeviceName == $right.CompromisedEntity\n| summarize by DisplayName, ThreatName, ThreatFamilyName, PublicIP, AlertSeverity, Description, tostring(LoggedOnUsers), DeviceId, TenantId , bin(TimeGenerated, 1d), CompromisedEntity, tostring(LoggedOnUsers), ProductName, Entities\n| extend HostName = tostring(split(CompromisedEntity, \".\")[0]), DomainIndex = toint(indexof(CompromisedEntity, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(CompromisedEntity, DomainIndex + 1), CompromisedEntity)\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "SecurityAlert"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "techniques": [
                  "T1053"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "CompromisedEntity",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "HostNameDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "PublicIP",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject8').analyticRuleId8,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 8",
                "parentId": "[variables('analyticRuleObject8').analyticRuleId8]",
                "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject8').analyticRuleVersion8]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
        "contentKind": "AnalyticsRule",
        "displayName": "AV detections related to Tarrask malware",
        "contentProductId": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
        "id": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
        "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject9').analyticRuleTemplateSpecName9]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AVSpringShell_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject9').analyticRuleVersion9]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query looks for Microsoft Defender AV detections related to the SpringShell vulnerability. In Microsoft Sentinel, the SecurityAlerts table includes only the Device Name of the affected device.\n  This query joins the DeviceInfo table to clearly connect other information such as device group, IP, logged-on users, etc. This would allow the Microsoft Sentinel analyst to have more context related to the alert, if available.\n  Reference: https://www.microsoft.com/security/blog/2022/04/04/springshell-rce-vulnerability-guidance-for-protecting-against-and-detecting-cve-2022-22965/",
                "displayName": "AV detections related to SpringShell Vulnerability",
                "enabled": false,
                "query": "let SpringShell_threats = dynamic([\"Trojan:Python/SpringShellExpl\", \"Exploit:Python/SpringShell\", \"Backdoor:PHP/Remoteshell.V\", \"SpringShell\"]);\nDeviceInfo\n| extend DeviceName = tolower(DeviceName)\n| join kind=inner ( SecurityAlert\n| where ProviderName =~ \"MDATP\"\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n| extend ThreatFamilyName = tostring(parse_json(ExtendedProperties).ThreatFamilyName)\n| where ThreatName in~ (SpringShell_threats) or ThreatFamilyName in~ (SpringShell_threats)\n| extend CompromisedEntity = tolower(CompromisedEntity)\n) on $left.DeviceName == $right.CompromisedEntity\n| summarize by DisplayName, ThreatName, ThreatFamilyName, PublicIP, AlertSeverity, Description, tostring(LoggedOnUsers), DeviceId, TenantId , bin(TimeGenerated, 1d), CompromisedEntity, tostring(LoggedOnUsers), ProductName, Entities\n| extend HostName = tostring(split(CompromisedEntity, \".\")[0]), DomainIndex = toint(indexof(CompromisedEntity, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(CompromisedEntity, DomainIndex + 1), CompromisedEntity)\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "SecurityAlert"
                    ]
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1190"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "CompromisedEntity",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "HostNameDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "PublicIP",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject9').analyticRuleId9,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 9",
                "parentId": "[variables('analyticRuleObject9').analyticRuleId9]",
                "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject9').analyticRuleVersion9]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
        "contentKind": "AnalyticsRule",
        "displayName": "AV detections related to SpringShell Vulnerability",
        "contentProductId": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
        "id": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
        "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject10').analyticRuleTemplateSpecName10]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PossibleWebpBufferOverflow_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject10').analyticRuleVersion10]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query looks at device, process, and network events from Defender for Endpoint that may be vulnerable to buffer overflow defined in CVE-2023-4863. Results are not an indicator of malicious activity.",
                "displayName": "Execution of software vulnerable to webp buffer overflow of CVE-2023-4863",
                "enabled": false,
                "query": "//CVE-2023-4863 Process activity with .webp files on devices where CVE-2023-4863 is unpatched\n//This query shows all process activity with .webp files on vulnerable machines and is not an indicator of malicious activity\nlet VulnDevices = DeviceTvmSoftwareVulnerabilities\n    | where CveId == \"CVE-2023-4863\"\n    | distinct DeviceId;\nunion DeviceProcessEvents, DeviceNetworkEvents, DeviceEvents\n| where DeviceId in (VulnDevices) and (InitiatingProcessCommandLine has(\".webp\") or ProcessCommandLine has(\".webp\"))\n| extend Name = tostring(split(AccountUpn, \"@\")[0]), UPNSuffix = tostring(split(AccountUpn, \"@\")[1])\n| extend HostName = tostring(split(DeviceName, \".\")[0]), DomainIndex = toint(indexof(DeviceName, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(DeviceName, DomainIndex + 1), DeviceName)",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Informational",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents",
                      "DeviceNetworkEvents",
                      "DeviceEvents",
                      "DeviceTvmSoftwareVulnerabilities"
                    ]
                  }
                ],
                "tactics": [
                  "Execution"
                ],
                "techniques": [
                  "T1203"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "HostNameDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountUpn",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "Name",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "UPNSuffix",
                        "identifier": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "LocalIP",
                        "identifier": "Address"
                      }
                    ]
                  },
                  {
                    "entityType": "Process",
                    "fieldMappings": [
                      {
                        "columnName": "ProcessId",
                        "identifier": "ProcessId"
                      }
                    ]
                  },
                  {
                    "entityType": "Process",
                    "fieldMappings": [
                      {
                        "columnName": "InitiatingProcessId",
                        "identifier": "ProcessId"
                      }
                    ]
                  },
                  {
                    "entityType": "Process",
                    "fieldMappings": [
                      {
                        "columnName": "ProcessCommandLine",
                        "identifier": "CommandLine"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "Possible exploitation of CVE-2023-4863",
                  "alertDynamicProperties": []
                },
                "incidentConfiguration": {
                  "createIncident": false,
                  "groupingConfiguration": {
                    "enabled": false,
                    "groupByCustomDetails": [],
                    "reopenClosedIncident": false,
                    "groupByAlertDetails": [],
                    "groupByEntities": [
                      "Account"
                    ],
                    "lookbackDuration": "PT5H",
                    "matchingMethod": "Selected"
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject10').analyticRuleId10,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 10",
                "parentId": "[variables('analyticRuleObject10').analyticRuleId10]",
                "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject10').analyticRuleVersion10]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
        "contentKind": "AnalyticsRule",
        "displayName": "Execution of software vulnerable to webp buffer overflow of CVE-2023-4863",
        "contentProductId": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
        "id": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
        "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject11').analyticRuleTemplateSpecName11]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DeimosComponentExecution_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject11').analyticRuleVersion11]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Jupyter, otherwise known as SolarMarker, is a malware family and cluster of components known for its info-stealing and backdoor capabilities that mainly proliferates through search engine optimization manipulation and malicious advertising in order to successfully encourage users to download malicious templates and documents. This malware has been popular since 2020 and currently is still active as of 2021.",
                "displayName": "Deimos Component Execution",
                "enabled": false,
                "query": "DeviceEvents   \n| where InitiatingProcessFileName =~ \"powershell.exe\"\n| where ActionType == \"AmsiScriptContent\"\n| where AdditionalFields endswith '[mArS.deiMos]::inteRaCt()\"}'\n| project InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessCommandLine, ActionType, AdditionalFields, DeviceName\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Execution",
                  "Collection",
                  "Exfiltration"
                ],
                "techniques": [
                  "T1059",
                  "T1005",
                  "T1020"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject11').analyticRuleId11,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 11",
                "parentId": "[variables('analyticRuleObject11').analyticRuleId11]",
                "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject11').analyticRuleVersion11]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
        "contentKind": "AnalyticsRule",
        "displayName": "Deimos Component Execution",
        "contentProductId": "[variables('analyticRuleObject11')._analyticRulecontentProductId11]",
        "id": "[variables('analyticRuleObject11')._analyticRulecontentProductId11]",
        "version": "[variables('analyticRuleObject11').analyticRuleVersion11]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject12').analyticRuleTemplateSpecName12]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ImminentRansomware_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject12').analyticRuleVersion12]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query checks for a series of commands that are commonly used by attackers to disable security tools and system recovery tools before deploying Macaw ransomware in an organization.",
                "displayName": "Imminent Ransomware",
                "enabled": false,
                "query": "_ASim_ProcessEvent \n// Pivot on specific commands \n| where CommandLine has_any(\"-ExclusionPath\", \"Set-MpPreference\", \"advfirewall\", \"-ExclusionExtension\", \n\"-EnableControlledFolderAccess\", \"windefend\", \"onstart\", \"bcdedit\", \"Startup\") \n// Making list of found commands \n| summarize CommandLine = make_set(CommandLine, 10000) by DvcId, Dvc, bin(TimeGenerated, 6h) \n// Extending columns for later aggregration, based on TTP\n| extend StartUpExclusionPath = iff(CommandLine has_all(\"-ExclusionPath\", \"Startup\"), 1, 0) \n| extend DefenderTamp = iff(CommandLine has \"Set-MpPreference\" \nand CommandLine has_any( \n\"-SevereThreatDefaultAction 6\" \n\"-HighThreatDefaultAction 6\", \n\"-ModerateThreatDefaultAction 6\", \n\"-LowThreatDefaultAction 6\" \n\"-ScanScheduleDay 8\"), 1, 0) \n| extend NetshFirewallTampering = iff(CommandLine has_all( \"netsh\", \"advfirewall\", \"allprofiles state off\"), 1, 0) \n| extend BatExclusion = iff(CommandLine has_all(\"-ExclusionExtension\", \".bat\"), 1, 0) \n| extend ExeExclusion = iff(CommandLine has_all(\"-ExclusionExtension\", \".exe\"), 1, 0) \n| extend DisableControlledFolderAccess = iff(CommandLine has_all(\"-EnableControlledFolderAccess\", \"Disabled\"), 1, 0) \n| extend ScDeleteDefend = iff(CommandLine has_all(\"sc\", \"delete\", \"windefend\"), 1, 0) \n| extend BootTampering = iff(CommandLine has_all(\"bcdedit\", \"default\") and CommandLine has_any (\"recoveryenabled No\", \"bootstatuspolicy ignoreallfailures\"), 1, 0) \n| extend SchTasks = iff(CommandLine has_all(\"/sc\", \"onstart\", \"system\", \"/create\", \"/delay\"), 1, 0) \n// Summarizing found commands \n| summarize by NetshFirewallTampering ,BatExclusion, ExeExclusion, DisableControlledFolderAccess, ScDeleteDefend, SchTasks, BootTampering, DefenderTamp, StartUpExclusionPath, DvcId, Dvc, TimeGenerated \n// Adding up each piece of evidence \n| extend EvidenceCount = NetshFirewallTampering + BatExclusion + ExeExclusion + DisableControlledFolderAccess + ScDeleteDefend + SchTasks + BootTampering + DefenderTamp + StartUpExclusionPath \n| where EvidenceCount > 4\n| extend HostName = iff(Dvc has '.', substring(Dvc, 0, indexof(Dvc, '.')), Dvc)\n| extend DnsDomain = iff(Dvc has '.', substring(Dvc, indexof(Dvc, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [],
                "tactics": [
                  "DefenseEvasion",
                  "Persistence"
                ],
                "techniques": [
                  "T1562",
                  "T1547"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "Dvc",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject12').analyticRuleId12,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 12",
                "parentId": "[variables('analyticRuleObject12').analyticRuleId12]",
                "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject12').analyticRuleVersion12]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
        "contentKind": "AnalyticsRule",
        "displayName": "Imminent Ransomware",
        "contentProductId": "[variables('analyticRuleObject12')._analyticRulecontentProductId12]",
        "id": "[variables('analyticRuleObject12')._analyticRulecontentProductId12]",
        "version": "[variables('analyticRuleObject12').analyticRuleVersion12]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject13').analyticRuleTemplateSpecName13]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MaliciousCMDExecutionByJava_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject13').analyticRuleVersion13]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query was originally published in the threat analytics report, Sysrv botnet evolution.\nSysrv is a Go-based botnet that targets both Windows and Linux servers, and steals resources to mine cryptocurrency.\nThe following query finds instances of the Java process being used to execute cmd.exe, and download and execute a PowerShell script.",
                "displayName": "Java Executing cmd to run Powershell",
                "enabled": false,
                "query": "DeviceProcessEvents                         \n| where InitiatingProcessFileName == 'java.exe' and FileName == 'cmd.exe' \nand ProcessCommandLine has_all('powershell iex','DownloadString')\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Execution"
                ],
                "techniques": [
                  "T1059"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject13').analyticRuleId13,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 13",
                "parentId": "[variables('analyticRuleObject13').analyticRuleId13]",
                "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject13').analyticRuleVersion13]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
        "contentKind": "AnalyticsRule",
        "displayName": "Java Executing cmd to run Powershell",
        "contentProductId": "[variables('analyticRuleObject13')._analyticRulecontentProductId13]",
        "id": "[variables('analyticRuleObject13')._analyticRulecontentProductId13]",
        "version": "[variables('analyticRuleObject13').analyticRuleVersion13]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject14').analyticRuleTemplateSpecName14]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "C2-NamedPipe_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject14').analyticRuleVersion14]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects the creation of a named pipe used by known APT malware.\nReference - https://docs.microsoft.com/openspecs/windows_protocols/ms-wpo/4de75e21-36fd-440a-859b-75accc74487c",
                "displayName": "C2-NamedPipe",
                "enabled": false,
                "query": "// this is what should be constantly tweaked with default C2 framework names, search uses has_any (wildcard)\nlet badPipeNames = pack_array(\n    '\\\\psexec',                                     // PSexec default pipe\n    '\\\\paexec',                                     // PSexec default pipe\n    '\\\\remcom',                                     // PSexec default pipe\n    '\\\\csexec',                                     // PSexec default pipe\n    '\\\\isapi_http',                                 // Uroburos Malware Named Pipe\n    '\\\\isapi_dg',                                   // Uroburos Malware Named Pipe\n    '\\\\isapi_dg2',                                  // Uroburos Malware Named Pipe\n    '\\\\sdlrpc',                                     // Cobra Trojan Named Pipe http://goo.gl/8rOZUX\n    '\\\\ahexec',                                     // Sofacy group malware\n    '\\\\winsession',                                 // Wild Neutron APT malware https://goo.gl/pivRZJ\n    '\\\\lsassw',                                     // Wild Neutron APT malware https://goo.gl/pivRZJ\n    '\\\\46a676ab7f179e511e30dd2dc41bd388',           // Project Sauron https://goo.gl/eFoP4A\n    '\\\\9f81f59bc58452127884ce513865ed20',           // Project Sauron https://goo.gl/eFoP4A\n    '\\\\e710f28d59aa529d6792ca6ff0ca1b34',           // Project Sauron https://goo.gl/eFoP4A\n    '\\\\rpchlp_3',                                   // Project Sauron https://goo.gl/eFoP4A - Technical Analysis Input\n    '\\\\NamePipe_MoreWindows',                       // US-CERT Alert - RedLeaves https://www.us-cert.gov/ncas/alerts/TA17-117A\n    '\\\\pcheap_reuse',                               // Pipe used by Equation Group malware 77486bb828dba77099785feda0ca1d4f33ad0d39b672190079c508b3feb21fb0\n    '\\\\gruntsvc',                                   // Covenant default named pipe\n    '\\\\583da945-62af-10e8-4902-a8f205c72b2e',       // SolarWinds SUNBURST malware report https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html\n    '\\\\bizkaz',                                     // Snatch Ransomware https://thedfirreport.com/2020/06/21/snatch-ransomware/\n    '\\\\atctl',                                      // https://www.virustotal.com/#/file/a4ddb2664a6c87a1d3c5da5a5a32a5df9a0b0c8f2e951811bd1ec1d44d42ccf1/detection\n    '\\\\userpipe',                                   // ruag apt case\n    '\\\\iehelper',                                   // ruag apt case\n    '\\\\sdlrpc',                                     // project cobra https://www.gdatasoftware.com/blog/2015/01/23926-analysis-of-project-cobra\n    '\\\\comnap',                                     // https://www.gdatasoftware.com/blog/2015/01/23926-analysis-of-project-cobra\n    '\\\\lsadump',                                    // Cred Dump-Tools Named Pipes\n    '\\\\cachedump',                                  // Cred Dump-Tools Named Pipes\n    '\\\\wceservicepipe',                             // Cred Dump-Tools Named Pipes\n    '\\\\jaccdpqnvbrrxlaf',                           // PoshC2 default named pipe\n    '\\\\svcctl',                                     // CrackMapExec default named pipe\n    '\\\\csexecsvc'                                   // CSEXEC default named pipe\n    '\\\\status_',                                    // CS default named pipes https://github.com/Neo23x0/sigma/issues/253\n    '\\\\MSSE-',                                      // CobaltStrike default named pipe\n    '\\\\status_',                                    // CobaltStrike default named pipe\n    '\\\\msagent_',                                   // (target) CobaltStrike default named pipe\n    '\\\\postex_ssh_',                                // CobaltStrike default named pipe\n    '\\\\postex_',                                    // CobaltStrike default named pipe\n    '\\\\Posh'                                        // PoshC2 default named pipe\n);\nDeviceEvents\n| where ActionType == \"NamedPipeEvent\"\n| extend ParsedFields=parse_json(AdditionalFields)\n| where ParsedFields.FileOperation == \"File created\"\n| where ParsedFields.PipeName has_any (badPipeNames)\n| project TimeGenerated, ActionType, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessFolderPath, InitiatingProcessCommandLine, ParsedFields.FileOperation, ParsedFields.PipeName\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceEvents"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "techniques": [
                  "T1105"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject14').analyticRuleId14,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 14",
                "parentId": "[variables('analyticRuleObject14').analyticRuleId14]",
                "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject14').analyticRuleVersion14]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
        "contentKind": "AnalyticsRule",
        "displayName": "C2-NamedPipe",
        "contentProductId": "[variables('analyticRuleObject14')._analyticRulecontentProductId14]",
        "id": "[variables('analyticRuleObject14')._analyticRulecontentProductId14]",
        "version": "[variables('analyticRuleObject14').analyticRuleVersion14]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject15').analyticRuleTemplateSpecName15]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DoppelPaymerProcDump_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject15').analyticRuleVersion15]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query was originally published in the threat analytics report, Doppelpaymer: More human-operated ransomware. There is also a related blog.\nDoppelPaymer is ransomware that is spread manually by human operators. These operators have exhibited extensive knowledge of system administration and common network security misconfigurations. For example, they use SysInternal utilities such as ProcDump to dump credentials from LSASS. They often use these stolen credentials to turn off security software, run malicious commands, and spread malware throughout an organization.\nThe following query detects ProcDump being used to dump credentials from LSASS.\nThe See also section below lists links to other queries associated with DoppelPaymer.\nReferences:\nhttps://msrc-blog.microsoft.com/2019/11/20/customer-guidance-for-the-dopplepaymer-ransomware/\nhttps://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Ransom:Win32/DoppelPaymer.KM!MTB\nhttps://docs.microsoft.com/sysinternals/downloads/procdump\nhttps://docs.microsoft.com/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection",
                "displayName": "DopplePaymer Procdump",
                "enabled": false,
                "query": "// Dumping of LSASS memory using procdump\nDeviceProcessEvents\n// Command lines that include \"lsass\" and -accepteula or -ma flags used in procdump\n| where (ProcessCommandLine has \"lsass\" and (ProcessCommandLine has \"-accepteula\" or\nProcessCommandLine contains \"-ma\"))\n// Omits possible FPs where the full command is just \"procdump.exe lsass\"\nor (FileName in~ ('procdump.exe','procdump64.exe') and ProcessCommandLine has 'lsass')\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "CredentialAccess"
                ],
                "techniques": [
                  "T1003"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject15').analyticRuleId15,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 15",
                "parentId": "[variables('analyticRuleObject15').analyticRuleId15]",
                "contentId": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject15').analyticRuleVersion15]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
        "contentKind": "AnalyticsRule",
        "displayName": "DopplePaymer Procdump",
        "contentProductId": "[variables('analyticRuleObject15')._analyticRulecontentProductId15]",
        "id": "[variables('analyticRuleObject15')._analyticRulecontentProductId15]",
        "version": "[variables('analyticRuleObject15').analyticRuleVersion15]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject16').analyticRuleTemplateSpecName16]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "LSASSCredDumpProcdump_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject16').analyticRuleVersion16]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query was originally published in the threat analytics report, \"Exchange Server zero-days exploited in the wild\".\nIn early March 2021, Microsoft released patches for four different zero-day vulnerabilities affecting Microsoft Exchange Server. The vulnerabilities were being used in a coordinated attack. For more information on the vulnerabilities, visit the following links:\n1. CVE-2021-26855\n2. CVE-2021-26857\n3. CVE-2021-26858\n4. CVE-2021-27065\nThe following query looks for evidence of Procdump being used to dump credentials from LSASS, the Local Security Authentication Server. This might indicate an attacker has compromised user accounts.\nMore queries related to this threat can be found under the See also section of this page.\nReference - https://msrc-blog.microsoft.com/2021/03/02/multiple-security-updates-released-for-exchange-server/",
                "displayName": "LSASS Credential Dumping with Procdump",
                "enabled": false,
                "query": "DeviceProcessEvents \n| where (FileName has_any (\"procdump.exe\", \"procdump64.exe\") and ProcessCommandLine has \"lsass\") or \n// Looking for Accepteula flag or Write a dump file with all process memory\n(ProcessCommandLine has \"lsass.exe\" and (ProcessCommandLine has \"-accepteula\" or ProcessCommandLine contains \"-ma\"))\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "CredentialAccess"
                ],
                "techniques": [
                  "T1003"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject16').analyticRuleId16,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 16",
                "parentId": "[variables('analyticRuleObject16').analyticRuleId16]",
                "contentId": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject16').analyticRuleVersion16]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
        "contentKind": "AnalyticsRule",
        "displayName": "LSASS Credential Dumping with Procdump",
        "contentProductId": "[variables('analyticRuleObject16')._analyticRulecontentProductId16]",
        "id": "[variables('analyticRuleObject16')._analyticRulecontentProductId16]",
        "version": "[variables('analyticRuleObject16').analyticRuleVersion16]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject17').analyticRuleTemplateSpecName17]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DoppelpaymerStopService_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject17').analyticRuleVersion17]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query was originally published in the threat analytics report, Doppelpaymer: More human-operated ransomware. There is also a related blog.\nDoppelPaymer is ransomware that is spread manually by human operators. These operators have exhibited extensive knowledge of system administration and common network security misconfigurations. They often use stolen credentials from over-privileged service accounts to turn off security software, run malicious commands, and spread malware throughout an organization.\nThe following query detects attempts to stop security services.\nThe See also section below lists links to other queries associated with DoppelPaymer.\nReferences:\nhttps://msrc-blog.microsoft.com/2019/11/20/customer-guidance-for-the-dopplepaymer-ransomware/\nhttps://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Ransom:Win32/DoppelPaymer.KM!MTB",
                "displayName": "Doppelpaymer Stop Services",
                "enabled": false,
                "query": "// Attempts to stop services and allow ransomware execution\nDeviceProcessEvents\n| where InitiatingProcessFileName startswith \"psexe\" and FileName =~ \"powershell.exe\" and\n  ProcessCommandLine has \"stop-service\" and ProcessCommandLine has \"sql\" and ProcessCommandLine has \"msexchange\"\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Execution",
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1059",
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject17').analyticRuleId17,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 17",
                "parentId": "[variables('analyticRuleObject17').analyticRuleId17]",
                "contentId": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject17').analyticRuleVersion17]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
        "contentKind": "AnalyticsRule",
        "displayName": "Doppelpaymer Stop Services",
        "contentProductId": "[variables('analyticRuleObject17')._analyticRulecontentProductId17]",
        "id": "[variables('analyticRuleObject17')._analyticRulecontentProductId17]",
        "version": "[variables('analyticRuleObject17').analyticRuleVersion17]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject18').analyticRuleTemplateSpecName18]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "QakbotCampaignSelfDeletion_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject18').analyticRuleVersion18]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query was originally published in the threat analytics report, Qakbot blight lingers, seeds ransomware\nQakbot is malware that steals login credentials from banking and financial services. It has been deployed against small businesses as well as major corporations. Some outbreaks have involved targeted ransomware campaigns that use a similar set of techniques. Links to related queries are listed under See also.\nThe following query detects if an instance of Qakbot has attempted to overwrite its original binary.\nReference - https://www.microsoft.com/security/blog/2017/11/06/mitigating-and-eliminating-info-stealing-qakbot-and-emotet-in-corporate-networks/",
                "displayName": "Qakbot Campaign Self Deletion",
                "enabled": false,
                "query": "DeviceProcessEvents \n| where FileName =~ \"ping.exe\"\n| where InitiatingProcessFileName =~ \"cmd.exe\"\n| where (InitiatingProcessCommandLine has \"calc.exe\") and (InitiatingProcessCommandLine has \"-n 6\") and (InitiatingProcessCommandLine has \"127.0.0.1\")\n| project TimeGenerated, ProcessCommandLine, InitiatingProcessCommandLine, InitiatingProcessParentFileName, DeviceId, DeviceName\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1070"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject18').analyticRuleId18,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 18",
                "parentId": "[variables('analyticRuleObject18').analyticRuleId18]",
                "contentId": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject18').analyticRuleVersion18]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
        "contentKind": "AnalyticsRule",
        "displayName": "Qakbot Campaign Self Deletion",
        "contentProductId": "[variables('analyticRuleObject18')._analyticRulecontentProductId18]",
        "id": "[variables('analyticRuleObject18')._analyticRulecontentProductId18]",
        "version": "[variables('analyticRuleObject18').analyticRuleVersion18]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject19').analyticRuleTemplateSpecName19]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Regsvr32Rundll32ImageLoadsAbnormalExtension_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject19').analyticRuleVersion19]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject19')._analyticRulecontentId19]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query is looking for regsvr32.exe or rundll32.exe loading DLL images with other extensions than .dll.\nJoins the data to public network events.\nReferences:\nhttps://threathunt.blog/running-live-malware-for-threat-hunting-purposes/",
                "displayName": "Regsvr32 Rundll32 Image Loads Abnormal Extension",
                "enabled": false,
                "query": "DeviceImageLoadEvents \n| where InitiatingProcessFileName has_any (\"rundll32.exe\",\"regsvr32.exe\")\n| where FileName !endswith \".dll\"\n| join (\nDeviceNetworkEvents\n| where InitiatingProcessFileName has_any (\"rundll32.exe\",\"regsvr32.exe\")\n| where RemoteIPType == \"Public\"\n) on InitiatingProcessFileName, InitiatingProcessId, InitiatingProcessCreationTime, InitiatingProcessCommandLine\n| project TimeGenerated, DeviceName, FileName, FolderPath, SHA1, InitiatingProcessFileName, InitiatingProcessCommandLine, LocalIP, LocalPort, RemoteIP, RemoteUrl, RemotePort, InitiatingProcessParentFileName\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents",
                      "DeviceNetworkEvents"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "subTechniques": [
                  "T1218.010",
                  "T1218.011"
                ],
                "techniques": [
                  "T1218",
                  "T1218"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "LocalIP",
                        "identifier": "Address"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "RemoteIP",
                        "identifier": "Address"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "RemoteUrl",
                        "identifier": "Url"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject19').analyticRuleId19,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 19",
                "parentId": "[variables('analyticRuleObject19').analyticRuleId19]",
                "contentId": "[variables('analyticRuleObject19')._analyticRulecontentId19]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject19').analyticRuleVersion19]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject19')._analyticRulecontentId19]",
        "contentKind": "AnalyticsRule",
        "displayName": "Regsvr32 Rundll32 Image Loads Abnormal Extension",
        "contentProductId": "[variables('analyticRuleObject19')._analyticRulecontentProductId19]",
        "id": "[variables('analyticRuleObject19')._analyticRulecontentProductId19]",
        "version": "[variables('analyticRuleObject19').analyticRuleVersion19]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject20').analyticRuleTemplateSpecName20]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Regsvr32Rundll32WithAnomalousParentProcess_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject20').analyticRuleVersion20]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject20')._analyticRulecontentId20]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This analytical rule looks for rundll32.exe or regsvr32.exe being spawned by abnormal processes: wscript.exe, powershell.exe, cmd.exe, pwsh.exe, cscript.exe.\nBlog: https://threathunt.blog/running-live-malware-for-threat-hunting-purposes/",
                "displayName": "Regsvr32 Rundll32 with Anomalous Parent Process",
                "enabled": false,
                "query": "DeviceProcessEvents\n| where FileName has_any (\"rundll32.exe\",\"regsvr32.exe\")\n| where InitiatingProcessFileName has_any (\"wscript.exe\",\"powershell.exe\",\"cmd.exe\",\"pwsh.exe\",\"cscript.exe\")\n| project TimeGenerated, DeviceName, InvestigatedProcessName=FileName, InvestigatedProcessCommandLine = ProcessCommandLine,InvestigatedProcessStartTime = ProcessCreationTime, InvestigatedProcessId = ProcessId, InitiatingProcessFileName, InitiatingProcessCommandLine, InitiatingProcessParentFileName\n| join (\nDeviceNetworkEvents\n| where InitiatingProcessFileName has_any (\"rundll32.exe\",\"regsvr32.exe\")\n| where RemoteIPType == \"Public\"\n| project DeviceName, InvestigatedProcessName=InitiatingProcessFileName, InvestigatedProcessCommandLine = InitiatingProcessCommandLine,InvestigatedProcessStartTime = InitiatingProcessCreationTime, InvestigatedProcessId = InitiatingProcessId, LocalIP, RemoteIP, RemoteUrl\n) on DeviceName, InvestigatedProcessCommandLine, InvestigatedProcessId, InvestigatedProcessName, InvestigatedProcessStartTime\n| project-away DeviceName1, InvestigatedProcessCommandLine1, InvestigatedProcessId1, InvestigatedProcessName1, InvestigatedProcessStartTime1\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents",
                      "DeviceNetworkEvents"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "subTechniques": [
                  "T1218.010",
                  "T1218.011"
                ],
                "techniques": [
                  "T1218",
                  "T1218"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "LocalIP",
                        "identifier": "Address"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "RemoteIP",
                        "identifier": "Address"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "RemoteUrl",
                        "identifier": "Url"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject20').analyticRuleId20,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 20",
                "parentId": "[variables('analyticRuleObject20').analyticRuleId20]",
                "contentId": "[variables('analyticRuleObject20')._analyticRulecontentId20]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject20').analyticRuleVersion20]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject20')._analyticRulecontentId20]",
        "contentKind": "AnalyticsRule",
        "displayName": "Regsvr32 Rundll32 with Anomalous Parent Process",
        "contentProductId": "[variables('analyticRuleObject20')._analyticRulecontentProductId20]",
        "id": "[variables('analyticRuleObject20')._analyticRulecontentProductId20]",
        "version": "[variables('analyticRuleObject20').analyticRuleVersion20]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject21').analyticRuleTemplateSpecName21]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SuspiciousCommandInitiatedByWebServerProcess_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject21').analyticRuleVersion21]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject21')._analyticRulecontentId21]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query was originally published in the threat analytics report, Operation Soft Cell.\nOperation Soft Cell is a series of campaigns targeting users' call logs at telecommunications providers throughout the world. These attacks date from as early as 2012.\nOperation Soft Cell operators sometimes use legitimate web server processes to launch commands, especially for network discovery and user/owner discovery. The following query detects activity of this kind.\nReference - https://www.cybereason.com/blog/operation-soft-cell-a-worldwide-campaign-against-telecommunications-providers",
                "displayName": "Detect Suspicious Commands Initiated by Webserver Processes",
                "enabled": false,
                "query": "// Suspicious commands launched by web server processes\nDeviceProcessEvents \n| where (((InitiatingProcessParentFileName in(\"w3wp.exe\", \"beasvc.exe\",\n    \"httpd.exe\") or InitiatingProcessParentFileName startswith \"tomcat\")\n    or InitiatingProcessFileName in(\"w3wp.exe\", \"beasvc.exe\", \"httpd.exe\") or\n    InitiatingProcessFileName startswith \"tomcat\"))\n    and FileName in~('cmd.exe', 'powershell.exe')\n| where ProcessCommandLine contains '%temp%'\n    or ProcessCommandLine has 'wget'\n    or ProcessCommandLine has 'whoami'\n    or ProcessCommandLine has 'certutil'\n    or ProcessCommandLine has 'systeminfo'\n    or ProcessCommandLine has 'ping'\n    or ProcessCommandLine has 'ipconfig'\n    or ProcessCommandLine has 'timeout'\n| summarize\n    take_any(FileName),\n    make_set(ProcessCommandLine, 100000),\n    take_any(InitiatingProcessFileName),\n    take_any(InitiatingProcessParentFileName)\n    by DeviceId, DeviceName\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Execution",
                  "DefenseEvasion",
                  "Discovery"
                ],
                "techniques": [
                  "T1059",
                  "T1574",
                  "T1087",
                  "T1082"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject21').analyticRuleId21,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 21",
                "parentId": "[variables('analyticRuleObject21').analyticRuleId21]",
                "contentId": "[variables('analyticRuleObject21')._analyticRulecontentId21]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject21').analyticRuleVersion21]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject21')._analyticRulecontentId21]",
        "contentKind": "AnalyticsRule",
        "displayName": "Detect Suspicious Commands Initiated by Webserver Processes",
        "contentProductId": "[variables('analyticRuleObject21')._analyticRulecontentProductId21]",
        "id": "[variables('analyticRuleObject21')._analyticRulecontentProductId21]",
        "version": "[variables('analyticRuleObject21').analyticRuleVersion21]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject22').analyticRuleTemplateSpecName22]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BITSAdminActivity_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject22').analyticRuleVersion22]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject22')._analyticRulecontentId22]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Background Intelligent Transfer Service (BITS) is a way to reliably download files from webservers or SMB servers. \nThis service is commonly used for legitimate purposes, but can also be used as part of a malware downloader. \nAdditionally, bitsadmin can be used to upload files and therefore can be used for data exfiltration. This\nquery will identify use of bitsadmin.exe for either purpose and will identify directionality file transfer\ndirectionality.",
                "displayName": "Bitsadmin Activity",
                "enabled": false,
                "query": "DeviceProcessEvents\n| where \n    (FileName =~ \"bitsadmin.exe\" or column_ifexists('ProcessVersionInfoOriginalFileName','ColumnNotAvailable') =~ 'bitsadmin.exe')\n    and ProcessCommandLine has_any ('/Transfer','/AddFile', '/AddFileSet','/AddFileWithRanges')\n| extend \n    ParsedCommandLine = parse_command_line(ProcessCommandLine,'windows')\n| extend     \n    RemoteUrl = tostring(ParsedCommandLine[-2]),\n    LocalFile= tostring(ParsedCommandLine[-1]),\n    Direction = iff(ProcessCommandLine has \"/Upload\", 'Upload', 'Download')\n| project-reorder \n    TimeGenerated,\n    DeviceId,\n    DeviceName,\n    Direction,\n    RemoteUrl,\n    LocalFile,\n    InitiatingProcessFolderPath,\n    InitiatingProcessAccountDomain,\n    InitiatingProcessAccountName,\n    InitiatingProcessSHA256,\n    ProcessId,\n    ProcessCommandLine\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence",
                  "CommandAndControl",
                  "Exfiltration"
                ],
                "techniques": [
                  "T1197",
                  "T1105",
                  "T1048"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Process",
                    "fieldMappings": [
                      {
                        "columnName": "ProcessId",
                        "identifier": "ProcessId"
                      },
                      {
                        "columnName": "ProcessCommandLine",
                        "identifier": "CommandLine"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject22').analyticRuleId22,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 22",
                "parentId": "[variables('analyticRuleObject22').analyticRuleId22]",
                "contentId": "[variables('analyticRuleObject22')._analyticRulecontentId22]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject22').analyticRuleVersion22]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject22')._analyticRulecontentId22]",
        "contentKind": "AnalyticsRule",
        "displayName": "Bitsadmin Activity",
        "contentProductId": "[variables('analyticRuleObject22')._analyticRulecontentProductId22]",
        "id": "[variables('analyticRuleObject22')._analyticRulecontentProductId22]",
        "version": "[variables('analyticRuleObject22').analyticRuleVersion22]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject23').analyticRuleTemplateSpecName23]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "OfficeAppsLaunchingWscript_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject23').analyticRuleVersion23]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject23')._analyticRulecontentId23]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query was originally published in the threat analytics report, Trickbot: Pervasive & underestimated.\nTrickbot is a very prevalent piece of malware with an array of malicious capabilities. Originally designed to steal banking credentials, it has since evolved into a modular trojan that can deploy other malware, disable security software, and perform command-and-control (C2) operations.\nTrickbot is frequently spread through email. An attacker will send a target a message with an attachment containing a malicious macro. If the target enables the macro, it will write a JScript Encoded (JSE) file to disk (JScript is a Microsoft dialect of ECMAScript). The JSE file will then be launched using wscript.exe to perform a variety of malicious tasks, particularly reconnaissance.\nThe following query detects when Office applications have launched wscript.exe to run a JSE file.\nSee Detect rundll.exe being used for reconnaissance and command-and-control for another query related to Trickbot activity.\nReference - https://attack.mitre.org/software/S0266/",
                "displayName": "Office Apps Launching Wscipt",
                "enabled": false,
                "query": "DeviceProcessEvents \n| where InitiatingProcessFileName in~ ('winword.exe', 'excel.exe', 'outlook.exe') \n| where FileName =~ \"wscript.exe\" and ProcessCommandLine has \".jse\"\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Execution",
                  "Collection",
                  "CommandAndControl"
                ],
                "techniques": [
                  "T1059",
                  "T1105",
                  "T1203"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Process",
                    "fieldMappings": [
                      {
                        "columnName": "ProcessId",
                        "identifier": "ProcessId"
                      },
                      {
                        "columnName": "ProcessCommandLine",
                        "identifier": "CommandLine"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject23').analyticRuleId23,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 23",
                "parentId": "[variables('analyticRuleObject23').analyticRuleId23]",
                "contentId": "[variables('analyticRuleObject23')._analyticRulecontentId23]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject23').analyticRuleVersion23]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject23')._analyticRulecontentId23]",
        "contentKind": "AnalyticsRule",
        "displayName": "Office Apps Launching Wscipt",
        "contentProductId": "[variables('analyticRuleObject23')._analyticRulecontentProductId23]",
        "id": "[variables('analyticRuleObject23')._analyticRulecontentProductId23]",
        "version": "[variables('analyticRuleObject23').analyticRuleVersion23]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject24').analyticRuleTemplateSpecName24]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PotentialKerberoastActivities_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject24').analyticRuleVersion24]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject24')._analyticRulecontentId24]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query aim to detect if someone requests service tickets (where count => maxcount)\nThe query requires trimming to set a baseline level for MaxCount  \nMitre Technique: Kerberoasting (T1558.003)\n@MattiasBorg82",
                "displayName": "Detect Potential Kerberoast Activities",
                "enabled": false,
                "query": "let MaxCount = 70; //Number of requests per 2 minute timeframe, depending on org size.\nIdentityLogonEvents\n| where ActionType == \"LogonSuccess\"\n| where Protocol == \"Kerberos\"\n| extend json = todynamic(parse_json(tostring(AdditionalFields)))\n| extend SPN = json.Spns,\n       AttackTechniques = json.AttackTechniques\n      | project-away json\n| where isnotempty(SPN)\n| where AttackTechniques has \"T1558.003\"\n| mv-expand SPN\n        | extend SPNType = tostring(extract(@\"^\\w+\",0,tostring(SPN)))\n| distinct tostring(SPN), DeviceName, AccountUpn, AccountSid, bin(TimeGenerated, 2m), ReportId, tostring(AttackTechniques)\n| summarize count(), SPNS=(make_list(SPN, 100000)),ReportId=tostring((make_list(ReportId, 100000))[0]) by AccountUpn,AccountSid,DeviceName, bin(TimeGenerated, 2m), tostring(AttackTechniques)\n| extend SPNS = (replace_regex(tostring(SPNS), @'[^\\w+-\\/]+', '')) \n| where count_ >= MaxCount\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n| extend AccountDomain = tostring(split(AccountUpn, '@')[1]), AccountName = tostring(split(AccountUpn, '@')[0])\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "IdentityLogonEvents"
                    ]
                  }
                ],
                "tactics": [
                  "CredentialAccess"
                ],
                "subTechniques": [
                  "T1558.003"
                ],
                "techniques": [
                  "T1558"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountUpn",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "AccountDomain",
                        "identifier": "DnsDomain"
                      },
                      {
                        "columnName": "AccountName",
                        "identifier": "Name"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject24').analyticRuleId24,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 24",
                "parentId": "[variables('analyticRuleObject24').analyticRuleId24]",
                "contentId": "[variables('analyticRuleObject24')._analyticRulecontentId24]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject24').analyticRuleVersion24]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject24')._analyticRulecontentId24]",
        "contentKind": "AnalyticsRule",
        "displayName": "Detect Potential Kerberoast Activities",
        "contentProductId": "[variables('analyticRuleObject24')._analyticRulecontentProductId24]",
        "id": "[variables('analyticRuleObject24')._analyticRulecontentProductId24]",
        "version": "[variables('analyticRuleObject24').analyticRuleVersion24]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject25').analyticRuleTemplateSpecName25]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "FilesCopiedToUSBDrives_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject25').analyticRuleVersion25]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject25')._analyticRulecontentId25]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query lists files copied to USB external drives with USB drive information based on FileCreated events associated with most recent USBDriveMount events befor file creations. But be aware that Advanced Hunting is not monitoring all the file types.",
                "displayName": "Files Copied to USB Drives",
                "enabled": false,
                "query": "let UsbDriveMount = DeviceEvents\n| where ActionType==\"UsbDriveMounted\"\n| extend ParsedFields=parse_json(AdditionalFields)\n| project DeviceId, DeviceName, DriveLetter=ParsedFields.DriveLetter, MountTime=TimeGenerated,\nProductName=ParsedFields.ProductName,SerialNumber=ParsedFields.SerialNumber,Manufacturer=ParsedFields.Manufacturer\n| order by DeviceId asc, MountTime desc;\nlet FileCreation = DeviceFileEvents\n| where InitiatingProcessAccountName != \"system\"\n| where ActionType == \"FileCreated\"\n| where FolderPath !startswith \"C:\\\\\"\n| where FolderPath !startswith \"\\\\\"\n| project ReportId,DeviceId,InitiatingProcessAccountDomain,\nInitiatingProcessAccountName,InitiatingProcessAccountUpn,\nFileName, FolderPath, SHA256, TimeGenerated, SensitivityLabel, IsAzureInfoProtectionApplied\n| order by DeviceId asc, TimeGenerated desc;\nFileCreation | lookup kind=inner (UsbDriveMount) on DeviceId\n| where FolderPath startswith DriveLetter\n| where TimeGenerated >= MountTime\n| partition hint.strategy=native by ReportId ( top 1 by MountTime )\n| order by DeviceId asc, TimeGenerated desc\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n| extend FileHashAlgorithm = 'SHA256'\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceEvents",
                      "DeviceFileEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Exfiltration"
                ],
                "techniques": [
                  "T1041"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "File",
                    "fieldMappings": [
                      {
                        "columnName": "FileName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "FolderPath",
                        "identifier": "Directory"
                      }
                    ]
                  },
                  {
                    "entityType": "FileHash",
                    "fieldMappings": [
                      {
                        "columnName": "FileHashAlgorithm",
                        "identifier": "Algorithm"
                      },
                      {
                        "columnName": "SHA256",
                        "identifier": "Value"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject25').analyticRuleId25,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 25",
                "parentId": "[variables('analyticRuleObject25').analyticRuleId25]",
                "contentId": "[variables('analyticRuleObject25')._analyticRulecontentId25]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject25').analyticRuleVersion25]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject25')._analyticRulecontentId25]",
        "contentKind": "AnalyticsRule",
        "displayName": "Files Copied to USB Drives",
        "contentProductId": "[variables('analyticRuleObject25')._analyticRulecontentProductId25]",
        "id": "[variables('analyticRuleObject25')._analyticRulecontentProductId25]",
        "version": "[variables('analyticRuleObject25').analyticRuleVersion25]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject26').analyticRuleTemplateSpecName26]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MosaicLoader_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject26').analyticRuleVersion26]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject26')._analyticRulecontentId26]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query looks Malware Hides Itself Among Windows Defender Exclusions to Evade Detection.",
                "displayName": "MosaicLoader",
                "enabled": false,
                "query": "DeviceRegistryEvents \n| where ((ActionType == \"RegistryValueSet\") and (RegistryKey startswith @\"HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows Defender\\\\Exclusions\\\\Paths\" \nor RegistryKey startswith @\"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Extensions\"\nor RegistryKey startswith @\"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Processes\"))\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceRegistryEvents"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "RegistryValue",
                    "fieldMappings": [
                      {
                        "columnName": "RegistryValueName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "RegistryValueData",
                        "identifier": "Value"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject26').analyticRuleId26,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 26",
                "parentId": "[variables('analyticRuleObject26').analyticRuleId26]",
                "contentId": "[variables('analyticRuleObject26')._analyticRulecontentId26]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject26').analyticRuleVersion26]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject26')._analyticRulecontentId26]",
        "contentKind": "AnalyticsRule",
        "displayName": "MosaicLoader",
        "contentProductId": "[variables('analyticRuleObject26')._analyticRulecontentProductId26]",
        "id": "[variables('analyticRuleObject26')._analyticRulecontentProductId26]",
        "version": "[variables('analyticRuleObject26').analyticRuleVersion26]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject27').analyticRuleTemplateSpecName27]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AnomalousVoulmeOfFileDeletion_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject27').analyticRuleVersion27]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject27')._analyticRulecontentId27]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query looks for users performing file deletion activities. Spikes in file deletion observed from risky sign-in sessions are flagged here.\nThis applies to SharePoint and OneDrive users.\nAudit event and Cloud application identifier references.\nReference - https://learn.microsoft.com/microsoft-365/compliance/audit-log-activities?view=o365-worldwide\nReference - https://learn.microsoft.com/azure/sentinel/entities-reference#cloud-application-identifiers",
                "displayName": "Unusual Volume of file deletion by users",
                "enabled": false,
                "query": "let relevantOperations = pack_array(\"FileDeleted\", \"FileRecycled\", \"FileDeletedFirstStageRecycleBin\", \"FileDeletedSecondStageRecycleBin\", \"FileVersionsAllMinorsRecycled\", \"FileVersionRecycled\", \"FileVersionsAllRecycled\");\nlet relevantAppIds = pack_array(int(20892), int(15600)); // App Ids for SharePoint and OneDrive\nlet timeWindow = 7d;\nlet timeNow = now();\n//\nlet riskyUsers= // Look for users with risky sign-ins\n  SigninLogs    \n  | where CreatedDateTime between ((timeNow - timeWindow) .. (timeNow))\n  | where isnotempty(UserId) and isnotempty(OriginalRequestId)\n  | where ResultType == '0'\n  | where RiskLevelDuringSignIn == 'high'\n  | project RiskLevelDuringSignIn, UserId, CreatedDateTime, SessionId=OriginalRequestId\n  ;\nlet hasUsers = isnotempty(toscalar(riskyUsers));\n//\nlet deleteEvents = // look for file deletion activity and scope it to risky users\n  CloudAppEvents\n  | where hasUsers\n  | where TimeGenerated between ((timeNow - timeWindow) .. (timeNow))\n  | where ApplicationId in (relevantAppIds)\n  | where isnotempty(AccountObjectId)\n  | where AccountObjectId in (riskyUsers)\n  | where ActionType in (relevantOperations)\n  | extend SessionId= tostring(RawEventData.AppAccessContext.AADSessionId)\n  | where isnotempty(SessionId)\n  | project UserId=AccountObjectId, AccountDisplayName, ApplicationId, SessionId, ActionType, TimeGenerated, ReportId\n  ;   \n //\ndeleteEvents  \n| join kind=leftsemi riskyUsers on UserId, SessionId\n| summarize Count=count() , (Timestamp, ReportId)=arg_min(TimeGenerated, ReportId) by UserId, AccountDisplayName, ApplicationId, ActionType, Time=bin(TimeGenerated, 5m)\n// look for only those scoped users who have generated an increase in file deletion activity.\n| summarize TotalCount= countif(Count > 50), (Timestamp, ReportId)=arg_min(Timestamp, ReportId) by UserId, AccountDisplayName, ApplicationId \n| where TotalCount >= 3\n| project UserId, AccountDisplayName, ApplicationId, TotalCount, ReportId, Timestamp\n| extend NTDomain = tostring(split(AccountDisplayName,'\\\\',0)[0]), Name = tostring(split(AccountDisplayName,'\\\\',1)[0])\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "CloudAppEvents",
                      "AADSignInEventsBeta"
                    ]
                  }
                ],
                "tactics": [
                  "Impact"
                ],
                "techniques": [
                  "T1485"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "UserId",
                        "identifier": "AadUserId"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "Name",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "NTDomain",
                        "identifier": "NTDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "columnName": "ApplicationId",
                        "identifier": "AppId"
                      }
                    ]
                  }
                ],
                "customDetails": {
                  "Count": "TotalCount"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject27').analyticRuleId27,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 27",
                "parentId": "[variables('analyticRuleObject27').analyticRuleId27]",
                "contentId": "[variables('analyticRuleObject27')._analyticRulecontentId27]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject27').analyticRuleVersion27]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject27')._analyticRulecontentId27]",
        "contentKind": "AnalyticsRule",
        "displayName": "Unusual Volume of file deletion by users",
        "contentProductId": "[variables('analyticRuleObject27')._analyticRulecontentProductId27]",
        "id": "[variables('analyticRuleObject27')._analyticRulecontentProductId27]",
        "version": "[variables('analyticRuleObject27').analyticRuleVersion27]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject28').analyticRuleTemplateSpecName28]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RemoteFileCreationWithPsExec_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject28').analyticRuleVersion28]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject28')._analyticRulecontentId28]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query was originally published in the threat analytics report, Ryuk ransomware. There is also a related blog.\nRyuk is human-operated ransomware. Much like DoppelPaymer ransomware, Ryuk is spread manually, often on networks that are already infected with Trickbot.\nRyuk operators use PsExec to manually spread the ransomware to other devices.\nThe following query detects remote file creation events that might indicate an active attack.\nThe See also section below lists links to other queries associated with Ryuk ransomware.\nReferences:\nhttps://www.microsoft.com/security/blog/2020/03/05/human-operated-ransomware-attacks-a-preventable-disaster/\nhttps://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Ransom:Win32/Ryuk.AA\nhttps://www.microsoft.com/security/blog/2020/03/05/human-operated-ransomware-attacks-a-preventable-disaster/\nhttps://docs.microsoft.com/sysinternals/downloads/psexec",
                "displayName": "Remote File Creation with PsExec",
                "enabled": false,
                "query": "// Find PsExec creating multiple files on remote machines in a 10-minute window\nDeviceFileEvents\n// Looking for PsExec by accepteula command flag\n| where InitiatingProcessCommandLine has \"accepteula\"\n// Remote machines and file is exe\n| where FolderPath has \"\\\\\\\\\" and FileName endswith \".exe\"\n| extend Exe = countof(InitiatingProcessCommandLine, \".exe\")\n// Checking to see if command line has 2 .exe or .bat\n| where InitiatingProcessCommandLine !has \".ps1\" and Exe > 1 or\nInitiatingProcessCommandLine has \".bat\"\n// Exclusions: Remove the following line to widen scope of AHQ\n| where not(InitiatingProcessCommandLine has_any(\"batch\", \"auditpol\",\n\"script\", \"scripts\", \"illusive\", \"rebootrequired\"))\n| summarize FileCount = dcount(FolderPath), make_set(SHA1, 100000), make_set(FolderPath, 100000),\nmake_set(FileName, 100000), make_set(InitiatingProcessCommandLine, 100000) by DeviceId, DeviceName,\nTimeWindow=bin(TimeGenerated, 10m), InitiatingProcessFileName\n| where FileCount > 4\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceFileEvents"
                    ]
                  }
                ],
                "tactics": [
                  "LateralMovement"
                ],
                "techniques": [
                  "T1570"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject28').analyticRuleId28,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 28",
                "parentId": "[variables('analyticRuleObject28').analyticRuleId28]",
                "contentId": "[variables('analyticRuleObject28')._analyticRulecontentId28]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject28').analyticRuleVersion28]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject28')._analyticRulecontentId28]",
        "contentKind": "AnalyticsRule",
        "displayName": "Remote File Creation with PsExec",
        "contentProductId": "[variables('analyticRuleObject28')._analyticRulecontentProductId28]",
        "id": "[variables('analyticRuleObject28')._analyticRulecontentProductId28]",
        "version": "[variables('analyticRuleObject28').analyticRuleVersion28]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject29').analyticRuleTemplateSpecName29]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ServiceAccountsPerformingRemotePS_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject29').analyticRuleVersion29]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject29')._analyticRulecontentId29]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Service Accounts Performing Remote PowerShell.\nThe purpose behind this detection is for finding service accounts that are performing remote powershell sessions.\nThere are two phases to the detection: Identify service accounts, Find remote PS cmdlets being ran by these accounts.\nTo accomplish this, we utilize DeviceLogonEvents and DeviceEvents to find cmdlets ran that meet the criteria.\nOne of the main advantages of this method is that only requires server telemetry, and not the attacking client.\nThe first phase relies on the DeviceLogonEvents to determine whether an account is a service account or not, consider the following accounts with logons:.\nRandom_user has DeviceLogonEvents with type 2, 3, 7, 10, 11 & 13.\nRandom_service_account 'should' only have DeviceLogonEvents with type 3,4 or 5.",
                "displayName": "Service Accounts Performing Remote PS",
                "enabled": false,
                "query": "let InteractiveTypes = pack_array(                                  // Declare Interactive logon type names\n    'Interactive',\n    'CachedInteractive',\n    'Unlock',\n    'RemoteInteractive',\n    'CachedRemoteInteractive',\n    'CachedUnlock'\n);\nlet WhitelistedCmdlets = pack_array(                                // List of whitelisted commands that don't provide a lot of value\n    'prompt',\n    'Out-Default',\n    'out-lineoutput',\n    'format-default',\n    'Set-StrictMode',\n    'TabExpansion2'\n);\nlet WhitelistedAccounts = pack_array('FakeWhitelistedAccount');     // List of accounts that are known to perform this activity in the environment and can be ignored\nDeviceLogonEvents                                                         // Get all logon events...\n| where AccountName !in~ (WhitelistedAccounts)                      // ...where it is not a whitelisted account...\n| where ActionType == \"LogonSuccess\"                                // ...and the logon was successful...\n| where AccountName !contains \"$\"                                   // ...and not a machine logon.\n| where AccountName !has \"winrm va_\"                                // WinRM will have pseudo account names that match this if there is an explicit permission for an admin to run the cmdlet, so assume it is good.\n| extend IsInteractive=(LogonType in (InteractiveTypes))            // Determine if the logon is interactive (True=1,False=0)...\n| summarize HasInteractiveLogon=max(IsInteractive)                  // ...then bucket and get the maximum interactive value (0 or 1)...\n            by AccountName                                          // ... by the AccountNames\n| where HasInteractiveLogon == 0                                    // ...and filter out all accounts that had an interactive logon.\n// At this point, we have a list of accounts that we believe to be service accounts\n// Now we need to find RemotePS sessions that were spawned by those accounts\n// Note that we look at all powershell cmdlets executed to form a 29-day baseline to evaluate the data on today\n| join kind=rightsemi (                                             // Start by dropping the account name and only tracking the...\n\tDeviceEvents                                                      // ...\n\t| where ActionType == 'PowerShellCommand'                         // ...PowerShell commands seen...\n\t| where InitiatingProcessFileName =~ 'wsmprovhost.exe'            // ...whose parent was wsmprovhost.exe (RemotePS Server)...\n    | extend AccountName = InitiatingProcessAccountName             // ...and add an AccountName field so the join is easier\n) on AccountName\n// At this point, we have all of the commands that were ran by service accounts\n| extend Command = tostring(extractjson('$.Command', tostring(AdditionalFields))) // Extract the actual PowerShell command that was executed\n| where Command !in (WhitelistedCmdlets)                                          // Remove any values that match the whitelisted cmdlets\n| summarize (Timestamp, ReportId)=arg_max(TimeGenerated, ReportId),               // Then group all of the cmdlets and calculate the min/max times of execution...\n    make_set(Command, 100000), count(), min(TimeGenerated) by                     // ...as well as creating a list of cmdlets ran and the count..\n    AccountName, AccountDomain, DeviceName, DeviceId                                             // ...and have the commonality be the account, DeviceName and DeviceId\n// At this point, we have machine-account pairs along with the list of commands run as well as the first/last time the commands were ran\n| order by AccountName asc                                        // Order the final list by AccountName just to make it easier to go through\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")                                           \n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceLogonEvents",
                      "DeviceEvents"
                    ]
                  }
                ],
                "tactics": [
                  "LateralMovement"
                ],
                "techniques": [
                  "T1210"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "AccountDomain",
                        "identifier": "DnsDomain"
                      },
                      {
                        "columnName": "AccountName",
                        "identifier": "Name"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject29').analyticRuleId29,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 29",
                "parentId": "[variables('analyticRuleObject29').analyticRuleId29]",
                "contentId": "[variables('analyticRuleObject29')._analyticRulecontentId29]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject29').analyticRuleVersion29]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject29')._analyticRulecontentId29]",
        "contentKind": "AnalyticsRule",
        "displayName": "Service Accounts Performing Remote PS",
        "contentProductId": "[variables('analyticRuleObject29')._analyticRulecontentProductId29]",
        "id": "[variables('analyticRuleObject29')._analyticRulecontentProductId29]",
        "version": "[variables('analyticRuleObject29').analyticRuleVersion29]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject30').analyticRuleTemplateSpecName30]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AccountCreation_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject30').analyticRuleVersion30]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject30')._analyticRulecontentId30]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "User accounts may be created to achieve persistence on a machine.\nRead more here: https://attack.mitre.org/wiki/Technique/T1136.\nTags: #CreateAccount.\nQuery #1: Query for users being created using \"net user\" command.\n\"net user\" commands are noisy, so needs to be joined with another signal -.\nE.g. in this example we look for use of uncommon & undocumented commandline switches (e.g. /ad instead of /add).",
                "displayName": "Account Creation",
                "enabled": false,
                "query": "DeviceProcessEvents\n// Pro-tip: \n// There are many different ways to run a process from a file - e.g. by using full path, env. variables, ~1 annotation, more...\n// So, to find executions of a known filename, better filter on the filename (and possibly on folder path) than on the commandline.\n| where FileName in~ (\"net.exe\", \"net1.exe\")\n// Parse the user name from the commandline.\n// To have case-insensitive parsing use the i flag, to have non-greedy match (e.g. CreatedUser as short as possible), specify U flag:\n// \"kind=regex flags=i\"\n| parse kind=regex flags=iU ProcessCommandLine with * \"user \" CreatedUser \" \" * \"/ad\"\n// Filter rows where user could not be parsed - e.g. because it was not a user command, or the /add commandline switch was not specified.\n| where isnotempty(CreatedUser)\n// Every net.exe executed will run net1.exe with the same commandline.\n// in this where clause we remove such rows, as they duplicate the number of results we have without adding any value.\n| where not (FileName =~ \"net1.exe\" and InitiatingProcessFileName =~ \"net.exe\" and replace(\"net\", \"net1\", InitiatingProcessCommandLine) =~ ProcessCommandLine)\n// If /domain is specified, so the user is created on the domain controller.\n// Also, any prefix that's longer than 1 char will also do the same, e.g. /do, /dom, /doma, ....\n| extend CreatedOnLocalMachine=(ProcessCommandLine !contains \"/do\")\n| where ProcessCommandLine !contains \"/add\" or (CreatedOnLocalMachine == 0 and ProcessCommandLine !contains \"/domain\")\n| summarize MachineCount=dcount(DeviceName) by CreatedUser, CreatedOnLocalMachine, InitiatingProcessFileName, FileName, ProcessId, ProcessCommandLine, InitiatingProcessCommandLine, DeviceId, DeviceName\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "techniques": [
                  "T1136"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Process",
                    "fieldMappings": [
                      {
                        "columnName": "ProcessId",
                        "identifier": "ProcessId"
                      },
                      {
                        "columnName": "ProcessCommandLine",
                        "identifier": "CommandLine"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject30').analyticRuleId30,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 30",
                "parentId": "[variables('analyticRuleObject30').analyticRuleId30]",
                "contentId": "[variables('analyticRuleObject30')._analyticRulecontentId30]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject30').analyticRuleVersion30]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject30')._analyticRulecontentId30]",
        "contentKind": "AnalyticsRule",
        "displayName": "Account Creation",
        "contentProductId": "[variables('analyticRuleObject30')._analyticRulecontentProductId30]",
        "id": "[variables('analyticRuleObject30')._analyticRulecontentProductId30]",
        "version": "[variables('analyticRuleObject30').analyticRuleVersion30]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject31').analyticRuleTemplateSpecName31]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "LocalAdminGroupChanges_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject31').analyticRuleVersion31]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject31')._analyticRulecontentId31]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query searches for changes to the local administrators group.\nBlogpost: https://www.verboon.info/2020/09/hunting-for-local-group-membership-changes.",
                "displayName": "Local Admin Group Changes",
                "enabled": false,
                "query": "let machineAccountSIDs = dynamic([\n  \"S-1-5-18\",\n  \"S-1-5-20\",\n  \"S-1-5-19\"]);\nlet ADAZUsers =  IdentityInfo \n| extend DirectoryDomain = AccountDomain \n| extend DirectoryAccount = AccountName \n| extend OnPremSid = AccountSID\n| distinct DirectoryDomain , DirectoryAccount , OnPremSid , AccountCloudSID, AccountUPN, GivenName, Surname;\n // check for any new created or modified local accounts \nlet NewUsers =  DeviceEvents\n| where ActionType contains \"UserAccountCreated\" or ActionType contains \"UserAccountModified\"\n| extend lUserAdded = AccountName\n| extend NewUserSID = AccountSid\n| extend laccountdomain = AccountDomain\n| distinct NewUserSID, lUserAdded,laccountdomain;\n// Check for any local group changes and enrich the data with the account name obtained from the previous query\nDeviceEvents \n| where ActionType == 'UserAccountAddedToLocalGroup'\n// Exclude machine and wellknown SIDs \n| where (AccountSid !in (machineAccountSIDs)) and (AccountSid matches regex @\"S-\\d-\\d+-\\d+-(\\d+-){1,5}\\d+\")\n| extend LocalGroupSID = tostring(parse_json(AdditionalFields).GroupSid)\n| extend LocalGroup = tostring(parse_json(AdditionalFields).GroupName)\n| extend AddedAccountSID = AccountSid\n| extend Actor = trim(@\"[^\\w]+\",InitiatingProcessAccountName)\n// limit to local administrators group\n// | where LocalGroupSID contains \"S-1-5-32-544\"\n| join kind=leftouter    (NewUsers)\non $left.AddedAccountSID == $right.NewUserSID\n| project TimeGenerated, DeviceName, LocalGroup,LocalGroupSID, AddedAccountSID, lUserAdded , Actor, ActionType , laccountdomain \n| join kind=innerunique  (ADAZUsers)\non $left.AddedAccountSID == $right.OnPremSid\n| extend UserAdded = iff(isnotempty(lUserAdded),strcat(laccountdomain,\"\\\\\", lUserAdded), strcat(DirectoryDomain,\"\\\\\", DirectoryAccount))\n| extend AccountName = iff(isnotempty(lUserAdded), lUserAdded, DirectoryAccount)\n| project TimeGenerated, DeviceName, LocalGroup, LocalGroupSID, AddedAccountSID, UserAdded ,Actor, ActionType, AccountName, laccountdomain  \n| where DeviceName !contains Actor\n// Provide details on actors that added users\n// | summarize count()  by Actor \n// | join ADAZUsers\n// on $left.Actor == $right.DirectoryAccount \n// | render piechart\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "IdentityInfo",
                      "DeviceEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "techniques": [
                  "T1098"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "UserAdded",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "AccountName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "laccountdomain",
                        "identifier": "NTDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject31').analyticRuleId31,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 31",
                "parentId": "[variables('analyticRuleObject31').analyticRuleId31]",
                "contentId": "[variables('analyticRuleObject31')._analyticRulecontentId31]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject31').analyticRuleVersion31]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject31')._analyticRulecontentId31]",
        "contentKind": "AnalyticsRule",
        "displayName": "Local Admin Group Changes",
        "contentProductId": "[variables('analyticRuleObject31')._analyticRulecontentProductId31]",
        "id": "[variables('analyticRuleObject31')._analyticRulecontentProductId31]",
        "version": "[variables('analyticRuleObject31').analyticRuleVersion31]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject32').analyticRuleTemplateSpecName32]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RareProcessAsService_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject32').analyticRuleVersion32]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject32')._analyticRulecontentId32]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query is looking for rarely seen processes which are launched as a service. Whiltelisted process list need to be updated based on the environment.\nAuthor: Jouni Mikkola\nMore info: https://threathunt.blog/rare-process-launch-as-a-service/",
                "displayName": "Rare Process as a Service",
                "enabled": false,
                "query": "let LookupTime = 14d;\nlet WhiteList = pack_array(\n\"svchost.exe\",\n\"mssense.exe\",\n\"msmpeng.exe\",\n\"searchindexer.exe\",\n\"microsoftedgeupdate.exe\"\n);\nlet GetServices = materialize (\nDeviceProcessEvents\n| where TimeGenerated > ago(LookupTime)\n| where InitiatingProcessParentFileName contains \"services.exe\"\n| where InitiatingProcessFileName !in~(WhiteList)\n| project TimeGenerated, DeviceName, StartedChildProcess = FileName, StartedChildProcessSHA1 = SHA1, StartedChildProcessCmdline = ProcessCommandLine, ServiceProcessSHA1 = InitiatingProcessSHA1, ServiceProcess = InitiatingProcessFileName, ServiceProcessCmdline = InitiatingProcessCommandLine, ServiceProcessID = InitiatingProcessId, ServiceProcessCreationTime = InitiatingProcessCreationTime, ServiceProcessUser = InitiatingProcessAccountName\n);\nGetServices\n| summarize count() by ServiceProcess, DeviceName\n| where count_ < 6 \n| join kind = inner GetServices on ServiceProcess, DeviceName \n| join kind = leftouter ( \nDeviceNetworkEvents \n| where TimeGenerated > ago(LookupTime)\n| where InitiatingProcessParentFileName contains \"services.exe\"\n| where InitiatingProcessFileName !in~(WhiteList)\n| project TimeGenerated, DeviceName, ServiceProcessSHA1 = InitiatingProcessSHA1, ServiceProcess = InitiatingProcessFileName, ServiceProcessCmdline = InitiatingProcessCommandLine, ServiceProcessID = InitiatingProcessId, ServiceProcessCreationTime = InitiatingProcessCreationTime, ServiceProcessUser = InitiatingProcessAccountName, NetworkAction = ActionType, RemoteIP, RemoteUrl\n) on DeviceName, ServiceProcess, ServiceProcessCmdline, ServiceProcessCreationTime, ServiceProcessID, ServiceProcessUser, ServiceProcessSHA1\n| join kind = leftouter (\nDeviceFileEvents\n| where TimeGenerated > ago(LookupTime)\n| where InitiatingProcessParentFileName contains \"services.exe\"\n| where InitiatingProcessFileName !in~(WhiteList)\n| project TimeGenerated, DeviceName, ServiceProcessSHA1 = InitiatingProcessSHA1, ServiceProcess = InitiatingProcessFileName, ServiceProcessCmdline = InitiatingProcessCommandLine, ServiceProcessID = InitiatingProcessId, ServiceProcessCreationTime = InitiatingProcessCreationTime, ServiceProcessUser = InitiatingProcessAccountName, FileAction = ActionType, ModifiedFile = FileName, ModifiedFileSHA1 = SHA1, ModifiedFilePath = FolderPath\n) on DeviceName, ServiceProcess, ServiceProcessCmdline, ServiceProcessCreationTime, ServiceProcessID, ServiceProcessUser, ServiceProcessSHA1\n| join kind = leftouter (\nDeviceImageLoadEvents\n| where TimeGenerated > ago(LookupTime)\n| where InitiatingProcessParentFileName contains \"services.exe\"\n| where InitiatingProcessFileName !in~(WhiteList)\n| project TimeGenerated, DeviceName, ServiceProcessSHA1 = InitiatingProcessSHA1, ServiceProcess = InitiatingProcessFileName, ServiceProcessCmdline = InitiatingProcessCommandLine, ServiceProcessID = InitiatingProcessId, ServiceProcessCreationTime = InitiatingProcessCreationTime, ServiceProcessUser = InitiatingProcessAccountName, LoadedDLL = FileName, LoadedDLLSHA1 = SHA1, LoadedDLLPath = FolderPath\n) on DeviceName, ServiceProcess, ServiceProcessCmdline, ServiceProcessCreationTime, ServiceProcessID, ServiceProcessUser, ServiceProcessSHA1\n| summarize ConnectedAddresses = make_set(RemoteIP, 100000), ConnectedUrls = make_set(RemoteUrl, 100000), FilesModified = make_set(ModifiedFile, 100000),FileModFolderPath = make_set(ModifiedFilePath, 100000),FileModHA1s = make_set(ModifiedFileSHA1, 100000), ChildProcesses = make_set(StartedChildProcess, 100000), ChildCommandlines = make_set(StartedChildProcessCmdline, 100000), DLLsLoaded = make_set(LoadedDLL, 100000), DLLSHA1 = make_set(LoadedDLLSHA1, 100000) by DeviceName, ServiceProcess, ServiceProcessCmdline, ServiceProcessCreationTime, ServiceProcessID, ServiceProcessUser, ServiceProcessSHA1\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P14D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents",
                      "DeviceNetworkEvents",
                      "DeviceFileEvents",
                      "DeviceImageLoadEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "subTechniques": [
                  "T1543.003"
                ],
                "techniques": [
                  "T1543",
                  "T1543"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Process",
                    "fieldMappings": [
                      {
                        "columnName": "ServiceProcessID",
                        "identifier": "ProcessId"
                      },
                      {
                        "columnName": "ServiceProcessCmdline",
                        "identifier": "CommandLine"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject32').analyticRuleId32,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 32",
                "parentId": "[variables('analyticRuleObject32').analyticRuleId32]",
                "contentId": "[variables('analyticRuleObject32')._analyticRulecontentId32]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject32').analyticRuleVersion32]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject32')._analyticRulecontentId32]",
        "contentKind": "AnalyticsRule",
        "displayName": "Rare Process as a Service",
        "contentProductId": "[variables('analyticRuleObject32')._analyticRulecontentProductId32]",
        "id": "[variables('analyticRuleObject32')._analyticRulecontentProductId32]",
        "version": "[variables('analyticRuleObject32').analyticRuleVersion32]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject33').analyticRuleTemplateSpecName33]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DisableSecurityServiceViaRegistry_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject33').analyticRuleVersion33]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject33')._analyticRulecontentId33]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query checks for processes modifying the registry to disable security features. This is a common technique used by threat actors for defence evasion.",
                "displayName": "Disabling Security Services via Registry",
                "enabled": false,
                "query": "DeviceProcessEvents\n| where InitiatingProcessCommandLine has_all(@'\"reg\"', 'add', @'\"HKLM\\SOFTWARE\\Policies\\', '/v','/t', 'REG_DWORD', '/d', '/f')\n  and InitiatingProcessCommandLine has_any('DisableRealtimeMonitoring', 'UseTPMKey', 'UseTPMKeyPIN', 'UseAdvancedStartup', \n  'EnableBDEWithNoTPM', 'RecoveryKeyMessageSource')\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountUpn",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "AccountName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "AccountDomain",
                        "identifier": "NTDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Process",
                    "fieldMappings": [
                      {
                        "columnName": "ProcessId",
                        "identifier": "ProcessId"
                      },
                      {
                        "columnName": "ProcessCommandLine",
                        "identifier": "CommandLine"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject33').analyticRuleId33,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 33",
                "parentId": "[variables('analyticRuleObject33').analyticRuleId33]",
                "contentId": "[variables('analyticRuleObject33')._analyticRulecontentId33]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject33').analyticRuleVersion33]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject33')._analyticRulecontentId33]",
        "contentKind": "AnalyticsRule",
        "displayName": "Disabling Security Services via Registry",
        "contentProductId": "[variables('analyticRuleObject33')._analyticRulecontentProductId33]",
        "id": "[variables('analyticRuleObject33')._analyticRulecontentProductId33]",
        "version": "[variables('analyticRuleObject33').analyticRuleVersion33]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject34').analyticRuleTemplateSpecName34]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DataDeletionOnMulipleDrivesUsingCipherExe_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject34').analyticRuleVersion34]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject34')._analyticRulecontentId34]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query checks for attempts to delete data on multiple drives using cipher.exe. This activity is typically done by ransomware to prevent recovery of data after encryption.",
                "displayName": "Deletion of data on multiple drives using cipher exe",
                "enabled": false,
                "query": "// Look for cipher.exe deleting data from multiple drives\nDeviceProcessEvents\n| where FileName =~ \"cipher.exe\" \n// cipher.exe /w flag used for deleting data \n| where ProcessCommandLine has \"/w\" \n| summarize CipherCount = dcount(ProcessCommandLine), CipherList = make_set(ProcessCommandLine, 1000) by DeviceId, DeviceName, bin(TimeGenerated, 1m) \n// cipher.exe accessing multiple drives in a short timeframe  \n| where CipherCount > 1\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Impact"
                ],
                "techniques": [
                  "T1485"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject34').analyticRuleId34,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 34",
                "parentId": "[variables('analyticRuleObject34').analyticRuleId34]",
                "contentId": "[variables('analyticRuleObject34')._analyticRulecontentId34]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject34').analyticRuleVersion34]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject34')._analyticRulecontentId34]",
        "contentKind": "AnalyticsRule",
        "displayName": "Deletion of data on multiple drives using cipher exe",
        "contentProductId": "[variables('analyticRuleObject34')._analyticRulecontentProductId34]",
        "id": "[variables('analyticRuleObject34')._analyticRulecontentProductId34]",
        "version": "[variables('analyticRuleObject34').analyticRuleVersion34]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject35').analyticRuleTemplateSpecName35]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "LaZagneCredTheft_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject35').analyticRuleVersion35]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject35')._analyticRulecontentId35]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "LaZagne is a popular open-source tool used to recover passwords stored on a local computer. It has been used in ransomware attacks to steal credentials and escalate privileges. This query looks for the execution of LaZagne.",
                "displayName": "LaZagne Credential Theft",
                "enabled": false,
                "query": "DeviceProcessEvents \n| where FileName =~ 'reg.exe'\n| where ProcessCommandLine has_all('save','hklm','sam')\n| project DeviceId, DeviceName, TimeGenerated, InitiatingProcessId, InitiatingProcessFileName, ProcessId, FileName, ProcessCommandLine\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "CredentialAccess"
                ],
                "techniques": [
                  "T1003"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Process",
                    "fieldMappings": [
                      {
                        "columnName": "ProcessId",
                        "identifier": "ProcessId"
                      },
                      {
                        "columnName": "ProcessCommandLine",
                        "identifier": "CommandLine"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject35').analyticRuleId35,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 35",
                "parentId": "[variables('analyticRuleObject35').analyticRuleId35]",
                "contentId": "[variables('analyticRuleObject35')._analyticRulecontentId35]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject35').analyticRuleVersion35]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject35')._analyticRulecontentId35]",
        "contentKind": "AnalyticsRule",
        "displayName": "LaZagne Credential Theft",
        "contentProductId": "[variables('analyticRuleObject35')._analyticRulecontentProductId35]",
        "id": "[variables('analyticRuleObject35')._analyticRulecontentProductId35]",
        "version": "[variables('analyticRuleObject35').analyticRuleVersion35]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject36').analyticRuleTemplateSpecName36]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "LogDeletionUsingWevtutil_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject36').analyticRuleVersion36]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject36')._analyticRulecontentId36]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query checks for attempts to clear at least 10 log entries from event logs using wevtutil. Clearing event logs can be a sign of ransomware activity, as ransomware often attempts to cover its tracks by deleting logs.",
                "displayName": "Clearing of forensic evidence from event logs using wevtutil",
                "enabled": false,
                "query": "// Look for use of wevtutil to clear multiple logs\nDeviceProcessEvents\n| where ProcessCommandLine has \"WEVTUTIL\" and ProcessCommandLine has \"CL\"\n| summarize LogClearCount = dcount(tostring(ProcessCommandLine)), ClearedLogList = make_set(ProcessCommandLine, 100000) by DeviceId, DeviceName, bin(TimeGenerated, 5m)\n| where LogClearCount > 10\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1070"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject36').analyticRuleId36,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 36",
                "parentId": "[variables('analyticRuleObject36').analyticRuleId36]",
                "contentId": "[variables('analyticRuleObject36')._analyticRulecontentId36]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject36').analyticRuleVersion36]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject36')._analyticRulecontentId36]",
        "contentKind": "AnalyticsRule",
        "displayName": "Clearing of forensic evidence from event logs using wevtutil",
        "contentProductId": "[variables('analyticRuleObject36')._analyticRulecontentProductId36]",
        "id": "[variables('analyticRuleObject36')._analyticRulecontentProductId36]",
        "version": "[variables('analyticRuleObject36').analyticRuleVersion36]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject37').analyticRuleTemplateSpecName37]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MultiProcessKillWithTaskKill_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject37').analyticRuleVersion37]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject37')._analyticRulecontentId37]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query checks for attempts to stop at least 10 separate processes using the taskkill.exe utility. This is a common technique used by ransomware to stop security products and other processes.",
                "displayName": "Stopping multiple processes using taskkill",
                "enabled": false,
                "query": "// Find attempts to stop processes using taskkill.exe\nDeviceProcessEvents\n| where FileName =~ \"taskkill.exe\" \n| summarize taskKillCount = dcount(ProcessCommandLine), TaskKillList = make_set(ProcessCommandLine, 10000) by DeviceId, DeviceName, bin(TimeGenerated, 2m)\n| where taskKillCount > 10\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject37').analyticRuleId37,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 37",
                "parentId": "[variables('analyticRuleObject37').analyticRuleId37]",
                "contentId": "[variables('analyticRuleObject37')._analyticRulecontentId37]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject37').analyticRuleVersion37]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject37')._analyticRulecontentId37]",
        "contentKind": "AnalyticsRule",
        "displayName": "Stopping multiple processes using taskkill",
        "contentProductId": "[variables('analyticRuleObject37')._analyticRulecontentProductId37]",
        "id": "[variables('analyticRuleObject37')._analyticRulecontentProductId37]",
        "version": "[variables('analyticRuleObject37').analyticRuleVersion37]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject38').analyticRuleTemplateSpecName38]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PotentialCobaltStrikeRansomwareActivity_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject38').analyticRuleVersion38]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject38')._analyticRulecontentId38]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query searches for alerts related to suspected ransomware and Cobalt Strike activity, a tool used in numerous ransomware campaigns. It looks for alerts that indicate potential ransomware activity, such as attempts to clear security event logs, delete backup files, and execute Cobalt Strike malware.",
                "displayName": "Potential Ransomware activity related to Cobalt Strike",
                "enabled": false,
                "query": "// Look for sc.exe disabling services\nAlertInfo \n// Attempts to clear security event logs. \n| where Title in(\"Event log was cleared\", \n// List alerts flagging attempts to delete backup files. \n\"File backups were deleted\", \n// Potential Cobalt Strike activity - Note that other threat activity can also \n// trigger alerts for suspicious decoded content \n\"Suspicious decoded content\", \n// Cobalt Strike activity \n\"\\'Atosev\\' malware was detected\", \n\"\\'Ploty\\' malware was detected\", \n\"\\'Bynoco\\' malware was detected\",\n\"\\'Cobaltstrike\\' malware was detected\",\n\"Echo command over pipe on localhost\",\n\"Known attack framework activity was observed\",\n\"An active \\'Cobaltstrike\\' malware was detected\",\n\"Suspicious \\'CobaltStrike\\' behavior was prevented\",\n\"Suspicious process launch by Rundll32.exe\") \n| extend AlertTime = TimeGenerated | distinct AlertTime, AlertId, Title \n| join AlertEvidence on $left.AlertId == $right.AlertId\n| summarize by DeviceId, AlertTime, Title, AlertId\n// Get device IDs\n| join DeviceLogonEvents on $left.DeviceId == $right.DeviceId \n// Creating 10 day Window surrounding alert activity \n| where TimeGenerated < AlertTime + 12h and TimeGenerated > AlertTime - 12h // Projecting specific columns \n| project Title, DeviceName, DeviceId, TimeGenerated, LogonType, AccountDomain, AccountName, AccountSid, AlertTime, AlertId, RemoteIP, RemoteDeviceName\n| extend AccountFullName = tostring(strcat(AccountDomain, \"\\\\\", AccountName))\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "AlertInfo",
                      "AlertEvidence",
                      "DeviceLogonEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Execution",
                  "Persistence",
                  "DefenseEvasion",
                  "Impact"
                ],
                "techniques": [
                  "T1059",
                  "T1078",
                  "T1070",
                  "T1490"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountFullName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "AccountName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "AccountDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "RemoteIP",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject38').analyticRuleId38,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 38",
                "parentId": "[variables('analyticRuleObject38').analyticRuleId38]",
                "contentId": "[variables('analyticRuleObject38')._analyticRulecontentId38]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject38').analyticRuleVersion38]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject38')._analyticRulecontentId38]",
        "contentKind": "AnalyticsRule",
        "displayName": "Potential Ransomware activity related to Cobalt Strike",
        "contentProductId": "[variables('analyticRuleObject38')._analyticRulecontentProductId38]",
        "id": "[variables('analyticRuleObject38')._analyticRulecontentProductId38]",
        "version": "[variables('analyticRuleObject38').analyticRuleVersion38]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject39').analyticRuleTemplateSpecName39]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "QakbotDiscoveryActivities_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject39').analyticRuleVersion39]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject39')._analyticRulecontentId39]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query searches for injected processes launching discovery activity. Qakbot has been observed leading to ransomware in numerous instances. It looks for discovery commands such as net.exe, whoami.exe, nslookup.exe, netstat.exe, arp.exe, and ping.exe.",
                "displayName": "Qakbot Discovery Activies",
                "enabled": false,
                "query": "DeviceProcessEvents \n| where InitiatingProcessFileName in~('mobsync.exe','explorer.exe')\n| where (FileName =~ 'net.exe' and InitiatingProcessCommandLine has_all('view','/all'))\n     or (FileName =~ 'whoami.exe' and InitiatingProcessCommandLine has '/all')\n     or (FileName =~ 'nslookup.exe' and InitiatingProcessCommandLine has_all('querytype=ALL','timeout=10'))\n     or (FileName =~ 'netstat.exe' and InitiatingProcessCommandLine has '-nao')\n     or (FileName =~ 'arp.exe' and InitiatingProcessCommandLine has '-a')\n     or (FileName =~ 'ping.exe' and InitiatingProcessCommandLine has '-t' and InitiatingProcessCommandLine endswith '127.0.0.1')\n| summarize DiscoveryCommands = dcount(InitiatingProcessCommandLine), make_set(InitiatingProcessFileName), make_set(FileName), make_set(InitiatingProcessCommandLine) by DeviceId, DeviceName, bin(TimeGenerated, 5m)   \n| where DiscoveryCommands >= 3\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion",
                  "Discovery",
                  "Execution"
                ],
                "techniques": [
                  "T1140",
                  "T1010",
                  "T1059"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject39').analyticRuleId39,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 39",
                "parentId": "[variables('analyticRuleObject39').analyticRuleId39]",
                "contentId": "[variables('analyticRuleObject39')._analyticRulecontentId39]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject39').analyticRuleVersion39]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject39')._analyticRulecontentId39]",
        "contentKind": "AnalyticsRule",
        "displayName": "Qakbot Discovery Activies",
        "contentProductId": "[variables('analyticRuleObject39')._analyticRulecontentProductId39]",
        "id": "[variables('analyticRuleObject39')._analyticRulecontentProductId39]",
        "version": "[variables('analyticRuleObject39').analyticRuleVersion39]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject40').analyticRuleTemplateSpecName40]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ShadowCopyDeletion_AnalyticalRules Analytics Rule with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject40').analyticRuleVersion40]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject40')._analyticRulecontentId40]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This rule detects when Shadow Copies are being deleted. This is a know actions that is performed by threat actors.\nThis query detects know commands that have been used by the ransomware actors.\nSome information from Mitre Attack: \nhttps://attack.mitre.org/techniques/T1490/",
                "displayName": "Shadow Copy Deletions",
                "enabled": false,
                "query": "let CommonRansomwareExecutionCommands = dynamic([@'vssadmin.exe delete shadows /all /quiet', \n@'wmic.exe shadowcopy delete', @'wbadmin delete catalog -quiet', \n@'Get-WmiObject Win32_Shadowcopy | ForEach-Object {$_.Delete();}',\n@'del /s /f /q c:\\*.VHD c:\\*.bac c:\\*.bak c:\\*.wbcat c:\\*.bkf c:\\Backup*.* c:\\backup*.* c:\\*.set c:\\*.win c:\\*.dsk', \n@'wbadmin delete systemstatebackup -keepVersions:0', \n@'schtasks.exe /Change /TN \"\\Microsoft\\Windows\\SystemRestore\\SR\" /disable', \n@'schtasks.exe /Change /TN \"\\Microsoft\\Windows\\SystemRestore\\SR\" /enable >nul 2>&1', \n@'reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\SystemRestore\" /v \"DisableConfig\" /t \"REG_DWORD\" /d \"1\" /f', \n@'reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\SystemRestore\" /v \"DisableSR\" /t \"REG_DWORD\" /d \"1\" /f', \n@'reg add \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore\" /v \"DisableConfig\" /t \"REG_DWORD\" /d \"1\" /f', \n@'reg add \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore\" /v \"DisableSR\" /t \"REG_DWORD\" /d \"1\" /f', \n@'reg delete \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\SystemRestore\" /v \"DisableConfig\" /f >nul 2>&1', \n@'reg delete \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\SystemRestore\" /v \"DisableSR\" /f >nul 2>&1', \n@'reg delete \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore\" /v \"DisableConfig\" /f >nul 2>&1', \n@'reg delete \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore\" /v \"DisableSR\" /f >nul 2>&1']);\nDeviceProcessEvents\n| where ProcessCommandLine has_any (CommonRansomwareExecutionCommands)\n| project-reorder TimeGenerated, ProcessCommandLine, DeviceName, AccountName\n| extend HostName = iff(DeviceName has '.', substring(DeviceName, 0, indexof(DeviceName, '.')), DeviceName)\n| extend DnsDomain = iff(DeviceName has '.', substring(DeviceName, indexof(DeviceName, '.') + 1), \"\")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "MicrosoftThreatProtection",
                    "dataTypes": [
                      "DeviceProcessEvents"
                    ]
                  }
                ],
                "tactics": [
                  "Impact"
                ],
                "techniques": [
                  "T1490"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "columnName": "DeviceName",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "HostName",
                        "identifier": "HostName"
                      },
                      {
                        "columnName": "DnsDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "AccountUpn",
                        "identifier": "FullName"
                      },
                      {
                        "columnName": "AccountName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "AccountDomain",
                        "identifier": "DnsDomain"
                      }
                    ]
                  },
                  {
                    "entityType": "Process",
                    "fieldMappings": [
                      {
                        "columnName": "ProcessId",
                        "identifier": "ProcessId"
                      },
                      {
                        "columnName": "ProcessCommandLine",
                        "identifier": "CommandLine"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject40').analyticRuleId40,'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Analytics Rule 40",
                "parentId": "[variables('analyticRuleObject40').analyticRuleId40]",
                "contentId": "[variables('analyticRuleObject40')._analyticRulecontentId40]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject40').analyticRuleVersion40]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject40')._analyticRulecontentId40]",
        "contentKind": "AnalyticsRule",
        "displayName": "Shadow Copy Deletions",
        "contentProductId": "[variables('analyticRuleObject40')._analyticRulecontentProductId40]",
        "id": "[variables('analyticRuleObject40')._analyticRulecontentProductId40]",
        "version": "[variables('analyticRuleObject40').analyticRuleVersion40]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject1').huntingQueryTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Appspot Phishing Abuse_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject1').huntingQueryVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_1",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Appspot Phishing Abuse",
                "category": "Hunting Queries",
                "query": "EmailUrlInfo\n// Detect URLs with a subdomain on appspot.com\n| where UrlDomain matches regex @'\\b[\\w\\-]+-dot-[\\w\\-\\.]+\\.appspot\\.com\\b'\n// Enrich results with sender and recipient data\n| join kind=inner EmailEvents on $left.NetworkMessageId==$right.NetworkMessageId\n// Phishing attempts from Appspot related campaigns typically contain the recipient's email address in the URI\n// Example 1: https://example-dot-example.appspot.com/#recipient@domain.com\n// Example 2: https://example-dot-example.appspot.com/index.html?user=recipient@domain.com\n| where Url has RecipientEmailAddress\n    // Some phishing campaigns pass recipient email as a Base64 encoded string in the URI\n    or Url has base64_encode_tostring(RecipientEmailAddress)\n| project-away NetworkMessageId1, ReportId1, Type1, TimeGenerated1, Timestamp1\n| extend Name = tostring(split(SenderFromAddress, '@', 0)[0]), UPNSuffix = tostring(split(SenderFromAddress, '@', 1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = SenderIPv4\n| extend URL_0_Url = Url\n| extend MailBox_0_MailboxPrimaryAddress = RecipientEmailAddress\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps surface phishing campaigns associated with Appspot abuse.These emails frequently contain phishing links that utilize the recipients' own email address as a unique identifier in the URI.\nThis campaign was published on Twitter by @MsftSecIntel at this link: https://twitter.com/MsftSecIntel/status/1374148156301004800\nReference - https://twitter.com/MsftSecIntel/status/1374148156301004800"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject1')._huntingQuerycontentId1),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 1",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject1')._huntingQuerycontentId1)]",
                "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject1').huntingQueryVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
        "contentKind": "HuntingQuery",
        "displayName": "Appspot Phishing Abuse",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject1')._huntingQuerycontentId1,'-', '1.1.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject1')._huntingQuerycontentId1,'-', '1.1.0')))]",
        "version": "1.1.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject2').huntingQueryTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PayloadDropUsingCertUtil_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject2').huntingQueryVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_2",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Dropping Payload via certutil",
                "category": "Hunting Queries",
                "query": "DeviceFileEvents\n| where InitiatingProcessFileName !~ \"certutil.exe\"\n| where InitiatingProcessFileName !~ \"cmd.exe\"\n| where InitiatingProcessCommandLine has_all(\"-urlcache\", \"split\", \"http\")\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "BazaCall campaign tricks users into calling a fake customer support center, and download a malicious Excel file which contains a macro to infect users' device with BazaLoader. This query searches for a copy of certutil.exe used by the macro."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess,DefenseEvasion"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject2')._huntingQuerycontentId2),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 2",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject2')._huntingQuerycontentId2)]",
                "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject2').huntingQueryVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
        "contentKind": "HuntingQuery",
        "displayName": "Dropping Payload via certutil",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject2')._huntingQuerycontentId2,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject2')._huntingQuerycontentId2,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject3').huntingQueryTemplateSpecName3]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "JudgementPandaExfilActivity_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject3').huntingQueryVersion3]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_3",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Judgement Panda Exfil Activity",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents\n| where TimeGenerated > ago(7d)\n| where ProcessCommandLine has @\"\\ldifde.exe -f -n \"\n     or ProcessCommandLine has @\"\\7za.exe a 1.7z \" \n     or ProcessCommandLine endswith @\" eprod.ldf\" \n     or ProcessCommandLine has @\"\\aaaa\\procdump64.exe\" \n     or ProcessCommandLine has @\"\\aaaa\\netsess.exe\" \n     or ProcessCommandLine has @\"\\aaaa\\7za.exe\" \n     or ProcessCommandLine has @\"copy .\\1.7z \\\" \n     or ProcessCommandLine has @\"copy \\client\\c$\\aaaa\\\" \n     or FolderPath == @\"C:\\Users\\Public\\7za.exe\"\n| top 100 by TimeGenerated desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Original Sigma Rule: https://github.com/Neo23x0/sigma/blob/master/rules/apt/apt_judgement_panda_gtr19.yml.\nQuestions via Twitter: @janvonkirchheim."
                  },
                  {
                    "name": "tactics",
                    "value": "Collection"
                  },
                  {
                    "name": "techniques",
                    "value": "T1560"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject3')._huntingQuerycontentId3),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 3",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject3')._huntingQuerycontentId3)]",
                "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject3').huntingQueryVersion3]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
        "contentKind": "HuntingQuery",
        "displayName": "Judgement Panda Exfil Activity",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject3')._huntingQuerycontentId3,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject3')._huntingQuerycontentId3,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject4').huntingQueryTemplateSpecName4]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DeimosComponentExecution_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject4').huntingQueryVersion4]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_4",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Deimos Component Execution",
                "category": "Hunting Queries",
                "query": "DeviceEvents   \n| where InitiatingProcessFileName =~ \"powershell.exe\"\n| where ActionType == \"AmsiScriptContent\"\n| where AdditionalFields endswith '[mArS.deiMos]::inteRaCt()\"}'\n| project InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessCommandLine, ActionType, AdditionalFields\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Jupyter, otherwise known as SolarMarker, is a malware family and cluster of components known for its info-stealing and backdoor capabilities that mainly proliferates through search engine optimization manipulation and malicious advertising."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution,Collection,Exfiltration,Impact"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject4')._huntingQuerycontentId4),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 4",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject4')._huntingQuerycontentId4)]",
                "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject4').huntingQueryVersion4]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
        "contentKind": "HuntingQuery",
        "displayName": "Deimos Component Execution",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject4')._huntingQuerycontentId4,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject4')._huntingQuerycontentId4,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject5').huntingQueryTemplateSpecName5]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "LemonDuckRegistrationFunction_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject5').huntingQueryVersion5]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_5",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "LemonDuck Registration Function",
                "category": "Hunting Queries",
                "query": "DeviceEvents\n| where ActionType == \"PowerShellCommand\"\n| where AdditionalFields =~ \"{\\\"Command\\\":\\\"SIEX\\\"}\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "LemonDuck is a malware primarily known for its botnet and cryptocurrency mining objectives. First discovered in 2019, LemonDuck has since adopted more sophisticated behavior and escalated its operations in 2021."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution,Persistence,LateralMovement,CommandAndControl"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject5')._huntingQuerycontentId5),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 5",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject5')._huntingQuerycontentId5)]",
                "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject5').huntingQueryVersion5]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
        "contentKind": "HuntingQuery",
        "displayName": "LemonDuck Registration Function",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject5')._huntingQuerycontentId5,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject5')._huntingQuerycontentId5,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject6').huntingQueryTemplateSpecName6]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DeviceWithLog4jAlerts_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject6').huntingQueryVersion6]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_6",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Devices with Log4j vulnerability alerts and additional other alert related context",
                "category": "Hunting Queries",
                "query": "// Get any devices with Log4J related Alert Activity\nlet DevicesLog4JAlerts = AlertInfo\n| where Title in~('Suspicious script launched',\n'Exploitation attempt against Log4j (CVE-2021-44228)',\n'Suspicious process executed by a network service',\n'Possible target of Log4j exploitation (CVE-2021-44228)',\n'Possible target of Log4j exploitation',\n'Possible Log4j exploitation',\n'Network connection seen in CVE-2021-44228 exploitation',\n'Log4j exploitation detected',\n'Possible exploitation of CVE-2021-44228',\n'Possible target of Log4j vulnerability (CVE-2021-44228) scanning',\n'Possible source of Log4j exploitation'\n'Log4j exploitation attempt via cloud application', // Previously titled Exploitation attempt against Log4j\n'Log4j exploitation attempt via email' // Previously titled Log4j Exploitation Attempt\n)\n// Join in evidence information\n| join kind=innerunique AlertEvidence on AlertId\n| where DeviceId != \"\"\n| summarize by DeviceId, Title;\n// Get additional alert activity for each device\nAlertEvidence\n| where DeviceId in(DevicesLog4JAlerts)\n// Add additional info\n| join kind=leftouter AlertInfo on AlertId\n| summarize DeviceAlerts = make_set(Title, 100000), AlertIDs = make_set(AlertId, 100000) by DeviceId, bin(TimeGenerated, 1d)\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Microsoft has observed threat actors exploiting vulnerabilities associated with Log4J."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess,Execution"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject6')._huntingQuerycontentId6),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 6",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject6')._huntingQuerycontentId6)]",
                "contentId": "[variables('huntingQueryObject6')._huntingQuerycontentId6]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject6').huntingQueryVersion6]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject6')._huntingQuerycontentId6]",
        "contentKind": "HuntingQuery",
        "displayName": "Devices with Log4j vulnerability alerts and additional other alert related context",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject6')._huntingQuerycontentId6,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject6')._huntingQuerycontentId6,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject7').huntingQueryTemplateSpecName7]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Log4jVulnRelatedAlerts_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject7').huntingQueryVersion7]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_7",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Alerts Related to Log4j Vulnerability",
                "category": "Hunting Queries",
                "query": "AlertInfo\n| where Title in~('Suspicious script launched',\n'Exploitation attempt against Log4j (CVE-2021-44228)',\n'Suspicious process executed by a network service',\n'Possible target of Log4j exploitation (CVE-2021-44228)',\n'Possible target of Log4j exploitation',\n'Possible Log4j exploitation',\n'Network connection seen in CVE-2021-44228 exploitation',\n'Log4j exploitation detected',\n'Possible exploitation of CVE-2021-44228',\n'Possible target of Log4j vulnerability (CVE-2021-44228) scanning',\n'Possible source of Log4j exploitation',\n'Log4j exploitation attempt via cloud application', // Previously titled Exploitation attempt against Log4j\n'Log4j exploitation attempt via email' // Previously titled Log4j Exploitation Attempt\n)\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Microsoft has observed attackers exploiting vulnerabilities associated with Log4J."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject7')._huntingQuerycontentId7),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 7",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject7')._huntingQuerycontentId7)]",
                "contentId": "[variables('huntingQueryObject7')._huntingQuerycontentId7]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject7').huntingQueryVersion7]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject7')._huntingQuerycontentId7]",
        "contentKind": "HuntingQuery",
        "displayName": "Alerts Related to Log4j Vulnerability",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject7')._huntingQuerycontentId7,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject7')._huntingQuerycontentId7,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject8').huntingQueryTemplateSpecName8]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ImminentRansomware_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject8').huntingQueryVersion8]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_8",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Imminent Ransomware",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents \n// Pivot on specific commands \n| where ProcessCommandLine has_any(\"-ExclusionPath\", \"Set-MpPreference\", \"advfirewall\", \"-ExclusionExtension\", \n\"-EnableControlledFolderAccess\", \"windefend\", \"onstart\", \"bcdedit\", \"Startup\") \n// Making list of found commands \n| summarize ProcessCommandLine = make_set(ProcessCommandLine, 10000) by DeviceId, bin(TimeGenerated, 6h) \n// Extending columns for later aggregration, based on TTP \n| extend StartUpExclusionPath = iff(ProcessCommandLine has_all(\"-ExclusionPath\", \"Startup\"), 1, 0) \n| extend DefenderTamp = iff(ProcessCommandLine has \"Set-MpPreference\" \nand ProcessCommandLine has_any( \n\"-SevereThreatDefaultAction 6\" \n\"-HighThreatDefaultAction 6\", \n\"-ModerateThreatDefaultAction 6\", \n\"-LowThreatDefaultAction 6\" \n\"-ScanScheduleDay 8\"), 1, 0) \n| extend NetshFirewallTampering = iff(ProcessCommandLine has_all( \"netsh\", \"advfirewall\", \"allprofiles state off\"), 1, 0) \n| extend BatExclusion = iff(ProcessCommandLine has_all(\"-ExclusionExtension\", \".bat\"), 1, 0) \n| extend ExeExclusion = iff(ProcessCommandLine has_all(\"-ExclusionExtension\", \".exe\"), 1, 0) \n| extend DisableControlledFolderAccess = iff(ProcessCommandLine has_all(\"-EnableControlledFolderAccess\", \"Disabled\"), 1, 0) \n| extend ScDeleteDefend = iff(ProcessCommandLine has_all(\"sc\", \"delete\", \"windefend\"), 1, 0) \n| extend BootTampering = iff(ProcessCommandLine has_all(\"bcdedit\", \"default\") and ProcessCommandLine has_any (\"recoveryenabled No\", \"bootstatuspolicy ignoreallfailures\"), 1, 0) \n| extend SchTasks = iff(ProcessCommandLine has_all(\"/sc\", \"onstart\", \"system\", \"/create\", \"/delay\"), 1, 0) \n// Summarizing found commands \n| summarize by NetshFirewallTampering ,BatExclusion, ExeExclusion, DisableControlledFolderAccess, ScDeleteDefend, SchTasks, BootTampering, DefenderTamp, StartUpExclusionPath, DeviceId, TimeGenerated \n// Adding up each piece of evidence \n| extend EvidenceCount = NetshFirewallTampering + BatExclusion + ExeExclusion + DisableControlledFolderAccess + ScDeleteDefend + SchTasks + BootTampering + DefenderTamp + StartUpExclusionPath \n| where EvidenceCount > 4\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Before deploying Macaw ransomware in an organization, the attacker will run several commands designed to disable security tools and system recovery tools."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject8')._huntingQuerycontentId8),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 8",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject8')._huntingQuerycontentId8)]",
                "contentId": "[variables('huntingQueryObject8')._huntingQuerycontentId8]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject8').huntingQueryVersion8]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject8')._huntingQuerycontentId8]",
        "contentKind": "HuntingQuery",
        "displayName": "Imminent Ransomware",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject8')._huntingQuerycontentId8,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject8')._huntingQuerycontentId8,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject9').huntingQueryTemplateSpecName9]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MaliciousUseOfMSBuildAsLoLBin_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject9').huntingQueryVersion9]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_9",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malicious Use of MSBuild as LOLBin",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents \n| where InitiatingProcessFileName =~ \"wmiprvse.exe\" \n| where FileName =~ \"msbuild.exe\" and ProcessCommandLine has \"programdata\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Prior to deploying Macaw ransomware in an organization, the adversary frequently uses MSBuild.exe as a LOLBin to communicate with the C2."
                  },
                  {
                    "name": "tactics",
                    "value": "CommandAndControl"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject9')._huntingQuerycontentId9),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 9",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject9')._huntingQuerycontentId9)]",
                "contentId": "[variables('huntingQueryObject9')._huntingQuerycontentId9]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject9').huntingQueryVersion9]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject9')._huntingQuerycontentId9]",
        "contentKind": "HuntingQuery",
        "displayName": "Malicious Use of MSBuild as LOLBin",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject9')._huntingQuerycontentId9,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject9')._huntingQuerycontentId9,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject10').huntingQueryTemplateSpecName10]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "QakbotReconActivities_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject10').huntingQueryVersion10]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_10",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Qakbot Reconnaissance Activities",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents\n| where InitiatingProcessFileName == InitiatingProcessCommandLine\n| where ProcessCommandLine has_any (\n\"whoami /all\",\"cmd /c set\",\"arp -a\",\"ipconfig /all\",\"net view /all\",\"nslookup -querytype=ALL -timeout=10\",\n\"net share\",\"route print\",\"netstat -nao\",\"net localgroup\")\n| summarize dcount(FileName), make_set(ProcessCommandLine, 10000) by DeviceId,bin(TimeGenerated, 1d), InitiatingProcessFileName, InitiatingProcessCommandLine\n| where dcount_FileName >= 8\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for reconnaissance and beaconing activities after code injection occurs in Qakbot infections."
                  },
                  {
                    "name": "tactics",
                    "value": "Discovery"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject10')._huntingQuerycontentId10),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 10",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject10')._huntingQuerycontentId10)]",
                "contentId": "[variables('huntingQueryObject10')._huntingQuerycontentId10]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject10').huntingQueryVersion10]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject10')._huntingQuerycontentId10]",
        "contentKind": "HuntingQuery",
        "displayName": "Qakbot Reconnaissance Activities",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject10')._huntingQuerycontentId10,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject10')._huntingQuerycontentId10,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject11').huntingQueryTemplateSpecName11]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RobbinhoodDriver_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject11').huntingQueryVersion11]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_11",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Robbinhood Driver",
                "category": "Hunting Queries",
                "query": "DeviceFileEvents\n| where TimeGenerated > ago(7d)\n| where SHA1 in('0b15b5cc64caf0c6ad9bd759eb35383b1f718edf3d7ab4cd912d0d8c1826edf8',\n'31f4cfb4c71da44120752721103a16512444c13c2ac2d857a7e6f13cb679b427')\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query detects the presence of the Robbinhood ransomware driver."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution,DefenseEvasion"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject11')._huntingQuerycontentId11),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 11",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject11')._huntingQuerycontentId11)]",
                "contentId": "[variables('huntingQueryObject11')._huntingQuerycontentId11]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject11').huntingQueryVersion11]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject11')._huntingQuerycontentId11]",
        "contentKind": "HuntingQuery",
        "displayName": "Robbinhood Driver",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject11')._huntingQuerycontentId11,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject11')._huntingQuerycontentId11,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject12').huntingQueryTemplateSpecName12]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Snip3MaliciousNetworkConnectivity_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject12').huntingQueryVersion12]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_12",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Snip3 Malicious Network Connectivity",
                "category": "Hunting Queries",
                "query": "DeviceNetworkEvents \n| where InitiatingProcessFileName in~ (\"RegSvcs.exe\",\"RegAsm.exe\", \"InstallUtil.exe\") \n| where InitiatingProcessCommandLine in~ (\"\\\"RegAsm.exe\\\"\",\"\\\"RegSvcs.exe\\\"\",\"\\\"InstallUtil.exe\\\"\") \n| where InitiatingProcessParentFileName endswith \"powershell.exe\" \n  or InitiatingProcessParentFileName endswith \"powershell_ise.exe\" \n  or InitiatingProcessParentFileName endswith \"pwsh.exe\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This hunting query looks for potentially hollowed processes that may be used to facilitate command-and-control or exfiltration by Snip3 malware."
                  },
                  {
                    "name": "tactics",
                    "value": "CommandAndControl,Exfiltration"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject12')._huntingQuerycontentId12),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 12",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject12')._huntingQuerycontentId12)]",
                "contentId": "[variables('huntingQueryObject12')._huntingQuerycontentId12]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject12').huntingQueryVersion12]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject12')._huntingQuerycontentId12]",
        "contentKind": "HuntingQuery",
        "displayName": "Snip3 Malicious Network Connectivity",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject12')._huntingQuerycontentId12,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject12')._huntingQuerycontentId12,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject13').huntingQueryTemplateSpecName13]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MaliciousCMDExecutionByJava_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject13').huntingQueryVersion13]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_13",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Java Executing cmd to run Powershell",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents                         \n| where InitiatingProcessFileName == 'java.exe' and FileName == 'cmd.exe' \nand ProcessCommandLine has_all('powershell iex','DownloadString')\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query finds instances of the Java process being used to execute cmd.exe, and download and execute a PowerShell script."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject13')._huntingQuerycontentId13),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 13",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject13')._huntingQuerycontentId13)]",
                "contentId": "[variables('huntingQueryObject13')._huntingQuerycontentId13]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject13').huntingQueryVersion13]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject13')._huntingQuerycontentId13]",
        "contentKind": "HuntingQuery",
        "displayName": "Java Executing cmd to run Powershell",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject13')._huntingQuerycontentId13,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject13')._huntingQuerycontentId13,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject14').huntingQueryTemplateSpecName14]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Check for spoofing attempts on the domain with Authentication failures_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject14').huntingQueryVersion14]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_14",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spoofing attempts from Specific Domains",
                "category": "Hunting Queries",
                "query": "// Add the list of domains to search for.\nlet DomainList = dynamic([\"contoso.com\"]); \nEmailEvents \n| where TimeGenerated > ago (1d) and DetectionMethods has \"spoof\" and SenderFromDomain in~ (DomainList)\n| project TimeGenerated, AR=parse_json(AuthenticationDetails) , NetworkMessageId, EmailDirection, Subject, SenderFromAddress, SenderIPv4, ThreatTypes, DetectionMethods, ThreatNames  \n| evaluate bag_unpack(AR)  \n| where column_ifexists('SPF','') =~ \"fail\" or  column_ifexists('DMARC','') =~ \"fail\" or column_ifexists('DKIM','') =~ \"fail\" or column_ifexists('CompAuth','') =~ \"fail\"\n| extend Name = tostring(split(SenderFromAddress, '@', 0)[0]), UPNSuffix = tostring(split(SenderFromAddress, '@', 1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = SenderIPv4\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query identifies potential phishing or spoofing attempts originating from specific domains with authentication failures."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject14')._huntingQuerycontentId14),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 14",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject14')._huntingQuerycontentId14)]",
                "contentId": "[variables('huntingQueryObject14')._huntingQuerycontentId14]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject14').huntingQueryVersion14]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject14')._huntingQuerycontentId14]",
        "contentKind": "HuntingQuery",
        "displayName": "Spoofing attempts from Specific Domains",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject14')._huntingQuerycontentId14,'-', '1.1.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject14')._huntingQuerycontentId14,'-', '1.1.0')))]",
        "version": "1.1.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject15').huntingQueryTemplateSpecName15]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "C2-NamedPipe_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject15').huntingQueryVersion15]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_15",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "C2-NamedPipe",
                "category": "Hunting Queries",
                "query": "// maximum lookback time\nlet minTimeRange = ago(7d);\n// this is what should be constantly tweaked with default C2 framework names, search uses has_any (wildcard)\nlet badPipeNames = pack_array(\n    '\\\\psexec',                                     // PSexec default pipe\n    '\\\\paexec',                                     // PSexec default pipe\n    '\\\\remcom',                                     // PSexec default pipe\n    '\\\\csexec',                                     // PSexec default pipe\n    '\\\\isapi_http',                                 // Uroburos Malware Named Pipe\n    '\\\\isapi_dg',                                   // Uroburos Malware Named Pipe\n    '\\\\isapi_dg2',                                  // Uroburos Malware Named Pipe\n    '\\\\sdlrpc',                                     // Cobra Trojan Named Pipe http://goo.gl/8rOZUX\n    '\\\\ahexec',                                     // Sofacy group malware\n    '\\\\winsession',                                 // Wild Neutron APT malware https://goo.gl/pivRZJ\n    '\\\\lsassw',                                     // Wild Neutron APT malware https://goo.gl/pivRZJ\n    '\\\\46a676ab7f179e511e30dd2dc41bd388',           // Project Sauron https://goo.gl/eFoP4A\n    '\\\\9f81f59bc58452127884ce513865ed20',           // Project Sauron https://goo.gl/eFoP4A\n    '\\\\e710f28d59aa529d6792ca6ff0ca1b34',           // Project Sauron https://goo.gl/eFoP4A\n    '\\\\rpchlp_3',                                   // Project Sauron https://goo.gl/eFoP4A - Technical Analysis Input\n    '\\\\NamePipe_MoreWindows',                       // Cloud Hopper Annex B https://www.pwc.co.uk/cyber-security/pdf/cloud-hopper-annex-b-final.pdf, US-CERT Alert - RedLeaves https://www.us-cert.gov/ncas/alerts/TA17-117A\n    '\\\\pcheap_reuse',                               // Pipe used by Equation Group malware 77486bb828dba77099785feda0ca1d4f33ad0d39b672190079c508b3feb21fb0\n    '\\\\gruntsvc',                                   // Covenant default named pipe\n    '\\\\583da945-62af-10e8-4902-a8f205c72b2e',       // SolarWinds SUNBURST malware report https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html\n    '\\\\bizkaz',                                     // Snatch Ransomware https://thedfirreport.com/2020/06/21/snatch-ransomware/\n    '\\\\atctl',                                      // https://www.virustotal.com/#/file/a4ddb2664a6c87a1d3c5da5a5a32a5df9a0b0c8f2e951811bd1ec1d44d42ccf1/detection\n    '\\\\userpipe',                                   // ruag apt case\n    '\\\\iehelper',                                   // ruag apt case\n    '\\\\sdlrpc',                                     // project cobra https://www.gdatasoftware.com/blog/2015/01/23926-analysis-of-project-cobra\n    '\\\\comnap',                                     // https://www.gdatasoftware.com/blog/2015/01/23926-analysis-of-project-cobra\n    '\\\\lsadump',                                    // Cred Dump-Tools Named Pipes\n    '\\\\cachedump',                                  // Cred Dump-Tools Named Pipes\n    '\\\\wceservicepipe',                             // Cred Dump-Tools Named Pipes\n    '\\\\jaccdpqnvbrrxlaf',                           // PoshC2 default named pipe\n    '\\\\svcctl',                                     // CrackMapExec default named pipe\n    '\\\\csexecsvc'                                   // CSEXEC default named pipe\n    '\\\\status_',                                    // CS default named pipes https://github.com/Neo23x0/sigma/issues/253\n    '\\\\MSSE-',                                      // CobaltStrike default named pipe\n    '\\\\status_',                                    // CobaltStrike default named pipe\n    '\\\\msagent_',                                   // (target) CobaltStrike default named pipe\n    '\\\\postex_ssh_',                                // CobaltStrike default named pipe\n    '\\\\postex_',                                    // CobaltStrike default named pipe\n    '\\\\Posh'                                        // PoshC2 default named pipe\n);\nDeviceEvents\n| where ActionType == \"NamedPipeEvent\" and Timestamp > minTimeRange\n| extend ParsedFields=parse_json(AdditionalFields)\n| where ParsedFields.FileOperation == \"File created\"\n| where ParsedFields.PipeName has_any (badPipeNames)\n| project TimeGenerated, ActionType, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessFolderPath, InitiatingProcessCommandLine, ParsedFields.FileOperation, ParsedFields.PipeName\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Detects the creation of a named pipe used by known APT malware.\nReference - https://docs.microsoft.com/openspecs/windows_protocols/ms-wpo/4de75e21-36fd-440a-859b-75accc74487c"
                  },
                  {
                    "name": "tactics",
                    "value": "CommandAndControl"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject15')._huntingQuerycontentId15),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 15",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject15')._huntingQuerycontentId15)]",
                "contentId": "[variables('huntingQueryObject15')._huntingQuerycontentId15]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject15').huntingQueryVersion15]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject15')._huntingQuerycontentId15]",
        "contentKind": "HuntingQuery",
        "displayName": "C2-NamedPipe",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject15')._huntingQuerycontentId15,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject15')._huntingQuerycontentId15,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject16').huntingQueryTemplateSpecName16]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ReconWithRundll_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject16').huntingQueryVersion16]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_16",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Recon with Rundll",
                "category": "Hunting Queries",
                "query": "DeviceNetworkEvents\n| where InitiatingProcessFileName =~ \"rundll32.exe\"\n// Empty command line\n| where InitiatingProcessCommandLine has \"rundll32.exe\" and InitiatingProcessCommandLine !contains \" \" \nand InitiatingProcessCommandLine != \"\" \n| summarize DestinationIPCount = dcount(RemoteIP), make_set(RemoteIP, 100000), make_set(RemoteUrl, 100000), \nmake_set(RemotePort, 100000) by InitiatingProcessCommandLine, DeviceId, bin(TimeGenerated, 5m)\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query detects suspicious rundll.exe activity associated with Trickbot campaigns."
                  },
                  {
                    "name": "tactics",
                    "value": "Discovery,Collection,CommandAndControl"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject16')._huntingQuerycontentId16),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 16",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject16')._huntingQuerycontentId16)]",
                "contentId": "[variables('huntingQueryObject16')._huntingQuerycontentId16]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject16').huntingQueryVersion16]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject16')._huntingQuerycontentId16]",
        "contentKind": "HuntingQuery",
        "displayName": "Recon with Rundll",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject16')._huntingQuerycontentId16,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject16')._huntingQuerycontentId16,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject17').huntingQueryTemplateSpecName17]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DoppelPaymerProcdump_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject17').huntingQueryVersion17]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_17",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "DopplePaymer Procdump",
                "category": "Hunting Queries",
                "query": "// Dumping of LSASS memory using procdump\nDeviceProcessEvents\n| where TimeGenerated > ago(7d)\n// Command lines that include \"lsass\" and -accepteula or -ma flags used in procdump\n| where (ProcessCommandLine has \"lsass\" and (ProcessCommandLine has \"-accepteula\" or\nProcessCommandLine contains \"-ma\"))\n// Omits possible FPs where the full command is just \"procdump.exe lsass\"\nor (FileName in~ ('procdump.exe','procdump64.exe') and ProcessCommandLine has 'lsass')\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Detects the use of ProcDump to dump credentials from LSASS memory by DoppelPaymer ransomware operators."
                  },
                  {
                    "name": "tactics",
                    "value": "CredentialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject17')._huntingQuerycontentId17),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 17",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject17')._huntingQuerycontentId17)]",
                "contentId": "[variables('huntingQueryObject17')._huntingQuerycontentId17]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject17').huntingQueryVersion17]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject17')._huntingQuerycontentId17]",
        "contentKind": "HuntingQuery",
        "displayName": "DopplePaymer Procdump",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject17')._huntingQuerycontentId17,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject17')._huntingQuerycontentId17,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject18').huntingQueryTemplateSpecName18]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "LaZagne_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject18').huntingQueryVersion18]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_18",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Credential Harvesting Using LaZagne",
                "category": "Hunting Queries",
                "query": "// Find credential theft via SAM database export by LaZagne\nDeviceProcessEvents\n| where TimeGenerated > ago(7d)\n| where FileName =~ 'reg.exe'\n    and ProcessCommandLine has 'save'\n    and ProcessCommandLine has 'hklm'\n    and ProcessCommandLine has 'sam'\n| project DeviceId, TimeGenerated, InitiatingProcessId,\nInitiatingProcessFileName, ProcessId, FileName, ProcessCommandLine\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Detects the use of LaZagne to steal credentials from the SAM database by Ryuk ransomware operators."
                  },
                  {
                    "name": "tactics",
                    "value": "CredentialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject18')._huntingQuerycontentId18),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 18",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject18')._huntingQuerycontentId18)]",
                "contentId": "[variables('huntingQueryObject18')._huntingQuerycontentId18]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject18').huntingQueryVersion18]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject18')._huntingQuerycontentId18]",
        "contentKind": "HuntingQuery",
        "displayName": "Credential Harvesting Using LaZagne",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject18')._huntingQuerycontentId18,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject18')._huntingQuerycontentId18,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject19').huntingQueryTemplateSpecName19]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "LSASSCredDumpProcdump_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject19').huntingQueryVersion19]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_19",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "LSASS Credential Dumping with Procdump",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents \n| where (FileName has_any (\"procdump.exe\", \"procdump64.exe\") and ProcessCommandLine has \"lsass\") or \n// Looking for Accepteula flag or Write a dump file with all process memory\n(ProcessCommandLine has \"lsass.exe\" and (ProcessCommandLine has \"-accepteula\" or ProcessCommandLine contains \"-ma\"))\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Detects the use of Procdump to dump credentials from LSASS memory."
                  },
                  {
                    "name": "tactics",
                    "value": "CredentialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject19')._huntingQuerycontentId19),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 19",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject19')._huntingQuerycontentId19)]",
                "contentId": "[variables('huntingQueryObject19')._huntingQuerycontentId19]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject19').huntingQueryVersion19]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject19')._huntingQuerycontentId19]",
        "contentKind": "HuntingQuery",
        "displayName": "LSASS Credential Dumping with Procdump",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject19')._huntingQuerycontentId19,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject19')._huntingQuerycontentId19,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject20').huntingQueryTemplateSpecName20]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ClearSystemLogs_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject20').huntingQueryVersion20]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_20",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Clear System Logs",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents\n| where TimeGenerated > ago(7d)\n| where FileName =~ \"fsutil.exe\"\nand ProcessCommandLine has \"usn\" and ProcessCommandLine has \"deletejournal\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This hunting query searches for attempts to use fsutil.exe to clear system logs and delete forensic artifacts."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject20')._huntingQuerycontentId20),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 20",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject20')._huntingQuerycontentId20)]",
                "contentId": "[variables('huntingQueryObject20')._huntingQuerycontentId20]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject20').huntingQueryVersion20]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject20')._huntingQuerycontentId20]",
        "contentKind": "HuntingQuery",
        "displayName": "Clear System Logs",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject20')._huntingQuerycontentId20,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject20')._huntingQuerycontentId20,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject21').huntingQueryTemplateSpecName21]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DoppelpaymerStopServices_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject21').huntingQueryVersion21]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_21",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Doppelpaymer Stop Services",
                "category": "Hunting Queries",
                "query": "// Attempts to stop services and allow ransomware execution\nDeviceProcessEvents\n| where TimeGenerated > ago(7d)\n| where InitiatingProcessFileName startswith \"psexe\" and FileName =~ \"powershell.exe\" and\nProcessCommandLine has \"stop-service\"\nand ProcessCommandLine has \"sql\" and ProcessCommandLine has \"msexchange\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for attempts to stop security services, which is a common tactic used by DoppelPaymer ransomware operators."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution,DefenseEvasion"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject21')._huntingQuerycontentId21),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 21",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject21')._huntingQuerycontentId21)]",
                "contentId": "[variables('huntingQueryObject21')._huntingQuerycontentId21]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject21').huntingQueryVersion21]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject21')._huntingQuerycontentId21]",
        "contentKind": "HuntingQuery",
        "displayName": "Doppelpaymer Stop Services",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject21')._huntingQuerycontentId21,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject21')._huntingQuerycontentId21,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject22').huntingQueryTemplateSpecName22]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "QakbotCampaignSelfDeletion_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject22').huntingQueryVersion22]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_22",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Qakbot Campaign Self Deletion",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents \n| where FileName =~ \"ping.exe\"\n| where InitiatingProcessFileName =~ \"cmd.exe\"\n| where (InitiatingProcessCommandLine has \"calc.exe\") and (InitiatingProcessCommandLine has \"-n 6\") and (InitiatingProcessCommandLine has \"127.0.0.1\")\n| project TimeGenerated, ProcessCommandLine, InitiatingProcessCommandLine, InitiatingProcessParentFileName, DeviceId\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query detects if an instance of Qakbot has attempted to overwrite its original binary."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject22')._huntingQuerycontentId22),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 22",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject22')._huntingQuerycontentId22)]",
                "contentId": "[variables('huntingQueryObject22')._huntingQuerycontentId22]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject22').huntingQueryVersion22]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject22')._huntingQuerycontentId22]",
        "contentKind": "HuntingQuery",
        "displayName": "Qakbot Campaign Self Deletion",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject22')._huntingQuerycontentId22,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject22')._huntingQuerycontentId22,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject23').huntingQueryTemplateSpecName23]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Regsvr32Rundll32ImageLoadsAbnormalExtension_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject23').huntingQueryVersion23]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_23",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Regsvr32 Rundll32 Image Loads Abnormal Extension",
                "category": "Hunting Queries",
                "query": "DeviceImageLoadEvents \n| where TimeGenerated > ago(1d)\n| where InitiatingProcessFileName has_any (\"rundll32.exe\",\"regsvr32.exe\")\n| where FileName !endswith \".dll\"\n| join (\nDeviceNetworkEvents\n| where TimeGenerated > ago(30d)\n| where InitiatingProcessFileName has_any (\"rundll32.exe\",\"regsvr32.exe\")\n| where RemoteIPType == \"Public\"\n) on InitiatingProcessFileName, InitiatingProcessId, InitiatingProcessCreationTime, InitiatingProcessCommandLine\n| project TimeGenerated, DeviceName, FileName, FolderPath, SHA1, InitiatingProcessFileName, InitiatingProcessCommandLine, RemoteIP, RemoteUrl, RemotePort, InitiatingProcessParentFileName\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query is looking for regsvr32.exe or rundll32.exe loading DLL images with other extensions than .dll."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1218.010,T1218.011"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject23')._huntingQuerycontentId23),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 23",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject23')._huntingQuerycontentId23)]",
                "contentId": "[variables('huntingQueryObject23')._huntingQuerycontentId23]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject23').huntingQueryVersion23]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject23')._huntingQuerycontentId23]",
        "contentKind": "HuntingQuery",
        "displayName": "Regsvr32 Rundll32 Image Loads Abnormal Extension",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject23')._huntingQuerycontentId23,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject23')._huntingQuerycontentId23,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject24').huntingQueryTemplateSpecName24]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Regsvr32Rundll32WithAnomalousParentProcess_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject24').huntingQueryVersion24]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_24",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Regsvr32 Rundll32 with Anomalous Parent Process",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents\n| where TimeGenerated > ago(30d)\n| where FileName has_any (\"rundll32.exe\",\"regsvr32.exe\")\n| where InitiatingProcessFileName has_any (\"wscript.exe\",\"powershell.exe\",\"cmd.exe\",\"pwsh.exe\",\"cscript.exe\")\n| project TimeGenerated,DeviceName, InvestigatedProcessName=FileName, InvestigatedProcessCommandLine = ProcessCommandLine,InvestigatedProcessStartTime = ProcessCreationTime, InvestigatedProcessId = ProcessId, InitiatingProcessFileName, InitiatingProcessCommandLine, InitiatingProcessParentFileName\n| join (\nDeviceNetworkEvents\n| where TimeGenerated > ago(30d)\n| where InitiatingProcessFileName has_any (\"rundll32.exe\",\"regsvr32.exe\")\n| where RemoteIPType == \"Public\"\n| project DeviceName, InvestigatedProcessName=InitiatingProcessFileName, InvestigatedProcessCommandLine = InitiatingProcessCommandLine,InvestigatedProcessStartTime = InitiatingProcessCreationTime, InvestigatedProcessId = InitiatingProcessId, RemoteIP, RemoteUrl\n) on DeviceName, InvestigatedProcessCommandLine, InvestigatedProcessId, InvestigatedProcessName, InvestigatedProcessStartTime\n| project-away DeviceName1, InvestigatedProcessCommandLine1, InvestigatedProcessId1, InvestigatedProcessName1, InvestigatedProcessStartTime1\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for rundll32.exe or regsvr32.exe being spawned by abnormal processes such as wscript.exe, powershell.exe, cmd.exe, pwsh.exe, cscript.exe."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1218.010,T1218.011"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject24')._huntingQuerycontentId24),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 24",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject24')._huntingQuerycontentId24)]",
                "contentId": "[variables('huntingQueryObject24')._huntingQuerycontentId24]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject24').huntingQueryVersion24]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject24')._huntingQuerycontentId24]",
        "contentKind": "HuntingQuery",
        "displayName": "Regsvr32 Rundll32 with Anomalous Parent Process",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject24')._huntingQuerycontentId24,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject24')._huntingQuerycontentId24,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject25').huntingQueryTemplateSpecName25]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Delivered Bad Emails from Top bad IPv4 addresses_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject25').huntingQueryVersion25]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_25",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Determine Successfully Delivered Phishing Emails by top IP Addresses",
                "category": "Hunting Queries",
                "query": "// Adjust the cutoff as needed \nlet cutoff = 5;\nEmailEvents\n| where ThreatTypes has \"Malware\" or ThreatTypes has \"Phish\" \n| summarize count() by SenderIPv4 \n| where count_ > cutoff\n| join kind=inner EmailEvents on SenderIPv4  \n| where DeliveryAction =~ \"Delivered\"\n| extend Name = tostring(split(SenderFromAddress, '@', 0)[0]), UPNSuffix = tostring(split(SenderFromAddress, '@', 1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = SenderIPv4\n| extend MailBox_0_MailboxPrimaryAddress = RecipientEmailAddress\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query identifies phishing emails sent that were successfully delivered, by top IP addressess. cutoff default value is 5, adjust the value as needed."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject25')._huntingQuerycontentId25),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 25",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject25')._huntingQuerycontentId25)]",
                "contentId": "[variables('huntingQueryObject25')._huntingQuerycontentId25]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject25').huntingQueryVersion25]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject25')._huntingQuerycontentId25]",
        "contentKind": "HuntingQuery",
        "displayName": "Determine Successfully Delivered Phishing Emails by top IP Addresses",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject25')._huntingQuerycontentId25,'-', '1.0.1')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject25')._huntingQuerycontentId25,'-', '1.0.1')))]",
        "version": "1.0.1"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject26').huntingQueryTemplateSpecName26]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SuspiciousCommandInitiatedByWebServerProcess_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject26').huntingQueryVersion26]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_26",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Detect Suspicious Commands Initiated by Webserver Processes",
                "category": "Hunting Queries",
                "query": "// Suspicious commands launched by web server processes\nDeviceProcessEvents \n| where TimeGenerated > ago(7d)\n// Pivoting on parents or grand parents\nand (((InitiatingProcessParentFileName in(\"w3wp.exe\", \"beasvc.exe\",\n\"httpd.exe\") or InitiatingProcessParentFileName startswith \"tomcat\")\nor InitiatingProcessFileName in(\"w3wp.exe\", \"beasvc.exe\", \"httpd.exe\") or\nInitiatingProcessFileName startswith \"tomcat\"))\n    and FileName in~('cmd.exe','powershell.exe')\n| where ProcessCommandLine contains '%temp%'\n    or ProcessCommandLine has 'wget'\n    or ProcessCommandLine has 'whoami'\n    or ProcessCommandLine has 'certutil'\n    or ProcessCommandLine has 'systeminfo'\n    or ProcessCommandLine has 'ping'\n    or ProcessCommandLine has 'ipconfig'\n    or ProcessCommandLine has 'timeout'\n| summarize take_any(TimeGenerated), take_any(TimeGenerated), take_any(FileName),\nmake_set(ProcessCommandLine, 100000), take_any(InitiatingProcessFileName),\ntake_any(InitiatingProcessParentFileName) by DeviceId\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Detect suspicious commands initiated by web server processes used for network discovery and user/owner discovery."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution,DefenseEvasion,Discovery"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject26')._huntingQuerycontentId26),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 26",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject26')._huntingQuerycontentId26)]",
                "contentId": "[variables('huntingQueryObject26')._huntingQuerycontentId26]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject26').huntingQueryVersion26]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject26')._huntingQuerycontentId26]",
        "contentKind": "HuntingQuery",
        "displayName": "Detect Suspicious Commands Initiated by Webserver Processes",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject26')._huntingQuerycontentId26,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject26')._huntingQuerycontentId26,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject27').huntingQueryTemplateSpecName27]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User&GroupEnumWithNetCommand_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject27').huntingQueryVersion27]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_27",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Enumeration of Users & Groups for Lateral Movement",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents \n| where TimeGenerated > ago(7d) \n| where FileName == 'net.exe' and AccountName != \"\" and ProcessCommandLine !contains '\\\\'  and ProcessCommandLine !contains '/add' \n| where (ProcessCommandLine contains ' user ' or ProcessCommandLine contains ' group ') and (ProcessCommandLine contains ' /do' or ProcessCommandLine contains ' /domain') \n| extend Target = extract(\"(?i)[user|group] (\\\"*[a-zA-Z0-9-_ ]+\\\"*)\", 1, ProcessCommandLine) | filter Target  != '' \n| project AccountName, Target, ProcessCommandLine, DeviceName, TimeGenerated  \n| sort by AccountName, Target\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query hunts for attempts to list users or groups using Net commands, which are commonly used for lateral movement."
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject27')._huntingQuerycontentId27),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 27",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject27')._huntingQuerycontentId27)]",
                "contentId": "[variables('huntingQueryObject27')._huntingQuerycontentId27]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject27').huntingQueryVersion27]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject27')._huntingQuerycontentId27]",
        "contentKind": "HuntingQuery",
        "displayName": "Enumeration of Users & Groups for Lateral Movement",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject27')._huntingQuerycontentId27,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject27')._huntingQuerycontentId27,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject28').huntingQueryTemplateSpecName28]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ATP policy status check_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject28').huntingQueryVersion28]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_28",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ATP policy status check",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where Application == \"Microsoft Exchange Online\"\n| where ActionType == \"Set-AtpPolicyForO365\"\n| mv-expand ActivityObjects\n| extend Name = tostring(ActivityObjects.Name)\n| extend Value = tostring(ActivityObjects.Value)\n| where Name in (\"EnableATPForSPOTeamsODB\", \"EnableSafeDocs\", \"AllowSafeDocsOpen\")\n| extend packed = pack(Name, Value)\n| summarize PackedInfo = make_bag(packed), ActionType = any(ActionType) by Timestamp, AccountDisplayName\n| evaluate bag_unpack(PackedInfo)\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query displays the configuration auditing for 'Safe Attachments for SharePoint, OneDrive, and Microsoft Teams' and 'Safe Documents' in Microsoft Defender for Office 365."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject28')._huntingQuerycontentId28),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 28",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject28')._huntingQuerycontentId28)]",
                "contentId": "[variables('huntingQueryObject28')._huntingQuerycontentId28]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject28').huntingQueryVersion28]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject28')._huntingQuerycontentId28]",
        "contentKind": "HuntingQuery",
        "displayName": "ATP policy status check",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject28')._huntingQuerycontentId28,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject28')._huntingQuerycontentId28,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject29').huntingQueryTemplateSpecName29]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "JNLP attachment_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject29').huntingQueryVersion29]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_29",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "JNLP-File-Attachment",
                "category": "Hunting Queries",
                "query": "EmailAttachmentInfo\n| where FileName endswith \".jnlp\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "JNLP file extensions are an uncommon file type often used to deliver malware."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject29')._huntingQuerycontentId29),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 29",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject29')._huntingQuerycontentId29)]",
                "contentId": "[variables('huntingQueryObject29')._huntingQuerycontentId29]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject29').huntingQueryVersion29]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject29')._huntingQuerycontentId29]",
        "contentKind": "HuntingQuery",
        "displayName": "JNLP-File-Attachment",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject29')._huntingQuerycontentId29,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject29')._huntingQuerycontentId29,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject30').huntingQueryTemplateSpecName30]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Safe attachment detection_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject30').huntingQueryVersion30]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_30",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Safe Attachments detections",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where DetectionMethods != \"\" \n| extend detection= tostring(parse_json(DetectionMethods).Phish) \n| where detection has \"File detonation reputation\" or detection has \"File detonation\"\n| summarize total=count() by bin(Timestamp, 1d) \n| order by Timestamp asc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query provides insights on the detections done by Safe Attachment detections"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject30')._huntingQuerycontentId30),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 30",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject30')._huntingQuerycontentId30)]",
                "contentId": "[variables('huntingQueryObject30')._huntingQuerycontentId30]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject30').huntingQueryVersion30]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject30')._huntingQuerycontentId30]",
        "contentKind": "HuntingQuery",
        "displayName": "Safe Attachments detections",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject30')._huntingQuerycontentId30,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject30')._huntingQuerycontentId30,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject31').huntingQueryTemplateSpecName31]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Authentication failures_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject31').huntingQueryVersion31]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_31",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Authentication failures by time and authentication type",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where Timestamp > ago (30d)\n| project Timestamp, AR=parse_json(AuthenticationDetails), NetworkMessageId, EmailDirection, SenderFromAddress, ThreatTypes, DetectionMethods\n| evaluate bag_unpack(AR)\n| where DMARC == \"fail\"\n| summarize count() by bin(Timestamp, 1d)\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing authentication failure count by authentication type. Update the authentication type below as DMARC, DKIM, SPM, CompAuth"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject31')._huntingQuerycontentId31),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 31",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject31')._huntingQuerycontentId31)]",
                "contentId": "[variables('huntingQueryObject31')._huntingQuerycontentId31]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject31').huntingQueryVersion31]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject31')._huntingQuerycontentId31]",
        "contentKind": "HuntingQuery",
        "displayName": "Authentication failures by time and authentication type",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject31')._huntingQuerycontentId31,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject31')._huntingQuerycontentId31,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject32').huntingQueryTemplateSpecName32]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CompAuth Failure Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject32').huntingQueryVersion32]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_32",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "CompAuth Failure Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nEmailEvents\n| extend CompAuthFail = AuthenticationDetails has_any ('CompAuth\":\"fail') \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Spoof - Composite Authentication fails summarizing the data daily."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject32')._huntingQuerycontentId32),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 32",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject32')._huntingQuerycontentId32)]",
                "contentId": "[variables('huntingQueryObject32')._huntingQuerycontentId32]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject32').huntingQueryVersion32]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject32')._huntingQuerycontentId32]",
        "contentKind": "HuntingQuery",
        "displayName": "CompAuth Failure Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject32')._huntingQuerycontentId32,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject32')._huntingQuerycontentId32,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject33').huntingQueryTemplateSpecName33]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DKIM Failure Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject33').huntingQueryVersion33]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_33",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "DKIM Failure Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nEmailEvents\n| extend DMARCFail = AuthenticationDetails has_any ('DKIM\":\"fail') \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Spoof - DKIM fails summarizing the data daily."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject33')._huntingQuerycontentId33),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 33",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject33')._huntingQuerycontentId33)]",
                "contentId": "[variables('huntingQueryObject33')._huntingQuerycontentId33]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject33').huntingQueryVersion33]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject33')._huntingQuerycontentId33]",
        "contentKind": "HuntingQuery",
        "displayName": "DKIM Failure Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject33')._huntingQuerycontentId33,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject33')._huntingQuerycontentId33,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject34').huntingQueryTemplateSpecName34]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DMARC Failure Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject34').huntingQueryVersion34]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_34",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "DMARC Failure Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nEmailEvents\n| extend DMARCFail = AuthenticationDetails has_any ('DMARC\":\"fail') \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Spoof - DMARC fails summarizing the data daily."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject34')._huntingQuerycontentId34),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 34",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject34')._huntingQuerycontentId34)]",
                "contentId": "[variables('huntingQueryObject34')._huntingQuerycontentId34]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject34').huntingQueryVersion34]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject34')._huntingQuerycontentId34]",
        "contentKind": "HuntingQuery",
        "displayName": "DMARC Failure Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject34')._huntingQuerycontentId34,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject34')._huntingQuerycontentId34,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject35').huntingQueryTemplateSpecName35]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SPF Failure Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject35').huntingQueryVersion35]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_35",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "SPF Failure Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nEmailEvents\n| extend DMARCFail = AuthenticationDetails has_any ('SPF\":\"fail') \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Spoof - SPF fails summarizing the data daily."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject35')._huntingQuerycontentId35),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 35",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject35')._huntingQuerycontentId35)]",
                "contentId": "[variables('huntingQueryObject35')._huntingQuerycontentId35]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject35').huntingQueryVersion35]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject35')._huntingQuerycontentId35]",
        "contentKind": "HuntingQuery",
        "displayName": "SPF Failure Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject35')._huntingQuerycontentId35,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject35')._huntingQuerycontentId35,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject36').huntingQueryTemplateSpecName36]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spoof attempts with auth failure_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject36').huntingQueryVersion36]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_36",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spoof attempts with auth failure",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where Timestamp > ago (1d) and DetectionMethods contains \"spoof\"  \n| project Timestamp, AR=parse_json(AuthenticationDetails) , NetworkMessageId, EmailDirection, Subject, SenderFromAddress, SenderIPv4,ThreatTypes, DetectionMethods, ThreatNames  \n| evaluate bag_unpack(AR)  \n| where SPF == \"fail\" or DMARC == \"fail\" or DKIM == \"fail\" or CompAuth == \"fail\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps in checking for spoofing attempts on the domain with Authentication failures"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject36')._huntingQuerycontentId36),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 36",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject36')._huntingQuerycontentId36)]",
                "contentId": "[variables('huntingQueryObject36')._huntingQuerycontentId36]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject36').huntingQueryVersion36]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject36')._huntingQuerycontentId36]",
        "contentKind": "HuntingQuery",
        "displayName": "Spoof attempts with auth failure",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject36')._huntingQuerycontentId36,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject36')._huntingQuerycontentId36,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject37').huntingQueryTemplateSpecName37]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top Spoof detections by Sender Domain_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject37').huntingQueryVersion37]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_37",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top Spoof external domain detections by Sender domain (P1/P2)",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Inbound\"\n| summarize TotalEmailCount = count(),\nSpoofExternalCount = countif(DetectionMethods has_any ('Phish\":[\"Spoof external domain\"]')) by P1Sender=SenderMailFromDomain, P2Sender=SenderFromDomain\n| extend SpoofExternal_Traffic_Percentage = todouble(round(SpoofExternalCount / todouble(TotalEmailCount) * 100, 2))\n| where SpoofExternalCount !=0\n| sort by SpoofExternalCount desc \n| project P1Sender,P2Sender,SpoofExternalCount,TotalEmailCount,SpoofExternal_Traffic_Percentage\n| top 10 by SpoofExternalCount\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Phish-Spoof-external domain detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain) and sender P1 domain (SenderMailFromDomain)."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject37')._huntingQuerycontentId37),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 37",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject37')._huntingQuerycontentId37)]",
                "contentId": "[variables('huntingQueryObject37')._huntingQuerycontentId37]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject37').huntingQueryVersion37]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject37')._huntingQuerycontentId37]",
        "contentKind": "HuntingQuery",
        "displayName": "Top Spoof external domain detections by Sender domain (P1/P2)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject37')._huntingQuerycontentId37,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject37')._huntingQuerycontentId37,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject38').huntingQueryTemplateSpecName38]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top Spoof DMARC detections by Sender Domain_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject38').huntingQueryVersion38]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_38",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top Spoof DMARC detections by Sender domain (P1/P2)",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Inbound\"\n| summarize TotalEmailCount = count(),\nDMARCFailCount = countif(DetectionMethods has_any ('Phish\":[\"Spoof DMARC\"]')) by P1Sender=SenderMailFromDomain, P2Sender=SenderFromDomain\n| extend DMARCFail_Traffic_Percentage = todouble(round(DMARCFailCount / todouble(TotalEmailCount) * 100, 2))\n| where DMARCFailCount !=0\n| sort by DMARCFailCount desc \n| project P1Sender,P2Sender,DMARCFailCount,TotalEmailCount,DMARCFail_Traffic_Percentage\n| top 10 by DMARCFailCount\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Spoof-DMARC fails detections summarizing the data by the top email sender P2 domain (SenderFromDomain) and sender P1 domain (SenderMailFromDomain)."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject38')._huntingQuerycontentId38),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 38",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject38')._huntingQuerycontentId38)]",
                "contentId": "[variables('huntingQueryObject38')._huntingQuerycontentId38]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject38').huntingQueryVersion38]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject38')._huntingQuerycontentId38]",
        "contentKind": "HuntingQuery",
        "displayName": "Top Spoof DMARC detections by Sender domain (P1/P2)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject38')._huntingQuerycontentId38,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject38')._huntingQuerycontentId38,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject39').huntingQueryTemplateSpecName39]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top Spoof Intra-Org detections by SenderDomain_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject39').huntingQueryVersion39]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_39",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top Spoof intra-org detections by Sender domain (P1/P2)",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Inbound\"\n| summarize TotalEmailCount = count(),\nSpoofInternalCount = countif(DetectionMethods has_any ('Phish\":[\"Spoof intra-org\"]')) by P1Sender=SenderMailFromDomain, P2Sender=SenderFromDomain\n| extend SpoofInternal_Traffic_Percentage = todouble(round(SpoofInternalCount / todouble(TotalEmailCount) * 100, 2))\n| where SpoofInternalCount !=0\n| sort by SpoofInternalCount desc \n| project P1Sender,P2Sender,SpoofInternalCount,TotalEmailCount,SpoofInternal_Traffic_Percentage\n| top 10 by SpoofInternalCount\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Phish-Spoof-internal domain detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain) and sender P1 domain (SenderMailFromDomain)."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject39')._huntingQuerycontentId39),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 39",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject39')._huntingQuerycontentId39)]",
                "contentId": "[variables('huntingQueryObject39')._huntingQuerycontentId39]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject39').huntingQueryVersion39]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject39')._huntingQuerycontentId39]",
        "contentKind": "HuntingQuery",
        "displayName": "Top Spoof intra-org detections by Sender domain (P1/P2)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject39')._huntingQuerycontentId39,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject39')._huntingQuerycontentId39,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject40').huntingQueryTemplateSpecName40]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Message from Accepted Domain with DMARC TempError_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject40').huntingQueryVersion40]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_40",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Message from an Accepted Domain with DMARC TempError",
                "category": "Hunting Queries",
                "query": "let SenderDomains = pack_array ('contoso.com','fabrikam.fr');\nEmailEvents\n| where EmailDirection == 'Inbound' and SenderMailFromDomain in (SenderDomains)\n| extend SPF= tostring(parse_json(AuthenticationDetails).SPF)\n| extend DMARC= tostring(parse_json(AuthenticationDetails).DMARC)\n| where DMARC == \"temperror\" or SPF == \"temperror\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query can be used as a Custom Detection Rule (CDR) to trigger when a potentially malicious email appearing to come from an Accepted Domain but DMARC had a (transient) TempError result."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject40')._huntingQuerycontentId40),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 40",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject40')._huntingQuerycontentId40)]",
                "contentId": "[variables('huntingQueryObject40')._huntingQuerycontentId40]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject40').huntingQueryVersion40]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject40')._huntingQuerycontentId40]",
        "contentKind": "HuntingQuery",
        "displayName": "Message from an Accepted Domain with DMARC TempError",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject40')._huntingQuerycontentId40,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject40')._huntingQuerycontentId40,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject41').huntingQueryTemplateSpecName41]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Message with URL listed on OpenPhish delivered into Inbox_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject41').huntingQueryVersion41]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_41",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Message with URL listed on OpenPhish delivered into Inbox",
                "category": "Hunting Queries",
                "query": "let PhishingURLs = externaldata(url: string)\n[\n    \"https://raw.githubusercontent.com/openphish/public_feed/refs/heads/main/feed.txt\"\n]\nwith (format=\"txt\"); // CSV and JSON formats are also valid formats if using the premium feeds\nEmailUrlInfo\n| where Url in (PhishingURLs)\n| join EmailEvents on NetworkMessageId\n| where LatestDeliveryAction == \"Delivered\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query can be used as a Custom Detection Rule (CDR) to trigger when a potentially malicious email with a URL from OpenPhish was delivered to Inbox"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject41')._huntingQuerycontentId41),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 41",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject41')._huntingQuerycontentId41)]",
                "contentId": "[variables('huntingQueryObject41')._huntingQuerycontentId41]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject41').huntingQueryVersion41]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject41')._huntingQuerycontentId41]",
        "contentKind": "HuntingQuery",
        "displayName": "Message with URL listed on OpenPhish delivered into Inbox",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject41')._huntingQuerycontentId41,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject41')._huntingQuerycontentId41,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject42').huntingQueryTemplateSpecName42]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Potential OAuth phishing email delivered into Inbox_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject42').huntingQueryVersion42]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_42",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Potential OAuth phishing email delivered into Inbox",
                "category": "Hunting Queries",
                "query": "let ConsentUrls = pack_array(\"://login.microsoftonline.com/common/oauth2\", \"://login.microsoftonline.com/consumers/oauth2\", \"://login.microsoftonline.com/organizations/oauth2\", \"://login.microsoftonline.us/common/oauth2\", \"://login.microsoftonline.us/consumers/oauth2\", \"://login.microsoftonline.us/organizations/oauth2\");\nEmailUrlInfo\n| where Url has_any (ConsentUrls)\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\" and LatestDeliveryAction == \"Delivered\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query can be used as a Custom Detection Rule (CDR) to trigger when a potentially malicious OAuth app URL has been delivered into an Inbox."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject42')._huntingQuerycontentId42),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 42",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject42')._huntingQuerycontentId42)]",
                "contentId": "[variables('huntingQueryObject42')._huntingQuerycontentId42]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject42').huntingQueryVersion42]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject42')._huntingQuerycontentId42]",
        "contentKind": "HuntingQuery",
        "displayName": "Potential OAuth phishing email delivered into Inbox",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject42')._huntingQuerycontentId42,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject42')._huntingQuerycontentId42,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject43').huntingQueryTemplateSpecName43]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Potentially malicious SVG file delivered into Inbox_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject43').huntingQueryVersion43]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_43",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Potentially malicious svg file delivered to Inbox",
                "category": "Hunting Queries",
                "query": "let SuspiciousDisplayNames = pack_array(\"Help Desk\", \"Help Desk Team\", \"Help Desk IT\", \"Microsoft Security\", \"IT Support\", \"Helpdesk\");\nEmailAttachmentInfo\n| where FileName contains \".svg\" and FileType == \"html\" // SVG files which render as only an image will display FileType as Text, unless containing Javascript which displays FileType as Html\n| join EmailEvents on NetworkMessageId\n// | where SenderDisplayName has_any (SuspiciousDisplayNames) // Optionally remove comment to also evaluate and filter based on email display name\n| where LatestDeliveryLocation == \"Inbox/folder\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query can be used as a Custom Detection Rule (CDR) to trigger when a potentially malicious .SVG file has been delivered into an Inbox."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject43')._huntingQuerycontentId43),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 43",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject43')._huntingQuerycontentId43)]",
                "contentId": "[variables('huntingQueryObject43')._huntingQuerycontentId43]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject43').huntingQueryVersion43]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject43')._huntingQuerycontentId43]",
        "contentKind": "HuntingQuery",
        "displayName": "Potentially malicious svg file delivered to Inbox",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject43')._huntingQuerycontentId43,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject43')._huntingQuerycontentId43,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject44').huntingQueryTemplateSpecName44]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Audit Email Preview-Download action_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject44').huntingQueryVersion44]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_44",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Audit Email Preview-Download action",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| project Timestamp, ActionType, AccountDisplayName, AR=parse_json(RawEventData) \n| evaluate bag_unpack(AR)\n| where RecordType == \"38\" and ExtendedProperties contains \"DownloadEMail\" or ExtendedProperties contains \"GetMailPreviewUrl\"\n| serialize \n| extend RowNumber = row_number()\n| mv-expand ExtendedProperties\n| evaluate bag_unpack(ExtendedProperties, 'xp_')\n| extend DownloadEMail = iff(tostring(xp_Name) == 'DownloadEMail', xp_Value, ''), GetMailPreviewUrl = iff(tostring(xp_Name) == 'GetMailPreviewUrl', xp_Value, ''), MailboxId = iff(tostring(xp_Name) == 'MailboxId', xp_Value, ''), InternetMessageId = iff(tostring(xp_Name) == 'InternetMessageId', xp_Value, '')\n| summarize Timestamp = any(Timestamp), ActionType = any(ActionType), AccountDisplayName = any(AccountDisplayName),  DownloadEmail = make_set_if(DownloadEMail, isnotempty( DownloadEMail)), GetMailPreviewUrl = make_set_if(GetMailPreviewUrl, isnotempty( GetMailPreviewUrl)), MailboxId = make_set_if(MailboxId, isnotempty( MailboxId)), InternetMessageId = make_set_if(InternetMessageId, isnotempty( InternetMessageId)) by RowNumber\n| extend DownloadEmail = tobool(DownloadEmail[0]), GetMailPreviewUrl = tobool(GetMailPreviewUrl[0]), MailboxId = tostring(MailboxId[0]), InternetMessageId = tostring(InternetMessageId[0])\n| project-away RowNumber\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps report on who Previewed/Downloaded email messages using the Email entity page in Defender for Office 365"
                  },
                  {
                    "name": "tactics",
                    "value": "PrivilegeEscalation"
                  },
                  {
                    "name": "techniques",
                    "value": "T1078"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject44')._huntingQuerycontentId44),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 44",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject44')._huntingQuerycontentId44)]",
                "contentId": "[variables('huntingQueryObject44')._huntingQuerycontentId44]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject44').huntingQueryVersion44]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject44')._huntingQuerycontentId44]",
        "contentKind": "HuntingQuery",
        "displayName": "Audit Email Preview-Download action",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject44')._huntingQuerycontentId44,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject44')._huntingQuerycontentId44,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject45').huntingQueryTemplateSpecName45]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Bad email percentage - Inbound emails_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject45').huntingQueryVersion45]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_45",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Bad email percentage of Inbound emails",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Inbound\"\n| summarize TotalEmailCount = count(),\nBadEmailCount = countif(isnotempty(ThreatTypes)) by bin(Timestamp, 1d)\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(BadEmailCount / todouble(TotalEmailCount) * 100, 2))\n| project Timestamp,Bad_Traffic_Percentage_Inbound\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises bad traffic (% of emails with threats) compared to total inbound emails over time summarising the data daily."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject45')._huntingQuerycontentId45),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 45",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject45')._huntingQuerycontentId45)]",
                "contentId": "[variables('huntingQueryObject45')._huntingQuerycontentId45]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject45').huntingQueryVersion45]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject45')._huntingQuerycontentId45]",
        "contentKind": "HuntingQuery",
        "displayName": "Bad email percentage of Inbound emails",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject45')._huntingQuerycontentId45,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject45')._huntingQuerycontentId45,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject46').huntingQueryTemplateSpecName46]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Calculate MDO Efficacy_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject46').huntingQueryVersion46]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_46",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Calculate overall MDO efficacy",
                "category": "Hunting Queries",
                "query": "let _startTime = ago(30d); \nlet _endTime = now(); \n// Get all mailflow detected as clean at time of delivery \nlet EmailEventsClean = materialize( \n    EmailEvents \n    | where Timestamp between (_startTime .. _endTime) and EmailDirection == \"Inbound\" \n    | where ThreatTypes !contains \"Phish\" and ThreatTypes !contains \"Malware\" \n    | project NetworkMessageId,ThreatTypes \n); \n// Get all mailflow detected as phish or malware at time of delivery \nlet EmailEventsThreats = materialize( \n    EmailEvents \n    | where Timestamp between (_startTime .. _endTime) and EmailDirection == \"Inbound\" \n    | where ThreatTypes contains \"Phish\" or ThreatTypes contains \"Malware\" \n    | extend MDO_detection = parse_json(DetectionMethods) \n    | extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0])) \n    | extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\") \n    | project NetworkMessageId,FirstDetection,FirstSubcategory,MDO_detection,ThreatTypes \n); \n// Get all post delivery ZAP / Redelivery events, and arg_max them to ensure we have the latest verdict to work with for each\nlet EmailPostDeliveryFiltered = materialize( \n    EmailPostDeliveryEvents \n    | where Timestamp between (_startTime .. datetime_add('day', 7, _endTime)) \n    | where ActionType in (\"Malware ZAP\",\"Phish ZAP\",\"Redelivery\") \n    | extend Key = strcat(NetworkMessageId , \"-\", RecipientEmailAddress) \n    | summarize arg_max(Timestamp, *) by Key \n    | project Action,ActionType,ActionResult,ThreatTypes,NetworkMessageId \n); \n// Optional - Get all admin submissions for malware or phish, so we can also count these in the miss bucket. \nlet CloudAppEventsFiltered = materialize( \n    CloudAppEvents \n    | where Timestamp between (_startTime .. datetime_add('day', 7, _endTime)) \n    | where ActionType == \"AdminSubmissionSubmitted\" \n    | extend SubmissionType = tostring(parse_json(RawEventData).SubmissionType) \n    | extend NetworkMessageId = tostring(parse_json(RawEventData).ObjectId) \n    | where SubmissionType in (\"1\", \"2\") \n    | project SubmissionType,NetworkMessageId \n); \n// Get the number of threats caught in mailflow \nlet Mal_Phish_Mailflow = toscalar( \n    EmailEventsThreats \n    | summarize count() \n); \n// Get the number of threats caught in mailflow which turned out to be false positives (FPs) so we can correct the calculation \nlet FP_ZAP = toscalar( \n    EmailPostDeliveryFiltered \n    | where ThreatTypes !contains \"Phish\" and ThreatTypes !contains \"Malware\" and ActionType == \"Redelivery\" \n    | join kind=leftsemi (EmailEventsThreats) on NetworkMessageId \n    | summarize count() \n); \n// Get the number of threats successfully cleaned up post delivery, ignoring where administrative policy stopped action \nlet FN_ZAP_Successful = toscalar( \n    EmailPostDeliveryFiltered \n    | where ActionType in (\"Malware ZAP\",\"Phish ZAP\") and ActionResult in (\"Success\",\"AdminPolicy\") \n    | join kind=leftsemi (EmailEventsClean) on NetworkMessageId \n    | summarize count() \n); \n// Get the number of threats unsuccessfully cleaned up post delivery. \nlet FN_ZAP_Unsuccessful = toscalar( \n    EmailPostDeliveryFiltered \n    | where ActionType in (\"Malware ZAP\",\"Phish ZAP\") and ActionResult !in (\"Success\",\"AdminPolicy\") \n    | join kind=leftsemi (EmailEventsClean) on NetworkMessageId \n    | summarize count() \n); \n// Join the admin submissions to clean mailflow to find the additional miss \nlet FN_Admin_Submissions = toscalar( \n    CloudAppEventsFiltered \n    | join kind=rightsemi (EmailEventsClean) on NetworkMessageId \n    | summarize count() \n    ); \n// Print each result, and run the formula to calculate effectiveness at time of delivery and post delivery. \nunion withsource=Table \n    (print StatisticName=\"Mal/Phish Mailflow totals - Minus FPs\", Value=toreal(Mal_Phish_Mailflow) - toreal(FP_ZAP)), \n    (print StatisticName=\"Admin Mal/Phish FNs Submitted\", Value=toreal(FN_Admin_Submissions)), \n    (print StatisticName=\"Mal/Phish FPs Reverse Zapped\", Value=toreal(FP_ZAP)), \n    (print StatisticName=\"Mal/Phish Successfully Zapped\", Value=toreal(FN_ZAP_Successful)), \n    (print StatisticName=\"Mal/Phish UN-Successfully Zapped\", Value=toreal(FN_ZAP_Unsuccessful)), \n    (print StatisticName=\"Effectiveness Post Delivery\", Value=abs(round(((toreal(FN_Admin_Submissions)+toreal(FN_ZAP_Unsuccessful))/(toreal(Mal_Phish_Mailflow)+toreal(FN_ZAP_Successful)+toreal(FN_ZAP_Unsuccessful)+toreal(FN_Admin_Submissions)-toreal(FP_ZAP))*100-100),2))), \n    (print StatisticName=\"Effectiveness Pre-Delivery\", Value=abs(round(((toreal(FN_Admin_Submissions)+toreal(FN_ZAP_Unsuccessful)+toreal(FN_ZAP_Successful))/(toreal(Mal_Phish_Mailflow)+toreal(FN_ZAP_Successful)+toreal(FN_ZAP_Unsuccessful)+toreal(FN_Admin_Submissions)-toreal(FP_ZAP))*100-100),2)))\n| project StatisticName, Value\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps calculate overall efficacy of MDO based on threats blocked pre-delivery, post-delivery cleanups, or were uncaught."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject46')._huntingQuerycontentId46),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 46",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject46')._huntingQuerycontentId46)]",
                "contentId": "[variables('huntingQueryObject46')._huntingQuerycontentId46]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject46').huntingQueryVersion46]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject46')._huntingQuerycontentId46]",
        "contentKind": "HuntingQuery",
        "displayName": "Calculate overall MDO efficacy",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject46')._huntingQuerycontentId46,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject46')._huntingQuerycontentId46,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject47').huntingQueryTemplateSpecName47]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Email sender IP address Geo location information_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject47').huntingQueryVersion47]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_47",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Email sender IP address Geo location information",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where geo_info_from_ip_address(SenderIPv4) != \"\"\n| extend GeoIPInfo = geo_info_from_ip_address(SenderIPv4)\n| extend country = tostring(parse_json(GeoIPInfo).country)\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps getting GeoIP information of emails SenderIPv4 addresses."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject47')._huntingQuerycontentId47),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 47",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject47')._huntingQuerycontentId47)]",
                "contentId": "[variables('huntingQueryObject47')._huntingQuerycontentId47]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject47').huntingQueryVersion47]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject47')._huntingQuerycontentId47]",
        "contentKind": "HuntingQuery",
        "displayName": "Email sender IP address Geo location information",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject47')._huntingQuerycontentId47,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject47')._huntingQuerycontentId47,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject48').huntingQueryTemplateSpecName48]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Hunt for Admin email access_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject48').huntingQueryVersion48]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_48",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Hunt for Admin email access",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminMailAccess\"\n| extend data = RawEventData[\"ExtendedProperties\"]\n| extend OpenedMailbox = data[1].[\"Value\"]\n| extend OpenedEmail = url_decode(tostring(data[2].[\"Value\"]))\n| project AccountDisplayName, ActionType, OpenedMailbox, OpenedEmail\n| join EmailEvents on $left.OpenedEmail == $right.InternetMessageId\n| project Timestamp , Actor = AccountDisplayName, ActionType, OpenedMailbox, SenderFromAddress, RecipientEmailAddress, Subject\n| order by Timestamp desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps report on email access by administrators"
                  },
                  {
                    "name": "tactics",
                    "value": "PrivilegeEscalation"
                  },
                  {
                    "name": "techniques",
                    "value": "T1078"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject48')._huntingQuerycontentId48),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 48",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject48')._huntingQuerycontentId48)]",
                "contentId": "[variables('huntingQueryObject48')._huntingQuerycontentId48]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject48').huntingQueryVersion48]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject48')._huntingQuerycontentId48]",
        "contentKind": "HuntingQuery",
        "displayName": "Hunt for Admin email access",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject48')._huntingQuerycontentId48,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject48')._huntingQuerycontentId48,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject49').huntingQueryTemplateSpecName49]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Hunt for TABL changes_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject49').huntingQueryVersion49]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_49",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Hunt for TABL changes",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType contains \"TenantAllowBlockListItems\"\n| order by Timestamp desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunting for Tenant allow/block list (TABL) changes in Defender for Office 365"
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject49')._huntingQuerycontentId49),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 49",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject49')._huntingQuerycontentId49)]",
                "contentId": "[variables('huntingQueryObject49')._huntingQuerycontentId49]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject49').huntingQueryVersion49]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject49')._huntingQuerycontentId49]",
        "contentKind": "HuntingQuery",
        "displayName": "Hunt for TABL changes",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject49')._huntingQuerycontentId49,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject49')._huntingQuerycontentId49,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject50').huntingQueryTemplateSpecName50]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Local time to UTC time conversion_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject50').huntingQueryVersion50]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_50",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Local time to UTC time conversion",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where Timestamp between (datetime_local_to_utc(datetime(2023-08-10T00:00:00Z),\"Europe/Madrid\") .. datetime_local_to_utc(datetime(2023-08-31T23:59:59Z),\"Europe/Madrid\"))\n| where DeliveryAction == \"Delivered\"\n| where LatestDeliveryLocation == \"Quarantine\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Advanced Hunting has default timezone as UTC time. Filters in Advanced Hunting also work in UTC by default whereas query results are shown in local time if user has selected local time zone in security center settings."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject50')._huntingQuerycontentId50),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 50",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject50')._huntingQuerycontentId50)]",
                "contentId": "[variables('huntingQueryObject50')._huntingQuerycontentId50]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject50').huntingQueryVersion50]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject50')._huntingQuerycontentId50]",
        "contentKind": "HuntingQuery",
        "displayName": "Local time to UTC time conversion",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject50')._huntingQuerycontentId50,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject50')._huntingQuerycontentId50,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject51').huntingQueryTemplateSpecName51]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Mail item accessed_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject51').huntingQueryVersion51]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_51",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Mail item accessed",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where Timestamp > ago(30d)\n| extend Record= (parse_json(RawEventData)).RecordType\n| where Record == 50\n| take 10\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing emails accessed by end users using cloud app events data"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject51')._huntingQuerycontentId51),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 51",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject51')._huntingQuerycontentId51)]",
                "contentId": "[variables('huntingQueryObject51')._huntingQuerycontentId51]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject51').huntingQueryVersion51]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject51')._huntingQuerycontentId51]",
        "contentKind": "HuntingQuery",
        "displayName": "Mail item accessed",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject51')._huntingQuerycontentId51,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject51')._huntingQuerycontentId51,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject52').huntingQueryTemplateSpecName52]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Malicious email senders_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject52').huntingQueryVersion52]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_52",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malicious email senders",
                "category": "Hunting Queries",
                "query": "let SenderWithQuarantine = EmailEvents\n| where LatestDeliveryLocation == \"Quarantine\"\n| project SenderFromAddress;\nEmailEvents\n| where LatestDeliveryLocation == \"Inbox/folder\"\n| where SenderFromAddress in (SenderWithQuarantine)\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunting for emails from a sender with at least one email in quarantine"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject52')._huntingQuerycontentId52),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 52",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject52')._huntingQuerycontentId52)]",
                "contentId": "[variables('huntingQueryObject52')._huntingQuerycontentId52]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject52').huntingQueryVersion52]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject52')._huntingQuerycontentId52]",
        "contentKind": "HuntingQuery",
        "displayName": "Malicious email senders",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject52')._huntingQuerycontentId52,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject52')._huntingQuerycontentId52,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject53').huntingQueryTemplateSpecName53]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MDO daily detection summary report_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject53').huntingQueryVersion53]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_53",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "MDO daily detection summary report",
                "category": "Hunting Queries",
                "query": "let QueryTime = 30d;\nlet Reports = CloudAppEvents \n| where Timestamp > ago(QueryTime)\n| where ActionType == \"UserSubmission\" or ActionType == \"AdminSubmission\"\n| extend MessageDate = todatetime((parse_json(RawEventData)).MessageDate)\n| extend NetworkMessageID = tostring((parse_json(RawEventData)).ObjectId)\n| extend Date_value = tostring(format_datetime( MessageDate, \"yyyy-MM-dd\"))\n| distinct Date_value,NetworkMessageID\n| summarize count() by Date_value\n| project Date_value, MessagesGotReported=count_;\nlet ThreatByAutomation = (AlertEvidence | where Title == \"Email reported by user as malware or phish\")\n| extend LastVerdictfromAutomation = tostring((parse_json(AdditionalFields)).LastVerdict)\n| extend Date_value = tostring(format_datetime( Timestamp, \"yyyy-MM-dd\"))\n| extend DetectionFromAIR = iif(isempty(LastVerdictfromAutomation), \"NoThreatsFound\", tostring(LastVerdictfromAutomation))\n| summarize PostDeliveryTotalAIRInvestigations = count(),\n         PostDeliveryAirNoThreatsFound = countif(DetectionFromAIR contains \"NoThreatsFound\"),\n         PostDeliveryAirSuspicious = countif(DetectionFromAIR contains \"Suspicious\"),\n         PostDeliveryAirMalicious = countif(DetectionFromAIR contains \"Malicious\")\n         by Date_value          //Date Reported from Message Submissions from CloudAppEvents does not match to the AIR Investigations from Alert playbooks\n| project Date_value, PostDeliveryTotalAIRInvestigations, PostDeliveryAirNoThreatsFound, PostDeliveryAirSuspicious, PostDeliveryAirMalicious;\nlet DeliveryInboundEvents = (EmailEvents | where EmailDirection == \"Inbound\" and Timestamp > ago(QueryTime)\n| extend Date_value = tostring(format_datetime( Timestamp, \"yyyy-MM-dd\"))\n| project Date_value, Timestamp, NetworkMessageId, DetectionMethods ,RecipientEmailAddress);\nlet PostDeliveryEvents = (EmailPostDeliveryEvents | where ActionType contains \"ZAP\" and ActionResult == \"Success\"| join DeliveryInboundEvents on RecipientEmailAddress, NetworkMessageId //Only successful ZAP Events, there could still be more, join on Recipient and NetID\n| extend Date_value = tostring(format_datetime( Timestamp, \"yyyy-MM-dd\")) //Zap Timestamp is used and not MessageDate received\n| summarize PostDeliveryZAP=count() by Date_value);\nlet DeliveryByThreat = (DeliveryInboundEvents\n| where Timestamp > ago(QueryTime)\n| extend Date_value = tostring(format_datetime( Timestamp, \"yyyy-MM-dd\"))\n| extend MDO_detection = parse_json(DetectionMethods)\n| extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0]))\n| extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\"))\n| summarize TotalEmails = count(),\n         Clean = countif(FirstSubcategory contains \"Clean\"),\n         Malware = countif(FirstSubcategory contains \"Malware\"),\n         Phish = countif(FirstSubcategory contains \"Phish\"),\n         Spam = countif(FirstSubcategory contains \"Spam\" and FirstSubcategory !contains \"Bulk\"),\n         Bulk = countif(FirstSubcategory contains \"Bulk\")                  \n         by Date_value;\nDeliveryByThreat\n| join kind=fullouter Reports on Date_value\n| join kind=fullouter PostDeliveryEvents on Date_value\n| join kind=fullouter ThreatByAutomation on Date_value\n| sort by Date_value asc\n| project Date_value, Clean, Malware, Phish, Spam, Bulk, MessagesGotReported, PostDeliveryZAP, PostDeliveryTotalAIRInvestigations, PostDeliveryAirNoThreatsFound, PostDeliveryAirMalicious, PostDeliveryAirSuspicious\n| where isnotempty(Date_value) // As Reports from CloudAppEvents Submissions could contain messages submitted before 30 days it is good to remove all > 30 days, otherwise EMailEvents wouldn't have a date\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps report daily on total number of emails, total number of emails detected aby Defender for Office 365"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject53')._huntingQuerycontentId53),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 53",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject53')._huntingQuerycontentId53)]",
                "contentId": "[variables('huntingQueryObject53')._huntingQuerycontentId53]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject53').huntingQueryVersion53]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject53')._huntingQuerycontentId53]",
        "contentKind": "HuntingQuery",
        "displayName": "MDO daily detection summary report",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject53')._huntingQuerycontentId53,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject53')._huntingQuerycontentId53,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject54').huntingQueryTemplateSpecName54]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "New TABL Items_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject54').huntingQueryVersion54]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_54",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "New TABL Items",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"New-TenantAllowBlockListItems\"\n| extend Parameters = RawEventData.Parameters\n| mv-apply Parameters on ( \n  extend Out=bag_pack(tostring(Parameters.Name), Parameters.Value)\n  | summarize Parameters=make_bag(Out)\n  )\n| extend Allow=Parameters.Allow, Block=Parameters.Block, Entry=Parameters.Entries, ExpirationDate=Parameters.ExpirationDate, ListType=Parameters.ListType,ListSubType=Parameters.ListSubType, ModifiedBy=Parameters.ModifiedBy, NoExpiration=Parameters.NoExpiration, SubmissionID=Parameters.SubmissionID, SubmissionUserId=Parameters.SubmissionUserId, Notes=Parameters.Notes\n| extend Action=iff(Allow == \"True\", \"Allow\", iff(Block == \"True\", \"Block\", \"Unknown\")), AccountUpn=tostring(coalesce(SubmissionUserId, ModifiedBy))\n| project Timestamp, Action, ListType, ListSubType, Entry, ExpirationDate, NoExpiration, AccountUpn, Notes, SubmissionID, ReportId\n| order by Timestamp desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps identifying when new items being added to the Tenant/Allow Block List (TABL) in Defender for Office 365."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject54')._huntingQuerycontentId54),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 54",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject54')._huntingQuerycontentId54)]",
                "contentId": "[variables('huntingQueryObject54')._huntingQuerycontentId54]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject54').huntingQueryVersion54]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject54')._huntingQuerycontentId54]",
        "contentKind": "HuntingQuery",
        "displayName": "New TABL Items",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject54')._huntingQuerycontentId54,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject54')._huntingQuerycontentId54,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject55').huntingQueryTemplateSpecName55]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 Domains sending Malicious Emails (Malware+Phish+Spam)_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject55').huntingQueryVersion55]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_55",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 Domains sending Malicious Emails (Malware+Phish+Spam)",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Inbound\"\n| where ThreatTypes has_any (\"Malware\", \"Phish\", \"Spam\")\n// Uncomment the line below to exclude your own organization's domains (including subdomains)\n// | where SenderFromDomain !contains \".yourdomain.com\"\n| summarize count() by SenderFromDomain\n| sort by count_ desc\n| top 10 by count_\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Identifies the top 10 sender domains delivering inbound emails classified as malware, phishing, or spam.\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject55')._huntingQuerycontentId55),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 55",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject55')._huntingQuerycontentId55)]",
                "contentId": "[variables('huntingQueryObject55')._huntingQuerycontentId55]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject55').huntingQueryVersion55]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject55')._huntingQuerycontentId55]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 Domains sending Malicious Emails (Malware+Phish+Spam)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject55')._huntingQuerycontentId55,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject55')._huntingQuerycontentId55,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject56').huntingQueryTemplateSpecName56]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 External Senders (Malware)_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject56').huntingQueryVersion56]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_56",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 External Senders (Malware)",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Inbound\"\n| where ThreatTypes has \"Malware\"\n//| where SenderFromAddress !contains \".yourdomain.com\"\n| summarize count() by SenderFromAddress\n| sort by count_ desc\n| top 10 by count_\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Identifies the top 10 external sender addresses delivering inbound emails classified as malware.\nIf you want to exclude your own organization's domains (including subdomains), add a filter after the malware filter, e.g.:\n  | where SenderFromAddress !contains \".yourdomain.com\"\n(Replace \"yourdomain.com\" with your actual domain.)\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject56')._huntingQuerycontentId56),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 56",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject56')._huntingQuerycontentId56)]",
                "contentId": "[variables('huntingQueryObject56')._huntingQuerycontentId56]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject56').huntingQueryVersion56]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject56')._huntingQuerycontentId56]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 External Senders (Malware)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject56')._huntingQuerycontentId56,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject56')._huntingQuerycontentId56,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject57').huntingQueryTemplateSpecName57]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 External Senders (Phish)_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject57').huntingQueryVersion57]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_57",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 External Senders (Phish)",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Inbound\"\n| where ThreatTypes has \"Phish\"\n//| where SenderFromAddress !contains \".yourdomain.com\"\n| summarize count() by SenderFromAddress\n| sort by count_ desc\n| top 10 by count_\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Identifies the top 10 external sender addresses delivering inbound emails classified as phishing.\nIf you want to exclude your own organization's domains (including subdomains), add a filter after the phishing filter, e.g.:\n  | where SenderFromAddress !contains \".yourdomain.com\"\n(Replace \"yourdomain.com\" with your actual domain.)\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject57')._huntingQuerycontentId57),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 57",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject57')._huntingQuerycontentId57)]",
                "contentId": "[variables('huntingQueryObject57')._huntingQuerycontentId57]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject57').huntingQueryVersion57]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject57')._huntingQuerycontentId57]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 External Senders (Phish)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject57')._huntingQuerycontentId57,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject57')._huntingQuerycontentId57,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject58').huntingQueryTemplateSpecName58]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 External Senders (Spam)_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject58').huntingQueryVersion58]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_58",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 External Senders (Spam)",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Inbound\"\n| where ThreatTypes has \"Spam\"\n//| where SenderFromAddress !contains \".yourdomain.com\"\n| summarize count() by SenderFromAddress\n| sort by count_ desc\n| top 10 by count_\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Identifies the top 10 external sender addresses delivering inbound emails classified as spam.\nIf you want to exclude your own organization's domains (including subdomains), add a filter after the spam filter, e.g.:\n  | where SenderFromAddress !contains \".yourdomain.com\"\n(Replace \"yourdomain.com\" with your actual domain.)\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject58')._huntingQuerycontentId58),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 58",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject58')._huntingQuerycontentId58)]",
                "contentId": "[variables('huntingQueryObject58')._huntingQuerycontentId58]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject58').huntingQueryVersion58]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject58')._huntingQuerycontentId58]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 External Senders (Spam)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject58')._huntingQuerycontentId58,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject58')._huntingQuerycontentId58,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject59').huntingQueryTemplateSpecName59]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 External Senders_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject59').huntingQueryVersion59]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_59",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 External Senders (Spam)",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Inbound\"\n| where ThreatTypes has \"Spam\"\n//| where SenderFromAddress !contains \".yourdomain.com\"\n| summarize count() by SenderFromAddress\n| sort by count_ desc\n| top 10 by count_\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Identifies the top 10 external sender addresses delivering inbound emails classified as spam.\nTo exclude your own organization's domains (including subdomains), add a filter after the spam filter, e.g.:\n  | where SenderFromAddress !contains \".yourdomain.com\"\n(Replace \"yourdomain.com\" with your actual domain.)\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject59')._huntingQuerycontentId59),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 59",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject59')._huntingQuerycontentId59)]",
                "contentId": "[variables('huntingQueryObject59')._huntingQuerycontentId59]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject59').huntingQueryVersion59]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject59')._huntingQuerycontentId59]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 External Senders (Spam)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject59')._huntingQuerycontentId59,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject59')._huntingQuerycontentId59,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject60').huntingQueryTemplateSpecName60]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 Targeted Users (Malware+Phish+Spam)_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject60').huntingQueryVersion60]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_60",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 Targeted Users (Malware+Phish+Spam)",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where (ThreatTypes has \"Malware\" or ThreatTypes has \"Phish\" or ThreatTypes has \"Spam\") and EmailDirection == \"Inbound\"\n| summarize count() by RecipientEmailAddress\n| sort by count_\n| top 10 by count_\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Identifies the top 10 users receiving inbound emails classified as malware, phishing, or spam.\nBased on concepts from the Defender for Office 365 solution in Sentinel: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject60')._huntingQuerycontentId60),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 60",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject60')._huntingQuerycontentId60)]",
                "contentId": "[variables('huntingQueryObject60')._huntingQuerycontentId60]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject60').huntingQueryVersion60]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject60')._huntingQuerycontentId60]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 Targeted Users (Malware+Phish+Spam)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject60')._huntingQuerycontentId60,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject60')._huntingQuerycontentId60,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject61').huntingQueryTemplateSpecName61]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 Users clicking on Malicious URLs (Malware+Phish+Spam)_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject61').huntingQueryVersion61]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_61",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 Users clicking on Malicious URLs (Malware+Phish+Spam)",
                "category": "Hunting Queries",
                "query": "UrlClickEvents\n| where ThreatTypes has_any (\"Malware\", \"Phish\", \"Spam\")\n| summarize count() by AccountUpn\n| top 10 by count_\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Visualises the top 10 users with click attempts on URLs in emails detected as malware, phishing, or spam, helping analysts identify risky user behaviour and potential targets.\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject61')._huntingQuerycontentId61),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 61",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject61')._huntingQuerycontentId61)]",
                "contentId": "[variables('huntingQueryObject61')._huntingQuerycontentId61]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject61').huntingQueryVersion61]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject61')._huntingQuerycontentId61]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 Users clicking on Malicious URLs (Malware+Phish+Spam)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject61')._huntingQuerycontentId61,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject61')._huntingQuerycontentId61,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject62').huntingQueryTemplateSpecName62]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Total number of detections by MDO over time_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject62').huntingQueryVersion62]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_62",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "MDO Threat Protection Detections trend over time",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet totalinbound = EmailEvents\n| where TimeGenerated >= TimeStart\n| where EmailDirection == \"Inbound\"\n| make-series Count= count() on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Total Inbound Emails\";\nlet totalintraorg = EmailEvents\n| where TimeGenerated >= TimeStart\n| where EmailDirection == \"Intra-org\"\n| make-series Count= count() on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Total Intra-org Emails\";\nlet totaloutbound = EmailEvents\n| where TimeGenerated >= TimeStart\n| where EmailDirection == \"Outbound\"\n| make-series Count= count() on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Total Outbound Emails\";\nlet totalwiththreat = EmailEvents\n| where TimeGenerated >= TimeStart\n| where isnotempty(ThreatTypes)\n| make-series Count= count() on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Total Emails with Threat\";\nlet phishingcount = EmailEvents\n| where TimeGenerated >= TimeStart\n| where ThreatTypes has ('Phish')\n| make-series Count= count() on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Emails Detected as Phish\";\nlet malwarecount = EmailEvents\n| where TimeGenerated >= TimeStart\n| where ThreatTypes has ('Malware')\n| make-series Count= count() on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Emails Detected as Malware\";\nlet spamcount = EmailEvents\n| where TimeGenerated >= TimeStart\n| where ThreatTypes has ('Spam')\n| make-series Count= count() on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Emails Detected as Spam\";\nlet zapcount = EmailPostDeliveryEvents\n| where TimeGenerated >= TimeStart\n| where ActionResult == \"Success\"\n| where ActionType == \"Phish ZAP\" or ActionType == \"Malware ZAP\"\n| make-series Count= count() on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Total Emails Removed by ZAP\";\nlet usersubmissioncount = CloudAppEvents\n| where TimeGenerated >= TimeStart\n| extend Record= (parse_json(RawEventData)).RecordType\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState\n| where Record == 29 | where ActionType == \"UserSubmission\"\n| make-series Count= count() on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Total Emails Reported by Users\";\nlet adminsubmissioncount = CloudAppEvents\n| where TimeGenerated >= TimeStart\n| extend Record= (parse_json(RawEventData)).RecordType\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState\n| where Record == 29\n| where ActionType == \"AdminSubmission\"\n| make-series Count= count() on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Total Emails Reported by Admins\";\nunion totalinbound, totalintraorg, totaloutbound, totalwiththreat, phishingcount, malwarecount, spamcount, zapcount,  usersubmissioncount, adminsubmissioncount\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Graph of MDO detections trended over time"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject62')._huntingQuerycontentId62),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 62",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject62')._huntingQuerycontentId62)]",
                "contentId": "[variables('huntingQueryObject62')._huntingQuerycontentId62]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject62').huntingQueryVersion62]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject62')._huntingQuerycontentId62]",
        "contentKind": "HuntingQuery",
        "displayName": "MDO Threat Protection Detections trend over time",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject62')._huntingQuerycontentId62,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject62')._huntingQuerycontentId62,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject63').huntingQueryTemplateSpecName63]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Total number of detections by MDO_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject63').huntingQueryVersion63]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_63",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Total number of detections by MDO",
                "category": "Hunting Queries",
                "query": "let totalinbound = EmailEvents\n| where EmailDirection == \"Inbound\"\n| summarize Count = count()\n| extend Details = \"Total Inbound Emails\";\nlet totalintraorg = EmailEvents\n| where EmailDirection == \"Intra-org\"\n| summarize Count = count()\n| extend Details = \"Total Intra-org Emails\";\nlet totaloutbound = EmailEvents\n| where EmailDirection == \"Outbound\"\n| summarize Count = count()\n| extend Details = \"Total Outbound Emails\";\nlet totalwiththreat = EmailEvents\n| where isnotempty(ThreatTypes)\n| summarize Count = count()\n| extend Details = \"Total Emails with Threats\";\nlet phishingcount = EmailEvents\n| where ThreatTypes has ('Phish')\n| summarize Count= count()\n| extend Details = \"Emails Detected as Phish\";\nlet malwarecount = EmailEvents\n| where ThreatTypes has ('Malware')\n| summarize Count= count()\n| extend Details = \"Emails Detected as Malware\";\nlet spamcount = EmailEvents\n| where ThreatTypes has ('Spam')\n| summarize Count= count()\n| extend Details = \"Emails Detected as Spam\";\nlet usersubmissioncount = CloudAppEvents\n| extend Record= (parse_json(RawEventData)).RecordType\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState\n| where Record == 29 | where ActionType == \"UserSubmission\"\n| summarize Count= count()\n| extend Details = \"Total Emails Reported by Users\";\nlet adminsubmissioncount = CloudAppEvents\n| extend Record= (parse_json(RawEventData)).RecordType\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState\n| where Record == 29 | where ActionType == \"AdminSubmission\"\n| summarize Count= count()\n| extend Details = \"Total Emails Reported by Admins\";\nlet zapcount = EmailPostDeliveryEvents\n| where ActionResult == \"Success\"\n| where ActionType == \"Phish ZAP\" or ActionType == \"Malware ZAP\"\n| summarize Count= count()\n| extend Details = \"Total Emails Removed by ZAP\";\nunion totalinbound, phishingcount, malwarecount, spamcount, totalintraorg, totaloutbound, totalwiththreat, usersubmissioncount, zapcount, adminsubmissioncount\n| project Count, Details\n| order by Count desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Provides a summary of total number of detections"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject63')._huntingQuerycontentId63),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 63",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject63')._huntingQuerycontentId63)]",
                "contentId": "[variables('huntingQueryObject63')._huntingQuerycontentId63]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject63').huntingQueryVersion63]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject63')._huntingQuerycontentId63]",
        "contentKind": "HuntingQuery",
        "displayName": "Total number of detections by MDO",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject63')._huntingQuerycontentId63,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject63')._huntingQuerycontentId63,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject64').huntingQueryTemplateSpecName64]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Automated email notifications and suspicious sign-in activity_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject64').huntingQueryVersion64]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_64",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Automated email notifications and suspicious sign-in activity",
                "category": "Hunting Queries",
                "query": "let usersWithSuspiciousEmails = EmailEvents\n| where SenderFromAddress in (\"no-reply@notify.microsoft.com\", \"no-reply@dropbox.com\") or InternetMessageId startswith \"<OneTimePasscode\"\n| where isnotempty(RecipientObjectId)\n| distinct RecipientObjectId;\nAADSignInEventsBeta\n| where AccountObjectId in (usersWithSuspiciousEmails)\n| where RiskLevelDuringSignIn == 100\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunting for Automated email notifications and suspicious sign-in activity"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject64')._huntingQuerycontentId64),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 64",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject64')._huntingQuerycontentId64)]",
                "contentId": "[variables('huntingQueryObject64')._huntingQuerycontentId64]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject64').huntingQueryVersion64]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject64')._huntingQuerycontentId64]",
        "contentKind": "HuntingQuery",
        "displayName": "Automated email notifications and suspicious sign-in activity",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject64')._huntingQuerycontentId64,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject64')._huntingQuerycontentId64,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject65').huntingQueryTemplateSpecName65]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BEC - File sharing tactics - Dropbox_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject65').huntingQueryVersion65]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_65",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "BEC - File sharing tactics - Dropbox",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType in (\"Added users and/or groups to shared file/folder\", \"Invited user to Dropbox and added them to shared file/folder\")\n| where Application == \"Dropbox\"\n| where ObjectType == \"File\"\n| extend FileShared = tostring(ObjectName)\n| where isnotempty(FileShared)\n| mv-expand ActivityObjects\n| where ActivityObjects.Type == \"Account\" and ActivityObjects.Role == \"To\"\n| extend SharedBy = AccountId\n| extend UserSharedWith = tostring(ActivityObjects.Name)\n| summarize dcount(UserSharedWith) by FileShared, AccountObjectId\n| where dcount_UserSharedWith >= 20\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunting for BEC - File sharing tactics - Dropbox"
                  },
                  {
                    "name": "tactics",
                    "value": "LateralMovement"
                  },
                  {
                    "name": "techniques",
                    "value": "T1021"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject65')._huntingQuerycontentId65),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 65",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject65')._huntingQuerycontentId65)]",
                "contentId": "[variables('huntingQueryObject65')._huntingQuerycontentId65]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject65').huntingQueryVersion65]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject65')._huntingQuerycontentId65]",
        "contentKind": "HuntingQuery",
        "displayName": "BEC - File sharing tactics - Dropbox",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject65')._huntingQuerycontentId65,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject65')._huntingQuerycontentId65,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject66').huntingQueryTemplateSpecName66]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BEC - File sharing tactics - OneDrive or SharePoint_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject66').huntingQueryVersion66]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_66",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "BEC - File sharing tactics - OneDrive or SharePoint",
                "category": "Hunting Queries",
                "query": "let securelinkCreated = CloudAppEvents\n| where ActionType == \"SecureLinkCreated\"\n| project FileCreatedTime = Timestamp, AccountObjectId, ObjectName;\nlet filesCreated = securelinkCreated\n| where isnotempty(ObjectName)\n| distinct tostring(ObjectName);\nCloudAppEvents\n| where ActionType == \"AddedToSecureLink\"\n| where Application in (\"Microsoft SharePoint Online\", \"Microsoft OneDrive for Business\")\n| extend FileShared = tostring(RawEventData.ObjectId)\n| where FileShared in (filesCreated)\n| extend UserSharedWith = tostring(RawEventData.TargetUserOrGroupName)\n| extend TypeofUserSharedWith = RawEventData.TargetUserOrGroupType\n| where TypeofUserSharedWith == \"Guest\"\n| where isnotempty(FileShared) and isnotempty(UserSharedWith)\n| join kind=inner securelinkCreated on $left.FileShared==$right.ObjectName\n// Secure file created recently (in the last 1day)\n| where (Timestamp - FileCreatedTime) between (1d .. 0h)\n| summarize NumofUsersSharedWith = dcount(UserSharedWith) by FileShared\n| where NumofUsersSharedWith >= 20\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunting for BEC - File sharing tactics - OneDrive or SharePoint"
                  },
                  {
                    "name": "tactics",
                    "value": "LateralMovement"
                  },
                  {
                    "name": "techniques",
                    "value": "T1021"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject66')._huntingQuerycontentId66),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 66",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject66')._huntingQuerycontentId66)]",
                "contentId": "[variables('huntingQueryObject66')._huntingQuerycontentId66]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject66').huntingQueryVersion66]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject66')._huntingQuerycontentId66]",
        "contentKind": "HuntingQuery",
        "displayName": "BEC - File sharing tactics - OneDrive or SharePoint",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject66')._huntingQuerycontentId66,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject66')._huntingQuerycontentId66,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject67').huntingQueryTemplateSpecName67]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Email bombing_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject67').huntingQueryVersion67]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_67",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Email bombing attacks",
                "category": "Hunting Queries",
                "query": "// Find mail that is older than 4 hrs and establish if it is a reply/forward or not. Join that to recent mail where the User hadn't communicated previously. These are new first contact messages.\nlet Contact_Established = EmailEvents \n| where Timestamp <= ago(4hr)\n| where DeliveryLocation != \"Quarantine\"\nand EmailDirection == \"Inbound\"\nand OrgLevelAction != \"Block\"\nand UserLevelAction != \"Block\"\n| extend NewMsg = case(Subject startswith \"RE:\", false, Subject startswith \"FW:\", false, true )\n| where NewMsg == false\n| project Pair = strcat(SenderMailFromAddress,\"|\",RecipientEmailAddress);\n// Find new mail in the last 4hrs.\nEmailEvents\n| where Timestamp > ago(4hr)\nand DeliveryAction == \"Delivered\"\n| extend Pair = strcat(SenderMailFromAddress,\"|\",RecipientEmailAddress)\n| where Pair !in (Contact_Established)\n| summarize 5_Min_Count = dcount(NetworkMessageId) by RecipientEmailAddress, bin(Timestamp, 5m)\n| where 5_Min_Count > 5 // check if recipient has received more than 5 first contact emails in 5 mins\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing recipients who are potentially victim of email bombing attacks"
                  },
                  {
                    "name": "tactics",
                    "value": "Initialaccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject67')._huntingQuerycontentId67),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 67",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject67')._huntingQuerycontentId67)]",
                "contentId": "[variables('huntingQueryObject67')._huntingQuerycontentId67]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject67').huntingQueryVersion67]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject67')._huntingQuerycontentId67]",
        "contentKind": "HuntingQuery",
        "displayName": "Email bombing attacks",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject67')._huntingQuerycontentId67,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject67')._huntingQuerycontentId67,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject68').huntingQueryTemplateSpecName68]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Emails containing links to IP addresses_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject68').huntingQueryVersion68]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_68",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Emails containing links to IP addresses",
                "category": "Hunting Queries",
                "query": "EmailUrlInfo\n| where Url matches regex @\"file://(?:[0-9]{1,3}\\.){3}[0-9]{1,3}\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunting for Emails containing links to IP addresses"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject68')._huntingQuerycontentId68),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 68",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject68')._huntingQuerycontentId68)]",
                "contentId": "[variables('huntingQueryObject68')._huntingQuerycontentId68]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject68').huntingQueryVersion68]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject68')._huntingQuerycontentId68]",
        "contentKind": "HuntingQuery",
        "displayName": "Emails containing links to IP addresses",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject68')._huntingQuerycontentId68,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject68')._huntingQuerycontentId68,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject69').huntingQueryTemplateSpecName69]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Files share contents and suspicious sign-in activity_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject69').huntingQueryVersion69]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_69",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Files share contents and suspicious sign-in activity",
                "category": "Hunting Queries",
                "query": "let usersWithSuspiciousEmails = EmailEvents\n| where Subject has_all (\"shared\", \"with you\")\n| where Subject has_any (\"payment\", \"invoice\", \"urgent\", \"mandatory\", \"Payoff\", \"Wire\", \"Confirmation\", \"password\")\n| where isnotempty(RecipientObjectId)\n| summarize RecipientCount = dcount(RecipientObjectId), RecipientList = make_set(RecipientObjectId) by Subject\n| where RecipientCount >= 10\n| mv-expand RecipientList to typeof(string)\n| distinct RecipientList;\nAADSignInEventsBeta\n| where AccountObjectId in (usersWithSuspiciousEmails)\n| where RiskLevelDuringSignIn == 100\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunting for Files share contents and suspicious sign-in activity"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject69')._huntingQuerycontentId69),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 69",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject69')._huntingQuerycontentId69)]",
                "contentId": "[variables('huntingQueryObject69')._huntingQuerycontentId69]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject69').huntingQueryVersion69]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject69')._huntingQuerycontentId69]",
        "contentKind": "HuntingQuery",
        "displayName": "Files share contents and suspicious sign-in activity",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject69')._huntingQuerycontentId69,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject69')._huntingQuerycontentId69,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject70').huntingQueryTemplateSpecName70]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Good emails from senders with bad patterns_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject70').huntingQueryVersion70]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_70",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Good emails from senders with bad patterns",
                "category": "Hunting Queries",
                "query": "//Good emails from senders with bad patterns\nlet PctPhishThreshold = 50;\nlet LookbackWindow = 1d;\n EmailEvents\n| where Timestamp > ago (LookbackWindow) and EmailDirection == \"Inbound\"\n| extend PhishMethods=tostring(parse_json(DetectionMethods).Phish)\n| where PhishMethods contains (\"File\") or PhishMethods contains (\"URL\") or PhishMethods contains (\"Filter\")\n| summarize PhishCount=count() by SenderMailFromAddress,AuthenticationDetails,PhishMethods\n| join kind=inner (EmailEvents | where Timestamp > ago (LookbackWindow) and EmailDirection == \"Inbound\"\n| summarize TotalCount=count() by SenderMailFromAddress,AuthenticationDetails) on SenderMailFromAddress,AuthenticationDetails\n| project-away SenderMailFromAddress1,AuthenticationDetails1\n| extend PctPhish = (PhishCount*100 / TotalCount)\n| where PctPhish < 100 and PctPhish>= PctPhishThreshold\n| join kind=inner (EmailEvents | where Timestamp > ago (LookbackWindow) and EmailDirection == \"Inbound\" and DeliveryLocation<> \"Quarantine\") on SenderMailFromAddress,AuthenticationDetails\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunting for good emails from senders with bad patterns"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject70')._huntingQuerycontentId70),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 70",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject70')._huntingQuerycontentId70)]",
                "contentId": "[variables('huntingQueryObject70')._huntingQuerycontentId70]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject70').huntingQueryVersion70]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject70')._huntingQuerycontentId70]",
        "contentKind": "HuntingQuery",
        "displayName": "Good emails from senders with bad patterns",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject70')._huntingQuerycontentId70,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject70')._huntingQuerycontentId70,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject71').huntingQueryTemplateSpecName71]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Hunt for email bombing attacks_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject71').huntingQueryVersion71]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_71",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Hunt for email bombing attacks",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Inbound\"\n| make-series Emailcount = count()\n              on Timestamp step 1h by RecipientObjectId\n| extend (Anomalies, AnomalyScore, ExpectedEmails) = series_decompose_anomalies(Emailcount)\n| mv-expand Emailcount, Anomalies, AnomalyScore, ExpectedEmails to typeof(double), Timestamp\n| where Anomalies != 0\n| where AnomalyScore >= 10\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps to hunt for possible email bombing attacks in Microsoft Defender for Office 365."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject71')._huntingQuerycontentId71),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 71",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject71')._huntingQuerycontentId71)]",
                "contentId": "[variables('huntingQueryObject71')._huntingQuerycontentId71]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject71').huntingQueryVersion71]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject71')._huntingQuerycontentId71]",
        "contentKind": "HuntingQuery",
        "displayName": "Hunt for email bombing attacks",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject71')._huntingQuerycontentId71,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject71')._huntingQuerycontentId71,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject72').huntingQueryTemplateSpecName72]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Hunt for email conversation take over attempts_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject72').huntingQueryVersion72]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_72",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Hunt for email conversation take over attempts",
                "category": "Hunting Queries",
                "query": "let emailDelivered = EmailEvents\n| where Timestamp < ago(4hrs)\nand DeliveryAction == \"Delivered\"\n| extend Pair = strcat(SenderMailFromAddress,\"|\",RecipientEmailAddress)\n| distinct Pair;\nlet EmailDomains = EmailEvents\n| where Timestamp < ago(4hrs)\nand DeliveryAction == \"Delivered\"\n| distinct SenderFromDomain;\nEmailEvents\n| where Timestamp >= ago(4hrs)\n| where DeliveryLocation != \"Quarantine\"\nand EmailDirection == \"Inbound\"\nand OrgLevelAction != \"Block\"\nand UserLevelAction != \"Block\"\n| extend NewMsg = case(Subject contains \"RE:\", false, Subject contains \"FW:\", false, true )\n| project Pair = strcat(SenderMailFromAddress,\"|\",RecipientEmailAddress), NetworkMessageId, SenderFromDomain, SenderMailFromAddress, RecipientEmailAddress, DeliveryAction, ThreatTypes, DetectionMethods, NewMsg, Subject\n| join kind=leftouter ( emailDelivered ) on Pair\n| order by SenderMailFromAddress\n| where NewMsg == false\nand Pair1 == \"\"\n| join kind=leftouter (EmailDomains) on SenderFromDomain\n| where SenderFromDomain1 == \"\"\n| distinct Pair, NetworkMessageId, SenderFromDomain, SenderMailFromAddress, RecipientEmailAddress, DeliveryAction, ThreatTypes, DetectionMethods, NewMsg, Subject\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunting for email conversation take over attempts"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject72')._huntingQuerycontentId72),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 72",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject72')._huntingQuerycontentId72)]",
                "contentId": "[variables('huntingQueryObject72')._huntingQuerycontentId72]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject72').huntingQueryVersion72]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject72')._huntingQuerycontentId72]",
        "contentKind": "HuntingQuery",
        "displayName": "Hunt for email conversation take over attempts",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject72')._huntingQuerycontentId72,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject72')._huntingQuerycontentId72,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject73').huntingQueryTemplateSpecName73]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Hunt for malicious attachments using external IOC source_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject73').huntingQueryVersion73]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_73",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Hunt for malicious attachments using external IOC source",
                "category": "Hunting Queries",
                "query": "let abuse_sha256 = (externaldata(sha256_hash: string)\n[@\"https://bazaar.abuse.ch/export/txt/sha256/recent/\"]\nwith (format=\"txt\"))\n| where sha256_hash !startswith \"#\"\n| project sha256_hash;\nabuse_sha256\n| join (EmailAttachmentInfo\n| where Timestamp > ago(1d)\n) on $left.sha256_hash == $right.SHA256\n| project Timestamp,SenderFromAddress,RecipientEmailAddress,FileName,FileType,SHA256,ThreatTypes,DetectionMethods,NetworkMessageId,ReportId\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for emails with malicious attachments based on SH256 hash from external IOC source"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject73')._huntingQuerycontentId73),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 73",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject73')._huntingQuerycontentId73)]",
                "contentId": "[variables('huntingQueryObject73')._huntingQuerycontentId73]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject73').huntingQueryVersion73]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject73')._huntingQuerycontentId73]",
        "contentKind": "HuntingQuery",
        "displayName": "Hunt for malicious attachments using external IOC source",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject73')._huntingQuerycontentId73,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject73')._huntingQuerycontentId73,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject74').huntingQueryTemplateSpecName74]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Hunt for malicious URLs using external IOC source_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject74').huntingQueryVersion74]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_74",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Hunt for malicious URLs using external IOC source",
                "category": "Hunting Queries",
                "query": "let url = (externaldata(url: string )\n[@\"https://urlhaus.abuse.ch/downloads/text_online/\"]\nwith (format=\"txt\"))\n| project url;\nurl\n| join (EmailUrlInfo\n| where Timestamp > ago(2h) \n) on $left.url == $right.Url\n|join EmailEvents on NetworkMessageId\n|project Timestamp, NetworkMessageId, Url, UrlLocation, UrlDomain, SenderFromAddress, SenderDisplayName, SenderIPv4, Subject,RecipientEmailAddress, RecipientObjectId, LatestDeliveryAction, ThreatNames, ThreatTypes, DetectionMethods, DeliveryAction,ReportId\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for emails with malicious URLs based on external IOC source"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject74')._huntingQuerycontentId74),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 74",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject74')._huntingQuerycontentId74)]",
                "contentId": "[variables('huntingQueryObject74')._huntingQuerycontentId74]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject74').huntingQueryVersion74]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject74')._huntingQuerycontentId74]",
        "contentKind": "HuntingQuery",
        "displayName": "Hunt for malicious URLs using external IOC source",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject74')._huntingQuerycontentId74,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject74')._huntingQuerycontentId74,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject75').huntingQueryTemplateSpecName75]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Inbox rule change which forward-redirect email_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject75').huntingQueryVersion75]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_75",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Inbox rule changes which forward-redirect email",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType contains \"Set-InboxRule\"\n|extend Parameters = tostring((parse_json(RawEventData)).Parameters)\n|where Parameters contains \"ForwardTo\" or Parameters contains \"RedirectTo\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunting for Inbox rule changes which forward-redirect email"
                  },
                  {
                    "name": "tactics",
                    "value": "Persistence"
                  },
                  {
                    "name": "techniques",
                    "value": "T1098"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject75')._huntingQuerycontentId75),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 75",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject75')._huntingQuerycontentId75)]",
                "contentId": "[variables('huntingQueryObject75')._huntingQuerycontentId75]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject75').huntingQueryVersion75]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject75')._huntingQuerycontentId75]",
        "contentKind": "HuntingQuery",
        "displayName": "Inbox rule changes which forward-redirect email",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject75')._huntingQuerycontentId75,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject75')._huntingQuerycontentId75,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject76').huntingQueryTemplateSpecName76]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MDO_CountOfRecipientsEmailaddressbySubject_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject76').huntingQueryVersion76]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_76",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "MDO_CountOfRecipientsEmailaddressbySubject",
                "category": "Hunting Queries",
                "query": "//Count of recipient's email addresses by subject\nEmailEvents\n//Change the date for as far back as you want to go\n| where Timestamp > ago(10d)\n| summarize CountRecipientEmailAddress=count() by RecipientEmailAddress, Subject\n//Change the Count of how many times the email with the same subject has come in\n| where CountRecipientEmailAddress >= 15\n| project RecipientEmailAddress, CountRecipientEmailAddress, Subject\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Count of recipient's email addresses by subject"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject76')._huntingQuerycontentId76),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 76",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject76')._huntingQuerycontentId76)]",
                "contentId": "[variables('huntingQueryObject76')._huntingQuerycontentId76]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject76').huntingQueryVersion76]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject76')._huntingQuerycontentId76]",
        "contentKind": "HuntingQuery",
        "displayName": "MDO_CountOfRecipientsEmailaddressbySubject",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject76')._huntingQuerycontentId76,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject76')._huntingQuerycontentId76,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject77').huntingQueryTemplateSpecName77]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MDO_Countofrecipientsemailaddressesbysubject_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject77').huntingQueryVersion77]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_77",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "MDO_Countofrecipientsemailaddressesbysubject",
                "category": "Hunting Queries",
                "query": "//Count of recipient's email addresses by subject\nEmailEvents\n//Change the date for as far back as you want to go\n| where Timestamp > ago(10d)\n| summarize CountRecipientEmailAddress=count() by RecipientEmailAddress, Subject\n//Change the Count of how many times the email with the same subject has come in\n| where CountRecipientEmailAddress >= 15\n| project RecipientEmailAddress, CountRecipientEmailAddress, Subject\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Count of recipient's email addresses by subject"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject77')._huntingQuerycontentId77),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 77",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject77')._huntingQuerycontentId77)]",
                "contentId": "[variables('huntingQueryObject77')._huntingQuerycontentId77]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject77').huntingQueryVersion77]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject77')._huntingQuerycontentId77]",
        "contentKind": "HuntingQuery",
        "displayName": "MDO_Countofrecipientsemailaddressesbysubject",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject77')._huntingQuerycontentId77,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject77')._huntingQuerycontentId77,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject78').huntingQueryTemplateSpecName78]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MDO_CountOfSendersEmailaddressbySubject_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject78').huntingQueryVersion78]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_78",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "MDO_CountOfSendersEmailaddressbySubject",
                "category": "Hunting Queries",
                "query": "//Count of sender's email addresses by subject\nEmailEvents\n//Change the date for as far back as you want to go\n| where Timestamp > ago(10d)\n| summarize CountSenderFromAddress=count() by SenderFromAddress, Subject\n//Change the Count of how many times the email with the same subject has come in\n| where CountSenderFromAddress >= 10\n| project SenderFromAddress, CountSenderFromAddress, Subject\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Count of sender's email addresses by subject"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject78')._huntingQuerycontentId78),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 78",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject78')._huntingQuerycontentId78)]",
                "contentId": "[variables('huntingQueryObject78')._huntingQuerycontentId78]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject78').huntingQueryVersion78]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject78')._huntingQuerycontentId78]",
        "contentKind": "HuntingQuery",
        "displayName": "MDO_CountOfSendersEmailaddressbySubject",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject78')._huntingQuerycontentId78,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject78')._huntingQuerycontentId78,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject79').huntingQueryTemplateSpecName79]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MDO_SummaryOfSenders_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject79').huntingQueryVersion79]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_79",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "MDO_SummaryOfSenders",
                "category": "Hunting Queries",
                "query": "//Distinct Count\nEmailEvents\n| summarize QuaratineEmails = count_distinct(DeliveryLocation == \"Quarantine\"),\n  Emails = count_distinct(DeliveryLocation == \"Inbox/folder\"),\n  JunkEmails = count_distinct(DeliveryLocation == \"Junk folder\")by SenderFromAddress\n\n//Count of all Senders and where they were delivered\nEmailEvents\n| summarize QuaratineEmails = count(DeliveryLocation == \"Quarantine\"),\n  Emails = count(DeliveryLocation == \"Inbox/folder\"),\n  JunkEmails = count(DeliveryLocation == \"Junk folder\")by SenderFromAddress\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Count of all Senders and where they were delivered"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject79')._huntingQuerycontentId79),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 79",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject79')._huntingQuerycontentId79)]",
                "contentId": "[variables('huntingQueryObject79')._huntingQuerycontentId79]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject79').huntingQueryVersion79]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject79')._huntingQuerycontentId79]",
        "contentKind": "HuntingQuery",
        "displayName": "MDO_SummaryOfSenders",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject79')._huntingQuerycontentId79,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject79')._huntingQuerycontentId79,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject80').huntingQueryTemplateSpecName80]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MDO_URLClickedinEmail_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject80').huntingQueryVersion80]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_80",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "MDO_URLClickedinEmail",
                "category": "Hunting Queries",
                "query": "UrlClickEvents\n| where ActionType == \"ClickAllowed\"\n//| where ActionType <> \"ClickAllowed\"\n| project AccountUpn, ActionType, Url\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "URLs clicked in Email"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject80')._huntingQuerycontentId80),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 80",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject80')._huntingQuerycontentId80)]",
                "contentId": "[variables('huntingQueryObject80')._huntingQuerycontentId80]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject80').huntingQueryVersion80]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject80')._huntingQuerycontentId80]",
        "contentKind": "HuntingQuery",
        "displayName": "MDO_URLClickedinEmail",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject80')._huntingQuerycontentId80,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject80')._huntingQuerycontentId80,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject81').huntingQueryTemplateSpecName81]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top outbound recipient domains sending inbound emails with threats_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject81').huntingQueryVersion81]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_81",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top outbound recipient domains sending inbound emails with threats",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Outbound\"\n| project RecipientDomain = tostring(split(RecipientEmailAddress, \"@\")[1])\n| summarize count() by RecipientDomain\n| project OutboundCount=count_, RecipientDomain, SenderFromDomain=RecipientDomain\n| join (EmailEvents | where EmailDirection == \"Inbound\" and isempty(ThreatTypes)==false) on SenderFromDomain\n| summarize max(OutboundCount),count() by SenderFromDomain\n| project SenderFromDomain, OutboundEmails=max_OutboundCount, IncomingEmailsWithThreats=count_\n| sort by OutboundEmails\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunting for top outbound recipient domains which are sending inbound emails with threats"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject81')._huntingQuerycontentId81),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 81",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject81')._huntingQuerycontentId81)]",
                "contentId": "[variables('huntingQueryObject81')._huntingQuerycontentId81]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject81').huntingQueryVersion81]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject81')._huntingQuerycontentId81]",
        "contentKind": "HuntingQuery",
        "displayName": "Top outbound recipient domains sending inbound emails with threats",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject81')._huntingQuerycontentId81,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject81')._huntingQuerycontentId81,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject82').huntingQueryTemplateSpecName82]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Detections by detection methods_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject82').huntingQueryVersion82]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_82",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Detections by detection methods",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where Timestamp > ago(7d)\n| where isnotempty(DetectionMethods)\n| extend MDO_detection = parse_json(DetectionMethods)\n| summarize TotalEmailCount = count(),\n            Phish_detection = countif(isnotempty(MDO_detection.Phish)),\n            Malware_detection = countif(isnotempty(MDO_detection.Malware)),\n            Spam_detection = countif(isnotempty( MDO_detection.Spam)),\n            URL_malicious_reputation = countif(MDO_detection.Phish == @'[\"URL malicious reputation\"]' or MDO_detection.Malware == @'[\"URL malicious reputation\"]'),\n            URL_detonation_reputation = countif(MDO_detection.Phish == @'[\"URL detonation reputation\"]' or MDO_detection.Malware == @'[\"URL detonation reputation\"]'),\n            URL_detonation = countif(MDO_detection.Phish == @'[\"URL detonation\"]' or MDO_detection.Malware == @'[\"URL detonation\"]'),\n            Advanced_filter = countif(MDO_detection.Phish == @'[\"Advanced filter\"]'),\n            General_filter = countif(MDO_detection.Phish == @'[\"General filter\"]'),\n            Spoof_intra_org = countif(MDO_detection.Phish == @'[\"Spoof intra-org\"]'),\n            Spoof_external_domain = countif(MDO_detection.Phish ==  @'[\"Spoof external domain\"]'),\n            Spoof_DMARC = countif(MDO_detection.Phish == @'[\"Spoof DMARC\"]'),\n            Impersonation_brand = countif(MDO_detection.Phish == @'[\"Impersonation brand\"]'),\n            Impersonation_user = countif(MDO_detection.Phish == @'[\"Impersonation user\"]'),\n            Impersonation_domain = countif(MDO_detection.Phish == @'[\"Impersonation domain\"]'),\n            Mixed_analysis_detection= countif(MDO_detection.Phish == @'[\"Mixed analysis detection\"]'),\n            File_reputation = countif(MDO_detection.Phish == @'[\"File reputation\"]' or MDO_detection.Malware == @'[\"File reputation\"]'),\n            File_detonation = countif(MDO_detection.Phish == @'[\"File detonation\"]' or MDO_detection.Malware == @'[\"File detonation\"]'),\n            File_detonation_reputation = countif(MDO_detection.Phish == @'[\"File detonation reputation\"]' or MDO_detection.Malware == @'[\"File detonation reputation\"]'),\n            Antimalware_engine = countif(MDO_detection.Malware == @'[\"Antimalware engine\"]'),\n            Fingerprint_matching = countif(MDO_detection.Phish == @'[\"Fingerprint matching\"]'), \n            Mailbox_intelligence_impersonation = countif(MDO_detection.Phish == @'[\"Mailbox intelligence impersonation\"]'),\n            Campaign = countif(MDO_detection.Phish == @'[\"Campaign\"]' or MDO_detection.Malware == @'[\"Campaign\"]') by bin(Timestamp, 1d)\n| project Timestamp, TotalEmailCount, Phish_detection, Malware_detection, Spam_detection,URL_malicious_reputation,URL_detonation_reputation ,URL_detonation,Advanced_filter, General_filter,Spoof_intra_org,Spoof_external_domain,Spoof_DMARC,Impersonation_brand,Impersonation_user,Impersonation_domain,\nMixed_analysis_detection,File_reputation,File_detonation,File_detonation_reputation,Antimalware_engine,Fingerprint_matching,Mailbox_intelligence_impersonation,Campaign\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing malicious email detections by detection methods"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject82')._huntingQuerycontentId82),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 82",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject82')._huntingQuerycontentId82)]",
                "contentId": "[variables('huntingQueryObject82')._huntingQuerycontentId82]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject82').huntingQueryVersion82]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject82')._huntingQuerycontentId82]",
        "contentKind": "HuntingQuery",
        "displayName": "Detections by detection methods",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject82')._huntingQuerycontentId82,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject82')._huntingQuerycontentId82,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject83').huntingQueryTemplateSpecName83]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Mail reply to new domain_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject83').huntingQueryVersion83]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_83",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Mail reply to new domain",
                "category": "Hunting Queries",
                "query": "let emailDelivered = EmailEvents\n| where Timestamp < ago(4hrs)\nand DeliveryAction == \"Delivered\"\n| extend Pair = strcat(SenderMailFromAddress,\"|\",RecipientEmailAddress)\n| distinct Pair;\nlet EmailDomains = EmailEvents\n| where Timestamp < ago(4hrs)\nand DeliveryAction == \"Delivered\"\n| distinct SenderFromDomain;\nEmailEvents \n| where Timestamp >= ago(4hrs)\n| where DeliveryLocation != \"Quarantine\"\n and EmailDirection == \"Inbound\" \n and OrgLevelAction != \"Block\"\n and UserLevelAction != \"Block\"\n| extend NewMsg = case(Subject contains \"RE:\", false, Subject contains \"FW:\", false, true )\n| project Pair = strcat(SenderMailFromAddress,\"|\",RecipientEmailAddress), NetworkMessageId, SenderFromDomain, SenderMailFromAddress, RecipientEmailAddress, DeliveryAction, ThreatTypes, DetectionMethods, NewMsg, Subject \n| join kind=leftouter ( emailDelivered ) on Pair\n| order by SenderMailFromAddress\n| where NewMsg == false\nand Pair1 == \"\"\n| join kind=leftouter (EmailDomains) on SenderFromDomain\n| where SenderFromDomain1 == \"\"\n| distinct Pair, NetworkMessageId, SenderFromDomain, SenderMailFromAddress, RecipientEmailAddress, DeliveryAction, ThreatTypes, DetectionMethods, NewMsg, Subject\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing mail that is likely a reply but there is no history of the people chatting and the domain is new"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject83')._huntingQuerycontentId83),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 83",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject83')._huntingQuerycontentId83)]",
                "contentId": "[variables('huntingQueryObject83')._huntingQuerycontentId83]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject83').huntingQueryVersion83]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject83')._huntingQuerycontentId83]",
        "contentKind": "HuntingQuery",
        "displayName": "Mail reply to new domain",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject83')._huntingQuerycontentId83,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject83')._huntingQuerycontentId83,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject84').huntingQueryTemplateSpecName84]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Mailflow by directionality_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject84').huntingQueryVersion84]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_84",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Mailflow by directionality",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where Timestamp > ago(30d)\n| extend domain = substring(RecipientEmailAddress, indexof(RecipientEmailAddress, \"@\")+1) \n| summarize total=count() by EmailDirection, domain, bin(Timestamp, 1d) \n| order by Timestamp asc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing inbound / outbound / intra-org emails by domain per day"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject84')._huntingQuerycontentId84),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 84",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject84')._huntingQuerycontentId84)]",
                "contentId": "[variables('huntingQueryObject84')._huntingQuerycontentId84]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject84').huntingQueryVersion84]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject84')._huntingQuerycontentId84]",
        "contentKind": "HuntingQuery",
        "displayName": "Mailflow by directionality",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject84')._huntingQuerycontentId84,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject84')._huntingQuerycontentId84,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject85').huntingQueryTemplateSpecName85]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Malicious emails detected per day_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject85').huntingQueryVersion85]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_85",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malicious emails detected per day",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where DetectionMethods != \"\" \n| extend detection= parse_json(DetectionMethods) \n| extend Spam = tostring(detection.Spam) \n| extend Phish = tostring(detection.Phish) \n| extend Malware = tostring(detection.Malware) \n| where Spam != '' or Phish != '' or Malware != '' \n| extend detection = case( \n    Malware != \"\", 'Malware', \n    Phish != \"\", 'Phish', \n    'Spam') \n| summarize total=count() by detection, bin(Timestamp, 1d) \n| order by Timestamp asc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing Malware, Phishing, Spam emails caught per day"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject85')._huntingQuerycontentId85),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 85",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject85')._huntingQuerycontentId85)]",
                "contentId": "[variables('huntingQueryObject85')._huntingQuerycontentId85]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject85').huntingQueryVersion85]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject85')._huntingQuerycontentId85]",
        "contentKind": "HuntingQuery",
        "displayName": "Malicious emails detected per day",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject85')._huntingQuerycontentId85,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject85')._huntingQuerycontentId85,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject86').huntingQueryTemplateSpecName86]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Sender recipient contact establishment_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject86').huntingQueryVersion86]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_86",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Sender recipient contact establishment",
                "category": "Hunting Queries",
                "query": "let emailDelivered = EmailEvents\n| where Timestamp < ago(30d)\nand DeliveryAction == \"Delivered\"\nand SenderDisplayName contains \"Microsoft\"\n| summarize count() by SenderFromAddress\n| where count_ > 3 // ensuring that some level of communications has occured.\n| project SenderFromAddress;\nEmailEvents \n| where Timestamp > ago(24hrs)\n| where DeliveryAction == \"Delivered\"\n and EmailDirection == \"Inbound\" \n and OrgLevelAction != \"Block\"\n and UserLevelAction != \"Block\"\n and SenderDisplayName contains \"Microsoft\" //Change the name here\n| extend NewMsg = case(Subject contains \"RE:\", false, Subject contains \"FW:\", false, true )\n| project SenderDisplayName, SenderFromAddress, NetworkMessageId, SenderMailFromAddress, RecipientEmailAddress, DeliveryAction, DeliveryLocation, ThreatTypes, DetectionMethods, NewMsg, Subject \n| join kind=leftanti  ( emailDelivered ) on SenderFromAddress\n| order by SenderMailFromAddress\n| summarize count() by SenderDisplayName, SenderFromAddress, NetworkMessageId, SenderMailFromAddress, RecipientEmailAddress, DeliveryAction, DeliveryLocation, ThreatTypes, DetectionMethods, NewMsg, Subject\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps in checking the sender-recipient contact establishment status"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject86')._huntingQuerycontentId86),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 86",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject86')._huntingQuerycontentId86)]",
                "contentId": "[variables('huntingQueryObject86')._huntingQuerycontentId86]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject86').huntingQueryVersion86]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject86')._huntingQuerycontentId86]",
        "contentKind": "HuntingQuery",
        "displayName": "Sender recipient contact establishment",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject86')._huntingQuerycontentId86,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject86')._huntingQuerycontentId86,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject87').huntingQueryTemplateSpecName87]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam Detections by Delivery Location - High_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject87').huntingQueryVersion87]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_87",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spam Detections (High) by delivery location",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\n| where ConfidenceLevel has_any ('Spam\":\"High')\n| summarize count() by LatestDeliveryLocation\n| sort by count_ desc\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises emails with Spam detections (High confidence) summarizing the data by Delivery Location."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject87')._huntingQuerycontentId87),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 87",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject87')._huntingQuerycontentId87)]",
                "contentId": "[variables('huntingQueryObject87')._huntingQuerycontentId87]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject87').huntingQueryVersion87]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject87')._huntingQuerycontentId87]",
        "contentKind": "HuntingQuery",
        "displayName": "Spam Detections (High) by delivery location",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject87')._huntingQuerycontentId87,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject87')._huntingQuerycontentId87,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject88').huntingQueryTemplateSpecName88]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam Detections by Delivery Location - Medium_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject88').huntingQueryVersion88]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_88",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spam Detections (Normal) by delivery location",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\n| where ConfidenceLevel has_any ('Spam\":\"Normal')\n| summarize count() by LatestDeliveryLocation\n| sort by count_ desc\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises emails with Spam detections (Normal confidence) summarizing the data by Delivery Location."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject88')._huntingQuerycontentId88),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 88",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject88')._huntingQuerycontentId88)]",
                "contentId": "[variables('huntingQueryObject88')._huntingQuerycontentId88]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject88').huntingQueryVersion88]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject88')._huntingQuerycontentId88]",
        "contentKind": "HuntingQuery",
        "displayName": "Spam Detections (Normal) by delivery location",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject88')._huntingQuerycontentId88,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject88')._huntingQuerycontentId88,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject89').huntingQueryTemplateSpecName89]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 100 malicious email senders_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject89').huntingQueryVersion89]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_89",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 100 malicious email senders",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where Timestamp > ago(30d)\n| where ThreatTypes has \"Phish\" or ThreatTypes has \"Malware\" \n| summarize total=count() by SenderMailFromAddress \n| top 100 by total\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing top 100 malicious senders"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject89')._huntingQuerycontentId89),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 89",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject89')._huntingQuerycontentId89)]",
                "contentId": "[variables('huntingQueryObject89')._huntingQuerycontentId89]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject89').huntingQueryVersion89]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject89')._huntingQuerycontentId89]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 100 malicious email senders",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject89')._huntingQuerycontentId89,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject89')._huntingQuerycontentId89,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject90').huntingQueryTemplateSpecName90]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 100 senders_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject90').huntingQueryVersion90]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_90",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 100 senders",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where Timestamp > ago(30d)\n| summarize mailCountBySender = count() by SenderMailFromAddress \n| top 100 by mailCountBySender\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing top 100 senders in your organization in last 30 days"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject90')._huntingQuerycontentId90),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 90",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject90')._huntingQuerycontentId90)]",
                "contentId": "[variables('huntingQueryObject90')._huntingQuerycontentId90]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject90').huntingQueryVersion90]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject90')._huntingQuerycontentId90]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 100 senders",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject90')._huntingQuerycontentId90,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject90')._huntingQuerycontentId90,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject91').huntingQueryTemplateSpecName91]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zero day threats_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject91').huntingQueryVersion91]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_91",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Zero day threats",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where Timestamp > ago(30d) \n| where DetectionMethods has \"URL Detonation\" or DetectionMethods has \"File Detonation\" \n| count\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing zero day threats via URL and file detonations"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject91')._huntingQuerycontentId91),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 91",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject91')._huntingQuerycontentId91)]",
                "contentId": "[variables('huntingQueryObject91')._huntingQuerycontentId91]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject91').huntingQueryVersion91]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject91')._huntingQuerycontentId91]",
        "contentKind": "HuntingQuery",
        "displayName": "Zero day threats",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject91')._huntingQuerycontentId91,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject91')._huntingQuerycontentId91,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject92').huntingQueryTemplateSpecName92]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Email containing malware accessed on a unmanaged device_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject92').huntingQueryVersion92]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_92",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Email containing malware accessed on a unmanaged device",
                "category": "Hunting Queries",
                "query": "EmailPostDeliveryEvents\n| where ActionType == \"Malware ZAP\"\n| project NetworkMessageId,InternetMessageId,ActionType,ThreatTypes,DetectionMethods,ZAPReportId=ReportId,ZAPTimestamp=Timestamp\n| join (CloudAppEvents | where ActionType == \"MailItemsAccessed\"\n| extend RawEvent=parse_json(RawEventData)\n| mv-expand RawEvent.Folders\n| mv-expand RawEvent_Folders.FolderItems\n| project SessionId=tostring(RawEvent.SessionId),InternetMessageId=tostring(parse_json(RawEvent_Folders_FolderItems).InternetMessageId),ActionTimestamp=Timestamp,ActionReportId=ReportId\n) on InternetMessageId\n| where isnotempty(SessionId)\n| join (AADSignInEventsBeta | where isempty(DeviceName) | distinct AccountUpn,SessionId) on SessionId\n| project AccountUpn,NetworkMessageId,InternetMessageId,ActionType,ThreatTypes,DetectionMethods,SessionId,ReportId=ActionReportId,Timestamp=ActionTimestamp\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this query, we are looking for emails containing malware accessed on a unmanaged device"
                  },
                  {
                    "name": "tactics",
                    "value": "Execution"
                  },
                  {
                    "name": "techniques",
                    "value": "T1204"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject92')._huntingQuerycontentId92),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 92",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject92')._huntingQuerycontentId92)]",
                "contentId": "[variables('huntingQueryObject92')._huntingQuerycontentId92]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject92').huntingQueryVersion92]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject92')._huntingQuerycontentId92]",
        "contentKind": "HuntingQuery",
        "displayName": "Email containing malware accessed on a unmanaged device",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject92')._huntingQuerycontentId92,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject92')._huntingQuerycontentId92,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject93').huntingQueryTemplateSpecName93]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Email containing malware sent by an internal sender_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject93').huntingQueryVersion93]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_93",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Email containing malware sent by an internal sender",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Intra-org\" or EmailDirection == \"Outbound\"\n| where ThreatTypes == \"Malware\" and SenderFromAddress !startswith \"postmaster@\" and SenderFromAddress !startswith \"microsoftexchange\"\n| join (EmailAttachmentInfo | where isnotempty(ThreatTypes)) on NetworkMessageId\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this query, we are looking for emails containing malware attachment sent by an internal sender"
                  },
                  {
                    "name": "tactics",
                    "value": "LateralMovement"
                  },
                  {
                    "name": "techniques",
                    "value": "T1534"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject93')._huntingQuerycontentId93),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 93",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject93')._huntingQuerycontentId93)]",
                "contentId": "[variables('huntingQueryObject93')._huntingQuerycontentId93]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject93').huntingQueryVersion93]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject93')._huntingQuerycontentId93]",
        "contentKind": "HuntingQuery",
        "displayName": "Email containing malware sent by an internal sender",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject93')._huntingQuerycontentId93,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject93')._huntingQuerycontentId93,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject94').huntingQueryTemplateSpecName94]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Email malware detection report_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject94').huntingQueryVersion94]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_94",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Email malware detection report",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where Timestamp > ago(30d)\n| where isnotempty(ThreatNames)\n| join kind=inner EmailAttachmentInfo on NetworkMessageId \n| extend ThreatFamilyAttachment = strcat(format_datetime(Timestamp,'yyyy-M-dd H:mm:ss'), \" /\", ThreatNames, \" /\", FileName, \" /\", NetworkMessageId)\n| summarize ThreatFamily_wih_Attachment= make_list(ThreatFamilyAttachment) by RecipientEmailAddress\n| extend Case = array_length(ThreatFamily_wih_Attachment)\n| project RecipientEmailAddress, Case, ThreatFamily_wih_Attachment \n| sort by Case desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing email malware detection cases"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject94')._huntingQuerycontentId94),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 94",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject94')._huntingQuerycontentId94)]",
                "contentId": "[variables('huntingQueryObject94')._huntingQuerycontentId94]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject94').huntingQueryVersion94]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject94')._huntingQuerycontentId94]",
        "contentKind": "HuntingQuery",
        "displayName": "Email malware detection report",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject94')._huntingQuerycontentId94,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject94')._huntingQuerycontentId94,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject95').huntingQueryTemplateSpecName95]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "File Malware Detection Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject95').huntingQueryVersion95]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_95",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "File Malware Detection Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nCloudAppEvents\n| where TimeGenerated >= TimeStart\n| where ActionType == 'FileMalwareDetected'\n| make-series Count = count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total files located on SharePoint, OneDrive and Teams with Malware detections over time summarizing the data daily."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject95')._huntingQuerycontentId95),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 95",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject95')._huntingQuerycontentId95)]",
                "contentId": "[variables('huntingQueryObject95')._huntingQuerycontentId95]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject95').huntingQueryVersion95]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject95')._huntingQuerycontentId95]",
        "contentKind": "HuntingQuery",
        "displayName": "File Malware Detection Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject95')._huntingQuerycontentId95,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject95')._huntingQuerycontentId95,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject96').huntingQueryTemplateSpecName96]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "File Malware Top Families by AV_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject96').huntingQueryVersion96]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_96",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "File Malware by Top Malware Families (Anti Virus)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == 'FileMalwareDetected' and isempty(UserAgent)\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_\n| render piechart\n// | render columnchart // Uncomment to change the graph type\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total Malware detections of files located on SharePoint, OneDrive and Teams over time summarizing the data by the various Malware families detected focusing on built-in SharePoint AV detections"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject96')._huntingQuerycontentId96),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 96",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject96')._huntingQuerycontentId96)]",
                "contentId": "[variables('huntingQueryObject96')._huntingQuerycontentId96]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject96').huntingQueryVersion96]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject96')._huntingQuerycontentId96]",
        "contentKind": "HuntingQuery",
        "displayName": "File Malware by Top Malware Families (Anti Virus)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject96')._huntingQuerycontentId96,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject96')._huntingQuerycontentId96,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject97').huntingQueryTemplateSpecName97]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "File Malware Top Families by Safe Attachments_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject97').huntingQueryVersion97]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_97",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "File Malware by Top Malware Families (Safe Attachments)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == 'FileMalwareDetected' and UserAgent =~ 'MS Scanner ATP'\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_\n| render piechart\n// | render columnchart // Uncomment to change the graph type\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total Malware detections of files located on SharePoint, OneDrive and Teams over time summarizing the data by the various Malware families detected focusing on Defender for Office 365 detections (detonations)"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject97')._huntingQuerycontentId97),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 97",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject97')._huntingQuerycontentId97)]",
                "contentId": "[variables('huntingQueryObject97')._huntingQuerycontentId97]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject97').huntingQueryVersion97]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject97')._huntingQuerycontentId97]",
        "contentKind": "HuntingQuery",
        "displayName": "File Malware by Top Malware Families (Safe Attachments)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject97')._huntingQuerycontentId97,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject97')._huntingQuerycontentId97,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject98').huntingQueryTemplateSpecName98]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Malware Detection Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject98').huntingQueryVersion98]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_98",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malware Detections Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nEmailEvents\n| where TimeGenerated >= TimeStart\n| where ThreatTypes has \"Malware\"\n| make-series MalwareDetections = count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Malware detections over time summarizing the data daily."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject98')._huntingQuerycontentId98),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 98",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject98')._huntingQuerycontentId98)]",
                "contentId": "[variables('huntingQueryObject98')._huntingQuerycontentId98]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject98').huntingQueryVersion98]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject98')._huntingQuerycontentId98]",
        "contentKind": "HuntingQuery",
        "displayName": "Malware Detections Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject98')._huntingQuerycontentId98,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject98')._huntingQuerycontentId98,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject99').huntingQueryTemplateSpecName99]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Malware Detections by Delivery Location_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject99').huntingQueryVersion99]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_99",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malware Detections by delivery location",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nEmailEvents\n| where TimeGenerated >= TimeStart\n| where DetectionMethods has \"Malware\" and EmailDirection == \"Inbound\"\n| make-series TotalMalwareDetections=count(),Quarantine = countif(DeliveryLocation == \"Quarantine\"), Failed=countif(DeliveryLocation == \"Failed\") default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Malware detections over time summarizing the data daily by Delivery Location."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject99')._huntingQuerycontentId99),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 99",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject99')._huntingQuerycontentId99)]",
                "contentId": "[variables('huntingQueryObject99')._huntingQuerycontentId99]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject99').huntingQueryVersion99]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject99')._huntingQuerycontentId99]",
        "contentKind": "HuntingQuery",
        "displayName": "Malware Detections by delivery location",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject99')._huntingQuerycontentId99,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject99')._huntingQuerycontentId99,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject100').huntingQueryTemplateSpecName100]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Malware Detections by Detection Technology Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject100').huntingQueryVersion100]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_100",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malware Detections by Detection technology Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = EmailEvents\n| where TimeGenerated >= TimeStart\n| where DetectionMethods has \"Malware\";\nlet av=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Malware has 'Antimalware engine'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Antimalware engine\";\nlet fd=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Malware has 'File detonation' and Malware !has 'File detonation reputation'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"File detonation\";\nlet fdr=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Malware has 'File detonation reputation'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"File detonation reputation\";\nlet ud=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Malware has 'URL detonation' and Malware !has 'URL detonation reputation'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"URL detonation\";\nlet udr=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Malware has 'URL detonation reputation' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"URL detonation reputation\";\nlet umr=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Malware has 'URL malicious reputation' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"URL malicious reputation\";\nunion av,fd,fdr,ud,udr,umr\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Malware detections over time summarizing the data daily by various Malware detection technologies/controls."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject100')._huntingQuerycontentId100),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 100",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject100')._huntingQuerycontentId100)]",
                "contentId": "[variables('huntingQueryObject100')._huntingQuerycontentId100]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject100').huntingQueryVersion100]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject100')._huntingQuerycontentId100]",
        "contentKind": "HuntingQuery",
        "displayName": "Malware Detections by Detection technology Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject100')._huntingQuerycontentId100,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject100')._huntingQuerycontentId100,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject101').huntingQueryTemplateSpecName101]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Malware Detections by Detection Technology_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject101').huntingQueryVersion101]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_101",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malware Detections by Detection technology",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where DetectionMethods has 'Malware' \n| project Timestamp, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) | summarize count() by Malware=tostring(column_ifexists('Malware', ''))\n| sort by count_ desc\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Malware detections summarizing the data by various Malware detection technologies/controls."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject101')._huntingQuerycontentId101),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 101",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject101')._huntingQuerycontentId101)]",
                "contentId": "[variables('huntingQueryObject101')._huntingQuerycontentId101]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject101').huntingQueryVersion101]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject101')._huntingQuerycontentId101]",
        "contentKind": "HuntingQuery",
        "displayName": "Malware Detections by Detection technology",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject101')._huntingQuerycontentId101,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject101')._huntingQuerycontentId101,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject102').huntingQueryTemplateSpecName102]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Malware detections by Workload Locations_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject102').huntingQueryVersion102]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_102",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malware detections by Workload Locations",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == 'FileMalwareDetected'\n| project location=(split(RawEventData.SiteUrl, '/')[4])\n| summarize count() by tostring(location)\n| sort by count_ desc\n| render columnchart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the amount of total Malware detections of files located on SharePoint, OneDrive and Teams, summarizing by the locations they are stored"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject102')._huntingQuerycontentId102),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 102",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject102')._huntingQuerycontentId102)]",
                "contentId": "[variables('huntingQueryObject102')._huntingQuerycontentId102]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject102').huntingQueryVersion102]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject102')._huntingQuerycontentId102]",
        "contentKind": "HuntingQuery",
        "displayName": "Malware detections by Workload Locations",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject102')._huntingQuerycontentId102,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject102')._huntingQuerycontentId102,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject103').huntingQueryTemplateSpecName103]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Malware detections by Workload Type_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject103').huntingQueryVersion103]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_103",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malware detections by Workload Type",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == 'FileMalwareDetected'\n| extend Appwithteams = iff(Application =~ 'Microsoft SharePoint Online',strcat(Application,' / Teams Files'),Application)\n| extend Appwithteams = trim_start('Microsoft',Appwithteams) | summarize count() by Appwithteams\n| sort by count_ desc\n| render piechart\n// | render columnchart // Uncomment to change the graph type\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the amount of total Malware detections of files located on SharePoint, OneDrive and Teams, summarizing by the workload in which they are stored"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject103')._huntingQuerycontentId103),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 103",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject103')._huntingQuerycontentId103)]",
                "contentId": "[variables('huntingQueryObject103')._huntingQuerycontentId103]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject103').huntingQueryVersion103]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject103')._huntingQuerycontentId103]",
        "contentKind": "HuntingQuery",
        "displayName": "Malware detections by Workload Type",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject103')._huntingQuerycontentId103,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject103')._huntingQuerycontentId103,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject104').huntingQueryTemplateSpecName104]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top Domains sending Malware_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject104').huntingQueryVersion104]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_104",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Email Top Domains sending Malware",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where ThreatTypes has \"Malware\" and EmailDirection == \"Inbound\"\n| summarize count() by SenderFromDomain\n| sort by count_\n| top 15 by count_\n//| render columnchart // Uncomment to display as a column graph\n//| render piechart // Uncomment to display as a piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total inbound emails with Malware detections summarizing the data by the top email sender P2 domain (SenderFromDomain)"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject104')._huntingQuerycontentId104),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 104",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject104')._huntingQuerycontentId104)]",
                "contentId": "[variables('huntingQueryObject104')._huntingQuerycontentId104]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject104').huntingQueryVersion104]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject104')._huntingQuerycontentId104]",
        "contentKind": "HuntingQuery",
        "displayName": "Email Top Domains sending Malware",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject104')._huntingQuerycontentId104,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject104')._huntingQuerycontentId104,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject105').huntingQueryTemplateSpecName105]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top Email Malware Families_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject105').huntingQueryVersion105]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_105",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top Malware Families",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where isnotempty(ThreatNames) and ThreatTypes has \"Malware\" \n| summarize count() by ThreatNames \n| project ThreatNames,Emails=count_\n| sort by Emails\n//| render piechart // Uncomment to display as a piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Malware detections summarizing the data by ThreatNames of the malware detected."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject105')._huntingQuerycontentId105),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 105",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject105')._huntingQuerycontentId105)]",
                "contentId": "[variables('huntingQueryObject105')._huntingQuerycontentId105]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject105').huntingQueryVersion105]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject105')._huntingQuerycontentId105]",
        "contentKind": "HuntingQuery",
        "displayName": "Top Malware Families",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject105')._huntingQuerycontentId105,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject105')._huntingQuerycontentId105,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject106').huntingQueryTemplateSpecName106]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top Users receiving Malware_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject106').huntingQueryVersion106]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_106",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top Users receiving Malware",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where ThreatTypes has \"Malware\" and EmailDirection == \"Inbound\"\n| summarize count() by RecipientEmailAddress\n| sort by count_\n| top 15 by count_\n//| render columnchart // Uncomment to display as a column graph\n//| render piechart // Uncomment to display as a piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total inbound emails with Malware detections summarizing the data by the top recipient email address (RecipientEmailAddress)"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject106')._huntingQuerycontentId106),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 106",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject106')._huntingQuerycontentId106)]",
                "contentId": "[variables('huntingQueryObject106')._huntingQuerycontentId106]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject106').huntingQueryVersion106]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject106')._huntingQuerycontentId106]",
        "contentKind": "HuntingQuery",
        "displayName": "Top Users receiving Malware",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject106')._huntingQuerycontentId106,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject106')._huntingQuerycontentId106,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject107').huntingQueryTemplateSpecName107]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zero-day Malware Detections Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject107').huntingQueryVersion107]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_107",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Zero-day Malware Detections Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = EmailEvents\n| where TimeGenerated >= TimeStart\n| where DetectionMethods has \"Malware\";\nlet fd=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Malware has 'File detonation' and Malware !has 'File detonation reputation'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"File detonation\";\nlet ud=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Malware has 'URL detonation' and Malware !has 'URL detonation reputation'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"URL detonation\";\nunion fd,ud\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Malware detections over time summarizing the data daily by Malware detection technologies/controls used for detecting unknown-unique malware."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject107')._huntingQuerycontentId107),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 107",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject107')._huntingQuerycontentId107)]",
                "contentId": "[variables('huntingQueryObject107')._huntingQuerycontentId107]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject107').huntingQueryVersion107]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject107')._huntingQuerycontentId107]",
        "contentKind": "HuntingQuery",
        "displayName": "Zero-day Malware Detections Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject107')._huntingQuerycontentId107,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject107')._huntingQuerycontentId107,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject108').huntingQueryTemplateSpecName108]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Communication from suspicious external users_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject108').huntingQueryVersion108]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_108",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams communication from suspicious external users",
                "category": "Hunting Queries",
                "query": "//This query uses MessageEvents to detect communication from suspicious external Help Desk\\Support representatives\nMessageEvents \n| where Timestamp > ago(30d) \n| where (SenderDisplayName contains \"help\" and SenderDisplayName contains \"desk\") \n  or (SenderDisplayName contains \"it\" and SenderDisplayName contains \"support\") \n  or (SenderDisplayName contains \"working\" and SenderDisplayName contains \"home\") \n| where IsExternalThread == true \n| project Timestamp, SenderDisplayName, SenderEmailAddress, RecipientDetails, IsOwnedThread, ThreadType\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for communication from suspicious external users."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject108')._huntingQuerycontentId108),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 108",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject108')._huntingQuerycontentId108)]",
                "contentId": "[variables('huntingQueryObject108')._huntingQuerycontentId108]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject108').huntingQueryVersion108]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject108')._huntingQuerycontentId108]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams communication from suspicious external users",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject108')._huntingQuerycontentId108,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject108')._huntingQuerycontentId108,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject109').huntingQueryTemplateSpecName109]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Communication to suspicious external users_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject109').huntingQueryVersion109]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_109",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams communication to suspicious external users",
                "category": "Hunting Queries",
                "query": "//This query uses MessageEvents to detect bi-directional outbound communication to suspicious external Help Desk\\Support representatives\nMessageEvents \n| where Timestamp > ago(30d) \n| where (RecipientDetails contains \"help\" and RecipientDetails contains \"desk\") \n  or (RecipientDetails contains \"it\" and RecipientDetails contains \"support\") \n  or (RecipientDetails contains \"working\" and RecipientDetails contains \"home\") \n| where IsExternalThread == true \n| project Timestamp, SenderDisplayName, SenderEmailAddress, RecipientDetails, IsOwnedThread, ThreadType\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for communication with suspicious external users."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject109')._huntingQuerycontentId109),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 109",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject109')._huntingQuerycontentId109)]",
                "contentId": "[variables('huntingQueryObject109')._huntingQuerycontentId109]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject109').huntingQueryVersion109]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject109')._huntingQuerycontentId109]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams communication to suspicious external users",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject109')._huntingQuerycontentId109,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject109')._huntingQuerycontentId109,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject110').huntingQueryTemplateSpecName110]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Expanding recipients into separate rows_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject110').huntingQueryVersion110]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_110",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Expanding recipients into separate rows",
                "category": "Hunting Queries",
                "query": "//Analyzing recipient details with a separate row for each recipient\nMessageEvents\n| mv-expand Recipients = RecipientDetails\n| extend RecipientSmtpAddress = Recipients.RecipientSmtpAddress, RecipientDisplayName = Recipients.RecipientDisplayName, RecipientObjectId = Recipients.RecipientObjectId, RecipientType = Recipients.RecipientType\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for recipients of Teams messages."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject110')._huntingQuerycontentId110),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 110",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject110')._huntingQuerycontentId110)]",
                "contentId": "[variables('huntingQueryObject110')._huntingQuerycontentId110]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject110').huntingQueryVersion110]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject110')._huntingQuerycontentId110]",
        "contentKind": "HuntingQuery",
        "displayName": "Expanding recipients into separate rows",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject110')._huntingQuerycontentId110,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject110')._huntingQuerycontentId110,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject111').huntingQueryTemplateSpecName111]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "External malicious Teams messages sent from internal senders_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject111').huntingQueryVersion111]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_111",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "External malicious Teams messages sent from internal senders",
                "category": "Hunting Queries",
                "query": "//This query helps hunt for Teams messages from internal senders with Threats in them (Spam, Phish, Malware)\nMessageEvents \n| where Timestamp > ago(30d)\n| where IsExternalThread==1 and IsOwnedThread==1\n| where ThreatTypes has_any (\"Phish\",\"Malware\",\"Spam\")                    \n| project Timestamp,TeamsMessageId, SenderDisplayName, SenderEmailAddress, RecipientDetails, IsOwnedThread, ThreadType, IsExternalThread, ReportId, ThreatTypes, DetectionMethods\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for external malicious Teams messages sent from internal senders"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject111')._huntingQuerycontentId111),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 111",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject111')._huntingQuerycontentId111)]",
                "contentId": "[variables('huntingQueryObject111')._huntingQuerycontentId111]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject111').huntingQueryVersion111]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject111')._huntingQuerycontentId111]",
        "contentKind": "HuntingQuery",
        "displayName": "External malicious Teams messages sent from internal senders",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject111')._huntingQuerycontentId111,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject111')._huntingQuerycontentId111,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject112').huntingQueryTemplateSpecName112]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Hunt for malicious messages using External Threat Intelligence_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject112').huntingQueryVersion112]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_112",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Hunt for malicious messages using External Threat Intelligence",
                "category": "Hunting Queries",
                "query": "// This query helps hunt for Teams messages with malicious URLs based on external IOC source\nlet url = (externaldata(url: string )\n[@\"https://urlhaus.abuse.ch/downloads/text_online/\"]\nwith (format=\"txt\"))\n| project url;\nurl\n| join (MessageUrlInfo\n| where Timestamp > ago(14d) \n) on $left.url == $right.Url\n|join MessageEvents on TeamsMessageId\n//|join UrlClickEvents on Url\n|project Timestamp, TeamsMessageId, Url, UrlDomain, SenderEmailAddress, SenderDisplayName, RecipientDetails,ThreatTypes, DetectionMethods, DeliveryAction,IsExternalThread, IsOwnedThread//, AccountUpn, ActionType, AppName, AppVersion, Workload\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for Teams messages with malicious URLs based on external Threat Intelligence source"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject112')._huntingQuerycontentId112),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 112",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject112')._huntingQuerycontentId112)]",
                "contentId": "[variables('huntingQueryObject112')._huntingQuerycontentId112]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject112').huntingQueryVersion112]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject112')._huntingQuerycontentId112]",
        "contentKind": "HuntingQuery",
        "displayName": "Hunt for malicious messages using External Threat Intelligence",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject112')._huntingQuerycontentId112,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject112')._huntingQuerycontentId112,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject113').huntingQueryTemplateSpecName113]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Inbound Teams messages by sender domains_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject113').huntingQueryVersion113]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_113",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Inbound Teams messages by sender domains",
                "category": "Hunting Queries",
                "query": "//This query helps reviewing volume of inbound external Teams message by sender domains\n MessageEvents \n | where IsExternalThread==1 and IsOwnedThread==1\n | mv-expand Recipients = RecipientDetails\n | extend RecipientEmailAddress = Recipients.RecipientSmtpAddress, RecipientDisplayName = Recipients.RecipientDisplayName, RecipientObjectId = Recipients.RecipientObjectId, RecipientType = Recipients.RecipientType\n | extend Domain = substring(RecipientEmailAddress, indexof(RecipientEmailAddress, \"@\")+1)\n | summarize total=count() by Domain, bin(Timestamp, 1d) \n | order by Timestamp asc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing volume of inbound external Teams message by sender domains"
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject113')._huntingQuerycontentId113),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 113",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject113')._huntingQuerycontentId113)]",
                "contentId": "[variables('huntingQueryObject113')._huntingQuerycontentId113]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject113').huntingQueryVersion113]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject113')._huntingQuerycontentId113]",
        "contentKind": "HuntingQuery",
        "displayName": "Inbound Teams messages by sender domains",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject113')._huntingQuerycontentId113,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject113')._huntingQuerycontentId113,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject114').huntingQueryTemplateSpecName114]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Malicious Teams messages by URL detection methods_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject114').huntingQueryVersion114]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_114",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malicious Teams messages by URL detection methods",
                "category": "Hunting Queries",
                "query": "//This query helps reviewing malicious Teams message detections by URL detection methods\nMessageEvents\n| where isnotempty(DetectionMethods)\n| extend MDO_detection = parse_json(DetectionMethods)\n| summarize TotalMessageCount = count(),\n           Phish_detection = countif(isnotempty(MDO_detection.Phish)),\n           Malware_detection = countif(isnotempty(MDO_detection.Malware)),\n           URL_malicious_reputation = countif(MDO_detection.Phish == @'[\"URL malicious reputation\"]' or MDO_detection.Malware == @'[\"URL malicious reputation\"]'),\n           URL_detonation_reputation = countif(MDO_detection.Phish == @'[\"URL detonation reputation\"]' or MDO_detection.Malware == @'[\"URL detonation reputation\"]')\n           by bin(Timestamp, 1d)\n| project Timestamp, Phish_detection, Malware_detection,URL_malicious_reputation,URL_detonation_reputation\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing malicious Teams message detections by URL detection methods"
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject114')._huntingQuerycontentId114),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 114",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject114')._huntingQuerycontentId114)]",
                "contentId": "[variables('huntingQueryObject114')._huntingQuerycontentId114]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject114').huntingQueryVersion114]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject114')._huntingQuerycontentId114]",
        "contentKind": "HuntingQuery",
        "displayName": "Malicious Teams messages by URL detection methods",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject114')._huntingQuerycontentId114,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject114')._huntingQuerycontentId114,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject115').huntingQueryTemplateSpecName115]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Malicious Teams messages received from external senders_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject115').huntingQueryVersion115]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_115",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malicious Teams messages received from external senders",
                "category": "Hunting Queries",
                "query": "//This query helps hunt for Teams messages from external senders with Threats (Spam, Phish, Malware)\nMessageEvents \n| where Timestamp > ago(30d)\n| where IsExternalThread==1 and IsOwnedThread==0\n| where ThreatTypes has_any (\"Phish\",\"Malware\",\"Spam\")                    \n| project Timestamp,TeamsMessageId, SenderDisplayName, SenderEmailAddress, RecipientDetails, IsOwnedThread, ThreadType, IsExternalThread, ReportId, ThreatTypes, DetectionMethods\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for malicious Teams messages received from external senders."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject115')._huntingQuerycontentId115),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 115",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject115')._huntingQuerycontentId115)]",
                "contentId": "[variables('huntingQueryObject115')._huntingQuerycontentId115]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject115').huntingQueryVersion115]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject115')._huntingQuerycontentId115]",
        "contentKind": "HuntingQuery",
        "displayName": "Malicious Teams messages received from external senders",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject115')._huntingQuerycontentId115,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject115')._huntingQuerycontentId115,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject116').huntingQueryTemplateSpecName116]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Microsoft Teams chat initiated by a suspicious external user_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject116').huntingQueryVersion116]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_116",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Microsoft Teams chat initiated by a suspicious external user",
                "category": "Hunting Queries",
                "query": "//Use AlertInfo and AlertEvidence to collect general information and clickable links to more IOCs about suspicious external  Teams messages\nAlertInfo \n| where Timestamp >= ago(30d) \n| where Title == \"Microsoft Teams chat initiated by a suspicious external user\" \n| join AlertEvidence on AlertId\n| top 100 by Timestamp\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Use AlertInfo and AlertEvidence to collect general information and clickable links to more IOCs about suspicious external Teams messages."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject116')._huntingQuerycontentId116),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 116",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject116')._huntingQuerycontentId116)]",
                "contentId": "[variables('huntingQueryObject116')._huntingQuerycontentId116]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject116').huntingQueryVersion116]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject116')._huntingQuerycontentId116]",
        "contentKind": "HuntingQuery",
        "displayName": "Microsoft Teams chat initiated by a suspicious external user",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject116')._huntingQuerycontentId116,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject116')._huntingQuerycontentId116,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject117').huntingQueryTemplateSpecName117]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Number of unique accounts performing Teams message Admin submissions_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject117').huntingQueryVersion117]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_117",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Number of unique accounts performing Teams message Admin submissions",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminSubmissionSubmitted\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),SubmittedBy=tostring((parse_json(RawEventData)).UserId)\n| where SubmissionContentType == \"ChatMessage\" and SubmissionType in (\"1\",\"2\",\"3\")\n| summarize dcount(SubmittedBy) \n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises number of unqiue accounts performing Teams message admin submissions as false negatives or false positives"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject117')._huntingQuerycontentId117),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 117",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject117')._huntingQuerycontentId117)]",
                "contentId": "[variables('huntingQueryObject117')._huntingQuerycontentId117]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject117').huntingQueryVersion117]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject117')._huntingQuerycontentId117]",
        "contentKind": "HuntingQuery",
        "displayName": "Number of unique accounts performing Teams message Admin submissions",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject117')._huntingQuerycontentId117,'-', 'l.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject117')._huntingQuerycontentId117,'-', 'l.0.0')))]",
        "version": "l.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject118').huntingQueryTemplateSpecName118]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Number of unique accounts performing Teams message User  submissions_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject118').huntingQueryVersion118]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_118",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Number of unique accounts performing Teams message User  submissions",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"UserSubmission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),SubmittedBy=tostring((parse_json(RawEventData)).UserId)\n| where SubmissionContentType == \"ChatMessage\"\n| summarize dcount(SubmittedBy) \n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises number of unqiue accounts performing Teams message user submissions as false negatives or false positives"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject118')._huntingQuerycontentId118),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 118",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject118')._huntingQuerycontentId118)]",
                "contentId": "[variables('huntingQueryObject118')._huntingQuerycontentId118]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject118').huntingQueryVersion118]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject118')._huntingQuerycontentId118]",
        "contentKind": "HuntingQuery",
        "displayName": "Number of unique accounts performing Teams message User  submissions",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject118')._huntingQuerycontentId118,'-', 'l.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject118')._huntingQuerycontentId118,'-', 'l.0.0')))]",
        "version": "l.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject119').huntingQueryTemplateSpecName119]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Possible partner impersonation in external Team messages_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject119').huntingQueryVersion119]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_119",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Possible partner impersonation in external Team messages",
                "category": "Hunting Queries",
                "query": "//This query can be used as a Custom Detection Rule (CDR) to trigger when a partner email domain or email address is used in a Sender display name part of an inbound external Teams message\n MessageEvents \n | where IsOwnedThread==0 and IsExternalThread==1 and SenderDisplayName contains \"@contoso.com\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query can be used as a Custom Detection Rule (CDR) to trigger when a partner email domain or email address is used in a Sender display name part of an inbound external Teams message"
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject119')._huntingQuerycontentId119),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 119",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject119')._huntingQuerycontentId119)]",
                "contentId": "[variables('huntingQueryObject119')._huntingQuerycontentId119]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject119').huntingQueryVersion119]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject119')._huntingQuerycontentId119]",
        "contentKind": "HuntingQuery",
        "displayName": "Possible partner impersonation in external Team messages",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject119')._huntingQuerycontentId119,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject119')._huntingQuerycontentId119,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject120').huntingQueryTemplateSpecName120]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Possible Teams phishing activity_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject120').huntingQueryVersion120]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_120",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Possible Teams phishing activity",
                "category": "Hunting Queries",
                "query": "let suspiciousUpns = DeviceProcessEvents\n| where DeviceId == \"alertedMachine\"\n| where isnotempty(InitiatingProcessAccountUpn)\n| project InitiatingProcessAccountUpn;\nCloudAppEvents\n| where Application == \"Microsoft Teams\"\n| where ActionType == \"ChatCreated\"\n| where isempty(AccountObjectId)\n| where RawEventData.ParticipantInfo.HasForeignTenantUsers == true\n| where RawEventData.CommunicationType == \"OneonOne\"\n| where RawEventData.ParticipantInfo.HasGuestUsers == false\n| where RawEventData.ParticipantInfo.HasOtherGuestUsers == false\n| where RawEventData.Members[0].DisplayName in (\"Microsoft  Security\", \"Help Desk\", \"Help Desk Team\", \"Help Desk IT\", \"Microsoft Security\", \"office\")\n| where AccountId has \"@\"\n| extend TargetUPN = tolower(tostring(RawEventData.Members[1].UPN))\n| where TargetUPN in (suspiciousUpns)\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query looks for possible Teams phishing activity."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject120')._huntingQuerycontentId120),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 120",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject120')._huntingQuerycontentId120)]",
                "contentId": "[variables('huntingQueryObject120')._huntingQuerycontentId120]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject120').huntingQueryVersion120]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject120')._huntingQuerycontentId120]",
        "contentKind": "HuntingQuery",
        "displayName": "Possible Teams phishing activity",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject120')._huntingQuerycontentId120,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject120')._huntingQuerycontentId120,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject121').huntingQueryTemplateSpecName121]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Potentially malicious URL click in Teams_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject121').huntingQueryVersion121]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_121",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Potentially malicious URL click in Teams",
                "category": "Hunting Queries",
                "query": "//This query provides insights on a potentially malicious URL click in Teams\nMessagePostDeliveryEvents\n| join MessageUrlInfo on TeamsMessageId\n| join UrlClickEvents on Url\n| where Workload == \"Teams\" and ActionType1==\"ClickAllowed\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query provides insights on a potentially malicious URL click in Teams"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject121')._huntingQuerycontentId121),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 121",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject121')._huntingQuerycontentId121)]",
                "contentId": "[variables('huntingQueryObject121')._huntingQuerycontentId121]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject121').huntingQueryVersion121]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject121')._huntingQuerycontentId121]",
        "contentKind": "HuntingQuery",
        "displayName": "Potentially malicious URL click in Teams",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject121')._huntingQuerycontentId121,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject121')._huntingQuerycontentId121,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject122').huntingQueryTemplateSpecName122]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Rare Domains in External Teams Messages_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject122').huntingQueryVersion122]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_122",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Rare Domains in External Teams Messages",
                "category": "Hunting Queries",
                "query": "let lookback = 1d;\n// External Teams messages \nlet externalMsgs =\n  MessageEvents\n  | where Timestamp > ago(lookback) and IsExternalThread == true\n  | project MsgTime = Timestamp, TeamsMessageId, SenderEmailAddress, ME_ReportId = ReportId;\n// URLs found in Teams messages \nlet urlsInMsgs =\n  MessageUrlInfo\n  | where Timestamp > ago(lookback)\n  | project MUI_Time = Timestamp, TeamsMessageId, Url, UrlDomain, MUI_ReportId = ReportId;\n// Clicks coming from Teams \nlet clicks =\n  UrlClickEvents\n  | where Timestamp > ago(lookback) and Workload == \"Teams\"\n  | project ClickTime = Timestamp, Url, Clicker = AccountUpn, ClickAction = ActionType, UCE_ReportId = ReportId;\n// Define \"rare\" domains in the period \nlet rareDomains =\n  urlsInMsgs\n  | summarize msgCount = dcount(TeamsMessageId) by UrlDomain\n  | where msgCount < 3;\nrareDomains\n  | join kind=inner (urlsInMsgs) on UrlDomain\n  | join kind=leftouter (externalMsgs) on TeamsMessageId\n  | join kind=leftouter (clicks) on Url\n  | project\n      Timestamp = coalesce(ClickTime, MUI_Time, MsgTime),\n      UrlDomain,\n      Url,\n      SenderEmailAddress,\n      Clicker,\n      ClickTime,\n      ClickAction,\n      TeamsMessageId,\n      ReportId = coalesce(UCE_ReportId, MUI_ReportId, ME_ReportId)\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Detects rare domains (seen in fewer than 3 Teams messages) appearing in external Microsoft Teams threads within the last 24 hours."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess,Execution"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566,T1204"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject122')._huntingQuerycontentId122),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 122",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject122')._huntingQuerycontentId122)]",
                "contentId": "[variables('huntingQueryObject122')._huntingQuerycontentId122]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject122').huntingQueryVersion122]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject122')._huntingQuerycontentId122]",
        "contentKind": "HuntingQuery",
        "displayName": "Rare Domains in External Teams Messages",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject122')._huntingQuerycontentId122,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject122')._huntingQuerycontentId122,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject123').huntingQueryTemplateSpecName123]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Suspicious Teams Display Name_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject123').huntingQueryVersion123]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_123",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Suspicious Teams Display Name",
                "category": "Hunting Queries",
                "query": "let SuspiciousDisplayNames = pack_array(\"Microsoft  Security\", \"Help Desk\", \"Help Desk Team\", \"Help Desk IT\", \"Microsoft Security\", \"IT Support\", \"Helpdesk\");\nMessageEvents\n| where IsExternalThread == 1 and IsOwnedThread == 0\n| where SenderDisplayName has_any (SuspiciousDisplayNames)\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query looks for Teams messages from an external user with a suspicious display name."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject123')._huntingQuerycontentId123),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 123",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject123')._huntingQuerycontentId123)]",
                "contentId": "[variables('huntingQueryObject123')._huntingQuerycontentId123]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject123').huntingQueryVersion123]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject123')._huntingQuerycontentId123]",
        "contentKind": "HuntingQuery",
        "displayName": "Suspicious Teams Display Name",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject123')._huntingQuerycontentId123,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject123')._huntingQuerycontentId123,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject124').huntingQueryTemplateSpecName124]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams Admin submission of Malware and Phish daily trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject124').huntingQueryVersion124]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_124",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams Admin submission of Malware and Phish daily trend",
                "category": "Hunting Queries",
                "query": "//Admin submission of false negative Teams message detections with Malware and Phish threat daily trend\nlet TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery=CloudAppEvents\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\n| where ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType == \"ChatMessage\";\nlet Admin_Malware_FN=baseQuery\n| make-series Count= countif(SubmissionType == \"2\") default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Admin_Malware_FN\";\nlet Admin_Phish_FN=baseQuery\n| make-series Count= countif(SubmissionType == \"1\") default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Admin_Phish_FN\";\nunion Admin_Malware_FN,Admin_Phish_FN\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the daily amount of admin false negative Teams message submissions by submission type of Phish or Malware"
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject124')._huntingQuerycontentId124),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 124",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject124')._huntingQuerycontentId124)]",
                "contentId": "[variables('huntingQueryObject124')._huntingQuerycontentId124]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject124').huntingQueryVersion124]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject124')._huntingQuerycontentId124]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams Admin submission of Malware and Phish daily trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject124')._huntingQuerycontentId124,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject124')._huntingQuerycontentId124,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject125').huntingQueryTemplateSpecName125]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams Admin submission of No Threats daily trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject125').huntingQueryVersion125]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_125",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams Admin submission of No Threats daily trend",
                "category": "Hunting Queries",
                "query": "//Admin submission of false positive Teams message detections daily trend\nlet TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery=CloudAppEvents\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\n| where ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType == \"ChatMessage\";\nlet Admin_Teams_FP=baseQuery\n| make-series Count= countif(SubmissionType == \"3\") default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Admin_Teams_FP\";\nunion Admin_Teams_FP\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the daily amount of admin false positive Teams message submissions"
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject125')._huntingQuerycontentId125),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 125",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject125')._huntingQuerycontentId125)]",
                "contentId": "[variables('huntingQueryObject125')._huntingQuerycontentId125]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject125').huntingQueryVersion125]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject125')._huntingQuerycontentId125]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams Admin submission of No Threats daily trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject125')._huntingQuerycontentId125,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject125')._huntingQuerycontentId125,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject126').huntingQueryTemplateSpecName126]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams Admin-User Submissions Grading Verdicts_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject126').huntingQueryVersion126]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_126",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams Admin-User Submissions Grading Verdicts",
                "category": "Hunting Queries",
                "query": "//This query visualizes Teams messages submitted by users or admins then graded in the submission process, summarizing the data by the various submission garde results\nCloudAppEvents\n| where ActionType == \"AdminSubmissionTriage\" or ActionType == \"UserSubmissionTriage\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),SubmissionState=tostring((parse_json(RawEventData)).SubmissionState),TriageVerdict=tostring((parse_json(RawEventData)).GradingResult.TriageVerdict)\n| where SubmissionContentType == \"ChatMessage\" and SubmissionState == \"Graded\"\n| summarize count() by TriageVerdict\n| project TriageVerdict, TeamsMessages = count_\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualizes Teams messages submitted by users or admins then graded in the submission process."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject126')._huntingQuerycontentId126),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 126",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject126')._huntingQuerycontentId126)]",
                "contentId": "[variables('huntingQueryObject126')._huntingQuerycontentId126]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject126').huntingQueryVersion126]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject126')._huntingQuerycontentId126]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams Admin-User Submissions Grading Verdicts",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject126')._huntingQuerycontentId126,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject126')._huntingQuerycontentId126,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject127').huntingQueryTemplateSpecName127]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams blocked URL clicks daily trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject127').huntingQueryVersion127]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_127",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams blocked URL clicks daily trend",
                "category": "Hunting Queries",
                "query": "//This query visualizes the daily amount of blocked Url clicks performed by users on Urls in Teams messages summarizing the data by various Teams app names.\nlet TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nUrlClickEvents\n| where Timestamp >= TimeStart\n| where ActionType == \"ClickBlocked\" and Workload ==\"Teams\"\n| make-series TeamsBlockedClicks = count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d by AppName\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualizes the daily amount of blocked Url clicks performed by users on Urls in Teams messages."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject127')._huntingQuerycontentId127),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 127",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject127')._huntingQuerycontentId127)]",
                "contentId": "[variables('huntingQueryObject127')._huntingQuerycontentId127]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject127').huntingQueryVersion127]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject127')._huntingQuerycontentId127]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams blocked URL clicks daily trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject127')._huntingQuerycontentId127,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject127')._huntingQuerycontentId127,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject128').huntingQueryTemplateSpecName128]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams Malware ZAP _HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject128').huntingQueryVersion128]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_128",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams Malware ZAP",
                "category": "Hunting Queries",
                "query": "//Zero-hour auto purge (ZAP) took action on Teams messages containing Malware after delivery.\nMessagePostDeliveryEvents\n| where ActionType == 'Malware ZAP' \n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for Teams messages with Malware threats that have been ZAPed."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject128')._huntingQuerycontentId128),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 128",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject128')._huntingQuerycontentId128)]",
                "contentId": "[variables('huntingQueryObject128')._huntingQuerycontentId128]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject128').huntingQueryVersion128]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject128')._huntingQuerycontentId128]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams Malware ZAP",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject128')._huntingQuerycontentId128,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject128')._huntingQuerycontentId128,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject129').huntingQueryTemplateSpecName129]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams Message with URL listed on OpenPhish_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject129').huntingQueryVersion129]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_129",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams Message with URL listed on OpenPhish",
                "category": "Hunting Queries",
                "query": "//This query can be used as a Custom Detection Rule (CDR) to trigger when a potentially malicious Teams message with a URL from OpenPhish.\nlet PhishingURLs = externaldata(url: string)\n[\n\"https://raw.githubusercontent.com/openphish/public_feed/refs/heads/main/feed.txt\"\n]\nwith (format=\"txt\"); // CSV and JSON formats are also valid formats if using the premium feeds\nMessageUrlInfo\n| where Url in (PhishingURLs)\n| join MessageEvents on TeamsMessageId\n//| where IsOwnedThread==0 and IsExternalThread==1\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query can be used as a Custom Detection Rule (CDR) to trigger when a potentially malicious Teams message with a URL from OpenPhish was delivered."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject129')._huntingQuerycontentId129),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 129",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject129')._huntingQuerycontentId129)]",
                "contentId": "[variables('huntingQueryObject129')._huntingQuerycontentId129]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject129').huntingQueryVersion129]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject129')._huntingQuerycontentId129]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams Message with URL listed on OpenPhish",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject129')._huntingQuerycontentId129,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject129')._huntingQuerycontentId129,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject130').huntingQueryTemplateSpecName130]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams message ZAPed with the same URL in Email_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject130').huntingQueryVersion130]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_130",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams message ZAPed with the same URL in Email",
                "category": "Hunting Queries",
                "query": "//This query provides insights on Teams messages ZAPed with the same malicious URLs in Email messages\nMessagePostDeliveryEvents\n| join MessageUrlInfo on TeamsMessageId\n| join EmailUrlInfo on Url\n| join EmailEvents on NetworkMessageId\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for Teams messages that have been ZAPed with the same URL in Email."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject130')._huntingQuerycontentId130),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 130",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject130')._huntingQuerycontentId130)]",
                "contentId": "[variables('huntingQueryObject130')._huntingQuerycontentId130]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject130').huntingQueryVersion130]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject130')._huntingQuerycontentId130]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams message ZAPed with the same URL in Email",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject130')._huntingQuerycontentId130,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject130')._huntingQuerycontentId130,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject131').huntingQueryTemplateSpecName131]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams messages from a specific sender by ThreadType_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject131').huntingQueryVersion131]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_131",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams messages from a specific sender by ThreadType",
                "category": "Hunting Queries",
                "query": "//This query gets the count of messages from a sender across all types of conversations\nlet Sender = \"norpely@contoso.com\";\nMessageEvents\n| where SenderEmailAddress == Sender\n| summarize Count = count() by ThreadType\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for Teams messages from a specific sender by ThreadType."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject131')._huntingQuerycontentId131),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 131",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject131')._huntingQuerycontentId131)]",
                "contentId": "[variables('huntingQueryObject131')._huntingQuerycontentId131]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject131').huntingQueryVersion131]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject131')._huntingQuerycontentId131]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams messages from a specific sender by ThreadType",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject131')._huntingQuerycontentId131,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject131')._huntingQuerycontentId131,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject132').huntingQueryTemplateSpecName132]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams messages with suspicious URL domains_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject132').huntingQueryVersion132]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_132",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams messages with suspicious URL domains",
                "category": "Hunting Queries",
                "query": "//This Query uses MessageUrlInfo to find external Teams messages with suspicious low reputation URL doamins (e.g .xyz etc)\nMessageUrlInfo\n| extend Domain = extract(@\"^(?:https?://)?([^/]+)\", 1, Url)\n| extend TLD = tostring(split(Domain, \".\")[-1])\n| where TLD has_any (\"dev\",\"app\",\"zip\",\"solutions\",\"io\",\"top\",\"xyz\")\n| project Timestamp,Url,UrlDomain,TLD,TeamsMessageId, ReportId\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for Teams messages with suspicious URL domains."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject132')._huntingQuerycontentId132),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 132",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject132')._huntingQuerycontentId132)]",
                "contentId": "[variables('huntingQueryObject132')._huntingQuerycontentId132]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject132').huntingQueryVersion132]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject132')._huntingQuerycontentId132]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams messages with suspicious URL domains",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject132')._huntingQuerycontentId132,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject132')._huntingQuerycontentId132,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject133').huntingQueryTemplateSpecName133]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams Phish ZAP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject133').huntingQueryVersion133]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_133",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams Phish ZAP",
                "category": "Hunting Queries",
                "query": "//Zero-hour auto purge (ZAP) took action on Teams messages containing Phish after delivery\nMessagePostDeliveryEvents\n| where ActionType == 'Phish ZAP' \n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for Teams messages with Phish threats that have been ZAPed."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject133')._huntingQuerycontentId133),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 133",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject133')._huntingQuerycontentId133)]",
                "contentId": "[variables('huntingQueryObject133')._huntingQuerycontentId133]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject133').huntingQueryVersion133]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject133')._huntingQuerycontentId133]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams Phish ZAP",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject133')._huntingQuerycontentId133,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject133')._huntingQuerycontentId133,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject134').huntingQueryTemplateSpecName134]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams post delivery events daily trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject134').huntingQueryVersion134]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_134",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams post delivery events daily trend",
                "category": "Hunting Queries",
                "query": "//Teams post delivery ZAP events daily trend\nlet TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nMessagePostDeliveryEvents\n| where Timestamp >= TimeStart\n| where ActionType has \"ZAP\"\n| make-series ZappedTeamsMessages = count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualizes the daily amount of post delivery events on Teams messages."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject134')._huntingQuerycontentId134),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 134",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject134')._huntingQuerycontentId134)]",
                "contentId": "[variables('huntingQueryObject134')._huntingQuerycontentId134]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject134').huntingQueryVersion134]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject134')._huntingQuerycontentId134]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams post delivery events daily trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject134')._huntingQuerycontentId134,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject134')._huntingQuerycontentId134,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject135').huntingQueryTemplateSpecName135]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams Spam ZAP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject135').huntingQueryVersion135]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_135",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams Spam ZAP",
                "category": "Hunting Queries",
                "query": "//Zero-hour auto purge (ZAP) took action on Teams messages containing Spam after delivery\nMessagePostDeliveryEvents\n| where ActionType == 'Spam ZAP' \n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for Teams messages with Spam threats that have been ZAPed."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject135')._huntingQuerycontentId135),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 135",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject135')._huntingQuerycontentId135)]",
                "contentId": "[variables('huntingQueryObject135')._huntingQuerycontentId135]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject135').huntingQueryVersion135]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject135')._huntingQuerycontentId135]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams Spam ZAP",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject135')._huntingQuerycontentId135,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject135')._huntingQuerycontentId135,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject136').huntingQueryTemplateSpecName136]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams URL clicks actions summarized by URLs clicked on_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject136').huntingQueryVersion136]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_136",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams URL clicks actions summarized by URLs clicked on",
                "category": "Hunting Queries",
                "query": "//Teams URL clicks actions summarized by URLs clicked on\nUrlClickEvents\n| extend UrlBlocked = ActionType has_any(\"ClickBlocked\")\n| extend UrlAllowed = ActionType has_any('ClickAllowed')\n| extend UrlPendingVerdict = ActionType has_any('UrlScanInProgress')\n| extend ErrorPage = ActionType has_any('UrlErrorPage')\n| where Workload == \"Teams\"\n| summarize Blocked = countif(UrlBlocked), Allowed = countif(UrlAllowed), PendingVerdict = countif(UrlPendingVerdict), Error = countif(ErrorPage), ClickedThrough = countif(IsClickedThrough) by Url\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualizes user clicks in Teams summarizing the data by the various URLs and Click actions on them."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject136')._huntingQuerycontentId136),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 136",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject136')._huntingQuerycontentId136)]",
                "contentId": "[variables('huntingQueryObject136')._huntingQuerycontentId136]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject136').huntingQueryVersion136]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject136')._huntingQuerycontentId136]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams URL clicks actions summarized by URLs clicked on",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject136')._huntingQuerycontentId136,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject136')._huntingQuerycontentId136,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject137').huntingQueryTemplateSpecName137]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams URL clicks through actions on Phish or Malware URLs summarized by URLs_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject137').huntingQueryVersion137]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_137",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams URL clicks through actions on Phish or Malware URLs summarized by URLs",
                "category": "Hunting Queries",
                "query": "//Teams URL clicks through actions on Phish or Malware URLs summarized by URLs\nUrlClickEvents \n| where IsClickedThrough !=\"0\" and Workload ==\"Teams\"\n| where ThreatTypes in (\"Phish\",\"Malware\") \n| summarize by Url,ThreatTypes, IsClickedThrough, ActionType\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualizes clicks through actions on Phish or Malware URLs in Teams, summarizing the data by Urls."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject137')._huntingQuerycontentId137),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 137",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject137')._huntingQuerycontentId137)]",
                "contentId": "[variables('huntingQueryObject137')._huntingQuerycontentId137]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject137').huntingQueryVersion137]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject137')._huntingQuerycontentId137]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams URL clicks through actions on Phish or Malware URLs summarized by URLs",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject137')._huntingQuerycontentId137,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject137')._huntingQuerycontentId137,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject138').huntingQueryTemplateSpecName138]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams User submissions daily trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject138').huntingQueryVersion138]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_138",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams User submissions daily trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery=CloudAppEvents\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\n| where ActionType == \"UserSubmission\" and SubmissionContentType == \"ChatMessage\";\nlet User_TeamsSubmission_FN_FP=baseQuery\n| make-series Count = count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"User_TeamsSubmission_FN_FP\";\nunion User_TeamsSubmission_FN_FP\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the daily amount of user false negative and false postive Teams message submissions"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject138')._huntingQuerycontentId138),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 138",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject138')._huntingQuerycontentId138)]",
                "contentId": "[variables('huntingQueryObject138')._huntingQuerycontentId138]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject138').huntingQueryVersion138]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject138')._huntingQuerycontentId138]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams User submissions daily trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject138')._huntingQuerycontentId138,'-', 'l.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject138')._huntingQuerycontentId138,'-', 'l.0.0')))]",
        "version": "l.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject139').huntingQueryTemplateSpecName139]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Teams users clicking on suspicious URL domains_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject139').huntingQueryVersion139]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_139",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Teams users clicking on suspicious URL domains",
                "category": "Hunting Queries",
                "query": "//This Query uses MessageUrlInfo, MessageEvents and UrlClickEvents to find external Teams messages with low reputation URL doamins (.xyz) and identify the top 10 users clicking on them. \nMessageUrlInfo\n| extend Domain = extract(@\"^(?:https?://)?([^/]+)\", 1, Url)\n| extend TLD = tostring(split(Domain, \".\")[-1])\n| where TLD has_any (\"dev\",\"app\",\"zip\",\"solutions\",\"io\",\"top\")\n| join MessageEvents on TeamsMessageId\n| join UrlClickEvents on Url\n| project Timestamp,Url,UrlDomain,TLD,TeamsMessageId, ReportId, Timestamp2,ActionType,AccountUpn,Workload, SenderDisplayName, SenderEmailAddress, ThreatTypes, DetectionMethods, RecipientDetails\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for Teams users clicking on suspicious URL domains."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject139')._huntingQuerycontentId139),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 139",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject139')._huntingQuerycontentId139)]",
                "contentId": "[variables('huntingQueryObject139')._huntingQuerycontentId139]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject139').huntingQueryVersion139]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject139')._huntingQuerycontentId139]",
        "contentKind": "HuntingQuery",
        "displayName": "Teams users clicking on suspicious URL domains",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject139')._huntingQuerycontentId139,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject139')._huntingQuerycontentId139,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject140').huntingQueryTemplateSpecName140]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 Attacked user by Phish messages_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject140').huntingQueryVersion140]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_140",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 Attacked user by Phish messages",
                "category": "Hunting Queries",
                "query": "//Top 10 attacked users by Phish messages from external senders using Teams. Replace contoso.com with your own recipient domain.\nMessageEvents\n| where ThreatTypes has 'Phish' and IsOwnedThread==0 and IsExternalThread==1\n| mv-expand Recipients = RecipientDetails\n| extend RecipientEmailAddress = Recipients.RecipientSmtpAddress, RecipientDisplayName = Recipients.RecipientDisplayName, RecipientObjectId = Recipients.RecipientObjectId, RecipientType = Recipients.RecipientType\n| where RecipientEmailAddress contains ('contoso.com')\n| summarize count() by tostring(RecipientEmailAddress)\n| sort by count_\n| top 10 by count_\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Top 10 attacked users by Phish messages from external senders using Teams"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject140')._huntingQuerycontentId140),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 140",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject140')._huntingQuerycontentId140)]",
                "contentId": "[variables('huntingQueryObject140')._huntingQuerycontentId140]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject140').huntingQueryVersion140]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject140')._huntingQuerycontentId140]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 Attacked user by Phish messages",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject140')._huntingQuerycontentId140,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject140')._huntingQuerycontentId140,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject141').huntingQueryTemplateSpecName141]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 external senders sending Teams messages_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject141').huntingQueryVersion141]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_141",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 external senders sending Teams messages",
                "category": "Hunting Queries",
                "query": "//Top 10 external senders sending Teams messages\nMessageEvents \n| where IsOwnedThread==0 and IsExternalThread==1\n| summarize count() by SenderEmailAddress\n| sort by count_ desc\n| top 10 by count_\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visulises all up Top 10 external senders sending Teams messages"
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject141')._huntingQuerycontentId141),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 141",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject141')._huntingQuerycontentId141)]",
                "contentId": "[variables('huntingQueryObject141')._huntingQuerycontentId141]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject141').huntingQueryVersion141]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject141')._huntingQuerycontentId141]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 external senders sending Teams messages",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject141')._huntingQuerycontentId141,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject141')._huntingQuerycontentId141,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject142').huntingQueryTemplateSpecName142]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 External senders sending Teams phishing messsages_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject142').huntingQueryVersion142]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_142",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 External senders sending Teams phishing messsages",
                "category": "Hunting Queries",
                "query": "//This query looking for top 10 External senders sending Team phishing messsages\nMessageEvents\n| where IsOwnedThread==0 and IsExternalThread==1\n| where ThreatTypes has \"Phish\"\n| summarize Count = count() by SenderEmailAddress\n| top 10 by Count\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query looking for top 10 External senders sending Team phishing messsages."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject142')._huntingQuerycontentId142),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 142",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject142')._huntingQuerycontentId142)]",
                "contentId": "[variables('huntingQueryObject142')._huntingQuerycontentId142]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject142').huntingQueryVersion142]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject142')._huntingQuerycontentId142]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 External senders sending Teams phishing messsages",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject142')._huntingQuerycontentId142,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject142')._huntingQuerycontentId142,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject143').huntingQueryTemplateSpecName143]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 sender domains - Admin Teams message submissions FN_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject143').huntingQueryVersion143]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_143",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 sender domains - Admin Teams message submissions FN",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminSubmissionSubmitted\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain)\n| where SubmissionContentType == \"ChatMessage\" and SubmissionType in (\"2\",\"1\")\n| summarize count() by P2SenderDomain\n| project P2SenderDomain, TeamsMessages = count_\n| top 10 by TeamsMessages desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises Teams messages submitted by admins as false negatives, summarizing the data by top 10 sender domains of those messages"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject143')._huntingQuerycontentId143),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 143",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject143')._huntingQuerycontentId143)]",
                "contentId": "[variables('huntingQueryObject143')._huntingQuerycontentId143]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject143').huntingQueryVersion143]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject143')._huntingQuerycontentId143]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 sender domains - Admin Teams message submissions FN",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject143')._huntingQuerycontentId143,'-', 'l.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject143')._huntingQuerycontentId143,'-', 'l.0.0')))]",
        "version": "l.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject144').huntingQueryTemplateSpecName144]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 sender domains - Teams user submissions FN or FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject144').huntingQueryVersion144]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_144",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 sender domains - Teams user submissions FN or FP",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"UserSubmission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain)\n| where SubmissionContentType == \"ChatMessage\"\n| summarize count() by P2SenderDomain\n| project P2SenderDomain, TeamsMessages = count_\n| top 10 by TeamsMessages desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises Teams messages submitted by users as false negatives or false positives, summarizing the data by top 10 sender domains of those messages"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject144')._huntingQuerycontentId144),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 144",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject144')._huntingQuerycontentId144)]",
                "contentId": "[variables('huntingQueryObject144')._huntingQuerycontentId144]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject144').huntingQueryVersion144]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject144')._huntingQuerycontentId144]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 sender domains - Teams user submissions FN or FP",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject144')._huntingQuerycontentId144,'-', 'l.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject144')._huntingQuerycontentId144,'-', 'l.0.0')))]",
        "version": "l.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject145').huntingQueryTemplateSpecName145]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 senders - Teams users submissions FN or FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject145').huntingQueryVersion145]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_145",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 senders - Teams users submissions FN or FP",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"UserSubmission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2Sender=tostring((parse_json(RawEventData)).P2Sender)\n| where SubmissionContentType == \"ChatMessage\"\n| summarize count() by P2Sender\n| project P2Sender, TeamsMessages = count_\n| top 10 by TeamsMessages desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises Teams messages submitted by user as false negatives or false positives, summarizing the data by top 10 indidvidual senders of those messages"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject145')._huntingQuerycontentId145),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 145",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject145')._huntingQuerycontentId145)]",
                "contentId": "[variables('huntingQueryObject145')._huntingQuerycontentId145]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject145').huntingQueryVersion145]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject145')._huntingQuerycontentId145]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 senders - Teams users submissions FN or FP",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject145')._huntingQuerycontentId145,'-', 'l.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject145')._huntingQuerycontentId145,'-', 'l.0.0')))]",
        "version": "l.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject146').huntingQueryTemplateSpecName146]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 senders of  Admin Teams message submissions FN_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject146').huntingQueryVersion146]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_146",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 senders of  Admin Teams message submissions FN",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminSubmissionSubmitted\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2Sender=tostring((parse_json(RawEventData)).P2Sender)\n| where SubmissionContentType == \"ChatMessage\" and SubmissionType in (\"2\",\"1\")\n| summarize count() by P2Sender\n| project P2Sender, TeamsMessages = count_\n| top 10 by TeamsMessages desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises Teams messages submitted by admins as false negatives, summarizing the data by top 10 indidvidual senders of those messages"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject146')._huntingQuerycontentId146),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 146",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject146')._huntingQuerycontentId146)]",
                "contentId": "[variables('huntingQueryObject146')._huntingQuerycontentId146]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject146').huntingQueryVersion146]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject146')._huntingQuerycontentId146]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 senders of  Admin Teams message submissions FN",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject146')._huntingQuerycontentId146,'-', 'l.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject146')._huntingQuerycontentId146,'-', 'l.0.0')))]",
        "version": "l.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject147').huntingQueryTemplateSpecName147]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 senders of  Admin Teams message submissions FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject147').huntingQueryVersion147]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_147",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 senders of  Admin Teams message submissions FP",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminSubmissionSubmitted\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2Sender=tostring((parse_json(RawEventData)).P2Sender)\n| where SubmissionContentType == \"ChatMessage\" and SubmissionType in (\"3\")\n| summarize count() by P2Sender\n| project P2Sender, TeamsMessages = count_\n| top 10 by TeamsMessages desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises Teams messages submitted by admins as false positives, summarizing the data by top 10 indidvidual senders of those messages"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject147')._huntingQuerycontentId147),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 147",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject147')._huntingQuerycontentId147)]",
                "contentId": "[variables('huntingQueryObject147')._huntingQuerycontentId147]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject147').huntingQueryVersion147]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject147')._huntingQuerycontentId147]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 senders of  Admin Teams message submissions FP",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject147')._huntingQuerycontentId147,'-', 'l.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject147')._huntingQuerycontentId147,'-', 'l.0.0')))]",
        "version": "l.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject148').huntingQueryTemplateSpecName148]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 Users clicking on malicious URLs in Teams_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject148').huntingQueryVersion148]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_148",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 Users clicking on malicious URLs in Teams",
                "category": "Hunting Queries",
                "query": "//Top 10 Users clicking on malicious URLs in Teams\nUrlClickEvents \n| where Workload ==\"Teams\" and ThreatTypes in (\"Phish\",\"Malware\") \n| summarize Blocked = countif(ActionType ==\"ClickBlocked\"), Allowed = countif(ActionType ==\"ClickAllowed\"), PendingVerdict = countif(ActionType ==\"UrlScanInProgress\"), Error = countif(ActionType ==\"UrlErrorPage\"), ClickedThrough = countif(IsClickedThrough)by AccountUpn\n| top 10 by Blocked desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualizes Top 10 Users clicking on malicious Phish or Malware URLs in Teams."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject148')._huntingQuerycontentId148),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 148",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject148')._huntingQuerycontentId148)]",
                "contentId": "[variables('huntingQueryObject148')._huntingQuerycontentId148]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject148').huntingQueryVersion148]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject148')._huntingQuerycontentId148]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 Users clicking on malicious URLs in Teams",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject148')._huntingQuerycontentId148,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject148')._huntingQuerycontentId148,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject149').huntingQueryTemplateSpecName149]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top accounts performing Teams admin submissions FN or FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject149').huntingQueryVersion149]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_149",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top accounts performing Teams admin submissions FN or FP",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminSubmissionSubmitted\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),SubmittedBy=tostring((parse_json(RawEventData)).UserId)\n| where SubmissionContentType == \"ChatMessage\" and SubmissionType in (\"1\",\"2\",\"3\")\n| summarize count() by SubmittedBy\n| project SubmittedBy, TeamsMessages = count_\n|top 10 by TeamsMessages desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the top admins performing false negative or false positive admin submissions of Teams messages"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject149')._huntingQuerycontentId149),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 149",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject149')._huntingQuerycontentId149)]",
                "contentId": "[variables('huntingQueryObject149')._huntingQuerycontentId149]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject149').huntingQueryVersion149]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject149')._huntingQuerycontentId149]",
        "contentKind": "HuntingQuery",
        "displayName": "Top accounts performing Teams admin submissions FN or FP",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject149')._huntingQuerycontentId149,'-', 'l.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject149')._huntingQuerycontentId149,'-', 'l.0.0')))]",
        "version": "l.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject150').huntingQueryTemplateSpecName150]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top accounts performing Teams user submissions FN or FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject150').huntingQueryVersion150]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_150",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top accounts performing Teams user submissions FN or FP",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"UserSubmission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),SubmittedBy=tostring((parse_json(RawEventData)).UserId)\n| where SubmissionContentType == \"ChatMessage\"\n| summarize count() by SubmittedBy\n| project SubmittedBy, TeamsMessages = count_\n|top 10 by TeamsMessages desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the top users performing false negative or false positive user submissions of Teams messages"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject150')._huntingQuerycontentId150),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 150",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject150')._huntingQuerycontentId150)]",
                "contentId": "[variables('huntingQueryObject150')._huntingQuerycontentId150]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject150').huntingQueryVersion150]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject150')._huntingQuerycontentId150]",
        "contentKind": "HuntingQuery",
        "displayName": "Top accounts performing Teams user submissions FN or FP",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject150')._huntingQuerycontentId150,'-', 'l.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject150')._huntingQuerycontentId150,'-', 'l.0.0')))]",
        "version": "l.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject151').huntingQueryTemplateSpecName151]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top domains outbound sending Malicious Teams messages inbound_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject151').huntingQueryVersion151]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_151",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top domains outbound sending Malicious Teams messages inbound",
                "category": "Hunting Queries",
                "query": "// This query provides insights of top outbound recipient domains of outbound Teams messages by volume and shows total number of inbound Teams messages with Threats from the same domains (as inbound senders) indicating potential partner user or organization compromise.\nMessageEvents\n| where IsExternalThread==1 and IsOwnedThread==1\n| mv-expand Recipients = RecipientDetails\n| extend RecipientEmailAddress = Recipients.RecipientSmtpAddress\n| extend RecipientDomain = tostring(split(RecipientEmailAddress, \"@\")[1])\n//| where RecipientDomain !=\"contoso.com\"\n| summarize count() by RecipientDomain\n| project OutboundCount=count_, RecipientDomain, SenderFromDomain=RecipientDomain\n| join (MessageEvents |mv-expand Recipients = RecipientDetails|extend RecipientEmailAddress = Recipients.RecipientSmtpAddress|extend SenderFromDomain = tostring(split(RecipientEmailAddress, \"@\")[1])| where IsExternalThread==1 and IsOwnedThread==0 and isempty(ThreatTypes)==false) on SenderFromDomain\n| summarize max(OutboundCount),count() by SenderFromDomain\n//| extend Bad_Traffic_Percentage = todouble(round(IncomingTeamsMessagesWithThreats=count_ / todouble(OutboundTeamsMessages=max_OutboundCount), 2))\n| project SenderFromDomain, OutboundTeamsMessages=max_OutboundCount, IncomingTeamsMessagesWithThreats=count_//, Bad_Traffic_Percentage\n| sort by OutboundTeamsMessages\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query looking for potential partner compromise via comparing outbound Teams message traffic per target domain and looking for malicious Teams messages from the same domains as inbound."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject151')._huntingQuerycontentId151),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 151",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject151')._huntingQuerycontentId151)]",
                "contentId": "[variables('huntingQueryObject151')._huntingQuerycontentId151]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject151').huntingQueryVersion151]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject151')._huntingQuerycontentId151]",
        "contentKind": "HuntingQuery",
        "displayName": "Top domains outbound sending Malicious Teams messages inbound",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject151')._huntingQuerycontentId151,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject151')._huntingQuerycontentId151,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject152').huntingQueryTemplateSpecName152]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top external malicious senders_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject152').huntingQueryVersion152]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_152",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top External malicious Senders",
                "category": "Hunting Queries",
                "query": "//Top external senders sending malicious inbound Teams messages Spam, Phish, Malware\nMessageEvents \n| where IsOwnedThread==0 and IsExternalThread==1 and ThreatTypes !='' and Timestamp > ago(30d)\n| summarize count() by SenderEmailAddress, ThreatTypes \n| sort by count_ desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Top external senders sending malicious inbound Teams messages Spam, Phish, Malware"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject152')._huntingQuerycontentId152),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 152",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject152')._huntingQuerycontentId152)]",
                "contentId": "[variables('huntingQueryObject152')._huntingQuerycontentId152]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject152').huntingQueryVersion152]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject152')._huntingQuerycontentId152]",
        "contentKind": "HuntingQuery",
        "displayName": "Top External malicious Senders",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject152')._huntingQuerycontentId152,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject152')._huntingQuerycontentId152,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject153').huntingQueryTemplateSpecName153]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top External Sender domains - Malware_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject153').huntingQueryVersion153]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_153",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top External Sender domains - Malware",
                "category": "Hunting Queries",
                "query": "//Top External Sender domains sending Teams message with Malware threats\nMessageEvents\n| where IsExternalThread==1 and IsOwnedThread==0\n| where ThreatTypes contains \"Malware\"\n| extend SenderDomain = tostring(split(SenderEmailAddress, \"@\")[1])\n| summarize count() by SenderDomain\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Top External Sender domains sending Teams message with Malware threats"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject153')._huntingQuerycontentId153),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 153",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject153')._huntingQuerycontentId153)]",
                "contentId": "[variables('huntingQueryObject153')._huntingQuerycontentId153]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject153').huntingQueryVersion153]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject153')._huntingQuerycontentId153]",
        "contentKind": "HuntingQuery",
        "displayName": "Top External Sender domains - Malware",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject153')._huntingQuerycontentId153,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject153')._huntingQuerycontentId153,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject154').huntingQueryTemplateSpecName154]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top External Sender domains - Phish_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject154').huntingQueryVersion154]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_154",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top External Sender domains - Phish",
                "category": "Hunting Queries",
                "query": "//Top External Sender domains sending Teams message with Phish threats\nMessageEvents\n| where IsExternalThread==1 and IsOwnedThread==0\n| where ThreatTypes contains \"Phish\"\n| extend SenderDomain = tostring(split(SenderEmailAddress, \"@\")[1])\n| summarize count() by SenderDomain\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Top External Sender domains sending Teams message with Phish threats"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject154')._huntingQuerycontentId154),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 154",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject154')._huntingQuerycontentId154)]",
                "contentId": "[variables('huntingQueryObject154')._huntingQuerycontentId154]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject154').huntingQueryVersion154]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject154')._huntingQuerycontentId154]",
        "contentKind": "HuntingQuery",
        "displayName": "Top External Sender domains - Phish",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject154')._huntingQuerycontentId154,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject154')._huntingQuerycontentId154,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject155').huntingQueryTemplateSpecName155]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top External Sender domains - Spam_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject155').huntingQueryVersion155]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_155",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top External Sender domains - Spam",
                "category": "Hunting Queries",
                "query": "//Top External Sender domains sending Teams message with Spam threats\nMessageEvents\n| where IsExternalThread==1 and IsOwnedThread==0\n| where ThreatTypes contains \"Spam\"\n| extend SenderDomain = tostring(split(SenderEmailAddress, \"@\")[1])\n| summarize count() by SenderDomain\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Top External Sender domains sending Teams message with Spam threats"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject155')._huntingQuerycontentId155),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 155",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject155')._huntingQuerycontentId155)]",
                "contentId": "[variables('huntingQueryObject155')._huntingQuerycontentId155]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject155').huntingQueryVersion155]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject155')._huntingQuerycontentId155]",
        "contentKind": "HuntingQuery",
        "displayName": "Top External Sender domains - Spam",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject155')._huntingQuerycontentId155,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject155')._huntingQuerycontentId155,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject156').huntingQueryTemplateSpecName156]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top malicious URLs clicked by users in Teams_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject156').huntingQueryVersion156]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_156",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top malicious URLs clicked by users in Teams",
                "category": "Hunting Queries",
                "query": "//This query shows the top 20 URL's that have a detection associated with it and the most ammount of clicks registered from Microsoft Teams \nUrlClickEvents\n| where ThreatTypes !=\"\" and Workload ==\"Teams\"\n| summarize count() by Url, ThreatTypes, ActionType, Workload\n| project Url, ThreatTypes, ActionType, Workload, ClickCount=count_\n| top 20 by ClickCount\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunt for top malicious URLs clicked by users in Teams"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject156')._huntingQuerycontentId156),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 156",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject156')._huntingQuerycontentId156)]",
                "contentId": "[variables('huntingQueryObject156')._huntingQuerycontentId156]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject156').huntingQueryVersion156]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject156')._huntingQuerycontentId156]",
        "contentKind": "HuntingQuery",
        "displayName": "Top malicious URLs clicked by users in Teams",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject156')._huntingQuerycontentId156,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject156')._huntingQuerycontentId156,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject157').huntingQueryTemplateSpecName157]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Total number of MDO Teams protection detections daily_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject157').huntingQueryVersion157]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_157",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Total number of MDO Teams protection detections daily",
                "category": "Hunting Queries",
                "query": "//Total number of MDO Teams protection detections daily \nlet minTime = toscalar(MessageEvents | summarize min(Timestamp));\nlet maxTime = toscalar(MessageEvents | summarize max(Timestamp));\nlet baseQuery = MessageEvents\n//| where IsOwnedThread==0 and IsExternalThread==1 \n| where isnotempty(Timestamp);\nlet totalwiththreat = baseQuery\n| where isnotempty(ThreatTypes) \n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \n| extend Details = \"Total Teams messages with Threat\";\nlet totalwithphishthreat = baseQuery\n| where ThreatTypes has ('Phish')\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \n| extend Details = \"Total Teams messages with Phish Threat\";\nlet totalwithmalwarethreat = baseQuery\n| where ThreatTypes has ('Malware')\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \n| extend Details = \"Total Teams messages with Malware Threat\";\nunion totalwiththreat, totalwithphishthreat, totalwithmalwarethreat\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visulises Total number of MDO Teams protection detections daily"
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject157')._huntingQuerycontentId157),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 157",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject157')._huntingQuerycontentId157)]",
                "contentId": "[variables('huntingQueryObject157')._huntingQuerycontentId157]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject157').huntingQueryVersion157]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject157')._huntingQuerycontentId157]",
        "contentKind": "HuntingQuery",
        "displayName": "Total number of MDO Teams protection detections daily",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject157')._huntingQuerycontentId157,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject157')._huntingQuerycontentId157,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject158').huntingQueryTemplateSpecName158]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "URL click on URLs in ZAP-d Teams messages_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject158').huntingQueryVersion158]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_158",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "URL click on URLs in ZAP-d Teams messages",
                "category": "Hunting Queries",
                "query": "//URL click on URLs in ZAP-d Teams messages\nMessagePostDeliveryEvents\n| join MessageUrlInfo on TeamsMessageId\n| join UrlClickEvents on Url\n| where ActionType !=\"\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualizes URL clicks on URLs in Teams messages which were acted by ZAP."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject158')._huntingQuerycontentId158),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 158",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject158')._huntingQuerycontentId158)]",
                "contentId": "[variables('huntingQueryObject158')._huntingQuerycontentId158]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject158').huntingQueryVersion158]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject158')._huntingQuerycontentId158]",
        "contentKind": "HuntingQuery",
        "displayName": "URL click on URLs in ZAP-d Teams messages",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject158')._huntingQuerycontentId158,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject158')._huntingQuerycontentId158,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject159').huntingQueryTemplateSpecName159]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam and Phish delivered to Inbox due to Admin Overrides_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject159').huntingQueryVersion159]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_159",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spam and Phish allowed to inbox by Admin Overrides",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = EmailEvents\n| where TimeGenerated >= TimeStart\n| where ConfidenceLevel != \"\" and OrgLevelPolicy!=\"\" and OrgLevelAction == \"Allow\" and DeliveryAction == \"Delivered\";\nlet spam=baseQuery\n| where ThreatTypes has 'Spam'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Allowed Spam\";\nlet phish=baseQuery\n| where ThreatTypes has 'Phish'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Allowed Phish\";\nunion spam,phish\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps in reviewing malicious emails allowed due to admin overrides"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject159')._huntingQuerycontentId159),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 159",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject159')._huntingQuerycontentId159)]",
                "contentId": "[variables('huntingQueryObject159')._huntingQuerycontentId159]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject159').huntingQueryVersion159]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject159')._huntingQuerycontentId159]",
        "contentKind": "HuntingQuery",
        "displayName": "Spam and Phish allowed to inbox by Admin Overrides",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject159')._huntingQuerycontentId159,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject159')._huntingQuerycontentId159,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject160').huntingQueryTemplateSpecName160]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam and Phish delivered to Inbox due to User Overrides_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject160').huntingQueryVersion160]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_160",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spam and Phish allowed to inbox by User Overrides",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = EmailEvents\n| where TimeGenerated >= TimeStart\n| where ConfidenceLevel != \"\" and UserLevelPolicy!=\"\" and UserLevelAction == \"Allow\" and DeliveryAction == \"Delivered\";\nlet spam=baseQuery\n| where ThreatTypes has 'Spam'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Allowed Spam\";\nlet phish=baseQuery\n| where ThreatTypes has 'Phish'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Allowed Phish\";\nunion spam,phish\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps in reviewing malicious emails allowed due to user overrides"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject160')._huntingQuerycontentId160),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 160",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject160')._huntingQuerycontentId160)]",
                "contentId": "[variables('huntingQueryObject160')._huntingQuerycontentId160]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject160').huntingQueryVersion160]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject160')._huntingQuerycontentId160]",
        "contentKind": "HuntingQuery",
        "displayName": "Spam and Phish allowed to inbox by User Overrides",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject160')._huntingQuerycontentId160,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject160')._huntingQuerycontentId160,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject161').huntingQueryTemplateSpecName161]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top policies performing admin overrides_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject161').huntingQueryVersion161]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_161",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top policies performing admin overrides",
                "category": "Hunting Queries",
                "query": "EmailEvents  \n| where OrgLevelPolicy!=\"\" and OrgLevelAction == \"Allow\"  //\"Block\"\n| extend OrgPolicy = split(OrgLevelPolicy, \"(\", 0)\n| summarize count() by tostring(OrgPolicy)\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps in reviewing top policies for admin overrides (Allow/Block)"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject161')._huntingQuerycontentId161),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 161",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject161')._huntingQuerycontentId161)]",
                "contentId": "[variables('huntingQueryObject161')._huntingQuerycontentId161]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject161').huntingQueryVersion161]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject161')._huntingQuerycontentId161]",
        "contentKind": "HuntingQuery",
        "displayName": "Top policies performing admin overrides",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject161')._huntingQuerycontentId161,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject161')._huntingQuerycontentId161,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject162').huntingQueryTemplateSpecName162]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top policies performing user overrides_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject162').huntingQueryVersion162]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_162",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top policies performing user overrides",
                "category": "Hunting Queries",
                "query": "EmailEvents  \n| where UserLevelPolicy!=\"\" and UserLevelAction == \"Allow\" //\"Block\"\n| extend UserPolicy = split(UserLevelPolicy, \"(\", 0)\n| summarize count() by tostring(UserPolicy)\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps in reviewing top policies for user overrides (Allow/Block)"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject162')._huntingQuerycontentId162),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 162",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject162')._huntingQuerycontentId162)]",
                "contentId": "[variables('huntingQueryObject162')._huntingQuerycontentId162]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject162').huntingQueryVersion162]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject162')._huntingQuerycontentId162]",
        "contentKind": "HuntingQuery",
        "displayName": "Top policies performing user overrides",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject162')._huntingQuerycontentId162,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject162')._huntingQuerycontentId162,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject163').huntingQueryTemplateSpecName163]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Total Emails with Admin Overrides - Allow_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject163').huntingQueryVersion163]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_163",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Total Emails with Admin Overrides (Allow)",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nEmailEvents \n| where OrgLevelPolicy != \"\" and OrgLevelAction == \"Allow\" // and OrgLevelPolicy != \"SecOps Mailbox\" // Remove to filter SecOps mailbox\n| make-series Count= count() on Timestamp from TimeStart to TimeEnd step 1d by OrgLevelPolicy\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the total amount of emails subject to an admin policy with action of allow, independent of action taken, summarizing the data by type of override"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject163')._huntingQuerycontentId163),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 163",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject163')._huntingQuerycontentId163)]",
                "contentId": "[variables('huntingQueryObject163')._huntingQuerycontentId163]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject163').huntingQueryVersion163]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject163')._huntingQuerycontentId163]",
        "contentKind": "HuntingQuery",
        "displayName": "Total Emails with Admin Overrides (Allow)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject163')._huntingQuerycontentId163,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject163')._huntingQuerycontentId163,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject164').huntingQueryTemplateSpecName164]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Total Emails with Admin Overrides - Block_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject164').huntingQueryVersion164]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_164",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Total Emails with Admin Overrides (Block)",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where OrgLevelPolicy != \"\" and OrgLevelAction == \"Block\"\n| make-series TotalAdminOverrides = count() default = 0 on Timestamp step 1d\n// | render columnchart // Uncomment this line to render as a graph\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the amount of emails subject to an admin policy with action of block, summarizing the data daily"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject164')._huntingQuerycontentId164),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 164",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject164')._huntingQuerycontentId164)]",
                "contentId": "[variables('huntingQueryObject164')._huntingQuerycontentId164]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject164').huntingQueryVersion164]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject164')._huntingQuerycontentId164]",
        "contentKind": "HuntingQuery",
        "displayName": "Total Emails with Admin Overrides (Block)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject164')._huntingQuerycontentId164,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject164')._huntingQuerycontentId164,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject165').huntingQueryTemplateSpecName165]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Total Emails with User Overrides - Allow_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject165').huntingQueryVersion165]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_165",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Total Emails with User Overrides (Allow)",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where UserLevelPolicy != \"\" and UserLevelAction == \"Allow\"\n| summarize Emails=count() by UserLevelAction,UserLevelPolicy,ThreatTypes\n| sort by Emails\n// | render columnchart // Uncomment this line to render as a graph\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the amount of emails subject to a user type policy with action of allow, summarizing the data by type of override and threats type found"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject165')._huntingQuerycontentId165),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 165",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject165')._huntingQuerycontentId165)]",
                "contentId": "[variables('huntingQueryObject165')._huntingQuerycontentId165]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject165').huntingQueryVersion165]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject165')._huntingQuerycontentId165]",
        "contentKind": "HuntingQuery",
        "displayName": "Total Emails with User Overrides (Allow)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject165')._huntingQuerycontentId165,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject165')._huntingQuerycontentId165,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject166').huntingQueryTemplateSpecName166]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Total Emails with User Overrides - Block_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject166').huntingQueryVersion166]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_166",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Total Emails with User Overrides (Block)",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where UserLevelPolicy != \"\" and UserLevelAction == \"Block\"\n| make-series TotalUserOverrides = count() default = 0 on Timestamp step 1d\n// | render columnchart // Uncomment this line to render as a graph\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the amount of emails subject to a user type policy with action of block, summarizing the data daily"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject166')._huntingQuerycontentId166),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 166",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject166')._huntingQuerycontentId166)]",
                "contentId": "[variables('huntingQueryObject166')._huntingQuerycontentId166]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject166').huntingQueryVersion166]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject166')._huntingQuerycontentId166]",
        "contentKind": "HuntingQuery",
        "displayName": "Total Emails with User Overrides (Block)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject166')._huntingQuerycontentId166,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject166')._huntingQuerycontentId166,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject167').huntingQueryTemplateSpecName167]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Phish Detection Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject167').huntingQueryVersion167]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_167",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Phish Detections Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nEmailEvents\n| where TimeGenerated >= TimeStart\n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\n| where ThreatTypes has \"Phish\"\n| make-series PhishDetections = count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Phish detections over time summarizing the data daily."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject167')._huntingQuerycontentId167),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 167",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject167')._huntingQuerycontentId167)]",
                "contentId": "[variables('huntingQueryObject167')._huntingQuerycontentId167]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject167').huntingQueryVersion167]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject167')._huntingQuerycontentId167]",
        "contentKind": "HuntingQuery",
        "displayName": "Phish Detections Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject167')._huntingQuerycontentId167,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject167')._huntingQuerycontentId167,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject168').huntingQueryTemplateSpecName168]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Phish Detections by Delivery Location - High_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject168').huntingQueryVersion168]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_168",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Phish Detections (High) by delivery location",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\n| where ConfidenceLevel has_any ('Phish\":\"High')\n| summarize count() by LatestDeliveryLocation\n| sort by count_ desc\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises emails with Phish detections (High confidence) summarizing the data by Delivery Location."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject168')._huntingQuerycontentId168),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 168",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject168')._huntingQuerycontentId168)]",
                "contentId": "[variables('huntingQueryObject168')._huntingQuerycontentId168]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject168').huntingQueryVersion168]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject168')._huntingQuerycontentId168]",
        "contentKind": "HuntingQuery",
        "displayName": "Phish Detections (High) by delivery location",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject168')._huntingQuerycontentId168,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject168')._huntingQuerycontentId168,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject169').huntingQueryTemplateSpecName169]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Phish Detections by Delivery Location - Medium_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject169').huntingQueryVersion169]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_169",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Phish Detections (Normal) by delivery location",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\n| where ConfidenceLevel has_any ('Phish\":\"Normal')\n| summarize count() by LatestDeliveryLocation\n| sort by count_ desc\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises emails with Phish detections (Normal confidence) summarizing the data by Delivery Location."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject169')._huntingQuerycontentId169),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 169",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject169')._huntingQuerycontentId169)]",
                "contentId": "[variables('huntingQueryObject169')._huntingQuerycontentId169]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject169').huntingQueryVersion169]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject169')._huntingQuerycontentId169]",
        "contentKind": "HuntingQuery",
        "displayName": "Phish Detections (Normal) by delivery location",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject169')._huntingQuerycontentId169,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject169')._huntingQuerycontentId169,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject170').huntingQueryTemplateSpecName170]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Phish Detections by Delivery Location Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject170').huntingQueryVersion170]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_170",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Phish Detections by delivery location trend",
                "category": "Hunting Queries",
                "query": "EmailEvents\n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\n| where DetectionMethods has \"Phish\" and EmailDirection == \"Inbound\"\n| make-series TotalPhishDetections=count(),Quarantine = countif(DeliveryLocation == \"Quarantine\"),Junkfolder=countif(DeliveryLocation == \"Junk folder\") ,Inbox=countif(DeliveryLocation == \"Inbox/folder\"),Failed=countif(DeliveryLocation == \"Failed\"),Dropped=countif(DeliveryLocation == \"Dropped\") default = 0 on Timestamp step 1d\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Phish detections over time summarizing the data daily by Delivery Location."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject170')._huntingQuerycontentId170),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 170",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject170')._huntingQuerycontentId170)]",
                "contentId": "[variables('huntingQueryObject170')._huntingQuerycontentId170]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject170').huntingQueryVersion170]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject170')._huntingQuerycontentId170]",
        "contentKind": "HuntingQuery",
        "displayName": "Phish Detections by delivery location trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject170')._huntingQuerycontentId170,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject170')._huntingQuerycontentId170,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject171').huntingQueryTemplateSpecName171]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Phish Detections by Detection Technology Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject171').huntingQueryVersion171]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_171",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Phish Detections by Detection technology Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = EmailEvents\n| where TimeGenerated >= TimeStart\n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\n| where DetectionMethods has \"Phish\";\nlet ml=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Advanced filter'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Advanced filter\";\nlet camp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Campaign'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Campaign\";\nlet fd=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'File detonation' and Phish !has 'File detonation reputation'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"File detonation\";\nlet fdr=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'File detonation reputation'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"File detonation reputation\";\nlet frp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Fingerprint matching' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Fingerprint matching\";\nlet gf=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'General filter' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"General filter\";\nlet bimp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Impersonation brand' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Impersonation brand\";\nlet dimp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Impersonation domain' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Impersonation domain\";\nlet uimp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Impersonation user' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Impersonation user\";\nlet mimp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Mailbox intelligence impersonation' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Mailbox intelligence impersonation\";\nlet sdmarc=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Spoof DMARC' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Spoof DMARC\";\nlet spoofe=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Spoof external domain' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Spoof external domain\";\nlet spoofi=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Spoof intra-org' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Spoof intra-org\";\nlet ud=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'URL detonation' and Phish !has 'URL detonation reputation'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"URL detonation\";\nlet udr=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'URL detonation reputation' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"URL detonation reputation\";\nlet umr=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'URL malicious reputation' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"URL malicious reputation\";\nunion ml,camp,fd,fdr,frp,gf,bimp,dimp,uimp,mimp,sdmarc,spoofe,spoofi,ud,udr,umr\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Phish detections over time summarizing the data daily by various Phish Detection technologies/controls"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject171')._huntingQuerycontentId171),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 171",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject171')._huntingQuerycontentId171)]",
                "contentId": "[variables('huntingQueryObject171')._huntingQuerycontentId171]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject171').huntingQueryVersion171]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject171')._huntingQuerycontentId171]",
        "contentKind": "HuntingQuery",
        "displayName": "Phish Detections by Detection technology Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject171')._huntingQuerycontentId171,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject171')._huntingQuerycontentId171,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject172').huntingQueryTemplateSpecName172]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Phish Detections by Detection Technology_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject172').huntingQueryVersion172]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_172",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Phish Detections by Detection technology",
                "category": "Hunting Queries",
                "query": "EmailEvents \n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\n| where ThreatTypes has 'Phish' \n| project Timestamp, DT=parse_json(DetectionMethods) \n| evaluate bag_unpack(DT) \n| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\n| sort by count_ desc\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Phish detections summarizing the data by various Phish detection technologies/controls"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject172')._huntingQuerycontentId172),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 172",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject172')._huntingQuerycontentId172)]",
                "contentId": "[variables('huntingQueryObject172')._huntingQuerycontentId172]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject172').huntingQueryVersion172]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject172')._huntingQuerycontentId172]",
        "contentKind": "HuntingQuery",
        "displayName": "Phish Detections by Detection technology",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject172')._huntingQuerycontentId172,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject172')._huntingQuerycontentId172,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject173').huntingQueryTemplateSpecName173]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Possible device code phishing attempts_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject173').huntingQueryVersion173]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_173",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Possible device code phishing attempts",
                "category": "Hunting Queries",
                "query": "let suspiciousUserClicks = materialize(UrlClickEvents\n  | where ActionType in (\"ClickAllowed\", \"UrlScanInProgress\", \"UrlErrorPage\") or IsClickedThrough != \"0\"\n  | where UrlChain has_any (\"microsoft.com/devicelogin\", \"login.microsoftonline.com/common/oauth2/deviceauth\")\n  | extend AccountUpn = tolower(AccountUpn)\n  | project ClickTime = Timestamp, ActionType, UrlChain, NetworkMessageId, Url, AccountUpn);\n//Check for Risky Sign-In in the short time window\nlet interestedUsersUpn = suspiciousUserClicks\n  | where isnotempty(AccountUpn)\n  | distinct AccountUpn;\nlet suspiciousSignIns = materialize(AADSignInEventsBeta\n  | where ErrorCode == 0\n  | where AccountUpn in~ (interestedUsersUpn)\n  | where RiskLevelDuringSignIn in (10, 50, 100)\n  | extend AccountUpn = tolower(AccountUpn)\n  | join kind=inner suspiciousUserClicks on AccountUpn\n  | where (Timestamp - ClickTime) between (-2min .. 7min)\n  | project Timestamp, ReportId, ClickTime, AccountUpn, RiskLevelDuringSignIn, SessionId, IPAddress, Url\n);\n//Validate errorCode 50199 followed by success in 5 minute time interval for the interested user, which suggests a pause to input the code from the phishing email\nlet interestedSessionUsers = suspiciousSignIns\n  | where isnotempty(AccountUpn)\n  | distinct AccountUpn;\nlet shortIntervalSignInAttemptUsers = materialize(AADSignInEventsBeta\n  | where AccountUpn in~ (interestedSessionUsers)\n  | where ErrorCode in (0, 50199)\n  | summarize ErrorCodes = make_set(ErrorCode) by AccountUpn, CorrelationId, SessionId\n  | where ErrorCodes has_all (0, 50199)\n  | distinct AccountUpn);\nsuspiciousSignIns\n| where AccountUpn in (shortIntervalSignInAttemptUsers)\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps hunting for possible device code Phishing attempts"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject173')._huntingQuerycontentId173),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 173",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject173')._huntingQuerycontentId173)]",
                "contentId": "[variables('huntingQueryObject173')._huntingQuerycontentId173]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject173').huntingQueryVersion173]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject173')._huntingQuerycontentId173]",
        "contentKind": "HuntingQuery",
        "displayName": "Possible device code phishing attempts",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject173')._huntingQuerycontentId173,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject173')._huntingQuerycontentId173,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject174').huntingQueryTemplateSpecName174]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top Domains sending Phish_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject174').huntingQueryVersion174]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_174",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Email Top Domains sending Phish",
                "category": "Hunting Queries",
                "query": "EmailEvents \n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\n| where ThreatTypes has \"Phish\" and EmailDirection == \"Inbound\"\n| summarize count() by SenderFromDomain\n| sort by count_\n| top 15 by count_\n//| render columnchart // Uncomment to display as a column graph\n//| render piechart // Uncomment to display as a piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total inbound emails with Phish detections summarizing the data by the top email sender P2 domain (SenderFromDomain)."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject174')._huntingQuerycontentId174),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 174",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject174')._huntingQuerycontentId174)]",
                "contentId": "[variables('huntingQueryObject174')._huntingQuerycontentId174]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject174').huntingQueryVersion174]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject174')._huntingQuerycontentId174]",
        "contentKind": "HuntingQuery",
        "displayName": "Email Top Domains sending Phish",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject174')._huntingQuerycontentId174,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject174')._huntingQuerycontentId174,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject175').huntingQueryTemplateSpecName175]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top Users receiving Phish_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject175').huntingQueryVersion175]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_175",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top Users receiving Phish",
                "category": "Hunting Queries",
                "query": "EmailEvents\n//| where OrgLevelPolicy != \"Phishing simulation\" and OrgLevelPolicy != \"SecOps Mailbox\"\n| where ThreatTypes has \"Phish\" and EmailDirection == \"Inbound\"\n| summarize count() by RecipientEmailAddress\n| sort by count_\n| top 15 by count_\n//| render columnchart // Uncomment to display as a column graph\n//| render piechart // Uncomment to display as a piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total inbound emails with Phish detections summarizing the data by the top recipient email address (RecipientEmailAddress)"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject175')._huntingQuerycontentId175),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 175",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject175')._huntingQuerycontentId175)]",
                "contentId": "[variables('huntingQueryObject175')._huntingQuerycontentId175]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject175').huntingQueryVersion175]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject175')._huntingQuerycontentId175]",
        "contentKind": "HuntingQuery",
        "displayName": "Top Users receiving Phish",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject175')._huntingQuerycontentId175,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject175')._huntingQuerycontentId175,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject176').huntingQueryTemplateSpecName176]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zero-day Phish Detections Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject176').huntingQueryVersion176]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_176",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Zero-day Phish Detections Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = EmailEvents\n| where TimeGenerated >= TimeStart\n| where DetectionMethods has \"Phish\";\nlet fd=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'File detonation' and Phish !has 'File detonation reputation'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"File detonation\";\nlet ud=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'URL detonation' and Phish !has 'URL detonation reputation'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"URL detonation\";\nunion fd,ud\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Phish detections over time summarizing the data daily by Phish detection technologies/controls used for detecting unknown-unique phish"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject176')._huntingQuerycontentId176),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 176",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject176')._huntingQuerycontentId176)]",
                "contentId": "[variables('huntingQueryObject176')._huntingQuerycontentId176]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject176').huntingQueryVersion176]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject176')._huntingQuerycontentId176]",
        "contentKind": "HuntingQuery",
        "displayName": "Zero-day Phish Detections Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject176')._huntingQuerycontentId176,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject176')._huntingQuerycontentId176,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject177').huntingQueryTemplateSpecName177]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Campaign with randomly named attachments_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject177').huntingQueryVersion177]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_177",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Campaign with randomly named attachments",
                "category": "Hunting Queries",
                "query": "EmailAttachmentInfo\n| where Timestamp > ago(7d)\n| where FileType in (\"png\", \"jpg\", \"jpeg\", \"gif\", \"svg\")\n| where isnotempty(FileName)\n| extend firstFourFileName = substring(FileName, 0, 4)\n| summarize RecipientsCount = dcount(RecipientEmailAddress), FirstFourFilesCount = dcount(firstFourFileName), suspiciousEmails = make_set(NetworkMessageId, 10) by SenderFromAddress\n| where FirstFourFilesCount >= 10\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this detection,we hunt for emails with randomly named attachment names from the same sender to multiple recipients"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject177')._huntingQuerycontentId177),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 177",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject177')._huntingQuerycontentId177)]",
                "contentId": "[variables('huntingQueryObject177')._huntingQuerycontentId177]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject177').huntingQueryVersion177]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject177')._huntingQuerycontentId177]",
        "contentKind": "HuntingQuery",
        "displayName": "Campaign with randomly named attachments",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject177')._huntingQuerycontentId177,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject177')._huntingQuerycontentId177,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject178').huntingQueryTemplateSpecName178]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Campaign with suspicious keywords_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject178').huntingQueryVersion178]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_178",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Campaign with suspicious keywords",
                "category": "Hunting Queries",
                "query": "let PhishingKeywords = ()\n{pack_array(\"account\", \"alert\", \"bank\", \"billing\", \"card\", \"change\", \"confirmation\",\"login\", \"password\", \"mfa\", \"authorize\", \"authenticate\", \"payment\", \"urgent\", \"verify\", \"blocked\");};\nEmailEvents\n| where Timestamp > ago(1d)\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Delivered\"\n| where isempty(SenderObjectId)\n| where Subject has_any (PhishingKeywords())\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this detection, we track emails with suspicious keywords in subjects."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject178')._huntingQuerycontentId178),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 178",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject178')._huntingQuerycontentId178)]",
                "contentId": "[variables('huntingQueryObject178')._huntingQuerycontentId178]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject178').huntingQueryVersion178]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject178')._huntingQuerycontentId178]",
        "contentKind": "HuntingQuery",
        "displayName": "Campaign with suspicious keywords",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject178')._huntingQuerycontentId178,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject178')._huntingQuerycontentId178,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject179').huntingQueryTemplateSpecName179]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Custom detection-Emails with QR from non-prevalent senders_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject179').huntingQueryVersion179]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_179",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Custom detection-Emails with QR from non-prevalent senders",
                "category": "Hunting Queries",
                "query": "let QRCode_emails = EmailUrlInfo\n| where Timestamp > ago (2d)\n| where UrlLocation == \"QRCode\"\n| distinct Url,NetworkMessageId;\nlet nMIDs = QRCode_emails | distinct NetworkMessageId;\n// Extracting sender of the email with QRCode:\nlet senders_NMIDs = EmailEvents\n| where Timestamp > ago (2d)\n| where DeliveryAction != \"Blocked\" // Only delivered or Junked emails are interesting\n| where isnotempty(NetworkMessageId)\n| where NetworkMessageId in (nMIDs)\n| distinct  Timestamp, NetworkMessageId, RecipientEmailAddress, SenderFromAddress, InternetMessageId, RecipientObjectId, ReportId;\nlet senders = senders_NMIDs\n| distinct SenderFromAddress;\n// Checking sender prevalence in the organization\nlet senderprevalence = EmailEvents\n| where Timestamp between (ago(14d)..(now()-24h))\n| where isnotempty(SenderFromAddress)\n| where SenderFromAddress in (senders)\n| summarize TotalEmailCount = count()  by SenderFromAddress\n| where TotalEmailCount > 1;\nlet prevalent_Sender = senderprevalence\n| where isnotempty (SenderFromAddress)\n| distinct SenderFromAddress;\n// Checking where email sender was not prevalent.\nlet nMIDs_from_non_prevalent_Senders = senders_NMIDs\n| where SenderFromAddress !in (prevalent_Sender)\n| distinct NetworkMessageId;\nlet QRCode_emails_from_non_prevalent_senders = QRCode_emails\n| where NetworkMessageId in (nMIDs_from_non_prevalent_Senders)\n| join kind=inner senders_NMIDs on NetworkMessageId\n| project Timestamp,Url,NetworkMessageId, InternetMessageId, RecipientObjectId,RecipientEmailAddress, ReportId;\nQRCode_emails_from_non_prevalent_senders\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this detection, we check the sender prevalence over the last 14 days and use the same to detect malicious activity via email containing QR code"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject179')._huntingQuerycontentId179),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 179",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject179')._huntingQuerycontentId179)]",
                "contentId": "[variables('huntingQueryObject179')._huntingQuerycontentId179]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject179').huntingQueryVersion179]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject179')._huntingQuerycontentId179]",
        "contentKind": "HuntingQuery",
        "displayName": "Custom detection-Emails with QR from non-prevalent senders",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject179')._huntingQuerycontentId179,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject179')._huntingQuerycontentId179,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject180').huntingQueryTemplateSpecName180]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Emails delivered having URLs from QR codes_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject180').huntingQueryVersion180]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_180",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Emails delivered having URLs from QR codes",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where Timestamp > ago(30d)\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Delivered\"\n| join EmailUrlInfo on NetworkMessageId\n| where UrlLocation == \"QRCode\"\n| project Timestamp, NetworkMessageId, SenderFromAddress, Subject, Url, UrlDomain, UrlLocation,RecipientEmailAddress\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this query, we hunt for inbound emails delivered having URLs from QR codes"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject180')._huntingQuerycontentId180),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 180",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject180')._huntingQuerycontentId180)]",
                "contentId": "[variables('huntingQueryObject180')._huntingQuerycontentId180]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject180').huntingQueryVersion180]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject180')._huntingQuerycontentId180]",
        "contentKind": "HuntingQuery",
        "displayName": "Emails delivered having URLs from QR codes",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject180')._huntingQuerycontentId180,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject180')._huntingQuerycontentId180,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject181').huntingQueryTemplateSpecName181]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Emails with QR codes and suspicious keywords in subject_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject181').huntingQueryVersion181]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_181",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Emails with QR codes and suspicious keywords in subject",
                "category": "Hunting Queries",
                "query": "let SubjectKeywords = ()\n{pack_array(\"authorize\", \"authenticate\", \"account\", \"confirmation\", \"QR\", \"login\", \"password\",  \"payment\", \"urgent\", \"verify\");};\nEmailEvents\n| where Timestamp > ago(30d)\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Delivered\"\n| where Subject has_any (SubjectKeywords)\n| join EmailUrlInfo on NetworkMessageId\n| where UrlLocation == \"QRCode\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this query, we hunt for inbound emails having URLs from QR codes and suspicious keywords in subject"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject181')._huntingQuerycontentId181),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 181",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject181')._huntingQuerycontentId181)]",
                "contentId": "[variables('huntingQueryObject181')._huntingQuerycontentId181]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject181').huntingQueryVersion181]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject181')._huntingQuerycontentId181]",
        "contentKind": "HuntingQuery",
        "displayName": "Emails with QR codes and suspicious keywords in subject",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject181')._huntingQuerycontentId181,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject181')._huntingQuerycontentId181,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject182').huntingQueryTemplateSpecName182]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Emails with QR codes from non-prevalent sender_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject182').huntingQueryVersion182]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_182",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Emails with QR codes from non-prevalent sender",
                "category": "Hunting Queries",
                "query": "let senderprevalence =\nEmailEvents\n| where Timestamp between (ago(7d)..(now()-24h))\n| where isnotempty(SenderFromAddress)\n| summarize TotalEmailCount = dcount(NetworkMessageId) by SenderFromAddress\n| where TotalEmailCount > 1;\nlet prevalent_Sender = senderprevalence\n| where isnotempty (SenderFromAddress)\n| distinct SenderFromAddress;\nlet QR_from_non_prevalent =\nEmailEvents\n| where EmailDirection == \"Inbound\"\n| where Timestamp > ago(1d)\n| where SenderFromAddress !in (prevalent_Sender)\n| join EmailUrlInfo on NetworkMessageId\n| where UrlLocation == \"QRCode\"\n| distinct SenderFromAddress,Url,NetworkMessageId;\nQR_from_non_prevalent\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this query, we hunt for inbound emails having URLs from QR codes and send by non-prevalent senders"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject182')._huntingQuerycontentId182),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 182",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject182')._huntingQuerycontentId182)]",
                "contentId": "[variables('huntingQueryObject182')._huntingQuerycontentId182]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject182').huntingQueryVersion182]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject182')._huntingQuerycontentId182]",
        "contentKind": "HuntingQuery",
        "displayName": "Emails with QR codes from non-prevalent sender",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject182')._huntingQuerycontentId182,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject182')._huntingQuerycontentId182,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject183').huntingQueryTemplateSpecName183]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Hunting for sender patterns_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject183').huntingQueryVersion183]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_183",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Hunting for sender patterns",
                "category": "Hunting Queries",
                "query": "let PhishingSenderDisplayNames = ()\n{\npack_array(\"IT\", \"support\", \"Payroll\", \"HR\", \"admin\", \"2FA\", \"notification\", \"sign\", \"reminder\", \"consent\", \"workplace\",\n\"administrator\", \"administration\", \"benefits\", \"employee\", \"update\", \"on behalf\");\n};\nlet suspiciousEmails = EmailEvents\n| where Timestamp > ago(1d)\n| where isnotempty(RecipientObjectId)\n| where isnotempty(SenderFromAddress)\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Delivered\"\n| join kind=inner (EmailAttachmentInfo\n| where Timestamp > ago(1d)\n| where isempty(SenderObjectId)\n| where FileType has_any (\"png\", \"jpg\", \"jpeg\", \"bmp\", \"gif\")\n ) on NetworkMessageId\n| where SenderDisplayName has_any (PhishingSenderDisplayNames())\n| project Timestamp, Subject, FileName, SenderFromDomain, RecipientObjectId, NetworkMessageId;\nlet suspiciousSenders = suspiciousEmails | distinct SenderFromDomain;\nlet prevalentSenders = materialize(EmailEvents\n| where Timestamp between (ago(7d) .. ago(1d))\n| where isnotempty(RecipientObjectId)\n| where isnotempty(SenderFromAddress)\n| where SenderFromDomain in (suspiciousSenders)\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Delivered\"\n| distinct SenderFromDomain);\nsuspiciousEmails\n| where SenderFromDomain !in (prevalentSenders)\n| project Timestamp, Subject, FileName, SenderFromDomain, RecipientObjectId, NetworkMessageId\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this detection approach, we correlate email from non-prevalent senders in the organization with impersonation intents"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject183')._huntingQuerycontentId183),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 183",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject183')._huntingQuerycontentId183)]",
                "contentId": "[variables('huntingQueryObject183')._huntingQuerycontentId183]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject183').huntingQueryVersion183]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject183')._huntingQuerycontentId183]",
        "contentKind": "HuntingQuery",
        "displayName": "Hunting for sender patterns",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject183')._huntingQuerycontentId183,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject183')._huntingQuerycontentId183,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject184').huntingQueryTemplateSpecName184]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Hunting for user signals-clusters_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject184').huntingQueryVersion184]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_184",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Hunting for user signals-clusters",
                "category": "Hunting Queries",
                "query": "let suspiciousClusters = EmailEvents\n| where Timestamp > ago(7d)\n| where EmailDirection == \"Inbound\"\n| where NetworkMessageId in (\"5ff15b1f-d731-4625-4c1c-08dc8615943f\",\"00ff0916-1263-428c-a558-08dc86a6d3cd\") //<List of suspicious Network Message Ids from Alerts>\n| distinct EmailClusterId;\nEmailEvents\n| where Timestamp > ago(7d)\n| where EmailDirection == \"Inbound\"\n| where EmailClusterId in (suspiciousClusters)\n| summarize make_set(Subject), make_set(SenderFromDomain), dcount(RecipientObjectId),dcount(SenderDisplayName) by EmailClusterId\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this detection,we use Email reported by user as malware or phish MDO alert as a starting point to identify the scope of a campaign."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject184')._huntingQuerycontentId184),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 184",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject184')._huntingQuerycontentId184)]",
                "contentId": "[variables('huntingQueryObject184')._huntingQuerycontentId184]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject184').huntingQueryVersion184]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject184')._huntingQuerycontentId184]",
        "contentKind": "HuntingQuery",
        "displayName": "Hunting for user signals-clusters",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject184')._huntingQuerycontentId184,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject184')._huntingQuerycontentId184,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject185').huntingQueryTemplateSpecName185]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Inbound emails with QR code URLs_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject185').huntingQueryVersion185]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_185",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Inbound emails with QR code URLs",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where Timestamp > ago(30d)\n| where EmailDirection == \"Inbound\"\n| join EmailUrlInfo on NetworkMessageId\n| where UrlLocation == \"QRCode\"\n| summarize dcount(NetworkMessageId) by bin(Timestamp, 1d)\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this query, we summarize volume of inbound emails with QR code URLs in last 30 days"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject185')._huntingQuerycontentId185),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 185",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject185')._huntingQuerycontentId185)]",
                "contentId": "[variables('huntingQueryObject185')._huntingQuerycontentId185]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject185').huntingQueryVersion185]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject185')._huntingQuerycontentId185]",
        "contentKind": "HuntingQuery",
        "displayName": "Inbound emails with QR code URLs",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject185')._huntingQuerycontentId185,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject185')._huntingQuerycontentId185,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject186').huntingQueryTemplateSpecName186]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Personalized campaigns based on the first few keywords_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject186').huntingQueryVersion186]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_186",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Personalized campaigns based on the first few keywords",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where Timestamp > ago(1d)\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Delivered\"\n| where isempty(SenderObjectId)\n| extend words = split(Subject,\" \")\n| project firstWord = tostring(words[0]), secondWord = tostring(words[1]), thirdWord = tostring(words[2]), Subject, SenderFromAddress, RecipientEmailAddress, NetworkMessageId\n| summarize SubjectsCount = dcount(Subject), RecipientsCount = dcount(RecipientEmailAddress), suspiciousEmails = make_set(NetworkMessageId, 10) by firstWord, secondWord, thirdWord, SenderFromAddress\n| where SubjectsCount >= 10\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this detection, we track emails with personalized subjects."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject186')._huntingQuerycontentId186),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 186",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject186')._huntingQuerycontentId186)]",
                "contentId": "[variables('huntingQueryObject186')._huntingQuerycontentId186]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject186').huntingQueryVersion186]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject186')._huntingQuerycontentId186]",
        "contentKind": "HuntingQuery",
        "displayName": "Personalized campaigns based on the first few keywords",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject186')._huntingQuerycontentId186,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject186')._huntingQuerycontentId186,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject187').huntingQueryTemplateSpecName187]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Personalized campaigns based on the last few keywords_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject187').huntingQueryVersion187]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_187",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Personalized campaigns based on the last few keywords",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where Timestamp > ago(1d)\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Delivered\"\n| where isempty(SenderObjectId)\n| extend words = split(Subject,\" \")\n| project firstLastWord = tostring(words[-1]), secondLastWord = tostring(words[-2]), thirdLastWord = tostring(words[-3]), Subject, SenderFromAddress, RecipientEmailAddress, NetworkMessageId\n| summarize SubjectsCount = dcount(Subject), RecipientsCount = dcount(RecipientEmailAddress), suspiciousEmails = make_set(NetworkMessageId, 10) by firstLastWord, secondLastWord, thirdLastWord, SenderFromAddress\n| where SubjectsCount >= 10\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this detection, we track emails with personalized subjects."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject187')._huntingQuerycontentId187),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 187",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject187')._huntingQuerycontentId187)]",
                "contentId": "[variables('huntingQueryObject187')._huntingQuerycontentId187]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject187').huntingQueryVersion187]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject187')._huntingQuerycontentId187]",
        "contentKind": "HuntingQuery",
        "displayName": "Personalized campaigns based on the last few keywords",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject187')._huntingQuerycontentId187,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject187')._huntingQuerycontentId187,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject188').huntingQueryTemplateSpecName188]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Risky sign-in attempt from a non-managed device_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject188').huntingQueryVersion188]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_188",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Risky sign-in attempt from a non-managed device",
                "category": "Hunting Queries",
                "query": "AADSignInEventsBeta\n| where Timestamp > ago(7d)\n| where IsManaged != 1\n| where IsCompliant != 1\n//Filtering only for medium and high risk sign-in\n| where RiskLevelDuringSignIn in (50, 100)\n| where ClientAppUsed == \"Browser\"\n| where isempty(DeviceTrustType)\n| where isnotempty(State) or isnotempty(Country) or isnotempty(City)\n| where isnotempty(IPAddress)\n| where isnotempty(AccountObjectId)\n| where isempty(DeviceName)\n| where isempty(AadDeviceId)\n| project Timestamp,IPAddress, AccountObjectId, ApplicationId, SessionId, RiskLevelDuringSignIn\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this detection,we hunt for any sign-in attempt from a non-managed, non-compliant, untrusted device."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject188')._huntingQuerycontentId188),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 188",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject188')._huntingQuerycontentId188)]",
                "contentId": "[variables('huntingQueryObject188')._huntingQuerycontentId188]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject188').huntingQueryVersion188]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject188')._huntingQuerycontentId188]",
        "contentKind": "HuntingQuery",
        "displayName": "Risky sign-in attempt from a non-managed device",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject188')._huntingQuerycontentId188,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject188')._huntingQuerycontentId188,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject189').huntingQueryTemplateSpecName189]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Suspicious sign-in attempts from QR code phishing campaigns_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject189').huntingQueryVersion189]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_189",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Suspicious sign-in attempts from QR code phishing campaigns",
                "category": "Hunting Queries",
                "query": "let successfulRiskySignIn = materialize(AADSignInEventsBeta\n| where Timestamp > ago(1d)\n| where isempty(DeviceTrustType)\n| where IsManaged != 1\n| where IsCompliant != 1\n| where RiskLevelDuringSignIn in (50, 100)\n| project Timestamp, ReportId, IPAddress, AccountUpn, AccountObjectId, SessionId, Country, State, City\n);\nlet suspiciousSignInUsers = successfulRiskySignIn\n| distinct AccountObjectId;\nlet suspiciousSignInIPs = successfulRiskySignIn\n| distinct IPAddress;\nlet suspiciousSignInCities = successfulRiskySignIn\n| distinct City;\nCloudAppEvents\n| where Timestamp > ago(1d)\n| where ActionType == \"MailItemsAccessed\"\n| where AccountObjectId in (suspiciousSignInUsers)\n| where IPAddress !in (suspiciousSignInIPs)\n| where City !in (suspiciousSignInCities)\n| join kind=inner successfulRiskySignIn on AccountObjectId\n| where AccountObjectId in (suspiciousSignInUsers)\n| where (Timestamp - Timestamp1) between (-5min .. 5min)\n| extend folders = RawEventData.Folders\n| mv-expand folders\n| extend items = folders.FolderItems\n| mv-expand items\n| extend InternetMessageId = tostring(items.InternetMessageId)\n| project Timestamp, ReportId, IPAddress, InternetMessageId, AccountObjectId, SessionId, Country, State, City\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This detection approach correlates a user accessing an email with image/document attachments and a risky sign-in attempt from non-trusted devices."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject189')._huntingQuerycontentId189),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 189",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject189')._huntingQuerycontentId189)]",
                "contentId": "[variables('huntingQueryObject189')._huntingQuerycontentId189]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject189').huntingQueryVersion189]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject189')._huntingQuerycontentId189]",
        "contentKind": "HuntingQuery",
        "displayName": "Suspicious sign-in attempts from QR code phishing campaigns",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject189')._huntingQuerycontentId189,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject189')._huntingQuerycontentId189,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject190').huntingQueryTemplateSpecName190]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Group quarantine release_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject190').huntingQueryVersion190]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_190",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Group quarantine release",
                "category": "Hunting Queries",
                "query": "CloudAppEvents \n| where ActionType == \"QuarantineReleaseMessage\"\n| extend parsed=parse_json(RawEventData)\n| extend NetworkMessageId = tostring(parsed.NetworkMessageId)\n| join EmailEvents on NetworkMessageId\n| summarize count() by DetectionMethods\n| order by count_ desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps in reviewing group Quarantine released messages by detection type. Useful to see what is leading to the largest number of messages being released."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject190')._huntingQuerycontentId190),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 190",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject190')._huntingQuerycontentId190)]",
                "contentId": "[variables('huntingQueryObject190')._huntingQuerycontentId190]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject190').huntingQueryVersion190]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject190')._huntingQuerycontentId190]",
        "contentKind": "HuntingQuery",
        "displayName": "Group quarantine release",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject190')._huntingQuerycontentId190,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject190')._huntingQuerycontentId190,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject191').huntingQueryTemplateSpecName191]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "High Confidence Phish Released_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject191').huntingQueryVersion191]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_191",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "High Confidence Phish Released",
                "category": "Hunting Queries",
                "query": "CloudAppEvents \n| where ActionType == \"QuarantineReleaseMessage\"\n| project ReleaseTime = Timestamp, ResultStatus = RawEventData.ResultStatus, ActionType, ReleasedBy = tostring(RawEventData.UserId), NetworkMessageId = tostring(RawEventData.NetworkMessageId), ReleaseTo = RawEventData.ReleaseTo\n| join kind=inner (\n  EmailEvents\n  | where todynamic(ConfidenceLevel).Phish == \"High\"\n  | project-rename EmailTime = Timestamp\n  ) on NetworkMessageId\n| project-away NetworkMessageId1\n| order by ReleaseTime asc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query shows information about high confidence phish email that has been released from the Quarantine."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject191')._huntingQuerycontentId191),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 191",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject191')._huntingQuerycontentId191)]",
                "contentId": "[variables('huntingQueryObject191')._huntingQuerycontentId191]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject191').huntingQueryVersion191]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject191')._huntingQuerycontentId191]",
        "contentKind": "HuntingQuery",
        "displayName": "High Confidence Phish Released",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject191')._huntingQuerycontentId191,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject191')._huntingQuerycontentId191,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject192').huntingQueryTemplateSpecName192]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Quarantine Phish reason trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject192').huntingQueryVersion192]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_192",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Quarantine Phish Reason trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = EmailEvents\n| where TimeGenerated >= TimeStart\n| where DetectionMethods has \"Phish\" and DeliveryLocation == \"Quarantine\";\nlet ml=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Advanced filter'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Advanced filter\";\nlet camp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Campaign'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Campaign\";\nlet fd=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'File detonation' and Phish !has 'File detonation reputation'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"File detonation\";\nlet fdr=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'File detonation reputation'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"File detonation reputation\";\nlet frp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Fingerprint matching' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Fingerprint matching\";\nlet gf=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'General filter' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"General filter\";\nlet bimp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Impersonation brand' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Impersonation brand\";\nlet dimp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Impersonation domain' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Impersonation domain\";\nlet uimp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Impersonation user' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Impersonation user\";\nlet mimp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Mailbox intelligence impersonation' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Mailbox intelligence impersonation\";\nlet sdmarc=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Spoof DMARC' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Spoof DMARC\";\nlet spoofe=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Spoof external domain' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Spoof external domain\";\nlet spoofi=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Spoof intra-org' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Spoof intra-org\";\nlet ud=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'URL detonation' and Phish !has 'URL detonation reputation'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"URL detonation\";\nlet udr=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'URL detonation reputation' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"URL detonation reputation\";\nlet umr=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'URL malicious reputation' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"URL malicious reputation\";\nunion ml,camp,fd,fdr,frp,gf,bimp,dimp,uimp,mimp,sdmarc,spoofe,spoofi,ud,udr,umr\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the amount of phish emails that are quarantined, summarized daily by the detection method"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject192')._huntingQuerycontentId192),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 192",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject192')._huntingQuerycontentId192)]",
                "contentId": "[variables('huntingQueryObject192')._huntingQuerycontentId192]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject192').huntingQueryVersion192]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject192')._huntingQuerycontentId192]",
        "contentKind": "HuntingQuery",
        "displayName": "Quarantine Phish Reason trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject192')._huntingQuerycontentId192,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject192')._huntingQuerycontentId192,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject193').huntingQueryTemplateSpecName193]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Quarantine Phish reason_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject193').huntingQueryVersion193]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_193",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Quarantine Phish Reason",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Inbound\" and DetectionMethods has 'Phish' and DeliveryLocation == \"Quarantine\"\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the total amount of phish emails that are quarantined, summarized by the detection method"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject193')._huntingQuerycontentId193),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 193",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject193')._huntingQuerycontentId193)]",
                "contentId": "[variables('huntingQueryObject193')._huntingQuerycontentId193]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject193').huntingQueryVersion193]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject193')._huntingQuerycontentId193]",
        "contentKind": "HuntingQuery",
        "displayName": "Quarantine Phish Reason",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject193')._huntingQuerycontentId193,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject193')._huntingQuerycontentId193,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject194').huntingQueryTemplateSpecName194]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Quarantine Release Email Details_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject194').huntingQueryVersion194]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_194",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Quarantine Release Email Details",
                "category": "Hunting Queries",
                "query": "CloudAppEvents \n| where ActionType == \"QuarantineReleaseMessage\"\n| project ReleaseTime = Timestamp, ResultStatus = RawEventData.ResultStatus, ActionType, ReleasedBy = tostring(RawEventData.UserId), NetworkMessageId = tostring(RawEventData.NetworkMessageId), ReleaseTo = RawEventData.ReleaseTo\n| join kind=inner (\n  EmailEvents\n  | project-rename EmailTime = Timestamp\n  ) on NetworkMessageId\n| project-away NetworkMessageId1\n| order by ReleaseTime asc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query shows information about email that has been released from the Quarantine in Defender for Office 365."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject194')._huntingQuerycontentId194),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 194",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject194')._huntingQuerycontentId194)]",
                "contentId": "[variables('huntingQueryObject194')._huntingQuerycontentId194]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject194').huntingQueryVersion194]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject194')._huntingQuerycontentId194]",
        "contentKind": "HuntingQuery",
        "displayName": "Quarantine Release Email Details",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject194')._huntingQuerycontentId194,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject194')._huntingQuerycontentId194,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject195').huntingQueryTemplateSpecName195]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Quarantine release trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject195').huntingQueryVersion195]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_195",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Quarantine release trend",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"QuarantineReleaseMessage\"\n| summarize count() by bin(Timestamp, 1d)\n| project-rename Releases = count_\n| render timechart with (title=\"Quarantine Releases by Day\")\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing quarantine release trend in Defender for Office 365"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject195')._huntingQuerycontentId195),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 195",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject195')._huntingQuerycontentId195)]",
                "contentId": "[variables('huntingQueryObject195')._huntingQuerycontentId195]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject195').huntingQueryVersion195]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject195')._huntingQuerycontentId195]",
        "contentKind": "HuntingQuery",
        "displayName": "Quarantine release trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject195')._huntingQuerycontentId195,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject195')._huntingQuerycontentId195,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject196').huntingQueryTemplateSpecName196]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Quarantine releases by Detection types_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject196').huntingQueryVersion196]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_196",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Quarantine releases by Detection Types",
                "category": "Hunting Queries",
                "query": "let totalQuery = EmailPostDeliveryEvents\n| where Action == \"Quarantine release\"\n| join kind=inner (EmailEvents | where DeliveryLocation == \"Quarantine\") on NetworkMessageId\n| extend MDO_detection = parse_json(DetectionMethods1)\n| extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0]))\n| extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\")\n| where FirstSubcategory contains \"Malware\" or FirstSubcategory contains \"Phish\" or FirstSubcategory contains \"Spam\"\n| count;\nEmailPostDeliveryEvents\n| where Action == \"Quarantine release\"\n| join kind=inner (EmailEvents | where DeliveryLocation == \"Quarantine\") on NetworkMessageId\n| extend MDO_detection = parse_json(DetectionMethods1)\n| extend FirstDetection = iif(isempty(MDO_detection), \"Clean\", tostring(bag_keys(MDO_detection)[0]))\n| extend FirstSubcategory = iif(FirstDetection != \"Clean\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \": \", tostring(MDO_detection[FirstDetection][0])), \"No Detection (clean)\")\n| where FirstSubcategory contains \"Malware\" or FirstSubcategory contains \"Phish\" or FirstSubcategory contains \"Spam\"\n| summarize count_messages = count() by FirstSubcategory\n| project FirstSubcategory, count_messages\n| order by count_messages desc\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises emails released from quarantine and summarizing the result by the original filter verdict"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject196')._huntingQuerycontentId196),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 196",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject196')._huntingQuerycontentId196)]",
                "contentId": "[variables('huntingQueryObject196')._huntingQuerycontentId196]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject196').huntingQueryVersion196]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject196')._huntingQuerycontentId196]",
        "contentKind": "HuntingQuery",
        "displayName": "Quarantine releases by Detection Types",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject196')._huntingQuerycontentId196,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject196')._huntingQuerycontentId196,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject197').huntingQueryTemplateSpecName197]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Quarantine Spam reason trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject197').huntingQueryVersion197]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_197",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Quarantine Spam Reason trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = EmailEvents\n| where TimeGenerated >= TimeStart\n| where DetectionMethods has \"Spam\" and DeliveryLocation == \"Quarantine\";\nlet timerange = \nbaseQuery\n| summarize minTime = min(Timestamp), maxTime = max(Timestamp);\nlet ml=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'Advanced filter'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Advanced filter\";\nlet gf=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'General filter'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"General filter\";\nlet bl=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'BulkFilter'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"BulkFilter\";\nlet mx=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'Mixed analysis detection'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Mixed analysis detection\";\nlet frp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'Fingerprint matching'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Fingerprint matching\";\nlet umr=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'URL malicious reputation' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"URL malicious reputation\";\nlet dr=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'Domain reputation' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Domain reputation\";\nlet ipr=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'IP reputation' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"IP reputation\";\nunion ml,gf,bl,mx,frp,umr,dr,ipr\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the amount of spam emails that are quarantined, summarized daily by the detection method"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject197')._huntingQuerycontentId197),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 197",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject197')._huntingQuerycontentId197)]",
                "contentId": "[variables('huntingQueryObject197')._huntingQuerycontentId197]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject197').huntingQueryVersion197]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject197')._huntingQuerycontentId197]",
        "contentKind": "HuntingQuery",
        "displayName": "Quarantine Spam Reason trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject197')._huntingQuerycontentId197,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject197')._huntingQuerycontentId197,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject198').huntingQueryTemplateSpecName198]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Quarantine Spam reason_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject198').huntingQueryVersion198]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_198",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Quarantine Spam Reason",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Inbound\" and DetectionMethods has 'Spam' and DeliveryLocation == \"Quarantine\"\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Spam=tostring(column_ifexists('Spam', ''))\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the total amount of spam emails that are quarantined, summarized by the detection method"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject198')._huntingQuerycontentId198),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 198",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject198')._huntingQuerycontentId198)]",
                "contentId": "[variables('huntingQueryObject198')._huntingQuerycontentId198]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject198').huntingQueryVersion198]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject198')._huntingQuerycontentId198]",
        "contentKind": "HuntingQuery",
        "displayName": "Quarantine Spam Reason",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject198')._huntingQuerycontentId198,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject198')._huntingQuerycontentId198,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject199').huntingQueryTemplateSpecName199]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AIR investigation actions insight_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject199').huntingQueryVersion199]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_199",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "AIR investigation actions insight",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AirInvestigationData\"\n| project Timestamp, RawEventData\n| extend EventData = parse_json(RawEventData)\n| extend Data = parse_json(tostring(EventData.Data))\n| extend InvestigationType = EventData.InvestigationType\n| extend InvestigationId = RawEventData.InvestigationId\n| extend Status = tostring(Data.Status)\n| where Status == \"Resolved\"\n| extend ActionRaw = parse_json(tostring(EventData.Actions))\n| mv-expand ActionRaw\n| extend Action = parse_json(tostring(ActionRaw))\n| extend ActionType=Action.ActionType, ActionApproval=Action.ActionApproval, ApprovedBy=Action.ApprovedBy, ApproverComment=Action.ApproverComment, ActionStatus=Action.ActionStatus\n| mv-expand Action.Entities\n| extend EntityQuery = Action_Entities.Query\n| mv-expand Action_Entities.Urls, Action_Entities.NetworkMessageIds\n| sort by Timestamp\n| project Timestamp, InvestigationType, InvestigationId, ActionType, ActionApproval, ApprovedBy, ApproverComment, ActionStatus, EntityQuery, Action_Entities_Urls, Action_Entities_NetworkMessageIds\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query provides insights into AIR investigation actions in Microsoft Defender for Office 365."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject199')._huntingQuerycontentId199),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 199",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject199')._huntingQuerycontentId199)]",
                "contentId": "[variables('huntingQueryObject199')._huntingQuerycontentId199]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject199').huntingQueryVersion199]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject199')._huntingQuerycontentId199]",
        "contentKind": "HuntingQuery",
        "displayName": "AIR investigation actions insight",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject199')._huntingQuerycontentId199,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject199')._huntingQuerycontentId199,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject200').huntingQueryTemplateSpecName200]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Email remediation action list_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject200').huntingQueryVersion200]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_200",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Listing Email Remediation Actions via Explorer",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where Timestamp > ago(30d)\n| where LatestDeliveryAction in (\"Hard delete\", \"Soft delete\", \"Moved to junk folder\", \"Moved to deleted items\")\n| summarize HardDelete_NetworkID = make_list_if(strcat(NetworkMessageId, @\"\\\", Timestamp,@\"\\\", Subject), LatestDeliveryAction == \"Hard delete\"),  \n            SoftDelete_NetworkID = make_list_if(strcat(NetworkMessageId, @\"\\\", Timestamp,@\"\\\", Subject), LatestDeliveryAction == \"Soft delete\"),\n            MoveToJunk_NetworkID = make_list_if(strcat(NetworkMessageId, @\"\\\", Timestamp,@\"\\\", Subject), LatestDeliveryAction == \"Moved to junk folder\"),\n            MoveToDelete_NetworkID = make_list_if(strcat(NetworkMessageId, @\"\\\", Timestamp,@\"\\\", Subject), LatestDeliveryAction == \"Moved to deleted items\") by RecipientEmailAddress\n| extend HardDelete_case = array_length(HardDelete_NetworkID)\n| extend SoftDelete_case = array_length(SoftDelete_NetworkID)\n| extend MoveToJunk_case = array_length(MoveToJunk_NetworkID)\n| extend MoveToDelete_case = array_length(MoveToDelete_NetworkID)\n| extend Sum_case = HardDelete_case + SoftDelete_case + MoveToJunk_case + MoveToDelete_case\n| project RecipientEmailAddress, Sum_case, HardDelete_case, SoftDelete_case, MoveToJunk_case, MoveToDelete_case, HardDelete_NetworkID, SoftDelete_NetworkID, MoveToJunk_NetworkID, MoveToDelete_NetworkID\n| order by Sum_case desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Listing Email Remediation Actions performed via Explorer in Defender for Office 365"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject200')._huntingQuerycontentId200),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 200",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject200')._huntingQuerycontentId200)]",
                "contentId": "[variables('huntingQueryObject200')._huntingQuerycontentId200]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject200').huntingQueryVersion200]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject200')._huntingQuerycontentId200]",
        "contentKind": "HuntingQuery",
        "displayName": "Listing Email Remediation Actions via Explorer",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject200')._huntingQuerycontentId200,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject200')._huntingQuerycontentId200,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject201').huntingQueryTemplateSpecName201]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Bulk Detection Top10 Domains_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject201').huntingQueryVersion201]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_201",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 domains sending Bulk email",
                "category": "Hunting Queries",
                "query": "//This query visualises total inbound emails which has any Bulk complaint level. It is summarizing the data by the various Bulk Complaint levels and SenderFromDomain of the email sender. It provides insights how many messages are detected with each Bulk Complaint level for each sender domain.\nEmailEvents\n| where EmailDirection == \"Inbound\" and BulkComplaintLevel !=\"\"\n| where TimeGenerated > ago(30d) // last 30 days by default, replace 30d with the desired period\n| summarize count() by BulkComplaintLevel, SenderFromDomain\n| sort by count_ desc\n| project SenderFromDomain,BulkComplaintLevel,Emails=count_\n| take 10\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total inbound emails which has any Bulk complaint level."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject201')._huntingQuerycontentId201),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 201",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject201')._huntingQuerycontentId201)]",
                "contentId": "[variables('huntingQueryObject201')._huntingQuerycontentId201]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject201').huntingQueryVersion201]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject201')._huntingQuerycontentId201]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 domains sending Bulk email",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject201')._huntingQuerycontentId201,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject201')._huntingQuerycontentId201,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject202').huntingQueryTemplateSpecName202]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam Detection Delivery Location_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject202').huntingQueryVersion202]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_202",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spam detection by delivery location",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where TimeGenerated > ago(30d) // last 30 days by default, replace 30d with the desired period\n| where DetectionMethods has \"Spam\" and EmailDirection == \"Inbound\"\n| make-series TotalSpamDetections=count(),Quarantine = countif(DeliveryLocation == \"Quarantine\"),Junkfolder=countif(DeliveryLocation == \"Junk folder\") ,Inbox=countif(DeliveryLocation == \"Inbox/folder\"),Failed=countif(DeliveryLocation == \"Failed\"),Dropped=countif(DeliveryLocation == \"Dropped\") default = 0 on Timestamp step 1d \n// | render timechart // Uncomment this line to render as a graph\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Spam detections over time summarizing the data daily by Delivery Location."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject202')._huntingQuerycontentId202),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 202",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject202')._huntingQuerycontentId202)]",
                "contentId": "[variables('huntingQueryObject202')._huntingQuerycontentId202]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject202').huntingQueryVersion202]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject202')._huntingQuerycontentId202]",
        "contentKind": "HuntingQuery",
        "displayName": "Spam detection by delivery location",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject202')._huntingQuerycontentId202,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject202')._huntingQuerycontentId202,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject203').huntingQueryTemplateSpecName203]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam Detection IP and Geo Position_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject203').huntingQueryVersion203]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_203",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spam detection by IP and its location",
                "category": "Hunting Queries",
                "query": "//This query visualises total emails with Spam detections summarizing the data by email sender IP address (SenderIPv4, SenderIPv6).\nlet ipv4position = EmailEvents\n| where ThreatTypes has \"Spam\" \n| where TimeGenerated > ago(90d) // last 30 days by default, replace 30d with the desired period\n| where SenderIPv4 != \"\"\n| summarize count() by SenderIPv4\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\n| project SenderIPv4, Latitude, Longitude, count_;\nlet ipv6position = EmailEvents\n| where ThreatTypes has \"Spam\" \n| where TimeGenerated > ago(90d) // last 30 days by default, replace 30d with the desired period\n| where SenderIPv6 != \"\"\n| summarize count() by SenderIPv6\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv6)\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\n| project SenderIPv6, Latitude, Longitude, count_;\nipv4position\n| union ipv6position\n| project SenderIPv6, SenderIPv4, Latitude, Longitude, count_;\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Spam detections summarizing the data by email sender IP address (SenderIPv4, SenderIPv6)."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject203')._huntingQuerycontentId203),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 203",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject203')._huntingQuerycontentId203)]",
                "contentId": "[variables('huntingQueryObject203')._huntingQuerycontentId203]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject203').huntingQueryVersion203]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject203')._huntingQuerycontentId203]",
        "contentKind": "HuntingQuery",
        "displayName": "Spam detection by IP and its location",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject203')._huntingQuerycontentId203,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject203')._huntingQuerycontentId203,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject204').huntingQueryTemplateSpecName204]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam Detection Mails with BCL_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject204').huntingQueryVersion204]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_204",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Bulk Emails by Sender Bulk Complaint level",
                "category": "Hunting Queries",
                "query": "//This query visualises total inbound emails which has any Bulk complaint level. It is summarizing the data by the various Bulk Complaint levels to understand how many messages are detected with each Bulk Complaint level.\nEmailEvents\n| where EmailDirection == \"Inbound\" and BulkComplaintLevel !=\"\"\n| where TimeGenerated > ago(30d) // last 30 days by default, replace 30d with the desired period\n| summarize count() by BulkComplaintLevel\n| sort by BulkComplaintLevel desc\n| project BulkComplaintLevel,Emails=count_\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total inbound emails which has any Bulk complaint level."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject204')._huntingQuerycontentId204),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 204",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject204')._huntingQuerycontentId204)]",
                "contentId": "[variables('huntingQueryObject204')._huntingQuerycontentId204]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject204').huntingQueryVersion204]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject204')._huntingQuerycontentId204]",
        "contentKind": "HuntingQuery",
        "displayName": "Bulk Emails by Sender Bulk Complaint level",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject204')._huntingQuerycontentId204,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject204')._huntingQuerycontentId204,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject205').huntingQueryTemplateSpecName205]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam Detection Tech_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject205').huntingQueryVersion205]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_205",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spam detection technologies",
                "category": "Hunting Queries",
                "query": "//This query visualises total emails with Spam detections summarizing the data by various Spam detection technologies/controls in Microsoft Defender for Office 365.\nEmailEvents \n| where DetectionMethods has 'Spam'\n| where TimeGenerated > ago(30d) // last 30 days by default, replace 30d with the desired period\n| project Timestamp, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) | summarize count() by Spam=tostring(column_ifexists('Spam', ''))\n| sort by count_\n// | render piechart  // Uncomment this line to render as a graph\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Spam detections summarizing the data by various Spam detection technologies/controls."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject205')._huntingQuerycontentId205),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 205",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject205')._huntingQuerycontentId205)]",
                "contentId": "[variables('huntingQueryObject205')._huntingQuerycontentId205]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject205').huntingQueryVersion205]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject205')._huntingQuerycontentId205]",
        "contentKind": "HuntingQuery",
        "displayName": "Spam detection technologies",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject205')._huntingQuerycontentId205,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject205')._huntingQuerycontentId205,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject206').huntingQueryTemplateSpecName206]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam Detection Top10 Domains_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject206').huntingQueryVersion206]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_206",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Email Top 10 Domains sending Spam",
                "category": "Hunting Queries",
                "query": "//This query visualises total inbound emails with Spam detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain).\nEmailEvents \n| where ThreatTypes has \"Spam\" and EmailDirection ==\"Inbound\"\n| where TimeGenerated > ago(30d) // last 30 days by default, replace 30d with the desired period\n| summarize count() by SenderFromDomain\n| sort by count_ desc \n| take 10\n// | render piechart // Uncomment this line to render as a graph\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total inbound emails with Spam detections."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject206')._huntingQuerycontentId206),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 206",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject206')._huntingQuerycontentId206)]",
                "contentId": "[variables('huntingQueryObject206')._huntingQuerycontentId206]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject206').huntingQueryVersion206]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject206')._huntingQuerycontentId206]",
        "contentKind": "HuntingQuery",
        "displayName": "Email Top 10 Domains sending Spam",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject206')._huntingQuerycontentId206,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject206')._huntingQuerycontentId206,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject207').huntingQueryTemplateSpecName207]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam Detection Top10 Users_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject207').huntingQueryVersion207]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_207",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Email Top 10 Targeted Users (Spam)",
                "category": "Hunting Queries",
                "query": "//This query visualises total inbound emails with Spam detections summarizing the data by the top 10 recipient email address (RecipientEmailAddress).\nEmailEvents \n| where ThreatTypes has \"Spam\" and EmailDirection ==\"Inbound\" \n| where TimeGenerated > ago(30d) // last 30 days by default, replace 30d with the desired period\n| summarize count() by RecipientEmailAddress \n| sort by count_ desc\n| take 10\n| render piechart // Uncomment this line to render as a graph\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises top 10 users targeted with Spam."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject207')._huntingQuerycontentId207),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 207",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject207')._huntingQuerycontentId207)]",
                "contentId": "[variables('huntingQueryObject207')._huntingQuerycontentId207]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject207').huntingQueryVersion207]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject207')._huntingQuerycontentId207]",
        "contentKind": "HuntingQuery",
        "displayName": "Email Top 10 Targeted Users (Spam)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject207')._huntingQuerycontentId207,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject207')._huntingQuerycontentId207,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject208').huntingQueryTemplateSpecName208]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam Detection Top15 Domains Details_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject208').huntingQueryVersion208]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_208",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Email Top 15 Domains sending Spam with Additional Details",
                "category": "Hunting Queries",
                "query": "//This query visualises total inbound emails with Spam detections summarizing the data by the top 15 email sender P2 domain (SenderFromDomain). Adding additional insights for total inbound emails and bad traffic percentage for each sender domain.\nEmailEvents\n| where EmailDirection == \"Inbound\"\n| where TimeGenerated > ago(30d) // last 30 days by default, replace 30d with the desired period\n| summarize TotalEmailCount = count(),\n          SpamEmailCount = countif(ThreatTypes has \"Spam\") by SenderFromDomain\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(SpamEmailCount / todouble(TotalEmailCount) * 100, 2))\n| where SpamEmailCount !=0\n| sort by SpamEmailCount desc \n| project SenderFromDomain,SpamEmailCount,TotalEmailCount,Bad_Traffic_Percentage_Inbound\n| top 15 by SpamEmailCount\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total inbound emails with Spam detections summarizing the data by the top 15 email sender P2 domain (SenderFromDomain)."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject208')._huntingQuerycontentId208),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 208",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject208')._huntingQuerycontentId208)]",
                "contentId": "[variables('huntingQueryObject208')._huntingQuerycontentId208]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject208').huntingQueryVersion208]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject208')._huntingQuerycontentId208]",
        "contentKind": "HuntingQuery",
        "displayName": "Email Top 15 Domains sending Spam with Additional Details",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject208')._huntingQuerycontentId208,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject208')._huntingQuerycontentId208,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject209').huntingQueryTemplateSpecName209]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam Detection Top15 Users Details_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject209').huntingQueryVersion209]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_209",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Email Top 15 Targeted Users (Spam) with Additional Details",
                "category": "Hunting Queries",
                "query": "//This query visualises total inbound emails with Spam detections summarizing the data by the top 15 recipient email address (RecipientEmailAddress).\nEmailEvents\n| where ThreatTypes has \"Spam\" and EmailDirection ==\"Inbound\"\n| where TimeGenerated > ago(90d) // last 30 days by default, replace 30d with the desired period\n| summarize count() by RecipientEmailAddress\n| sort by count_ desc\n| take 15\n| project RecipientEmailAddress,Emails=count_\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises top 15 users targeted with Spam with summarized spam detections."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject209')._huntingQuerycontentId209),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 209",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject209')._huntingQuerycontentId209)]",
                "contentId": "[variables('huntingQueryObject209')._huntingQuerycontentId209]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject209').huntingQueryVersion209]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject209')._huntingQuerycontentId209]",
        "contentKind": "HuntingQuery",
        "displayName": "Email Top 15 Targeted Users (Spam) with Additional Details",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject209')._huntingQuerycontentId209,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject209')._huntingQuerycontentId209,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject210').huntingQueryTemplateSpecName210]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam Detection Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject210').huntingQueryVersion210]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_210",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spam detection trend",
                "category": "Hunting Queries",
                "query": "//This query visualises total emails with Spam detections over time summarizing the data daily.\nEmailEvents\n| where ThreatTypes has \"Spam\"\n| make-series Count = count() default = 0 on Timestamp step 1d\n// | render timechart // Uncomment this line to render as a graph\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Spam detections over time summarizing the data daily"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject210')._huntingQuerycontentId210),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 210",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject210')._huntingQuerycontentId210)]",
                "contentId": "[variables('huntingQueryObject210')._huntingQuerycontentId210]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject210').huntingQueryVersion210]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject210')._huntingQuerycontentId210]",
        "contentKind": "HuntingQuery",
        "displayName": "Spam detection trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject210')._huntingQuerycontentId210,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject210')._huntingQuerycontentId210,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject211').huntingQueryTemplateSpecName211]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spam Detections by Detection technology_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject211').huntingQueryVersion211]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_211",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spam Detections by Detection technology",
                "category": "Hunting Queries",
                "query": "//This query visualises total emails with Spam detections over time summarizing the data daily by various Spam Detection technologies/controls in Microsoft Defender for Office 365.\nlet minTime = startofday(ago(30d)); // last 30 days by default, replace 30d with the desired period\nlet maxTime = startofday(now());\nlet baseQuery = EmailEvents\n| where DetectionMethods has \"Spam\"\n| where TimeGenerated >= minTime;\nlet ml=baseQuery\n| where TimeGenerated >= minTime\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'Advanced filter'\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \n| extend Details = \"Advanced filter\";\nlet gf=baseQuery\n| where TimeGenerated >= minTime\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'General filter'\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \n| extend Details = \"General filter\";\nlet bl=baseQuery\n| where TimeGenerated >= minTime\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'BulkFilter'\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \n| extend Details = \"BulkFilter\";\nlet mx=baseQuery\n| where TimeGenerated >= minTime\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'Mixed analysis detection'\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \n| extend Details = \"Mixed analysis detection\";\nlet frp=baseQuery\n| where TimeGenerated >= minTime\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'Fingerprint matching'\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \n| extend Details = \"Fingerprint matching\";\nlet umr=baseQuery\n| where TimeGenerated >= minTime\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'URL malicious reputation'\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \n| extend Details = \"URL malicious reputation\";\nlet dr=baseQuery\n| where TimeGenerated >= minTime\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'Domain reputation'\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \n| extend Details = \"Domain reputation\";\nlet ipr=baseQuery\n| where TimeGenerated >= minTime\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Spam has 'IP reputation' \n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \n| extend Details = \"IP reputation\";\nunion ml,gf,bl,mx,frp,umr,dr,ipr\n| project Count, Details, Timestamp\n| render timechart \n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Spam detections over time by various Spam Detection technologies/controls."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject211')._huntingQuerycontentId211),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 211",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject211')._huntingQuerycontentId211)]",
                "contentId": "[variables('huntingQueryObject211')._huntingQuerycontentId211]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject211').huntingQueryVersion211]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject211')._huntingQuerycontentId211]",
        "contentKind": "HuntingQuery",
        "displayName": "Spam Detections by Detection technology",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject211')._huntingQuerycontentId211,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject211')._huntingQuerycontentId211,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject212').huntingQueryTemplateSpecName212]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Display Name - Spoof and Impersonation_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject212').huntingQueryVersion212]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_212",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Display Name - Spoof and Impersonation",
                "category": "Hunting Queries",
                "query": "let emailDelivered = EmailEvents\n| where Timestamp < ago(24hrs)\nand DeliveryAction == \"Delivered\"\nand SenderDisplayName contains \"Microsoft\"\n| summarize count() by SenderFromAddress\n| where count_ > 3 // ensuring that some level of communications has occurred.\n| project SenderFromAddress;\nEmailEvents\n| where Timestamp > ago(24hrs)\n| where DeliveryAction == \"Delivered\"\nand EmailDirection == \"Inbound\"\nand OrgLevelAction != \"Block\"\nand UserLevelAction != \"Block\"\nand SenderDisplayName contains \"Microsoft\"\n| extend NewMsg = case(Subject contains \"RE:\", false, Subject contains \"FW:\", false, true )\n| project SenderDisplayName, SenderFromAddress, NetworkMessageId, SenderMailFromAddress, RecipientEmailAddress, DeliveryAction, DeliveryLocation, ThreatTypes, DetectionMethods, NewMsg, Subject\n| join kind=leftanti  ( emailDelivered ) on SenderFromAddress\n| order by SenderMailFromAddress\n| summarize count() by SenderDisplayName, SenderFromAddress, NetworkMessageId, SenderMailFromAddress, RecipientEmailAddress, DeliveryAction, DeliveryLocation, ThreatTypes, DetectionMethods, NewMsg, Subject\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing incoming email messages where the Display Name of the sender contains own or other partner company/brand name"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject212')._huntingQuerycontentId212),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 212",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject212')._huntingQuerycontentId212)]",
                "contentId": "[variables('huntingQueryObject212')._huntingQuerycontentId212]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject212').huntingQueryVersion212]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject212')._huntingQuerycontentId212]",
        "contentKind": "HuntingQuery",
        "displayName": "Display Name - Spoof and Impersonation",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject212')._huntingQuerycontentId212,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject212')._huntingQuerycontentId212,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject213').huntingQueryTemplateSpecName213]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Impersonation Phishing detections by Detection Technology Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject213').huntingQueryVersion213]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_213",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Impersonation Detections by Detection Technology Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = EmailEvents\n| where DetectionMethods has \"Phish\";\nlet bimp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Impersonation brand' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Impersonation brand\";\nlet dimp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Impersonation domain' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Impersonation domain\";\nlet uimp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Impersonation user' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Impersonation user\";\nlet mimp=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Mailbox intelligence impersonation' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Mailbox intelligence impersonation\";\nunion bimp,dimp,uimp,mimp\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Phish (BEC) Impersonation detections by Detection Technology over time"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject213')._huntingQuerycontentId213),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 213",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject213')._huntingQuerycontentId213)]",
                "contentId": "[variables('huntingQueryObject213')._huntingQuerycontentId213]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject213').huntingQueryVersion213]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject213')._huntingQuerycontentId213]",
        "contentKind": "HuntingQuery",
        "displayName": "Impersonation Detections by Detection Technology Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject213')._huntingQuerycontentId213,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject213')._huntingQuerycontentId213,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject214').huntingQueryTemplateSpecName214]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Impersonation Phishing detections by Detection Technology_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject214').huntingQueryVersion214]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_214",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Impersonation Detections by Detection Technology",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where DetectionMethods has 'Impersonation' \n| project Timestamp, DT=parse_json(DetectionMethods) \n| evaluate bag_unpack(DT) \n| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\n| sort by count_ desc\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Phish (BEC) Impersonation detections by Detection Technology"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject214')._huntingQuerycontentId214),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 214",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject214')._huntingQuerycontentId214)]",
                "contentId": "[variables('huntingQueryObject214')._huntingQuerycontentId214]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject214').huntingQueryVersion214]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject214')._huntingQuerycontentId214]",
        "contentKind": "HuntingQuery",
        "displayName": "Impersonation Detections by Detection Technology",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject214')._huntingQuerycontentId214,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject214')._huntingQuerycontentId214,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject215').huntingQueryTemplateSpecName215]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Impersonation Phishing detections trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject215').huntingQueryVersion215]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_215",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Impersonation Detections Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nEmailEvents \n| where DetectionMethods has 'Impersonation' \n| make-series Count = count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"ImpersonatedEmails\"\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Phish (BEC) - Impersonation detections over time."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject215')._huntingQuerycontentId215),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 215",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject215')._huntingQuerycontentId215)]",
                "contentId": "[variables('huntingQueryObject215')._huntingQuerycontentId215]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject215').huntingQueryVersion215]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject215')._huntingQuerycontentId215]",
        "contentKind": "HuntingQuery",
        "displayName": "Impersonation Detections Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject215')._huntingQuerycontentId215,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject215')._huntingQuerycontentId215,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject216').huntingQueryTemplateSpecName216]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Referral phish emails_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject216').huntingQueryVersion216]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_216",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "referral-phish-emails",
                "category": "Hunting Queries",
                "query": "let EmailAddresses = pack_array\n('zreffertalt.com.com','zreffesral.com.com','kzreffertal.com.com',\n'wzreffertal.com.com','refferal.comq','refferal.net','zreffertal.com.com',\n'zrefferal.com.com','refferasl.com.com','zreffesral.com','zrefsfertal.com.com',\n'irefferal.com','refferasl.co','zrefferal.com');\nEmailEvents\n| where SenderMailFromDomain in (EmailAddresses)\n| extend RecipientDomain = extract(\"[^@]+$\", 0, RecipientEmailAddress)\n| where SenderFromDomain == RecipientDomain\n| join EmailUrlInfo on $left.NetworkMessageId == $right.NetworkMessageId\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Hunting for credential phishing using the \"Referral\" infrastructure using Defender for Office 365 data"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject216')._huntingQuerycontentId216),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 216",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject216')._huntingQuerycontentId216)]",
                "contentId": "[variables('huntingQueryObject216')._huntingQuerycontentId216]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject216').huntingQueryVersion216]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject216')._huntingQuerycontentId216]",
        "contentKind": "HuntingQuery",
        "displayName": "referral-phish-emails",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject216')._huntingQuerycontentId216,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject216')._huntingQuerycontentId216,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject217').huntingQueryTemplateSpecName217]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spoof and impersonation detections by sender IP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject217').huntingQueryVersion217]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_217",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spoof and impersonation detections by sender IP",
                "category": "Hunting Queries",
                "query": "EmailEvents \n|where Timestamp > ago (30d) and (DetectionMethods contains 'spoof' or DetectionMethods contains \"impersonation\")  \n| project Timestamp, EmailDirection, SenderFromAddress, AdditionalFields, SenderIPv4 \n| summarize count() by SenderIPv4\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing count of spoof and impersonation detections done per sender IP"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject217')._huntingQuerycontentId217),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 217",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject217')._huntingQuerycontentId217)]",
                "contentId": "[variables('huntingQueryObject217')._huntingQuerycontentId217]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject217').huntingQueryVersion217]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject217')._huntingQuerycontentId217]",
        "contentKind": "HuntingQuery",
        "displayName": "Spoof and impersonation detections by sender IP",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject217')._huntingQuerycontentId217,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject217')._huntingQuerycontentId217,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject218').huntingQueryTemplateSpecName218]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spoof and impersonation phish detections_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject218').huntingQueryVersion218]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_218",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spoof and impersonation phish detections",
                "category": "Hunting Queries",
                "query": "EmailEvents\n|where Timestamp > ago (30d) and (DetectionMethods contains 'spoof' or DetectionMethods contains \"impersonation\")\n| project Timestamp, AR=parse_json(ThreatTypes) , DT=parse_json(DetectionMethods), EmailDirection, SenderFromAddress\n| evaluate bag_unpack(DT)\n| summarize count() by tostring(Phish)\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing count of phish detections done by spoof detection methods"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject218')._huntingQuerycontentId218),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 218",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject218')._huntingQuerycontentId218)]",
                "contentId": "[variables('huntingQueryObject218')._huntingQuerycontentId218]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject218').huntingQueryVersion218]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject218')._huntingQuerycontentId218]",
        "contentKind": "HuntingQuery",
        "displayName": "Spoof and impersonation phish detections",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject218')._huntingQuerycontentId218,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject218')._huntingQuerycontentId218,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject219').huntingQueryTemplateSpecName219]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spoof detections by Detection Technology Trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject219').huntingQueryVersion219]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_219",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spoof Detections by Detection Technology Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = EmailEvents\n| where DetectionMethods has \"Phish\";\nlet sdmarc=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Spoof DMARC' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Spoof DMARC\";\nlet spoofe=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Spoof external domain' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Spoof external domain\";\nlet spoofi=baseQuery\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \n| where Phish has 'Spoof intra-org' \n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"Spoof intra-org\";\nunion sdmarc, spoofe, spoofi\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Phish (BEC) Spoof detections by Detection Technology over time"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject219')._huntingQuerycontentId219),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 219",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject219')._huntingQuerycontentId219)]",
                "contentId": "[variables('huntingQueryObject219')._huntingQuerycontentId219]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject219').huntingQueryVersion219]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject219')._huntingQuerycontentId219]",
        "contentKind": "HuntingQuery",
        "displayName": "Spoof Detections by Detection Technology Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject219')._huntingQuerycontentId219,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject219')._huntingQuerycontentId219,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject220').huntingQueryTemplateSpecName220]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spoof detections by Detection Technology_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject220').huntingQueryVersion220]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_220",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spoof Detections by Detection Technology",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where DetectionMethods has 'Spoof' \n| project Timestamp, DT=parse_json(DetectionMethods) \n| evaluate bag_unpack(DT) \n| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\n| sort by count_ desc\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails with Phish (BEC) Spoof detections by Detection Technology"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject220')._huntingQuerycontentId220),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 220",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject220')._huntingQuerycontentId220)]",
                "contentId": "[variables('huntingQueryObject220')._huntingQuerycontentId220]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject220').huntingQueryVersion220]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject220')._huntingQuerycontentId220]",
        "contentKind": "HuntingQuery",
        "displayName": "Spoof Detections by Detection Technology",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject220')._huntingQuerycontentId220,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject220')._huntingQuerycontentId220,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject221').huntingQueryTemplateSpecName221]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Spoof detections trend_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject221').huntingQueryVersion221]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_221",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spoof Detections Trend",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nEmailEvents \n| where DetectionMethods has 'Spoof' \n| make-series Count = count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"SpoofEmails\"\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises total emails Business Email Compromise (BEC) Spoofing detections over time summarizing the data daily."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject221')._huntingQuerycontentId221),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 221",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject221')._huntingQuerycontentId221)]",
                "contentId": "[variables('huntingQueryObject221')._huntingQuerycontentId221]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject221').huntingQueryVersion221]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject221')._huntingQuerycontentId221]",
        "contentKind": "HuntingQuery",
        "displayName": "Spoof Detections Trend",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject221')._huntingQuerycontentId221,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject221')._huntingQuerycontentId221,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject222').huntingQueryTemplateSpecName222]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top Domains with BEC Threats inbound_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject222').huntingQueryVersion222]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_222",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top Domains Outbound with Emails with Threats Inbound (Partner BEC)",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where EmailDirection == \"Outbound\"\n| project RecipientDomain = tostring(split(RecipientEmailAddress, \"@\")[1])\n| summarize count() by RecipientDomain\n| project OutboundCount=count_, RecipientDomain, SenderFromDomain=RecipientDomain\n| join (EmailEvents | where EmailDirection == \"Inbound\" and isempty(ThreatTypes)==false) on SenderFromDomain\n| summarize max(OutboundCount),count() by SenderFromDomain\n| project SenderFromDomain, OutboundEmails=max_OutboundCount, IncomingEmailsWithThreats=count_\n| sort by OutboundEmails\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises top outbound recipient domains by outbound email volume and shows total number of inbound emails with Threats from the same domains (as inbound senders)"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject222')._huntingQuerycontentId222),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 222",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject222')._huntingQuerycontentId222)]",
                "contentId": "[variables('huntingQueryObject222')._huntingQuerycontentId222]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject222').huntingQueryVersion222]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject222')._huntingQuerycontentId222]",
        "contentKind": "HuntingQuery",
        "displayName": "Top Domains Outbound with Emails with Threats Inbound (Partner BEC)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject222')._huntingQuerycontentId222,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject222')._huntingQuerycontentId222,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject223').huntingQueryTemplateSpecName223]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User not covered under display name impersonation_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject223').huntingQueryVersion223]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_223",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User not covered under display name impersonation",
                "category": "Hunting Queries",
                "query": "let display_names = \nIdentityInfo \n  | summarize by AccountDisplayName \n  | project-rename  SenderDisplayName = AccountDisplayName; \nEmailEvents \n  | where EmailDirection == \"Inbound\" \n  | where ThreatNames != \"\" \n  | where ThreatNames !contains \"Impersonation User\" \n  | lookup kind=inner (display_names) on SenderDisplayName, $left.SenderDisplayName == $right.SenderDisplayName \n  | where SenderDisplayName != \"\" \n  | summarize by SenderDisplayName\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps to find threats using display name impersonation for users not already protected with User Impersonation"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject223')._huntingQuerycontentId223),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 223",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject223')._huntingQuerycontentId223)]",
                "contentId": "[variables('huntingQueryObject223')._huntingQuerycontentId223]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject223').huntingQueryVersion223]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject223')._huntingQuerycontentId223]",
        "contentKind": "HuntingQuery",
        "displayName": "User not covered under display name impersonation",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject223')._huntingQuerycontentId223,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject223')._huntingQuerycontentId223,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject224').huntingQueryTemplateSpecName224]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Admin Submission Trend - FN_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject224').huntingQueryVersion224]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_224",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Admin Submission Trend (FN)",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = CloudAppEvents\n| where TimeGenerated >= TimeStart\n| where ActionType contains \"Submission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType);\nlet Admin_Malware_FN=baseQuery\n| make-series Count= countif(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Admin_Malware_FN\";\nlet Admin_Phish_FN=baseQuery\n| make-series Count= countif(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Admin_Phish_FN\";\nlet Admin_Spam_FN=baseQuery\n| make-series Count= countif(SubmissionType == \"0\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\") default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Admin_Spam_FN\";\nlet Admin_Malware_URL_FN=baseQuery\n| make-series Count= countif(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\") default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Admin_Malware_URL_FN\";\nlet Admin_Malware_Attach_FN=baseQuery\n| make-series Count= countif(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\") default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Admin_Malware_Attach_FN\";\nlet Admin_Phish_URL_FN=baseQuery\n| make-series Count= countif(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\") default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Admin_Phish_URL_FN\";\nlet Admin_Phish_Attach_FN=baseQuery\n| make-series Count= countif(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\") default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Admin_Phish_Attach_FN\";\nunion Admin_Malware_FN,Admin_Phish_FN,Admin_Spam_FN,Admin_Malware_URL_FN,Admin_Malware_Attach_FN,Admin_Phish_URL_FN,Admin_Phish_Attach_FN\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the daily amount of admin false negative submission by submission type."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject224')._huntingQuerycontentId224),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 224",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject224')._huntingQuerycontentId224)]",
                "contentId": "[variables('huntingQueryObject224')._huntingQuerycontentId224]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject224').huntingQueryVersion224]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject224')._huntingQuerycontentId224]",
        "contentKind": "HuntingQuery",
        "displayName": "Admin Submission Trend (FN)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject224')._huntingQuerycontentId224,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject224')._huntingQuerycontentId224,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject225').huntingQueryTemplateSpecName225]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Admin Submission Trend - FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject225').huntingQueryVersion225]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_225",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Admin Submission Trend (FP)",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = CloudAppEvents\n| where TimeGenerated >= TimeStart\n| where ActionType contains \"Submission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType);\nlet Admin_Email_FP=baseQuery\n| make-series Count= countif(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Admin_Email_FP\";\nlet Admin_URL_FP=baseQuery\n| make-series Count= countif(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\") default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Admin_URL_FP\";\nlet Admin_Attach_FP=baseQuery\n| make-series Count= countif(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\") default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Admin_Attach_FP\";\nunion Admin_Email_FP,Admin_URL_FP,Admin_Attach_FP\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the daily amount of admin false positive submission by submission type."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject225')._huntingQuerycontentId225),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 225",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject225')._huntingQuerycontentId225)]",
                "contentId": "[variables('huntingQueryObject225')._huntingQuerycontentId225]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject225').huntingQueryVersion225]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject225')._huntingQuerycontentId225]",
        "contentKind": "HuntingQuery",
        "displayName": "Admin Submission Trend (FP)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject225')._huntingQuerycontentId225,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject225')._huntingQuerycontentId225,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject226').huntingQueryTemplateSpecName226]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Admin Submissions by Detection Method - Phish FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject226').huntingQueryVersion226]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_226",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Admin Submissions by DetectionMethod (Phish FP)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminSubmissionSubmitted\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\n| extend Admin_SubmissionType=\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ,\"Admin_Email_FP\",\n\"Other\"),DetectionMethod=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdictControlSource),\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\n| where SubmissionContentType == \"Mail\" and SubmissionType == \"3\" and DetectionVerdict ==\"Phish\"\n| summarize count() by DetectionMethod\n| project DetectionMethod,Emails = count_\n// | render piechart // Uncomment this line to render as a graph\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the original detection technology of emails submitted as phish false positive by admins"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject226')._huntingQuerycontentId226),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 226",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject226')._huntingQuerycontentId226)]",
                "contentId": "[variables('huntingQueryObject226')._huntingQuerycontentId226]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject226').huntingQueryVersion226]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject226')._huntingQuerycontentId226]",
        "contentKind": "HuntingQuery",
        "displayName": "Admin Submissions by DetectionMethod (Phish FP)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject226')._huntingQuerycontentId226,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject226')._huntingQuerycontentId226,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject227').huntingQueryTemplateSpecName227]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Admin Submissions by Detection Method - Spam FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject227').huntingQueryVersion227]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_227",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Admin Submissions by DetectionMethod (Spam FP)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminSubmissionSubmitted\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\n| extend Admin_SubmissionType=\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ,\"Admin_Email_FP\",\n\"Other\"),DetectionMethod=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdictControlSource),\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\n| where SubmissionContentType == \"Mail\" and SubmissionType == \"3\" and DetectionVerdict ==\"Spam\" \n| summarize count() by DetectionMethod\n| project DetectionMethod,Emails = count_\n// | render piechart // Uncomment this line to render as a graph\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the original detection technology of emails submitted as spam false positive by admins"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject227')._huntingQuerycontentId227),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 227",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject227')._huntingQuerycontentId227)]",
                "contentId": "[variables('huntingQueryObject227')._huntingQuerycontentId227]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject227').huntingQueryVersion227]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject227')._huntingQuerycontentId227]",
        "contentKind": "HuntingQuery",
        "displayName": "Admin Submissions by DetectionMethod (Spam FP)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject227')._huntingQuerycontentId227,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject227')._huntingQuerycontentId227,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject228').huntingQueryTemplateSpecName228]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Admin Submissions by Detection Type_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject228').huntingQueryVersion228]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_228",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Admin Submissions by Detection Type",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminSubmissionSubmitted\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\n| extend Admin_SubmissionType=\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\" ,\"Admin_Email_FP\",\n\"Other\"),\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\n| where SubmissionContentType == \"Mail\" and SubmissionType == \"3\"\n| summarize count() by PolicyOverride,DetectionVerdict,Admin_SubmissionType\n| project PolicyOverride, DetectionVerdict,Admin_SubmissionType, Emails = count_\n| top 10 by Emails desc\n// | render piechart // Uncomment this line to render as a graph\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises all emails submitted as false positive by admins summarizing by the original filter verdict threat type"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject228')._huntingQuerycontentId228),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 228",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject228')._huntingQuerycontentId228)]",
                "contentId": "[variables('huntingQueryObject228')._huntingQuerycontentId228]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject228').huntingQueryVersion228]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject228')._huntingQuerycontentId228]",
        "contentKind": "HuntingQuery",
        "displayName": "Admin Submissions by Detection Type",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject228')._huntingQuerycontentId228,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject228')._huntingQuerycontentId228,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject229').huntingQueryTemplateSpecName229]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Admin Submissions by Grading Verdict - FN-FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject229').huntingQueryVersion229]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_229",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Admin Submissions by Grading verdict (FN-FP)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType contains \"AdminSubmissionTriage\"\n| extend UserKey = (parse_json(RawEventData)).UserKey, SubmissionState = (parse_json(RawEventData)).SubmissionState,  SubmissionId=(parse_json(RawEventData)).SubmissionId, TriageVerdict=(parse_json(RawEventData)).GradingResult.TriageVerdict\n| summarize count() by tostring(TriageVerdict)\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the total amount of admin false negative or false positive submissions by the verdict of the submission grading."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject229')._huntingQuerycontentId229),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 229",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject229')._huntingQuerycontentId229)]",
                "contentId": "[variables('huntingQueryObject229')._huntingQuerycontentId229]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject229').huntingQueryVersion229]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject229')._huntingQuerycontentId229]",
        "contentKind": "HuntingQuery",
        "displayName": "Admin Submissions by Grading verdict (FN-FP)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject229')._huntingQuerycontentId229,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject229')._huntingQuerycontentId229,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject230').huntingQueryTemplateSpecName230]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Admin Submissions by Submission State - FN_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject230').huntingQueryVersion230]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_230",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Admin Submissions by Submission State (FN)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType contains \"AdminSubmission\"\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\n| where Record == 29 and SubmissionType in (\"0\",\"1\",\"2\")\n| summarize count() by tostring(SubmissionState)\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the total amount of admin false negative submissions by the state of the submission."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject230')._huntingQuerycontentId230),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 230",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject230')._huntingQuerycontentId230)]",
                "contentId": "[variables('huntingQueryObject230')._huntingQuerycontentId230]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject230').huntingQueryVersion230]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject230')._huntingQuerycontentId230]",
        "contentKind": "HuntingQuery",
        "displayName": "Admin Submissions by Submission State (FN)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject230')._huntingQuerycontentId230,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject230')._huntingQuerycontentId230,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject231').huntingQueryTemplateSpecName231]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Admin Submissions by Submission State - FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject231').huntingQueryVersion231]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_231",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Admin Submissions by Submission State (FP)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType contains \"AdminSubmission\"\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\n| where Record == 29 and SubmissionType == \"3\"\n| summarize count() by tostring(SubmissionState)\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the total amount of admin false positive submissions by the state of the submission."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject231')._huntingQuerycontentId231),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 231",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject231')._huntingQuerycontentId231)]",
                "contentId": "[variables('huntingQueryObject231')._huntingQuerycontentId231]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject231').huntingQueryVersion231]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject231')._huntingQuerycontentId231]",
        "contentKind": "HuntingQuery",
        "displayName": "Admin Submissions by Submission State (FP)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject231')._huntingQuerycontentId231,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject231')._huntingQuerycontentId231,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject232').huntingQueryTemplateSpecName232]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Admin Submissions by Submission Type - FN_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject232').huntingQueryVersion232]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_232",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Admin Submissions by Submission Type (FN)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType contains \"Submission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\n| extend Admin_SubmissionType=\niff(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Malware_FN\",\niff(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Phish_FN\",\niff(SubmissionType == \"0\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Spam_FN\",\niff(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\",\"Admin_Malware_URL_FN\",\niff(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\",\"Admin_Malware_Attach_FN\",\niff(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\",\"Admin_Phish_URL_FN\",\niff(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\",\"Admin_Phish_Attach_FN\",\n\"Other\")))))))\n| where Admin_SubmissionType!=\"Other\"\n| summarize count() by Admin_SubmissionType\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing admin reported email submissions"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject232')._huntingQuerycontentId232),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 232",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject232')._huntingQuerycontentId232)]",
                "contentId": "[variables('huntingQueryObject232')._huntingQuerycontentId232]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject232').huntingQueryVersion232]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject232')._huntingQuerycontentId232]",
        "contentKind": "HuntingQuery",
        "displayName": "Admin Submissions by Submission Type (FN)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject232')._huntingQuerycontentId232,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject232')._huntingQuerycontentId232,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject233').huntingQueryTemplateSpecName233]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Admin Submissions by Submission Type - FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject233').huntingQueryVersion233]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_233",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Admin Submissions by Submission Type (FP)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType contains \"Submission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\n| extend Admin_SubmissionType=\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Email_FP\",\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"URL\",\"Admin_URL_FP\",\niff(SubmissionType == \"3\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Attachment\",\"Admin_Attach_FP\",\n\"Other\")))\n| where Admin_SubmissionType!=\"Other\"\n| summarize count() by Admin_SubmissionType\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the total amount of admin false positive submission by submission type."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject233')._huntingQuerycontentId233),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 233",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject233')._huntingQuerycontentId233)]",
                "contentId": "[variables('huntingQueryObject233')._huntingQuerycontentId233]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject233').huntingQueryVersion233]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject233')._huntingQuerycontentId233]",
        "contentKind": "HuntingQuery",
        "displayName": "Admin Submissions by Submission Type (FP)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject233')._huntingQuerycontentId233,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject233')._huntingQuerycontentId233,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject234').huntingQueryTemplateSpecName234]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top accounts performing admin submissions - FN_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject234').huntingQueryVersion234]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_234",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top accounts performing admin submissions (FN)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminSubmissionSubmitted\"\n| extend Record= (parse_json(RawEventData)).RecordType,SubmissionState = (parse_json(RawEventData)).SubmissionState, UserId = (parse_json(RawEventData)).UserId,SubmissionType = parse_json(RawEventData).SubmissionType\n| where Record == 29 and SubmissionType in (\"0\",\"1\",\"2\")\n| summarize count() by tostring(UserId) | sort by count_\n| top 15 by count_\n| render columnchart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the top admins performing false negative submissions"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject234')._huntingQuerycontentId234),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 234",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject234')._huntingQuerycontentId234)]",
                "contentId": "[variables('huntingQueryObject234')._huntingQuerycontentId234]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject234').huntingQueryVersion234]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject234')._huntingQuerycontentId234]",
        "contentKind": "HuntingQuery",
        "displayName": "Top accounts performing admin submissions (FN)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject234')._huntingQuerycontentId234,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject234')._huntingQuerycontentId234,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject235').huntingQueryTemplateSpecName235]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top accounts performing admin submissions - FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject235').huntingQueryVersion235]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_235",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top accounts performing admin submissions (FP)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminSubmissionSubmitted\"\n| extend Record= (parse_json(RawEventData)).RecordType,SubmissionState = (parse_json(RawEventData)).SubmissionState, UserId = (parse_json(RawEventData)).UserId,SubmissionType = parse_json(RawEventData).SubmissionType\n| where Record == 29 and SubmissionType ==\"3\"\n| summarize count() by tostring(UserId) | sort by count_\n| top 15 by count_\n| render columnchart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the top admins performing false positive submissions"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject235')._huntingQuerycontentId235),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 235",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject235')._huntingQuerycontentId235)]",
                "contentId": "[variables('huntingQueryObject235')._huntingQuerycontentId235]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject235').huntingQueryVersion235]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject235')._huntingQuerycontentId235]",
        "contentKind": "HuntingQuery",
        "displayName": "Top accounts performing admin submissions (FP)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject235')._huntingQuerycontentId235,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject235')._huntingQuerycontentId235,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject236').huntingQueryTemplateSpecName236]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top accounts performing user submissions_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject236').huntingQueryVersion236]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_236",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top accounts performing user submissions",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where Timestamp > ago(30d) \n| extend Record= (parse_json(RawEventData)).RecordType \n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState  \n| extend UserId = (parse_json(RawEventData)).UserId\n| where Record == 29 \n| where ActionType == \"UserSubmission\" \n| summarize count() by tostring(UserId) | sort by count_ //| top 50 by count_\n| render columnchart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query graphs top accounts performing user submissions"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject236')._huntingQuerycontentId236),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 236",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject236')._huntingQuerycontentId236)]",
                "contentId": "[variables('huntingQueryObject236')._huntingQuerycontentId236]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject236').huntingQueryVersion236]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject236')._huntingQuerycontentId236]",
        "contentKind": "HuntingQuery",
        "displayName": "Top accounts performing user submissions",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject236')._huntingQuerycontentId236,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject236')._huntingQuerycontentId236,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject237').huntingQueryTemplateSpecName237]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top Detection Overrides - Admin Submissions_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject237').huntingQueryVersion237]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_237",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 Detection Overrides - Admin Email Submissions (FN)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminSubmissionSubmitted\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\n| extend Admin_SubmissionType=\niff(SubmissionType == \"2\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Malware_FN\",\niff(SubmissionType == \"1\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Phish_FN\",\niff(SubmissionType == \"0\" and ActionType == \"AdminSubmissionSubmitted\" and SubmissionContentType==\"Mail\",\"Admin_Spam_FN\",\"Other\"))),\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"2\",\"1\",\"0\") and PolicyOverride !=\"NoOverride\"\n| summarize count() by PolicyOverride, PolicyPolicyOverrideType,DetectionVerdict,Admin_SubmissionType\n| project PolicyOverride, PolicyPolicyOverrideType,DetectionVerdict,Admin_SubmissionType, Emails = count_\n| top 10 by Emails desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises emails submitted as false negatives by admins where emails where already detected by MDO but there was an admin policy override"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject237')._huntingQuerycontentId237),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 237",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject237')._huntingQuerycontentId237)]",
                "contentId": "[variables('huntingQueryObject237')._huntingQuerycontentId237]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject237').huntingQueryVersion237]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject237')._huntingQuerycontentId237]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 Detection Overrides - Admin Email Submissions (FN)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject237')._huntingQuerycontentId237,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject237')._huntingQuerycontentId237,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject238').huntingQueryTemplateSpecName238]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top Sender Domains - Admin Submissions FN_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject238').huntingQueryVersion238]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_238",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 sender domains - Admin email submissions (FN)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminSubmissionSubmitted\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain)\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"2\",\"1\",\"0\")\n| summarize count() by P2SenderDomain\n| project P2SenderDomain, Emails = count_\n| top 10 by Emails desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises emails submitted by admins as false negatives, summarizing the data by top 10 sender domains of those emails"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject238')._huntingQuerycontentId238),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 238",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject238')._huntingQuerycontentId238)]",
                "contentId": "[variables('huntingQueryObject238')._huntingQuerycontentId238]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject238').huntingQueryVersion238]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject238')._huntingQuerycontentId238]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 sender domains - Admin email submissions (FN)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject238')._huntingQuerycontentId238,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject238')._huntingQuerycontentId238,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject239').huntingQueryTemplateSpecName239]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top Sender Domains - Admin Submissions FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject239').huntingQueryVersion239]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_239",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 sender domains - Admin email submissions (FP)",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType == \"AdminSubmissionSubmitted\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain)\n| where SubmissionContentType == \"Mail\" and SubmissionType ==\"3\"\n| summarize count() by P2SenderDomain\n| project P2SenderDomain, Emails = count_\n| top 10 by Emails desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises emails submitted by admins as false positives, summarizing the data by top 10 sender domains of those emails"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject239')._huntingQuerycontentId239),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 239",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject239')._huntingQuerycontentId239)]",
                "contentId": "[variables('huntingQueryObject239')._huntingQuerycontentId239]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject239').huntingQueryVersion239]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject239')._huntingQuerycontentId239]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 sender domains - Admin email submissions (FP)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject239')._huntingQuerycontentId239,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject239')._huntingQuerycontentId239,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject240').huntingQueryTemplateSpecName240]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Total Submissions by Submission Status_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject240').huntingQueryVersion240]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_240",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Total Submissions by Submission Type",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where Timestamp > ago(30d) \n| extend Record= (parse_json(RawEventData)).RecordType \n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState  \n| extend UserKey = (parse_json(RawEventData)).UserKey \n| where Record == 29 \n| where ActionType == \"UserSubmission\" or ActionType == \"AdminSubmission\" \n| summarize count() by tostring(SubmissionState) | sort by count_\n// | render piechart // Uncomment this line to render as a graph\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Total Submissions by Submission Status"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject240')._huntingQuerycontentId240),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 240",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject240')._huntingQuerycontentId240)]",
                "contentId": "[variables('huntingQueryObject240')._huntingQuerycontentId240]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject240').huntingQueryVersion240]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject240')._huntingQuerycontentId240]",
        "contentKind": "HuntingQuery",
        "displayName": "Total Submissions by Submission Type",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject240')._huntingQuerycontentId240,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject240')._huntingQuerycontentId240,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject241').huntingQueryTemplateSpecName241]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Total Submissions by Submission Type_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject241').huntingQueryVersion241]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_241",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Total Submissions by Submission Type",
                "category": "Hunting Queries",
                "query": "CloudAppEvents \n| where ActionType == \"UserSubmission\" or ActionType == \"AdminSubmission\"\n| summarize count() by ActionType\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Total Submissions by Submission Type"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject241')._huntingQuerycontentId241),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 241",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject241')._huntingQuerycontentId241)]",
                "contentId": "[variables('huntingQueryObject241')._huntingQuerycontentId241]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject241').huntingQueryVersion241]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject241')._huntingQuerycontentId241]",
        "contentKind": "HuntingQuery",
        "displayName": "Total Submissions by Submission Type",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject241')._huntingQuerycontentId241,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject241')._huntingQuerycontentId241,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject242').huntingQueryTemplateSpecName242]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User reported submissions_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject242').huntingQueryVersion242]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_242",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User reported submissions",
                "category": "Hunting Queries",
                "query": "CloudAppEvents \n| where Timestamp > ago(30d) \n| extend Record= (parse_json(RawEventData)).RecordType \n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState  \n| where Record == 29 \n| where ActionType == \"UserSubmission\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing user reported email submissions"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject242')._huntingQuerycontentId242),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 242",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject242')._huntingQuerycontentId242)]",
                "contentId": "[variables('huntingQueryObject242')._huntingQuerycontentId242]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject242').huntingQueryVersion242]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject242')._huntingQuerycontentId242]",
        "contentKind": "HuntingQuery",
        "displayName": "User reported submissions",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject242')._huntingQuerycontentId242,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject242')._huntingQuerycontentId242,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject243').huntingQueryTemplateSpecName243]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User Submission Accuracy versus Admin Verdicts_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject243').huntingQueryVersion243]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_243",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User Email Submissions accuracy vs Admin review verdict",
                "category": "Hunting Queries",
                "query": "let ReviewResults = CloudAppEvents | where ActionType == \"SubmissionNotification\" \n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId)\n| extend Properties = parse_json(RawEventData.ExtendedProperties)\n| mv-expand element = Properties\n| where element.Name == \"AdminReviewResult\"\n| project SubmissionId, AdminReviewResult = element.Value;\nCloudAppEvents\n| where ActionType == \"UserSubmission\"\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId), SubmissionType = parse_json(RawEventData).SubmissionType\n| join kind=leftouter ReviewResults on SubmissionId\n| extend UserReportedAs=iif(SubmissionType == 1, \"Phish\",iif(SubmissionType == 2, \"Junk\",iif(SubmissionType == 3, \"NotJunk\",\"\")))\n| extend ReviewedAccuracy=iif(AdminReviewResult==UserReportedAs, \"Correct\", iif(AdminReviewResult==\"Phish\" and UserReportedAs == \"Junk\", \"Phish reported as junk\",iif(AdminReviewResult==\"Junk\" and UserReportedAs == \"Phish\",\"Junk reported as Phish\",iif(AdminReviewResult==\"NotJunk\",\"Reported but not malicious or spam\",iif(isempty(AdminReviewResult),\"Not Reviewed\",\"Not correct\")))))\n| extend Reviewed=iif(isempty(AdminReviewResult),\"Not Reviewed\",\"Reviewed\")\n| project SubmissionId,UserReportedAs,Reviewed,AdminReviewResult, ReviewedAccuracy\n| where Reviewed==\"Reviewed\"\n| summarize count() by ReviewedAccuracy\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises user submissions type compared to admin review verdict"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject243')._huntingQuerycontentId243),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 243",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject243')._huntingQuerycontentId243)]",
                "contentId": "[variables('huntingQueryObject243')._huntingQuerycontentId243]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject243').huntingQueryVersion243]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject243')._huntingQuerycontentId243]",
        "contentKind": "HuntingQuery",
        "displayName": "User Email Submissions accuracy vs Admin review verdict",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject243')._huntingQuerycontentId243,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject243')._huntingQuerycontentId243,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject244').huntingQueryTemplateSpecName244]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User Submissions - Top detection overrides by Admins_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject244').huntingQueryVersion244]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_244",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User Email Submissions (FN) - Top Detection Overrides by Admins",
                "category": "Hunting Queries",
                "query": "CloudAppEvents \n| where ActionType == \"UserSubmission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\n| extend User_SubmissionType=\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\n| join EmailEvents on NetworkMessageId, RecipientObjectId\n| where ThreatTypes !=\"\"and OrgLevelAction!=\"\"\n| summarize count() by OrgLevelAction, OrgLevelPolicy,ThreatTypes,User_SubmissionType\n| project OrgLevelAction, OrgLevelPolicy,ThreatTypes,User_SubmissionType, UserSubmissions = count_\n| top 10 by UserSubmissions desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises emails submitted as false negatives by users where emails were already detected by MDO but there was an admin definded policy override"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject244')._huntingQuerycontentId244),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 244",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject244')._huntingQuerycontentId244)]",
                "contentId": "[variables('huntingQueryObject244')._huntingQuerycontentId244]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject244').huntingQueryVersion244]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject244')._huntingQuerycontentId244]",
        "contentKind": "HuntingQuery",
        "displayName": "User Email Submissions (FN) - Top Detection Overrides by Admins",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject244')._huntingQuerycontentId244,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject244')._huntingQuerycontentId244,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject245').huntingQueryTemplateSpecName245]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User Submissions - Top detection overrides by Users_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject245').huntingQueryVersion245]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_245",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User Email Submissions (FN) - Top Detection Overrides by Users",
                "category": "Hunting Queries",
                "query": "CloudAppEvents \n| where ActionType == \"UserSubmission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\n| extend User_SubmissionType=\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\n| join EmailEvents on NetworkMessageId, RecipientObjectId\n| where ThreatTypes !=\"\"and UserLevelAction!=\"\"\n| summarize count() by UserLevelAction, UserLevelPolicy,ThreatTypes,User_SubmissionType\n| project UserLevelAction, UserLevelPolicy,ThreatTypes,User_SubmissionType, UserSubmissions = count_\n| top 10 by UserSubmissions desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises emails submitted as false negatives by users where emails were already detected by MDO but there was a policy override."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject245')._huntingQuerycontentId245),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 245",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject245')._huntingQuerycontentId245)]",
                "contentId": "[variables('huntingQueryObject245')._huntingQuerycontentId245]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject245').huntingQueryVersion245]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject245')._huntingQuerycontentId245]",
        "contentKind": "HuntingQuery",
        "displayName": "User Email Submissions (FN) - Top Detection Overrides by Users",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject245')._huntingQuerycontentId245,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject245')._huntingQuerycontentId245,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject246').huntingQueryTemplateSpecName246]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User Submissions - Top email (P2) senders domains_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject246').huntingQueryVersion246]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_246",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User Email Submissions (FN) - Top Inbound P2 Senders domains",
                "category": "Hunting Queries",
                "query": "let TotalInboundbySender = EmailEvents\n| where EmailDirection ==\"Inbound\"\n| summarize count() by SenderFromDomain;\nCloudAppEvents \n| where ActionType == \"UserSubmission\" \n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),RecipientObjectId=AccountObjectId,NetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\n| join EmailEvents on NetworkMessageId, RecipientObjectId\n| where EmailDirection == \"Inbound\"\n| summarize UserSubmissions=count() by SenderFromDomain\n| join TotalInboundbySender on SenderFromDomain\n| extend UserSubmissions_Percentage = todouble(round(UserSubmissions / todouble(count_) * 100, 2))\n| project SenderFromDomain, UserSubmissions, TotalInboundEmail=count_,UserSubmissions_Percentage\n| top 10 by UserSubmissions desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises top sender domains of inbound emails submitted as false negatives by users."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject246')._huntingQuerycontentId246),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 246",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject246')._huntingQuerycontentId246)]",
                "contentId": "[variables('huntingQueryObject246')._huntingQuerycontentId246]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject246').huntingQueryVersion246]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject246')._huntingQuerycontentId246]",
        "contentKind": "HuntingQuery",
        "displayName": "User Email Submissions (FN) - Top Inbound P2 Senders domains",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject246')._huntingQuerycontentId246,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject246')._huntingQuerycontentId246,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject247').huntingQueryTemplateSpecName247]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User Submissions - Top email (P2) senders_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject247').huntingQueryVersion247]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_247",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User Email Submissions (FN) - Top Inbound P2 Senders",
                "category": "Hunting Queries",
                "query": "let TotalInboundbySender = EmailEvents\n| where EmailDirection ==\"Inbound\"\n| summarize count() by SenderFromAddress;\nCloudAppEvents \n| where ActionType == \"UserSubmission\" \n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),RecipientObjectId=AccountObjectId,NetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\n| join EmailEvents on NetworkMessageId, RecipientObjectId\n| where EmailDirection == \"Inbound\"\n| summarize UserSubmissions=count() by SenderFromAddress\n| join TotalInboundbySender on SenderFromAddress\n| extend UserSubmissions_Percentage = todouble(round(UserSubmissions / todouble(count_) * 100, 2))\n| project SenderFromAddress, UserSubmissions, TotalInboundEmail=count_,UserSubmissions_Percentage\n| top 10 by UserSubmissions desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises top sender email addresses of inbound emails submitted as false negatives by users."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject247')._huntingQuerycontentId247),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 247",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject247')._huntingQuerycontentId247)]",
                "contentId": "[variables('huntingQueryObject247')._huntingQuerycontentId247]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject247').huntingQueryVersion247]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject247')._huntingQuerycontentId247]",
        "contentKind": "HuntingQuery",
        "displayName": "User Email Submissions (FN) - Top Inbound P2 Senders",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject247')._huntingQuerycontentId247,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject247')._huntingQuerycontentId247,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject248').huntingQueryTemplateSpecName248]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User Submissions - Top Intra-Org P2 senders_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject248').huntingQueryVersion248]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_248",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User Email Submissions (FN) - Top Intra-Org P2 Senders",
                "category": "Hunting Queries",
                "query": "CloudAppEvents \n| where ActionType == \"UserSubmission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\n| extend User_SubmissionType=\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\n| join EmailEvents on NetworkMessageId, RecipientObjectId\n| where EmailDirection == \"Intra-org\"\n| summarize count() by SenderMailFromAddress\n| project SenderMailFromAddress,UserSubmissions = count_\n| top 10 by UserSubmissions desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises top sender email addresses of intra-org emails submitted as false negatives by users."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject248')._huntingQuerycontentId248),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 248",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject248')._huntingQuerycontentId248)]",
                "contentId": "[variables('huntingQueryObject248')._huntingQuerycontentId248]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject248').huntingQueryVersion248]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject248')._huntingQuerycontentId248]",
        "contentKind": "HuntingQuery",
        "displayName": "User Email Submissions (FN) - Top Intra-Org P2 Senders",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject248')._huntingQuerycontentId248,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject248')._huntingQuerycontentId248,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject249').huntingQueryTemplateSpecName249]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User Submissions - Top Intra-Org Subjects_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject249').huntingQueryVersion249]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_249",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User Email Submissions (FN) - Top Intra-Org Subjects",
                "category": "Hunting Queries",
                "query": "CloudAppEvents \n| where ActionType == \"UserSubmission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\n| extend User_SubmissionType=\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\n| join EmailEvents on NetworkMessageId, RecipientObjectId\n| where EmailDirection == \"Intra-org\"\n| summarize count() by Subject\n| project Subject,UserSubmissions = count_\n| top 10 by UserSubmissions desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises top 10 subjects of intra-org emails submitted as false negatives by users."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject249')._huntingQuerycontentId249),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 249",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject249')._huntingQuerycontentId249)]",
                "contentId": "[variables('huntingQueryObject249')._huntingQuerycontentId249]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject249').huntingQueryVersion249]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject249')._huntingQuerycontentId249]",
        "contentKind": "HuntingQuery",
        "displayName": "User Email Submissions (FN) - Top Intra-Org Subjects",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject249')._huntingQuerycontentId249,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject249')._huntingQuerycontentId249,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject250').huntingQueryTemplateSpecName250]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User Submissions by Admin review status_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject250').huntingQueryVersion250]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_250",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User Email Submissions by Admin review status (Mark and Notify)",
                "category": "Hunting Queries",
                "query": "let ReviewResults = CloudAppEvents | where ActionType == \"SubmissionNotification\" \n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId)\n| extend Properties = parse_json(RawEventData.ExtendedProperties)\n| mv-expand element = Properties\n| where element.Name == \"AdminReviewResult\"\n| project SubmissionId, AdminReviewResult = element.Value;\nCloudAppEvents\n| where ActionType == \"UserSubmission\"\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId), SubmissionType = parse_json(RawEventData).SubmissionType\n| join kind=leftouter ReviewResults on SubmissionId\n| extend UserReportedAs=iif(SubmissionType == 1, \"Phish\",iif(SubmissionType == 2, \"Junk\",iif(SubmissionType == 3, \"NotJunk\",\"\")))\n| extend ReviewedAccuracy=iif(UserReportedAs==AdminReviewResult, 1,0)\n| extend Reviewed=iif(isempty(AdminReviewResult),\"Not Reviewed\",\"Reviewed\")\n| project SubmissionId,UserReportedAs,Reviewed,AdminReviewResult, ReviewedAccuracy\n| summarize count() by Reviewed\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises user submissions where admin also performed 'mark and notify' action on the submission"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject250')._huntingQuerycontentId250),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 250",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject250')._huntingQuerycontentId250)]",
                "contentId": "[variables('huntingQueryObject250')._huntingQuerycontentId250]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject250').huntingQueryVersion250]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject250')._huntingQuerycontentId250]",
        "contentKind": "HuntingQuery",
        "displayName": "User Email Submissions by Admin review status (Mark and Notify)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject250')._huntingQuerycontentId250,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject250')._huntingQuerycontentId250,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject251').huntingQueryTemplateSpecName251]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User Submissions by Grading Verdict - FN-FP_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject251').huntingQueryVersion251]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_251",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User Email Submissions (FN-FP) by Grading verdict",
                "category": "Hunting Queries",
                "query": "CloudAppEvents \n| where ActionType contains \"UserSubmissionTriage\" \n| extend UserKey = (parse_json(RawEventData)).UserKey, SubmissionState = (parse_json(RawEventData)).SubmissionState,  SubmissionId=(parse_json(RawEventData)).SubmissionId, TriageVerdict=(parse_json(RawEventData)).GradingResult.TriageVerdict \n| summarize count() by tostring(TriageVerdict)\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the total ammount of user false negative or false positive submissions by the verdict of the submission grading."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject251')._huntingQuerycontentId251),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 251",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject251')._huntingQuerycontentId251)]",
                "contentId": "[variables('huntingQueryObject251')._huntingQuerycontentId251]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject251').huntingQueryVersion251]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject251')._huntingQuerycontentId251]",
        "contentKind": "HuntingQuery",
        "displayName": "User Email Submissions (FN-FP) by Grading verdict",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject251')._huntingQuerycontentId251,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject251')._huntingQuerycontentId251,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject252').huntingQueryTemplateSpecName252]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User Submissions by Submission Type_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject252').huntingQueryVersion252]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_252",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User Email Submissions (FN) by Submission Type",
                "category": "Hunting Queries",
                "query": "CloudAppEvents\n| where ActionType contains \"UserSubmission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\n| extend User_SubmissionType=\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\niff(ActionType == \"AttackSimUserSubmission\" and SubmissionContentType==\"Mail\",\"User_AttackSim_Submission\",\n\"Other\")))\n| where User_SubmissionType!=\"Other\"\n| summarize count() by User_SubmissionType\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the total ammount of user false negative submission by submission type, including the phish simulations reported emails"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject252')._huntingQuerycontentId252),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 252",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject252')._huntingQuerycontentId252)]",
                "contentId": "[variables('huntingQueryObject252')._huntingQuerycontentId252]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject252').huntingQueryVersion252]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject252')._huntingQuerycontentId252]",
        "contentKind": "HuntingQuery",
        "displayName": "User Email Submissions (FN) by Submission Type",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject252')._huntingQuerycontentId252,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject252')._huntingQuerycontentId252,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject253').huntingQueryTemplateSpecName253]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User Submissions from Junk Folder_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject253').huntingQueryVersion253]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_253",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User email submissions (FN) from Junk Folder",
                "category": "Hunting Queries",
                "query": "CloudAppEvents \n| where ActionType == \"UserSubmission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\n| extend User_SubmissionType=\niff(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Phish_FN\",\niff(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\",\"User_Spam_FN\",\"Other\")),\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\n| where SubmissionContentType == \"Mail\" and SubmissionType in (\"1\",\"0\")\n| join EmailEvents on NetworkMessageId, RecipientObjectId\n| where DeliveryLocation == \"Junk folder\"\n| summarize count() by ThreatTypes,User_SubmissionType\n| project ThreatTypes,User_SubmissionType, Emails = count_\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the total ammount of user false negative submissions from the junk folder"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject253')._huntingQuerycontentId253),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 253",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject253')._huntingQuerycontentId253)]",
                "contentId": "[variables('huntingQueryObject253')._huntingQuerycontentId253]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject253').huntingQueryVersion253]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject253')._huntingQuerycontentId253]",
        "contentKind": "HuntingQuery",
        "displayName": "User email submissions (FN) from Junk Folder",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject253')._huntingQuerycontentId253,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject253')._huntingQuerycontentId253,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject254').huntingQueryTemplateSpecName254]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User Submissions Trend - FN_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject254').huntingQueryVersion254]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_254",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User Email Submission Trend (FN)",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = CloudAppEvents\n| where ActionType contains \"UserSubmission\"\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType);\nlet User_Phish_FN=baseQuery\n| make-series Count= countif(SubmissionType == \"1\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"User_Phish_FN\";\nlet User_Spam_FN=baseQuery\n| make-series Count= countif(SubmissionType == \"0\" and ActionType == \"UserSubmission\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"User_Spam_FN\";\nlet User_AttackSim_Submission=baseQuery\n| make-series Count= countif(ActionType == \"AttackSimUserSubmission\" and SubmissionContentType==\"Mail\" ) default = 0 on Timestamp from TimeStart to TimeEnd step 1d \n| extend Details = \"User_AttackSim_Submission\";\nunion User_Phish_FN,User_Spam_FN,User_AttackSim_Submission\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the daily ammount of users false negative submission by submission type, including phish simulations reported by users."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject254')._huntingQuerycontentId254),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 254",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject254')._huntingQuerycontentId254)]",
                "contentId": "[variables('huntingQueryObject254')._huntingQuerycontentId254]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject254').huntingQueryVersion254]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject254')._huntingQuerycontentId254]",
        "contentKind": "HuntingQuery",
        "displayName": "User Email Submission Trend (FN)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject254')._huntingQuerycontentId254,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject254')._huntingQuerycontentId254,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject255').huntingQueryTemplateSpecName255]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Attacked more than x times average_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject255').huntingQueryVersion255]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_255",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Attacked more than x times average",
                "category": "Hunting Queries",
                "query": "let AverageThreatPerRecipient = toscalar(EmailEvents \n| where DetectionMethods != \"\" \n| summarize total=count() by RecipientEmailAddress \n| summarize avg(total)); \nEmailEvents \n| where DetectionMethods != \"\" \n| summarize total=count() by RecipientEmailAddress \n| where tolong(total) >= 1*AverageThreatPerRecipient // update \"1\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing count of users attacked more than x times average."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject255')._huntingQuerycontentId255),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 255",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject255')._huntingQuerycontentId255)]",
                "contentId": "[variables('huntingQueryObject255')._huntingQuerycontentId255]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject255').huntingQueryVersion255]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject255')._huntingQuerycontentId255]",
        "contentKind": "HuntingQuery",
        "displayName": "Attacked more than x times average",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject255')._huntingQuerycontentId255,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject255')._huntingQuerycontentId255,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject256').huntingQueryTemplateSpecName256]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Malicious mails by sender IPs_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject256').huntingQueryVersion256]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_256",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malicious mails by sender IPs",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where Timestamp > ago(30d) \n| where ThreatTypes has \"Phish\" or ThreatTypes has \"Malware\"\n| summarize count() by SenderIPv4 //SenderIPv6\n| sort by count_\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing sender IPs sending malicious email of type Malware or Phish"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject256')._huntingQuerycontentId256),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 256",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject256')._huntingQuerycontentId256)]",
                "contentId": "[variables('huntingQueryObject256')._huntingQuerycontentId256]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject256').huntingQueryVersion256]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject256')._huntingQuerycontentId256]",
        "contentKind": "HuntingQuery",
        "displayName": "Malicious mails by sender IPs",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject256')._huntingQuerycontentId256,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject256')._huntingQuerycontentId256,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject257').huntingQueryTemplateSpecName257]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 percent of most attacked users_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject257').huntingQueryVersion257]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_257",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10% of most attacked users",
                "category": "Hunting Queries",
                "query": "let topTargeted = toscalar( EmailEvents \n| where DetectionMethods != \"\" \n| summarize total=count() by RecipientEmailAddress \n| summarize percentiles(total,90)); \nEmailEvents \n| where DetectionMethods != \"\" \n| summarize total=count() by RecipientEmailAddress \n| where total >= topTargeted \n| order by total desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing the list of top 10% of most attacked users"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject257')._huntingQuerycontentId257),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 257",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject257')._huntingQuerycontentId257)]",
                "contentId": "[variables('huntingQueryObject257')._huntingQuerycontentId257]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject257').huntingQueryVersion257]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject257')._huntingQuerycontentId257]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10% of most attacked users",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject257')._huntingQuerycontentId257,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject257')._huntingQuerycontentId257,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject258').huntingQueryTemplateSpecName258]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 URL domains attacking organization_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject258').huntingQueryVersion258]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_258",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 URL domains attacking organization",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where ThreatTypes != \"\" \n| extend detection= parse_json(DetectionMethods) \n| extend Spam = tostring(detection.Spam) \n| extend Phish = tostring(detection.Phish) \n| where (Spam == '[\"URL malicious reputation\"]') or (Phish == '[\"URL malicious reputation\"]') or (Phish == '[\"URL detonation reputation\"]') or (Phish == '[\"URL detonation\"]') \n| join EmailUrlInfo on NetworkMessageId\n| summarize total=count() by UrlDomain \n| top 10 by total \n| render columnchart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing list of top 10 URL domains attacking the organization"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject258')._huntingQuerycontentId258),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 258",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject258')._huntingQuerycontentId258)]",
                "contentId": "[variables('huntingQueryObject258')._huntingQuerycontentId258]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject258').huntingQueryVersion258]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject258')._huntingQuerycontentId258]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 URL domains attacking organization",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject258')._huntingQuerycontentId258,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject258')._huntingQuerycontentId258,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject259').huntingQueryTemplateSpecName259]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top external malicious senders_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject259').huntingQueryVersion259]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_259",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top external malicious senders",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where Timestamp > ago(30d) \n| where EmailDirection == \"Inbound\" \n| summarize count() by SenderFromAddress \n| sort by count_\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing external top malicious email sender with malware or phishing emails in an organization in last 30 days"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject259')._huntingQuerycontentId259),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 259",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject259')._huntingQuerycontentId259)]",
                "contentId": "[variables('huntingQueryObject259')._huntingQuerycontentId259]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject259').huntingQueryVersion259]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject259')._huntingQuerycontentId259]",
        "contentKind": "HuntingQuery",
        "displayName": "Top external malicious senders",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject259')._huntingQuerycontentId259,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject259')._huntingQuerycontentId259,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject260').huntingQueryTemplateSpecName260]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top targeted users_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject260').huntingQueryVersion260]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_260",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top targeted users",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where Timestamp > ago(30d) \n| where ThreatTypes has \"Malware\" or ThreatTypes has \"Phish\" \n| summarize count() by RecipientEmailAddress \n| sort by count_\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing top targeted users with malware or phishing emails in an organization in last 30 days"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject260')._huntingQuerycontentId260),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 260",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject260')._huntingQuerycontentId260)]",
                "contentId": "[variables('huntingQueryObject260')._huntingQuerycontentId260]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject260').huntingQueryVersion260]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject260')._huntingQuerycontentId260]",
        "contentKind": "HuntingQuery",
        "displayName": "Top targeted users",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject260')._huntingQuerycontentId260,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject260')._huntingQuerycontentId260,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject261').huntingQueryTemplateSpecName261]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "End user malicious clicks_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject261').huntingQueryVersion261]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_261",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "End user malicious clicks",
                "category": "Hunting Queries",
                "query": "UrlClickEvents\n| where ThreatTypes contains \"Phish\"\n| extend UrlBlocked = ActionType has_any(\"ClickBlocked\")\n| extend UrlAllowed = ActionType has_any('ClickAllowed')\n| extend UrlPendingVerdict = ActionType has_any('UrlScanInProgress')\n| extend ErrorPage = ActionType has_any('UrlErrorPage')\n| summarize Blocked = countif(UrlBlocked), Allowed = countif(UrlAllowed), PendingVerdict = countif(UrlPendingVerdict), Error = countif(ErrorPage), ClickedThrough = countif(IsClickedThrough)  by AccountUpn\n| sort by Blocked desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing list of top users click on Phis URLs"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject261')._huntingQuerycontentId261),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 261",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject261')._huntingQuerycontentId261)]",
                "contentId": "[variables('huntingQueryObject261')._huntingQuerycontentId261]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject261').huntingQueryVersion261]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject261')._huntingQuerycontentId261]",
        "contentKind": "HuntingQuery",
        "displayName": "End user malicious clicks",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject261')._huntingQuerycontentId261,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject261')._huntingQuerycontentId261,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject262').huntingQueryTemplateSpecName262]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "URL click count by click action_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject262').huntingQueryVersion262]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_262",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "URL click count by click action",
                "category": "Hunting Queries",
                "query": "UrlClickEvents \n| extend UrlBlocked = ActionType has_any(\"ClickBlocked\") \n| extend UrlAllowed = ActionType has_any('ClickAllowed') \n| extend UrlPendingVerdict = ActionType has_any('UrlScanInProgress') \n| extend ErrorPage = ActionType has_any('UrlErrorPage') \n| summarize Blocked = countif(UrlBlocked), Allowed = countif(UrlAllowed), PendingVerdict = countif(UrlPendingVerdict), Error = countif(ErrorPage), ClickedThrough = countif(IsClickedThrough)\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing URL click count by ClickAction"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject262')._huntingQuerycontentId262),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 262",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject262')._huntingQuerycontentId262)]",
                "contentId": "[variables('huntingQueryObject262')._huntingQuerycontentId262]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject262').huntingQueryVersion262]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject262')._huntingQuerycontentId262]",
        "contentKind": "HuntingQuery",
        "displayName": "URL click count by click action",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject262')._huntingQuerycontentId262,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject262')._huntingQuerycontentId262,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject263').huntingQueryTemplateSpecName263]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "URL click on ZAP Email_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject263').huntingQueryVersion263]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_263",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "URL click on ZAP email",
                "category": "Hunting Queries",
                "query": "AlertInfo\n| where Title contains \"Email messages containing malicious URL removed after delivery\" and Timestamp > ago (7d)\n| join kind=inner (AlertEvidence| where EntityType == \"MailMessage\") on AlertId \n| join UrlClickEvents on NetworkMessageId\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this query, we are looking for Url clicks on emails which get actioned by Zerohour auto purge"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject263')._huntingQuerycontentId263),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 263",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject263')._huntingQuerycontentId263)]",
                "contentId": "[variables('huntingQueryObject263')._huntingQuerycontentId263]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject263').huntingQueryVersion263]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject263')._huntingQuerycontentId263]",
        "contentKind": "HuntingQuery",
        "displayName": "URL click on ZAP email",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject263')._huntingQuerycontentId263,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject263')._huntingQuerycontentId263,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject264').huntingQueryTemplateSpecName264]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "URL clicks actions by URL_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject264').huntingQueryVersion264]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_264",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "URL clicks actions by URL",
                "category": "Hunting Queries",
                "query": "UrlClickEvents\n| extend UrlBlocked = ActionType has_any(\"ClickBlocked\")\n| extend UrlAllowed = ActionType has_any('ClickAllowed')\n| extend UrlPendingVerdict = ActionType has_any('UrlScanInProgress')\n| extend ErrorPage = ActionType has_any('UrlErrorPage')\n| summarize Blocked = countif(UrlBlocked), Allowed = countif(UrlAllowed), PendingVerdict = countif(UrlPendingVerdict), Error = countif(ErrorPage), ClickedThrough = countif(IsClickedThrough) by Url\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this query, we are looking URL click actions by URL in the last 7 days"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject264')._huntingQuerycontentId264),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 264",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject264')._huntingQuerycontentId264)]",
                "contentId": "[variables('huntingQueryObject264')._huntingQuerycontentId264]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject264').huntingQueryVersion264]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject264')._huntingQuerycontentId264]",
        "contentKind": "HuntingQuery",
        "displayName": "URL clicks actions by URL",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject264')._huntingQuerycontentId264,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject264')._huntingQuerycontentId264,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject265').huntingQueryTemplateSpecName265]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "URLClick details based on malicious URL click alert_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject265').huntingQueryVersion265]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_265",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "URLClick details based on malicious URL click alert",
                "category": "Hunting Queries",
                "query": "AlertInfo\n| where Title contains \"Potentially malicious\" and Timestamp > ago (30d)\n| join kind=inner (AlertEvidence| where EntityType == \"MailMessage\") on AlertId \n| join UrlClickEvents on NetworkMessageId\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "In this query, we are looking for Url clicks on emails which are generated the alert-A potentially malicious URL click was detected"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject265')._huntingQuerycontentId265),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 265",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject265')._huntingQuerycontentId265)]",
                "contentId": "[variables('huntingQueryObject265')._huntingQuerycontentId265]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject265').huntingQueryVersion265]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject265')._huntingQuerycontentId265]",
        "contentKind": "HuntingQuery",
        "displayName": "URLClick details based on malicious URL click alert",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject265')._huntingQuerycontentId265,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject265')._huntingQuerycontentId265,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject266').huntingQueryTemplateSpecName266]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User clicked through events_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject266').huntingQueryVersion266]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_266",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User clicked through events",
                "category": "Hunting Queries",
                "query": "UrlClickEvents \n| where ActionType == \"ClickAllowed\" or IsClickedThrough !=\"0\" \n| where ThreatTypes has \"Phish\" \n| summarize by ReportId, IsClickedThrough, AccountUpn, NetworkMessageId, ThreatTypes\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps reviewing malicious clicks where user was allowed to proceed through malicious URL page."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject266')._huntingQuerycontentId266),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 266",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject266')._huntingQuerycontentId266)]",
                "contentId": "[variables('huntingQueryObject266')._huntingQuerycontentId266]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject266').huntingQueryVersion266]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject266')._huntingQuerycontentId266]",
        "contentKind": "HuntingQuery",
        "displayName": "User clicked through events",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject266')._huntingQuerycontentId266,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject266')._huntingQuerycontentId266,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject267').huntingQueryTemplateSpecName267]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User clicks on malicious inbound emails_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject267').huntingQueryVersion267]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_267",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User clicks on malicious inbound emails",
                "category": "Hunting Queries",
                "query": "let UrlClicked = (UrlClickEvents\n| where ActionType == \"ClickAllowed\" or IsClickedThrough !=\"0\"\n| extend Device_IPv4 = IPAddress\n| project ActionType, Device_IPv4, Url, UrlChain, IPAddress, NetworkMessageId);\nEmailEvents\n| where Timestamp > ago(30d)\n| where isnotempty(ThreatTypes) and EmailDirection == \"Inbound\"\n| where ThreatTypes has_any (\"Malware\", \"Phish\")\n| extend SenderFromAddress_IPv4 = strcat(SenderFromAddress, \", \", SenderIPv4)\n| join kind = inner UrlClicked on NetworkMessageId\n| project Timestamp,NetworkMessageId, Subject, SenderFromAddress_IPv4, RecipientEmailAddress, ThreatTypes, ActionType, Url, UrlChain, Device_IPv4, LatestDeliveryLocation, LatestDeliveryAction, EmailAction, EmailActionPolicy\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query provides insights on users who clicked on a suspicious URL"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject267')._huntingQuerycontentId267),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 267",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject267')._huntingQuerycontentId267)]",
                "contentId": "[variables('huntingQueryObject267')._huntingQuerycontentId267]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject267').huntingQueryVersion267]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject267')._huntingQuerycontentId267]",
        "contentKind": "HuntingQuery",
        "displayName": "User clicks on malicious inbound emails",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject267')._huntingQuerycontentId267,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject267')._huntingQuerycontentId267,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject268').huntingQueryTemplateSpecName268]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "User clicks on phishing URLs in emails_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject268').huntingQueryVersion268]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_268",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "User clicks on phishing URLs in emails",
                "category": "Hunting Queries",
                "query": "UrlClickEvents \n| where ThreatTypes has \"Phish\" \n| join EmailEvents on NetworkMessageId,  $left.AccountUpn == $right.RecipientEmailAddress \n| project Timestamp, Url, ActionType, AccountUpn, ReportId, NetworkMessageId, ThreatTypes, IsClickedThrough, DeliveryLocation, OrgLevelAction, UserLevelAction\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query helps in determining clickthroughs when email delivered because of detection overrides."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject268')._huntingQuerycontentId268),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 268",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject268')._huntingQuerycontentId268)]",
                "contentId": "[variables('huntingQueryObject268')._huntingQuerycontentId268]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject268').huntingQueryVersion268]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject268')._huntingQuerycontentId268]",
        "contentKind": "HuntingQuery",
        "displayName": "User clicks on phishing URLs in emails",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject268')._huntingQuerycontentId268,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject268')._huntingQuerycontentId268,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject269').huntingQueryTemplateSpecName269]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Malicious Clicks allowed (click-through)_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject269').huntingQueryVersion269]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_269",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malicious Clicks allowed (click-through)",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nUrlClickEvents\n| where TimeGenerated >= TimeStart\n| where IsClickedThrough == 1\n| where isnotempty(ThreatTypes)\n| make-series Count = count() default = 0 on TimeGenerated from TimeStart to TimeEnd step 1d\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Visualises malicious URL clicks that were allowed through Safe Links over time, helping analysts identify when users bypass security controls and click on malicious content.\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject269')._huntingQuerycontentId269),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 269",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject269')._huntingQuerycontentId269)]",
                "contentId": "[variables('huntingQueryObject269')._huntingQuerycontentId269]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject269').huntingQueryVersion269]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject269')._huntingQuerycontentId269]",
        "contentKind": "HuntingQuery",
        "displayName": "Malicious Clicks allowed (click-through)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject269')._huntingQuerycontentId269,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject269')._huntingQuerycontentId269,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject270').huntingQueryTemplateSpecName270]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Malicious Emails with QR code Urls_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject270').huntingQueryVersion270]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_270",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Malicious Emails with QR code Urls",
                "category": "Hunting Queries",
                "query": "EmailUrlInfo\n| where UrlLocation == \"QRCode\"\n| join kind=inner (\n    EmailEvents\n    | where isnotempty(ThreatTypes)\n    | project NetworkMessageId, ThreatTypes\n) on NetworkMessageId\n| summarize count() by ThreatTypes\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Visualises emails containing QR code URLs that have been detected as malicious, helping analysts identify QR code-based attack campaigns.\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject270')._huntingQuerycontentId270),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 270",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject270')._huntingQuerycontentId270)]",
                "contentId": "[variables('huntingQueryObject270')._huntingQuerycontentId270]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject270').huntingQueryVersion270]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject270')._huntingQuerycontentId270]",
        "contentKind": "HuntingQuery",
        "displayName": "Malicious Emails with QR code Urls",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject270')._huntingQuerycontentId270,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject270')._huntingQuerycontentId270,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject271').huntingQueryTemplateSpecName271]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Phishing Email Url Redirector_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject271').huntingQueryVersion271]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_271",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "PhishingEmailUrlRedirector (1)",
                "category": "Hunting Queries",
                "query": "EmailUrlInfo\n//This regex identifies emails containing the \"T-Dot\" redirector pattern in the URL\n| where Url matches regex @\"s?\\:\\/\\/(?:www\\.)?t\\.(?:[\\w\\-\\.]+\\/+)+(?:r|redirect)\\/?\\?\" \n    //This regex narrows in on emails that contain the known malicious domain pattern in the URL from the most recent campaigns\n    and Url matches regex @\"[a-zA-Z]\\-[a-zA-Z]{2}\\.(xyz|club|shop)\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "The query helps detect emails associated with the open redirector URL campaign using Defender for Office 365 data."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject271')._huntingQuerycontentId271),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 271",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject271')._huntingQuerycontentId271)]",
                "contentId": "[variables('huntingQueryObject271')._huntingQuerycontentId271]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject271').huntingQueryVersion271]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject271')._huntingQuerycontentId271]",
        "contentKind": "HuntingQuery",
        "displayName": "PhishingEmailUrlRedirector (1)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject271')._huntingQuerycontentId271,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject271')._huntingQuerycontentId271,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject272').huntingQueryTemplateSpecName272]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SafeLinks URL detections_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject272').huntingQueryVersion272]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_272",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "SafeLinks URL detections",
                "category": "Hunting Queries",
                "query": "EmailEvents \n| where DetectionMethods != \"\" \n| extend detection= tostring(parse_json(DetectionMethods).Phish) \n| where detection == '[\"URL detonation reputation\"]' or detection == '[\"URL detonation\"]' \n| summarize total=count() by bin(Timestamp, 1d) \n| order by Timestamp asc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query provides insights on the detections done by SafeLinks protection in Defender for Office 365"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject272')._huntingQuerycontentId272),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 272",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject272')._huntingQuerycontentId272)]",
                "contentId": "[variables('huntingQueryObject272')._huntingQuerycontentId272]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject272').huntingQueryVersion272]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject272')._huntingQuerycontentId272]",
        "contentKind": "HuntingQuery",
        "displayName": "SafeLinks URL detections",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject272')._huntingQuerycontentId272,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject272')._huntingQuerycontentId272,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject273').huntingQueryTemplateSpecName273]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 Users clicking on Malicious URLs (Malware)_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject273').huntingQueryVersion273]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_273",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 Users clicking on Malicious URLs (Malware)",
                "category": "Hunting Queries",
                "query": "UrlClickEvents\n| where ThreatTypes == \"Malware\"\n| summarize count() by AccountUpn\n| top 10 by count_\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Visualises the top 10 users with click attempts on URLs in emails detected as malware, helping analysts identify risky user behaviour and potential targets.\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject273')._huntingQuerycontentId273),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 273",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject273')._huntingQuerycontentId273)]",
                "contentId": "[variables('huntingQueryObject273')._huntingQuerycontentId273]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject273').huntingQueryVersion273]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject273')._huntingQuerycontentId273]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 Users clicking on Malicious URLs (Malware)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject273')._huntingQuerycontentId273,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject273')._huntingQuerycontentId273,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject274').huntingQueryTemplateSpecName274]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 Users clicking on Malicious URLs (Phish)_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject274').huntingQueryVersion274]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_274",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 Users clicking on Malicious URLs (Phish)",
                "category": "Hunting Queries",
                "query": "UrlClickEvents\n| where ThreatTypes == \"Phish\"\n| summarize count() by AccountUpn\n| top 10 by count_\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Visualises the top 10 users with click attempts on URLs in emails detected as phishing, helping analysts identify risky user behaviour and potential targets.\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject274')._huntingQuerycontentId274),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 274",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject274')._huntingQuerycontentId274)]",
                "contentId": "[variables('huntingQueryObject274')._huntingQuerycontentId274]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject274').huntingQueryVersion274]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject274')._huntingQuerycontentId274]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 Users clicking on Malicious URLs (Phish)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject274')._huntingQuerycontentId274,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject274')._huntingQuerycontentId274,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject275').huntingQueryTemplateSpecName275]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Top 10 Users clicking on Malicious URLs (Spam)_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject275').huntingQueryVersion275]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_275",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Top 10 Users clicking on Malicious URLs (Spam)",
                "category": "Hunting Queries",
                "query": "UrlClickEvents\n| where ThreatTypes == \"Spam\"\n| summarize count() by AccountUpn\n| top 10 by count_\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Visualises the top 10 users with click attempts on URLs in emails detected as spam, helping analysts identify risky user behaviour and potential targets.\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject275')._huntingQuerycontentId275),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 275",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject275')._huntingQuerycontentId275)]",
                "contentId": "[variables('huntingQueryObject275')._huntingQuerycontentId275]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject275').huntingQueryVersion275]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject275')._huntingQuerycontentId275]",
        "contentKind": "HuntingQuery",
        "displayName": "Top 10 Users clicking on Malicious URLs (Spam)",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject275')._huntingQuerycontentId275,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject275')._huntingQuerycontentId275,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject276').huntingQueryTemplateSpecName276]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "URL Click attempts by threat type_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject276').huntingQueryVersion276]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_276",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "URL Click attempts by threat type",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nUrlClickEvents\n| where TimeGenerated >= TimeStart\n| where isnotempty(ThreatTypes)\n| summarize Count = count() by ThreatTypes, bin(TimeGenerated, 1d)\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Visualises the total amount of click attempts on URLs with detections, split by the different threat types identified.\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject276')._huntingQuerycontentId276),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 276",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject276')._huntingQuerycontentId276)]",
                "contentId": "[variables('huntingQueryObject276')._huntingQuerycontentId276]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject276').huntingQueryVersion276]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject276')._huntingQuerycontentId276]",
        "contentKind": "HuntingQuery",
        "displayName": "URL Click attempts by threat type",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject276')._huntingQuerycontentId276,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject276')._huntingQuerycontentId276,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject277').huntingQueryTemplateSpecName277]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "URL Clicks by Action_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject277').huntingQueryVersion277]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_277",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "URL Clicks by Action",
                "category": "Hunting Queries",
                "query": "UrlClickEvents\n| summarize Count = count() by ActionType\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Summarizes URL click events by action type to help analysts understand user click behavior and policy effectiveness.\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject277')._huntingQuerycontentId277),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 277",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject277')._huntingQuerycontentId277)]",
                "contentId": "[variables('huntingQueryObject277')._huntingQuerycontentId277]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject277').huntingQueryVersion277]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject277')._huntingQuerycontentId277]",
        "contentKind": "HuntingQuery",
        "displayName": "URL Clicks by Action",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject277')._huntingQuerycontentId277,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject277')._huntingQuerycontentId277,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject278').huntingQueryTemplateSpecName278]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "URLs by location_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject278').huntingQueryVersion278]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_278",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "URLs by location",
                "category": "Hunting Queries",
                "query": "EmailUrlInfo\n| summarize Count = count() by UrlLocation\n| render piechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Visualises where URLs have been identified in emails, summarizing by location (for example: Attachment, header, body) to help analysts understand distribution and risk.\nBased on Defender for Office 365 workbook: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject278')._huntingQuerycontentId278),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 278",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject278')._huntingQuerycontentId278)]",
                "contentId": "[variables('huntingQueryObject278')._huntingQuerycontentId278]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject278').huntingQueryVersion278]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject278')._huntingQuerycontentId278]",
        "contentKind": "HuntingQuery",
        "displayName": "URLs by location",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject278')._huntingQuerycontentId278,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject278')._huntingQuerycontentId278,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject279').huntingQueryTemplateSpecName279]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Post Delivery Events by Admin_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject279').huntingQueryVersion279]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_279",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Post Delivery Events by Admin",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = EmailPostDeliveryEvents\n| where TimeGenerated >= TimeStart\n| where ActionTrigger has \"AdminAction\";\nlet sdelete=baseQuery\n| where Action has 'Soft Delete'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Soft Delete\";\nlet hdelete=baseQuery\n| where Action has 'Hard Delete'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Hard Delete\";\nlet mtojunk=baseQuery\n| where Action has 'Moved to junk folder'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Moved to junk folder\";\nlet mtoinbox=baseQuery\n| where Action has 'Moved to inbox'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Moved to inbox\";\nlet qrel=baseQuery\n| where Action has 'Quarantine release'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Quarantine release\";\nunion sdelete,hdelete,mtojunk,mtoinbox,qrel\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the daily amount of emails that had an admin post delivery action, summarizing the data by action type"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject279')._huntingQuerycontentId279),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 279",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject279')._huntingQuerycontentId279)]",
                "contentId": "[variables('huntingQueryObject279')._huntingQuerycontentId279]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject279').huntingQueryVersion279]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject279')._huntingQuerycontentId279]",
        "contentKind": "HuntingQuery",
        "displayName": "Post Delivery Events by Admin",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject279')._huntingQuerycontentId279,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject279')._huntingQuerycontentId279,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject280').huntingQueryTemplateSpecName280]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Post Delivery Events by Location_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject280').huntingQueryVersion280]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_280",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Post Delivery Events by Location",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet quarantine=EmailPostDeliveryEvents\n| where TimeGenerated >= TimeStart\n| where DeliveryLocation has 'Quarantine'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Quarantine\";\nlet delete=EmailPostDeliveryEvents\n| where TimeGenerated >= TimeStart\n| where DeliveryLocation has 'Delete'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Delete\";\nlet junk=EmailPostDeliveryEvents\n| where TimeGenerated >= TimeStart\n| where DeliveryLocation has 'Junk'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Junk\";\nlet inbox=EmailPostDeliveryEvents\n| where TimeGenerated >= TimeStart\n| where DeliveryLocation has 'Inbox'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Inbox\";\nunion quarantine,delete,junk,inbox\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the amount of emails that had a post delivery action, summarizing the data daily by the final location as a result of the action"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject280')._huntingQuerycontentId280),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 280",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject280')._huntingQuerycontentId280)]",
                "contentId": "[variables('huntingQueryObject280')._huntingQuerycontentId280]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject280').huntingQueryVersion280]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject280')._huntingQuerycontentId280]",
        "contentKind": "HuntingQuery",
        "displayName": "Post Delivery Events by Location",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject280')._huntingQuerycontentId280,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject280')._huntingQuerycontentId280,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject281').huntingQueryTemplateSpecName281]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Post Delivery Events by ZAP type_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject281').huntingQueryVersion281]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_281",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Post Delivery Events by ZAP type",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nlet baseQuery = EmailPostDeliveryEvents\n| where TimeGenerated >= TimeStart\n| where ActionType has \"ZAP\";\nlet szap=baseQuery\n| where ActionType has 'Spam ZAP'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Spam ZAP\";\nlet pzap=baseQuery\n| where ActionType has 'Phish ZAP'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Phish ZAP\";\nlet mzap=baseQuery\n| where ActionType has 'Malware ZAP'\n| make-series Count= count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| extend Details = \"Malware ZAP\";\nunion szap,pzap,mzap\n| project Count, Details, Timestamp\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the daily amount of emails that had a post delivery action from zero-hour auto purge, summarizing by phish,spam or malware detection action"
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject281')._huntingQuerycontentId281),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 281",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject281')._huntingQuerycontentId281)]",
                "contentId": "[variables('huntingQueryObject281')._huntingQuerycontentId281]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject281').huntingQueryVersion281]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject281')._huntingQuerycontentId281]",
        "contentKind": "HuntingQuery",
        "displayName": "Post Delivery Events by ZAP type",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject281')._huntingQuerycontentId281,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject281')._huntingQuerycontentId281,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject282').huntingQueryTemplateSpecName282]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Post Delivery Events over time_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject282').huntingQueryVersion282]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_282",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Post Delivery Events over time",
                "category": "Hunting Queries",
                "query": "let TimeStart = startofday(ago(30d));\nlet TimeEnd = startofday(now());\nEmailPostDeliveryEvents\n| where TimeGenerated >= TimeStart\n| where ActionType has \"ZAP\"\n| make-series ZappedEmails = count() default = 0 on Timestamp from TimeStart to TimeEnd step 1d\n| render timechart\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query visualises the daily amount of emails that had a post delivery action from zero-hour auto purge."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject282')._huntingQuerycontentId282),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 282",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject282')._huntingQuerycontentId282)]",
                "contentId": "[variables('huntingQueryObject282')._huntingQuerycontentId282]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject282').huntingQueryVersion282]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject282')._huntingQuerycontentId282]",
        "contentKind": "HuntingQuery",
        "displayName": "Post Delivery Events over time",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject282')._huntingQuerycontentId282,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject282')._huntingQuerycontentId282,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject283').huntingQueryTemplateSpecName283]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "EmailDelivered-ToInbox_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject283').huntingQueryVersion283]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_283",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Determine Successfully Delivered Phishing Emails to Inbox/Junk folder.",
                "category": "Hunting Queries",
                "query": "EmailEvents\n| where isnotempty(ThreatTypes) and DeliveryLocation in~ (\"Inbox/folder\",\"Junk folder\")\n| extend Name = tostring(split(SenderFromAddress, '@', 0)[0]), UPNSuffix = tostring(split(SenderFromAddress, '@', 1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = SenderIPv4\n| extend MailBox_0_MailboxPrimaryAddress = RecipientEmailAddress\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query identifies threats which got successfully delivered to Inbox/Junk folder."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1566"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject283')._huntingQuerycontentId283),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 283",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject283')._huntingQuerycontentId283)]",
                "contentId": "[variables('huntingQueryObject283')._huntingQuerycontentId283]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject283').huntingQueryVersion283]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject283')._huntingQuerycontentId283]",
        "contentKind": "HuntingQuery",
        "displayName": "Determine Successfully Delivered Phishing Emails to Inbox/Junk folder.",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject283')._huntingQuerycontentId283,'-', '1.0.1')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject283')._huntingQuerycontentId283,'-', '1.0.1')))]",
        "version": "1.0.1"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject284').huntingQueryTemplateSpecName284]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AnomalousPayloadDeliveredWithISOFile_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject284').huntingQueryVersion284]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_284",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Anomalous Payload Delivered from ISO files",
                "category": "Hunting Queries",
                "query": "DeviceEvents\n| where TimeGenerated > ago(30d) \n| where ActionType == 'BrowserLaunchedToOpenUrl' \n| where RemoteUrl endswith \".lnk\"\n| where RemoteUrl !startswith \"C:\"\n| project LNKLaunchTimestamp = TimeGenerated, DeviceName, RemoteUrl\n| parse RemoteUrl with Drive '\\\\' *\n| extend Drive= tostring(Drive)\n| where isnotempty(Drive)\n| join kind=innerunique (\nDeviceProcessEvents\n| where TimeGenerated > ago(30d)\n| where FolderPath !startswith \"C:\"\n| parse FolderPath with Drive '\\\\' *\n| project Drive= tostring(Drive), StartedProcessTimestamp = TimeGenerated, StartedProcessName = FileName, StartedProcessSHA1 = SHA1, StartedProcessCommandline = ProcessCommandLine, StartedProcessPath = FolderPath, DeviceName, StartedProcessParentName = InitiatingProcessFileName, StartedProcessParentCmdline = InitiatingProcessCommandLine, StartedParentProcessFolderPath = InitiatingProcessFolderPath, StartedProcessGrandParent = InitiatingProcessParentFileName, TimeGenerated\n) on DeviceName, Drive\n| where StartedProcessTimestamp between (LNKLaunchTimestamp ..(LNKLaunchTimestamp+1m))\n| project-away Drive1, DeviceName1\n| project-reorder LNKLaunchTimestamp, StartedProcessTimestamp, DeviceName, RemoteUrl, Drive, StartedProcessName, StartedProcessSHA1, StartedProcessPath,StartedProcessCommandline, StartedProcessParentName, StartedProcessParentCmdline, StartedParentProcessFolderPath, StartedProcessGrandParent, TimeGenerated\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for lnk file executions from other locations than C: drive, which can relate to mounted ISO-files."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution"
                  },
                  {
                    "name": "techniques",
                    "value": "T1204"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject284')._huntingQuerycontentId284),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 284",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject284')._huntingQuerycontentId284)]",
                "contentId": "[variables('huntingQueryObject284')._huntingQuerycontentId284]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject284').huntingQueryVersion284]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject284')._huntingQuerycontentId284]",
        "contentKind": "HuntingQuery",
        "displayName": "Anomalous Payload Delivered from ISO files",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject284')._huntingQuerycontentId284,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject284')._huntingQuerycontentId284,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject285').huntingQueryTemplateSpecName285]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BitsadminActivity_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject285').huntingQueryVersion285]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_285",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Bitsadmin Activity",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents\n| where \n    (FileName =~ \"bitsadmin.exe\" or column_ifexists('ProcessVersionInfoOriginalFileName','ColumnNotAvailable') =~ 'bitsadmin.exe')\n    and ProcessCommandLine has_any ('/Transfer','/AddFile', '/AddFileSet','/AddFileWithRanges')\n| extend \n    ParsedCommandLine = parse_command_line(ProcessCommandLine,'windows')\n| extend     \n    RemoteUrl = tostring(ParsedCommandLine[-2]),\n    LocalFile= tostring(ParsedCommandLine[-1]),\n    Direction = iff(ProcessCommandLine has \"/Upload\", 'Upload', 'Download')\n| project-reorder \n    TimeGenerated,\n    DeviceId,\n    DeviceName,\n    Direction,\n    RemoteUrl,\n    LocalFile,\n    InitiatingProcessFolderPath,\n    InitiatingProcessAccountDomain,\n    InitiatingProcessAccountName,\n    InitiatingProcessSHA256,\n    ProcessCommandLine\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for use of bitsadmin.exe for file transfer, which can be used for legitimate purposes or as part of a malware downloader."
                  },
                  {
                    "name": "tactics",
                    "value": "Persistence,CommandAndControl,Exfiltration"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject285')._huntingQuerycontentId285),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 285",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject285')._huntingQuerycontentId285)]",
                "contentId": "[variables('huntingQueryObject285')._huntingQuerycontentId285]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject285').huntingQueryVersion285]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject285')._huntingQuerycontentId285]",
        "contentKind": "HuntingQuery",
        "displayName": "Bitsadmin Activity",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject285')._huntingQuerycontentId285,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject285')._huntingQuerycontentId285,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject286').huntingQueryTemplateSpecName286]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MaliciousUseOfMSIExec_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject286').huntingQueryVersion286]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_286",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Detect Malicious use of MSIExec",
                "category": "Hunting Queries",
                "query": "//Find possible download and execution using Msiexec\nDeviceProcessEvents\n| where TimeGenerated > ago(7d)\n//MSIExec\n| where FileName =~ \"msiexec.exe\" and \n//With domain in command line\n(ProcessCommandLine has \"http\" and ProcessCommandLine has \"return\")//Find PowerShell running files from the temp folder\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query detects possible download and execution using Msiexec."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution,PrivilegeEscalation,CredentialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject286')._huntingQuerycontentId286),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 286",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject286')._huntingQuerycontentId286)]",
                "contentId": "[variables('huntingQueryObject286')._huntingQuerycontentId286]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject286').huntingQueryVersion286]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject286')._huntingQuerycontentId286]",
        "contentKind": "HuntingQuery",
        "displayName": "Detect Malicious use of MSIExec",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject286')._huntingQuerycontentId286,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject286')._huntingQuerycontentId286,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject287').huntingQueryTemplateSpecName287]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MaliciousUseOfMsiExecMimikatz_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject287').huntingQueryVersion287]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_287",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Detect Malicious use of Msiexec Mimikatz",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents\n| where Timestamp > ago(7d)\n| where InitiatingProcessFileName =~ \"msiexec.exe\"\n//Mimikatz commands\nand (ProcessCommandLine contains \"privilege::\" \nor ProcessCommandLine has \"sekurlsa\" \nor ProcessCommandLine contains \"token::\")\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for malicious use of msiexec.exe, particularly alongside mimikatz, a common credential dumper and privilege escalation tool."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution,CredentialAccess,PrivilegeEscalation"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject287')._huntingQuerycontentId287),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 287",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject287')._huntingQuerycontentId287)]",
                "contentId": "[variables('huntingQueryObject287')._huntingQuerycontentId287]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject287').huntingQueryVersion287]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject287')._huntingQuerycontentId287]",
        "contentKind": "HuntingQuery",
        "displayName": "Detect Malicious use of Msiexec Mimikatz",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject287')._huntingQuerycontentId287,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject287')._huntingQuerycontentId287,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject288').huntingQueryTemplateSpecName288]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "OfficeAppsLaunchingWscript_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject288').huntingQueryVersion288]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_288",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Office Apps Launching Wscipt",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents \n| where InitiatingProcessFileName in~('winword.exe', 'excel.exe', 'outlook.exe') \n| where FileName =~ \"wscript.exe\" and ProcessCommandLine has \".jse\" \n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "The query searches for Office applications launching wscript.exe to run a JSE file."
                  },
                  {
                    "name": "tactics",
                    "value": "LateralMovement,Collection,CommandAndControl"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject288')._huntingQuerycontentId288),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 288",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject288')._huntingQuerycontentId288)]",
                "contentId": "[variables('huntingQueryObject288')._huntingQuerycontentId288]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject288').huntingQueryVersion288]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject288')._huntingQuerycontentId288]",
        "contentKind": "HuntingQuery",
        "displayName": "Office Apps Launching Wscipt",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject288')._huntingQuerycontentId288,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject288')._huntingQuerycontentId288,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject289').huntingQueryTemplateSpecName289]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PotentialKerberoastActivities_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject289').huntingQueryVersion289]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_289",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Detect Potential kerberoast Activities",
                "category": "Hunting Queries",
                "query": "let MaxCount = 70; //Number of requests per 2 minute timeframe, depending on org size.\nIdentityLogonEvents\n| where TimeGenerated > ago(1d)\n| where ActionType == \"LogonSuccess\"\n| where Protocol == \"Kerberos\"\n| extend json = todynamic(parse_json(tostring(AdditionalFields)))\n| extend SPN = json.Spns,\n       AttackTechniques = json.AttackTechniques\n      | project-away json\n| where isnotempty(SPN)\n| where AttackTechniques has \"T1558.003\"\n| mv-expand SPN\n        | extend SPNType = tostring(extract(@\"^\\w+\",0,tostring(SPN)))\n| distinct tostring(SPN),DeviceName,AccountUpn, AccountSid,bin(TimeGenerated,2m),ReportId, tostring(AttackTechniques)\n| summarize count(), SPNS=(make_list(SPN, 100000)),ReportId=tostring((make_list(ReportId, 100000))[0]) by AccountUpn,AccountSid,DeviceName, bin(TimeGenerated, 2m), tostring(AttackTechniques)\n| extend SPNS = (replace_regex(tostring(SPNS), @'[^\\w+-\\/]+', ''))\n| where count_ >= MaxCount\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query aim to detect if someone requests service tickets (where count => maxcount). The query requires trimming to set a baseline level for MaxCount."
                  },
                  {
                    "name": "tactics",
                    "value": "LateralMovement"
                  },
                  {
                    "name": "techniques",
                    "value": "T1558.003"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject289')._huntingQuerycontentId289),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 289",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject289')._huntingQuerycontentId289)]",
                "contentId": "[variables('huntingQueryObject289')._huntingQuerycontentId289]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject289').huntingQueryVersion289]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject289')._huntingQuerycontentId289]",
        "contentKind": "HuntingQuery",
        "displayName": "Detect Potential kerberoast Activities",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject289')._huntingQuerycontentId289,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject289')._huntingQuerycontentId289,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject290').huntingQueryTemplateSpecName290]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PowerShellDownloads_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject290').huntingQueryVersion290]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_290",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "PowerShell Downloads",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents\n| where TimeGenerated > ago(7d)\n| where FileName in~ (\"powershell.exe\", \"powershell_ise.exe\")\n| where ProcessCommandLine has \"Net.WebClient\"\n   or ProcessCommandLine has \"DownloadFile\"\n   or ProcessCommandLine has \"Invoke-WebRequest\"\n   or ProcessCommandLine has \"Invoke-Shellcode\"\n   or ProcessCommandLine has \"http\"\n   or ProcessCommandLine has \"IEX\"\n   or ProcessCommandLine has \"Start-BitsTransfer\"\n   or ProcessCommandLine has \"mpcmdrun.exe\"\n| project TimeGenerated, DeviceName, InitiatingProcessFileName, FileName, ProcessCommandLine\n| top 100 by TimeGenerated\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "The query searches for PowerShell execution events that could involve a download."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject290')._huntingQuerycontentId290),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 290",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject290')._huntingQuerycontentId290)]",
                "contentId": "[variables('huntingQueryObject290')._huntingQuerycontentId290]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject290').huntingQueryVersion290]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject290')._huntingQuerycontentId290]",
        "contentKind": "HuntingQuery",
        "displayName": "PowerShell Downloads",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject290')._huntingQuerycontentId290,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject290')._huntingQuerycontentId290,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject291').huntingQueryTemplateSpecName291]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SuspiciousAppExeutedByWebserver_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject291').huntingQueryVersion291]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_291",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Webserver Executing Suspicious Applications",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents\n| where TimeGenerated > ago(7d)\n| where InitiatingProcessFileName in~ ('w3wp.exe', 'httpd.exe') // 'sqlservr.exe')\n| where FileName in~ ('cmd.exe', 'powershell.exe', 'cscript.exe', 'wscript.exe', 'net.exe', 'net1.exe', 'ping.exe', 'whoami.exe')\n| summarize instances = count() by ProcessCommandLine, FolderPath, DeviceName, DeviceId \n| order by instances asc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query looks for common webserver process names and identifies any processes launched using a scripting language (cmd, powershell, wscript, cscript)."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject291')._huntingQuerycontentId291),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 291",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject291')._huntingQuerycontentId291)]",
                "contentId": "[variables('huntingQueryObject291')._huntingQuerycontentId291]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject291').huntingQueryVersion291]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject291')._huntingQuerycontentId291]",
        "contentKind": "HuntingQuery",
        "displayName": "Webserver Executing Suspicious Applications",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject291')._huntingQuerycontentId291,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject291')._huntingQuerycontentId291,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject292').huntingQueryTemplateSpecName292]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SuspiciousMshtaUsage_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject292').huntingQueryVersion292]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_292",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Detect Suspicious Mshta Usage",
                "category": "Hunting Queries",
                "query": "// mshta.exe script launching processes\nDeviceProcessEvents \n| where Timestamp > ago(7d)\nand InitiatingProcessFileName =~ 'mshta.exe'\nand InitiatingProcessCommandLine contains '<script>'\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query detects when mshta.exe has been run, which might include illegitimate usage by attackers."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject292')._huntingQuerycontentId292),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 292",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject292')._huntingQuerycontentId292)]",
                "contentId": "[variables('huntingQueryObject292')._huntingQuerycontentId292]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject292').huntingQueryVersion292]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject292')._huntingQuerycontentId292]",
        "contentKind": "HuntingQuery",
        "displayName": "Detect Suspicious Mshta Usage",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject292')._huntingQuerycontentId292,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject292')._huntingQuerycontentId292,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject293').huntingQueryTemplateSpecName293]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "FilesCopiedToUSBDrives_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject293').huntingQueryVersion293]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_293",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Files Copied to USB Drives",
                "category": "Hunting Queries",
                "query": "let UsbDriveMount = DeviceEvents\n| where ActionType==\"UsbDriveMounted\"\n| extend ParsedFields=parse_json(AdditionalFields)\n| project DeviceId, DeviceName, DriveLetter=ParsedFields.DriveLetter, MountTime=TimeGenerated,\nProductName=ParsedFields.ProductName,SerialNumber=ParsedFields.SerialNumber,Manufacturer=ParsedFields.Manufacturer\n| order by DeviceId asc, MountTime desc;\nlet FileCreation = DeviceFileEvents\n| where InitiatingProcessAccountName != \"system\"\n| where ActionType == \"FileCreated\"\n| where FolderPath !startswith \"C:\\\\\"\n| where FolderPath !startswith \"\\\\\"\n| project ReportId,DeviceId,InitiatingProcessAccountDomain,\nInitiatingProcessAccountName,InitiatingProcessAccountUpn,\nFileName, FolderPath, SHA256, TimeGenerated, SensitivityLabel, IsAzureInfoProtectionApplied\n| order by DeviceId asc, TimeGenerated desc;\nFileCreation | lookup kind=inner (UsbDriveMount) on DeviceId\n| where FolderPath startswith DriveLetter\n| where TimeGenerated >= MountTime\n| partition hint.strategy=native by ReportId ( top 1 by MountTime )\n| order by DeviceId asc, TimeGenerated desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query lists files copied to USB external drives with USB drive information based on FileCreated events associated with most recent USBDriveMount events befor file creations."
                  },
                  {
                    "name": "tactics",
                    "value": "Exfiltration"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject293')._huntingQuerycontentId293),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 293",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject293')._huntingQuerycontentId293)]",
                "contentId": "[variables('huntingQueryObject293')._huntingQuerycontentId293]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject293').huntingQueryVersion293]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject293')._huntingQuerycontentId293]",
        "contentKind": "HuntingQuery",
        "displayName": "Files Copied to USB Drives",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject293')._huntingQuerycontentId293,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject293')._huntingQuerycontentId293,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject294').huntingQueryTemplateSpecName294]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CVE-2022-26134-Confluence_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject294').huntingQueryVersion294]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_294",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Suspicious Tomcat Confluence Process Launch",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents\n| where InitiatingProcessFileName hasprefix \"tomcat\" and InitiatingProcessCommandLine has \"confluence\"\n| where (ProcessCommandLine has_any(\"certutil\", \"whoami\", \"nltest\", \" dir \", \"curl\", \"ifconfig\", \"cat \", \"net user\",\n\"net time /domain\",\"tasklist\",\"-c ls\",\"ipconfig\",\"arp\",\"ping\",\"net view\",\"net group\",\"netstat\", \"wmic datafile\"))\nor (FileName =~ \"powershell.exe\" and ProcessCommandLine hasprefix \"-e\") \n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "The query checks for suspicious Tomcat process launches associated with likely exploitation of Confluence - CVE-2022-26134."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution,PrivilegeEscalation"
                  },
                  {
                    "name": "techniques",
                    "value": "T1203"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject294')._huntingQuerycontentId294),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 294",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject294')._huntingQuerycontentId294)]",
                "contentId": "[variables('huntingQueryObject294')._huntingQuerycontentId294]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject294').huntingQueryVersion294]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject294')._huntingQuerycontentId294]",
        "contentKind": "HuntingQuery",
        "displayName": "Suspicious Tomcat Confluence Process Launch",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject294')._huntingQuerycontentId294,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject294')._huntingQuerycontentId294,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject295').huntingQueryTemplateSpecName295]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MosaicLoader_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject295').huntingQueryVersion295]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_295",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "MosaicLoader",
                "category": "Hunting Queries",
                "query": "DeviceRegistryEvents \n| where ((ActionType == \"RegistryValueSet\") and (RegistryKey startswith @\"HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows Defender\\\\Exclusions\\\\Paths\" \nor RegistryKey startswith @\"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Extensions\"\nor RegistryKey startswith @\"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Processes\"))\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This hunting query looks Malware Hides Itself Among Windows Defender Exclusions to Evade Detection."
                  },
                  {
                    "name": "tactics",
                    "value": "CommandAndControl"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject295')._huntingQuerycontentId295),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 295",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject295')._huntingQuerycontentId295)]",
                "contentId": "[variables('huntingQueryObject295')._huntingQuerycontentId295]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject295').huntingQueryVersion295]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject295')._huntingQuerycontentId295]",
        "contentKind": "HuntingQuery",
        "displayName": "MosaicLoader",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject295')._huntingQuerycontentId295,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject295')._huntingQuerycontentId295,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject296').huntingQueryTemplateSpecName296]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SpoolsvSpawningRundll32_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject296').huntingQueryVersion296]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_296",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Spoolsv Spawning Rundll32",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents\n| where InitiatingProcessParentFileName has \"spoolsv.exe\"\n| where InitiatingProcessFileName =~ \"rundll32.exe\"\n| where isempty(InitiatingProcessCommandLine) or InitiatingProcessCommandLine endswith \"rundll32.exe\" //either commandline is empty or just \"rundll32.exe\"\n| where FileName !in~ (\"WerFault.exe\")\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Look for the spoolsv.exe launching rundll32.exe with an empty command line."
                  },
                  {
                    "name": "tactics",
                    "value": "PrivilegeEscalation,Execution"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject296')._huntingQuerycontentId296),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 296",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject296')._huntingQuerycontentId296)]",
                "contentId": "[variables('huntingQueryObject296')._huntingQuerycontentId296]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject296').huntingQueryVersion296]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject296')._huntingQuerycontentId296]",
        "contentKind": "HuntingQuery",
        "displayName": "Spoolsv Spawning Rundll32",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject296')._huntingQuerycontentId296,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject296')._huntingQuerycontentId296,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject297').huntingQueryTemplateSpecName297]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SuspiciousDLLInSpoolFolder_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject297').huntingQueryVersion297]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_297",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Suspicious DLLs in spool Folder",
                "category": "Hunting Queries",
                "query": "DeviceFileEvents\n| where FolderPath contains @\"\\system32\\spool\\drivers\\x64\\3\\\"\n| where FileName endswith \".dll\"\n| where ActionType in (\"FileCreated\", \"FileRenamed\")\n| join kind=inner DeviceImageLoadEvents on DeviceId,DeviceName,FileName,InitiatingProcessFileName\n| where TimeGenerated1 >= TimeGenerated and FolderPath1 contains @\"\\system32\\spool\\drivers\\x64\\3\\Old\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Look for the creation of suspicious DLL files spawned in the \\spool\\ folder along with DLLs that were recently loaded afterwards from \\Old."
                  },
                  {
                    "name": "tactics",
                    "value": "PrivilegeEscalation,Execution"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject297')._huntingQuerycontentId297),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 297",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject297')._huntingQuerycontentId297)]",
                "contentId": "[variables('huntingQueryObject297')._huntingQuerycontentId297]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject297').huntingQueryVersion297]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject297')._huntingQuerycontentId297]",
        "contentKind": "HuntingQuery",
        "displayName": "Suspicious DLLs in spool Folder",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject297')._huntingQuerycontentId297,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject297')._huntingQuerycontentId297,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject298').huntingQueryTemplateSpecName298]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SuspiciousFilesInSpoolFolder_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject298').huntingQueryVersion298]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_298",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Suspicious Files in spool Folder",
                "category": "Hunting Queries",
                "query": "DeviceFileEvents\n| where FolderPath has @\"System32\\spool\\drivers\"\n| project DeviceName, TimeGenerated, ActionType, FolderPath, FileName, SHA1\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Monitor for creation of suspicious files in the /spools/driver/ folder. This is a broad-based search that will surface any creation or modification of files in the folder targeted by this exploit."
                  },
                  {
                    "name": "tactics",
                    "value": "PrivilegeEscalation,Execution"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject298')._huntingQuerycontentId298),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 298",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject298')._huntingQuerycontentId298)]",
                "contentId": "[variables('huntingQueryObject298')._huntingQuerycontentId298]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject298').huntingQueryVersion298]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject298')._huntingQuerycontentId298]",
        "contentKind": "HuntingQuery",
        "displayName": "Suspicious Files in spool Folder",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject298')._huntingQuerycontentId298,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject298')._huntingQuerycontentId298,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject299').huntingQueryTemplateSpecName299]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SuspiciousSpoolsvChildProcess_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject299').huntingQueryVersion299]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_299",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Suspicious Spoolsv Child Process",
                "category": "Hunting Queries",
                "query": "// Look for file load events for spoolsv\nDeviceImageLoadEvents\n| where TimeGenerated > ago(7d)\n| where InitiatingProcessFileName =~ \"spoolsv.exe\"\n| where FolderPath has @\"spool\\drivers\"\n| extend LoadFileTime = TimeGenerated\n| distinct DeviceId, LoadFileTime, FileName, SHA256\n// Join process data associated with spoolsv launching suspicious processes after image load\n| join DeviceProcessEvents on $left.DeviceId == $right.DeviceId\n| where TimeGenerated > ago(7d)\n| where TimeGenerated < LoadFileTime +5m\n| where InitiatingProcessFileName =~ \"spoolsv.exe\"\n| where ProcessIntegrityLevel =~ 'SYSTEM'\n| where (FileName1 in~(\"gpupdate.exe\", \"whoami.exe\", \"nltest.exe\", \"taskkill.exe\",\n            \"wmic.exe\", \"taskmgr.exe\", \"sc.exe\", \"findstr.exe\", \"curl.exe\", \"wget.exe\", \"certutil.exe\", \"bitsadmin.exe\", \"accesschk.exe\",\n            \"wevtutil.exe\", \"bcdedit.exe\", \"fsutil.exe\", \"cipher.exe\", \"schtasks.exe\", \"write.exe\", \"wuauclt.exe\") or \n// Processes with specific FPs removed          \n(FileName1 =~ \"net.exe\" and ProcessCommandLine !has \"start\") or \n(FileName1 =~ \"cmd.exe\" and not(ProcessCommandLine has_any(\".spl\", \"route add\", \"program files\"))) or \n(FileName1 =~ \"netsh.exe\" and not(ProcessCommandLine has_any(\"add portopening\", \"rule name\")))) or\n(FileName1 =~ \"powershell.exe\" and ProcessCommandLine!has \".spl\") or\n(FileName1 =~ \"rundll32.exe\" and ProcessCommandLine != \"\" and ProcessCommandLine !contains \" \")\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Surfaces suspicious spoolsv.exe behavior likely related to CVE-2021-1675"
                  },
                  {
                    "name": "tactics",
                    "value": "PrivilegeEscalation,Execution"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject299')._huntingQuerycontentId299),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 299",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject299')._huntingQuerycontentId299)]",
                "contentId": "[variables('huntingQueryObject299')._huntingQuerycontentId299]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject299').huntingQueryVersion299]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject299')._huntingQuerycontentId299]",
        "contentKind": "HuntingQuery",
        "displayName": "Suspicious Spoolsv Child Process",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject299')._huntingQuerycontentId299,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject299')._huntingQuerycontentId299,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject300').huntingQueryTemplateSpecName300]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PrintNightmareUsageDetection-CVE-2021-1675_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject300').huntingQueryVersion300]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_300",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "PrintNightmare CVE-2021-1675 usage Detection",
                "category": "Hunting Queries",
                "query": "DeviceFileEvents\n| where Timestamp > ago(7d)\n| where ActionType == \"FileCreated\"\n| where FolderPath startswith \"C:\\\\WINDOWS\\\\SYSTEM32\\\\SPOOL\\\\drivers\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query looks for any file creations in the print spooler drivers folder."
                  },
                  {
                    "name": "tactics",
                    "value": "PrivilegeEscalation,LateralMovement,Execution"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject300')._huntingQuerycontentId300),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 300",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject300')._huntingQuerycontentId300)]",
                "contentId": "[variables('huntingQueryObject300')._huntingQuerycontentId300]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject300').huntingQueryVersion300]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject300')._huntingQuerycontentId300]",
        "contentKind": "HuntingQuery",
        "displayName": "PrintNightmare CVE-2021-1675 usage Detection",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject300')._huntingQuerycontentId300,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject300')._huntingQuerycontentId300,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject301').huntingQueryTemplateSpecName301]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SuspiciousFileCreationByPrintSpoolerService_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject301').huntingQueryVersion301]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_301",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Windows Print Spooler Service Suspicious File Creation",
                "category": "Hunting Queries",
                "query": "DeviceFileEvents\n| where TimeGenerated > ago(7d)\n| where ActionType == \"FileCreated\"\n| where FileName endswith \".dll\"\n| where FolderPath startswith \"C:\\\\WINDOWS\\\\SYSTEM32\\\\SPOOL\\\\drivers\\\\x64\\\\\\3\\\\\"\n   or FolderPath startswith \"C:\\\\WINDOWS\\\\SYSTEM32\\\\SPOOL\\\\drivers\\\\x64\\\\\\4\\\\\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "The query digs in Windows print spooler drivers folder for any file creations. This behavior is used from PoC Exploit of CVE-2021-34527, CVE-2021-1675 or CVE-2022-21999."
                  },
                  {
                    "name": "tactics",
                    "value": "PrivilegeEscalation,LateralMovement"
                  },
                  {
                    "name": "techniques",
                    "value": "T1574"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject301')._huntingQuerycontentId301),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 301",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject301')._huntingQuerycontentId301)]",
                "contentId": "[variables('huntingQueryObject301')._huntingQuerycontentId301]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject301').huntingQueryVersion301]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject301')._huntingQuerycontentId301]",
        "contentKind": "HuntingQuery",
        "displayName": "Windows Print Spooler Service Suspicious File Creation",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject301')._huntingQuerycontentId301,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject301')._huntingQuerycontentId301,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject302').huntingQueryTemplateSpecName302]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MITRESuspiciousEvents_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject302').huntingQueryVersion302]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_302",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "MITRE - Suspicious Events",
                "category": "Hunting Queries",
                "query": "let weights = dynamic({\"Low\":1, \"Medium\":3, \"High\":5}); //Assign weights to the risk levels\n//Low risk events\nlet lowRiskEvents =\n    DeviceProcessEvents \n    | where\n        (FileName =~ \"powershell.exe\" and ProcessCommandLine has \"-command\") //T1086 PowerShell\n        or\n        (FileName =~ \"powershell.exe\" and ProcessCommandLine contains \"-nop\") //T1086 PowerShell\n        or\n        (FileName =~ \"schtasks.exe\" and ProcessCommandLine has \"create\") //T1053 Scheduled Task\n        or\n        (FileName =~ \"installutil.exe\") //T1118 InstallUtil\n        or\n        (FileName =~ \"msbuild.exe\") //T1127 Trusted Developer Utilities\n        or\n        (FileName =~ \"nbtstat.exe\") //T1016 System Network Configuration Discovery\n        or\n        (FileName == \"mshta.exe\") //T1170 Mshta\n        or\n        (FileName =~ \"netsh.exe\") //T1089 Disabling Security Tools, T1063 Security Software Discovery\n        or\n        (FileName == \"net.exe\" and ProcessCommandLine has \" start \") //T1007 System Service Discovery\n    | extend Weight = toint((weights[\"Low\"]));\n//Medium risk events\nlet mediumRiskEvents =\n    DeviceProcessEvents \n    | where\n        (FileName =~ \"regsvcs.exe\") //T1121 Regsvcs/Regasm\n        or\n        (FileName =~ \"arp.exe\" and ProcessCommandLine has \"-a\") //T1016 System Network Configuration Discovery\n        or\n        (FileName =~ \"ipconfig.exe\" and ProcessCommandLine has \"all\") //T1016 System Network Configuration Discovery\n        or\n        (FileName startswith \"psexe\") //T1035 Service Execution\n        or\n        (FileName == \"net.exe\" and ProcessCommandLine has \" share \") //T1135 Network Share Discovery\n        or\n        (FileName =~ \"netsh.exe\" and ProcessCommandLine has \"interface show\") //T1016 System Network Configuration Discovery\n    | extend Weight = toint((weights[\"Medium\"]));\n//Higher risk events\nlet highRiskEvents =\n    DeviceProcessEvents \n    | where\n        (FileName =~ \"net.exe\" and ProcessCommandLine has \"config\") //T1016 System Network Configuration Discovery\n        or\n        (FileName =~ \"net.exe\" and ProcessCommandLine has \"time\") //T1124 System Time Discovery\n        or \n        (FileName =~ \"w32tm.exe\" and ProcessCommandLine has \"/tz\") //T1124 System Time Discovery\n        or\n        (FileName == \"cmstp.exe\") //T1191 CMSTP\n        or\n        (FileName =~ \"netsh.exe\" and (ProcessCommandLine has \"portproxy\" or ProcessCommandLine has \"p\")) //T1090 Connection Proxy\n    | extend Weight = toint((weights[\"High\"]));\nunion kind=outer lowRiskEvents, mediumRiskEvents, highRiskEvents\n| project TimeGenerated, DeviceName, FileName, ProcessCommandLine, InitiatingProcessCommandLine, Weight\n| summarize Start_Time=min(TimeGenerated), End_Time=max(TimeGenerated), Weight_Sum=sum(Weight), Processes=make_set(FileName, 100000), Commands=make_set(ProcessCommandLine, 100000) by DeviceName\n| where Weight_Sum > 30\n| sort by Weight_Sum desc\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This hunting query looks for several different MITRE techniques, grouped by risk level. A weighting is applied to each risk level and a total score calculated per machine. Techniques can be added/removed as required."
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject302')._huntingQuerycontentId302),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 302",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject302')._huntingQuerycontentId302)]",
                "contentId": "[variables('huntingQueryObject302')._huntingQuerycontentId302]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject302').huntingQueryVersion302]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject302')._huntingQuerycontentId302]",
        "contentKind": "HuntingQuery",
        "displayName": "MITRE - Suspicious Events",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject302')._huntingQuerycontentId302,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject302')._huntingQuerycontentId302,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject303').huntingQueryTemplateSpecName303]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AnomalousVoulmeOfFileDeletion_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject303').huntingQueryVersion303]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_303",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Unusual Volume of file deletion by users",
                "category": "Hunting Queries",
                "query": "let relevantOperations = pack_array(\"FileDeleted\", \"FileRecycled\", \"FileDeletedFirstStageRecycleBin\", \"FileDeletedSecondStageRecycleBin\", \"FileVersionsAllMinorsRecycled\", \"FileVersionRecycled\", \"FileVersionsAllRecycled\");\nlet relevantAppIds = pack_array(int(20892), int(15600)); // App Ids for SharePoint and OneDrive\nlet timeWindow = 7d;\nlet timeNow = now();\n//\nlet riskyUsers= // Look for users with risky sign-ins\n  SigninLogs    \n  | where CreatedDateTime between ((timeNow - timeWindow) .. (timeNow))\n  | where isnotempty(UserId) and isnotempty(OriginalRequestId)\n  | where ResultType == '0'\n  | where RiskLevelDuringSignIn == 'high'\n  | project RiskLevelDuringSignIn, UserId, CreatedDateTime, SessionId=OriginalRequestId\n  ;\nlet hasUsers = isnotempty(toscalar(riskyUsers));\n //\nlet deleteEvents = // look for file deletion activity and scope it to risky users\n  CloudAppEvents\n  | where hasUsers\n  | where TimeGenerated between ((timeNow - timeWindow) .. (timeNow))\n  | where ApplicationId in (relevantAppIds)\n  | where isnotempty(AccountObjectId)\n  | where AccountObjectId in (riskyUsers)\n  | where ActionType in (relevantOperations)\n  | extend SessionId= tostring(RawEventData.AppAccessContext.AADSessionId)\n  | where isnotempty(SessionId)\n  | project UserId=AccountObjectId, AccountDisplayName, ApplicationId, SessionId, ActionType, TimeGenerated, ReportId\n  ;   \n //\ndeleteEvents  \n| join kind=leftsemi riskyUsers on UserId, SessionId\n| summarize Count=count() , (Timestamp, ReportId)=arg_min(TimeGenerated, ReportId) by UserId, AccountDisplayName, ApplicationId, ActionType, Time=bin(TimeGenerated, 5m)\n// look for only those scoped users who have generated an increase in file deletion activity.\n| summarize TotalCount= countif(Count > 50), (Timestamp, ReportId)=arg_min(Timestamp, ReportId) by UserId, AccountDisplayName, ApplicationId \n| where TotalCount >= 3\n| project UserId, AccountDisplayName, ApplicationId, TotalCount, ReportId, Timestamp\n| extend NTDomain = tostring(split(AccountDisplayName,'\\\\',0)[0]), Name = tostring(split(AccountDisplayName,'\\\\',1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_NTDomain = NTDomain\n| extend Account_0_AadUserId = UserId\n| extend CloudApplication_0_AppId = ApplicationId\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query looks for users performing file deletion activities. Spikes in file deletion observed from risky sign-in sessions are flagged here."
                  },
                  {
                    "name": "tactics",
                    "value": "Impact"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject303')._huntingQuerycontentId303),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 303",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject303')._huntingQuerycontentId303)]",
                "contentId": "[variables('huntingQueryObject303')._huntingQuerycontentId303]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject303').huntingQueryVersion303]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject303')._huntingQuerycontentId303]",
        "contentKind": "HuntingQuery",
        "displayName": "Unusual Volume of file deletion by users",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject303')._huntingQuerycontentId303,'-', '1.0.1')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject303')._huntingQuerycontentId303,'-', '1.0.1')))]",
        "version": "1.0.1"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject304').huntingQueryTemplateSpecName304]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DetectMailSniper_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject304').huntingQueryVersion304]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_304",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Detect MaiSniper",
                "category": "Hunting Queries",
                "query": "let dateRange = ago(10d);\n//\nlet whoamiProcess = DeviceProcessEvents\n| where ProcessCreationTime >= dateRange\n| where FileName =~ 'whoami.exe' and InitiatingProcessParentFileName =~ 'powershell.exe'\n| project DeviceId, whoamiTime = ProcessCreationTime, whoamiProcessName = FileName, \nwhoamiParentName = InitiatingProcessParentFileName, whoamiParentPID = InitiatingProcessParentId;\n//\nlet netProcess = DeviceProcessEvents \n| where ProcessCreationTime >= dateRange\n| where FileName =~ 'net.exe' and InitiatingProcessParentFileName =~ 'powershell.exe'\n| project DeviceId, netTime = ProcessCreationTime, ProcessCreationTime = FileName, \nnetParentName = InitiatingProcessParentFileName, netParentPID = InitiatingProcessParentId;\n//\nlet mailServerEvents = DeviceNetworkEvents\n| where TimeGenerated >= dateRange\n| where InitiatingProcessFileName =~ 'powershell.exe'\n| where RemoteUrl contains 'onmicrosoft.com'\nor RemoteUrl contains 'outlook.com'\n| project DeviceId, mailTime = TimeGenerated, mailProcessName = InitiatingProcessFileName, \nmailPID = InitiatingProcessId;\n//\nmailServerEvents\n| join netProcess on DeviceId \n| where netParentPID == mailPID and netParentName == mailProcessName \n| join whoamiProcess on DeviceId \n| where whoamiParentPID == mailPID and whoamiParentName == mailProcessName \n| where netTime < mailTime + 4h and netTime > mailTime - 4h\n| where whoamiTime < mailTime + 4h and whoamiTime > mailTime - 4h\n| project DeviceId, EstimatedIncidentTime = mailTime, ProcessName = mailProcessName, \nProcessID = mailPID\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for usage of MailSniper Exchange attack tool."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess,CredentialAccess,Collection,Exfiltration"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject304')._huntingQuerycontentId304),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 304",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject304')._huntingQuerycontentId304)]",
                "contentId": "[variables('huntingQueryObject304')._huntingQuerycontentId304]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject304').huntingQueryVersion304]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject304')._huntingQuerycontentId304]",
        "contentKind": "HuntingQuery",
        "displayName": "Detect MaiSniper",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject304')._huntingQuerycontentId304,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject304')._huntingQuerycontentId304,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject305').huntingQueryTemplateSpecName305]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AccountBruteForce_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject305').huntingQueryVersion305]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_305",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Account Brute Force",
                "category": "Hunting Queries",
                "query": "DeviceLogonEvents\n| where isnotempty(RemoteIP) \n    and AccountName !endswith \"$\"\n    and RemoteIPType == \"Public\"\n| extend Account=strcat(AccountDomain, \"\\\\\", AccountName)\n| summarize \n    Successful=countif(ActionType == \"LogonSuccess\"),\n    Failed = countif(ActionType == \"LogonFailed\"),\n    FailedAccountsCount = dcountif(Account, ActionType == \"LogonFailed\"),\n    SuccessfulAccountsCount = dcountif(Account, ActionType == \"LogonSuccess\"),\n    FailedAccounts = make_set(iff(ActionType == \"LogonFailed\", Account, \"\"), 5),\n    SuccessfulAccounts = make_set(iff(ActionType == \"LogonSuccess\", Account, \"\"), 5)\n    by DeviceName, RemoteIP, RemoteIPType\n| where Failed > 10 and Successful > 0 and FailedAccountsCount > 2 and SuccessfulAccountsCount == 1\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This hunting query searches for public IP addresses that failed to logon to a computer multiple times, using multiple accounts, and eventually succeeded."
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject305')._huntingQuerycontentId305),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 305",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject305')._huntingQuerycontentId305)]",
                "contentId": "[variables('huntingQueryObject305')._huntingQuerycontentId305]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject305').huntingQueryVersion305]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject305')._huntingQuerycontentId305]",
        "contentKind": "HuntingQuery",
        "displayName": "Account Brute Force",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject305')._huntingQuerycontentId305,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject305')._huntingQuerycontentId305,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject306').huntingQueryTemplateSpecName306]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RemoteFileCreationWithPsExec_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject306').huntingQueryVersion306]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_306",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Remote File Creation with PsExec",
                "category": "Hunting Queries",
                "query": "// Find PsExec creating multiple files on remote machines in a 10-minute window\nDeviceFileEvents\n| where TimeGenerated > ago(7d)\n// Looking for PsExec by accepteula command flag\n| where InitiatingProcessCommandLine has \"accepteula\"\n// Remote machines and file is exe\n| where FolderPath has \"\\\\\\\\\" and FileName endswith \".exe\"\n| extend Exe = countof(InitiatingProcessCommandLine, \".exe\")\n// Checking to see if command line has 2 .exe or .bat\n| where InitiatingProcessCommandLine !has \".ps1\" and Exe > 1 or\nInitiatingProcessCommandLine has \".bat\"\n// Exclusions: Remove the following line to widen scope of AHQ\n| where not(InitiatingProcessCommandLine has_any(\"batch\", \"auditpol\",\n\"script\", \"scripts\", \"illusive\", \"rebootrequired\"))\n| summarize FileCount = dcount(FolderPath), make_set(SHA1, 100000), make_set(FolderPath, 100000),\nmake_set(FileName, 100000), make_set(InitiatingProcessCommandLine, 100000) by DeviceId,\nTimeWindow=bin(TimeGenerated, 10m), InitiatingProcessFileName\n| where FileCount > 4\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query detects remote file creation events that might indicate an active attack using PsExec."
                  },
                  {
                    "name": "tactics",
                    "value": "LateralMovement"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject306')._huntingQuerycontentId306),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 306",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject306')._huntingQuerycontentId306)]",
                "contentId": "[variables('huntingQueryObject306')._huntingQuerycontentId306]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject306').huntingQueryVersion306]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject306')._huntingQuerycontentId306]",
        "contentKind": "HuntingQuery",
        "displayName": "Remote File Creation with PsExec",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject306')._huntingQuerycontentId306,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject306')._huntingQuerycontentId306,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject307').huntingQueryTemplateSpecName307]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ServiceAccountsPerformingRemotePS_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject307').huntingQueryVersion307]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_307",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Service Accounts Performing Remote PS",
                "category": "Hunting Queries",
                "query": "let InteractiveTypes = pack_array(                                  // Declare Interactive logon type names\n    'Interactive',\n    'CachedInteractive',\n    'Unlock',\n    'RemoteInteractive',\n    'CachedRemoteInteractive',\n    'CachedUnlock'\n);\nlet WhitelistedCmdlets = pack_array(                                // List of whitelisted commands that don't provide a lot of value\n    'prompt',\n    'Out-Default',\n    'out-lineoutput',\n    'format-default',\n    'Set-StrictMode',\n    'TabExpansion2'\n);\nlet WhitelistedAccounts = pack_array('FakeWhitelistedAccount');     // List of accounts that are known to perform this activity in the environment and can be ignored\nDeviceLogonEvents                                                         // Get all logon events...\n| where AccountName !in~ (WhitelistedAccounts)                      // ...where it is not a whitelisted account...\n| where ActionType == \"LogonSuccess\"                                // ...and the logon was successful...\n| where AccountName !contains \"$\"                                   // ...and not a machine logon.\n| where AccountName !has \"winrm va_\"                                // WinRM will have pseudo account names that match this if there is an explicit permission for an admin to run the cmdlet, so assume it is good.\n| extend IsInteractive=(LogonType in (InteractiveTypes))            // Determine if the logon is interactive (True=1,False=0)...\n| summarize HasInteractiveLogon=max(IsInteractive)                  // ...then bucket and get the maximum interactive value (0 or 1)...\n            by AccountName                                          // ... by the AccountNames\n| where HasInteractiveLogon == 0                                    // ...and filter out all accounts that had an interactive logon.\n// At this point, we have a list of accounts that we believe to be service accounts\n// Now we need to find RemotePS sessions that were spawned by those accounts\n// Note that we look at all powershell cmdlets executed to form a 29-day baseline to evaluate the data on today\n| join kind=rightsemi (                                             // Start by dropping the account name and only tracking the...\n\tDeviceEvents                                                      // ...\n\t| where ActionType == 'PowerShellCommand'                       // ...PowerShell commands seen...\n\t| where InitiatingProcessFileName =~ 'wsmprovhost.exe'          // ...whose parent was wsmprovhost.exe (RemotePS Server)...\n    | extend AccountName = InitiatingProcessAccountName             // ...and add an AccountName field so the join is easier\n) on AccountName\n// At this point, we have all of the commands that were ran by service accounts\n| extend Command = tostring(extractjson('$.Command', tostring(AdditionalFields)))   // Extract the actual PowerShell command that was executed\n| where Command !in (WhitelistedCmdlets)                            // Remove any values that match the whitelisted cmdlets\n| summarize (Timestamp, ReportId)=argmax(TimeGenerated, ReportId),      // Then group all of the cmdlets and calculate the min/max times of execution...\n    makeset(Command), count(), min(TimeGenerated) by                    // ...as well as creating a list of cmdlets ran and the count..\n    AccountName, DeviceName, DeviceId                            // ...and have the commonality be the account, DeviceName and DeviceId\n// At this point, we have machine-account pairs along with the list of commands run as well as the first/last time the commands were ran\n| order by AccountName asc                                          // Order the final list by AccountName just to make it easier to go through\n| where Timestamp > ago(1d)                                     // Included to restrict the scope for the custom detection page\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for any Service Accounts Performing Remote PowerShell."
                  },
                  {
                    "name": "tactics",
                    "value": "LateralMovement"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject307')._huntingQuerycontentId307),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 307",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject307')._huntingQuerycontentId307)]",
                "contentId": "[variables('huntingQueryObject307')._huntingQuerycontentId307]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject307').huntingQueryVersion307]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject307')._huntingQuerycontentId307]",
        "contentKind": "HuntingQuery",
        "displayName": "Service Accounts Performing Remote PS",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject307')._huntingQuerycontentId307,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject307')._huntingQuerycontentId307,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject308').huntingQueryTemplateSpecName308]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AccountCreation_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject308').huntingQueryVersion308]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_308",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Account Creation",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents\n// Pro-tip: \n// There are many different ways to run a process from a file - e.g. by using full path, env. variables, ~1 annotation, more...\n// So, to find executions of a known filename, better filter on the filename (and possibly on folder path) than on the commandline.\n| where FileName in~ (\"net.exe\", \"net1.exe\") and TimeGenerated > ago(3d)\n// Parse the user name from the commandline.\n// To have case-insensitive parsing use the i flag, to have non-greedy match (e.g. CreatedUser as short as possible), specify U flag:\n// \"kind=regex flags=i\"\n| parse kind=regex flags=iU ProcessCommandLine with * \"user \" CreatedUser \" \" * \"/ad\"\n// Filter rows where user could not be parsed - e.g. because it was not a user command, or the /add commandline switch was not specified.\n| where isnotempty(CreatedUser)\n// Every net.exe executed will run net1.exe with the same commandline.\n// in this where clause we remove such rows, as they duplicate the number of results we have without adding any value.\n| where not (FileName =~ \"net1.exe\" and InitiatingProcessFileName =~ \"net.exe\" and replace(\"net\", \"net1\", InitiatingProcessCommandLine) =~ ProcessCommandLine)\n// If /domain is specified, so the user is created on the domain controller.\n// Also, any prefix that's longer than 1 char will also do the same, e.g. /do, /dom, /doma, ....\n| extend CreatedOnLocalMachine=(ProcessCommandLine !contains \"/do\")\n| where ProcessCommandLine !contains \"/add\" or (CreatedOnLocalMachine == 0 and ProcessCommandLine !contains \"/domain\")\n| summarize MachineCount=dcount(DeviceName) by CreatedUser, CreatedOnLocalMachine, InitiatingProcessFileName, FileName, ProcessCommandLine, InitiatingProcessCommandLine \n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query looks for the creation of user accounts on a machine using the \"net user\" command."
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject308')._huntingQuerycontentId308),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 308",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject308')._huntingQuerycontentId308)]",
                "contentId": "[variables('huntingQueryObject308')._huntingQuerycontentId308]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject308').huntingQueryVersion308]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject308')._huntingQuerycontentId308]",
        "contentKind": "HuntingQuery",
        "displayName": "Account Creation",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject308')._huntingQuerycontentId308,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject308')._huntingQuerycontentId308,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject309').huntingQueryTemplateSpecName309]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "LocalAdminGroupChanges_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject309').huntingQueryVersion309]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_309",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Local Admin Group Changes",
                "category": "Hunting Queries",
                "query": "let ADAZUsers =  IdentityInfo \n| extend DirectoryDomain = AccountDomain \n| extend DirectoryAccount = AccountName \n| extend OnPremSid = AccountSID\n| distinct DirectoryDomain , DirectoryAccount , OnPremSid , AccountCloudSID, AccountUPN, GivenName, Surname;\n // check for any new created or modified local accounts \nlet NewUsers =  DeviceEvents\n| where ActionType contains \"UserAccountCreated\"  // or ActionType contains \"UserAccountModified\"\n| extend lUserAdded = AccountName\n| extend NewUserSID = AccountSid\n| extend laccountdomain = AccountDomain\n| distinct NewUserSID, lUserAdded,laccountdomain;\n// Check for any local group changes and enrich the data with the account name obtained from the previous query\nDeviceEvents \n| where ActionType == 'UserAccountAddedToLocalGroup' \n| extend AddedAccountSID = tostring(parse_json(AdditionalFields).MemberSid)\n| extend LocalGroup = AccountName\n| extend LocalGroupSID = AccountSid\n| extend Actor = trim(@\"[^\\w]+\",InitiatingProcessAccountName)\n// limit to local administrators group\n//  | where LocalGroupSID contains \"S-1-5-32-544\"\n| join kind= leftouter    (NewUsers)\non $left.AddedAccountSID == $right.NewUserSID\n| project TimeGenerated, DeviceName, LocalGroup,LocalGroupSID, AddedAccountSID, lUserAdded , Actor, ActionType , laccountdomain \n| join kind= leftouter        (ADAZUsers)\non $left.AddedAccountSID == $right.OnPremSid\n| extend UserAdded = iff(isnotempty(lUserAdded),strcat(laccountdomain,\"\\\\\", lUserAdded), strcat(DirectoryDomain,\"\\\\\", DirectoryAccount))\n| project TimeGenerated, DeviceName, LocalGroup,LocalGroupSID, AddedAccountSID, UserAdded , Actor, ActionType  \n| where DeviceName !contains Actor \n// Provide details on actors that added users\n// | summarize count()  by Actor \n// | join ADAZUsers\n// on $left.Actor == $right.DirectoryAccount \n// | render piechart \n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This hunting query searches for changes to the local administrators group."
                  },
                  {
                    "name": "tactics",
                    "value": "Persistence"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject309')._huntingQuerycontentId309),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 309",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject309')._huntingQuerycontentId309)]",
                "contentId": "[variables('huntingQueryObject309')._huntingQuerycontentId309]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject309').huntingQueryVersion309]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject309')._huntingQuerycontentId309]",
        "contentKind": "HuntingQuery",
        "displayName": "Local Admin Group Changes",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject309')._huntingQuerycontentId309,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject309')._huntingQuerycontentId309,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject310').huntingQueryTemplateSpecName310]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RareProcessAsService_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject310').huntingQueryVersion310]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_310",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Rare Process as a Service",
                "category": "Hunting Queries",
                "query": "let LookupTime = 30d;\nlet WhiteList = pack_array(\n\"svchost.exe\",\n\"mssense.exe\",\n\"msmpeng.exe\",\n\"searchindexer.exe\",\n\"microsoftedgeupdate.exe\"\n);\nlet GetServices = materialize (\nDeviceProcessEvents\n| where TimeGenerated > ago(LookupTime)\n| where InitiatingProcessParentFileName contains \"services.exe\"\n| where InitiatingProcessFileName !in~(WhiteList)\n| project TimeGenerated, DeviceName, StartedChildProcess = FileName, StartedChildProcessSHA1 = SHA1, StartedChildProcessCmdline = ProcessCommandLine, ServiceProcessSHA1 = InitiatingProcessSHA1, ServiceProcess = InitiatingProcessFileName, ServiceProcessCmdline = InitiatingProcessCommandLine, ServiceProcessID = InitiatingProcessId, ServiceProcessCreationTime = InitiatingProcessCreationTime, ServiceProcessUser = InitiatingProcessAccountName\n);\nGetServices\n| summarize count() by ServiceProcess, DeviceName\n| where count_ < 6 \n| join kind = inner GetServices on ServiceProcess, DeviceName \n| join kind = leftouter ( \nDeviceNetworkEvents \n| where TimeGenerated > ago(LookupTime)\n| where InitiatingProcessParentFileName contains \"services.exe\"\n| where InitiatingProcessFileName !in~(WhiteList)\n| project TimeGenerated, DeviceName, ServiceProcessSHA1 = InitiatingProcessSHA1, ServiceProcess = InitiatingProcessFileName, ServiceProcessCmdline = InitiatingProcessCommandLine, ServiceProcessID = InitiatingProcessId, ServiceProcessCreationTime = InitiatingProcessCreationTime, ServiceProcessUser = InitiatingProcessAccountName, NetworkAction = ActionType, RemoteIP, RemoteUrl\n) on DeviceName, ServiceProcess, ServiceProcessCmdline, ServiceProcessCreationTime, ServiceProcessID, ServiceProcessUser, ServiceProcessSHA1\n| join kind = leftouter (\nDeviceFileEvents\n| where TimeGenerated > ago(LookupTime)\n| where InitiatingProcessParentFileName contains \"services.exe\"\n| where InitiatingProcessFileName !in~(WhiteList)\n| project TimeGenerated, DeviceName, ServiceProcessSHA1 = InitiatingProcessSHA1, ServiceProcess = InitiatingProcessFileName, ServiceProcessCmdline = InitiatingProcessCommandLine, ServiceProcessID = InitiatingProcessId, ServiceProcessCreationTime = InitiatingProcessCreationTime, ServiceProcessUser = InitiatingProcessAccountName, FileAction = ActionType, ModifiedFile = FileName, ModifiedFileSHA1 = SHA1, ModifiedFilePath = FolderPath\n) on DeviceName, ServiceProcess, ServiceProcessCmdline, ServiceProcessCreationTime, ServiceProcessID, ServiceProcessUser, ServiceProcessSHA1\n| join kind = leftouter (\nDeviceImageLoadEvents\n| where TimeGenerated > ago(LookupTime)\n| where InitiatingProcessParentFileName contains \"services.exe\"\n| where InitiatingProcessFileName !in~(WhiteList)\n| project TimeGenerated, DeviceName, ServiceProcessSHA1 = InitiatingProcessSHA1, ServiceProcess = InitiatingProcessFileName, ServiceProcessCmdline = InitiatingProcessCommandLine, ServiceProcessID = InitiatingProcessId, ServiceProcessCreationTime = InitiatingProcessCreationTime, ServiceProcessUser = InitiatingProcessAccountName, LoadedDLL = FileName, LoadedDLLSHA1 = SHA1, LoadedDLLPath = FolderPath\n) on DeviceName, ServiceProcess, ServiceProcessCmdline, ServiceProcessCreationTime, ServiceProcessID, ServiceProcessUser, ServiceProcessSHA1\n| summarize ConnectedAddresses = make_set(RemoteIP, 100000), ConnectedUrls = make_set(RemoteUrl, 100000), FilesModified = make_set(ModifiedFile, 100000),FileModFolderPath = make_set(ModifiedFilePath, 100000),FileModHA1s = make_set(ModifiedFileSHA1, 100000), ChildProcesses = make_set(StartedChildProcess, 100000), ChildCommandlines = make_set(StartedChildProcessCmdline, 100000), DLLsLoaded = make_set(LoadedDLL, 100000), DLLSHA1 = make_set(LoadedDLLSHA1, 100000) by DeviceName, ServiceProcess, ServiceProcessCmdline, ServiceProcessCreationTime, ServiceProcessID, ServiceProcessUser, ServiceProcessSHA1\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query looks for rarely seen processes which are launched as a service."
                  },
                  {
                    "name": "tactics",
                    "value": "Persistence"
                  },
                  {
                    "name": "techniques",
                    "value": "T1543,T1543.003"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject310')._huntingQuerycontentId310),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 310",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject310')._huntingQuerycontentId310)]",
                "contentId": "[variables('huntingQueryObject310')._huntingQuerycontentId310]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject310').huntingQueryVersion310]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject310')._huntingQuerycontentId310]",
        "contentKind": "HuntingQuery",
        "displayName": "Rare Process as a Service",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject310')._huntingQuerycontentId310,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject310')._huntingQuerycontentId310,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject311').huntingQueryTemplateSpecName311]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ScheduledTaskCreation_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject311').huntingQueryVersion311]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_311",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Scheduled Task Creation",
                "category": "Hunting Queries",
                "query": "DeviceEvents \n| where ActionType == \"ScheduledTaskCreated\"\n  and InitiatingProcessAccountSid != \"S-1-5-18\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for any scheduled task creation event."
                  },
                  {
                    "name": "tactics",
                    "value": "Persistence"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject311')._huntingQuerycontentId311),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 311",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject311')._huntingQuerycontentId311)]",
                "contentId": "[variables('huntingQueryObject311')._huntingQuerycontentId311]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject311').huntingQueryVersion311]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject311')._huntingQuerycontentId311]",
        "contentKind": "HuntingQuery",
        "displayName": "Scheduled Task Creation",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject311')._huntingQuerycontentId311,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject311')._huntingQuerycontentId311,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject312').huntingQueryTemplateSpecName312]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SAMNameChange_CVE-2021-42278_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject312').huntingQueryVersion312]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_312",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "SAM Name Change CVE-2021-42278",
                "category": "Hunting Queries",
                "query": "IdentityDirectoryEvents\n| where TimeGenerated > ago(1d)\n| where ActionType == \"SAM Account Name changed\"\n| extend FROMSAM = parse_json(AdditionalFields)['FROM SAM Account Name']\n| extend TOSAM = parse_json(AdditionalFields)['TO SAM Account Name']\n| where (FROMSAM has \"$\" and TOSAM !has \"$\") \n        or TOSAM in (\"DC1\", \"DC2\", \"DC3\", \"DC4\") // DC Names in the org\n| project TimeGenerated, Application, ActionType, TargetDeviceName, FROMSAM, TOSAM, ReportId, AdditionalFields\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "The following query detects possible CVE-2021-42278 exploitation by finding changes of device names in the network using Microsoft Defender for Identity."
                  },
                  {
                    "name": "tactics",
                    "value": "PrivilegeEscalation,Vulnerability"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject312')._huntingQuerycontentId312),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 312",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject312')._huntingQuerycontentId312)]",
                "contentId": "[variables('huntingQueryObject312')._huntingQuerycontentId312]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject312').huntingQueryVersion312]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject312')._huntingQuerycontentId312]",
        "contentKind": "HuntingQuery",
        "displayName": "SAM Name Change CVE-2021-42278",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject312')._huntingQuerycontentId312,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject312')._huntingQuerycontentId312,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject313').huntingQueryTemplateSpecName313]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DataDeletionOnMulipleDrivesUsingCipherExe_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject313').huntingQueryVersion313]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_313",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Deletion of data on multiple drives using cipher exe",
                "category": "Hunting Queries",
                "query": "// Look for cipher.exe deleting data from multiple drives\nDeviceProcessEvents\n| where TimeGenerated > ago(1d)\n| where FileName =~ \"cipher.exe\" \n// cipher.exe /w flag used for deleting data \n| where ProcessCommandLine has \"/w\" \n| summarize CipherCount = dcount(ProcessCommandLine),\nCipherList = make_set(ProcessCommandLine, 1000) by DeviceId, bin(TimeGenerated, 1m) \n// cipher.exe accessing multiple drives in a short timeframe  \n| where CipherCount > 1\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query checks for attempts to delete data on multiple drives using cipher.exe. This activity is typically done by ransomware to prevent recovery of data after encryption."
                  },
                  {
                    "name": "tactics",
                    "value": "Impact"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject313')._huntingQuerycontentId313),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 313",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject313')._huntingQuerycontentId313)]",
                "contentId": "[variables('huntingQueryObject313')._huntingQuerycontentId313]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject313').huntingQueryVersion313]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject313')._huntingQuerycontentId313]",
        "contentKind": "HuntingQuery",
        "displayName": "Deletion of data on multiple drives using cipher exe",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject313')._huntingQuerycontentId313,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject313')._huntingQuerycontentId313,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject314').huntingQueryTemplateSpecName314]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DetectMultipleSignsOfRamsomwareActivity_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject314').huntingQueryVersion314]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_314",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Check for multiple signs of Ransomware Activity",
                "category": "Hunting Queries",
                "query": "// Find attempts to stop processes using taskkill.exe\nlet taskKill = DeviceProcessEvents\n| where TimeGenerated > ago(1d)\n| where FileName =~ \"taskkill.exe\" \n| summarize taskKillCount = dcount(tostring(ProcessCommandLine)), TaskKillList = make_set(ProcessCommandLine) by DeviceId, bin(TimeGenerated, 2m)\n| where taskKillCount > 10;\n// Find attempts to stop processes using net stop\nlet netStop = DeviceProcessEvents\n| where TimeGenerated > ago(1d)\n| where FileName =~ \"net.exe\" and ProcessCommandLine has \"stop\"\n| summarize netStopCount = dcount(tostring(ProcessCommandLine)), NetStopList = make_set(ProcessCommandLine) by DeviceId, bin(TimeGenerated, 2m)\n| where netStopCount > 10;\n// Look for cipher.exe deleting data from multiple drives\nlet cipher = DeviceProcessEvents\n| where TimeGenerated > ago(1d)\n| where FileName =~ \"cipher.exe\" \n// cipher.exe /w flag used for deleting data \n| where ProcessCommandLine has \"/w\" \n| summarize CipherCount = dcount(tostring(ProcessCommandLine)), \nCipherList = make_set(ProcessCommandLine) by DeviceId, bin(TimeGenerated, 1m) \n// cipher.exe accessing multiple drives in a short timeframe \n| where CipherCount > 1;\n// Look for use of wevtutil to clear multiple logs\nlet wevtutilClear = DeviceProcessEvents\n| where TimeGenerated > ago(1d)\n| where ProcessCommandLine has \"WEVTUTIL\" and ProcessCommandLine has \"CL\"\n| summarize LogClearCount = dcount(tostring(ProcessCommandLine)), ClearedLogList = make_set(ProcessCommandLine) by DeviceId, bin(TimeGenerated, 5m)\n| where LogClearCount > 10;\n// Look for sc.exe disabling services\nlet scDisable = DeviceProcessEvents\n| where TimeGenerated > ago(1d)\n| where ProcessCommandLine has \"sc\" and ProcessCommandLine has \"config\" and ProcessCommandLine has \"disabled\"\n| summarize ScDisableCount = dcount(tostring(ProcessCommandLine)), ScDisableList = make_set(ProcessCommandLine) by DeviceId, bin(TimeGenerated, 5m)\n| where ScDisableCount > 10;\n// Main query for counting and aggregating evidence\nDeviceProcessEvents\n| where TimeGenerated > ago(1d)\n| where FileName =~ \"vssadmin.exe\" and ProcessCommandLine has_any(\"list shadows\", \"delete shadows\")\nor FileName =~ \"fsutil.exe\" and ProcessCommandLine has \"usn\" and ProcessCommandLine has \"deletejournal\"\nor ProcessCommandLine has(\"bcdedit\") and ProcessCommandLine has_any(\"recoveryenabled no\", \"bootstatuspolicy ignoreallfailures\")\nor ProcessCommandLine has \"wbadmin\" and ProcessCommandLine has \"delete\" and ProcessCommandLine has_any(\"backup\", \"catalog\", \"systemstatebackup\")\nor (ProcessCommandLine has \"wevtutil\" and ProcessCommandLine has \"cl\") \nor (ProcessCommandLine has \"wmic\" and ProcessCommandLine has \"shadowcopy delete\")\nor (ProcessCommandLine has \"sc\" and ProcessCommandLine has \"config\" and ProcessCommandLine has \"disabled\")\n| extend Bcdedit = iff(ProcessCommandLine has \"bcdedit\" and ProcessCommandLine has_any(\"recoveryenabled no\", \"bootstatuspolicy ignoreallfailures\"), 1, 0)\n| extend ShadowCopyDelete = iff (ProcessCommandLine has \"shadowcopy delete\", 1, 0)\n| extend VssAdminShadows = iff(ProcessCommandLine has \"vssadmin\" and ProcessCommandLine has_any(\"list shadows\", \"delete shadows\"), 1, 0)\n| extend Wbadmin = iff(ProcessCommandLine has \"wbadmin\" and ProcessCommandLine has \"delete\" and ProcessCommandLine has_any(\"backup\", \"catalog\", \"systemstatebackup\"), 1,0)\n| extend Fsutil = iff(ProcessCommandLine has \"fsutil\" and ProcessCommandLine has \"usn\" and ProcessCommandLine has \"deletejournal\", 1, 0)\n| summarize FirstActivity = min(TimeGenerated), ReportId = any(ReportId), Commands = make_set(ProcessCommandLine) by DeviceId, Fsutil, Wbadmin, ShadowCopyDelete, Bcdedit, VssAdminShadows, bin(TimeGenerated, 6h)\n// Joining extra evidence\n| join kind=leftouter (wevtutilClear) on $left.DeviceId == $right.DeviceId\n| join kind=leftouter (cipher) on $left.DeviceId == $right.DeviceId\n| join kind=leftouter (netStop) on $left.DeviceId == $right.DeviceId\n| join kind=leftouter (taskKill) on $left.DeviceId == $right.DeviceId\n| join kind=leftouter (scDisable) on $left.DeviceId == $right.DeviceId\n| extend WevtutilUse = iff(LogClearCount > 10, 1, 0)\n| extend CipherUse = iff(CipherCount > 1, 1, 0)\n| extend NetStopUse = iff(netStopCount > 10, 1, 0)\n| extend TaskkillUse = iff(taskKillCount > 10, 1, 0)\n| extend ScDisableUse = iff(ScDisableCount > 10, 1, 0)\n// Adding up all evidence\n| mv-expand CommandList = NetStopList, TaskKillList, ClearedLogList, CipherList, Commands, ScDisableList\n// Format results\n| summarize BcdEdit = iff(make_set(Bcdedit) contains \"1\" , 1, 0), NetStop10PlusCommands = iff(make_set(NetStopUse) contains \"1\", 1, 0), Wevtutil10PlusLogsCleared = iff(make_set(WevtutilUse) contains \"1\", 1, 0),\nCipherMultipleDrives = iff(make_set(CipherUse) contains \"1\", 1, 0), Fsutil = iff(make_set(Fsutil) contains \"1\", 1, 0), ShadowCopyDelete = iff(make_set(ShadowCopyDelete) contains \"1\", 1, 0),\nWbadmin = iff(make_set(Wbadmin) contains \"1\", 1, 0), TaskKill10PlusCommand = iff(make_set(TaskkillUse) contains \"1\", 1, 0), VssAdminShadow = iff(make_set(VssAdminShadows) contains \"1\", 1, 0), \nScDisable = iff(make_set(ScDisableUse) contains \"1\", 1, 0), TotalEvidenceCount = dcount(tostring(CommandList)), EvidenceList = make_set(Commands), StartofBehavior = min(FirstActivity) by DeviceId, bin(TimeGenerated, 1d)\n| extend UniqueEvidenceCount = BcdEdit + NetStop10PlusCommands + Wevtutil10PlusLogsCleared + CipherMultipleDrives + Wbadmin + Fsutil + TaskKill10PlusCommand + VssAdminShadow + ScDisable + ShadowCopyDelete\n| where UniqueEvidenceCount > 2\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query checks for multiple signs of ransomware activity to identify affected devices."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution,Impact,Exfiltration"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject314')._huntingQuerycontentId314),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 314",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject314')._huntingQuerycontentId314)]",
                "contentId": "[variables('huntingQueryObject314')._huntingQuerycontentId314]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject314').huntingQueryVersion314]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject314')._huntingQuerycontentId314]",
        "contentKind": "HuntingQuery",
        "displayName": "Check for multiple signs of Ransomware Activity",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject314')._huntingQuerycontentId314,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject314')._huntingQuerycontentId314,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject315').huntingQueryTemplateSpecName315]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DisableSecurityServiceViaRegistry_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject315').huntingQueryVersion315]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_315",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Disabling Services via Registry",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents\n| where InitiatingProcessCommandLine has_all(@'\"reg\"', 'add', @'\"HKLM\\SOFTWARE\\Policies\\', '/v','/t', 'REG_DWORD', '/d', '/f')\n  and InitiatingProcessCommandLine has_any('DisableRealtimeMonitoring', 'UseTPMKey', 'UseTPMKeyPIN', 'UseAdvancedStartup', \n  'EnableBDEWithNoTPM', 'RecoveryKeyMessageSource')\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for processes modifying the registry to disable security features."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject315')._huntingQuerycontentId315),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 315",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject315')._huntingQuerycontentId315)]",
                "contentId": "[variables('huntingQueryObject315')._huntingQuerycontentId315]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject315').huntingQueryVersion315]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject315')._huntingQuerycontentId315]",
        "contentKind": "HuntingQuery",
        "displayName": "Disabling Services via Registry",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject315')._huntingQuerycontentId315,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject315')._huntingQuerycontentId315,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject316').huntingQueryTemplateSpecName316]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DomainDiscoveryWMICwithDLLHostExe_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject316').huntingQueryVersion316]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_316",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "DLLHost.exe WMIC domain discovery",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents \n| where InitiatingProcessFileName =~ \"dllhost.exe\" and InitiatingProcessCommandLine == \"dllhost.exe\" \n| where ProcessCommandLine has \"wmic computersystem get domain\"\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query checks for dllhost.exe calling WMIC to discover additional hosts and associated domain."
                  },
                  {
                    "name": "tactics",
                    "value": "Reconnaissance"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject316')._huntingQuerycontentId316),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 316",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject316')._huntingQuerycontentId316)]",
                "contentId": "[variables('huntingQueryObject316')._huntingQuerycontentId316]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject316').huntingQueryVersion316]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject316')._huntingQuerycontentId316]",
        "contentKind": "HuntingQuery",
        "displayName": "DLLHost.exe WMIC domain discovery",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject316')._huntingQuerycontentId316,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject316')._huntingQuerycontentId316,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject317').huntingQueryTemplateSpecName317]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MDEExclusionUsingPowerShell_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject317').huntingQueryVersion317]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_317",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "PowerShell adding exclusion path for Microsoft Defender of ProgramData",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents \n| where FileName =~ \"powershell.exe\" and ProcessCommandLine has_all(\"try\", \"Add-MpPreference\", \"-ExclusionPath\", \"ProgramData\", \"catch\")\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Identify PowerShell creating an exclusion path of ProgramData directory for Microsoft Defender to not monitor."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject317')._huntingQuerycontentId317),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 317",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject317')._huntingQuerycontentId317)]",
                "contentId": "[variables('huntingQueryObject317')._huntingQuerycontentId317]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject317').huntingQueryVersion317]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject317')._huntingQuerycontentId317]",
        "contentKind": "HuntingQuery",
        "displayName": "PowerShell adding exclusion path for Microsoft Defender of ProgramData",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject317')._huntingQuerycontentId317,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject317')._huntingQuerycontentId317,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject318').huntingQueryTemplateSpecName318]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "IcedIdSuspiciousImageLoad_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject318').huntingQueryVersion318]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_318",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Suspicious Image Load related to IcedId",
                "category": "Hunting Queries",
                "query": "DeviceImageLoadEvents \n| where InitiatingProcessFileName in~ ('rundll32.exe','regsvr32.exe') \n| where FileName endswith '.txt' or FileName endswith '.pdf'\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for suspicious load image events by rundll32.exe or regsvr32.exe, a behavior associated with IcedId, which can lead to IcedId ransomware."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution,DefenseEvasion"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject318')._huntingQuerycontentId318),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 318",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject318')._huntingQuerycontentId318)]",
                "contentId": "[variables('huntingQueryObject318')._huntingQuerycontentId318]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject318').huntingQueryVersion318]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject318')._huntingQuerycontentId318]",
        "contentKind": "HuntingQuery",
        "displayName": "Suspicious Image Load related to IcedId",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject318')._huntingQuerycontentId318,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject318')._huntingQuerycontentId318,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject319').huntingQueryTemplateSpecName319]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "LaZagneCredTheft_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject319').huntingQueryVersion319]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_319",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "LaZagne Credential Theft",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents \n| where FileName =~ 'reg.exe'\n| where ProcessCommandLine has_all('save','hklm','sam')\n| project DeviceId, TimeGenerated, InitiatingProcessId, InitiatingProcessFileName, ProcessId, FileName, ProcessCommandLine\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query can be used to locate processes executing credential theft activity, often LaZagne in ransomware compromises."
                  },
                  {
                    "name": "tactics",
                    "value": "CredentialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject319')._huntingQuerycontentId319),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 319",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject319')._huntingQuerycontentId319)]",
                "contentId": "[variables('huntingQueryObject319')._huntingQuerycontentId319]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject319').huntingQueryVersion319]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject319')._huntingQuerycontentId319]",
        "contentKind": "HuntingQuery",
        "displayName": "LaZagne Credential Theft",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject319')._huntingQuerycontentId319,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject319')._huntingQuerycontentId319,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject320').huntingQueryTemplateSpecName320]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "LogDeletionUsingWevtutil_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject320').huntingQueryVersion320]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_320",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Clearing of forensic evidence from event logs using wevtutil",
                "category": "Hunting Queries",
                "query": "// Look for use of wevtutil to clear multiple logs\nDeviceProcessEvents\n| where TimeGenerated > ago(1d)\n| where ProcessCommandLine has \"WEVTUTIL\" and ProcessCommandLine has \"CL\"\n| summarize LogClearCount = dcount(tostring(ProcessCommandLine)), ClearedLogList = make_set(ProcessCommandLine, 100000) by DeviceId, bin(TimeGenerated, 5m)\n| where LogClearCount > 10\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query checks for attempts to clear at least 10 log entries from event logs using wevtutil."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject320')._huntingQuerycontentId320),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 320",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject320')._huntingQuerycontentId320)]",
                "contentId": "[variables('huntingQueryObject320')._huntingQuerycontentId320]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject320').huntingQueryVersion320]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject320')._huntingQuerycontentId320]",
        "contentKind": "HuntingQuery",
        "displayName": "Clearing of forensic evidence from event logs using wevtutil",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject320')._huntingQuerycontentId320,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject320')._huntingQuerycontentId320,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject321').huntingQueryTemplateSpecName321]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MultiProcessKillWithTaskKill_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject321').huntingQueryVersion321]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_321",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Stopping multiple processes using taskkill",
                "category": "Hunting Queries",
                "query": "// Find attempts to stop processes using taskkill.exe\nDeviceProcessEvents\n| where TimeGenerated > ago(1d)\n| where FileName =~ \"taskkill.exe\" \n| summarize taskKillCount = dcount(ProcessCommandLine), TaskKillList = make_set(ProcessCommandLine) by DeviceId, bin(TimeGenerated, 2m)\n| where taskKillCount > 10\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query checks for attempts to stop at least 10 separate processes using the taskkill.exe utility."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject321')._huntingQuerycontentId321),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 321",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject321')._huntingQuerycontentId321)]",
                "contentId": "[variables('huntingQueryObject321')._huntingQuerycontentId321]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject321').huntingQueryVersion321]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject321')._huntingQuerycontentId321]",
        "contentKind": "HuntingQuery",
        "displayName": "Stopping multiple processes using taskkill",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject321')._huntingQuerycontentId321,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject321')._huntingQuerycontentId321,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject322').huntingQueryTemplateSpecName322]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PotentialCobaltStrikeRansomwareActivity_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject322').huntingQueryVersion322]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_322",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Potential Ransomware activity related to Cobalt Strike",
                "category": "Hunting Queries",
                "query": "// Look for sc.exe disabling services\nAlertInfo \n// Attempts to clear security event logs. \n| where Title in(\"Event log was cleared\", \n// List alerts flagging attempts to delete backup files. \n\"File backups were deleted\", \n// Potential Cobalt Strike activity - Note that other threat activity can also \n// trigger alerts for suspicious decoded content \n\"Suspicious decoded content\", \n// Cobalt Strike activity \n\"\\'Atosev\\' malware was detected\", \n\"\\'Ploty\\' malware was detected\", \n\"\\'Bynoco\\' malware was detected\",\n\"\\'Cobaltstrike\\' malware was detected\",\n\"Echo command over pipe on localhost\",\n\"Known attack framework activity was observed\",\n\"An active \\'Cobaltstrike\\' malware was detected\",\n\"Suspicious \\'CobaltStrike\\' behavior was prevented\",\n\"Suspicious process launch by Rundll32.exe\") \n| extend AlertTime = TimeGenerated | distinct AlertTime, AlertId, Title \n| join AlertEvidence on $left.AlertId == $right.AlertId\n| summarize by DeviceId, AlertTime, Title, AlertId\n// Get device IDs\n| join DeviceLogonEvents on $left.DeviceId == $right.DeviceId \n// Creating 10 day Window surrounding alert activity \n| where TimeGenerated < AlertTime +5d and TimeGenerated > AlertTime - 5d // Projecting specific columns \n| project Title, DeviceName, DeviceId, TimeGenerated, LogonType, AccountDomain, AccountName, AccountSid, AlertTime, AlertId, RemoteIP, RemoteDeviceName\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for alerts related to suspected ransomware and Cobalt Strike activity, a tool used in numerous ransomware campaigns."
                  },
                  {
                    "name": "tactics",
                    "value": "Execution,Persistence"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject322')._huntingQuerycontentId322),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 322",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject322')._huntingQuerycontentId322)]",
                "contentId": "[variables('huntingQueryObject322')._huntingQuerycontentId322]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject322').huntingQueryVersion322]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject322')._huntingQuerycontentId322]",
        "contentKind": "HuntingQuery",
        "displayName": "Potential Ransomware activity related to Cobalt Strike",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject322')._huntingQuerycontentId322,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject322')._huntingQuerycontentId322,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject323').huntingQueryTemplateSpecName323]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "QakbotDiscoveryActivities_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject323').huntingQueryVersion323]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_323",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Qakbot Discovery Activies",
                "category": "Hunting Queries",
                "query": "DeviceProcessEvents \n| where InitiatingProcessFileName in~('mobsync.exe','explorer.exe')\n| where (FileName =~ 'net.exe' and InitiatingProcessCommandLine has_all('view','/all'))\n     or (FileName =~ 'whoami.exe' and InitiatingProcessCommandLine has '/all')\n     or (FileName =~ 'nslookup.exe' and InitiatingProcessCommandLine has_all('querytype=ALL','timeout=10'))\n     or (FileName =~ 'netstat.exe' and InitiatingProcessCommandLine has '-nao')\n     or (FileName =~ 'arp.exe' and InitiatingProcessCommandLine has '-a')\n     or (FileName =~ 'ping.exe' and InitiatingProcessCommandLine has '-t' and InitiatingProcessCommandLine endswith '127.0.0.1')\n| summarize DiscoveryCommands = dcount(InitiatingProcessCommandLine), make_set(InitiatingProcessFileName), make_set(FileName), make_set(InitiatingProcessCommandLine) by DeviceId, bin(TimeGenerated, 5m)   \n| where DiscoveryCommands >= 3\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query searches for injected processes launching discovery activity. Qakbot has been observed leading to ransomware in numerous instances."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion,Discovery,Execution"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject323')._huntingQuerycontentId323),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 323",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject323')._huntingQuerycontentId323)]",
                "contentId": "[variables('huntingQueryObject323')._huntingQuerycontentId323]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject323').huntingQueryVersion323]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject323')._huntingQuerycontentId323]",
        "contentKind": "HuntingQuery",
        "displayName": "Qakbot Discovery Activies",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject323')._huntingQuerycontentId323,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject323')._huntingQuerycontentId323,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject324').huntingQueryTemplateSpecName324]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ShadowCopyDeletion_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject324').huntingQueryVersion324]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_324",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Shadow Copy Deletions",
                "category": "Hunting Queries",
                "query": "let CommonRansomwareExecutionCommands = dynamic([@'vssadmin.exe delete shadows /all /quiet', \n@'wmic.exe shadowcopy delete', @'wbadmin delete catalog -quiet', \n@'Get-WmiObject Win32_Shadowcopy | ForEach-Object {$_.Delete();}',\n@'del /s /f /q c:\\*.VHD c:\\*.bac c:\\*.bak c:\\*.wbcat c:\\*.bkf c:\\Backup*.* c:\\backup*.* c:\\*.set c:\\*.win c:\\*.dsk', \n@'wbadmin delete systemstatebackup -keepVersions:0', \n@'schtasks.exe /Change /TN \"\\Microsoft\\Windows\\SystemRestore\\SR\" /disable', \n@'schtasks.exe /Change /TN \"\\Microsoft\\Windows\\SystemRestore\\SR\" /enable >nul 2>&1', \n@'reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\SystemRestore\" /v \"DisableConfig\" /t \"REG_DWORD\" /d \"1\" /f', \n@'reg add \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\SystemRestore\" /v \"DisableSR\" /t \"REG_DWORD\" /d \"1\" /f', \n@'reg add \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore\" /v \"DisableConfig\" /t \"REG_DWORD\" /d \"1\" /f', \n@'reg add \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore\" /v \"DisableSR\" /t \"REG_DWORD\" /d \"1\" /f', \n@'reg delete \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\SystemRestore\" /v \"DisableConfig\" /f >nul 2>&1', \n@'reg delete \"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\SystemRestore\" /v \"DisableSR\" /f >nul 2>&1', \n@'reg delete \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore\" /v \"DisableConfig\" /f >nul 2>&1', \n@'reg delete \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore\" /v \"DisableSR\" /f >nul 2>&1']);\nDeviceProcessEvents\n| where ProcessCommandLine has_any (CommonRansomwareExecutionCommands)\n| project-reorder TimeGenerated, ProcessCommandLine, DeviceName, AccountName\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This rule detects when Shadow Copies are being deleted. This is a know actions that is performed by threat actors."
                  },
                  {
                    "name": "tactics",
                    "value": "Impact"
                  },
                  {
                    "name": "techniques",
                    "value": "T1490"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject324')._huntingQuerycontentId324),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 324",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject324')._huntingQuerycontentId324)]",
                "contentId": "[variables('huntingQueryObject324')._huntingQuerycontentId324]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject324').huntingQueryVersion324]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject324')._huntingQuerycontentId324]",
        "contentKind": "HuntingQuery",
        "displayName": "Shadow Copy Deletions",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject324')._huntingQuerycontentId324,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject324')._huntingQuerycontentId324,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject325').huntingQueryTemplateSpecName325]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "TurningOffServicesWithSCCommad_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject325').huntingQueryVersion325]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_325",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Turning off services using sc exe",
                "category": "Hunting Queries",
                "query": "// Look for sc.exe disabling services\nDeviceProcessEvents\n| where TimeGenerated > ago(1d)\n| where ProcessCommandLine has \"sc\" and ProcessCommandLine has \"config\" and ProcessCommandLine has \"disabled\"\n| summarize ScDisableCount = dcount(ProcessCommandLine), ScDisableList = make_set(ProcessCommandLine) by DeviceId, bin(TimeGenerated, 5m)\n| where ScDisableCount > 10\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query checks for attempts to turn off at least 10 existing services using sc.exe."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject325')._huntingQuerycontentId325),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 325",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject325')._huntingQuerycontentId325)]",
                "contentId": "[variables('huntingQueryObject325')._huntingQuerycontentId325]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject325').huntingQueryVersion325]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject325')._huntingQuerycontentId325]",
        "contentKind": "HuntingQuery",
        "displayName": "Turning off services using sc exe",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject325')._huntingQuerycontentId325,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject325')._huntingQuerycontentId325,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject326').huntingQueryTemplateSpecName326]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Detect_CISA_Alert_AA22-117A2021_Top_Routinely_Exploited_Vulnerabilities_HuntingQueries Hunting Query with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject326').huntingQueryVersion326]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Microsoft_Defender_XDR_Hunting_Query_326",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Detect CISA Alert (AA22-117A) 2021 Top Routinely Exploited Vulnerabilities",
                "category": "Hunting Queries",
                "query": "// CISA Alert (AA22-117A) 2021 Top Routinely Exploited Vulnerabilities https://www.cisa.gov/uscert/ncas/alerts/aa22-117a\nlet CISAAlertAA22117A= dynamic(\n[\n\"CVE-2021-44228\", // Log4Shell - Apache Log4j - Remote code execution (RCE)\n\"CVE-2021-40539\", // Zoho ManageEngine AD SelfService Plus - RCE\n\"CVE-2021-34523\", // ProxyShell - Microsoft Exchange Server - Elevation of privilege\n\"CVE-2021-34473\", // ProxyShell - Microsoft Exchange Server - RCE\n\"CVE-2021-31207\", // ProxyShell - Microsoft Exchange Server - Security feature bypass\n\"CVE-2021-27065\", // ProxyLogon - Microsoft Exchange Server - RCE\n\"CVE-2021-26858\", // ProxyLogon - Microsoft Exchange Server - RCE\n\"CVE-2021-26857\", // ProxyLogon - Microsoft Exchange Server - RCE\n\"CVE-2021-26855\", // ProxyLogon - Microsoft Exchange Server - RCE\n\"CVE-2021-26084\", // Atlassian Confluence Server and Data Center - Arbitrary code execution\n\"CVE-2021-21972\", // VMware vSphere Client - RCE \n\"CVE-2020-1472\", // ZeroLogon - Microsoft Netlogon Remote Protocol (MS-NRPC) - Elevation of privilege\n\"CVE-2020-0688\", // Microsoft Exchange Server - RCE\n\"CVE-2019-11510\", // Pulse Secure Pulse Connect Secure - Arbitrary file reading\n\"CVE-2018-13379\", // Fortinet FortiOS and FortiProxy - Path traversal\n\"CVE-2021-42237\", // Sitecore XP - RCE\n\"CVE-2021-35464\", // ForgeRock OpenAM server - RCE\n\"CVE-2021-27104\", // Accellion FTA - OS command execution\n\"CVE-2021-27103\", // Accellion FTA - Server-side request forgery\n\"CVE-2021-27102\", // Accellion FTA - OS command execution\n\"CVE-2021-27101\", // Accellion FTA - SQL injection\n\"CVE-2021-21985\", // SQL injection - RCE\n\"CVE-2021-20038\", // SonicWall Secure Mobile Access (SMA) - RCE\n\"CVE-2021-40444\", // Microsoft MSHTML - RCE\n\"CVE-2021-34527\", // Microsoft Windows Print Spooler - RCE\n\"CVE-2021-3156\", // Suco - Microsoft Windows Print Spooler\n\"CVE-2021-27852\", // Checkbox Survey - Remote arbitrary code execution\n\"CVE-2021-22893\", // Pulse Secure Pulse Connect Secure - Remote arbitrary code execution\n\"CVE-2021-20016\", // SonicWall SSLVPN SMA100 - Improper SQL command neutralization, allowing for credential access\n\"CVE-2021-1675\", // Windows Print Spooler - RCE\n\"CVE-2020-2509\", // QNAP QTS and QuTS hero - Remote arbitrary code execution\n\"CVE-2019-19781\", // Citrix Application Delivery Controller (ADC) and Gateway - Arbitrary code execution\n\"CVE-2019-18935\", // Progress Telerik UI for ASP.NET AJAX - Code execution\n\"CVE-2018-0171\", // Cisco IOS Software and IOS XE Software - Remote arbitrary code execution\n\"CVE-2017-11882\", // Microsoft Office - RCE\n\"CVE-2017-0199\" // Microsoft Office - RCE\n ]\n);\nDeviceTvmSoftwareVulnerabilitiesKB\n| where CveId in(CISAAlertAA22117A)\n| join DeviceTvmSoftwareVulnerabilities on CveId\n| project-away CveId1, VulnerabilitySeverityLevel1, AffectedSoftware\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This advanced hunting query detects CISA Alert (AA22-117A) 2021 Top Routinely Exploited Vulnerabilities https://www.cisa.gov/uscert/ncas/alerts/aa22-117a"
                  },
                  {
                    "name": "tactics",
                    "value": "Execution"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject326')._huntingQuerycontentId326),'/'))))]",
              "properties": {
                "description": "Microsoft Defender XDR Hunting Query 326",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject326')._huntingQuerycontentId326)]",
                "contentId": "[variables('huntingQueryObject326')._huntingQuerycontentId326]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject326').huntingQueryVersion326]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject326')._huntingQuerycontentId326]",
        "contentKind": "HuntingQuery",
        "displayName": "Detect CISA Alert (AA22-117A) 2021 Top Routinely Exploited Vulnerabilities",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject326')._huntingQuerycontentId326,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject326')._huntingQuerycontentId326,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MicrosoftDefenderForOffice365detectionsandinsights Workbook with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Gain extensive insight into your organization's Microsoft Defender for Office 365 Detections by analyzing and correlating events. \nYou can track various detections and insights over time including: metrics for phish, spam, malware, URL and URL click detection details, post delivery detections, user and admin submissions, system overrides and actions taken by security administrators."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"\\n<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#ffffff;\\\">\\n  <tr style=\\\"border:none;\\\">\\n    <td style=\\\"text-align:left; border:none; font-size:28px; font-weight:bold;width:1%;background-color:#ffffff;\\\">\\n      Microsoft Defender for Office 365 Detections and Insights\\n    </td>\\n    <td style=\\\"text-align:right; border:none;width:1%;background-color:#ffffff;\\\">\\n      <img height=\\\"40\\\" src=\\\"https://img-prod-cms-rt-microsoft-com.akamaized.net/cms/api/am/imageFileData/RE1Mu3b\\\">\\n\\t</td>\\n  </tr>\\n</table>\\n<table>\\n<tr>\\n<td style=\\\"text-align:left; border:none; font-size:16px; width:10%;background-color:#ffffff;\\\">This workbook template provides an example of how to visualise and gain insights into Microsoft Defender for Office 365.<br>It allows you to visualise Microsoft Defender for Office 365 (MDO) data based on your organisation needs.<br> The workbook uses data from hunting tables streamed from <a href=\\\"https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-schema-tables\\\">Microsoft Defender XDR</a> via the Microsoft Sentinel Connector. Keep the data in the <a href=\\\"https://learn.microsoft.com/en-us/azure/sentinel/configure-data-retention\\\">Log Analytics workspace</a> for as long as necessary to get insights over an extended period, based on your organisation's needs.</td>\\n</tr>\\n</table>\\n\\n> \\n**Please note:** *The workbook has a total of 13 tabs. If not all tabs are visible, you can access the remaining tabs using the \\\"...\\\" located at the end of the tab list on the right side.*\\n> \\n\\n---\\n\\n\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"6e647d99-1a32-4bca-8147-403b5d37d773\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"value\":\"\",\"typeSettings\":{\"includeAll\":false,\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"timeContextFromParameter\":\"TimeRange\"},{\"id\":\"d57bcdf5-aec7-4f86-904c-67171864919b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"isRequired\":true,\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.operationalinsights/workspaces\":true},\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"value\":\"\"},{\"id\":\"2e238f92-709c-410b-93e0-60eab6150a75\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"isGlobal\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":7776000000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"3d26d949-bba8-486c-9af7-2b85bd5c8ab0\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Detection Dashboard\",\"subTarget\":\"1\",\"style\":\"link\"},{\"id\":\"a5f95467-84c1-4d8b-858c-7819339af748\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Email - Malware Detections\",\"subTarget\":\"2\",\"style\":\"link\"},{\"id\":\"b6c93de8-16d9-4c90-999b-837935de5645\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Email - Phish Detections\",\"subTarget\":\"3\",\"style\":\"link\"},{\"id\":\"df2c53b4-b6ed-4151-95fb-b3f08b849b84\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Email - Spam Detections\",\"subTarget\":\"4\",\"style\":\"link\"},{\"id\":\"9df30067-3266-48a8-b9e3-d65952098d46\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"URL Detections and Clicks\",\"subTarget\":\"5\",\"style\":\"link\"},{\"id\":\"b4be0ac3-3f48-44a8-b4b6-b46e17c710cd\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Email - Top Users/Senders/Forwarders\",\"subTarget\":\"6\",\"style\":\"link\"},{\"id\":\"e1d34091-7b3c-4e2d-a032-8be82a989313\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Email - Detection Overrides\",\"subTarget\":\"7\",\"style\":\"link\"},{\"id\":\"08c43a4f-f502-4813-9b8d-3f6b0b62b2fd\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"False Negative(FN) Submissions\",\"subTarget\":\"8\",\"style\":\"link\"},{\"id\":\"638d931f-f319-4914-b72d-8d68e914c7d4\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"False Positive(FP) Submissions\",\"subTarget\":\"10\",\"style\":\"link\"},{\"id\":\"ee01f95a-c5f7-4864-82e8-54a164741ba2\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"File - Malware Detections (SharePoint, Teams and OneDrive)\",\"subTarget\":\"9\",\"style\":\"link\"},{\"id\":\"a1e6264d-8f85-4a94-9ffd-eee36c04a0d5\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Post Delivery Detections\",\"subTarget\":\"11\",\"style\":\"link\"},{\"id\":\"85dd7ba0-d15f-4fc4-90ac-a4ecf734fb52\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Quarantine Insights\",\"subTarget\":\"12\",\"style\":\"link\"},{\"id\":\"b2920bee-c32a-4fdd-9d32-b004db2f3ac8\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Security Operations Center (SOC) Insights\",\"subTarget\":\"13\",\"style\":\"link\"}]},\"name\":\"links - 14\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:28px; font-weight:bold;color:white;width:1%\\\">Threat Landscape\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\n**Microsoft Defender for Office 365** is a comprehensive security solution designed to protect organizations from **advanced threats targeting their email and collaboration** tools. It leverages a multi-layered approach to safeguard against phishing, malware, business email compromise (BEC), and other sophisticated attacks. <br>\\r\\nThis summary provides an overview of how Microsoft Defender for Office 365 addresses the **evolving threat landscape** and **implements robust protections**. <br>\\r\\n\"},\"name\":\"text - 13\",\"styleSettings\":{\"margin\":\"0\",\"padding\":\"0\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query shows the number behind the effectiveness of phish and malware false positives including post delivery events but without edge data detections.\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\n\\r\\n// Get all mailflow detected as clean at time of delivery \\r\\nlet EmailEventsClean = materialize( \\r\\n    EmailEvents \\r\\n    | where Timestamp between (toscalar(minTime) .. toscalar(maxTime)) and EmailDirection == \\\"Inbound\\\" \\r\\n    | where ThreatTypes !contains \\\"Phish\\\" and ThreatTypes !contains \\\"Malware\\\" // UN-comment this when using sentinel or another streaming SIEM (line 10).\\r\\n    // this alteration is due to the threat types being updated directly within advanced hunting.\\r\\n    //| where DeliveryLocation != \\\"Quarantine\\\" // comment out this line if you uncomment line 10, as it's only required for advanced hunting.\\r\\n    | project NetworkMessageId,ThreatTypes \\r\\n); \\r\\n// Get all mailflow detected as phish or malware at time of delivery \\r\\nlet EmailEventsThreats = materialize( \\r\\n    EmailEvents \\r\\n    | where Timestamp between (toscalar(minTime) .. toscalar(maxTime)) and EmailDirection == \\\"Inbound\\\" \\r\\n    | where ThreatTypes contains \\\"Phish\\\" or ThreatTypes contains \\\"Malware\\\" \\r\\n    | extend MDO_detection = parse_json(DetectionMethods) \\r\\n    | extend FirstDetection = iif(isempty(MDO_detection), \\\"Clean\\\", tostring(bag_keys(MDO_detection)[0])) \\r\\n    | extend FirstSubcategory = iif(FirstDetection != \\\"Clean\\\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \\\": \\\", tostring(MDO_detection[FirstDetection][0])), \\\"No Detection (clean)\\\") \\r\\n    | project NetworkMessageId,FirstDetection,FirstSubcategory,MDO_detection,ThreatTypes \\r\\n); \\r\\n// Get all post delivery ZAP / Redelivery events, and arg_max them to ensure we have the latest verdict to work with for each \\r\\nlet EmailPostDeliveryFiltered = materialize( \\r\\n    EmailPostDeliveryEvents \\r\\n    | where Timestamp between (toscalar(minTime) .. datetime_add('day', 7, toscalar(maxTime))) \\r\\n    | where ActionType in (\\\"Malware ZAP\\\",\\\"Phish ZAP\\\",\\\"Redelivery\\\") \\r\\n    | extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n    | summarize arg_max(Timestamp, *) by Key \\r\\n    | project Action,ActionType,ActionResult,ThreatTypes,NetworkMessageId \\r\\n); \\r\\n// Optional - get all admin submissions for malware or phish, so we can also count these in the miss bucket. \\r\\nlet CloudAppEventsFiltered = materialize( \\r\\n    CloudAppEvents \\r\\n    | where Timestamp between (toscalar(minTime) .. datetime_add('day', 7, toscalar(maxTime)))\\r\\n    | where ActionType == \\\"AdminSubmissionSubmitted\\\" \\r\\n    | extend SubmissionType = tostring(parse_json(RawEventData).SubmissionType) \\r\\n    | extend NetworkMessageId = tostring(parse_json(RawEventData).ObjectId) \\r\\n    | where SubmissionType in (\\\"1\\\", \\\"2\\\") \\r\\n    | project SubmissionType,NetworkMessageId \\r\\n); \\r\\n// get the number of threats caught in mailflow \\r\\nlet Mal_Phish_Mailflow = toscalar( \\r\\n    EmailEventsThreats \\r\\n    | summarize count() \\r\\n); \\r\\n// get the number of threats caught in mailflow which turned out to be false positives (FPs) so we can correct the calculation \\r\\nlet FP_ZAP = toscalar( \\r\\n    EmailPostDeliveryFiltered \\r\\n    | where ThreatTypes !contains \\\"Phish\\\" and ThreatTypes !contains \\\"Malware\\\" and ActionType == \\\"Redelivery\\\" \\r\\n    | join kind=leftsemi (EmailEventsThreats) on NetworkMessageId \\r\\n    | summarize count() \\r\\n); \\r\\n// get the number of threats successfully cleaned up post delivery, ignoring where administrative policy stopped action \\r\\nlet FN_ZAP_Successful = toscalar( \\r\\n    EmailPostDeliveryFiltered \\r\\n    | where ActionType in (\\\"Malware ZAP\\\",\\\"Phish ZAP\\\") and ActionResult in (\\\"Success\\\",\\\"AdminPolicy\\\") \\r\\n    | join kind=leftsemi (EmailEventsClean) on NetworkMessageId \\r\\n    | summarize count() \\r\\n); \\r\\n// get the number of threats unsuccessfully cleaned up post delivery. \\r\\nlet FN_ZAP_Unsuccessful = toscalar( \\r\\n    EmailPostDeliveryFiltered \\r\\n    | where ActionType in (\\\"Malware ZAP\\\",\\\"Phish ZAP\\\") and ActionResult !in (\\\"Success\\\",\\\"AdminPolicy\\\") \\r\\n    | join kind=leftsemi (EmailEventsClean) on NetworkMessageId \\r\\n    | summarize count() \\r\\n); \\r\\n// join the administrative submissions to clean mailflow to find the additional miss \\r\\nlet FN_Admin_Submissions = toscalar( \\r\\n    CloudAppEventsFiltered \\r\\n    | join kind=rightsemi (EmailEventsClean) on NetworkMessageId \\r\\n    | summarize count() \\r\\n    ); \\r\\n    // print each result, and run the calculation to work out effectiveness at time of delivery and post delivery. \\r\\n\\r\\nprint StatisticName=\\\"Effectiveness Post Delivery\\\", Value=abs(round(((toreal(toscalar(FN_Admin_Submissions))+toreal(toscalar(FN_ZAP_Unsuccessful)))/(toreal(toscalar(Mal_Phish_Mailflow))+toreal(toscalar(FN_ZAP_Successful))+toreal(toscalar(FN_ZAP_Unsuccessful))+toreal(toscalar(FN_Admin_Submissions))-toreal(toscalar(FP_ZAP)))*100-100),2))\",\"size\":1,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"stat\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"StatisticName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Value\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"StatisticName\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Value\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"statSettings\":{\"valueField\":\"Value\",\"valueAggregation\":\"None\",\"colorSettings\":{\"type\":\"thresholds\",\"mode\":\"foreground\",\"heatmapPalette\":\"greenRed\",\"thresholdsGrid\":[{\"operator\":\">\",\"thresholdValue\":\"95\",\"representation\":\"green\"},{\"operator\":\"<=\",\"thresholdValue\":\"95\",\"representation\":\"orange\"},{\"operator\":\"<=\",\"thresholdValue\":\"90\",\"representation\":\"red\"}]},\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}},\"tagText\":\"Phish / Malware Effectiveness - Post Delivery\",\"valueFontStyle\":\"superLarge\",\"tagTextPosition\":\"bottom\"}},\"customWidth\":\"50\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the percentage of emails released from quarantine out of the total ammount of quarantined emails\\r\\nlet Quarantine_Releases = toscalar(EmailPostDeliveryEvents\\r\\n| where Action == \\\"Quarantine release\\\"\\r\\n| join kind=leftouter (EmailEvents | where DeliveryLocation == \\\"Quarantine\\\") on NetworkMessageId\\r\\n| summarize count());\\r\\nlet Quarantined_Mailfow = toscalar(EmailEvents | where DeliveryLocation == \\\"Quarantine\\\"\\r\\n| summarize count());\\r\\nprint\\r\\nQuarantine_Releases = toreal(Quarantine_Releases),\\r\\nQuarantined_Mailflow = toreal(Quarantined_Mailfow),\\r\\nRelease_Percentage = abs(round(((toreal(Quarantine_Releases)/toreal(Quarantined_Mailfow))*100),2))\",\"size\":1,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"stat\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Release_Percentage\",\"formatter\":12,\"formatOptions\":{\"palette\":\"none\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},\"showBorder\":true,\"sortCriteriaField\":\"Release_Percentage\",\"size\":\"auto\"},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"StatisticName\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Value\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"statSettings\":{\"valueField\":\"Release_Percentage\",\"valueAggregation\":\"None\",\"colorSettings\":{\"type\":\"thresholds\",\"mode\":\"foreground\",\"heatmapPalette\":\"greenRed\",\"thresholdsGrid\":[{\"operator\":\"<\",\"thresholdValue\":\"5\",\"representation\":\"green\"},{\"operator\":\">\",\"thresholdValue\":\"5\",\"representation\":\"redDark\"}]},\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}},\"tagText\":\"Quarantine Release Percentage\",\"valueFontStyle\":\"superLarge\",\"tagTextPosition\":\"bottom\"}},\"customWidth\":\"50\",\"name\":\"query - 1\"}]},\"name\":\"TopNr\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Effectiveness visually represents the protection given by Defender for Office 365 against phishing and malware in email messages.** <br>\\r\\nWe consider messages that your users report, as well as decisions that are made after delivery.\"},\"name\":\"text - 9\",\"styleSettings\":{\"margin\":\"1px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query shows the number behind the effectiveness of phish and malware false positives including post delivery events but without edge data detections.\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\n\\r\\n// Get all mailflow detected as clean at time of delivery \\r\\nlet EmailEventsClean = materialize( \\r\\n    EmailEvents \\r\\n    | where Timestamp between (toscalar(minTime) .. toscalar(maxTime)) and EmailDirection == \\\"Inbound\\\" \\r\\n    | where ThreatTypes !contains \\\"Phish\\\" and ThreatTypes !contains \\\"Malware\\\" // UN-comment this when using sentinel or another streaming SIEM (line 10).\\r\\n    // this alteration is due to the threat types being updated directly within advanced hunting.\\r\\n    //| where DeliveryLocation != \\\"Quarantine\\\" // comment out this line if you uncomment line 10, as it's only required for advanced hunting.\\r\\n    | project NetworkMessageId,ThreatTypes \\r\\n); \\r\\n// Get all mailflow detected as phish or malware at time of delivery \\r\\nlet EmailEventsThreats = materialize( \\r\\n    EmailEvents \\r\\n    | where Timestamp between (toscalar(minTime) .. toscalar(maxTime)) and EmailDirection == \\\"Inbound\\\" \\r\\n    | where ThreatTypes contains \\\"Phish\\\" or ThreatTypes contains \\\"Malware\\\" \\r\\n    | extend MDO_detection = parse_json(DetectionMethods) \\r\\n    | extend FirstDetection = iif(isempty(MDO_detection), \\\"Clean\\\", tostring(bag_keys(MDO_detection)[0])) \\r\\n    | extend FirstSubcategory = iif(FirstDetection != \\\"Clean\\\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \\\": \\\", tostring(MDO_detection[FirstDetection][0])), \\\"No Detection (clean)\\\") \\r\\n    | project NetworkMessageId,FirstDetection,FirstSubcategory,MDO_detection,ThreatTypes \\r\\n); \\r\\n// Get all post delivery ZAP / Redelivery events, and arg_max them to ensure we have the latest verdict to work with for each \\r\\nlet EmailPostDeliveryFiltered = materialize( \\r\\n    EmailPostDeliveryEvents \\r\\n    | where Timestamp between (toscalar(minTime) .. datetime_add('day', 7, toscalar(maxTime))) \\r\\n    | where ActionType in (\\\"Malware ZAP\\\",\\\"Phish ZAP\\\",\\\"Redelivery\\\") \\r\\n    | extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n    | summarize arg_max(Timestamp, *) by Key \\r\\n    | project Action,ActionType,ActionResult,ThreatTypes,NetworkMessageId \\r\\n); \\r\\n// Optional - get all admin submissions for malware or phish, so we can also count these in the miss bucket. \\r\\nlet CloudAppEventsFiltered = materialize( \\r\\n    CloudAppEvents \\r\\n    | where Timestamp between (toscalar(minTime) .. datetime_add('day', 7, toscalar(maxTime)))\\r\\n    | where ActionType == \\\"AdminSubmissionSubmitted\\\" \\r\\n    | extend SubmissionType = tostring(parse_json(RawEventData).SubmissionType) \\r\\n    | extend NetworkMessageId = tostring(parse_json(RawEventData).ObjectId) \\r\\n    | where SubmissionType in (\\\"1\\\", \\\"2\\\") \\r\\n    | project SubmissionType,NetworkMessageId \\r\\n); \\r\\n// get the number of threats caught in mailflow \\r\\nlet Mal_Phish_Mailflow = toscalar( \\r\\n    EmailEventsThreats \\r\\n    | summarize count() \\r\\n); \\r\\n// get the number of threats caught in mailflow which turned out to be false positives (FPs) so we can correct the calculation \\r\\nlet FP_ZAP = toscalar( \\r\\n    EmailPostDeliveryFiltered \\r\\n    | where ThreatTypes !contains \\\"Phish\\\" and ThreatTypes !contains \\\"Malware\\\" and ActionType == \\\"Redelivery\\\" \\r\\n    | join kind=leftsemi (EmailEventsThreats) on NetworkMessageId \\r\\n    | summarize count() \\r\\n); \\r\\n// get the number of threats successfully cleaned up post delivery, ignoring where administrative policy stopped action \\r\\nlet FN_ZAP_Successful = toscalar( \\r\\n    EmailPostDeliveryFiltered \\r\\n    | where ActionType in (\\\"Malware ZAP\\\",\\\"Phish ZAP\\\") and ActionResult in (\\\"Success\\\",\\\"AdminPolicy\\\") \\r\\n    | join kind=leftsemi (EmailEventsClean) on NetworkMessageId \\r\\n    | summarize count() \\r\\n); \\r\\n// get the number of threats unsuccessfully cleaned up post delivery. \\r\\nlet FN_ZAP_Unsuccessful = toscalar( \\r\\n    EmailPostDeliveryFiltered \\r\\n    | where ActionType in (\\\"Malware ZAP\\\",\\\"Phish ZAP\\\") and ActionResult !in (\\\"Success\\\",\\\"AdminPolicy\\\") \\r\\n    | join kind=leftsemi (EmailEventsClean) on NetworkMessageId \\r\\n    | summarize count() \\r\\n); \\r\\n// join the administrative submissions to clean mailflow to find the additional miss \\r\\nlet FN_Admin_Submissions = toscalar( \\r\\n    CloudAppEventsFiltered \\r\\n    | join kind=rightsemi (EmailEventsClean) on NetworkMessageId \\r\\n    | summarize count() \\r\\n    ); \\r\\n    // print each result, and run the calculation to work out effectiveness at time of delivery and post delivery. \\r\\nunion withsource=Table \\r\\n    (print StatisticName=\\\"Mal/Phish Mailflow totals - Minus FPs\\\", Value=toreal(Mal_Phish_Mailflow) - toreal(FP_ZAP)), \\r\\n    (print StatisticName=\\\"Admin Mal/Phish FNs Submitted\\\", Value=toreal(FN_Admin_Submissions)), \\r\\n    (print StatisticName=\\\"Mal/Phish FPs Reverse Zapped\\\", Value=toreal(FP_ZAP)), \\r\\n    (print StatisticName=\\\"Mal / Phish Successfully Zapped\\\", Value=toreal(FN_ZAP_Successful)), \\r\\n    (print StatisticName=\\\"Mal / Phish UN-Successfully Zapped\\\", Value=toreal(FN_ZAP_Unsuccessful)), \\r\\n    (print StatisticName=\\\"Effectiveness Post Delivery\\\", Value=abs(round(((toreal(FN_Admin_Submissions)+toreal(FN_ZAP_Unsuccessful))/(toreal(Mal_Phish_Mailflow)+toreal(FN_ZAP_Successful)+toreal(FN_ZAP_Unsuccessful)+toreal(FN_Admin_Submissions)-toreal(FP_ZAP))*100-100),2))), \\r\\n    (print StatisticName=\\\"Effectiveness Pre-Delivery\\\", Value=abs(round(((toreal(FN_Admin_Submissions)+toreal(FN_ZAP_Unsuccessful)+toreal(FN_ZAP_Successful))/(toreal(Mal_Phish_Mailflow)+toreal(FN_ZAP_Successful)+toreal(FN_ZAP_Unsuccessful)+toreal(FN_Admin_Submissions)-toreal(FP_ZAP))*100-100),2))) \\r\\n| project StatisticName, Value\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Value\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}]},\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"StatisticName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Value\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"StatisticName\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Value\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"StatisticName\",\"sourceIdField\":\"Value\",\"targetIdField\":\"Value\",\"graphOrientation\":3,\"showOrientationToggles\":false,\"staticNodeSize\":100,\"hivesMargin\":5}},\"name\":\"query - 7\"}]},\"customWidth\":\"50\",\"name\":\"Effectiveness Nr\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Quarantine Release Percentage takes all emails quarantined during mail flow and divides it by the amount of mail released from quarantine.** \\r\\n<br>\\r\\nQuarantine release actions can be initiated by end-user or administrators.\"},\"name\":\"text - 1\",\"styleSettings\":{\"margin\":\"1px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises emails released from quarantine and summarizing the result by the original filter verdict - detection method\\r\\nlet totalQuery = \\r\\n    EmailPostDeliveryEvents \\r\\n    | where Action == \\\"Quarantine release\\\" \\r\\n    | join kind=inner (EmailEvents | where DeliveryLocation == \\\"Quarantine\\\") on NetworkMessageId \\r\\n    | extend MDO_detection = parse_json(DetectionMethods1) \\r\\n    | extend FirstDetection = iif(isempty(MDO_detection), \\\"Clean\\\", tostring(bag_keys(MDO_detection)[0])) \\r\\n    | extend FirstSubcategory = iif(FirstDetection != \\\"Clean\\\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \\\": \\\", tostring(MDO_detection[FirstDetection][0])), \\\"No Detection (clean)\\\") \\r\\n    | where FirstSubcategory contains \\\"Malware\\\" or FirstSubcategory contains \\\"Phish\\\" or FirstSubcategory contains \\\"Spam\\\"\\r\\n    | count;\\r\\nEmailPostDeliveryEvents \\r\\n| where Action == \\\"Quarantine release\\\" \\r\\n| join kind=inner (EmailEvents | where DeliveryLocation == \\\"Quarantine\\\") on NetworkMessageId \\r\\n| extend MDO_detection = parse_json(DetectionMethods1) \\r\\n| extend FirstDetection = iif(isempty(MDO_detection), \\\"Clean\\\", tostring(bag_keys(MDO_detection)[0])) \\r\\n| extend DetectionTechnology= iif(FirstDetection != \\\"Clean\\\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \\\": \\\", tostring(MDO_detection[FirstDetection][0])), \\\"No Detection (clean)\\\") \\r\\n| where DetectionTechnology contains \\\"Malware\\\" or DetectionTechnology contains \\\"Phish\\\" or DetectionTechnology contains \\\"Spam\\\" \\r\\n| summarize count_messages = count(NetworkMessageId) by DetectionTechnology\\r\\n| extend percentage = round((count_messages * 100.0 / toscalar(totalQuery)), 2)\\r\\n| project DetectionTechnology, count_messages, percentage\\r\\n| order by percentage desc\\r\\n| take 7 \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_messages\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}]}},\"name\":\"query - 2\"}]},\"customWidth\":\"50\",\"name\":\"Quarantine Overview Relese\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:28px; font-weight:bold;color:white;width:1%\\\">Protection\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis is an overview of protection numbers for **Microsoft Defender for Office 365** including Malware, Phish, Spam detections, post delivery detections and user/admin reported messages.\"},\"name\":\"text - 13\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Total Emails\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"EmailEvents\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key \\r\\n| summarize Count = count()\\r\\n| extend Details = \\\"Total Inbound Emails\\\";\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\"}}]},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Details\",\"formatter\":1,\"formatOptions\":{\"compositeBarSettings\":{\"labelText\":\"\"}}},\"secondaryContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"min\":1,\"palette\":\"blue\",\"compositeBarSettings\":{\"labelText\":\"\"}},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},\"showBorder\":true,\"size\":\"full\",\"styleSettings\":{\"borderStyle\":\"rounded\",\"backgroundColor\":\"colorGray100\"}},\"chartSettings\":{\"xAxis\":\"Count\",\"createOtherGroup\":0},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"Count\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"Count\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"Count\",\"heatmapPalette\":\"greenRed\"}}},\"name\":\"query - 1\"}]},\"name\":\"Total Inbound\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Pre-Delivery Filtering Totals\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"EmailEvents\\r\\n| where isnotempty(ThreatTypes) and EmailDirection == \\\"Inbound\\\" and DeliveryAction != 'Delivered'\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key \\r\\n| summarize Count = count()\\r\\n| extend Details = \\\"Filtering Totals\\\";\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Details\",\"formatter\":1,\"formatOptions\":{\"compositeBarSettings\":{\"labelText\":\"\"}}},\"secondaryContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"min\":1,\"palette\":\"redDark\",\"compositeBarSettings\":{\"labelText\":\"\"}}},\"showBorder\":true,\"size\":\"full\",\"styleSettings\":{\"borderStyle\":\"rounded\",\"backgroundColor\":\"colorGray100\"}}},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises Total emails detected as Malware\\r\\nEmailEvents\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key \\r\\n| where ThreatTypes has ('Malware') and EmailDirection == \\\"Inbound\\\"\\r\\n| summarize Count= count()\\r\\n| extend Details = \\\"Emails Filtered as Malware\\\"\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Details\",\"formatter\":1},\"secondaryContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"min\":1,\"palette\":\"red\"}},\"showBorder\":true,\"size\":\"full\",\"styleSettings\":{\"borderStyle\":\"rounded\",\"backgroundColor\":\"colorGray100\"}}},\"customWidth\":\"33.3\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises Total emails detected as Phish\\r\\nEmailEvents\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key \\r\\n| where ThreatTypes has \\\"Phish\\\" and not(ThreatTypes has \\\"Malware\\\") and EmailDirection == \\\"Inbound\\\" and DeliveryAction != 'Delivered'\\r\\n| summarize Count= count()\\r\\n| extend Details = \\\"Emails Filtered as Phish\\\"\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Details\",\"formatter\":1},\"secondaryContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"min\":1,\"palette\":\"orange\"}},\"showBorder\":true,\"size\":\"full\",\"styleSettings\":{\"borderStyle\":\"rounded\",\"backgroundColor\":\"colorGray100\"}}},\"customWidth\":\"33.3\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises Total emails by detected as Spam\\r\\nEmailEvents\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key \\r\\n| where ThreatTypes == 'Spam' and EmailDirection == \\\"Inbound\\\" and DeliveryAction != 'Delivered'\\r\\n| summarize Count= count()\\r\\n| extend Details = \\\"Emails Filtered as Spam\\\"\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Details\",\"formatter\":1},\"secondaryContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"min\":1,\"palette\":\"yellow\"}},\"showBorder\":true,\"size\":\"full\",\"styleSettings\":{\"borderStyle\":\"rounded\",\"backgroundColor\":\"colorGray100\"}}},\"customWidth\":\"33.3\",\"name\":\"query - 4\"}]},\"customWidth\":\"50\",\"name\":\"group - 9\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\" \",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"EmailEvents\\r\\n| where EmailDirection == \\\"Inbound\\\" and isnotempty(ThreatTypes) and DeliveryAction == 'Delivered'\\r\\n| where isnotempty(OrgLevelAction) or isnotempty(UserLevelAction)\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key \\r\\n| summarize Count= count()\\r\\n| extend Details = \\\"Emails Delivered with Detection\\\"\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Details\",\"formatter\":1},\"secondaryContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"min\":0,\"palette\":\"red\"}},\"showBorder\":true,\"size\":\"full\",\"styleSettings\":{\"borderStyle\":\"rounded\",\"backgroundColor\":\"colorGray100\"}}},\"customWidth\":\"33.3\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"EmailEvents\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where EmailDirection == \\\"Inbound\\\" and isempty(ThreatTypes) \\r\\n| where isnotempty(OrgLevelAction) or isnotempty(UserLevelAction)\\r\\n| where DeliveryAction != 'Delivered'\\r\\n| summarize Count= count()\\r\\n| extend Details = \\\"User/Admin Blocked\\\"\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Details\",\"formatter\":1},\"secondaryContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"min\":1,\"palette\":\"gray\"},\"tooltipFormat\":{\"tooltip\":\"Emails blocked from being delivered because of User or Admin overriddes\"}},\"showBorder\":true,\"size\":\"full\",\"styleSettings\":{\"borderStyle\":\"rounded\",\"backgroundColor\":\"colorGray100\"}}},\"customWidth\":\"33.3\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"EmailEvents\\r\\n| where isempty(ThreatTypes) and EmailDirection == \\\"Inbound\\\" and DeliveryAction == 'Delivered'\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key \\r\\n| summarize Count= count()\\r\\n| extend Details = \\\"Clean Emails\\\"\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Details\",\"formatter\":1},\"secondaryContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"min\":1,\"palette\":\"gray\"}},\"showBorder\":true,\"size\":\"full\",\"styleSettings\":{\"borderStyle\":\"rounded\",\"backgroundColor\":\"colorGray100\"}}},\"customWidth\":\"33.3\",\"name\":\"query - 3\"}]},\"customWidth\":\"50\",\"name\":\"group - 8\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Post Delivery FIltering Totals\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"EmailPostDeliveryEvents\\r\\n| where ActionResult == \\\"Success\\\"\\r\\n| where ActionType == \\\"Malware ZAP\\\"\\r\\n| summarize Count= count()\\r\\n| extend Details = \\\"Total Emails Removed by Malware ZAP\\\"\\r\\n\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Details\",\"formatter\":1},\"secondaryContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"min\":1,\"palette\":\"red\"}},\"showBorder\":true,\"size\":\"full\",\"styleSettings\":{\"borderStyle\":\"rounded\",\"backgroundColor\":\"colorGray100\"}}},\"customWidth\":\"33.3\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"EmailPostDeliveryEvents\\r\\n| where ActionResult == \\\"Success\\\"\\r\\n| where ActionType == \\\"Phish ZAP\\\"\\r\\n| summarize Count= count()\\r\\n| extend Details = \\\"Total Emails Removed by Phish ZAP\\\"\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Details\",\"formatter\":1},\"secondaryContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"min\":1,\"palette\":\"orange\"}},\"showBorder\":true,\"size\":\"full\",\"styleSettings\":{\"borderStyle\":\"rounded\",\"backgroundColor\":\"colorGray100\"}}},\"customWidth\":\"33.3\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"EmailPostDeliveryEvents\\r\\n| where ActionResult == \\\"Success\\\"\\r\\n| where ActionType == \\\"Spam ZAP\\\"\\r\\n| summarize Count= count()\\r\\n| extend Details = \\\"Total Emails Removed by Spam ZAP\\\"\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Details\",\"formatter\":1},\"secondaryContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"min\":1,\"palette\":\"yellow\"}},\"showBorder\":true,\"size\":\"full\",\"styleSettings\":{\"borderStyle\":\"rounded\",\"backgroundColor\":\"colorGray100\"}}},\"customWidth\":\"33.3\",\"name\":\"query - 3\"}]},\"name\":\"Post Delivery\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails reported by user and total emails reported by Admins as false positive or false negative detection\\r\\nCloudAppEvents\\r\\n| extend Record= (parse_json(RawEventData)).RecordType\\r\\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| where Record == 29 and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\"\\r\\n| summarize Count= count()\\r\\n| extend Details = \\\"Total Emails Reported by Admins\\\"\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Details\",\"formatter\":1},\"secondaryContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"none\"}},\"showBorder\":true,\"size\":\"full\",\"styleSettings\":{\"borderStyle\":\"rounded\",\"backgroundColor\":\"colorGray100\"}}},\"customWidth\":\"50\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails reported by user and total emails reported by Admins as false positive or false negative detection\\r\\nCloudAppEvents\\r\\n| extend Record= (parse_json(RawEventData)).RecordType\\r\\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState\\r\\n| where Record == 29 and ActionType == \\\"UserSubmission\\\"\\r\\n| summarize Count= count()\\r\\n| extend Details = \\\"Total Emails Reported by Users\\\"\\r\\n\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Details\",\"formatter\":1},\"secondaryContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"none\"}},\"showBorder\":true,\"size\":\"full\",\"styleSettings\":{\"borderStyle\":\"rounded\",\"backgroundColor\":\"colorGray100\"}}},\"customWidth\":\"50\",\"name\":\"query - 2\"}]},\"name\":\"Reported\"},{\"type\":1,\"content\":{\"json\":\"## Detection trend over time\\r\\n**Represents total emails, total detections, total user submissions and admin email submissions over time summarizing the data daily**\"},\"name\":\"text - 14\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails, total detections, total user, and admin email submissions over time summarizing the data daily\\r\\n\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\n\\r\\nlet baseQuery = EmailEvents\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key \\r\\n| where isnotempty(Timestamp);\\r\\n\\r\\nlet totalinbound = baseQuery\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Total Inbound Emails\\\";\\r\\n\\r\\nlet totalintraorg = baseQuery\\r\\n| where EmailDirection == \\\"Intra-org\\\"\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Total Intra-org Emails\\\";\\r\\n\\r\\nlet totaloutbound = baseQuery\\r\\n| where EmailDirection == \\\"Outbound\\\"\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Total Outbound Emails\\\";\\r\\n\\r\\nlet totalwiththreat = baseQuery\\r\\n| where isnotempty(ThreatTypes) \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Total Emails with Threat\\\";\\r\\n\\r\\nlet phishingcount = baseQuery\\r\\n| where ThreatTypes has ('Phish')\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Emails Detected as Phish\\\";\\r\\n\\r\\nlet malwarecount = baseQuery\\r\\n| where ThreatTypes has ('Malware')\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Emails Detected as Malware\\\";\\r\\n\\r\\nlet spamcount = baseQuery\\r\\n| where ThreatTypes has ('Spam')\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Emails Detected as Spam\\\";\\r\\n\\r\\nlet usersubmissioncount = CloudAppEvents\\r\\n| extend Record= (parse_json(RawEventData)).RecordType\\r\\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState\\r\\n| where Record == 29 | where ActionType == \\\"UserSubmission\\\"\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Total Emails Reported by Users\\\";\\r\\n\\r\\nlet adminsubmissioncount = CloudAppEvents\\r\\n| extend Record= (parse_json(RawEventData)).RecordType\\r\\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| where Record == 29 and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\"\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Total Emails Reported by Admins\\\";\\r\\n\\r\\nlet zapcount = EmailPostDeliveryEvents\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key \\r\\n| where ActionResult == \\\"Success\\\"\\r\\n| where ActionType == \\\"Phish ZAP\\\" or ActionType == \\\"Malware ZAP\\\" or ActionType == \\\"Spam ZAP\\\"\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Total Emails Removed by ZAP\\\";\\r\\n\\r\\nunion totalinbound, phishingcount, malwarecount, spamcount, totalintraorg, totaloutbound, totalwiththreat, usersubmissioncount, zapcount, adminsubmissioncount\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"xAxis\":\"Timestamp\",\"seriesLabelSettings\":[{\"seriesName\":\"Total Inbound Emails\",\"label\":\"Inbound Emails\",\"color\":\"green\"},{\"seriesName\":\"Total Emails with Threat\",\"label\":\"Emails with Threat\",\"color\":\"redDark\"},{\"seriesName\":\"Emails Detected as Phish\",\"label\":\"Emails with Phish\",\"color\":\"redBright\"},{\"seriesName\":\"Emails Detected as Malware\",\"label\":\"Emails with Malware\",\"color\":\"red\"},{\"seriesName\":\"Total Intra-org Emails\",\"label\":\"Intra-org Emails\",\"color\":\"greenDark\"},{\"seriesName\":\"Emails Detected as Spam\",\"label\":\"Emails with Spam\",\"color\":\"gray\"},{\"seriesName\":\"Total Outbound Emails\",\"label\":\"Outbound Emails\",\"color\":\"greenDarkDark\"},{\"seriesName\":\"Total Emails Removed by ZAP\",\"label\":\"Emails ZAP-d\",\"color\":\"orangeDark\"},{\"seriesName\":\"Total Emails Reported by Users\",\"label\":\"User Reported Emails\",\"color\":\"lightBlue\"},{\"seriesName\":\"Total Emails Reported by Admins\",\"color\":\"blueDark\"}]}},\"customWidth\":\"100\",\"name\":\"query - 1\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"## Bad traffic percentage (%) - Inbound Emails\\r\\n**This represents bad traffic (% of emails with threats) compared to total inbound emails, summarized daily over time.**\"},\"name\":\"text - 15\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises bad traffic (% of emails with threats) compared to total inbound emails over time summarising the data daily.\\r\\nEmailEvents\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| summarize TotalEmailCount = count(),\\r\\n            BadEmailCount = countif(isnotempty(ThreatTypes)) by bin(Timestamp, 1d)\\r\\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(BadEmailCount / todouble(TotalEmailCount) * 100, 2))\\r\\n| project Timestamp,Bad_Traffic_Percentage_Inbound\",\"size\":0,\"aggregation\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"100\",\"name\":\"query - 4\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:28px; font-weight:bold;color:white;width:1%\\\">Emerging Threats\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\n<p style=\\\"font-size:16px;\\\">With more sophisticated adversaries and new threats emerging frequently and prevalently, it's critical to be able to quickly identify and react to these threats.</p>\\r\\n\\r\\n[<p style=\\\"font-size:16px;\\\"><b>Activity Profile: Recent OSINT trends in ransomware</b></p>](https://security.microsoft.com/threatanalytics3/7f22cb98-1a75-4288-b2f6-f429c21f6d82)\\r\\n[<p style=\\\"font-size:16px;\\\"><b>Activity Profile: Vulnerability threat landscape, July to September 2025</p>](https://security.microsoft.com/threatanalytics3/cc065001-85d1-4ef5-9aa1-589727a9c473)\\r\\n[<p style=\\\"font-size:16px;\\\"><b>Activity Profile: Email threat landscape, September 2025</p>](https://security.microsoft.com/threatanalytics3/343aec4e-38ff-4a48-ad02-284744402840)\\r\\n[<p style=\\\"font-size:16px;\\\"><b>Actor Profile: Storm-2657</p>](https://security.microsoft.com/threatanalytics3/ee708c69-c676-4221-a2a7-1b90f7a5ebca)\\r\\n[<p style=\\\"font-size:16px;\\\"><b>Activity Profile: Targeted payroll pirate attacks affecting US universities</p>](https://security.microsoft.com/threatanalytics3/efc971b5-8159-46cf-b944-015090923411)\\r\\n\\r\\n<br>\\r\\n<a href=\\\"https://go.microsoft.com/fwlink/?linkid=2323913\\\" target=\\\"_blank\\\" style=\\\"font-size:14px; padding:10px 20px; background-color:#003366; color:white; border:none; border-radius:5px;\\\">\\r\\n<b>View all\\r\\n \\r\\n</a>\\r\\n\"},\"name\":\"text - 10\",\"styleSettings\":{\"margin\":\"0\",\"padding\":\"0\"}},{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:28px; font-weight:bold;color:white;width:1%\\\">Microsoft 365 Secure Email Gateway Performance\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\n<p style=\\\"font-size:16px;\\\">Using multiple vendor email security products can offer diverse detections. However, our comprehensive end-to-end approachspanning prevention, detection, posture, investigation, response, and user trainingdelivers a unified and effective defense that matches or exceeds the efficacy of siloed Secure Email Gateway solutions.</p>\\r\\n\\r\\n[<p style=\\\"font-size:18px;\\\"><b>Learn more</b></p>](https://go.microsoft.com/fwlink/?linkid=2326674) \\r\\n\\r\\n<br>\\r\\n<p style=\\\"font-size:16px;\\\"><b>High confidence Phish / Malware miss per 1,000 active users - Last Updated by Microsoft on 1st July 2025 (Q2 CY2025 Results)</b></p>\"},\"name\":\"text - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"datatable(Index:int, Name:string, Value:int)\\r\\n[\\r\\n    1, \\\"Defender for Office 365\\\", \\\"154\\\",\\r\\n    2, \\\"Proofpoint\\\", \\\"433\\\",\\r\\n    3, \\\"HornetSecurity\\\", \\\"564\\\",\\r\\n    4, \\\"Mimecast\\\", \\\"674\\\",\\r\\n    5, \\\"Trend Micro\\\", \\\"790\\\",\\r\\n    7, \\\"Ironport\\\", \\\"931\\\",\\r\\n    8, \\\"Barracuda\\\", \\\"936\\\",\\r\\n    9, \\\"Trellix\\\", \\\"1700\\\"\\r\\n]\\r\\n| project Name, Value, Index\\r\\n| order by Index asc\\r\\n\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"xAxis\":\"Name\",\"yAxis\":[\"Value\"],\"sortBy\":\"query\",\"seriesLabelSettings\":[{\"seriesName\":\"Trellix\",\"color\":\"gray\"},{\"seriesName\":\"Barracuda\",\"color\":\"gray\"},{\"seriesName\":\"Ironport\",\"color\":\"gray\"},{\"seriesName\":\"Trend Micro\",\"color\":\"gray\"},{\"seriesName\":\"Mimecast\",\"color\":\"gray\"},{\"seriesName\":\"HornetSecurity\",\"color\":\"gray\"},{\"seriesName\":\"Proofpoint\",\"color\":\"gray\"},{\"seriesName\":\"Defender for Office 365\",\"color\":\"blueDark\"}],\"xSettings\":{\"numberFormatSettings\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}}},\"name\":\"query - 11\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}],\"exportParameters\":true},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"1\"},\"customWidth\":\"100\",\"name\":\"Detection Overview\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"# Malware detection insights\\r\\n\\r\\n---\\r\\n\\r\\nThis tab provides insights into email message **detections** by Microsoft Defender for Office 365 where the message contained a **malware threat** (such as viruses, spyware, or ransomware) within its **URLs** or **attachments**.\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"text - 13\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Malware Detection Trends, Threat Classes, and Malware Names\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and explain malware detections in inbound email as identified by Microsoft Defender for Office 365 focusing on daily trend, threat classes and Malware types. \\r\\n\"},\"name\":\"text - 14\"},{\"type\":1,\"content\":{\"json\":\"### Malware Detection Trend\\r\\n**This visual displays a daily trend of email malware detections identified by Microsoft Defender for Office 365. The line chart summarises the number of messages flagged for malware threats.**\"},\"name\":\"text - 14 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Malware detections over time summarizing the data daily.\\r\\nEmailEvents \\r\\n| where ThreatTypes has \\\"Malware\\\" \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| make-series MalwareDetections = count(Key) default = 0 on Timestamp step 1d \\r\\n\\r\\n\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"query - 0\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Malware Detection Trend - Advanced Threats\\r\\n**Not all threats are going to be easily recognisable, that's why Microsoft Defender for Office 365 has advanced threat detection methods, that use virtual sandbox environments to detonate URLs and Files. These virtual sandbox technologies look for known patterns, such as a recognisable login page in a URL, or a file accessing command and control infrastructure. This visual displays a daily trend of Malware detections of these advanced threats**\"},\"name\":\"text - 14 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Malware detections over time summarizing the data daily by Malware detection technologies/controls used for detecting unknown-unique malware.\\r\\nEmailEvents\\r\\n| where DetectionMethods has 'Malware'\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend ParsedMethods = parse_json(DetectionMethods)\\r\\n| mv-expand MalwareMethod = ParsedMethods.Malware\\r\\n| where MalwareMethod in ('File detonation','URL detonation')\\r\\n| make-series Count= count(Key) default = 0 on Timestamp step 1d by tostring(MalwareMethod)\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"File detonation\",\"color\":\"redDark\"},{\"seriesName\":\"URL detonation\",\"color\":\"orangeDark\"}]}},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"query - 9\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Malware Detections by Threat Classification\\r\\n**Summary of email messages detected by Microsoft Defender for Office 365 as malware, grouped by type of malware (Adware, Downloader, Hack tool, Ransomware, Remote access trojan, Spyware).**\"},\"customWidth\":\"33\",\"name\":\"text - 15\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top Attacked Users by Malware Threat Classification\\r\\n**Displays the recipient most frequently targeted for each malware type (Adware, Downloader, Hack tool, Ransomware, Remote access trojan, Spyware) in inbound email detections.**\"},\"customWidth\":\"33\",\"name\":\"text - 15 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Malware Detections by Threat Name\\r\\n**Summarises email messages flagged by Microsoft Defender for Office 365, grouped by specific malware names detected in URLs or attachments.**\"},\"customWidth\":\"33\",\"name\":\"text - 15 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Malware detections summarizing the data by threat classification of the malware threat in the message.\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| where ThreatTypes has 'Malware' and ThreatClassification  has_any(\\\"Adware\\\",\\\"Downloader\\\",\\\"Hack tool\\\",\\\"Ransomware\\\",\\\"Remote access trojan\\\",\\\"Spyware\\\")\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize Count = count(Key) by ThreatClassification\\r\\n| sort by Count desc\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":10}},\"customWidth\":\"33\",\"name\":\"query - 11\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises Malware detections in emails summarizing by various Threat classes showing the top attacked user for each threat classification type.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| where ThreatTypes has \\\"Malware\\\" and EmailDirection == \\\"Inbound\\\" and ThreatClassification has_any(\\\"Adware\\\",\\\"Downloader\\\",\\\"Hack tool\\\",\\\"Ransomware\\\",\\\"Remote access trojan\\\",\\\"Spyware\\\")\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize EmailCount=count() by ThreatClassification, RecipientEmailAddress\\r\\n| summarize Count = arg_max(EmailCount, RecipientEmailAddress) by ThreatClassification\\r\\n| sort by Count desc\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"}},{\"columnMatch\":\"TopEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"}}],\"filter\":true},\"statSettings\":{\"valueField\":\"RecipientEmailAddress\",\"valueAggregation\":\"None\",\"colorSettings\":{\"type\":\"static\",\"mode\":\"background\",\"heatmapPalette\":\"greenRed\"},\"tagText\":\"\",\"valueFontStyle\":\"auto\"},\"chartSettings\":{\"xAxis\":\"RecipientEmailAddress\"}},\"customWidth\":\"33\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"query - 5 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Malware detections summarizing the data by ThreatNames of the malware detected.\\r\\nEmailEvents \\r\\n| where isnotempty(ThreatNames) and ThreatTypes has \\\"Malware\\\" \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , \\\"-\\\", RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize Count = count() by ThreatNames \\r\\n| sort by Count\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"chartSettings\":{\"xAxis\":\"ThreatNames\",\"yAxis\":[\"count_\"],\"createOtherGroup\":10}},\"customWidth\":\"33\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"group - 3\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Malware Detections by Delivery Location, Detection Technology and Sender Infrastructure Insights\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and explain malware detections delivery locations, detection technologies used for detections, sender infrastructure insights in inbound email identified by Microsoft Defender for Office 365 as Malware. \\r\\n\"},\"name\":\"text - 14 - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Malware Detections by delivery location\\r\\n**Visualizes daily counts of malware detections of inbound emails by delivery location: Quarantine or Failed (rejected with or without NDR)**\"},\"name\":\"text - 14 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Malware detections over time summarizing the data daily by Delivery Location\\r\\nEmailEvents\\r\\n| where DetectionMethods has 'Malware' and EmailDirection == 'Inbound'\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| make-series TotalMalwareDetections=count(Key),Quarantine = countif(DeliveryLocation == 'Quarantine'), Failed=countif(DeliveryLocation == 'Failed') default = 0 on Timestamp step 1d \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"TotalMalwareDetections\",\"color\":\"blue\"},{\"seriesName\":\"Quarantine\",\"color\":\"orangeDark\"},{\"seriesName\":\"Failed\",\"color\":\"redDark\"}]}},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"query - 10\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Malware Detections by Detection Technology\\r\\n**Visualizes daily counts of Malware detections of inbound emails by various Microsoft Defender for Office 365 detection technologies.**\"},\"name\":\"text - 14 - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Malware detections over time summarizing the data daily by various Malware detection technologies/controls in Microsoft Defender for Office 365.\\r\\nEmailEvents\\r\\n| where DetectionMethods has 'Malware'\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend ParsedMethods = parse_json(DetectionMethods)\\r\\n| mv-expand MalwareMethod = ParsedMethods.Malware\\r\\n| project Timestamp, Key, MalwareMethod\\r\\n| make-series Count= count(Key) default = 0 on Timestamp step 1d by tostring(MalwareMethod)\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"66\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"query - 8\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Malware detections summarizing the data by various Malware detection technologies/controls in Microsoft Defender for Office 365.\\r\\nEmailEvents \\r\\n| where DetectionMethods has 'Malware'\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend ParsedMethods = parse_json(DetectionMethods)\\r\\n| mv-expand MalwareMethod = ParsedMethods.Malware\\r\\n| summarize Count = count() by tostring(MalwareMethod)\\r\\n| sort by Count desc\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"xAxis\":\"Malware\"}},\"customWidth\":\"33\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"query - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Malware Detections by SenderIPv4 Geo Location\\r\\n**Visualizes the email sending infrastructure sender IPv4 addresses associated with inbound emails detected as Malware, along with the IPv4 address geographic coordinates (latitude, longitude) and country information. Helps identify high-risk regions and sources for targeted threat mitigation.**\"},\"name\":\"text - 14 - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Malware detections summarizing the data by email sender IP address (SenderIPv4).\\r\\nEmailEvents \\r\\n| where ThreatTypes has 'Malware' and isnotempty(SenderIPv4)\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize count() by SenderIPv4\\r\\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\\r\\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\\r\\n| project SenderIPv4, Latitude, Longitude, count_\\r\\n\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Malware Detections-Sender Heatmap (IPv4)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"map\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"count_\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"count_\",\"sortOrder\":2}],\"mapSettings\":{\"locInfo\":\"LatLong\",\"locInfoColumn\":\"GeoInfo\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"SenderIPv4\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"query - 1\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Malware detections summarizing the data by email sender IP address and IP address country information (SenderIPv4).\\r\\nEmailEvents \\r\\n| where ThreatTypes has 'Malware' and isnotempty(SenderIPv4)\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\\r\\n| extend Country = tostring(GeoInfo.country)\\r\\n| summarize count() by Country\\r\\n| project Country, MalwareEmailCount=count_\\r\\n| sort by MalwareEmailCount desc\\r\\n\\r\\n\\r\\n\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"MalwareEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"mapSettings\":{\"locInfo\":\"LatLong\",\"locInfoColumn\":\"GeoInfo\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"SenderIPv4\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"query - 1 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"Malware-Detectiontech-Deliverylocation-SendingInfra\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Malware Detections Top attacked users and top senders\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and explain malware detections in inbound email as identified by Microsoft Defender for Office 365 focusing on top attacked users and top senders. \\r\\n\"},\"name\":\"text - 14 - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Malware Detections top attacked users\\r\\n**Displays the top 10 recipient email addresses that received inbound emails flagged as Malware. These users may be at higher risk and should be prioritised for targeted cybersecurity awareness training. Training should cover the specific threat types and techniques they are exposed to, and reinforce best practices for promptly reporting any suspicious messages that might bypass security controls and reach their inbox.**\"},\"customWidth\":\"50\",\"name\":\"text - 14 - Copy - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Top 10 Sender Domains with Malware Detections (Inbound)\\r\\n**Displays the top 10 sender domains sending inbound emails detected as Malware. Helps identify external sources most frequently associated with malicious content for prioritised threat monitoring and mitigation.**\"},\"customWidth\":\"50\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total inbound emails with Malware detections summarizing the data by the top 10 recipient email address (RecipientEmailAddress).\\r\\nEmailEvents \\r\\n| where ThreatTypes has 'Malware' and EmailDirection == 'Inbound'\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize count() by RecipientEmailAddress\\r\\n| sort by count_ \\r\\n| top 10 by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"xAxis\":\"RecipientEmailAddress\",\"yAxis\":[\"count_\"],\"createOtherGroup\":10}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"query - 5\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total inbound emails with Malware detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain).\\r\\nEmailEvents \\r\\n| where ThreatTypes has 'Malware' and EmailDirection == 'Inbound'\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize count() by SenderFromDomain\\r\\n| sort by count_ \\r\\n| top 10 by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"SenderFromDomain\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"SenderFromDomain\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"SenderFromDomain\",\"yAxis\":[\"count_\"],\"createOtherGroup\":10}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"query - 4\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total inbound emails with Malware detections summarizing the data by the top 15 recipient email address (RecipientEmailAddress).\\r\\nEmailEvents\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(ThreatTypes has \\\"Malware\\\") by RecipientEmailAddress\\r\\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(MalwareEmailCount / todouble(TotalEmailCount) *100, 2))\\r\\n| where MalwareEmailCount !=0\\r\\n| sort by MalwareEmailCount desc\\r\\n| project RecipientEmailAddress,MalwareEmailCount, TotalEmailCount,Bad_Traffic_Percentage_Inbound\\r\\n| top 15 by MalwareEmailCount\\r\\n\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"MalwareEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Traffic_Percentage_Inbound\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"query - 18\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Malware detections summarizing the data by the top 15 email sender P2 domain (SenderFromDomain). Adding additional insights for total inbound emails and bad traffic percentage for each sender domain.\\r\\nEmailEvents\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmailCount = count(), MalwareEmailCount = countif(ThreatTypes has \\\"Malware\\\") by SenderFromDomain\\r\\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(MalwareEmailCount / todouble(TotalEmailCount) *100, 2))\\r\\n| where MalwareEmailCount !=0\\r\\n| sort by MalwareEmailCount desc \\r\\n| project SenderFromDomain,MalwareEmailCount,TotalEmailCount,Bad_Traffic_Percentage_Inbound\\r\\n| top 15 by MalwareEmailCount\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"MalwareEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Traffic_Percentage_Inbound\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false}}},{\"columnMatch\":\"BadEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"query - 18\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"MalwareTopAttackedUser-TopSenders\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"# Phishing Detection Insights\\r\\n\\r\\n---\\r\\nThis tab provides insights into email message **detections** by Microsoft Defender for Office 365 where the message contained a **Phishing threat** within its **email content**, **URLs**, or **attachments**.\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"text - 24\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%;\\\">Phishing Detection Trend, LLM Content Analysis, Advanced Threats, and Threat Classes\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and explain Phish detections in inbound email as identified by Microsoft Defender for Office 365 focusing on daily trends, advanced threat detections, LLM-based content analysis, and threat classes.\"},\"name\":\"text - 13\"},{\"type\":1,\"content\":{\"json\":\"### Phish Detection Trend<br>\\r\\n\\r\\n**This visual displays a daily trend of email Phish detections identified by Microsoft Defender for Office 365. The line chart summarises the number of messages flagged for Phish threats.**\"},\"name\":\"text - 13 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish detections over time summarizing the data daily.\\r\\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \\\"//\\\" to apply the exclusion.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where ThreatTypes has \\\"Phish\\\"\\r\\n| make-series PhishDetections = count() default = 0 on Timestamp step 1d \\r\\n\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"query - 0\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Phish Detection Trend - Advanced Threats<br>\\r\\n\\r\\n**Not all threats are easily recognizable, which is why Microsoft Defender for Office 365 uses advanced detection methods, including virtual sandbox environments to detonate URLs and files. These virtual sandbox technologies look for known patterns, such as a recognisable login page in a URL, or a file accessing command and control infrastructure. This visual displays a daily trend of Phish detections of these advanced threats.**\"},\"name\":\"text - 13 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish detections over time summarizing the data daily by Phish detection technologies/controls used for detecting unknown-unique phish.\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\nlet baseQuery = EmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where DetectionMethods has \\\"Phish\\\";\\r\\nlet fd=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'File detonation' and Phish !has 'File detonation reputation'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"File detonation\\\";\\r\\nlet ud=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'URL detonation' and Phish !has 'URL detonation reputation'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"URL detonation\\\";\\r\\nunion fd,ud\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"URL detonation\",\"color\":\"orangeDark\"},{\"seriesName\":\"File detonation\",\"color\":\"redDark\"}]}},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"query - 8\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Phish Detection - LLM content analysis<br>\\r\\n\\r\\n**Microsoft Defender for Office 365 uses Language AI for Phish  and Business Email Compromise (BEC) detection. These models are progressively learning from thousands of real-world phishing attempts and analyzing all messages classified as phish. Furthermore, it incorporates advanced Machine Learning and Natural Language Processing (NLP) techniques to read, process, and understand email content the way a human analyst might, yet in a fraction of the time and at a large scale. [Learn more](https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/microsoft-defender-for-office-365s-language-ai-for-phish-enhancing-email-securit/4410446)**\"},\"customWidth\":\"33\",\"name\":\"text - 13 - Copy - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Phish Detections - LLM Threat Classifications<br>\\r\\n\\r\\n**Microsoft Defender for Office 365 uses purpose-built Large Language Models (LLM) at scale to provide AI-powered email and collaboration security. Our solution now parses language to understand and identify attacker intent and classifies threats at machine speed  keeping malicious emails out of your inbox and giving security operations (SOC) teams a new level of insight into adversary techniques. [Learn more](https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/microsoft-ignite-redefining-email-security-with-llms-to-tackle-a-new-era-of-soci/4302421)**\"},\"customWidth\":\"33\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Top Attacked Users by LLM Threat classes (Phish)<br>\\r\\n\\r\\n**Displays recipients most frequently targeted by inbound phishing emails, grouped by threat classification (e.g., Gift Card, Invoice, Payroll). Helps identify users at higher risk for phishing attacks. These users may be at higher risk and should be prioritised for targeted cybersecurity awareness training. Training should cover the specific threat types and techniques they are exposed to, and reinforce best practices for promptly reporting any suspicious messages that might bypass security controls and reach their inbox.**\"},\"customWidth\":\"33\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of emails detected as Phish by LLM content analysis detection technology in Microsoft Defender for Office 365. \\r\\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \\\"//\\\" to apply the exclusion.\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where ThreatTypes has 'Phish' and DetectionMethods contains \\\"LLM content analysis\\\"\\r\\n| summarize count()\\r\\n| sort by count_ desc\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"stat\",\"statSettings\":{\"valueAggregation\":\"None\",\"colorSettings\":{\"type\":\"static\",\"mode\":\"background\",\"heatmapPalette\":\"greenRed\"},\"tagText\":\"\",\"valueFontStyle\":\"auto\",\"tagTextPosition\":\"bottom\"}},\"customWidth\":\"33\",\"name\":\"query - 12\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish detections summarizing the data by intent of the message.\\r\\n// Microsoft Defender for Office 365 LLM analysis is analyzing email messages to understand the intent of the messages. These threat classifications are then used in filtering decisions.\\r\\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \\\"//\\\" to apply the exclusion.\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where ThreatTypes has 'Phish' and ThreatClassification  has_any(\\\"Business intelligence\\\",\\\"Contact establishment\\\",\\\"Gift card\\\",\\\"Invoice\\\",\\\"Payroll\\\",\\\"PII gathering\\\",\\\"Task\\\")\\r\\n| summarize count() by ThreatClassification\\r\\n| sort by count_ desc\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"chartSettings\":{\"yAxis\":[\"count_\"],\"createOtherGroup\":10}},\"customWidth\":\"33\",\"name\":\"query - 10\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises Phish detections in emails summarizing by various Threat classes showing the top attacked user for each threat classification type.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where ThreatTypes has \\\"Phish\\\" and EmailDirection == \\\"Inbound\\\" and ThreatClassification has_any(\\\"Business intelligence\\\",\\\"Contact establishment\\\",\\\"Gift card\\\",\\\"Invoice\\\",\\\"Payroll\\\",\\\"PII gathering\\\",\\\"Task\\\")\\r\\n| summarize EmailCount=count() by ThreatClassification, RecipientEmailAddress\\r\\n| summarize Emails = arg_max(EmailCount, RecipientEmailAddress) by ThreatClassification\\r\\n| sort by Emails desc\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"}}],\"filter\":true}},\"customWidth\":\"33\",\"name\":\"query - 11\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"group - 5\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Phish Detections by Delivery location, Detection technology and Sender infrastructure insights\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and explain Phish detections delivery locations, detection technologies used for detections, sender infrastructure insights in inbound email identified by Microsoft Defender for Office 365 as Phish.\"},\"name\":\"text - 13 - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Phish Detections by delivery location<br>\\r\\n\\r\\n**Visualizes daily counts of Phish detections of inbound emails by various delivery locations: Quarantine, Junk folder or Failed (rejected with or without NDR)**\"},\"name\":\"text - 13 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish detections over time summarizing the data daily by Delivery Location.\\r\\n//The comment in the query excludes deliveries to the SecOps Mailboxes and by the Phish Simulation system. Remove the \\\"//\\\" to apply the exclusion.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where DetectionMethods has \\\"Phish\\\" and EmailDirection == \\\"Inbound\\\"\\r\\n| make-series TotalPhishDetections=count(),Quarantine=countif(DeliveryLocation == \\\"Quarantine\\\"),Junkfolder=countif(DeliveryLocation == \\\"Junk folder\\\") ,Inbox=countif(DeliveryLocation == \\\"Inbox/folder\\\"),Failed=countif(DeliveryLocation == \\\"Failed\\\"),Dropped=countif(DeliveryLocation == \\\"Dropped\\\") default = 0 on Timestamp step 1d \\r\\n\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Quarantine\",\"color\":\"greenDark\"},{\"seriesName\":\"Failed\",\"color\":\"green\"},{\"seriesName\":\"Dropped\",\"color\":\"green\"},{\"seriesName\":\"Junk folder\",\"color\":\"orangeDark\"},{\"seriesName\":\"Inbox\",\"color\":\"redBright\"}]}},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"query - 9\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Phish detections by Detection Technology<br>\\r\\n\\r\\n**Visualizes daily counts of Phish detections of inbound emails by various Microsoft Defender for Office 365 detection technologies.**\"},\"name\":\"text - 13 - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish detections over time summarizing the data daily by various Phish Detection technologies/controls in Microsoft Defender for Office 365.\\r\\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \\\"//\\\" to apply the exclusion.\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\nlet baseQuery = EmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where DetectionMethods has \\\"Phish\\\";\\r\\nlet llm=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'LLM content analysis'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"LLM content analysis\\\";\\r\\nlet ml=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Advanced filter'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Advanced filter\\\";\\r\\nlet camp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Campaign'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Campaign\\\";\\r\\nlet fd=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'File detonation' and Phish !has 'File detonation reputation'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"File detonation\\\";\\r\\nlet fdr=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'File detonation reputation'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"File detonation reputation\\\";\\r\\nlet frp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Fingerprint matching' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Fingerprint matching\\\";\\r\\nlet gf=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'General filter' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"General filter\\\";\\r\\nlet bimp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Impersonation brand' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Impersonation brand\\\";\\r\\nlet dimp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Impersonation domain' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Impersonation domain\\\";\\r\\nlet uimp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Impersonation user' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Impersonation user\\\";\\r\\nlet mimp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Mailbox intelligence impersonation' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Mailbox intelligence impersonation\\\";\\r\\nlet sdmarc=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Spoof DMARC' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Spoof DMARC\\\";\\r\\nlet spoofe=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Spoof external domain' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Spoof external domain\\\";\\r\\nlet spoofi=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Spoof intra-org' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Spoof intra-org\\\";\\r\\nlet ud=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'URL detonation' and Phish !has 'URL detonation reputation'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"URL detonation\\\";\\r\\nlet udr=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'URL detonation reputation' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"URL detonation reputation\\\";\\r\\nlet umr=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'URL malicious reputation' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"URL malicious reputation\\\";\\r\\nunion llm,ml,camp,fd,fdr,frp,gf,bimp,dimp,uimp,mimp,sdmarc,spoofe,spoofi,ud,udr,umr\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"createOtherGroup\":15}},\"customWidth\":\"66\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"query - 7\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish detections summarizing the data by various Phish detection technologies/controls in Microsoft Defender for Office 365.\\r\\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \\\"//\\\" to apply the exclusion.\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where ThreatTypes has 'Phish' \\r\\n| project Timestamp, DT=parse_json(DetectionMethods) \\r\\n| evaluate bag_unpack(DT) \\r\\n| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\\r\\n| sort by count_ desc\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Phish\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Detections\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"Phish\",\"yAxis\":[\"count_\"],\"createOtherGroup\":20}},\"customWidth\":\"33\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"query - 1\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Phish Detections by SenderIPv4 Geo Location<br>\\r\\n\\r\\n**Visualizes the email sending infrastructure sender IPv4 addresses associated with inbound emails detected as Phish, along with the IPv4 address geographic coordinates (latitude, longitude) and country information. Helps identify high-risk regions and sources for targeted threat mitigation.**\"},\"name\":\"text - 13 - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish detections summarizing the data by email sender IP address (SenderIPv4).\\r\\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \\\"//\\\" to apply the exclusion.\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\" \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where ThreatTypes has \\\"Phish\\\" and isnotempty(SenderIPv4)\\r\\n| summarize count() by SenderIPv4\\r\\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\\r\\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\\r\\n| project SenderIPv4, Latitude, Longitude, count_\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"SenderIPv4\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"query - 4\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish detections summarizing the data by email sender IP address and IP address country information (SenderIPv4).\\r\\nEmailEvents \\r\\n| where ThreatTypes has 'Phish' and isnotempty(SenderIPv4)\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\\r\\n| extend Country = tostring(GeoInfo.country)\\r\\n| summarize count() by Country\\r\\n| project Country, PhishEmailCount=count_\\r\\n| sort by PhishEmailCount desc\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"PhishEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}]},\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"SenderIPv4\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"query - 4 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"group - 25- Phish delivery locations-detecion tech-sender infra\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Phish Detections Top attacked users and top senders\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and explain phish detections in inbound email as identified by Microsoft Defender for Office 365 focusing on top attacked users and top senders.\"},\"name\":\"text - 13 - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Phish Detections top attacked users\\r\\n**Displays the top 10 recipient email addresses that received inbound emails flagged as Phish. These users may be at higher risk and should be prioritised for targeted cybersecurity awareness training. Training should cover the specific threat types and techniques they are exposed to, and reinforce best practices for promptly reporting any suspicious messages that might bypass security controls and reach their inbox.**\"},\"customWidth\":\"50\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Top 10 Sender Domains with Phish Detections (Inbound)\\r\\n**Displays the top 10 sender domains sending inbound emails detected as Phish. Helps identify external sources most frequently associated with malicious content for prioritised threat monitoring and mitigation.**\"},\"customWidth\":\"50\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total inbound emails with Phish detections summarizing the data by the top 10 recipient email address (RecipientEmailAddress).\\r\\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \\\"//\\\" to apply the exclusion.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where ThreatTypes has \\\"Phish\\\" and EmailDirection == \\\"Inbound\\\"\\r\\n| summarize count() by RecipientEmailAddress\\r\\n| sort by count_\\r\\n| top 10 by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"xAxis\":\"RecipientEmailAddress\",\"yAxis\":[\"count_\"],\"createOtherGroup\":10}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total inbound emails with Phish detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain).\\r\\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \\\"//\\\" to apply the exclusion.\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where ThreatTypes has \\\"Phish\\\" and EmailDirection == \\\"Inbound\\\"\\r\\n| summarize count() by SenderFromDomain\\r\\n| sort by count_\\r\\n| top 10 by count_\\r\\n\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"SenderFromDomain\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"SenderFromDomain\",\"yAxis\":[\"count_\"],\"createOtherGroup\":10}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"query - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total inbound emails with Phish detections summarizing the data by the top 15 recipient email address (RecipientEmailAddress).\\r\\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \\\"//\\\" to apply the exclusion.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmailCount=count(),PhishEmailCount = countif(ThreatTypes has \\\"Phish\\\") by RecipientEmailAddress\\r\\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(PhishEmailCount / todouble(TotalEmailCount), 2))\\r\\n| where PhishEmailCount !=0\\r\\n| sort by PhishEmailCount desc\\r\\n| project RecipientEmailAddress,PhishEmailCount, TotalEmailCount,Bad_Traffic_Percentage_Inbound\\r\\n| top 15 by PhishEmailCount\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"PhishEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Traffic_Percentage_Inbound\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"query - 18\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish detections summarizing the data by the top 15 email sender P2 domain (SenderFromDomain). Adding additional insights for total inbound emails and bad traffic percentage for each sender domain.\\r\\n//The comment in the query excludes deliveries to the SecOps Mailbox and by the Phish Simulation system. Remove the \\\"//\\\" to apply the exclusion.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| summarize TotalEmailCount = count(),\\r\\n            PhishEmailCount = countif(ThreatTypes has \\\"Phish\\\") by SenderFromDomain\\r\\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(PhishEmailCount / todouble(TotalEmailCount) * 100, 2))\\r\\n| where PhishEmailCount !=0\\r\\n| sort by PhishEmailCount desc \\r\\n| project SenderFromDomain,PhishEmailCount,TotalEmailCount,Bad_Traffic_Percentage_Inbound\\r\\n| top 15 by PhishEmailCount\\r\\n\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"PhishEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Traffic_Percentage_Inbound\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"BadEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"query - 18\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"group - 26-PhishDetectionsTopattackedusers-topsenders\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"# Spam Detection Insights\\r\\n\\r\\n---\\r\\nThis tab provides insights into email message **detections** by Microsoft Defender for Office 365 where the message contained a **Spam threat** within its **email content**, **URLs**, or **attachments**.\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"4\"},\"name\":\"text - 24 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Spam Detection Effectiveness and Trends\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and explain Spam detections in inbound email as identified by Microsoft Defender for Office 365 focusing on Effectiveness and daily trend. For effectiveness, we consider messages reported by your admins and decisions made post-delivery.\"},\"name\":\"text - 13 - Copy\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query calculates the effectiveness of spam detections without edge data.\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\n// baseQuery _FN_Admin_Submissions_SPM\\r\\nlet _FN_Admin_Submissions_SPM = toscalar(\\r\\nCloudAppEvents\\r\\n| where Timestamp between (minTime .. maxTime)\\r\\n| where ActionType == \\\"AdminSubmissionSubmitted\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType)\\r\\n| extend NetworkMessageId = tostring((parse_json(RawEventData)).ObjectId)\\r\\n| where SubmissionType in (\\\"3\\\")\\r\\n| summarize count()\\r\\n);\\r\\n// baseQuery _FN_ZAP_Successful_Spam\\r\\nlet _FN_ZAP_Successful_Spam = toscalar(\\r\\nEmailPostDeliveryEvents\\r\\n| where ActionTrigger == \\\"SpecialAction\\\" and ActionType == \\\"Spam ZAP\\\" and ActionResult == \\\"Success\\\" and Timestamp between (minTime .. maxTime)\\r\\n| summarize count()\\r\\n    //Take all our Spam ZAP, and count how many messages we missed and successfully cleaned up.\\r\\n);\\r\\n// baseQuery _FN_ZAP_Unsuccessful_Spam\\r\\nlet _FN_ZAP_Unsuccessful_Spam = toscalar(\\r\\nEmailPostDeliveryEvents\\r\\n| where ActionTrigger == \\\"SpecialAction\\\" and ActionType == \\\"Spam ZAP\\\" and ActionResult != \\\"Success\\\"\\r\\n| summarize count()\\r\\n//Take all our Spam ZAP, and count how many messages we failed to clean up due to error or users/admins/API vendors getting to the message first.\\r\\n);\\r\\n// baseQuery _SPAM_ZAP_FP\\r\\nlet _SPAM_ZAP_FP = toscalar(\\r\\nEmailPostDeliveryEvents\\r\\n| where ActionTrigger == \\\"SpecialAction\\\" and ActionType == \\\"Redelivery\\\" and Timestamp between (minTime .. maxTime)\\r\\n| join kind=leftsemi (\\r\\n            EmailEvents\\r\\n            | where Timestamp between (minTime ..maxTime )\\r\\n            | where ThreatTypes contains \\\"Spam\\\"\\r\\n            | project NetworkMessageId, ThreatTypes)\\r\\n            on NetworkMessageId\\r\\n| summarize count()\\r\\n// count all the FPs which were originally Spam, and when we TT'd them were not so we can subtract that from our mailfow catch, and therefore the total true bad.\\r\\n);\\r\\n// baseQuery _Spam_Mailflow\\r\\nlet _Spam_Mailflow = toscalar(\\r\\nEmailEvents\\r\\n| where EmailDirection == \\\"Inbound\\\" and ThreatTypes == \\\"Spam\\\" and Timestamp between (minTime .. maxTime)\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize count()\\r\\n// Get all the mailflow detected as SPM, then count all the NMIDs (not distinct)\\r\\n);\\r\\nprint\\r\\nEffectiveness_PostDelivery = abs(round(((toreal(toscalar(_FN_Admin_Submissions_SPM))+toreal(toscalar(_FN_ZAP_Unsuccessful_Spam)))/(toreal(toscalar(_Spam_Mailflow))+toreal(toscalar(_FN_ZAP_Successful_Spam))+toreal(toscalar(_FN_ZAP_Unsuccessful_Spam))+toreal(toscalar(_FN_Admin_Submissions_SPM))-toreal(toscalar(_SPAM_ZAP_FP)))*100-100),2))\",\"size\":1,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"stat\",\"statSettings\":{\"valueAggregation\":\"None\",\"colorSettings\":{\"type\":\"thresholds\",\"mode\":\"foreground\",\"heatmapPalette\":\"greenRed\",\"thresholdsGrid\":[{\"operator\":\">\",\"thresholdValue\":\"95\",\"representation\":\"green\"},{\"operator\":\"<=\",\"thresholdValue\":\"95\",\"representation\":\"orange\"},{\"operator\":\"<=\",\"thresholdValue\":\"90\",\"representation\":\"red\"}]},\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}},\"tagText\":\"Spam Effectiveness (without Edge data)\",\"valueFontStyle\":\"superLarge\",\"tagTextPosition\":\"bottom\"}},\"customWidth\":\"50\",\"name\":\"query - 11\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\n// baseQuery _FN_Admin_Submissions_SPM\\r\\nlet _FN_Admin_Submissions_SPM = toscalar(\\r\\nCloudAppEvents\\r\\n| where Timestamp between (minTime .. maxTime)\\r\\n| where ActionType == \\\"AdminSubmissionSubmitted\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType)\\r\\n| extend NetworkMessageId = tostring((parse_json(RawEventData)).ObjectId)\\r\\n| where SubmissionType in (\\\"3\\\")\\r\\n| summarize count()\\r\\n);\\r\\n// baseQuery _FN_ZAP_Successful_Spam\\r\\nlet _FN_ZAP_Successful_Spam = toscalar(\\r\\nEmailPostDeliveryEvents\\r\\n| where ActionTrigger == \\\"SpecialAction\\\" and ActionType == \\\"Spam ZAP\\\" and ActionResult == \\\"Success\\\" and Timestamp between (minTime .. maxTime)\\r\\n| summarize count()\\r\\n    //Take all our Spam ZAP, and count how many messages we missed and successfully cleaned up.\\r\\n);\\r\\n// baseQuery _FN_ZAP_Unsuccessful_Spam\\r\\nlet _FN_ZAP_Unsuccessful_Spam = toscalar(\\r\\nEmailPostDeliveryEvents\\r\\n| where ActionTrigger == \\\"SpecialAction\\\" and ActionType == \\\"Spam ZAP\\\" and ActionResult != \\\"Success\\\"\\r\\n| summarize count()\\r\\n//Take all our Spam ZAP, and count how many messages we failed to clean up due to error or users/admins/API vendors getting to the message first.\\r\\n);\\r\\n// baseQuery _SPAM_ZAP_FP\\r\\nlet _SPAM_ZAP_FP = toscalar(\\r\\nEmailPostDeliveryEvents\\r\\n| where ActionTrigger == \\\"SpecialAction\\\" and ActionType == \\\"Redelivery\\\" and Timestamp between (minTime .. maxTime)\\r\\n| join kind=leftsemi (\\r\\n            EmailEvents\\r\\n            | where Timestamp between (minTime ..maxTime )\\r\\n            | where ThreatTypes contains \\\"Spam\\\"\\r\\n            | project NetworkMessageId, ThreatTypes)\\r\\n            on NetworkMessageId\\r\\n| summarize count()\\r\\n// count all the FPs which were originally Spam, and when we TT'd them were not so we can subtract that from our mailfow catch, and therefore the total true bad.\\r\\n);\\r\\n// baseQuery _Spam_Mailflow\\r\\nlet _Spam_Mailflow = toscalar(\\r\\nEmailEvents\\r\\n| where EmailDirection == \\\"Inbound\\\" and ThreatTypes == \\\"Spam\\\" and Timestamp between (minTime .. maxTime)\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize count()\\r\\n// Get all the mailflow detected as SPM, then count all the NMIDs (not distinct)\\r\\n);\\r\\nprint StatisticName=\\\"Spam Mailflow Minus FPs\\\", Value=toreal((toscalar(_Spam_Mailflow)) - toreal(toscalar(_SPAM_ZAP_FP)))\\r\\n| union (print StatisticName=\\\"Spam Admin FNs Submitted\\\", Value=toreal(toscalar(_FN_Admin_Submissions_SPM)))\\r\\n| union (print StatisticName=\\\"Spam FPs Reverse Zapped\\\", Value=toreal(toscalar(_SPAM_ZAP_FP)))\\r\\n| union (print StatisticName=\\\"Spam Zapped Sucessfully\\\", Value=toreal(toscalar(_FN_ZAP_Successful_Spam)))\\r\\n| union (print StatisticName=\\\"Spam NotZapped\\\", Value=toreal(toscalar(_FN_ZAP_Unsuccessful_Spam)))\\r\\n| union (print StatisticName=\\\"Spam Effectiveness Post Delivery %\\\", Value=abs(round(((toreal(toscalar(_FN_Admin_Submissions_SPM)) + toreal(toscalar(_FN_ZAP_Unsuccessful_Spam))) / (toreal(toscalar(_Spam_Mailflow)) + toreal(toscalar(_FN_ZAP_Successful_Spam)) + toreal(toscalar(_FN_ZAP_Unsuccessful_Spam)) + toreal(toscalar(_FN_Admin_Submissions_SPM)) - toreal(toscalar(_SPAM_ZAP_FP)))) * 100 - 100, 2)))\\r\\n| union (print StatisticName=\\\"Spam Effectiveness Pre-Delivery %\\\", Value=abs(round(((toreal(toscalar(_FN_Admin_Submissions_SPM)) + toreal(toscalar(_FN_ZAP_Unsuccessful_Spam)) + (toscalar(_FN_ZAP_Successful_Spam))) / (toreal(toscalar(_Spam_Mailflow)) + toreal(toscalar(_FN_ZAP_Successful_Spam)) + toreal(toscalar(_FN_ZAP_Unsuccessful_Spam)) + toreal(toscalar(_FN_Admin_Submissions_SPM)) - toreal(toscalar(_SPAM_ZAP_FP)))) * 100 - 100, 2 )))\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"StatisticName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Value\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 12\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"customWidth\":\"100\",\"name\":\"Spam Effectiveness\"},{\"type\":1,\"content\":{\"json\":\"### Spam Detection Trend<br>\\r\\n\\r\\n**This visual displays a daily trend of email Spam detections identified by Microsoft Defender for Office 365. The line chart summarises the number of messages flagged for Spam threats.**\"},\"name\":\"text - 13 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Spam detections over time summarizing the data daily.\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| where ThreatTypes has \\\"Spam\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| make-series Count = count() default = 0 on Timestamp step 1d \\r\\n| extend Details = \\\"SpamDetections\\\";\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Emails\",\"color\":\"redDark\"}]}},\"customWidth\":\"100\",\"name\":\"query - 13\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"4\"},\"name\":\"group - 6-Spam-detections-trend\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Spam Detections by Delivery location, Detection technology, Sender infrastructure and Bulk insights\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and explain Spam detections delivery locations, detection technologies used for detections, sender infrastructure and Bulk insights in inbound email identified by Microsoft Defender for Office 365 as Spam.\"},\"name\":\"text - 13 - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Spam Detections by delivery location<br>\\r\\n\\r\\n**Visualizes daily counts of Spam detections of inbound emails by various delivery locations Quarantine, Junk folder or Failed (rejected with or without NDR)**\"},\"name\":\"text - 13 - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Spam detections over time summarizing the data daily by Delivery Location.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where DetectionMethods has \\\"Spam\\\" and EmailDirection == \\\"Inbound\\\"\\r\\n| make-series TotalSpamDetections=count(),Quarantine = countif(DeliveryLocation == \\\"Quarantine\\\"),Junkfolder=countif(DeliveryLocation == \\\"Junk folder\\\") ,Inbox=countif(DeliveryLocation == \\\"Inbox/folder\\\"),Failed=countif(DeliveryLocation == \\\"Failed\\\"),Dropped=countif(DeliveryLocation == \\\"Dropped\\\") default = 0 on Timestamp step 1d \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"TotalSpamDetections\",\"color\":\"blue\"},{\"seriesName\":\"Quarantine\",\"color\":\"greenDark\"},{\"seriesName\":\"Junkfolder\",\"color\":\"orangeDark\"},{\"seriesName\":\"Inbox\",\"color\":\"redBright\"},{\"seriesName\":\"Failed\",\"color\":\"red\"},{\"seriesName\":\"Dropped\",\"color\":\"redDark\"}]}},\"customWidth\":\"100\",\"name\":\"query - 8\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Spam Detections Detection Technology<br>\\r\\n\\r\\n**Visualizes daily counts of Spam detections of inbound emails by various Microsoft Defender for Office 365 detection technologies.**\"},\"name\":\"text - 13 - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Spam detections over time summarizing the data daily by various Spam Detection technologies/controls in Microsoft Defender for Office 365.\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\nlet baseQuery = EmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| where DetectionMethods has \\\"Spam\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key;\\r\\nlet mailbombing=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'Mail bombing'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Mail bombing\\\";\\r\\nlet ml=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'Advanced filter'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Advanced filter\\\";\\r\\nlet gf=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'General filter'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"General filter\\\";\\r\\nlet bl=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'BulkFilter'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"BulkFilter\\\";\\r\\nlet mx=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'Mixed analysis detection'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Mixed analysis detection\\\";\\r\\nlet frp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'Fingerprint matching'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Fingerprint matching\\\";\\r\\nlet umr=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'URL malicious reputation' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"URL malicious reputation\\\";\\r\\nlet dr=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'Domain reputation' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Domain reputation\\\";\\r\\nlet ipr=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'IP reputation' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"IP reputation\\\";\\r\\nunion ml,gf,bl,mx,frp,umr,dr,ipr,mailbombing\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"66\",\"name\":\"query - 7\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Spam detections summarizing the data by various Spam detection technologies/controls in Microsoft Defender for Office 365.\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| where DetectionMethods has 'Spam' \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| project Timestamp, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) | summarize count() by Spam=tostring(column_ifexists('Spam', ''))\\r\\n| sort by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"xAxis\":\"Spam\",\"yAxis\":[\"count_\"],\"createOtherGroup\":8}},\"customWidth\":\"33\",\"name\":\"query - 15\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Spam Detections by SenderIPv4 Geo Location<br>\\r\\n\\r\\n**Visualizes the email sending infrastructure sender IPv4 addresses associated with inbound emails detected as Spam, along with the IPv4 address geographic coordinates (latitude, longitude) and country information. Helps identify high-risk regions and sources for targeted threat mitigation.**\"},\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Spam detections summarizing the data by email sender IP address (SenderIPv4).\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| where ThreatTypes has \\\"Spam\\\" and isnotempty(SenderIPv4)\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize count() by SenderIPv4\\r\\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\\r\\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\\r\\n| project SenderIPv4, Latitude, Longitude, count_  \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"LatLong\",\"locInfoColumn\":\"SenderIPv4\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"SenderIPv4\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"name\":\"query - 14\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish detections summarizing the data by email sender IP address and IP address country information (SenderIPv4).\\r\\nEmailEvents \\r\\n| where ThreatTypes has 'Spam' and isnotempty(SenderIPv4)\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\\r\\n| extend Country = tostring(GeoInfo.country)\\r\\n| summarize count() by Country\\r\\n| project Country, SpamEmailCount=count_\\r\\n| sort by SpamEmailCount desc\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SpamEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}]},\"mapSettings\":{\"locInfo\":\"LatLong\",\"locInfoColumn\":\"SenderIPv4\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"SenderIPv4\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"name\":\"query - 14 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Spam Detections Bulk Insights<br>\\r\\n\\r\\n**Displays the distribution of inbound emails across different Bulk Complaint Levels together with Top 10 domains sending Bulk email (grey mail). Helps identify patterns in bulk email complaints and assess potential spam or unwanted message trends.**\"},\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total inbound emails which has any Bulk complaint level. It is summarizing the data by the various Bulk Complaint levels to understand how many messages are detected with each Bulk Complaint level.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where EmailDirection == \\\"Inbound\\\" and BulkComplaintLevel !=\\\"\\\"\\r\\n| summarize count() by BulkComplaintLevel\\r\\n| sort by BulkComplaintLevel desc\\r\\n| project BulkComplaintLevel,Emails=count_\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blueDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}]}},\"customWidth\":\"50\",\"name\":\"query - 9\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total inbound emails which has any Bulk complaint level. It is summarizing the data by the various Bulk Complaint levels and SenderFromDomain of the email sender. It provides insights how many messages are detected with each Bulk Complaint level for each sender domain.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where EmailDirection == \\\"Inbound\\\" and BulkComplaintLevel !=\\\"\\\"\\r\\n| summarize count() by BulkComplaintLevel, SenderFromDomain\\r\\n| sort by count_ desc\\r\\n| project SenderFromDomain,BulkComplaintLevel,Emails=count_\\r\\n| take 10\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 10\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"4\"},\"name\":\"group - 28-Spam-Delivery location-Detection technology-Sender infrastructure insights\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"\\r\\n<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Spam Detections Top attacked users and top senders\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and explain spam detections in inbound email as identified by Microsoft Defender for Office 365 focusing on top attacked users and top senders.\"},\"name\":\"text - 13 - Copy - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Spam Detections top attacked users<br>\\r\\n\\r\\n**Displays the top 10 recipient email addresses that received inbound emails flagged as Spam. These users may be at higher risk and should be prioritised for targeted cybersecurity awareness training. Training should cover the specific threat types and techniques they are exposed to, and reinforce best practices for promptly reporting any suspicious messages that might bypass security controls and reach their inbox.**\"},\"customWidth\":\"50\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Sender Domains with Spam Detections (Inbound)<br>\\r\\n\\r\\n**Displays the top 10 sender domains sending inbound emails detected as Spam. Helps identify external sources most frequently associated with spam content for prioritised monitoring and mitigation.**\"},\"customWidth\":\"50\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total inbound emails with Spam detections summarizing the data by the top 10 recipient email address (RecipientEmailAddress).\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| where ThreatTypes has \\\"Spam\\\" and EmailDirection ==\\\"Inbound\\\" \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize count() by RecipientEmailAddress \\r\\n| sort by count_ desc\\r\\n| take 10\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"group\":\"RecipientEmailAddress\",\"createOtherGroup\":10}},\"customWidth\":\"50\",\"name\":\"query - 17 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total inbound emails with Spam detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain).\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| where ThreatTypes has \\\"Spam\\\" and EmailDirection ==\\\"Inbound\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize count() by SenderFromDomain\\r\\n| sort by count_ desc \\r\\n| take 10\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"group\":\"SenderFromDomain\",\"createOtherGroup\":10}},\"customWidth\":\"50\",\"name\":\"query - 17\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total inbound emails with Spam detections summarizing the data by the top 15 recipient email address (RecipientEmailAddress).\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| where EmailDirection ==\\\"Inbound\\\" \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmailCount=count(),SpamEmailCount = countif(ThreatTypes has \\\"Spam\\\") by RecipientEmailAddress\\r\\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(SpamEmailCount / todouble(TotalEmailCount)* 100, 2))\\r\\n| where SpamEmailCount !=0\\r\\n| sort by SpamEmailCount desc\\r\\n| project RecipientEmailAddress,SpamEmailCount, TotalEmailCount,Bad_Traffic_Percentage_Inbound\\r\\n| top 15 by SpamEmailCount\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SpamEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Traffic_Percentage_Inbound\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":false}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 18 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total inbound emails with Spam detections summarizing the data by the top 15 email sender P2 domain (SenderFromDomain). Adding additional insights for total inbound emails and bad traffic percentage for each sender domain.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmailCount = count(),\\r\\n            SpamEmailCount = countif(ThreatTypes has \\\"Spam\\\") by SenderFromDomain\\r\\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(SpamEmailCount / todouble(TotalEmailCount) * 100, 2))\\r\\n| where SpamEmailCount !=0\\r\\n| sort by SpamEmailCount desc \\r\\n| project SenderFromDomain,SpamEmailCount,TotalEmailCount,Bad_Traffic_Percentage_Inbound\\r\\n| top 15 by SpamEmailCount\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SpamEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Traffic_Percentage_Inbound\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 18\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"4\"},\"name\":\"group - 29-Spam Detections Top attacked users and top senders\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Phish Detections Business Email Compromise (BEC) detections\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and explain phish detections in inbound email as identified by Microsoft Defender for Office 365 focusing on Business Email Compromise (BEC) detections Impersonation and Spoof.\"},\"name\":\"text - 13 - Copy - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Phish Detections - Impersonation detections Trend\\r\\n**Displays daily counts of inbound emails flagged for Business Email Compromise (BEC) using Impersonation detection methods by Microsoft Defender for Office 365. Helps track impersonation attack patterns over time.**\"},\"customWidth\":\"100\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish  Business Email Compromise (BEC)  Impersonation detections over time summarizing the data daily.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where DetectionMethods has 'Impersonation' \\r\\n| make-series Count = count() default = 0 on Timestamp step 1d \\r\\n| extend Details = \\\"ImpersonatedEmails\\\";\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"100\",\"name\":\"query - 5\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Phish Detections - Impersonation detections by Detection Technology\\r\\n**Visualizes daily counts of Phish detections of inbound emails by various Microsoft Defender for Office 365 detection technologies used for detecting Impersonations.**\"},\"customWidth\":\"100\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish  Business Email Compromise (BEC)  Impersonation detections over time summarizing the data daily by various Impersonation Detection technologies/controls in Microsoft Defender for Office 365.\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\nlet baseQuery = EmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where DetectionMethods has \\\"Phish\\\";\\r\\nlet bimp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Impersonation brand' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Impersonation brand\\\";\\r\\nlet dimp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Impersonation domain' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Impersonation domain\\\";\\r\\nlet uimp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Impersonation user' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Impersonation user\\\";\\r\\nlet mimp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Mailbox intelligence impersonation' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Mailbox intelligence impersonation\\\";\\r\\nunion bimp,dimp,uimp,mimp\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"66\",\"name\":\"query - 7\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish  Business Email Compromise (BEC)  Impersonation detections summarizing the data by various Impersonation detection technologies/controls in Microsoft Defender for Office 365.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where DetectionMethods has 'Impersonation' \\r\\n| project Timestamp, DT=parse_json(DetectionMethods) \\r\\n| evaluate bag_unpack(DT) \\r\\n| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\\r\\n| sort by count_ desc\\r\\n\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0}},\"customWidth\":\"33\",\"name\":\"query - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"### Phish Detections - Impersonation detections by SenderIPv4 Geo Location\\r\\n**Visualizes the email sending infrastructure sender IPv4 addresses associated with inbound emails detected as Phish - Impersonation, along with the IPv4 address geographic coordinates (latitude, longitude) and country information. Helps identify high-risk regions and sources for targeted threat mitigation.**\"},\"customWidth\":\"100\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish  Business Email Compromise (BEC)  Impersonation detections summarizing the data by email sender IP address (SenderIPv4).\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where DetectionMethods contains 'Impersonation' and isnotempty(SenderIPv4)\\r\\n//| project Timestamp, EmailDirection, SenderFromAddress, AdditionalFields, SenderIPv4 \\r\\n| summarize count()by SenderIPv4\\r\\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\\r\\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\\r\\n| project SenderIPv4, Latitude, Longitude, count_  \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"SenderIPv4\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"name\":\"query - 6\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish detections summarizing the data by email sender IP address and IP address country information (SenderIPv4).\\r\\nEmailEvents \\r\\n| where DetectionMethods contains 'Impersonation' and isnotempty(SenderIPv4)\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\\r\\n| extend Country = tostring(GeoInfo.country)\\r\\n| summarize count() by Country\\r\\n| project Country, PhishImpersonationEmailCount=count_\\r\\n| sort by PhishImpersonationEmailCount desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Impersonation Detections-Sender Heatmap (IPv4)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"PhishImpersonationEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}]},\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"SenderIPv4\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"name\":\"query - 6 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Phish Detections - Spoof detections Trend\\r\\n**Displays daily counts of inbound emails flagged for Business Email Compromise (BEC) using Spoof detection methods by Microsoft Defender for Office 365. Helps track Spoofing based attack patterns over time.**\"},\"customWidth\":\"100\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish  Business Email Compromise (BEC)  Spoof detections over time summarizing the data daily.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where DetectionMethods has 'Spoof' \\r\\n| make-series Count = count() default = 0 on Timestamp step 1d \\r\\n| extend Details = \\\"SpoofEmails\\\";\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"100\",\"name\":\"query - 0\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Phish Detections - Spoof detections Trend by Detection Technology\\r\\n**Visualizes daily counts of Phish detections of inbound emails by various Microsoft Defender for Office 365 detection technologies used for detecting Spoofing.**\"},\"customWidth\":\"100\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish  Business Email Compromise (BEC)  Spoof detections over time summarizing the data daily by various Spoof Detection technologies/controls in Microsoft Defender for Office 365.\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\nlet baseQuery = EmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where DetectionMethods has \\\"Phish\\\";\\r\\nlet sdmarc=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Spoof DMARC' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Spoof DMARC\\\";\\r\\nlet spoofe=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Spoof external domain' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Spoof external domain\\\";\\r\\nlet spoofi=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Spoof intra-org' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Spoof intra-org\\\";\\r\\nunion sdmarc, spoofe, spoofi\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"yAxis\":[\"Count\"],\"seriesLabelSettings\":[{\"seriesName\":\"[\\\"Spoof external domain\\\"]\",\"color\":\"redDark\"},{\"seriesName\":\"[\\\"Spoof intra-org\\\"]\",\"color\":\"orangeDark\"},{\"seriesName\":\"[\\\"Spoof DMARC\\\"]\",\"color\":\"yellowDark\"}]}},\"customWidth\":\"66\",\"name\":\"query - 20\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish  Business Email Compromise (BEC)  Spoof detections detections summarizing the data by various Spoof detection technologies/controls in Microsoft Defender for Office 365.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where DetectionMethods has 'Spoof' \\r\\n| project Timestamp, DT=parse_json(DetectionMethods) \\r\\n| evaluate bag_unpack(DT) \\r\\n| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\\r\\n| sort by count_ desc\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"xAxis\":\"Phish\",\"yAxis\":[\"count_\"]}},\"customWidth\":\"33\",\"name\":\"query - 1\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"### Phish Detections - Spoof detections by SenderIPv4 Geo Location\\r\\n**Visualizes the email sending infrastructure sender IPv4 addresses associated with inbound emails detected as Phish - Spoofing, along with the IPv4 address geographic coordinates (latitude, longitude) and country information. Helps identify high-risk regions and sources for targeted threat mitigation.**\"},\"customWidth\":\"100\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish  Business Email Compromise (BEC)  Spoof detections summarizing the data by email sender IP address (SenderIPv4).\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where DetectionMethods contains 'spoof' and isnotempty(SenderIPv4)\\r\\n//| project Timestamp, EmailDirection, SenderFromAddress, AdditionalFields, SenderIPv4 \\r\\n| summarize count()by SenderIPv4\\r\\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\\r\\n| extend Latitude = tostring(GeoInfo.latitude), Longitude = tostring(GeoInfo.longitude)\\r\\n| project SenderIPv4, Latitude, Longitude, count_  \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"SenderIPv4\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"15px\",\"padding\":\"15px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish detections summarizing the data by email sender IP address and IP address country information (SenderIPv4).\\r\\nEmailEvents \\r\\n| where DetectionMethods contains 'Spoof' and isnotempty(SenderIPv4)\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend GeoInfo = geo_info_from_ip_address(SenderIPv4)\\r\\n| extend Country = tostring(GeoInfo.country)\\r\\n| summarize count() by Country\\r\\n| project Country, PhishSpoofEmailCount=count_\\r\\n| sort by PhishSpoofEmailCount desc\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"PhishSpoofEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}]},\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"SenderIPv4\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"name\":\"query - 3 - Copy\",\"styleSettings\":{\"margin\":\"15px\",\"padding\":\"15px\"}},{\"type\":1,\"content\":{\"json\":\"### Phish Detections - Top Outbound Recipient Domains with Inbound Threat Correlation (Possible Partner compromise)\\r\\n**Visualizes the domains most frequently targeted by outbound emails and correlates them with inbound emails carrying threats from the same domains in Inbound emails. Helps identify risky communication channels and potential compromise points.**\"},\"customWidth\":\"100\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises top outbound recipient domains by outbound email volume and shows total number of inbound emails with Threats from the same domains (as inbound senders) \\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where EmailDirection == \\\"Outbound\\\"\\r\\n| project RecipientDomain = tostring(split(RecipientEmailAddress, \\\"@\\\")[1])\\r\\n| summarize count() by RecipientDomain\\r\\n| project OutboundCount=count_, RecipientDomain, SenderFromDomain=RecipientDomain\\r\\n| join (EmailEvents | where EmailDirection == \\\"Inbound\\\" and isempty(ThreatTypes)==false) on SenderFromDomain\\r\\n| summarize max(OutboundCount),count() by SenderFromDomain\\r\\n| project SenderFromDomain, OutboundEmails=max_OutboundCount, IncomingEmailsWithThreats=count_\\r\\n| extend Bad_Traffic_Percentage = todouble(round(IncomingEmailsWithThreats / todouble(OutboundEmails), 2))\\r\\n| project SenderFromDomain, OutboundEmails, IncomingEmailsWithThreats, Bad_Traffic_Percentage\\r\\n| sort by OutboundEmails\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"OutboundEmails\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"IncomingEmailsWithThreats\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"60ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Traffic_Percentage\",\"formatter\":0,\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"100\",\"name\":\"query - 8\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"group - 7 - Phish-BEC-Insights\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Phish Detections Sender Authentication details (DMARC, DKIM, SPF, CompAuth)\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and explain Sender Authentication checks details in inbound email by Microsoft Defender for Office 365 focusing on the various Sender Authentication standards: DMARC, DKIM, SPF, CompAuth.\"},\"name\":\"text - 13 - Copy - Copy - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Phish Detections Sender Authentication Trend (DMARC, DKIM, SPF, CompAuth)\\r\\n**Shows daily counts of sender authentication check outcomes (DMARC, DKIM, SPF, CompAuth) performed by Microsoft Defender for Office 365 on inbound emails. Useful for monitoring authentication success and failure patterns over time to identify anomalies or potential phishing risks.**\"},\"customWidth\":\"100\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Spoof- DMARC fails summarizing the data daily.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend DMARCFail = AuthenticationDetails has_any ('DMARC\\\":\\\"fail') \\r\\n| summarize DMARCFail = sum(DMARCFail) by bin (Timestamp,1d)\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"DMARCFail\",\"color\":\"orangeDark\"}]}},\"customWidth\":\"50\",\"name\":\"query - 22\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Spoof- DKIM fails summarizing the data daily.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend DKIMFail = AuthenticationDetails has_any ('DKIM\\\":\\\"fail') \\r\\n| summarize DKIMCFail = sum(DKIMFail) by bin (Timestamp,1d)\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"DKIMCFail\",\"color\":\"yellowDark\"}]}},\"customWidth\":\"50\",\"name\":\"query - 24\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Spoof- SPF fails summarizing the data daily.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend SPFFail = AuthenticationDetails has_any ('SPF\\\":\\\"fail') \\r\\n| summarize SPFFail = sum(SPFFail) by bin (Timestamp,1d)\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"SPFFail\",\"color\":\"purpleDark\"}]}},\"customWidth\":\"50\",\"name\":\"query - 23\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Spoof- Composite Authentication fails summarizing the data daily.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend CompAuthFail = AuthenticationDetails has_any ('CompAuth\\\":\\\"fail') \\r\\n| summarize CompAuthFail = sum(CompAuthFail) by bin (Timestamp,1d)\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"CompAuthFail\",\"color\":\"blueDark\"}]}},\"customWidth\":\"50\",\"name\":\"query - 21\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Phish Detections Top Sender Domains with DMARC Failures (Inbound)\\r\\n**Displays the top 10 sender domains (P1 and P2) for inbound emails where Spoof-DMARC detection triggered. Includes total inbound email volume and calculates DMARC fail traffic percentage per domain to highlight high-risk sources.**\"},\"customWidth\":\"100\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Spoof-DMARC fails detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain) and sender P1 domain (SenderMailFromDomain). Adding additional insights for total inbound emails and DMARC fail traffic percentage for each sender domain.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| summarize TotalEmailCount = count(),\\r\\n            DMARCFailCount = countif(DetectionMethods has_any ('Phish\\\":[\\\"Spoof DMARC\\\"]')) by P1Sender=SenderMailFromDomain, P2Sender=SenderFromDomain\\r\\n| extend DMARCFail_Traffic_Percentage = todouble(round(DMARCFailCount / todouble(TotalEmailCount) * 100, 2))\\r\\n| where DMARCFailCount !=0\\r\\n| sort by DMARCFailCount desc \\r\\n| project P1Sender,P2Sender,DMARCFailCount,TotalEmailCount,DMARCFail_Traffic_Percentage\\r\\n| top 10 by DMARCFailCount\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DMARCFail\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"DMARCFail_Traffic_Percentage\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"100\",\"name\":\"query - 26\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Phish Detections Top Sender Domains with Spoof External Domain Detections (Inbound)\\r\\n**Displays the top 10 sender domains (P1 and P2) for inbound emails flagged for Spoof External Domain detection. Includes total inbound email volume and calculates spoof traffic percentage per domain to highlight high-risk sources.**\"},\"customWidth\":\"50\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Phish Detections Top Sender Domains with Spoof Internal Domain Detections (Inbound)\\r\\n**Displays the top 10 sender domains (P1 and P2) for inbound emails flagged for Spoof Internal Domain detection. Includes total inbound email volume and calculates spoof traffic percentage per domain to highlight high-risk sources.**\"},\"customWidth\":\"50\",\"name\":\"text - 14 - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish-Spoof-external domain detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain) and sender P1 domain (SenderMailFromDomain). Adding additional insights for total inbound emails and Spoof external domain detection traffic percentage for each sender domain.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| summarize TotalEmailCount = count(),\\r\\n            SpoofExternalCount = countif(DetectionMethods has_any ('Phish\\\":[\\\"Spoof external domain\\\"]')) by P1Sender=SenderMailFromDomain, P2Sender=SenderFromDomain\\r\\n| extend SpoofExternal_Traffic_Percentage = todouble(round(SpoofExternalCount / todouble(TotalEmailCount) * 100, 2))\\r\\n| where SpoofExternalCount !=0\\r\\n| sort by SpoofExternalCount desc \\r\\n| project P1Sender,P2Sender,SpoofExternalCount,TotalEmailCount,SpoofExternal_Traffic_Percentage\\r\\n| top 10 by SpoofExternalCount\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SpoofExternalCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"SpoofExternal_Traffic_Percentage\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"SpoofExternalFail\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 26 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Phish-Spoof-internal domain detections summarizing the data by the top 10 email sender P2 domain (SenderFromDomain) and sender P1 domain (SenderMailFromDomain). Adding additional insights for total inbound emails and Spoof internal domain detection traffic percentage for each sender domain.\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| summarize TotalEmailCount = count(),\\r\\n            SpoofInternalCount = countif(DetectionMethods has_any ('Phish\\\":[\\\"Spoof intra-org\\\"]')) by P1Sender=SenderMailFromDomain, P2Sender=SenderFromDomain\\r\\n| extend SpoofInternal_Traffic_Percentage = todouble(round(SpoofInternalCount / todouble(TotalEmailCount) * 100, 2))\\r\\n| where SpoofInternalCount !=0\\r\\n| sort by SpoofInternalCount desc \\r\\n| project P1Sender,P2Sender,SpoofInternalCount,TotalEmailCount,SpoofInternal_Traffic_Percentage\\r\\n| top 10 by SpoofInternalCount\",\"size\":3,\"showAnalytics\":true,\"title\":\"Top 10 Spoof intra-org detections by Sender domain (P1/P2)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SpoofInternalCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"SpoofInternal_Traffic_Percentage\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"SpoofIntraorgFail\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 26 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"3\"},\"name\":\"group - 8-Phish-SenderAuth\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"# URL Detections and URL Click Insights\\r\\n\\r\\n---\\r\\nThis tab provides insights into **URL-based detections** in email messages and details about URL clicks performed by end users on URLs identified as **malicious**.\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"5\"},\"name\":\"text - 24 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Insights on URL-Based Threat Detections\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and explain URL based threat detections in inbound email as identified by Microsoft Defender for Office 365 focusing on daily trends of URL-based threat detections, QR code detections, and URL scans activity by locations.\"},\"name\":\"text - 13 - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Trend of URL-Based Malware Threat Detections<br>\\r\\n\\r\\n**This visual displays a daily trend of emails with URL based Malware threat detections identified by Microsoft Defender for Office 365. The line chart summarises the number of messages flagged for malware threats.**\"},\"name\":\"text - 13 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Malware detections over time summarizing the data daily by various Malware URL threat based detection technologies/controls in Microsoft Defender for Office 365.\\r\\nEmailEvents\\r\\n| where DetectionMethods has 'Malware'\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend ParsedMethods = parse_json(DetectionMethods)\\r\\n| mv-expand MalwareMethod = ParsedMethods.Malware\\r\\n| where MalwareMethod contains \\\"URL\\\"\\r\\n| project Timestamp, Key, MalwareMethod\\r\\n| make-series Count= count(Key) default = 0 on Timestamp step 1d by tostring(MalwareMethod)\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"100\",\"name\":\"query - 8 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### URL based Phish threat detections Trend<br>\\r\\n\\r\\n**This visual displays a daily trend of emails with URL based Phish threat detections identified by Microsoft Defender for Office 365. The line chart summarises the number of messages flagged for Phish threats.**\"},\"name\":\"text - 13 - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total emails with Malware detections over time summarizing the data daily by various Malware URL threat based detection technologies/controls in Microsoft Defender for Office 365.\\r\\nEmailEvents\\r\\n| where DetectionMethods has 'Phish'\\r\\n| where OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend ParsedMethods = parse_json(DetectionMethods)\\r\\n| mv-expand PhishMethod = ParsedMethods.Phish\\r\\n| where PhishMethod contains \\\"URL\\\"\\r\\n| project Timestamp, Key, PhishMethod\\r\\n| make-series Count= count(Key) default = 0 on Timestamp step 1d by tostring(PhishMethod)\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"100\",\"name\":\"query - 8 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Daily Trend of QR Code-Based Threat Detections<br>\\r\\n\\r\\n**Displays daily counts of inbound emails containing QR codes flagged for Phish, Malware, or Spam via URL-based detection methods. Helps track QR code abuse patterns over time.**\"},\"customWidth\":\"50\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Daily URL Scan activity by Location<br>\\r\\n\\r\\n**Displays daily counts of URLs scanned from various locations within emails (e.g., body, attachments, QR codes). Helps identify where malicious URLs are most commonly embedded.**\"},\"customWidth\":\"50\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\n\\r\\nlet baseQuery = EmailEvents\\r\\n| where EmailDirection == \\\"Inbound\\\" \\r\\n| where DetectionMethods has \\\"Url\\\"\\r\\n| join EmailUrlInfo on NetworkMessageId\\r\\n| where UrlLocation == \\\"QRCode\\\";\\r\\n\\r\\nlet qrphishh = baseQuery\\r\\n| where parse_json(DetectionMethods).Phish has \\\"URL\\\"\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d\\r\\n| extend Details = \\\"Phish QR Detection\\\";\\r\\n\\r\\nlet qrmalww = baseQuery\\r\\n| where parse_json(DetectionMethods).Malware has \\\"URL\\\"\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Malware QR Detection\\\";\\r\\n\\r\\nlet qrspamm = baseQuery\\r\\n| where parse_json(DetectionMethods).Spam has \\\"URL\\\"\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Spam QR Detection\\\";\\r\\n\\r\\nunion qrphishh, qrmalww, qrspamm\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"graphSettings\":{\"type\":0},\"chartSettings\":{\"xAxis\":\"Timestamp\",\"xSettings\":{\"dateFormatSettings\":{\"formatName\":\"shortDatePattern\",\"showUtcTime\":false}}}},\"customWidth\":\"50\",\"name\":\"query - 6\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises where URL's have been scanned identified from various locations in emails\\r\\nEmailUrlInfo\\r\\n| summarize  count() by UrlLocation, bin (Timestamp,1d)\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 5\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"5\"},\"name\":\"group - 9-URL detections\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">URL click based threat detections insights\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and explain URL click based threat detections in emails as identified by Microsoft Defender for Office 365 focusing on daily trend of blocked URL clicks, time-of-click URL scans by workload, malicious clicks allowed, top clicks on malicious URLs, and more.\"},\"name\":\"text - 13 - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Daily Trend of Blocked URL Click Events<br>\\r\\n\\r\\n**Shows the daily count of blocked URL click attempts and click attempts on URLs with detections, grouped by threat types (e.g., Phish, Malware, Spam). Helps track user interaction with malicious links over time across various threat types.**\"},\"name\":\"text - 13 - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Generates a time-series analysis for blocked URL click events from the 'UrlClickEvents' table\\r\\n\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\n\\r\\nlet baseQuery = UrlClickEvents\\r\\n| where isnotempty(ActionType);\\r\\n\\r\\nlet Blocked = baseQuery\\r\\n| where ActionType has_any(\\\"ClickBlocked\\\")\\r\\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\\r\\n| extend Details = \\\"ClickBlocked\\\";\\r\\n\\r\\nBlocked\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"xAxis\":\"Timestamp\"}},\"customWidth\":\"66\",\"name\":\"query - 4\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of click attempts on URL's with detections split by the different threat types identified\\r\\nUrlClickEvents\\r\\n| where isnotempty(ThreatTypes)\\r\\n| summarize count() by ThreatTypes,bin(Timestamp, 1d)\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 4\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Daily Trend of URL Click Actions by Type<br>\\r\\n\\r\\n**Displays daily counts of URL click events categorised by action type: Blocked, Allowed, Pending Verdict, Error Page, and Clicked Through. Helps identify risky user behaviour and policy gaps.**\"},\"customWidth\":\"66\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### URL Clicks by Workload<br>\\r\\n\\r\\n**DisplaysdailycountsofURLclickeventsgroupedbyWorkload(e.g.,Outlook,Teams,Copilot,OfficeApps: Word, Excel,PowerPoint) HelpsidentifywhichapplicationsaremostfrequentlyusedforURLinteractionsandpotentialriskexposure.**\"},\"customWidth\":\"33\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises different URL click event types by action (e.g., blocked, allowed, pending verdict, error pages, and clicked through), summarizing the data daily\\r\\n\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\n\\r\\nlet baseQuery = UrlClickEvents\\r\\n| where isnotempty(ActionType);\\r\\n\\r\\nlet Blocked = baseQuery\\r\\n| where ActionType has_any(\\\"ClickBlocked\\\")\\r\\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\\r\\n| extend Details = \\\"ClickBlocked\\\";\\r\\n\\r\\nlet Allowed = baseQuery\\r\\n| where ActionType has_any(\\\"ClickAllowed\\\")\\r\\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\\r\\n| extend Details = \\\"ClickAllowed\\\";\\r\\n\\r\\nlet PendingVerdict = baseQuery\\r\\n| where ActionType has_any(\\\"UrlScanInProgress\\\")\\r\\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\\r\\n| extend Details = \\\"PendingVerdict\\\";\\r\\n\\r\\nlet ErrorPage = baseQuery\\r\\n| where ActionType has_any(\\\"UrlErrorPage\\\")\\r\\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\\r\\n| extend Details = \\\"ErrorPage\\\";\\r\\n\\r\\nlet ClickedThrough = baseQuery\\r\\n| where IsClickedThrough == true\\r\\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\\r\\n| extend Details = \\\"ClickedThrough\\\";\\r\\n\\r\\nunion Blocked, Allowed, PendingVerdict, ErrorPage, ClickedThrough\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"xAxis\":\"Timestamp\"}},\"customWidth\":\"66\",\"name\":\"query - 1\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises where URL clicks scanned by the Workload the click happened from\\r\\nUrlClickEvents\\r\\n| summarize  count() by Workload, bin (Timestamp,1d)\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 5 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Daily Blocked URL Clicks by Workload<br>\\r\\n\\r\\n**Displays daily counts of blocked URL click attempts grouped by Workload (Email, Teams, Office, Microsoft 365 Copilot). Helps identify which platforms are most exposed to malicious link interactions and where user awareness or policy enforcement should be strengthened.**\"},\"customWidth\":\"66\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Click-Through Activity on Detected URLs by Workload<br>\\r\\n\\r\\n**Displays counts of clickthrough actions on URLs already identified with detections, grouped by Workload where the click happened. Helps identify clients/platforms where users are most likely to proceed to risky URLs and prioritise awareness training or policy tuning for those workloads**\"},\"customWidth\":\"33\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises blocked URL click event types by Workload (e.g., Email, Teams, Office, Microsoft 365 Copilot), summarizing the data daily\\r\\n\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\n\\r\\nlet baseQuery = UrlClickEvents\\r\\n| where ActionType ==\\\"ClickBlocked\\\";\\r\\n\\r\\nlet Teams = baseQuery\\r\\n| where Workload==\\\"Teams\\\" \\r\\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\\r\\n| extend Details = \\\"Teams\\\";\\r\\n\\r\\nlet Office = baseQuery\\r\\n| where Workload==\\\"Office\\\" \\r\\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\\r\\n| extend Details = \\\"Office\\\";\\r\\n\\r\\nlet Email = baseQuery\\r\\n| where Workload==\\\"Email\\\" \\r\\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\\r\\n| extend Details = \\\"Email\\\";\\r\\n\\r\\nlet Copilot = baseQuery\\r\\n| where Workload==\\\"Copilot\\\" \\r\\n| make-series Count = count() default = 0 on Timestamp from minTime to maxTime step 1d\\r\\n| extend Details = \\\"Copilot\\\";\\r\\n\\r\\nunion Teams, Office, Email, Copilot\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"66\",\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of click-through activities on URL's with detections split by the source client\\r\\nUrlClickEvents \\r\\n| where IsClickedThrough !=\\\"0\\\"\\r\\n| where isnotempty(ThreatTypes) \\r\\n| summarize count() by Workload\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top clicks on Malicious URLs<br>\\r\\n\\r\\n**Displays the top 20 URLs associated with detections that registered the highest number of clicks. Includes ThreatTypes, ActionType, and Workload to provide context on the nature of the threat and where user interaction occurred.**\"},\"customWidth\":\"100\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query shows the top 20 URL's that have a detection associated with the most ammount of clicks registered \\r\\nUrlClickEvents\\r\\n| where ThreatTypes !=\\\"\\\"\\r\\n| summarize count() by Url, ThreatTypes, ActionType, Workload\\r\\n| project Url, ThreatTypes, ActionType, Workload, ClickCount=count_\\r\\n| top 20 by ClickCount\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"ClickCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"100\",\"name\":\"query - 10 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"5\"},\"name\":\"group - 31-URL clicks\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Top Risky Users Clicking on URLs with Threats\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track and identify users who have clicked on malicious URLs detected by Microsoft Defender for Office 365.\"},\"name\":\"text - 13 - Copy - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Top 10 Users Clicking on URLs with Malware Threat<br>\\r\\n\\r\\n**Displays the top 10 user accounts with the highest number of click attempts on URLs flagged as Malware. Helps identify individuals at greater risk and prioritise targeted security awareness training.**\"},\"customWidth\":\"33\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Users Clicking on URLs with Phish Threat<br>\\r\\n\\r\\n**Displays the top 10 user accounts with the highest number of click attempts on URLs flagged as Phish. Helps identify individuals at greater risk and prioritise targeted security awareness training.**\"},\"customWidth\":\"33\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Users Clicking on URLs with Spam Threat<br>\\r\\n\\r\\n**Displays the top 10 user accounts with the highest number of click attempts on URLs flagged as Spam. Helps identify individuals at greater risk and prioritise targeted security awareness training.**\"},\"customWidth\":\"33\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top 10 users with click attempts on URL's with malware detections\\r\\nUrlClickEvents\\r\\n| where ThreatTypes == \\\"Malware\\\"\\r\\n| summarize count() by AccountUpn\\r\\n| top 10 by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":10}},\"customWidth\":\"33\",\"name\":\"query - 4 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top 10 users with click attempts on URL's with phishing detections\\r\\nUrlClickEvents\\r\\n| where ThreatTypes == \\\"Phish\\\"\\r\\n| summarize count() by AccountUpn\\r\\n| top 10 by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":10}},\"customWidth\":\"33\",\"name\":\"query - 4 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top 10 users with click attempts on URL's with spam detections\\r\\nUrlClickEvents\\r\\n| where ThreatTypes == \\\"Spam\\\"\\r\\n| summarize count() by AccountUpn\\r\\n| top 10 by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":10}},\"customWidth\":\"33\",\"name\":\"query - 4 - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top 10 users with click attempts on URL's with malware detections\\r\\nUrlClickEvents\\r\\n| summarize TotalClickCount=count(),MalwareClickCount = countif(ThreatTypes has \\\"Malware\\\") by AccountUpn\\r\\n| extend Bad_Click_Percentage = todouble(round(MalwareClickCount / todouble(TotalClickCount) *100, 2))\\r\\n| where MalwareClickCount !=0\\r\\n| sort by MalwareClickCount desc\\r\\n| project AccountUpn,MalwareClickCount, TotalClickCount,Bad_Click_Percentage\\r\\n| top 15 by MalwareClickCount\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"MalwareClickCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"25ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalClickCount\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Click_Percentage\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"25ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"MalwareEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Traffic_Percentage_Inbound\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"33\",\"name\":\"query - 18 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top 10 users with click attempts on URL's with Phish detections\\r\\nUrlClickEvents\\r\\n| summarize TotalClickCount=count(),PhishClickCount = countif(ThreatTypes has \\\"Phish\\\") by AccountUpn\\r\\n| extend Bad_Click_Percentage = todouble(round(PhishClickCount / todouble(TotalClickCount) *100, 2))\\r\\n| where PhishClickCount !=0\\r\\n| sort by PhishClickCount desc\\r\\n| project AccountUpn,PhishClickCount, TotalClickCount,Bad_Click_Percentage\\r\\n| top 15 by PhishClickCount\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"PhishClickCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"25ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalClickCount\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Click_Percentage\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"25ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"MalwareClickCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"MalwareEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Traffic_Percentage_Inbound\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"33\",\"name\":\"query - 18 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top 10 users with click attempts on URL's with Spam detections\\r\\nUrlClickEvents\\r\\n| summarize TotalClickCount=count(),SpamClickCount = countif(ThreatTypes has \\\"Spam\\\") by AccountUpn\\r\\n| extend Bad_Click_Percentage = todouble(round(SpamClickCount / todouble(TotalClickCount) *100, 2))\\r\\n| where SpamClickCount !=0\\r\\n| sort by SpamClickCount desc\\r\\n| project AccountUpn,SpamClickCount, TotalClickCount,Bad_Click_Percentage\\r\\n| top 15 by SpamClickCount\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SpamClickCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"25ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalClickCount\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Click_Percentage\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"25ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"PhishClickCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"MalwareClickCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"MalwareEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Traffic_Percentage_Inbound\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"50ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"33\",\"name\":\"query - 18 - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"5\"},\"name\":\"group - 32-Top clickers\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"# Top Attacked Users, Top Senders, and Automatic External Email Forwarding\\r\\n\\r\\n---\\r\\nThis tab provides insights into **Top attacked users, Top Senders** in inbound email messages and details about **automatic external email forwarding**.\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"6\"},\"name\":\"text - 24 - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Top attacked users and Top Senders insights\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section provides key visuals that highlight top attacked users  individuals most frequently targeted by inbound email threats as detected by Microsoft Defender for Office 365. Offers insights into top email senders and sender domains across inbound email traffic, helping identify patterns and potential risk sources.\"},\"name\":\"text - 13 - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Top Attacked Users<br>\\r\\n\\r\\n**Displays the top 10 recipient email addresses that received inbound emails flagged as Spam, Phishing, or Malware. Helps identify high-risk users for targeted security awareness and policy enforcement.**\"},\"name\":\"text - 13 - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises the top 10 users that are receiving Spam, Phishing or Malware emails\\r\\nEmailEvents \\r\\n| where  OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\" and EmailDirection ==\\\"Inbound\\\"\\r\\n| extend MDO_detection = parse_json(DetectionMethods) \\r\\n| extend FirstDetection = iif(isempty(MDO_detection), \\\"Clean\\\", tostring(bag_keys(MDO_detection)[0])) \\r\\n| extend FirstSubcategory = iif(FirstDetection != \\\"Clean\\\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \\\": \\\", tostring(MDO_detection[FirstDetection][0])), \\\"No Detection (clean)\\\") \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(FirstDetection == \\\"Malware\\\"),PhishEmailCount = countif(FirstDetection ==  \\\"Phish\\\"),SpamEmailCount = countif(FirstDetection ==  \\\"Spam\\\") by RecipientEmailAddress\\r\\n| extend ThreatEmailCount=(MalwareEmailCount+PhishEmailCount+SpamEmailCount)\\r\\n| project RecipientEmailAddress,ThreatEmailCount\\r\\n| sort by ThreatEmailCount  | take 10\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"RecipientEmailAddress\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"RecipientEmailAddress\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"createOtherGroup\":10}},\"customWidth\":\"33\",\"name\":\"query - 27\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises the top 10 users that are receiving Spam, Phishing or Malware emails\\r\\nEmailEvents \\r\\n| where  OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\" and EmailDirection ==\\\"Inbound\\\"\\r\\n| extend MDO_detection = parse_json(DetectionMethods) \\r\\n| extend FirstDetection = iif(isempty(MDO_detection), \\\"Clean\\\", tostring(bag_keys(MDO_detection)[0])) \\r\\n| extend FirstSubcategory = iif(FirstDetection != \\\"Clean\\\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \\\": \\\", tostring(MDO_detection[FirstDetection][0])), \\\"No Detection (clean)\\\") \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(FirstDetection == \\\"Malware\\\"),PhishEmailCount = countif(FirstDetection ==  \\\"Phish\\\"),SpamEmailCount = countif(FirstDetection ==  \\\"Spam\\\") by RecipientEmailAddress\\r\\n| extend ThreatEmailCount=(MalwareEmailCount+PhishEmailCount+SpamEmailCount)\\r\\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(ThreatEmailCount / todouble(TotalEmailCount) *100, 2))\\r\\n| project RecipientEmailAddress,TotalEmailCount,ThreatEmailCount, MalwareEmailCount, PhishEmailCount, SpamEmailCount, Bad_Traffic_Percentage_Inbound\\r\\n| sort by ThreatEmailCount  | take 15\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"ThreatEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"MalwareEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"PhishEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"SpamEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Traffic_Percentage_Inbound\",\"formatter\":0,\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true,\"sortBy\":[{\"itemKey\":\"$gen_bar_ThreatEmailCount_2\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"$gen_bar_ThreatEmailCount_2\",\"sortOrder\":2}],\"chartSettings\":{\"createOtherGroup\":10}},\"customWidth\":\"66\",\"name\":\"query - 28\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Senders of Inbound Emails<br>\\r\\n\\r\\n**Displays the top 10 sender email addresses from external sources delivering inbound emails. Helps identify high-volume external senders for monitoring and policy enforcement.**\"},\"name\":\"text - 13 - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises the top 10 senders by inbound email sending volume\\r\\nEmailEvents \\r\\n| where  OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\" and EmailDirection ==\\\"Inbound\\\"\\r\\n| extend MDO_detection = parse_json(DetectionMethods) \\r\\n| extend FirstDetection = iif(isempty(MDO_detection), \\\"Clean\\\", tostring(bag_keys(MDO_detection)[0])) \\r\\n| extend FirstSubcategory = iif(FirstDetection != \\\"Clean\\\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \\\": \\\", tostring(MDO_detection[FirstDetection][0])), \\\"No Detection (clean)\\\") \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(FirstDetection == \\\"Malware\\\"),PhishEmailCount = countif(FirstDetection ==  \\\"Phish\\\"),SpamEmailCount = countif(FirstDetection ==  \\\"Spam\\\") by SenderFromAddress\\r\\n| extend ThreatEmailCount=(MalwareEmailCount+PhishEmailCount+SpamEmailCount)\\r\\n| project SenderFromAddress,TotalEmailCount\\r\\n| sort by TotalEmailCount  | take 10\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"yAxis\":[\"TotalEmailCount\"],\"createOtherGroup\":10}},\"customWidth\":\"33\",\"name\":\"query - 30\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises the top 10 senders by inbound email sending volume\\r\\nEmailEvents \\r\\n| where  OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\" and EmailDirection ==\\\"Inbound\\\"\\r\\n| extend MDO_detection = parse_json(DetectionMethods) \\r\\n| extend FirstDetection = iif(isempty(MDO_detection), \\\"Clean\\\", tostring(bag_keys(MDO_detection)[0])) \\r\\n| extend FirstSubcategory = iif(FirstDetection != \\\"Clean\\\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \\\": \\\", tostring(MDO_detection[FirstDetection][0])), \\\"No Detection (clean)\\\") \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(FirstDetection == \\\"Malware\\\"),PhishEmailCount = countif(FirstDetection ==  \\\"Phish\\\"),SpamEmailCount = countif(FirstDetection ==  \\\"Spam\\\") by SenderFromAddress\\r\\n| extend ThreatEmailCount=(MalwareEmailCount+PhishEmailCount+SpamEmailCount)\\r\\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(ThreatEmailCount / todouble(TotalEmailCount) *100, 2))\\r\\n| project SenderFromAddress,TotalEmailCount,ThreatEmailCount, MalwareEmailCount, PhishEmailCount, SpamEmailCount, Bad_Traffic_Percentage_Inbound\\r\\n| sort by TotalEmailCount  | take 15\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"ThreatEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"MalwareEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"PhishEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"SpamEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Traffic_Percentage_Inbound\",\"formatter\":0,\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"chartSettings\":{\"createOtherGroup\":10}},\"customWidth\":\"66\",\"name\":\"query - 28 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Sender domains of Inbound Emails<br>\\r\\n\\r\\n**Displays the top 10 sender domains from external sources delivering inbound emails. Helps identify high-volume external sender domains for monitoring and policy enforcement.**\"},\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises the top 10 senders by inbound email sending volume\\r\\nEmailEvents \\r\\n| where  OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\" and EmailDirection ==\\\"Inbound\\\"\\r\\n| extend MDO_detection = parse_json(DetectionMethods) \\r\\n| extend FirstDetection = iif(isempty(MDO_detection), \\\"Clean\\\", tostring(bag_keys(MDO_detection)[0])) \\r\\n| extend FirstSubcategory = iif(FirstDetection != \\\"Clean\\\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \\\": \\\", tostring(MDO_detection[FirstDetection][0])), \\\"No Detection (clean)\\\") \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(FirstDetection == \\\"Malware\\\"),PhishEmailCount = countif(FirstDetection ==  \\\"Phish\\\"),SpamEmailCount = countif(FirstDetection ==  \\\"Spam\\\") by SenderFromDomain\\r\\n| extend ThreatEmailCount=(MalwareEmailCount+PhishEmailCount+SpamEmailCount)\\r\\n| project SenderFromDomain,TotalEmailCount\\r\\n| sort by TotalEmailCount  | take 10\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"yAxis\":[\"TotalEmailCount\"],\"createOtherGroup\":10}},\"customWidth\":\"33\",\"name\":\"query - 30 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises the top 10 senders by inbound email sending volume\\r\\nEmailEvents \\r\\n| where  OrgLevelPolicy != \\\"Phishing simulation\\\" and OrgLevelPolicy != \\\"SecOps Mailbox\\\" and EmailDirection ==\\\"Inbound\\\"\\r\\n| extend MDO_detection = parse_json(DetectionMethods) \\r\\n| extend FirstDetection = iif(isempty(MDO_detection), \\\"Clean\\\", tostring(bag_keys(MDO_detection)[0])) \\r\\n| extend FirstSubcategory = iif(FirstDetection != \\\"Clean\\\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \\\": \\\", tostring(MDO_detection[FirstDetection][0])), \\\"No Detection (clean)\\\") \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmailCount=count(),MalwareEmailCount = countif(FirstDetection == \\\"Malware\\\"),PhishEmailCount = countif(FirstDetection ==  \\\"Phish\\\"),SpamEmailCount = countif(FirstDetection ==  \\\"Spam\\\") by SenderFromDomain\\r\\n| extend ThreatEmailCount=(MalwareEmailCount+PhishEmailCount+SpamEmailCount)\\r\\n| extend Bad_Traffic_Percentage_Inbound = todouble(round(ThreatEmailCount / todouble(TotalEmailCount) *100, 2))\\r\\n| project SenderFromDomain,TotalEmailCount,ThreatEmailCount, MalwareEmailCount, PhishEmailCount, SpamEmailCount, Bad_Traffic_Percentage_Inbound\\r\\n| sort by TotalEmailCount  | take 15\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"ThreatEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"MalwareEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"PhishEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"SpamEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Bad_Traffic_Percentage_Inbound\",\"formatter\":0,\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"chartSettings\":{\"createOtherGroup\":10}},\"customWidth\":\"66\",\"name\":\"query - 28 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"6\"},\"name\":\"group - 10-Top attacked users and top senders\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Automatic External Email Forwarding Insights\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\n**Email forwarding can be useful, but can also pose a security risk due to the potential disclosure of information.**\\r\\n<br>\\r\\n\\r\\nUsers can configure [<b>Inbox rules</b>](https://cus.prod.support.services.microsoft.com/en-us/office/use-rules-to-automatically-forward-messages-45aa9664-4911-4f96-9663-ece42816d746) in Outlook or set up [<b>SMTP forwarding</b>](https://support.microsoft.com/en-us/office/turn-on-automatic-forwarding-in-outlook-7f2670a1-7fff-4475-8a3c-5822d63b0c8e) to automatically forward messages to external recipients. You can control automatic external email forwarding from cloud mailboxes using [<b>Outbound spam policies</b>](https://learn.microsoft.com/en-us/defender-office-365/outbound-spam-policies-external-email-forwarding) in Microsoft Defender for Office 365. \\r\\n**Attackers might exploit this capability to compromise your organization or its partners.**\"},\"name\":\"text - 8\"},{\"type\":1,\"content\":{\"json\":\"### Automatic Email Forwarding by Type<br>\\r\\n\\r\\n**Displays counts of outbound emails automatically forwarded to external addresses, grouped by forwarding type (e.g., SMTP forwarding, inbox rules). Helps identify forwarding behaviors that may pose data exfiltration risks.**\"},\"customWidth\":\"50\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Internal Users Forwarding Emails Externally<br>\\r\\n\\r\\n**Displays the top 10 internal user accounts that have automatically forwarded emails to external addresses (regardless of the forwarding type used). Helps identify potential data exfiltration risks and enforce forwarding policies.**\"},\"customWidth\":\"50\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises automatic email forwarding to external email addresses by forwarding type\\r\\nEmailEvents \\r\\n| where EmailDirection == \\\"Outbound\\\" and ForwardingInformation !=\\\"\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser)\\r\\n| summarize count() by ForwardingType\\r\\n| sort by count_ desc \\r\\n\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"yAxis\":[\"count_\"],\"createOtherGroup\":10}},\"customWidth\":\"50\",\"name\":\"query - 30 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises the top 10 internal senders who are automatically forwarding emails to external email addresses\\r\\nEmailEvents \\r\\n| where EmailDirection == \\\"Outbound\\\" and ForwardingInformation !=\\\"\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser)\\r\\n| summarize TotalForwardedMessages = count() by ForwardingUser\\r\\n| sort by TotalForwardedMessages desc \\r\\n| top 10 by TotalForwardedMessages\\r\\n\\r\\n\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalForwardedMessages\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"chartSettings\":{\"yAxis\":[\"TotalForwardedMessages\"]}},\"customWidth\":\"50\",\"name\":\"query - 30 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Internal Users Forwarding Emails Using Mailbox Rules<br>\\r\\n\\r\\n**Displays the top 10 internal user accounts that have automatically forwarded outbound emails to external addresses using Mailbox Rules. Helps identify potential data exfiltration risks and enforce forwarding restrictions.**\"},\"customWidth\":\"50\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 External domains Receiving Auto-Forwarded Emails (Mailbox Rules)<br>\\r\\n\\r\\n**Displays the top 10 external recipient email domains that received automatically forwarded emails from internal users via Mailbox Rules. Helps identify potential data exfiltration risks and enforce forwarding restrictions.**\"},\"customWidth\":\"25\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 External Recipients Receiving Auto-Forwarded Emails (Mailbox Rules)<br>\\r\\n\\r\\n**Displays the top 10 external recipient email addresses that received automatically forwarded emails from internal users via Mailbox Rules. Helps identify potential data exfiltration risks and enforce forwarding restrictions.**\"},\"customWidth\":\"25\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises the top 10 internal senders who are automatically forwarding emails to external email addresses using Mailbox Rules\\r\\nEmailEvents \\r\\n| where EmailDirection == \\\"Outbound\\\" and ForwardingInformation !=\\\"\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser)\\r\\n| where ForwardingType ==\\\"MbxRule\\\"\\r\\n| summarize TotalForwardedMessages = count() by ForwardingUser\\r\\n| sort by TotalForwardedMessages desc \\r\\n| take 10\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalForwardedMessages\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"}}]},\"chartSettings\":{\"yAxis\":[\"TotalForwardedMessages\"]}},\"customWidth\":\"50\",\"name\":\"query - 30 - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises the top 10 external domains who are recieving automatically forwarded emails using Mailbox Rules\\r\\nEmailEvents \\r\\n| where EmailDirection == \\\"Outbound\\\" and ForwardingInformation !=\\\"\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser),RecipientDomain = tostring(split(RecipientEmailAddress, \\\"@\\\")[1])\\r\\n| where ForwardingType ==\\\"MbxRule\\\"\\r\\n| summarize TotalForwardedMessages = count() by RecipientDomain\\r\\n| sort by TotalForwardedMessages desc \\r\\n| take 10\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalForwardedMessages\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"chartSettings\":{\"yAxis\":[\"count_\"],\"createOtherGroup\":10}},\"customWidth\":\"25\",\"name\":\"query - 30 - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises the top 10 external recipients who are recieving automatically forwarded emails using Mailbox Rules\\r\\nEmailEvents \\r\\n| where EmailDirection == \\\"Outbound\\\" and ForwardingInformation !=\\\"\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser)\\r\\n| where ForwardingType ==\\\"MbxRule\\\"\\r\\n| summarize TotalForwardedMessages = count() by RecipientEmailAddress\\r\\n| sort by TotalForwardedMessages desc \\r\\n| take 10\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalForwardedMessages\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"chartSettings\":{\"yAxis\":[\"count_\"],\"createOtherGroup\":10}},\"customWidth\":\"25\",\"name\":\"query - 30 - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Internal Users Forwarding Emails via SMTP Forwarding<br>\\r\\n\\r\\n**Displays the top 10 internal user accounts that have automatically forwarded outbound emails to external addresses using SMTP Forwarding. Helps identify potential data exfiltration risks and enforce forwarding restrictions.**\"},\"customWidth\":\"50\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 External domains receiving Auto-Forwarded Emails (SMTP Forwarding)<br>\\r\\n\\r\\n**Displays the top 10 external recipient email domains that received automatically forwarded emails from internal users using SMTP Forwarding. Helps identify potential data exfiltration risks and enforce forwarding restrictions.**\"},\"customWidth\":\"25\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 External Recipients Receiving Auto-Forwarded Emails (SMTP Forwarding)<br>\\r\\n\\r\\n**Displays the top 10 external recipient email addresses that received automatically forwarded emails from internal users using SMTP Forwarding. Helps identify potential data exfiltration risks and enforce forwarding restrictions.**\"},\"customWidth\":\"25\",\"name\":\"text - 13 - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises the top 10 internal senders who are automatically forwarding emails to external email addresses using SmtpForwarding\\r\\nEmailEvents \\r\\n| where EmailDirection == \\\"Outbound\\\" and ForwardingInformation !=\\\"\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser)\\r\\n| where ForwardingType ==\\\"SmtpForwarding\\\"\\r\\n| summarize count() by ForwardingUser\\r\\n| sort by count_ desc \\r\\n| take 10\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"yAxis\":[\"count_\"],\"createOtherGroup\":10}},\"customWidth\":\"50\",\"name\":\"query - 30 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises the top 10 external recipients who are recieving automatically forwarded emails using SmtpForwarding\\r\\nEmailEvents \\r\\n| where EmailDirection == \\\"Outbound\\\" and ForwardingInformation !=\\\"\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser),RecipientDomain = tostring(split(RecipientEmailAddress, \\\"@\\\")[1])\\r\\n| where ForwardingType ==\\\"SmtpForwarding\\\"\\r\\n| summarize TotalForwardedMessages = count() by RecipientDomain\\r\\n| sort by TotalForwardedMessages desc \\r\\n| take 10\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalForwardedMessages\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"chartSettings\":{\"yAxis\":[\"count_\"],\"createOtherGroup\":10}},\"customWidth\":\"25\",\"name\":\"query - 30 - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query visualises the top 10 external recipients who are recieving automatically forwarded emails using SmtpForwarding\\r\\nEmailEvents \\r\\n| where EmailDirection == \\\"Outbound\\\" and ForwardingInformation !=\\\"\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| extend ForwardingType = tostring((parse_json(ForwardingInformation)).ForwardingType),ForwardingUser=tostring((parse_json(ForwardingInformation)).ForwardingUser)\\r\\n| where ForwardingType ==\\\"SmtpForwarding\\\"\\r\\n| summarize TotalForwardedMessages = count() by RecipientEmailAddress\\r\\n| sort by TotalForwardedMessages desc \\r\\n| take 10\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalForwardedMessages\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"chartSettings\":{\"yAxis\":[\"count_\"],\"createOtherGroup\":10}},\"customWidth\":\"25\",\"name\":\"query - 30 - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"6\"},\"name\":\"group - 34 - Automatic email forwarding\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"# Email detection action overrides\\r\\n\\r\\n---\\r\\n\\r\\nThis tab provides insights into admin or end-user configured **detection overrides** where the message was detected as a threat by Microsoft Defender for Office 365, however an admin-configured policy or end-user setting overrode the detection action.[<p><b>Learn more</b></p>](https://learn.microsoft.com/en-us/defender-office-365/step-by-step-guides/understand-overrides-in-email-entity) \"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"7\"},\"name\":\"text - 13 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Admin configured Detection Overrides (Allow)\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track emails subject to administrator policies (e.g., Transport Rules, Tenant Allow/Block List) with an \\\"Allow\\\" action, overriding Microsoft Defender for Office 365 detections (excluding SecOps Mailbox overrides).\"},\"name\":\"text - AdminOverridesAllowHeader\"},{\"type\":1,\"content\":{\"json\":\"### Admin Overrides (Allow) Trend\\r\\n**Displays the daily count of emails where an administrator policy with an \\\"Allow\\\" action overrode detections (excluding SecOps Mailbox). Helps track the frequency of admin overrides over time.**\"},\"name\":\"text - AdminOverridesAllowTrend\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of emails subject to an admin policy with action of allow independent of action taken, summarizing the data daily\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy!=\\\"\\\"\\\"\\\" and OrgLevelPolicy!=\\\"SecOps Mailbox\\\" and OrgLevelAction == \\\"Allow\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| make-series TotalAdminOverrides = count() default = 0 on Timestamp step 1d\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Total Emails by Admin Override type (Allow)\\r\\n**Summarizes the total count of emails subject to administrator policies with an \\\"Allow\\\" action, grouped by the type of override. Helps identify which policies are most frequently allowing emails.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowByType\"},{\"type\":1,\"content\":{\"json\":\"### Admin Overrides (Allow) by Override Type and Threat Type\\r\\n**Details the count of emails allowed by administrator policies, categorized by the override type and the detected threat type. Helps assess the risk associated with allowed emails.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowByTypeAndThreat\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of emails subject to an admin policy with action of allow, independent of action taken, summarizing the data by type of override\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy!=\\\"\\\"\\\"\\\" and OrgLevelPolicy!=\\\"SecOps Mailbox\\\" and OrgLevelAction == \\\"Allow\\\" \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize count() by OrgLevelPolicy\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 16\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of emails subject to an admin policy with action of allow, independent of action taken, summarizing the data by type of override and threats type found\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy!=\\\"\\\"\\\"\\\" and OrgLevelPolicy!=\\\"SecOps Mailbox\\\" and OrgLevelAction == \\\"Allow\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmails=count() by OrgLevelAction,OrgLevelPolicy,ThreatTypes\\r\\n| sort by TotalEmails\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalEmails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}]}},\"customWidth\":\"50\",\"name\":\"query - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### SecOps Mailbox Overrides (Allow)\\r\\nThis section focuses on emails allowed specifically due to the SecOps Mailbox override policy, typically used for investigation and analysis.[<p><b>Learn more</b></p>](https://learn.microsoft.com/en-us/defender-office-365/advanced-delivery-policy-configure) \"},\"name\":\"text - SecOpsOverridesHeader\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of emails subject to the \\r\\nEmailEvents \\r\\n| where OrgLevelPolicy==\\\"SecOps Mailbox\\\" and OrgLevelAction == \\\"Allow\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize count() by OrgLevelPolicy\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"stat\",\"statSettings\":{\"valueAggregation\":\"None\",\"colorSettings\":{\"type\":\"static\",\"mode\":\"background\",\"heatmapPalette\":\"greenRed\"},\"tagText\":\"\",\"valueFontStyle\":\"auto\",\"tagTextPosition\":\"bottom\"}},\"customWidth\":\"50\",\"name\":\"query - 1\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of emails delivered to the SecOps Mailbox by threat type\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy!=\\\"\\\"\\\"\\\" and OrgLevelPolicy==\\\"SecOps Mailbox\\\" and OrgLevelAction == \\\"Allow\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmails=count() by OrgLevelAction,OrgLevelPolicy,ThreatTypes\\r\\n| sort by TotalEmails\",\"size\":1,\"showAnalytics\":true,\"title\":\" \",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalEmails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}]}},\"customWidth\":\"50\",\"name\":\"query - 4\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"7\"},\"name\":\"group - 15 - Admin Detection Overrides - Allow\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Admin configured Detection Overrides (Block)\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section provides insights into email messages blocked by administrative policies (e.g. Tenant allow/block list, Antimalware policy file type block), overriding detection actions defined by Microsoft Defender for Office 365.\"},\"name\":\"text - AdminOverridesBlockHeader\"},{\"type\":1,\"content\":{\"json\":\"### Admin Overrides (Block) Trend\\r\\n**Displays the daily count of emails where an administrator policy with a \\\"Block\\\" action overrode detections. Helps track the frequency of admin blocks over time.**\"},\"name\":\"text - AdminOverridesBlockTrend\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of emails subject to an admin policy with action of block, summarizing the data daily\\r\\nEmailEvents\\r\\n| where OrgLevelPolicy!=\\\"\\\"\\\"\\\" and OrgLevelAction == \\\"Block\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| make-series TotalAdminOverrides = count() default = 0 on Timestamp step 1d\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"100\",\"name\":\"query - 5\",\"styleSettings\":{\"margin\":\"10\",\"padding\":\"10\"}},{\"type\":1,\"content\":{\"json\":\"### Total Emails by Admin Override Type (Block)\\r\\n**Summarizes the total count of emails subject to administrator policies with a \\\"Block\\\" action, grouped by the type of override.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesBlockByType\"},{\"type\":1,\"content\":{\"json\":\"### Admin Overrides (Block) by Override Type and Threat Type\\r\\n**Details the count of emails blocked by administrator policies, categorized by the override type and the detected threat type.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesBlockByTypeAndThreat\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of emails subject to an admin policy with action of block, summarizing the data by type of override\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy!=\\\"\\\"\\\"\\\" and OrgLevelAction == \\\"Block\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize count() by OrgLevelPolicy\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 6\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of emails subject to an admin policy with action of block, summarizing the data by type of override and threats type found\\r\\nEmailEvents \\r\\n| where OrgLevelPolicy!=\\\"\\\"\\\"\\\" and OrgLevelAction == \\\"Block\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmails=count() by OrgLevelAction,OrgLevelPolicy,ThreatTypes\\r\\n| sort by TotalEmails\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalEmails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}]}},\"customWidth\":\"50\",\"name\":\"query - 7\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"7\"},\"name\":\"group - 36-Admin Detection Overrides - Block\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">User configured Detection Overrides (Allow)\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section consolidates key visuals that track email messages subject to user policies (e.g. [Safe Senders list defined in Outlook](https://learn.microsoft.com/en-us/defender-office-365/create-safe-sender-lists-in-office-365#use-outlook-safe-senders)) with an \\\"Allow\\\" action, overriding Microsoft Defender for Office 365 detections.\"},\"name\":\"text - UserOverridesAllowHeader\"},{\"type\":1,\"content\":{\"json\":\"### User Overrides (Allow) Trend\\r\\n**Displays the daily count of emails where a user policy with an \\\"Allow\\\" action overrode detections. Helps track the frequency of user overrides over time.**\"},\"name\":\"text - UserOverridesAllowTrend\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of emails subject to a user type policy with action of allow, summarizing the data daily\\r\\nEmailEvents\\r\\n| where UserLevelPolicy!=\\\"\\\"\\\"\\\" and UserLevelAction == \\\"Allow\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| make-series TotalUserOverrides = count() default = 0 on Timestamp step 1d\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Total Emails by User Override Type (Allow)\\r\\n**Summarizes the total count of emails subject to user policies with an \\\"Allow\\\" action, grouped by the type of override.**\"},\"customWidth\":\"50\",\"name\":\"text - UserOverridesAllowByType\"},{\"type\":1,\"content\":{\"json\":\"### User Overrides (Allow) by Override Type and Threat Type\\r\\n**Details the count of emails allowed by user policies, categorized by the override type and the detected threat type. Helps assess the risk associated with user-allowed emails.**\"},\"customWidth\":\"50\",\"name\":\"text - UserOverridesAllowByTypeAndThreat\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of emails subject to a user type policy with action of allow, summarizing the data by type of override\\r\\nEmailEvents \\r\\n| where UserLevelPolicy!=\\\"\\\"\\\"\\\" and UserLevelAction == \\\"Allow\\\" \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize count() by UserLevelPolicy\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 16\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of emails subject to a user type policy with action of allow, summarizing the data by type of override and threats type found\\r\\nEmailEvents \\r\\n| where UserLevelPolicy!=\\\"\\\"\\\"\\\" and UserLevelAction == \\\"Allow\\\" \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmails=count() by UserLevelAction,UserLevelPolicy,ThreatTypes\\r\\n| sort by TotalEmails\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalEmails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}]}},\"customWidth\":\"50\",\"name\":\"query - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"7\"},\"name\":\"group - 15 - User Detection Overrides - Allow\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">User configured Detection Overrides (Block)\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section provides insights into emails blocked by user-configured policies (e.g., [Blocked Senders list in Outlook](https://support.microsoft.com/en-us/office/block-or-unblock-senders-in-outlook-9bf812d4-6995-4d19-901a-76d6e26939b0)).\"},\"name\":\"text - UserOverridesBlockHeader\"},{\"type\":1,\"content\":{\"json\":\"### User Overrides (Block) Trend\\r\\n**Displays the daily count of emails where a user policy with a \\\"Block\\\" action overrode detections. Helps track the frequency of user blocks over time.**\"},\"name\":\"text - UserOverridesBlockTrend\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of emails subject to a user type policy with action of block, summarizing the data daily\\r\\nEmailEvents\\r\\n| where UserLevelPolicy!=\\\"\\\"\\\"\\\" and UserLevelAction == \\\"Block\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| make-series TotalUserOverrides = count() default = 0 on Timestamp step 1d\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"100\",\"name\":\"query - 5\",\"styleSettings\":{\"margin\":\"10\",\"padding\":\"10\"}},{\"type\":1,\"content\":{\"json\":\"### Total Emails by User Override Type (Block)\\r\\n**Summarizes the total count of emails subject to user policies with a \\\"Block\\\" action, grouped by the type of override.**\"},\"customWidth\":\"50\",\"name\":\"text - UserOverridesBlockByType\"},{\"type\":1,\"content\":{\"json\":\"### User Overrides (Block) by Override Type and Threat Type\\r\\n**Details the count of emails blocked by user policies, categorized by the override type and the detected threat type.**\"},\"customWidth\":\"50\",\"name\":\"text - UserOverridesBlockByTypeAndThreat\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of emails subject to a user type policy with action of block, summarizing the data by type of override\\r\\nEmailEvents \\r\\n| where UserLevelPolicy!=\\\"\\\"\\\"\\\" and UserLevelAction == \\\"Block\\\" \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize count() by UserLevelPolicy\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 6\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of emails subject to a user type policy with action of block, summarizing the data by type of override and threats type found\\r\\nEmailEvents \\r\\n| where UserLevelPolicy!=\\\"\\\"\\\"\\\" and UserLevelAction == \\\"Block\\\" \\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize TotalEmails=count() by UserLevelAction,UserLevelPolicy,ThreatTypes\\r\\n| sort by TotalEmails\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalEmails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}]}},\"customWidth\":\"50\",\"name\":\"query - 7\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"7\"},\"name\":\"group - 37-User Detection Overrides - Block\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"# False Negative(FN) Submissions insights\\r\\n\\r\\n---\\r\\n\\r\\nThis tab provides insights into email message **False Negative(FN) Submissions** performed by users or administrators in Microsoft Defender for Office 365 where the message reported to have **Malware, Phish or Spam threat** within its **content, URLs or attachments**.\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"8\"},\"name\":\"text - 13 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">False Negative(FN) Admin submissions\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section provides insights into email message **False Negative(FN) Submissions performed by administrators** in Microsoft Defender for Office 365 where the message reported to have Malware, Phish or Spam threat within its content, URLs or attachments.\"},\"name\":\"text - AdminOverridesAllowHeader - Copy\"},{\"type\":1,\"content\":{\"json\":\"### False Negative(FN) Admin Submissions daily trend by submission types \\r\\n**Displays daily counts of False Negative(FN) Admin Submissions grouped by submission type (Spam, Phish, Malware) and content type (Mail, URL, Attachment). Helps to monitor where detections were missed and later submitted by admins as false negatives to Microsoft.**\"},\"name\":\"text - AdminOverridesAllowTrend - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the daily ammount of admin false negative submission by submission type.\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\nlet baseQuery = CloudAppEvents\\r\\n| where ActionType contains \\\"Submission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType);\\r\\nlet Admin_Malware_FN=baseQuery\\r\\n| make-series Count= countif(SubmissionType == \\\"2\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\" ) default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Admin_Malware_FN\\\";\\r\\nlet Admin_Phish_FN=baseQuery\\r\\n| make-series Count= countif(SubmissionType == \\\"1\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\" ) default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Admin_Phish_FN\\\";\\r\\nlet Admin_Spam_FN=baseQuery\\r\\n| make-series Count= countif(SubmissionType == \\\"0\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\") default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Admin_Spam_FN\\\";\\r\\nlet Admin_Malware_URL_FN=baseQuery\\r\\n| make-series Count= countif(SubmissionType == \\\"2\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"URL\\\") default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Admin_Malware_URL_FN\\\";\\r\\nlet Admin_Malware_Attach_FN=baseQuery\\r\\n| make-series Count= countif(SubmissionType == \\\"2\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Attachment\\\") default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Admin_Malware_Attach_FN\\\";\\r\\nlet Admin_Phish_URL_FN=baseQuery\\r\\n| make-series Count= countif(SubmissionType == \\\"1\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"URL\\\") default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Admin_Phish_URL_FN\\\";\\r\\nlet Admin_Phish_Attach_FN=baseQuery\\r\\n| make-series Count= countif(SubmissionType == \\\"1\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Attachment\\\") default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Admin_Phish_Attach_FN\\\";\\r\\nunion Admin_Malware_FN,Admin_Phish_FN,Admin_Spam_FN,Admin_Malware_URL_FN,Admin_Malware_Attach_FN,Admin_Phish_URL_FN,Admin_Phish_Attach_FN\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"TotalAdminSubmissions\",\"color\":\"redDark\"},{\"seriesName\":\"Admin_Phish_FN\",\"color\":\"redBright\"},{\"seriesName\":\"Admin_Spam_FN\",\"color\":\"orange\"},{\"seriesName\":\"Admin_Malware_FN\",\"color\":\"redDark\"},{\"seriesName\":\"Admin_Phish_URL_FN\",\"color\":\"purple\"},{\"seriesName\":\"Admin_Malware_Attach_FN\",\"color\":\"yellowDark\"},{\"seriesName\":\"Admin_Phish_Attach_FN\",\"color\":\"purpleDark\"},{\"seriesName\":\"Admin_Malware_URL_FN\",\"color\":\"yellow\"}]}},\"name\":\"query - 4 - Copy\"},{\"type\":1,\"content\":{\"json\":\"### False Negative(FN) Admin Submissions by submission types \\r\\n**Displays daily counts of False Negative(FN) Admin Submissions grouped by submission type (Spam, Phish, Malware) and content type (Mail, URL, Attachment).**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### False Negative(FN) Admin Submissions by submission State\\r\\n**Displays the total count of False Negative(FN) Admin Submissions by submission State (e.g., Pending, Completed, Failed). Helps track the processing status of admin submissions and identify bottlenecks or errors.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of admin false negative submission by submission type.\\r\\nCloudAppEvents \\r\\n| where ActionType contains \\\"Submission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| extend Admin_SubmissionType=\\r\\niff(SubmissionType == \\\"2\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\",\\\"Admin_Malware_FN\\\",\\r\\niff(SubmissionType == \\\"1\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\",\\\"Admin_Phish_FN\\\",\\r\\niff(SubmissionType == \\\"0\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\",\\\"Admin_Spam_FN\\\",\\r\\niff(SubmissionType == \\\"2\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"URL\\\",\\\"Admin_Malware_URL_FN\\\",\\r\\niff(SubmissionType == \\\"2\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Attachment\\\",\\\"Admin_Malware_Attach_FN\\\",\\r\\niff(SubmissionType == \\\"1\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"URL\\\",\\\"Admin_Phish_URL_FN\\\",\\r\\niff(SubmissionType == \\\"1\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Attachment\\\",\\\"Admin_Phish_Attach_FN\\\",\\r\\n\\\"Other\\\")))))))\\r\\n| where Admin_SubmissionType!=\\\"Other\\\"\\r\\n| summarize count() by Admin_SubmissionType\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":10}},\"customWidth\":\"50\",\"name\":\"query - 1\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of admin false negative submissions by the state of the submission.\\r\\nCloudAppEvents \\r\\n| where ActionType contains \\\"AdminSubmission\\\" \\r\\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| where Record == 29 and SubmissionType in (\\\"0\\\",\\\"1\\\",\\\"2\\\")\\r\\n| summarize count() by tostring(SubmissionState)\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 0\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### False Negative(FN)/False Positive(FP) Admin Submissions by Triage Verdict\\r\\n**Displays the total count of False Negative(FN)/False Positive(FP) Admin Submissions grouped by TriageVerdict (e.g., Malware, Spam, Phish, Clean). Helps assess how submissions were graded during triage and identify detection gaps.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top Admins Submitting False Negatives \\r\\n**Displays the top 15 admin accounts that submitted the highest number of false negative messages (missed detections) via AdminSubmission. Helps identify key contributors to threat remediation and potential patterns in detection gaps.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of admin false negative or false positive submissions by the verdict of the submission grading.\\r\\nCloudAppEvents \\r\\n| where ActionType contains \\\"AdminSubmissionTriage\\\" \\r\\n| extend UserKey = (parse_json(RawEventData)).UserKey, SubmissionState = (parse_json(RawEventData)).SubmissionState,  SubmissionId=(parse_json(RawEventData)).SubmissionId, TriageVerdict=(parse_json(RawEventData)).GradingResult.TriageVerdict \\r\\n| summarize count() by tostring(TriageVerdict)\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 0 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top admins performing false negative submissions\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"AdminSubmissionSubmitted\\\" \\r\\n| extend Record= (parse_json(RawEventData)).RecordType,SubmissionState = (parse_json(RawEventData)).SubmissionState, UserId = (parse_json(RawEventData)).UserId,SubmissionType = parse_json(RawEventData).SubmissionType  \\r\\n| where Record == 29 and SubmissionType in (\\\"0\\\",\\\"1\\\",\\\"2\\\")\\r\\n| summarize count() by tostring(UserId) | sort by count_\\r\\n| top 15 by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":15}},\"customWidth\":\"50\",\"name\":\"query - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### False Negative(FN) Admin Submissions by Top Sender domains of messages\\r\\n**Displays the top 10 sender domains of emails that were submitted by admins as false negatives (e.g., Malware, Spam, Phish). Helps identify external sources frequently associated with undetected threats and prioritise domain-level security measures.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### False Negative(FN) Admin Submissions by admin Detection override types\\r\\n**Displays the top 10 cases where emails were submitted as false negatives by admins, even though they were initially detected by Microsoft Defender for Office 365 but delivered due to an admin policy override. Includes details on PolicyOverride, PolicySource, and DetectionVerdict for deeper insight into override behaviour.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises emails submitted by admins as false negatives, summarizing the data by top 10 sender domains of those emails\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"AdminSubmissionSubmitted\\\" \\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain)\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType in (\\\"2\\\",\\\"1\\\",\\\"0\\\")\\r\\n| summarize count() by P2SenderDomain\\r\\n| project P2SenderDomain, TotalEmails = count_\\r\\n| top 10 by TotalEmails desc \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises emails submitted as false negatives by admins where emails where already detected by MDO but there was a admin policy override\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"AdminSubmissionSubmitted\\\" \\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| extend Admin_SubmissionType=\\r\\niff(SubmissionType == \\\"2\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\",\\\"Admin_Malware_FN\\\",\\r\\niff(SubmissionType == \\\"1\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\",\\\"Admin_Phish_FN\\\",\\r\\niff(SubmissionType == \\\"0\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\",\\\"Admin_Spam_FN\\\",\\\"Other\\\"))),\\r\\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType in (\\\"2\\\",\\\"1\\\",\\\"0\\\") and PolicyOverride !=\\\"NoOverride\\\"\\r\\n| summarize count() by PolicyOverride, PolicyPolicyOverrideType,DetectionVerdict,Admin_SubmissionType\\r\\n| project PolicyOverride, PolicyPolicyOverrideType,DetectionVerdict,Admin_SubmissionType, Emails = count_\\r\\n| top 10 by Emails desc \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"8\"},\"name\":\"group - 11-Fn Admin Submissions\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">False Negative(FN) User submissions\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section provides insights into email message **False Negative(FN) Submissions performed by end users** in Microsoft Defender for Office 365 where the message reported as having Phish, Spam threat within its content, URLs or attachments.\"},\"name\":\"text - AdminOverridesAllowHeader - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"### False Negative(FN) User Submissions daily trend by submission types \\r\\n**Displays daily counts of False Negative(FN) User Submissions grouped by submission type (Spam, Phish and Attack simulations) . Helps to monitor where detections were missed and later submitted by users as false negatives.**\"},\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the daily ammount of users false negative submission by submission type, including phish simulations reported by users.\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\nlet baseQuery = CloudAppEvents\\r\\n| where ActionType contains \\\"UserSubmission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType);\\r\\nlet User_Phish_FN=baseQuery\\r\\n| make-series Count= countif(SubmissionType == \\\"1\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\" ) default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"User_Phish_FN\\\";\\r\\nlet User_Spam_FN=baseQuery\\r\\n| make-series Count= countif(SubmissionType == \\\"0\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\" ) default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"User_Spam_FN\\\";\\r\\nlet User_AttackSim_Submission=baseQuery\\r\\n| make-series Count= countif(ActionType == \\\"AttackSimUserSubmission\\\" and SubmissionContentType==\\\"Mail\\\" ) default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"User_AttackSim_Submission\\\";\\r\\nunion User_Phish_FN,User_Spam_FN,User_AttackSim_Submission\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"TotalAdminSubmissions\",\"color\":\"redDark\"},{\"seriesName\":\"User_Phish_FN\",\"color\":\"redDark\"},{\"seriesName\":\"User_AttackSim_Submission\",\"color\":\"green\"},{\"seriesName\":\"User_Spam_FN\",\"color\":\"orangeDark\"}]}},\"name\":\"query - 4 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### False Negative(FN) User Submissions by submission State\\r\\n**Displays the total count of False Negative(FN) User Submissions by submission State (e.g., Pending, Completed, Failed). Helps track the processing status of user submissions and identify bottlenecks or errors.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### False Negative(FN) User Submissions by Triage Verdict\\r\\n**Displays the total count of False Negative(FN)/False Positive(FP) User Submissions grouped by TriageVerdict (e.g., Malware, Spam, Phish, Clean). Helps assess how submissions were graded during triage and identify detection gaps.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of user false negative submissions by the state of the submission.\\r\\nCloudAppEvents \\r\\n| where ActionType contains \\\"UserSubmission\\\" \\r\\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| where Record == 29 and SubmissionType in (\\\"0\\\",\\\"1\\\")\\r\\n| summarize count() by tostring(SubmissionState)\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 0\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of user false negative or false positive submissions by the verdict of the submission grading.\\r\\nCloudAppEvents \\r\\n| where ActionType contains \\\"UserSubmissionTriage\\\" \\r\\n| extend UserKey = (parse_json(RawEventData)).UserKey, SubmissionState = (parse_json(RawEventData)).SubmissionState,  SubmissionId=(parse_json(RawEventData)).SubmissionId, TriageVerdict=(parse_json(RawEventData)).GradingResult.TriageVerdict \\r\\n| summarize count() by tostring(TriageVerdict)\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 0 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### False Negative(FN) User Submissions of already detected Emails (from Junk folder)\\r\\n**Displays the total count of False Negative(FN) User Submissions where the email message was already detected by Microsoft Defender for Office 365 and the detection action was configured to deliver the message into the Junk folder of the user mailbox. It breaks down the result based on the original detection verdict determined by Microsoft Defender for Office 365. Helps track the user submissions of messages that already had a detection. Consider changing the detection action to Quarantine to avoid these submissions.**\"},\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of user false negative submissions that are already detected by MDO and already delivered in the junk folder\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\\r\\n| extend User_SubmissionType=\\r\\niff(SubmissionType == \\\"1\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Phish_FN\\\",\\r\\niff(SubmissionType == \\\"0\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Spam_FN\\\",\\\"Other\\\")),\\r\\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType in (\\\"1\\\",\\\"0\\\")\\r\\n| join EmailEvents on NetworkMessageId, RecipientObjectId\\r\\n| where DeliveryLocation == \\\"Junk folder\\\"\\r\\n| summarize count() by ThreatTypes,User_SubmissionType\\r\\n| project ThreatTypes,User_SubmissionType, Emails = count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 0 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of user false negative submissions that are already detected by MDO and already delivered in the junk folder\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId,UserId = (parse_json(RawEventData)).UserId\\r\\n| extend User_SubmissionType=\\r\\niff(SubmissionType == \\\"1\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Phish_FN\\\",\\r\\niff(SubmissionType == \\\"0\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Spam_FN\\\",\\\"Other\\\")),\\r\\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType in (\\\"1\\\",\\\"0\\\")\\r\\n| join EmailEvents on NetworkMessageId, RecipientObjectId\\r\\n| where DeliveryLocation == \\\"Junk folder\\\"\\r\\n| extend MDO_detection = parse_json(DetectionMethods) \\r\\n| extend FirstDetection = iif(isempty(MDO_detection), \\\"Clean\\\", tostring(bag_keys(MDO_detection)[0])) \\r\\n| extend FirstSubcategory = iif(FirstDetection != \\\"Clean\\\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \\\": \\\", tostring(MDO_detection[FirstDetection][0])), \\\"No Detection (clean)\\\") \\r\\n| summarize TotalJunkSubmittedEmailCount=count(),PhishEmailCount = countif(FirstDetection ==  \\\"Phish\\\"),SpamEmailCount = countif(FirstDetection ==  \\\"Spam\\\") by tostring(UserId)\\r\\n| project UserId,TotalJunkSubmittedEmailCount, PhishEmailCount, SpamEmailCount\\r\\n| sort by TotalJunkSubmittedEmailCount desc \\r\\n| take 15\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalJunkSubmittedEmailCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"PhishEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"SpamEmailCount\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 0 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### False Negative(FN) User Submissions - Admin review status (Mark and Notify)\\r\\n**Displays counts of False Negative(FN) User Submissions that were reviewed by admins and marked with a notify action. The Mark and Notify action also can be taken automatically with Automated investigation and response (AIR). Helps track cases where admins confirmed user reports and communicated the outcome, supporting transparency and user trust.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### False Negative(FN) User Submissions accuracy vs Admin review verdict\\r\\n**Displays counts of False Negative(FN) User Submissions (Phish, Junk, NotJunk) compared to admin review results. Highlights whether submissions were Correct, Not Correct, or misclassified comparing user submission type with the Admin decision using Mark and Notify action in Microsoft Defender for Office 365 (e.g., Phish reported as Junk, Reported but not malicious).**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises user submissions where admin also performed 'mark and notify' action on the submission\\r\\nlet ReviewResults = CloudAppEvents | where ActionType == \\\"SubmissionNotification\\\" \\r\\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId)\\r\\n| extend Properties = parse_json(RawEventData.ExtendedProperties)\\r\\n| mv-expand element = Properties\\r\\n| where element.Name == \\\"AdminReviewResult\\\"\\r\\n| project SubmissionId, AdminReviewResult = element.Value;\\r\\nCloudAppEvents\\r\\n| where ActionType == \\\"UserSubmission\\\"\\r\\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId), SubmissionType = parse_json(RawEventData).SubmissionType\\r\\n| join kind=leftouter ReviewResults on SubmissionId\\r\\n| extend UserReportedAs=iif(SubmissionType == 1, \\\"Phish\\\",iif(SubmissionType == 2, \\\"Junk\\\",iif(SubmissionType == 3, \\\"NotJunk\\\",\\\"\\\")))\\r\\n| extend ReviewedAccuracy=iif(UserReportedAs==AdminReviewResult, 1,0)\\r\\n| extend Reviewed=iif(isempty(AdminReviewResult),\\\"Not Reviewed\\\",\\\"Reviewed\\\")\\r\\n| project SubmissionId,UserReportedAs,Reviewed,AdminReviewResult, ReviewedAccuracy\\r\\n| summarize count() by Reviewed\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 5\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises user submissions type compared to admin review verdict. \\r\\n//Eg. User reporting a phish but admin review is 'not threat found'\\r\\nlet ReviewResults = CloudAppEvents | where ActionType == \\\"SubmissionNotification\\\" \\r\\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId)\\r\\n| extend Properties = parse_json(RawEventData.ExtendedProperties)\\r\\n| mv-expand element = Properties\\r\\n| where element.Name == \\\"AdminReviewResult\\\"\\r\\n| project SubmissionId, AdminReviewResult = element.Value;\\r\\nCloudAppEvents\\r\\n| where ActionType == \\\"UserSubmission\\\"\\r\\n| extend SubmissionId = tostring(parse_json(RawEventData).SubmissionId), SubmissionType = parse_json(RawEventData).SubmissionType\\r\\n| join kind=leftouter ReviewResults on SubmissionId\\r\\n| extend UserReportedAs=iif(SubmissionType == 1, \\\"Phish\\\",iif(SubmissionType == 2, \\\"Junk\\\",iif(SubmissionType == 3, \\\"NotJunk\\\",\\\"\\\")))\\r\\n| extend ReviewedAccuracy=iif(AdminReviewResult==UserReportedAs, \\\"Correct\\\", iif(AdminReviewResult==\\\"Phish\\\" and UserReportedAs == \\\"Junk\\\", \\\"Phish reported as junk\\\",iif(AdminReviewResult==\\\"Junk\\\" and UserReportedAs == \\\"Phish\\\",\\\"Junk reported as Phish\\\",iif(AdminReviewResult==\\\"NotJunk\\\",\\\"Reported but not malicious or spam\\\",iif(isempty(AdminReviewResult),\\\"Not Reviewed\\\",\\\"Not correct\\\")))))\\r\\n| extend Reviewed=iif(isempty(AdminReviewResult),\\\"Not Reviewed\\\",\\\"Reviewed\\\")\\r\\n| project SubmissionId,UserReportedAs,Reviewed,AdminReviewResult, ReviewedAccuracy\\r\\n| where Reviewed==\\\"Reviewed\\\"\\r\\n| summarize count() by ReviewedAccuracy\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 6\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 P2 Email Senders domains in False Negative(FN) User Submissions \\r\\n**Displays the top 10 P2 email sender domains of inbound emails reported by users as false negatives (missed detections). Includes total inbound email volume and calculates the percentage of user submissions per domain to highlight high-risk sources.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 P2 Individual Email Senders in False Negative(FN) User Submissions \\r\\n**Displays the top 10 P2 individual email sender addresses of inbound emails reported by users as false negatives (missed detections). Includes total inbound email volume and calculates the percentage of user submissions per sender to highlight high-risk sources.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises top 10 sender domains of inbound emails submitted as false negatives by users.\\r\\nlet TotalInboundbySender=\\r\\nEmailEvents\\r\\n| where EmailDirection ==\\\"Inbound\\\"\\r\\n| summarize count() by SenderFromDomain;\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\" \\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),RecipientObjectId=AccountObjectId,NetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType in (\\\"1\\\",\\\"0\\\")\\r\\n| join EmailEvents on NetworkMessageId, RecipientObjectId\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| summarize UserSubmissions=count() by SenderFromDomain\\r\\n| join TotalInboundbySender on SenderFromDomain\\r\\n| extend UserSubmissions_Percentage = todouble(round(UserSubmissions / todouble(count_) * 100, 2))\\r\\n| project SenderFromDomain, UserSubmissions, TotalInboundEmail=count_,UserSubmissions_Percentage\\r\\n| top 10 by UserSubmissions desc \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"UserSubmissions\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalInboundEmail\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"UserSubmissions_Percentage\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises top 10 sender email addresses of inbound emails submitted as false negatives by users.\\r\\nlet TotalInboundbySender=\\r\\nEmailEvents\\r\\n| where EmailDirection ==\\\"Inbound\\\"\\r\\n| summarize count() by SenderFromAddress;\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\" \\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),RecipientObjectId=AccountObjectId,NetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType in (\\\"1\\\",\\\"0\\\")\\r\\n| join EmailEvents on NetworkMessageId, RecipientObjectId\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| summarize UserSubmissions=count() by SenderFromAddress\\r\\n| join TotalInboundbySender on SenderFromAddress\\r\\n| extend UserSubmissions_Percentage = todouble(round(UserSubmissions / todouble(count_) * 100, 2))\\r\\n| project SenderFromAddress, UserSubmissions, TotalInboundEmail=count_,UserSubmissions_Percentage\\r\\n| top 10 by UserSubmissions desc \",\"size\":0,\"showAnalytics\":true,\"title\":\"User Email Submissions (FN)- Top 10 Inbound P2 Senders\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"UserSubmissions\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalInboundEmail\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"UserSubmissions_Percentage\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Intra-org Email Senders in False Negative(FN) User Submissions \\r\\n**Displays the top 10 email senders of intra-org emails reported by users as false negatives (missed detections). Includes total intra-org email volume and calculates the percentage of user submissions per sender to highlight high-risk sources.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Intra-org Email Subjects in False Negative(FN) User Submissions \\r\\n**Displays the top 10 Email Subjects of intra-org emails reported by users as false negatives (missed detections). Helps to highlight high-risk intra-org email sources.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises top 10 sender email address of intra-org emails submitted as false negatives by users.\\r\\nlet TotalInboundbySender=\\r\\nEmailEvents\\r\\n| where EmailDirection ==\\\"Intra-org\\\"\\r\\n| summarize count() by SenderFromAddress;\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\" \\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),RecipientObjectId=AccountObjectId,NetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType in (\\\"1\\\",\\\"0\\\")\\r\\n| join EmailEvents on NetworkMessageId, RecipientObjectId\\r\\n| where EmailDirection == \\\"Intra-org\\\"\\r\\n| summarize UserSubmissions=count() by SenderFromAddress\\r\\n| join TotalInboundbySender on SenderFromAddress\\r\\n| extend UserSubmissions_Percentage = todouble(round(UserSubmissions / todouble(count_) * 100, 2))\\r\\n| project SenderFromAddress, UserSubmissions, TotalIntraorgEmail=count_, UserSubmissions_Percentage\\r\\n| top 10 by UserSubmissions desc \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"UserSubmissions\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"TotalIntraorgEmail\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"UserSubmissions_Percentage\",\"formatter\":0,\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises top 10 subjects of intra-org emails submitted as false negatives by users.\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\\r\\n| extend User_SubmissionType=\\r\\niff(SubmissionType == \\\"1\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Phish_FN\\\",\\r\\niff(SubmissionType == \\\"0\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Spam_FN\\\",\\\"Other\\\")),\\r\\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType in (\\\"1\\\",\\\"0\\\")\\r\\n| join EmailEvents on NetworkMessageId, RecipientObjectId\\r\\n| where EmailDirection == \\\"Intra-org\\\"\\r\\n| summarize count() by Subject\\r\\n| project Subject,UserSubmissions = count_\\r\\n| top 10 by UserSubmissions desc \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Subject\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"70ch\"}},{\"columnMatch\":\"UserSubmissions\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8 - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Detection Overrides defined by Admins in False Negative(FN) User Submissions \\r\\n**Displays the top 10 use cases where users submitted emails as false negatives (Spam or Phish) that were already detected by Microsoft Defender for Office 365 but delivered due to an admin-defined policy override. Includes details on OrgLevelAction, OrgLevelPolicy, and ThreatTypes for deeper insight into override behaviour.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Detection Overrides defined by Users in False Negative(FN) User Submissions \\r\\n**Displays the top 10 use cases where users submitted emails as false negatives (Spam or Phish) that were already detected by Microsoft Defender for Office 365 but delivered due to a user-defined override. Includes details on UserLevelAction, UserLevelPolicy, and ThreatTypes for deeper insight into override behaviour.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises emails submitted as false negatives by users where emails where already detected by MDO but there was an admin definded policy override.\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\\r\\n| extend User_SubmissionType=\\r\\niff(SubmissionType == \\\"1\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Phish_FN\\\",\\r\\niff(SubmissionType == \\\"0\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Spam_FN\\\",\\\"Other\\\")),\\r\\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType in (\\\"1\\\",\\\"0\\\")\\r\\n| join EmailEvents on NetworkMessageId, RecipientObjectId\\r\\n| where ThreatTypes !=\\\"\\\"and OrgLevelAction!=\\\"\\\"\\r\\n| summarize count() by OrgLevelAction, OrgLevelPolicy,ThreatTypes,User_SubmissionType\\r\\n| project OrgLevelAction, OrgLevelPolicy,ThreatTypes,User_SubmissionType, UserSubmissions = count_\\r\\n| top 10 by UserSubmissions desc \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"OrgLevelPolicy\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"48ch\"}},{\"columnMatch\":\"UserSubmissions\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises emails submitted as false negatives by users where emails where already detected by MDO but there was an policy override.\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\\r\\n| extend User_SubmissionType=\\r\\niff(SubmissionType == \\\"1\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Phish_FN\\\",\\r\\niff(SubmissionType == \\\"0\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Spam_FN\\\",\\\"Other\\\")),\\r\\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType in (\\\"1\\\",\\\"0\\\")\\r\\n| join EmailEvents on NetworkMessageId, RecipientObjectId\\r\\n| where ThreatTypes !=\\\"\\\"and UserLevelAction!=\\\"\\\"\\r\\n| summarize count() by UserLevelAction, UserLevelPolicy,ThreatTypes,User_SubmissionType\\r\\n| project UserLevelAction, UserLevelPolicy,ThreatTypes,User_SubmissionType, UserSubmissions = count_\\r\\n| top 10 by UserSubmissions desc \",\"size\":0,\"showAnalytics\":true,\"title\":\"User Email Submissions (FN)- Top 10 Detection Overrides by Users\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"UserLevelPolicy\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"48ch\"}},{\"columnMatch\":\"UserSubmissions\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"30ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 users performing the most False Negative(FN) User Submissions\\r\\n**Displays the Top 10 user accounts that performed the highest number of False Negative(FN) User Submissions (missed detections). Helps identify individuals most engaged in reporting suspicious, malicious messages and potential patterns in detection gaps.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 users performing the most User Submissions of Attack simulation messages\\r\\n**Displays the top 10 user accounts that reported phishing simulation emails during cyber security awareness campaigns. Supports evaluation of cyber security awareness programme effectiveness and identifies highly engaged users.**\"},\"customWidth\":\"50\",\"name\":\"text - AdminOverridesAllowTrend - Copy - Copy - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top 10 users performing false negative submissions\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\" \\r\\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| where Record == 29 and SubmissionType in (\\\"0\\\",\\\"1\\\")\\r\\n| extend UserId = (parse_json(RawEventData)).UserId\\r\\n| summarize count() by tostring(UserId) | sort by count_\\r\\n| top 10 by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":15}},\"customWidth\":\"50\",\"name\":\"query - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top users reporting the phishing simulation emails.\\r\\nCloudAppEvents \\r\\n| extend Record= (parse_json(RawEventData)).RecordType \\r\\n| extend SubmissionState = (parse_json(RawEventData)).SubmissionState \\r\\n| extend UserId = (parse_json(RawEventData)).UserId\\r\\n| where Record == 29\\r\\n| where ActionType == \\\"AttackSimUserSubmission\\\" \\r\\n| summarize count() by tostring(UserId) | sort by count_\\r\\n| top 10 by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":15}},\"customWidth\":\"50\",\"name\":\"query - 2 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"8\"},\"name\":\"group - 11 - FN User submissions\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"# False Positive(FP) Submissions insights\\r\\n\\r\\n---\\r\\n\\r\\nThis tab provides insights into email message **False Positive(FP) Submissions** performed by users or administrators in Microsoft Defender for Office 365 where the message was flagged as a threat by Microsoft Defender for Office 365 but was later reported as No Threat by administrators or users.\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"10\"},\"name\":\"FP Description\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">False Positive(FP) Admin Submissions\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nAdministrator submissions represent escalated false positive reports submitted by security team members rather than end users. These typically involve more complex cases requiring expert review, such as recurring issues affecting multiple users, business-critical communications being blocked, or suspected policy misconfigurations. Admin submissions carry higher priority and can result in actions as allow-list additions or global policy changes to prevent widespread user impact.\"},\"name\":\"text - 5\"},{\"type\":1,\"content\":{\"json\":\"<br>\\r\\n### Admin Submission Volume and Type Breakdown\\r\\n\\r\\n**These charts track the volume and composition of administrator-initiated false positive submissions. The trend chart shows daily submission patterns across Email, URL, and Attachment types, while the pie chart reveals the distribution among these categories. Spikes in admin submissions often signal systemic issues requiring immediate policy review, as admins typically escalate only the most impactful or recurring problems.**\"},\"name\":\"text - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the daily ammount of admin false positive submission by submission type.\\r\\nlet minTime = toscalar(CloudAppEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(CloudAppEvents | summarize max(Timestamp));\\r\\nlet baseQuery = CloudAppEvents\\r\\n| where ActionType contains \\\"Submission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType);\\r\\nlet Admin_Email_FP=baseQuery\\r\\n| make-series Count= countif(SubmissionType == \\\"3\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\" ) default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Admin_Email_FP\\\";\\r\\nlet Admin_URL_FP=baseQuery\\r\\n| make-series Count= countif(SubmissionType == \\\"3\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"URL\\\") default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Admin_URL_FP\\\";\\r\\nlet Admin_Attach_FP=baseQuery\\r\\n| make-series Count= countif(SubmissionType == \\\"3\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Attachment\\\") default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Admin_Attach_FP\\\";\\r\\nunion Admin_Email_FP,Admin_URL_FP,Admin_Attach_FP\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"TotalAdminSubmissions\",\"color\":\"redDark\"},{\"seriesName\":\"Admin_Phish_FN\",\"color\":\"redBright\"},{\"seriesName\":\"Admin_Spam_FN\",\"color\":\"orange\"},{\"seriesName\":\"Admin_Malware_FN\",\"color\":\"redDark\"},{\"seriesName\":\"Admin_Phish_URL_FN\",\"color\":\"purple\"},{\"seriesName\":\"Admin_Malware_Attach_FN\",\"color\":\"yellowDark\"},{\"seriesName\":\"Admin_Phish_Attach_FN\",\"color\":\"purpleDark\"},{\"seriesName\":\"Admin_Malware_URL_FN\",\"color\":\"yellow\"},{\"seriesName\":\"Admin_Email_FP\",\"color\":\"redDark\"},{\"seriesName\":\"Admin_URL_FP\",\"color\":\"orangeDark\"},{\"seriesName\":\"Admin_Attach_FP\",\"color\":\"yellow\"}]}},\"customWidth\":\"66\",\"name\":\"query - 4 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of admin false positive submission by submission type.\\r\\nCloudAppEvents \\r\\n| where ActionType contains \\\"Submission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| extend Admin_SubmissionType=\\r\\niff(SubmissionType == \\\"3\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\",\\\"Admin_Email_FP\\\",\\r\\niff(SubmissionType == \\\"3\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"URL\\\",\\\"Admin_URL_FP\\\",\\r\\niff(SubmissionType == \\\"3\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Attachment\\\",\\\"Admin_Attach_FP\\\",\\r\\n\\\"Other\\\")))\\r\\n| where Admin_SubmissionType!=\\\"Other\\\"\\r\\n| summarize count() by Admin_SubmissionType\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":10}},\"customWidth\":\"33\",\"name\":\"query - 1\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### False Positive(FP) Admin Submissions by submission state<br>\\r\\n\\r\\n**Displays the total count of False Positive(FP) Admin Submissions by submission State (e.g., Pending, Completed, Failed). Helps track the processing status of admin submissions and identify bottlenecks or errors.**\"},\"customWidth\":\"50\",\"name\":\"text - 7\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top Admins Submitting False Positives<br>\\r\\n\\r\\n**Displays the top 15 admin accounts that submitted the highest number of false positive messages via AdminSubmission.**\"},\"customWidth\":\"50\",\"name\":\"text - 7 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of admin false positive submissions by the state of the submission.\\r\\nCloudAppEvents \\r\\n| where ActionType contains \\\"AdminSubmission\\\" \\r\\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| where Record == 29 and SubmissionType == \\\"3\\\"\\r\\n| summarize count() by tostring(SubmissionState)\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 0\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top admins performing false positive submissions.\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"AdminSubmissionSubmitted\\\" \\r\\n| extend Record= (parse_json(RawEventData)).RecordType,SubmissionState = (parse_json(RawEventData)).SubmissionState, UserId = (parse_json(RawEventData)).UserId,SubmissionType = parse_json(RawEventData).SubmissionType  \\r\\n| where Record == 29 and SubmissionType ==\\\"3\\\"\\r\\n| summarize count() by tostring(UserId) | sort by count_\\r\\n| top 15 by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":15}},\"customWidth\":\"50\",\"name\":\"query - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Admin False Positive Phish Detection Breakdown<br>\\r\\n\\r\\n**Displays the count of administrator-submitted false positive email reports (legitimate emails flagged as phishing) grouped by detection method. Helps identify which filtering technologies contribute most to misclassification.**\"},\"customWidth\":\"50\",\"name\":\"text - 8\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Admin False Positive Spam Detection Breakdown<br>\\r\\n\\r\\n**Shows the count of administrator-submitted false positive email reports (legitimate emails flagged as spam) grouped by detection method. Helps identify which filtering technologies most often misclassify valid messages.**\"},\"customWidth\":\"50\",\"name\":\"text - 8 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CloudAppEvents \\r\\n| where ActionType == \\\"AdminSubmissionSubmitted\\\" \\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| extend Admin_SubmissionType=\\r\\niff(SubmissionType == \\\"3\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\" ,\\\"Admin_Email_FP\\\",\\r\\n\\\"Other\\\"),DetectionMethod=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdictControlSource),\\r\\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType == \\\"3\\\" and DetectionVerdict ==\\\"Phish\\\" \\r\\n| summarize count() by DetectionMethod\\r\\n| project DetectionMethod,Emails = count_\\r\\n\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 0 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the original detection technology of emails submitted as spam false positive by admins\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"AdminSubmissionSubmitted\\\" \\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| extend Admin_SubmissionType=\\r\\niff(SubmissionType == \\\"3\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\" ,\\\"Admin_Email_FP\\\",\\r\\n\\\"Other\\\"),DetectionMethod=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdictControlSource),\\r\\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType == \\\"3\\\" and DetectionVerdict ==\\\"Spam\\\" \\r\\n| summarize count() by DetectionMethod\\r\\n| project DetectionMethod,Emails = count_\\r\\n\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 0 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Sender Domains for Admin False Positive Submissions<br>\\r\\n\\r\\n**Lists the top 10 sender domains of emails reported as false positives by administrators (legitimate messages incorrectly flagged as spam or phishing). Helps identify domains frequently misclassified.**\"},\"customWidth\":\"50\",\"name\":\"text - 9\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Admin False Positive Submissions by Original Threat Verdict<br>\\r\\n\\r\\n**Displays all administrator-submitted false positive emails by their original filter verdict (e.g., spam, phishing) and policy override details. Helps identify which threat categories are most often misclassified.**\"},\"customWidth\":\"50\",\"name\":\"text - 9 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top 10 sender domains of emails which are submitted as false positive by admins\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"AdminSubmissionSubmitted\\\" \\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain)\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType ==\\\"3\\\"\\r\\n| summarize count() by P2SenderDomain\\r\\n| project P2SenderDomain, Emails = count_\\r\\n| top 10 by Emails desc \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises all emails submitted as false positive by admins summarizing by the original filter verdict threat type\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"AdminSubmissionSubmitted\\\" \\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| extend Admin_SubmissionType=\\r\\niff(SubmissionType == \\\"3\\\" and ActionType == \\\"AdminSubmissionSubmitted\\\" and SubmissionContentType==\\\"Mail\\\" ,\\\"Admin_Email_FP\\\",\\r\\n\\\"Other\\\"),\\r\\nP2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain),NetworkMessageId=tostring((parse_json(RawEventData).ObjectId)),DetectionVerdict=tostring((parse_json(RawEventData)).DeliveryMessageInfo.FinalFilterVerdict),PolicyOverride=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicyOverride),PolicyPolicyOverrideType=tostring((parse_json(RawEventData)).DeliveryMessageInfo.PolicySource)\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType == \\\"3\\\"\\r\\n| summarize count() by PolicyOverride,DetectionVerdict,Admin_SubmissionType\\r\\n| project PolicyOverride, DetectionVerdict,Admin_SubmissionType, Emails = count_\\r\\n| top 10 by Emails desc \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"10\"},\"name\":\"group - 11 - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">False Positive (FP) User Submissions\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section provides insights into email message False Postive(FP) Submissions performed by end users in Microsoft Defender for Office 365 where the message was flagged as a threat by Microsoft Defender for Office 365 but was later reported as No Threat by users. User submissions are critical feedback mechanisms that help security teams identify overly aggressive detection rules, refine security policies, and reduce user friction. High false positive rates can erode user trust and lead to security fatigue, so monitoring these metrics helps balance protection with productivity.\"},\"name\":\"text - 0\"},{\"type\":1,\"content\":{\"json\":\"<br>\\r\\n### User Submission Trend\\r\\n\\r\\n**Displays the daily volume of false positive submissions from end users. A sudden spike may indicate a new detection rule causing widespread misclassification, while a declining trend suggests improving detection accuracy. Monitoring this trend helps security teams respond quickly to detection issues before they impact user productivity.**\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the daily ammount of user false positive submission by submission type.\\r\\nlet minTime = toscalar(CloudAppEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(CloudAppEvents | summarize max(Timestamp));\\r\\nlet User_Email_FP=CloudAppEvents\\r\\n| where ActionType contains \\\"UserSubmission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| make-series Count= countif(SubmissionType == \\\"3\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\" ) default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"User_Email_FP\\\";\\r\\nUser_Email_FP\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"TotalAdminSubmissions\",\"color\":\"redDark\"},{\"seriesName\":\"User_Phish_FN\",\"color\":\"redDark\"},{\"seriesName\":\"User_AttackSim_Submission\",\"color\":\"green\"},{\"seriesName\":\"User_Spam_FN\",\"color\":\"orangeDark\"},{\"seriesName\":\"User_Email_FP\",\"color\":\"green\"}]}},\"customWidth\":\"100\",\"name\":\"query - 4 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### User False Positive Submissions by State<br>\\r\\n\\r\\n**Displays the total number of user-reported false positive email submissions grouped by their processing state (e.g., pending, completed). Helps track submission workflow and resolution progress.**\"},\"customWidth\":\"50\",\"name\":\"text - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top Users Performing False Positive Submissions<br>\\r\\n\\r\\n**Lists the top 15 users who reported emails as false positives (legitimate messages incorrectly flagged as threats). Helps identify frequent reporters and potential training or policy adjustment needs.**\"},\"customWidth\":\"50\",\"name\":\"text - 2 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of user false positive submission by submission state.\\r\\nCloudAppEvents \\r\\n| where ActionType contains \\\"UserSubmission\\\" \\r\\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| where Record == 29 and SubmissionType == \\\"3\\\"\\r\\n| summarize count() by tostring(SubmissionState)\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 0\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top users performing false positive submissions.\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\" \\r\\n| extend Record = (parse_json(RawEventData)).RecordType,SubmissionState = parse_json(RawEventData).SubmissionState,SubmissionId=parse_json(RawEventData).SubmissionId,SubmissionType = parse_json(RawEventData).SubmissionType,SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType)\\r\\n| where Record == 29 and SubmissionType == \\\"3\\\"\\r\\n| extend UserId = (parse_json(RawEventData)).UserId\\r\\n| summarize count() by tostring(UserId) | sort by count_\\r\\n| top 15 by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":15}},\"customWidth\":\"50\",\"name\":\"query - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### User False Positive Submissions by Original Phish Detection Verdict<br>\\r\\n\\r\\n**Shows the number of user-reported false positive emails originally flagged by phishing detection filters, grouped by verdict type. Helps identify which phishing detection methods most often misclassify legitimate messages.**\"},\"customWidth\":\"50\",\"name\":\"text - 3\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### User False Positive Submissions by Original Spam Detection Verdict<br>\\r\\n\\r\\n**Shows the number of user-reported false positive emails originally flagged by spam detection filters, grouped by verdict type. Helps identify which spam detection methods most often misclassify legitimate messages.**\"},\"customWidth\":\"50\",\"name\":\"text - 3 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of user false positive submission by original phish filter detected verdict.\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\\r\\n| extend User_SubmissionType=\\r\\niff(SubmissionType == \\\"3\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Email_FP\\\",\\r\\n\\\"Other\\\"),\\r\\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType ==\\\"3\\\"\\r\\n| join EmailEvents on NetworkMessageId, RecipientObjectId\\r\\n| where EmailDirection == \\\"Inbound\\\" and DetectionMethods has 'Phish'\\r\\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":15}},\"customWidth\":\"50\",\"name\":\"query - 2 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of user false positive submission by original spam filter detected verdict.\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\\r\\n| extend User_SubmissionType=\\r\\niff(SubmissionType == \\\"3\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Email_FP\\\",\\r\\n\\\"Other\\\"),\\r\\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType ==\\\"3\\\"\\r\\n| join EmailEvents on NetworkMessageId, RecipientObjectId\\r\\n| where EmailDirection == \\\"Inbound\\\" and DetectionMethods has 'Spam'\\r\\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Spam=tostring(column_ifexists('Spam', ''))\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":15}},\"customWidth\":\"50\",\"name\":\"query - 2 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Sender Domains for User False Positive Submissions<br>\\r\\n\\r\\n**Lists the top 10 sender domains of emails reported as false positives by users (legitimate messages incorrectly flagged as threats). Helps identify domains frequently misclassified.**\"},\"customWidth\":\"50\",\"name\":\"text - 4\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Senders in User False Positive Submissions<br>\\r\\n\\r\\n**Displays the top 10 email senders whose messages were reported as false positives by users (legitimate emails incorrectly flagged as threats). Helps identify senders frequently misclassified.**\"},\"customWidth\":\"50\",\"name\":\"text - 4 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\" \\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType),P2SenderDomain=tostring((parse_json(RawEventData)).P2SenderDomain)\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType == \\\"3\\\"\\r\\n| summarize count() by P2SenderDomain\\r\\n| project P2SenderDomain, Emails = count_\\r\\n| top 10 by Emails desc \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top 10 senders seen in false positive user submission\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\\r\\n| extend User_SubmissionType=\\r\\niff(SubmissionType == \\\"3\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Email_FP\\\",\\r\\n\\\"Other\\\"),\\r\\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType == \\\"3\\\"\\r\\n| join EmailEvents on NetworkMessageId, RecipientObjectId\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| summarize count() by SenderMailFromAddress\\r\\n| project SenderMailFromAddress,Emails = count_\\r\\n| top 10 by Emails desc \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Subjects in User False Positive Submissions<br>\\r\\n\\r\\n**Displays the top 10 email subjects reported as false positives by users (legitimate messages incorrectly flagged as threats). Helps identify common patterns in misclassified emails.**\"},\"customWidth\":\"50\",\"name\":\"text - 4 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Top 10 Intra-Org Senders in User False Positive Submissions<br>\\r\\n\\r\\n**Displays the top 10 internal senders whose emails were reported as false positives by users (legitimate intra-org messages incorrectly flagged as threats). Helps identify internal communication patterns causing misclassification.**\"},\"customWidth\":\"50\",\"name\":\"text - 4 - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top 10 subjects seen in false positive user submission\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\\r\\n| extend User_SubmissionType=\\r\\niff(SubmissionType == \\\"3\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Email_FP\\\",\\r\\n\\\"Other\\\"),\\r\\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType ==\\\"3\\\"\\r\\n| join EmailEvents on NetworkMessageId, RecipientObjectId\\r\\n| where EmailDirection == \\\"Inbound\\\"\\r\\n| summarize count() by Subject\\r\\n| project Subject,Emails = count_\\r\\n| top 10 by Emails desc \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Subject\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"70ch\"}},{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8 - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the top 10 senders seen in intra-org false positive user submission\\r\\nCloudAppEvents \\r\\n| where ActionType == \\\"UserSubmission\\\"\\r\\n| extend SubmissionType = tostring((parse_json(RawEventData)).SubmissionType),SubmissionContentType=tostring((parse_json(RawEventData)).SubmissionContentType), RecipientObjectId=AccountObjectId\\r\\n| extend User_SubmissionType=\\r\\niff(SubmissionType == \\\"3\\\" and ActionType == \\\"UserSubmission\\\" and SubmissionContentType==\\\"Mail\\\",\\\"User_Email_FP\\\",\\r\\n\\\"Other\\\"),\\r\\nNetworkMessageId=tostring((parse_json(RawEventData).ObjectId))\\r\\n| where SubmissionContentType == \\\"Mail\\\" and SubmissionType ==\\\"3\\\"\\r\\n| join EmailEvents on NetworkMessageId, RecipientObjectId\\r\\n| where EmailDirection == \\\"Intra-org\\\"\\r\\n| summarize count() by SenderMailFromAddress\\r\\n| project SenderMailFromAddress,Emails = count_\\r\\n| top 10 by Emails desc \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Emails\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 8 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"10\"},\"name\":\"group - 11 - Copy - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"# File Malware Detections (SharePoint, Teams and OneDrive)\\r\\n\\r\\n---\\r\\n\\r\\nThis tab provides insights into malicious file detections across Microsoft collaboration platforms such as SharePoint, OneDrive, and Teams.\\r\\n\\r\\n[<p><b>Safe Attachments for SharePoint, OneDrive, and Microsoft Teams</b></p>](https://learn.microsoft.com/en-us/defender-office-365/safe-attachments-for-spo-odfb-teams-about)\\r\\n[<p><b>Built-in virus protection in SharePoint, SharePoint Embedded, OneDrive, and Microsoft Teams</b></p>](https://learn.microsoft.com/en-us/defender-office-365/anti-malware-protection-for-spo-odfb-teams-about) \"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"9\"},\"name\":\"File Malware Description\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">File Malware Detection (SharePoint, OneDrive, and Teams)\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section monitors malware detections in files stored across Microsoft 365 collaboration platforms. Microsoft Defender for Office 365 and built-in SharePoint Online antivirus work together to scan files uploaded to SharePoint, OneDrive, and Teams. Understanding file-based malware patterns helps protect collaborative workspaces and identify potential security risks in shared content.\"},\"name\":\"text - 0\"},{\"type\":1,\"content\":{\"json\":\"### File Malware Detection Trend<br>\\r\\n\\r\\n**This visual tracks the daily volume of malware detections in files across all Microsoft 365 workloads. Spikes in detection activity may indicate targeted attacks or emerging malware campaigns affecting collaborative platforms. Regular monitoring helps identify unusual patterns that require investigation.**\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total files located on SharePoint, OneDrive and Teams with Malware detections over time summarizing the data daily. \\r\\nCloudAppEvents\\r\\n| where ActionType == 'FileMalwareDetected'\\r\\n| make-series Count = count() default = 0 on Timestamp step 1d \",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"FileMalwareDetections\",\"color\":\"redDark\"}],\"showDataPoints\":true}},\"customWidth\":\"100\",\"name\":\"query - 0\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Malware Family Analysis - Defender for Office 365<br>\\r\\n\\r\\n**Provides a visual breakdown of malware detections in files scanned by Microsoft Defender for Office 365 across SharePoint, OneDrive, and Teams. The pie chart shows the distribution of malware families, while the table lists total detections per family, helping identify dominant threats and trends in collaboration platforms.**\"},\"customWidth\":\"50\",\"name\":\"text - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Malware Family Analysis - SharePoint AV<br>\\r\\n\\r\\n**Provides a visual summary of malware detections in files across SharePoint, OneDrive, and Teams using built-in SharePoint antivirus. The pie chart shows the distribution of malware families, while the table lists total detections per family, helping identify prevalent threats and trends in collaboration environments.**\"},\"customWidth\":\"50\",\"name\":\"text - 2 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CloudAppEvents\\r\\n| where ActionType == 'FileMalwareDetected' and UserAgent =~ 'MS Scanner ATP'\\r\\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\\r\\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"RawinfoVirusInfo\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"RawinfoVirusInfo\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"RawinfoVirusInfo\",\"createOtherGroup\":20,\"showMetrics\":false}},\"customWidth\":\"25\",\"name\":\"query - 1\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total Malware detections of files located on SharePoint, OneDrive and Teams over time summarizing the data by the various Malware families detected focusing on Defender for Office 365 detections (detonations). \\r\\nCloudAppEvents\\r\\n| where ActionType == 'FileMalwareDetected' and UserAgent =~ 'MS Scanner ATP'\\r\\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\\r\\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_\\r\\n| project RawinfoVirusInfo, Files=count_\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Files\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"RawinfoVirusInfo\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"RawinfoVirusInfo\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"RawinfoVirusInfo\",\"createOtherGroup\":15}},\"customWidth\":\"25\",\"name\":\"query - 1 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises total Malware detections of files located on SharePoint, OneDrive and Teams over time summarizing the data by the various Malware families detected focusing on built-in SharePoint AV detections. \\r\\nCloudAppEvents\\r\\n| where ActionType == 'FileMalwareDetected' and isempty(UserAgent)\\r\\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\\r\\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"xAxis\":\"RawinfoVirusInfo\",\"createOtherGroup\":20,\"showMetrics\":false}},\"customWidth\":\"25\",\"name\":\"query - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CloudAppEvents\\r\\n| where ActionType == 'FileMalwareDetected' and isempty(UserAgent)\\r\\n| project ObjectName, UserAgent, RawinfoVirusInfo = RawEventData.VirusInfo\\r\\n| summarize count() by tostring(RawinfoVirusInfo) | sort by count_\\r\\n| project RawinfoVirusInfo, Files=count_\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Files\",\"formatter\":3,\"formatOptions\":{\"palette\":\"redDark\",\"customColumnWidthSetting\":\"40ch\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"chartSettings\":{\"xAxis\":\"RawinfoVirusInfo\",\"createOtherGroup\":10}},\"customWidth\":\"25\",\"name\":\"query - 2 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Malware Detections by Location<br>\\r\\n\\r\\n**Displays the number of malware detections grouped by specific SharePoint sites or OneDrive locations. Helps identify which sites have the highest volume of detected threats for targeted remediation and security hardening.**\"},\"customWidth\":\"50\",\"name\":\"text - 3\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Malware Detections by Application<br>\\r\\n\\r\\n**Summarizes malware detections across Microsoft collaboration apps, including SharePoint, OneDrive, and Teams. Helps identify which applications experience the highest volume of detected threats for targeted security measures.**\"},\"customWidth\":\"50\",\"name\":\"text - 3 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CloudAppEvents\\r\\n| where ActionType == 'FileMalwareDetected'\\r\\n| project location=(split(RawEventData.SiteUrl, '/')[4])\\r\\n| summarize count() by tostring(location)\\r\\n| sort by count_ desc\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"location\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"createOtherGroup\":10}},\"customWidth\":\"50\",\"name\":\"query - 4\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CloudAppEvents\\r\\n| where ActionType == 'FileMalwareDetected'\\r\\n| extend Appwithteams = iff(Application =~ 'Microsoft SharePoint Online',strcat(Application,' / Teams Files'),Application)\\r\\n| extend Appwithteams = trim_start('Microsoft',Appwithteams) | summarize count() by Appwithteams\\r\\n| sort by count_ desc\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 4\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"9\"},\"name\":\"group - 4\",\"styleSettings\":{\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"# Post Delivery Detections\\r\\n\\r\\n---\\r\\n\\r\\nThis tab provides insights into threats detected after email delivery to user mailboxes by mechanisms such as Zero-hour auto purge (ZAP) in Microsoft Defender for Office 365.\\r\\n\\r\\n[<p><b>Learn more</b></p>](https://learn.microsoft.com/en-us/defender-office-365/zero-hour-auto-purge)\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"11\"},\"name\":\"Post Delivery Tab Description\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Post Delivery Protection offered by ZAP\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section provides insights into Microsoft Defender for Office 365's post-delivery protection capabilities through Zero-Hour Auto Purge (ZAP). ZAP is a critical security feature that continuously monitors delivered emails and automatically removes messages that are later identified as malicious. These visuals help track ZAP effectiveness, response times, and remediation patterns.\"},\"name\":\"text - 0\"},{\"type\":1,\"content\":{\"json\":\"### Daily ZAP Post-Delivery Actions<br>\\r\\n\\r\\n**Shows the daily count of emails that were remediated post-delivery by Zero-Hour Auto Purge (ZAP). Helps track how often threats are detected and removed after reaching user mailboxes.**\"},\"customWidth\":\"50\",\"name\":\"text - 1\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Daily ZAP Actions by Detection Type<br>\\r\\n\\r\\n**Visualizes the daily count of post-delivery remediation actions performed by Zero-Hour Auto Purge (ZAP), broken down by detection type (Spam ZAP, Phish ZAP, Malware ZAP). Helps track which threat categories are most frequently remediated after delivery.**\"},\"customWidth\":\"50\",\"name\":\"text - 1 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the daily ammount of emails that had a post delivery action from zero-hour auto purge.\\r\\nEmailPostDeliveryEvents \\r\\n| where ActionType has \\\"ZAP\\\"\\r\\n| make-series Count = count() default = 0 on Timestamp step 1d \\r\\n| extend Details = \\\"Zapped Emails\\\";\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"50\",\"name\":\"query - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the daily ammount of emails that had a post delivery action from zero-hour auto purge, summarizing by phish,spam or malware detection action\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\nlet baseQuery = EmailPostDeliveryEvents\\r\\n| where ActionType has \\\"ZAP\\\";\\r\\nlet szap=baseQuery\\r\\n| where ActionType has 'Spam ZAP' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Spam ZAP\\\";\\r\\nlet pzap=baseQuery\\r\\n| where ActionType has 'Phish ZAP' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Phish ZAP\\\";\\r\\nlet mzap=baseQuery\\r\\n| where ActionType has 'Malware ZAP' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Malware ZAP\\\";\\r\\nunion szap,pzap,mzap\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"50\",\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### ZAP Remediation by Destination<br>\\r\\n\\r\\n**This visual shows where ZAP moves malicious emails during remediation. Post-delivery actions can send emails to different locations: Quarantine (isolated for admin review), Deleted Items (soft delete), Junk Email folder, or back to Inbox (for false positive corrections). Understanding these patterns helps evaluate ZAP policy configurations and ensures malicious content is properly isolated from users.**\"},\"name\":\"text - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of emails that had a post delivery action, summarizing the data daily by the final location as a result of the action\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\nlet quarantine=EmailPostDeliveryEvents\\r\\n| where DeliveryLocation has 'Quarantine' and ActionType contains \\\"ZAP\\\"\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Quarantine\\\";\\r\\nlet delete=EmailPostDeliveryEvents\\r\\n| where DeliveryLocation has 'Delete' and ActionType contains \\\"ZAP\\\"\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Delete\\\";\\r\\nlet junk=EmailPostDeliveryEvents\\r\\n| where DeliveryLocation has 'Junk' and ActionType contains \\\"ZAP\\\"\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Junk\\\";\\r\\nlet inbox=EmailPostDeliveryEvents\\r\\n| where DeliveryLocation has 'Inbox' and ActionType contains \\\"ZAP\\\"\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Inbox\\\";\\r\\nunion quarantine,delete,junk,inbox\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"name\":\"query - 0\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"11\"},\"name\":\"group - 13\",\"styleSettings\":{\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"# Quarantine Insights\\r\\n\\r\\n---\\r\\n\\r\\nThis tab provides insights into emails that were quarantined by Microsoft Defender for Office 365 due to security policies or threat detections. This tab includes data on quarantined messages by threat type (phish, spam, malware), sender domains, and user interactions such as release requests. These insights help security teams monitor quarantined items, identify patterns in false positives, and ensure timely remediation to maintain productivity and security.\\r\\n\\r\\n[<p><b>Learn more</b></p>](https://learn.microsoft.com/en-us/defender-office-365/quarantine-about)\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"12\"},\"name\":\"Quarantine Tab Description\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Quarantine Management and Insights\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\nThis section provides comprehensive insights into quarantine operations, including release patterns, detection methods, and threat categorization. It helps security teams understand what types of threats are being quarantined and monitor quarantine release activity to identify potential false positives or security policy effectiveness.\"},\"name\":\"text - 0\"},{\"type\":1,\"content\":{\"json\":\"### Quarantine Release Trend<br>\\r\\n\\r\\n**This visual displays the daily trend of emails released from quarantine by administrators. Monitoring this metric helps identify patterns in quarantine management and potential areas where policy adjustments may be needed to reduce unnecessary quarantines.**\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the daily ammount of emails released from quarantine\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\nlet qrel = EmailPostDeliveryEvents\\r\\n| where ActionTrigger has \\\"AdminAction\\\" and Action has 'Quarantine release' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Quarantine release\\\";\\r\\nqrel\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"100\",\"name\":\"query - 0\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Quarantine Release Percentage<br>\\r\\n\\r\\n**Calculates the percentage of quarantined emails that were successfully released compared to the total quarantined messages. This metric helps measure engagement with quarantine and assess the effectiveness of quarantine policies.**\"},\"customWidth\":\"66\",\"name\":\"text - 2 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Quarantine Release Analysis by Detection Type<br>\\r\\n\\r\\n**This visual shows the distribution of quarantine release attempts categorized by the original detection method (Malware, Phish, or Spam). Understanding which detection types result in the most release attempts can help identify potential false positives and areas where detection rules may need tuning.**\"},\"customWidth\":\"33\",\"name\":\"text - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the percentage of emails released from quarantine out of the total ammount of quarantined emails\\r\\nlet Quarantine_Releases = toscalar(EmailPostDeliveryEvents\\r\\n| where Action == \\\"Quarantine release\\\"\\r\\n| join kind=leftouter (EmailEvents | where DeliveryLocation == \\\"Quarantine\\\") on NetworkMessageId\\r\\n| summarize count());\\r\\nlet Quarantined_Mailfow = toscalar(EmailEvents | where DeliveryLocation == \\\"Quarantine\\\"\\r\\n| summarize count());\\r\\nprint\\r\\nQuarantine_Releases = toreal(Quarantine_Releases),\\r\\nQuarantined_Mailflow = toreal(Quarantined_Mailfow),\\r\\nRelease_Percentage = abs(round(((toreal(Quarantine_Releases)/toreal(Quarantined_Mailfow))*100),2))\",\"size\":0,\"showAnalytics\":true,\"title\":\" \",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"stat\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Release_Percentage\",\"formatter\":12,\"formatOptions\":{\"palette\":\"none\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},\"showBorder\":true,\"sortCriteriaField\":\"Release_Percentage\",\"size\":\"auto\"},\"statSettings\":{\"valueField\":\"Release_Percentage\",\"valueAggregation\":\"None\",\"colorSettings\":{\"type\":\"thresholds\",\"mode\":\"foreground\",\"heatmapPalette\":\"greenRed\",\"thresholdsGrid\":[{\"operator\":\"<\",\"thresholdValue\":\"5\",\"representation\":\"green\"},{\"operator\":\">\",\"thresholdValue\":\"5\",\"representation\":\"redDark\"}]},\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}},\"tagText\":\"Quarantine Release Percentage\",\"valueFontStyle\":\"mega\",\"tagTextPosition\":\"bottom\"}},\"customWidth\":\"66\",\"name\":\"query - 1\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises emails released from quarantine and summarizing the result by the original filter verdict - detection method\\r\\nlet totalQuery = \\r\\n    EmailPostDeliveryEvents \\r\\n    | where Action == \\\"Quarantine release\\\" \\r\\n    | join kind=inner (EmailEvents | where DeliveryLocation == \\\"Quarantine\\\") on NetworkMessageId \\r\\n    | extend MDO_detection = parse_json(DetectionMethods1) \\r\\n    | extend FirstDetection = iif(isempty(MDO_detection), \\\"Clean\\\", tostring(bag_keys(MDO_detection)[0])) \\r\\n    | extend FirstSubcategory = iif(FirstDetection != \\\"Clean\\\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \\\": \\\", tostring(MDO_detection[FirstDetection][0])), \\\"No Detection (clean)\\\") \\r\\n    | where FirstSubcategory contains \\\"Malware\\\" or FirstSubcategory contains \\\"Phish\\\" or FirstSubcategory contains \\\"Spam\\\"\\r\\n    | count;\\r\\nEmailPostDeliveryEvents \\r\\n| where Action == \\\"Quarantine release\\\" \\r\\n| join kind=inner (EmailEvents | where DeliveryLocation == \\\"Quarantine\\\") on NetworkMessageId \\r\\n| extend MDO_detection = parse_json(DetectionMethods1) \\r\\n| extend FirstDetection = iif(isempty(MDO_detection), \\\"Clean\\\", tostring(bag_keys(MDO_detection)[0])) \\r\\n| extend FirstSubcategory = iif(FirstDetection != \\\"Clean\\\" and array_length(MDO_detection[FirstDetection]) > 0, strcat(FirstDetection, \\\": \\\", tostring(MDO_detection[FirstDetection][0])), \\\"No Detection (clean)\\\") \\r\\n| where FirstSubcategory contains \\\"Malware\\\" or FirstSubcategory contains \\\"Phish\\\" or FirstSubcategory contains \\\"Spam\\\" \\r\\n| summarize count_messages = count(NetworkMessageId) by FirstSubcategory\\r\\n| extend percentage = round((count_messages * 100.0 / toscalar(totalQuery)), 2)\\r\\n| project FirstSubcategory, count_messages, percentage\\r\\n| order by percentage desc\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"yAxis\":[\"percentage\"],\"createOtherGroup\":20,\"ySettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}}},\"customWidth\":\"33\",\"name\":\"query - 6\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Phishing Email Quarantine Analysis<br>\\r\\n\\r\\n**These visuals break down quarantined phishing emails by their specific detection methods. Microsoft Defender for Office 365 employs multiple phishing detection techniques including impersonation protection, URL detonation, spoof detection, and advanced filters. Understanding which detection methods are most frequently triggered helps optimize anti-phishing policies and identify emerging phishing tactics.<br>The line chart shows daily trends across all phishing detection methods, while the pie chart provides an overall distribution of detection reasons.**\"},\"name\":\"text - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of phish emails that are quarantined, summarized daily by the detection method\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\nlet baseQuery = EmailEvents\\r\\n| where DetectionMethods has \\\"Phish\\\" and DeliveryLocation == \\\"Quarantine\\\";\\r\\nlet ml=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Advanced filter'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Advanced filter\\\";\\r\\nlet camp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Campaign'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Campaign\\\";\\r\\nlet fd=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'File detonation' and Phish !has 'File detonation reputation'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"File detonation\\\";\\r\\nlet fdr=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'File detonation reputation'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"File detonation reputation\\\";\\r\\nlet frp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Fingerprint matching' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Fingerprint matching\\\";\\r\\nlet gf=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'General filter' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"General filter\\\";\\r\\nlet bimp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Impersonation brand' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Impersonation brand\\\";\\r\\nlet dimp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Impersonation domain' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Impersonation domain\\\";\\r\\nlet uimp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Impersonation user' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Impersonation user\\\";\\r\\nlet mimp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Mailbox intelligence impersonation' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Mailbox intelligence impersonation\\\";\\r\\nlet sdmarc=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Spoof DMARC' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Spoof DMARC\\\";\\r\\nlet spoofe=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Spoof external domain' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Spoof external domain\\\";\\r\\nlet spoofi=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'Spoof intra-org' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Spoof intra-org\\\";\\r\\nlet ud=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'URL detonation' and Phish !has 'URL detonation reputation'\\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"URL detonation\\\";\\r\\nlet udr=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'URL detonation reputation' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"URL detonation reputation\\\";\\r\\nlet umr=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Phish has 'URL malicious reputation' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"URL malicious reputation\\\";\\r\\nunion ml,camp,fd,fdr,frp,gf,bimp,dimp,uimp,mimp,sdmarc,spoofe,spoofi,ud,udr,umr\\r\\n| project Count, Details, Timestamp\\r\\n\\r\\n\\r\\n\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"66\",\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of phish emails that are quarantined, summarized by the detection method\\r\\nEmailEvents\\r\\n| where EmailDirection == \\\"Inbound\\\" and DetectionMethods has 'Phish' and DeliveryLocation == \\\"Quarantine\\\"\\r\\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Phish=tostring(column_ifexists('Phish', ''))\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":20}},\"customWidth\":\"33\",\"name\":\"query - 2\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Spam Email Quarantine Analysis<br>\\r\\n\\r\\n**These visuals provide detailed insights into quarantined spam emails categorized by detection methods. Spam detection technologies include advanced filters, general filters, bulk email filtering, reputation-based systems (IP, domain, URL), and mixed analysis detection. Analyzing spam quarantine patterns helps fine-tune spam filtering policies to balance security with user productivity and reduce false positives.<br>The line chart displays daily trends for each spam detection method, while the pie chart shows the overall distribution.**\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the ammount of spam emails that are quarantined, summarized daily by the detection method\\r\\nlet baseQuery = EmailEvents\\r\\n| where DetectionMethods has \\\"Spam\\\" and DeliveryLocation == \\\"Quarantine\\\";\\r\\nlet timerange = \\r\\nbaseQuery\\r\\n| summarize minTime = min(Timestamp), maxTime = max(Timestamp);\\r\\nlet ml=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'Advanced filter'\\r\\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \\r\\n| extend Details = \\\"Advanced filter\\\";\\r\\nlet gf=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'General filter'\\r\\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \\r\\n| extend Details = \\\"General filter\\\";\\r\\nlet bl=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'BulkFilter'\\r\\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \\r\\n| extend Details = \\\"BulkFilter\\\";\\r\\nlet mx=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'Mixed analysis detection'\\r\\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \\r\\n| extend Details = \\\"Mixed analysis detection\\\";\\r\\nlet frp=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'Fingerprint matching'\\r\\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \\r\\n| extend Details = \\\"Fingerprint matching\\\";\\r\\nlet umr=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'URL malicious reputation' \\r\\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \\r\\n| extend Details = \\\"URL malicious reputation\\\";\\r\\nlet dr=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'Domain reputation' \\r\\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \\r\\n| extend Details = \\\"Domain reputation\\\";\\r\\nlet ipr=baseQuery\\r\\n| project Timestamp,RecipientEmailAddress,NetworkMessageId, DT=parse_json(DetectionMethods) | evaluate bag_unpack(DT) \\r\\n| where Spam has 'IP reputation' \\r\\n| make-series Count= count() default = 0 on Timestamp from toscalar((timerange | project minTime)) to toscalar((timerange | project maxTime)) step 1d \\r\\n| extend Details = \\\"IP reputation\\\";\\r\\nunion ml,gf,bl,mx,frp,umr,dr,ipr\\r\\n| project Count, Details, Timestamp\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"66\",\"name\":\"query - 4\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the total ammount of spam emails that are quarantined, summarized by the detection method\\r\\nEmailEvents\\r\\n| where EmailDirection == \\\"Inbound\\\" and DetectionMethods has 'Spam' and DeliveryLocation == \\\"Quarantine\\\"\\r\\n| project DT=parse_json(DetectionMethods)| evaluate bag_unpack(DT)| summarize count() by Spam=tostring(column_ifexists('Spam', ''))\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"createOtherGroup\":20}},\"customWidth\":\"33\",\"name\":\"query - 2 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"12\"},\"name\":\"group - 19\"},{\"type\":1,\"content\":{\"json\":\"# Security Operations Center (SOC) Insights \\r\\n\\r\\n---\\r\\n\\r\\nThis tab provides a view for security operations. Combines incident response metrics with investigation insights to evaluate the effectiveness of both automated systems and manual interventions.\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"13\"},\"name\":\"text - 13 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Security Incident Response Metrics\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\n**Operational efficiency insights.** Tracks incident volume, resolution speed, automation efficacy, and classification accuracy to evaluate SOC performance.\"},\"name\":\"text - 8\"},{\"type\":1,\"content\":{\"json\":\"### Email Security Incidents<br>\\r\\n\\r\\n**These visuals display the daily trend of email-related security incidents, as well as the proportion of email incidents compared to the total number of incidents in Defender.**\"},\"name\":\"text - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Filter for incidents that have at least one Email Security alert\\r\\nlet OfficeEmailAlerts = SecurityAlert\\r\\n    | where ProductName contains \\\"Office 365 Advanced Threat Protection\\\" or ProductName contains \\\"Microsoft 365 Defender\\\"\\r\\n    | project SystemAlertId;\\r\\nSecurityIncident\\r\\n| summarize arg_max(TimeGenerated, *) by IncidentNumber\\r\\n| mv-expand AlertIds\\r\\n| where isnotempty(AlertIds) and not(Title startswith \\\"CC_\\\")\\r\\n| extend AlertId = tostring(AlertIds) \\r\\n| join kind=inner\\r\\n    (OfficeEmailAlerts | extend SystemAlertId = tostring(SystemAlertId))\\r\\n    on $left.AlertId == $right.SystemAlertId\\r\\n| summarize arg_max(TimeGenerated, *), AlertCount = dcount(AlertId) by IncidentNumber\\r\\n| make-series Incidents_Number = count() default = 0 on TimeGenerated step 1d\",\"size\":0,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"75\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Categorize incidents: Email Security vs Other\\r\\nlet AllAlerts = SecurityAlert\\r\\n    | extend SystemAlertId = tostring(SystemAlertId)\\r\\n    | project SystemAlertId, ProductName;\\r\\nSecurityIncident\\r\\n| summarize arg_max(TimeGenerated, *) by IncidentNumber\\r\\n| mv-expand AlertIds\\r\\n| where isnotempty(AlertIds) and not(Title startswith \\\"CC_\\\")\\r\\n| extend AlertId = tostring(AlertIds)\\r\\n| join kind=inner\\r\\n    (AllAlerts)\\r\\n    on $left.AlertId == $right.SystemAlertId\\r\\n| summarize AlertSystems = make_set(ProductName) by IncidentNumber\\r\\n| extend HasEmailSecurity = \\r\\n    AlertSystems has \\\"Office 365 Advanced Threat Protection\\\" or \\r\\n    AlertSystems has \\\"Microsoft 365 Defender\\\"\\r\\n| extend Category = iff(HasEmailSecurity, \\\"Email Security\\\", \\\"Other\\\")\\r\\n| summarize IncidentCount = count() by Category\\r\\n\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"25\",\"name\":\"query - 7\"},{\"type\":1,\"content\":{\"json\":\"### Average Incident Time To Close<br>\\r\\n\\r\\n**This visual displays the average time taken to close email-related security incidents, showing daily trends and providing insight into how resolution speed changes over time.**\"},\"name\":\"text - 6 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// SLA thresholds by severity for email-security (MDO) incidents\\r\\nlet SLA_Variables = datatable (Severity:string, TimeToResolve:int) [\\r\\n    \\\"High\\\", 60,\\r\\n    \\\"Medium\\\", 120,\\r\\n    \\\"Low\\\", 240,\\r\\n    \\\"Informational\\\", 480\\r\\n];\\r\\n\\r\\n// Identify MDO-related incidents via alert correlation\\r\\nlet EmailSecurityIncidents = \\r\\n    SecurityIncident\\r\\n    | mv-expand AlertIds\\r\\n    | where isnotempty(AlertIds)\\r\\n    | extend AlertId = tostring(AlertIds)\\r\\n    | join kind=inner (\\r\\n        SecurityAlert\\r\\n        | where ProductName in (\\\"Office 365 Advanced Threat Protection\\\", \\\"Microsoft 365 Defender\\\")\\r\\n        | extend AlertId = tostring(SystemAlertId)\\r\\n        | project AlertId\\r\\n    ) on AlertId\\r\\n    | distinct ProviderIncidentId;\\r\\n\\r\\n// Get latest incident state for each MDO-related incident\\r\\nlet LatestMdoIncidents =\\r\\n    SecurityIncident\\r\\n    | summarize arg_max(TimeGenerated, Classification, Status, Severity, CreatedTime, ClosedTime, Title) by ProviderIncidentId\\r\\n    | where ProviderIncidentId in (EmailSecurityIncidents)\\r\\n    | where not(Title startswith \\\"CC_\\\");  // Exclude non-email incidents as needed\\r\\n\\r\\nLatestMdoIncidents\\r\\n| where Status == \\\"Closed\\\"\\r\\n| extend TimeToResolveIncident = datetime_diff('minute', ClosedTime, CreatedTime)\\r\\n| join kind=inner SLA_Variables on Severity\\r\\n| summarize\\r\\n    AvgTimeToCloseMinutes = avg(TimeToResolveIncident),\\r\\n    CountIncidents = count()\\r\\n    by Day = bin(ClosedTime, 1d), Severity\\r\\n| order by Day asc, Severity asc\",\"size\":0,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"xAxis\":\"Day\",\"yAxis\":[\"AvgTimeToCloseMinutes\"],\"group\":\"Severity\"}},\"name\":\"query - 8\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"### Closed Incident Classification (True Positive vs False Positive)\\r\\n\\r\\nThis visual shows the distribution of closed email-related incidents classified as True Positive versus False Positive. It helps assess detection accuracy and provides insight into validation trends.\"},\"customWidth\":\"33.3\",\"name\":\"text - 6 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### True Positive Incident Classification Rate\\r\\n\\r\\nThis visual displays the percentage of email-related incidents confirmed as True Positive. It offers a clear measure of classification accuracy and highlights changes in detection effectiveness over time.\"},\"customWidth\":\"33.3\",\"name\":\"text - 6 - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Incidents Automated vs Manual Closure\\r\\n\\r\\nThis visual illustrates the proportion of email-related incidents closed automatically versus manually. It provides visibility into operational efficiency and the impact of automation on incident resolution.\\r\\n<br>  *You will have to review the underlying query and add any automation system specific to your organization.*\"},\"customWidth\":\"33.3\",\"name\":\"text - 6 - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Build a list of MDO-related incidents by cross-referencing SecurityAlert\\r\\nlet EmailSecurityIncidents = SecurityIncident\\r\\n    | mv-expand AlertIds\\r\\n    | where isnotempty(AlertIds)\\r\\n    | extend AlertId = tostring(AlertIds)\\r\\n    | join kind=inner (\\r\\n        SecurityAlert\\r\\n        | where ProductName in (\\\"Office 365 Advanced Threat Protection\\\", \\\"Microsoft 365 Defender\\\")\\r\\n        | extend AlertId = tostring(SystemAlertId)\\r\\n        | project AlertId\\r\\n    ) on AlertId\\r\\n    | distinct ProviderIncidentId;\\r\\n\\r\\n// Get only the most recent state of each incident, ensuring it's MDO-related\\r\\nlet LatestIncidents = SecurityIncident\\r\\n    | summarize arg_max(TimeGenerated, Classification, Status, Title) by ProviderIncidentId\\r\\n    | where ProviderIncidentId in (EmailSecurityIncidents)\\r\\n    | where not(Title startswith \\\"CC_\\\");  // Exclude incidents unrelated to MDO (e.g., DSPM)\\r\\n\\r\\nLatestIncidents\\r\\n| where Status == 'Closed'                                     // (Optional) Limit to closed/fully classified incidents\\r\\n| summarize Count = count() by Classification = iif(\\r\\n    isnull(Classification) or trim(\\\" \\\", Classification) == \\\"\\\",\\r\\n    \\\"Not Set\\\", \\r\\n    Classification\\r\\n  )\\r\\n| order by Count desc\",\"size\":3,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"33.3\",\"name\":\"query - 4\",\"styleSettings\":{\"margin\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Identify MDO-related SecurityIncident IDs via alert correlation\\r\\nlet EmailSecurityIncidents = \\r\\n    SecurityIncident\\r\\n    | mv-expand AlertIds\\r\\n    | where isnotempty(AlertIds)\\r\\n    | extend AlertId = tostring(AlertIds)\\r\\n    | join kind=inner (\\r\\n        SecurityAlert\\r\\n        | where ProductName in (\\\"Office 365 Advanced Threat Protection\\\", \\\"Microsoft 365 Defender\\\")\\r\\n        | extend AlertId = tostring(SystemAlertId)\\r\\n        | project AlertId\\r\\n    ) on AlertId\\r\\n    | distinct ProviderIncidentId;\\r\\n\\r\\n// Get latest incident state for MDO-related incidents\\r\\nlet LatestMdoIncidents =\\r\\n    SecurityIncident\\r\\n    | summarize arg_max(TimeGenerated, Classification, Status, IncidentName) by ProviderIncidentId\\r\\n    | where ProviderIncidentId in (EmailSecurityIncidents)\\r\\n    // Exclude other non-email incidents (e.g., DSPM with specific naming pattern)\\r\\n    | where not(IncidentName startswith \\\"CC_\\\");\\r\\n\\r\\n// Compute true positive rate among closed MDO incidents\\r\\nLatestMdoIncidents\\r\\n| where Status == \\\"Closed\\\"\\r\\n| summarize\\r\\n    TruePositiveCount = countif(Classification == \\\"TruePositive\\\"),\\r\\n    TotalClosed       = count()\\r\\n| extend TruePositiveRate = iff(\\r\\n    TotalClosed > 0,\\r\\n    TruePositiveCount * 100.0 / TotalClosed,\\r\\n    real(null)\\r\\n)\",\"size\":1,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"stat\",\"statSettings\":{\"valueField\":\"TruePositiveRate\",\"valueAggregation\":\"None\",\"colorSettings\":{\"type\":\"static\",\"mode\":\"background\",\"heatmapPalette\":\"greenRed\"},\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}},\"tagText\":\"True Positive Rate\",\"valueFontStyle\":\"xxLarge\",\"tagTextPosition\":\"bottom\"}},\"customWidth\":\"33.3\",\"name\":\"query - 5\",\"styleSettings\":{\"margin\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This queries shows the last activity on the Incident and attempts to display auto resolved incidents vs manual interaction.\\r\\n//Add strings for your automations if you rely on any other application/system\\r\\n//Fewer human-closed incidents (and a higher automated closure rate) generally indicates greater SecOps efficiency, as automation is successfully handling more work.\\r\\n\\r\\n// Identify MDO-related incidents by joining SecurityIncident and SecurityAlert\\r\\nlet EmailSecurityIncidents = SecurityIncident\\r\\n    | mv-expand AlertIds\\r\\n    | where isnotempty(AlertIds)\\r\\n    | extend AlertId = tostring(AlertIds)\\r\\n    | join kind=inner (\\r\\n        SecurityAlert\\r\\n        | where ProductName in (\\\"Office 365 Advanced Threat Protection\\\", \\\"Microsoft 365 Defender\\\")\\r\\n        | extend AlertId = tostring(SystemAlertId)\\r\\n        | project AlertId\\r\\n    ) on AlertId\\r\\n    | distinct ProviderIncidentId;\\r\\n\\r\\n// Get latest status of each incident and count closed incidents by who closed them\\r\\nSecurityIncident\\r\\n| summarize arg_max(TimeGenerated, *) by ProviderIncidentId\\r\\n| where ProviderIncidentId in (EmailSecurityIncidents)\\r\\n| where Status == 'Closed'\\r\\n| where not(Title startswith \\\"CC_\\\")          // Exclude non-MDO incidents from DSPM policies\\r\\n| extend ClosedBy = iff(                       // Add strings for your automation systems\\r\\n        tolower(ModifiedBy) has_any (\\\"system\\\",\\\"azure\\\",\\\"automation\\\",\\\"playbook\\\",\\\"microsoft xdr\\\",\\\"microsoft defender xdr\\\",\\\"created from alert\\\"),\\r\\n        \\\"Automated\\\",\\r\\n        \\\"Human\\\"\\r\\n    )\\r\\n| summarize ClosedCount = count() by ClosedBy\",\"size\":3,\"showAnalytics\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33.3\",\"name\":\"query - 1\",\"styleSettings\":{\"margin\":\"10px\"}}]},\"name\":\"Incident Insights Group\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"13\"},\"name\":\"group - 20\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<table style=\\\"width:100%; border-collapse:collapse; border:none;background-color:#003366;\\\">\\r\\n<tr>\\r\\n<td style=\\\"text-align:left; border:none; font-size:20px; font-weight:bold;color:white;width:1%\\\">Investigation & Response Actions\\r\\n</td>\\r\\n</tr>\\r\\n</table>\\r\\n\\r\\n**Remediation efficacy analysis.** Compares automated (AIR) and manual admin actions to evaluate response times and investigation outcomes.\\r\\n\"},\"name\":\"text - 1\"},{\"type\":1,\"content\":{\"json\":\"### Automated Investigation and Response (AIR) Actions Daily\\r\\n\\r\\nThis visual shows the daily trend of Automated Investigation and Response (AIR) actions, including the number of successful and failed attempts (because of prior remediation).\"},\"customWidth\":\"50\",\"name\":\"text - 4\",\"styleSettings\":{\"margin\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Daily Automated Investigation and Response (AIR) Response Time After Email Delivery\\r\\n\\r\\nThis visual displays the daily average, 80th percentile (p80), 90th percentile (p90) and 99th percentile (p99) time needed, measured in minutes, from email delivery to AIR action. It serves as a SOC metric to monitor responsiveness (security team members reviewing and manually approving AIR Pending Actions) and identify potential latency in automated incident handling. If the latency is high focus on reviewing why reviwing AIR Pending Actions takes longer time for admins and consider <a href='https://learn.microsoft.com/en-us/defender-office-365/air-auto-remediation#configure-automated-remediation'>auto-aproval of URL, Files and Email clusters. </a>\\r\\n\"},\"customWidth\":\"50\",\"name\":\"text - 4 - Copy\",\"styleSettings\":{\"margin\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query attempts to show AIR Efficiency Over Time by displaying the number of successes and failures over time\\r\\nEmailPostDeliveryEvents\\r\\n| where ActionType =~ \\\"Automated Remediation\\\"\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| summarize Count = count() by bin(Timestamp, 1d), ActionResult\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"AlertId\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Count\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"Timestamp\"}},\"customWidth\":\"50\",\"name\":\"query - 0 - Copy\",\"styleSettings\":{\"margin\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// SOC metric: Daily average/p75 delay (in minutes) from email delivery to AIR action\\r\\nlet deliveries = EmailEvents\\r\\n  | where DeliveryAction == \\\"Delivered\\\"// delivered emails\\r\\n  | extend MsgKey = strcat(NetworkMessageId, \\\"-\\\", RecipientEmailAddress)\\r\\n  | summarize FirstDelivery = min(Timestamp) by MsgKey, Threat = tostring(ThreatTypes);\\r\\nlet remediations = EmailPostDeliveryEvents\\r\\n  | where ActionType =~ \\\"Automated Remediation\\\"// automated remediation events\\r\\n  | extend MsgKey = strcat(NetworkMessageId, \\\"-\\\", RecipientEmailAddress)\\r\\n  | summarize FirstRemediation = min(Timestamp) by MsgKey;\\r\\ndeliveries\\r\\n| join kind=inner remediations on MsgKey\\r\\n| extend DelayMinutes = datetime_diff(\\\"minute\\\", FirstRemediation, FirstDelivery)\\r\\n| where DelayMinutes >= 0\\r\\n| summarize AvgLatencyMinutes = avg(DelayMinutes),\\r\\n            P80LatencyMinutes = percentile(DelayMinutes, 80),\\r\\n            P90LatencyMinutes = percentile(DelayMinutes, 90),\\r\\n            P99LatencyMinutes = percentile(DelayMinutes, 99),\\r\\n            CountEmails = count()\\r\\n   by bin(FirstRemediation, 1d) \",\"size\":0,\"aggregation\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"areachart\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"FirstRemediation\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"FirstRemediation\",\"sortOrder\":1}],\"chartSettings\":{\"xAxis\":\"FirstRemediation\",\"yAxis\":[\"P99LatencyMinutes\",\"P90LatencyMinutes\",\"P80LatencyMinutes\",\"AvgLatencyMinutes\"],\"showLegend\":true}},\"customWidth\":\"50\",\"name\":\"query - 9\",\"styleSettings\":{\"margin\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Investigation Actions Taken: Automated Investigation and Response (AIR) vs Manual (Human)\\r\\n\\r\\nThis visual shows whether actions taken after an Automated Investigation and Response (AIR) required manual approval by an administrator or were executed automatically. It provides insight into the level of automation versus human intervention in post-investigation remediation.\"},\"customWidth\":\"50\",\"name\":\"text - 4 - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\"}},{\"type\":1,\"content\":{\"json\":\"### Automated Investigation and Response (AIR) Investigation Results Trend\\r\\n\\r\\nThis visual displays the daily trend of AIR investigation outcomes, categorized as **Threat Detected** or **Clean**. It helps track the effectiveness of automated investigations over time and highlights patterns in threat detection.\"},\"customWidth\":\"50\",\"name\":\"text - 4 - Copy - Copy - Copy\",\"styleSettings\":{\"margin\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query shows if the action taken after an Automated Investigation required manual approval by and admin or was automatically taken\\r\\nEmailPostDeliveryEvents\\r\\n| extend Key = strcat(NetworkMessageId , '-', RecipientEmailAddress) \\r\\n| summarize arg_max(Timestamp, *) by Key\\r\\n| where ActionType == \\\"Automated Remediation\\\"\\r\\n| summarize count() by ActionTrigger\",\"size\":3,\"showAnalytics\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 1 - Copy\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// AIR investigation outcomes by day: ThreatDetected vs. Clean\\r\\n\\r\\n// Step 1: Deduplicate automated remediation events by message and recipient\\r\\nlet AutoRemediations = \\r\\n    EmailPostDeliveryEvents\\r\\n    | where ActionType == \\\"Automated Remediation\\\"\\r\\n    | summarize arg_max(Timestamp, ActionResult) by NetworkMessageId, RecipientEmailAddress\\r\\n    | project NetworkMessageId, RecipientEmailAddress, Timestamp;\\r\\n\\r\\n// Step 2: Derive threat verdicts using AlertEvidence\\r\\nlet EvidenceVerdicts =\\r\\n    AlertEvidence\\r\\n    | where EntityType in (\\\"MailMessage\\\", \\\"MailCluster\\\")\\r\\n    | extend extra = todynamic(AdditionalFields)\\r\\n    // If this is a mail cluster, use provided NetworkMessageIds array; otherwise wrap NetworkMessageId as a single-item array\\r\\n    | extend networkIds = iff(\\r\\n      isnull(extra.NetworkMessageIds) or array_length(extra.NetworkMessageIds) == 0,\\r\\n      pack_array(NetworkMessageId),          // create a single-element array using pack_array\\r\\n      extra.NetworkMessageIds                // use the array as-is if it exists\\r\\n    )\\r\\n    | mv-expand nmID = networkIds                // expand to individual message IDs\\r\\n    // Derive verdict from LastVerdict, ThreatAnalysisSummary, and ThreatIntelligence\\r\\n    | extend \\r\\n        lastVerdict = tolower(tostring(extra.LastVerdict)),\\r\\n        threatAIList = extra.ThreatAnalysisSummary,\\r\\n        threatInt   = extra.ThreatIntelligence\\r\\n    | extend verdictFromAnalysis = iff(array_length(threatAIList) > 0, tolower(tostring(threatAIList[0].Verdict)), \\\"\\\"),\\r\\n             verdictTI          = iff(array_length(threatInt) > 0, \\\"malicious\\\", \\\"\\\")   // any item in ThreatIntelligence indicates malicious\\r\\n    // Mark as threat-detected if verdict is malicious/suspicious or threat evidence is present\\r\\n    | extend ThreatDetectedFlag = \\r\\n        case(\\r\\n            lastVerdict in (\\\"malicious\\\",\\\"suspicious\\\") or verdictFromAnalysis in (\\\"malicious\\\",\\\"suspicious\\\")\\r\\n                or verdictTI == \\\"malicious\\\",\\r\\n            true,\\r\\n            false\\r\\n        )\\r\\n    // Weight mail clusters by MailCount; default to 1 for single messages\\r\\n    | extend MailCountInt = toint(extra.MailCount)\\r\\n    | extend Weight = iff(EntityType == \\\"MailCluster\\\", \\r\\n                        coalesce(MailCountInt, 1), // default to 1 if MailCount is missing\\r\\n                        1)\\r\\n    | summarize IsThreatDetected = any(ThreatDetectedFlag), \\r\\n                WeightSum       = sum(Weight) \\r\\n    by nmID = tostring(nmID);\\r\\n\\r\\n// Step 3: Join remediation events with verdicts and aggregate by day\\r\\nAutoRemediations\\r\\n| join kind=leftouter EvidenceVerdicts on $left.NetworkMessageId == $right.nmID\\r\\n| extend isThreat      = coalesce(IsThreatDetected, false), \\r\\n         effectiveWeight= coalesce(WeightSum, 1)\\r\\n| extend InvestigationOutcome = iif(isThreat, \\\"ThreatDetected\\\", \\\"Clean\\\")\\r\\n| summarize PreventionCount = sum(effectiveWeight) by Day = bin(Timestamp, 1d), InvestigationOutcome\\r\\n| order by Day asc, InvestigationOutcome asc\",\"size\":0,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"customWidth\":\"50\",\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"### Post-Delivery Actions by Admin\\r\\n\\r\\nThis visual displays the daily number of emails where an administrator performed a post-delivery action. Actions are summarized by type, including **Soft Delete**, **Hard Delete**, **Moved to Junk Folder**, **Moved to Inbox**, and **Quarantine Release**, providing insight into manual intervention trends after email delivery.\"},\"name\":\"text - 8\",\"styleSettings\":{\"margin\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query visualises the daily ammount of emails that had an admin post delivery action, summarizing the data by action type\\r\\nlet minTime = toscalar(EmailEvents | summarize min(Timestamp));\\r\\nlet maxTime = toscalar(EmailEvents | summarize max(Timestamp));\\r\\nlet baseQuery = EmailPostDeliveryEvents\\r\\n| where ActionTrigger has \\\"AdminAction\\\";\\r\\nlet sdelete=baseQuery\\r\\n| where Action has 'Soft Delete' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Soft Delete\\\";\\r\\nlet hdelete=baseQuery\\r\\n| where Action has 'Hard Delete' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Hard Delete\\\";\\r\\nlet mtojunk=baseQuery\\r\\n| where Action has 'Moved to junk folder' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Moved to junk folder\\\";\\r\\nlet mtoinbox=baseQuery\\r\\n| where Action has 'Moved to inbox' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Moved to inbox\\\";\\r\\nlet qrel=baseQuery\\r\\n| where Action has 'Quarantine release' \\r\\n| make-series Count= count() default = 0 on Timestamp from minTime to maxTime step 1d \\r\\n| extend Details = \\\"Quarantine release\\\";\\r\\nunion sdelete,hdelete,mtojunk,mtoinbox,qrel\\r\\n| project Count, Details, Timestamp\\r\\n\",\"size\":0,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\"},\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10px\"}}]},\"customWidth\":\"50\",\"name\":\"group - 15\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"13\"},\"name\":\"AIRGroup\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\",\"showBorder\":true}}],\"fromTemplateId\":\"sentinel-MicrosoftDefenderForOffice365detectionsandinsights\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=MicrosoftDefenderForOffice365detectionsandinsights; logoFileName=Azure_Sentinel.svg; description=Gain extensive insight into your organization's Microsoft Defender for Office 365 Detections by analyzing and correlating events. \nYou can track various detections and insights over time including: metrics for phish, spam, malware, URL and URL click detection details, post delivery detections, user and admin submissions, system overrides and actions taken by security administrators.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Microsoft Defender for Office 365 Detection and Insights; templateRelativePath=MicrosoftDefenderForOffice365detectionsandinsights.json; subtitle=; provider=Microsoft}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "EmailEvents",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "EmailPostDeliveryEvents",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "EmailUrlInfo",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "UrlClickEvents",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "CloudAppEvents",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "MicrosoftThreatProtection",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MicrosoftDefenderForEndPoint Workbook with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId2')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "A wokbook to provide details about Microsoft Defender for Endpoint Advance Hunting to Overview & Analyse data brought through M365 Defender Connector."
              },
              "properties": {
                "displayName": "[parameters('workbook2-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Microsoft Defender for Endpoint (Preview)\\n---\\n\\nA workbook to provide details about Microsoft Defender for Endpoint Advance Hunting to Overview & Analyse data brought through Microsoft Defender XDR Connector.\\n\\n\\n\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"b22a3bd7-19b3-495d-a0df-95a7a59d98ff\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"value\":{\"durationMs\":172800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"f0450560-ef16-4aa9-a3ad-7485dd909587\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Help\",\"type\":10,\"isRequired\":true,\"jsonData\":\"[{ \\\"value\\\": \\\"Yes\\\", \\\"label\\\": \\\"Yes\\\"},\\r\\n {\\\"value\\\": \\\"No\\\", \\\"label\\\": \\\"No\\\", \\\"selected\\\":true }]\",\"label\":\"Show Help\",\"value\":\"Yes\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":1,\"content\":{\"json\":\"\\r\\n|Overview|Device|Network|File|\\r\\n|--------|------|-------|----|\\r\\n|MDE Tables Last Data Received|Source of the AV detections|Internet Connected Devices|FileActivityCount per Device|\\r\\n|Daily Data Flow on MDE Tables|Get stats on ASR audit events|Count By Machine Group|Count by InitiatingProcessAccountUpn|\\r\\n|Device Heartbeat|Get stats on ASR blocks|Count By Network Adaptor||\\r\\n|Device where files are copied to USB Drive|AV Detections with USB Disk Drive|TimeSeries on Network Activity||\\r\\n|Device Internet Connectivity Status |List files copied to USB mounted drives|Top 10 RemoteUrl accessed over TimeRange||\\r\\n|Device Count by DNS Suffix ||Tor Clients||\\r\\n|Device Microsoft Entra ID Join status ||||\\r\\n|Device ClientVersion ||||\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 8\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"454d4e02-26ba-4195-ae30-94752bbf4603\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"preText\":\"Overview\",\"style\":\"link\"},{\"id\":\"3d902e84-3e5b-4631-85d1-c229ec2abf75\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Device\",\"subTarget\":\"Device\",\"style\":\"link\"},{\"id\":\"bbc20288-b398-4f63-b7a9-e3830213bb34\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Network\",\"subTarget\":\"Network\",\"style\":\"link\"},{\"id\":\"edab4a44-8ca3-4ba1-bede-4186f4376d28\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"File\",\"subTarget\":\"File\",\"style\":\"link\"}]},\"name\":\"links - 3\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union \\r\\nisfuzzy = true\\r\\n(DeviceInfo | summarize arg_max(TimeGenerated,*) | project TimeGenerated, Type= \\\"DeviceInfo\\\" | extend Description = \\\"Machine information (including OS information)\\\"),\\r\\n(DeviceNetworkInfo | summarize arg_max(TimeGenerated,*) | project TimeGenerated, Type=\\\"DeviceNetworkInfo\\\"  | extend Description = \\\"Network properties of machines\\\"),\\r\\n(DeviceProcessEvents | summarize arg_max(TimeGenerated,*) | project TimeGenerated, Type=\\\"DeviceProcessEvents\\\" | extend Description = \\\"Process creation and related events\\\"),\\r\\n(DeviceNetworkEvents | summarize arg_max(TimeGenerated,*) | project TimeGenerated, Type=\\\"DeviceNetworkEvents\\\" | extend Description = \\\"Network connection and related events\\\"),\\r\\n(DeviceFileEvents | summarize arg_max(TimeGenerated,*) | project TimeGenerated, Type=\\\"DeviceFileEvents\\\" | extend Description = \\\"File creation, modification, and other file system events\\\"),\\r\\n(DeviceRegistryEvents | summarize arg_max(TimeGenerated,*) | project TimeGenerated, Type=\\\"DeviceRegistryEvents\\\" | extend Description = \\\"Creation and modification of registry entries\\\"),\\r\\n(DeviceLogonEvents | summarize arg_max(TimeGenerated,*) | project TimeGenerated, Type=\\\"DeviceLogonEvents\\\" | extend Description = \\\"Sign-ins and other authentication events\\\"),\\r\\n(DeviceImageLoadEvents | summarize arg_max(TimeGenerated,*) | project TimeGenerated, Type=\\\"DeviceImageLoadEvents\\\" | extend Description = \\\"DLL loading events\\\"),\\r\\n(DeviceEvents | summarize arg_max(TimeGenerated,*) | project TimeGenerated, Type=\\\"DeviceEvents\\\" | extend Description = \\\"Additional events types\\\"),\\r\\n(DeviceFileCertificateInfo | summarize arg_max(TimeGenerated,*) | project TimeGenerated, Type=\\\"DeviceFileCertificateInfo\\\" | extend Description = \\\"Certificate information of signed files)\\\")\\r\\n| extend [\\\"Last Log Received At (Local Time)\\\"] = TimeGenerated\\r\\n| project Type, Description, [\\\"Last Log Received At (Local Time)\\\"]\",\"size\":0,\"title\":\"MDE Tables Last Data Received based on {TimeRange}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Type\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Last Log Received At\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"fullDateTimePattern\"}}],\"filter\":true}},\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let AllDeviceNames = DeviceInfo | distinct DeviceId, DeviceName;\\nlet DeviceEventSummary = DeviceEvents | summarize count() by DeviceId, Type, bin(TimeGenerated,1d);\\nlet DeviceNetworkEventsSummary = DeviceNetworkEvents | summarize count() by DeviceId,Type, bin(TimeGenerated,1d);\\nlet DeviceNetworkInfoSummary = DeviceNetworkInfo | summarize count() by DeviceId,Type, bin(TimeGenerated,1d);\\nlet DeviceLogonEventsSummary = DeviceLogonEvents | summarize count() by DeviceId,Type, bin(TimeGenerated,1d);\\nlet DeviceRegistryEventsSummary = DeviceRegistryEvents | summarize count() by DeviceId,Type, bin(TimeGenerated,1d);\\nlet DeviceProcessEventsSummary = DeviceProcessEvents | summarize count() by DeviceId,Type, bin(TimeGenerated,1d);\\n(DeviceEventSummary\\n| union DeviceNetworkEventsSummary,\\nDeviceNetworkEventsSummary,\\nDeviceNetworkInfoSummary,\\nDeviceLogonEventsSummary,\\nDeviceRegistryEventsSummary,\\nDeviceProcessEventsSummary)\\n| join kind=inner ( \\nAllDeviceNames\\n)\\non $left.DeviceId == $right.DeviceId\\n| project-reorder Type, TimeGenerated, count_\\n//| project-away DeviceId, DeviceId1\",\"size\":1,\"title\":\"Daily Data Flow on MDE Tables over {TimeRange}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"chartSettings\":{\"xAxis\":\"count_\"}},\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceInfo \\r\\n| summarize arg_max(TimeGenerated,*) by DeviceId\\r\\n| extend ParsedFields=parse_json(LoggedOnUsers)[0]\\r\\n| extend DurationAtLeast= format_timespan(now()-TimeGenerated,'dd:hh:mm:ss')\\r\\n| project DurationAtLeast,TimeGenerated,DeviceName,DomainName=ParsedFields.DomainName,UserName=ParsedFields.UserName\\r\\n| order by DurationAtLeast asc\",\"size\":0,\"title\":\"Device Heartbeat from TimeTange {TimeRange}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"filter\":true}},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let UsbDriveMount = DeviceEvents\\r\\n| where ActionType==\\\"UsbDriveMounted\\\"\\r\\n| extend ParsedFields=parse_json(AdditionalFields)\\r\\n| project DeviceId, DeviceName, DriveLetter=ParsedFields.DriveLetter, MountTime=Timestamp,\\r\\nProductName=ParsedFields.ProductName,SerialNumber=ParsedFields.SerialNumber,Manufacturer=ParsedFields.Manufacturer\\r\\n| order by DeviceId asc, MountTime desc;\\r\\nlet FileCreation = DeviceFileEvents\\r\\n| where InitiatingProcessAccountName != \\\"system\\\"\\r\\n| where ActionType == \\\"FileCreated\\\"\\r\\n| where FolderPath !startswith \\\"C:\\\\\\\\\\\"\\r\\n| where FolderPath !startswith \\\"\\\\\\\\\\\"\\r\\n| project ReportId,DeviceId,InitiatingProcessAccountDomain,\\r\\nInitiatingProcessAccountName,InitiatingProcessAccountUpn,\\r\\nFileName, FolderPath, SHA256, Timestamp, SensitivityLabel, IsAzureInfoProtectionApplied\\r\\n| order by DeviceId asc, Timestamp desc;\\r\\nFileCreation | lookup kind=inner (UsbDriveMount) on DeviceId\\r\\n| where FolderPath startswith DriveLetter\\r\\n| where Timestamp >= MountTime\\r\\n| partition by ReportId ( top 1 by MountTime )\\r\\n| order by DeviceId asc, Timestamp desc\\r\\n| summarize FileCount = count() by DeviceName\\r\\n| order by FileCount desc\",\"size\":1,\"title\":\"Device where files are copied to USB Drive from TimeTange {TimeRange}\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"FileCount\",\"formatter\":8,\"formatOptions\":{\"palette\":\"red\"}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 0 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceNetworkInfo\\r\\n| summarize arg_max(TimeGenerated,*) by DeviceId\\r\\n| mvexpand ConnectedNetworks\\r\\n| summarize count() by tostring(ConnectedNetworks.IsConnectedToInternet)\",\"size\":1,\"title\":\"Device Internet Connectivity Status from TimeTange {TimeRange}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"FileCount\",\"formatter\":8,\"formatOptions\":{\"palette\":\"red\"}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 0 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceInfo\\r\\n| where isnotempty(OSPlatform)\\r\\n| summarize arg_max(Timestamp, DeviceName) by DeviceId\\r\\n| extend DeviceMachineName = split(DeviceName, '.')[0]\\r\\n| extend DeviceDomain = substring(DeviceName, strlen(DeviceMachineName) + 1, strlen(DeviceName) - strlen(DeviceMachineName) - 1)\\r\\n| summarize count() by DeviceDomain\",\"size\":1,\"title\":\"Device Count by DNS Suffix\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"filter\":true},\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"customWidth\":\"30\",\"name\":\"query - 0 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceInfo\\r\\n| where isnotempty(OSPlatform)\\r\\n| summarize arg_max(TimeGenerated, *) by DeviceId\\r\\n| summarize count() by tostring(IsAzureADJoined)\",\"size\":1,\"title\":\"Device EntraID Join status\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"filter\":true},\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"customWidth\":\"30\",\"name\":\"query - 0 - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceInfo\\r\\n| where isnotempty(OSPlatform)\\r\\n| summarize arg_max(TimeGenerated, *) by DeviceId\\r\\n| summarize count() by ClientVersion\",\"size\":1,\"title\":\"Device ClientVersion\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"filter\":true},\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"customWidth\":\"30\",\"name\":\"query - 0 - Copy - Copy - Copy - Copy\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"groupOverview\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query shows the source of the AV detections (e.g., the website the file was downloaded from etc.)\\r\\n//\\r\\n//Get the list of AV detections\\r\\nlet avDetections =\\r\\nDeviceEvents\\r\\n| where ActionType == \\\"AntivirusDetection\\\" and isnotempty(MD5)\\r\\n| extend ParsedFields=parse_json(AdditionalFields)\\r\\n| project Timestamp, DeviceName, ThreatName=tostring(ParsedFields.ThreatName), FileName, FolderPath, MD5;\\r\\n//Get a list of file creations\\r\\nlet fileCreations =\\r\\nDeviceFileEvents \\r\\n| where (isnotempty(FileOriginReferrerUrl) or isnotempty(FileOriginUrl)) and isnotempty(MD5)\\r\\n| project MD5, FileOriginUrl, FileOriginReferrerUrl, InitiatingProcessFileName, InitiatingProcessParentFileName;\\r\\n//Join the file creations and AV detections on the MD5 of the file\\r\\navDetections | join kind=inner (fileCreations) on MD5\\r\\n| project-away MD51 //Remove the duplicated MD5 field\\r\\n| sort by Timestamp desc \",\"size\":0,\"title\":\"Source of the AV detections for {TimeRange}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"filter\":true}},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceEvents\\r\\n| where ActionType startswith \\\"Asr\\\" and ActionType endswith \\\"Audited\\\"\\r\\n// Count total stats - count events and machines per rule\\r\\n| summarize EventCount=count(), MachinesCount=dcount(DeviceId) by ActionType\",\"size\":0,\"title\":\"Get stats on ASR audit events - count events and machines per rule for {TimeRange}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceEvents\\r\\n| where ActionType startswith \\\"Asr\\\" and ActionType endswith \\\"Blocked\\\"\\r\\n// Count total stats - count events and machines per rule\\r\\n| summarize EventCount=count(), MachinesCount=dcount(DeviceId) by ActionType\",\"size\":0,\"title\":\"Get stats on ASR blocks - count events and machines per rule for {TimeRange}\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//This query make a best-guess detection regarding which removable media device caused an AV detection\\r\\n//The query is best run over 30 days to get the full USB history\\r\\n//\\r\\n//Get a list of USB AV detections. This assumes any path not beginning with C is a removable/USB device\\r\\nlet usbDetections =\\r\\n    DeviceEvents\\r\\n    | where ActionType == \\\"AntivirusDetection\\\" and FolderPath !startswith \\\"c\\\" and FolderPath matches regex \\\"^[A-Za-z]{1}\\\"\\r\\n    | extend ParsedFields=parse_json(AdditionalFields)\\r\\n    | project DetectionTime=Timestamp, DeviceName, ThreatName=tostring(ParsedFields.ThreatName), FileName, FolderPath;\\r\\n//Get a list of USB disk drive connections, grouped by computer name and DeviceID\\r\\nlet usbConnections = \\r\\n    DeviceEvents\\r\\n    | where ActionType == \\\"PnpDeviceConnected\\\"\\r\\n    | extend parsed=parse_json(AdditionalFields)\\r\\n    | project Timestamp, DeviceName, DeviceId=tostring(parsed.DeviceId), ClassName=tostring(parsed.ClassName)\\r\\n    | where ClassName == \\\"DiskDrive\\\"\\r\\n    | summarize UsbFirstSeen=min(Timestamp), UsbLastSeen=max(Timestamp) by DeviceId, DeviceName;\\r\\n//Join USB AV detections and connections, where the detection occurs after the USB has been plugged in\\r\\nusbDetections | join kind=inner (usbConnections) on DeviceName | where DetectionTime > UsbFirstSeen and DetectionTime < UsbLastSeen\\r\\n| project DetectionTime, DeviceName, ThreatName, FileName, FolderPath, DeviceId, UsbFirstSeen, UsbLastSeen\\r\\n| sort by DetectionTime desc\",\"size\":0,\"title\":\"AV Detections with USB Disk Drive for {TimeRange}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let UsbDriveMount = DeviceEvents\\r\\n| where ActionType==\\\"UsbDriveMounted\\\"\\r\\n| extend ParsedFields=parse_json(AdditionalFields)\\r\\n| project DeviceId, DeviceName, DriveLetter=ParsedFields.DriveLetter, MountTime=Timestamp,\\r\\nProductName=ParsedFields.ProductName,SerialNumber=ParsedFields.SerialNumber,Manufacturer=ParsedFields.Manufacturer\\r\\n| order by DeviceId asc, MountTime desc;\\r\\nlet FileCreation = DeviceFileEvents\\r\\n| where InitiatingProcessAccountName != \\\"system\\\"\\r\\n| where ActionType == \\\"FileCreated\\\"\\r\\n| where FolderPath !startswith \\\"C:\\\\\\\\\\\"\\r\\n| where FolderPath !startswith \\\"\\\\\\\\\\\"\\r\\n| project ReportId,DeviceId,InitiatingProcessAccountDomain,\\r\\nInitiatingProcessAccountName,InitiatingProcessAccountUpn,\\r\\nFileName, FolderPath, SHA256, Timestamp, SensitivityLabel, IsAzureInfoProtectionApplied\\r\\n| order by DeviceId asc, Timestamp desc;\\r\\nFileCreation | lookup kind=inner (UsbDriveMount) on DeviceId\\r\\n| where FolderPath startswith DriveLetter\\r\\n| where Timestamp >= MountTime\\r\\n| partition by ReportId ( top 1 by MountTime )\\r\\n| order by DeviceId asc, Timestamp desc\",\"size\":0,\"title\":\"List files copied to USB mounted drives for {TimeRange}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 4\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Device\"},\"name\":\"groupDevice\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceNetworkInfo\\r\\n| summarize arg_max(TimeGenerated,*) by DeviceId\\r\\n| mv-apply ConnectedNetworks on \\r\\n(\\r\\nwhere ConnectedNetworks.IsConnectedToInternet == true\\r\\n)\\r\\n| project DeviceName, DefaultGateways, IPv4Dhcp, IPv6Dhcp,MacAddress,MachineGroup, ConnectedNetworks.IsConnectedToInternet\",\"size\":0,\"title\":\"Internet Connected Devices for {TimeRange}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceNetworkInfo\\r\\n| summarize arg_max(TimeGenerated,*) by DeviceId\\r\\n| summarize count() by MachineGroup\",\"size\":0,\"title\":\"Count By Machine Group for {TimeRange}\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"filter\":true}},\"name\":\"query - 0 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceNetworkInfo\\r\\n| summarize arg_max(TimeGenerated,*) by DeviceId\\r\\n| summarize count() by NetworkAdapterType, NetworkAdapterStatus\",\"size\":0,\"title\":\"Count By Network Adaptor\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"filter\":true}},\"name\":\"query - 0 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceNetworkEvents\\r\\n| summarize count() by DeviceName, DeviceId,bin( TimeGenerated,5m)\",\"size\":0,\"title\":\"TimeSeries on Network Activity for {TimeRange}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"name\":\"query - 0 - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceNetworkEvents\\r\\n| where isnotempty(RemoteUrl)\\r\\n| summarize count() by RemoteUrl\\r\\n| order by count_ desc\\r\\n| limit 10\",\"size\":0,\"title\":\"Top 10 RemoteUrl accessed over TimeRange {TimeRange}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"categoricalbar\"},\"name\":\"query - 0 - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// This query looks for Tor client, or for a common Tor plugin called Meek.\\r\\n// We query for active Tor connections, but could have alternatively looked for active Tor runs (ProcessCreateEvents) or Tor downloads (DeviceFileEvents)\\r\\n// To read more about this technique, see:\\r\\n// Tor: https://attack.mitre.org/wiki/Software/S0183#Techniques_Used\\r\\n// Meek plugin: https://attack.mitre.org/wiki/Software/S0175\\r\\n// Multi-hop proxy technique: https://attack.mitre.org/wiki/Technique/T1188\\r\\n// Tags: #Tor, #MultiHopProxy, #CnC\\r\\nDeviceNetworkEvents  \\r\\n| where Timestamp < ago(3d) and InitiatingProcessFileName in~ (\\\"tor.exe\\\", \\\"meek-client.exe\\\")\\r\\n// Returns MD5 hashes of files used by Tor, to enable you to block them.\\r\\n// We count how prevalent each file is (by machines) and show examples for some of them (up to 5 machine names per hash).\\r\\n| summarize MachineCount=dcount(DeviceName), MachineNames=makeset(DeviceName, 5) by InitiatingProcessMD5\\r\\n| order by MachineCount desc\",\"size\":0,\"title\":\"Tor Clients for {TimeRange}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 5\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Network\"},\"name\":\"groupNetwork\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceFileEvents\\r\\n| summarize FileActivityCount = count() by DeviceName\",\"size\":0,\"title\":\"FileActivityCount per Device for {TimeRange}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"unstackedbar\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceFileEvents\\r\\n| summarize count() by InitiatingProcessAccountUpn\",\"size\":0,\"title\":\"Count by InitiatingProcessAccountUpn for {TimeRange}\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"unstackedbar\"},\"name\":\"query - 0 - Copy\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"File\"},\"name\":\"groupFile\"}],\"fromTemplateId\":\"sentinel-MicrosoftDefenderForEndPoint\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId2'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=MicrosoftDefenderForEndPoint; logoFileName=Azure_Sentinel.svg; description=A wokbook to provide details about Microsoft Defender for Endpoint Advance Hunting to Overview & Analyse data brought through M365 Defender Connector.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Microsoft Defender For EndPoint; templateRelativePath=MicrosoftDefenderForEndPoint.json; subtitle=; provider=Microsoft Sentinel Community}.description",
                "parentId": "[variables('workbookId2')]",
                "contentId": "[variables('_workbookContentId2')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId2')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook2-name')]",
        "contentProductId": "[variables('_workbookcontentProductId2')]",
        "id": "[variables('_workbookcontentProductId2')]",
        "version": "[variables('workbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MicrosoftDefenderForIdentity Workbook with template version 3.0.13",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId3')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Use this workbook to analyse the advance hunting data ingested for Defender For Identity."
              },
              "properties": {
                "displayName": "[parameters('workbook3-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Microsoft Defender for Identity\\n---\\n\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"6e647d99-1a32-4bca-8147-403b5d37d773\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"value\":\"\",\"typeSettings\":{\"includeAll\":false,\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"timeContextFromParameter\":\"TimeRange\"},{\"id\":\"d57bcdf5-aec7-4f86-904c-67171864919b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"isRequired\":true,\"query\":\"resources\\r\\n| where type =~ \\\"microsoft.operationalinsights/workspaces\\\"\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.operationalinsights/workspaces\":true},\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"2e238f92-709c-410b-93e0-60eab6150a75\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":1800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"ec13514a-7e54-4d41-86db-2805727a2fa7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"About\",\"type\":10,\"description\":\"\",\"isRequired\":true,\"value\":\"Show\",\"typeSettings\":{\"showDefault\":false},\"jsonData\":\"[\\r\\n    \\\"Show\\\",\\r\\n    \\\"Hide\\\"\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 1\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"### Microsoft Defender for Identity Analysis Workbook\\r\\n\\r\\n\",\"style\":\"info\"},\"name\":\"text - 0\"}]},\"conditionalVisibility\":{\"parameterName\":\"About\",\"comparison\":\"isEqualTo\",\"value\":\"Show\"},\"name\":\"AboutGroup\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"48578fe1-da47-4a4c-b495-ce7fe24ce495\",\"cellValue\":\"Nav\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"grpOverview\",\"style\":\"link\"},{\"id\":\"30e93159-8bf5-4006-820f-406ea10bcd17\",\"cellValue\":\"Nav\",\"linkTarget\":\"parameter\",\"linkLabel\":\"LogOnEvents\",\"subTarget\":\"grpLogOnEvents\",\"style\":\"link\"},{\"id\":\"c40f76ed-94be-40ff-b65b-3fda306f2c3d\",\"cellValue\":\"Nav\",\"linkTarget\":\"parameter\",\"linkLabel\":\"QueryEvents\",\"subTarget\":\"grpQueryEvents\",\"style\":\"link\"},{\"id\":\"38c88a53-f7b1-42da-83d6-0c809835eaab\",\"cellValue\":\"Nav\",\"linkTarget\":\"parameter\",\"linkLabel\":\"DirectoryEvents\",\"subTarget\":\"grpDirectoryEvents\",\"style\":\"link\"},{\"id\":\"0ad83579-c492-4c20-8db6-27883db5abc8\",\"cellValue\":\"Nav\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Alerts\",\"subTarget\":\"grpAlerts\",\"style\":\"link\"}]},\"name\":\"links - 8\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityLogonEvents\\r\\n| summarize count() by LogonType\",\"size\":0,\"title\":\"Log On Summary\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"LogonType\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"40\",\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityLogonEvents\\r\\n|summarize count() by ActionType\",\"size\":0,\"title\":\"Log On Status\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityLogonEvents\\r\\n| summarize count() by Protocol\",\"size\":0,\"title\":\"Log On Protocol\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"barchart\"},\"customWidth\":\"30\",\"name\":\"query - 1 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityQueryEvents\\r\\n| summarize count() by Protocol\",\"size\":0,\"title\":\"Query Summary\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"barchart\"},\"customWidth\":\"30\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityQueryEvents\\r\\n| summarize count() by DestinationPort\",\"size\":0,\"title\":\"Query Destination Port\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"query - 3 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityQueryEvents\\r\\n| where isnotempty(QueryType)\\r\\n| summarize count() by QueryType\\r\\n| order by count_ desc\\r\\n| take 10\",\"size\":0,\"title\":\"Top 10 Query Types\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}}]}},\"customWidth\":\"30\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityDirectoryEvents\\r\\n| summarize count() by Protocol\",\"size\":0,\"title\":\"Directory Events Protocol\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"categoricalbar\"},\"customWidth\":\"40\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityDirectoryEvents\\r\\n| summarize count() by AccountDomain\",\"size\":0,\"title\":\"Directory Events Protocol\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"query - 6 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityDirectoryEvents\\r\\n| where isnotempty(AccountUpn)\\r\\n| summarize count() by AccountUpn\\r\\n| order by count_ desc \\r\\n| take 10\",\"size\":0,\"title\":\"Top 10 Accounts Activity\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}}],\"rowLimit\":10000,\"filter\":true}},\"customWidth\":\"30\",\"name\":\"query - 6 - Copy - Copy\"}]},\"conditionalVisibility\":{\"parameterName\":\"Nav\",\"comparison\":\"isEqualTo\",\"value\":\"grpOverview\"},\"name\":\"grpOverview\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityLogonEvents\\r\\n| where LogonType == \\\"Resource access\\\"\\r\\n| extend FROM_DEVICE_ = tostring(AdditionalFields.[\\\"FROM.DEVICE\\\"])\\r\\n| extend TO_DEVICE_ = tostring(AdditionalFields.[\\\"TO.DEVICE\\\"])\\r\\n| extend Count_ = toint(AdditionalFields.Count)\\r\\n| summarize sum(Count_) by FROM_DEVICE_, TO_DEVICE_\\r\\n| order by sum_Count_ desc\",\"size\":0,\"title\":\"Resource Access Summary in Devices\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"sum_Count_\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}}],\"rowLimit\":10000,\"filter\":true}},\"customWidth\":\"45\",\"name\":\"query - 0\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\",\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityLogonEvents\\r\\n| where LogonType == \\\"Resource access\\\"\\r\\n| extend TargetComputerOperatingSystem_ = tostring(AdditionalFields.TargetComputerOperatingSystem)\\r\\n| extend DestinationComputerOperatingSystem_ = tostring(AdditionalFields.DestinationComputerOperatingSystem)\\r\\n| extend Count_ = toint(AdditionalFields.Count)\\r\\n| summarize sum(Count_) by TargetComputerOperatingSystem_, DestinationComputerOperatingSystem_\\r\\n| order by sum_Count_ desc\",\"size\":0,\"title\":\"Resource Access Summary in OS\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"sum_Count_\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}}],\"rowLimit\":10000,\"filter\":true}},\"customWidth\":\"45\",\"name\":\"query - 0 - Copy\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\",\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityLogonEvents\\r\\n| where LogonType == \\\"Credentials validation\\\"\\r\\n| extend FROM_DEVICE = tostring(AdditionalFields.[\\\"FROM.DEVICE\\\"])\\r\\n| extend TO_DEVICE = tostring(AdditionalFields.[\\\"TO.DEVICE\\\"])\\r\\n| extend Count = toint(AdditionalFields.Count)\\r\\n| summarize sum(Count) by FROM_DEVICE, TO_DEVICE\\r\\n| order by sum_Count desc\",\"size\":0,\"title\":\"Credentials validation Summary in Devices\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"sum_Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}}],\"rowLimit\":10000,\"filter\":true}},\"customWidth\":\"45\",\"name\":\"query - 0 - Copy\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\",\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = IdentityLogonEvents\\r\\n| where LogonType == \\\"Credentials validation\\\"\\r\\n| extend TO_DEVICE = tostring(AdditionalFields.[\\\"TO.DEVICE\\\"])\\r\\n| extend Count = toint(AdditionalFields.Count);\\r\\ndata\\r\\n| summarize sum(Count) by  TO_DEVICE\\r\\n| order by sum_Count desc\\r\\n| join kind=inner\\r\\n(\\r\\ndata\\r\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by TO_DEVICE\\r\\n)\\r\\non $left.TO_DEVICE == $right.TO_DEVICE\",\"size\":0,\"title\":\"Credentials validation by Domain Controllers\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"sum_Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"TO_DEVICE1\",\"formatter\":5},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true}},\"customWidth\":\"45\",\"name\":\"query - 0 - Copy - Copy\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\",\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = IdentityLogonEvents;\\r\\ndata\\r\\n| extend Count = toint(AdditionalFields.Count)\\r\\n| summarize LogonSuccess = sumif(Count,ActionType == \\\"LogonSuccess\\\"),LogonFailed= sumif(Count,ActionType == \\\"LogonFailed\\\") by AccountUpn\\r\\n| join kind = inner\\r\\n(\\r\\ndata\\r\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by AccountUpn\\r\\n) on $left.AccountUpn == $right.AccountUpn\",\"size\":0,\"title\":\"Logon Summary by Users\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"LogonSuccess\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"LogonFailed\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redPurple\"}},{\"columnMatch\":\"AccountUpn1\",\"formatter\":5},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true}},\"name\":\"query - 0 - Copy - Copy\"}]},\"conditionalVisibility\":{\"parameterName\":\"Nav\",\"comparison\":\"isEqualTo\",\"value\":\"grpLogOnEvents\"},\"name\":\"AttachmentGroup\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = IdentityQueryEvents\\r\\n| extend TO_DEVICE = tostring(AdditionalFields.[\\\"TO.DEVICE\\\"]);\\r\\ndata\\r\\n| summarize count() by QueryType, TO_DEVICE\\r\\n| join kind =inner \\r\\n(\\r\\ndata\\r\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by QueryType, TO_DEVICE\\r\\n) on $left.QueryType == $right.QueryType and $left.TO_DEVICE== $right.TO_DEVICE\",\"size\":0,\"title\":\"Device Query Summary\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TO_DEVICE\",\"formatter\":5},{\"columnMatch\":\"count_\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"QueryType1\",\"formatter\":5},{\"columnMatch\":\"TO_DEVICE1\",\"formatter\":5},{\"columnMatch\":\"Trend\",\"formatter\":21,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"TO_DEVICE\"],\"expandTopLevel\":true}}},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = IdentityQueryEvents;\\r\\ndata\\r\\n| summarize count() by DeviceName\\r\\n| join kind =inner \\r\\n(\\r\\ndata\\r\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by DeviceName\\r\\n) on $left.DeviceName == $right.DeviceName\",\"size\":0,\"title\":\"Query Summary from Source Devices\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DeviceName1\",\"formatter\":5},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true}},\"name\":\"query - 0 - Copy\"}]},\"conditionalVisibility\":{\"parameterName\":\"Nav\",\"comparison\":\"isEqualTo\",\"value\":\"grpQueryEvents\"},\"name\":\"UrlGroup\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityDirectoryEvents\\r\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by ActionType \",\"size\":0,\"title\":\"Timeline on ActionType\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"timechart\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityDirectoryEvents\\r\\n| summarize count() by ActionType \\r\\n| order by count_ desc\",\"size\":0,\"title\":\"Top 10 Actions\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"categoricalbar\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5}]},\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"DestinationPort\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"name\":\"query - 0 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityDirectoryEvents\\r\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by AccountUpn\",\"size\":0,\"title\":\"Account Trend on Directory Events\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true},\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"DestinationPort\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"name\":\"query - 0 - Copy - Copy\"}]},\"conditionalVisibility\":{\"parameterName\":\"Nav\",\"comparison\":\"isEqualTo\",\"value\":\"grpDirectoryEvents\"},\"name\":\"group - 8\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = SecurityAlert\\r\\n| where ProductName == \\\"Azure Advanced Threat Protection\\\"\\r\\n| summarize arg_max(TimeGenerated,*) by SystemAlertId;\\r\\ndata\\r\\n| summarize count() by AlertName\\r\\n| join kind=inner \\r\\n(\\r\\ndata\\r\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by AlertName\\r\\n) on AlertName\",\"size\":0,\"noDataMessage\":\"Alerts\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":8,\"formatOptions\":{\"palette\":\"red\"}},{\"columnMatch\":\"AlertName1\",\"formatter\":5},{\"columnMatch\":\"Trend\",\"formatter\":21,\"formatOptions\":{\"palette\":\"red\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5}]}},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = SecurityAlert\\r\\n| where ProductName == \\\"Azure Advanced Threat Protection\\\"\\r\\n| summarize arg_max(TimeGenerated,*) by SystemAlertId\\r\\n| mv-expand todynamic(Entities)\\r\\n| where Entities[\\\"Type\\\"] == \\\"host\\\"\\r\\n| where isnotempty(Entities[\\\"HostName\\\"])\\r\\n| extend HostName = tostring(Entities[\\\"HostName\\\"]);\\r\\ndata\\r\\n| summarize count() by HostName\\r\\n| join kind=inner \\r\\n(\\r\\ndata\\r\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by HostName\\r\\n) on $left.HostName == $right.HostName\",\"size\":0,\"title\":\"Impacted Hosts\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":8,\"formatOptions\":{\"palette\":\"red\"}},{\"columnMatch\":\"HostName1\",\"formatter\":5},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"red\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5}]}},\"name\":\"query - 1\"}]},\"conditionalVisibility\":{\"parameterName\":\"Nav\",\"comparison\":\"isEqualTo\",\"value\":\"grpAlerts\"},\"name\":\"group - 8\"}],\"fromTemplateId\":\"sentinel-MicrosoftDefenderForIdentity\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId3'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=MicrosoftDefenderForIdentity; logoFileName=Azure_Sentinel.svg; description=Use this workbook to analyse the advance hunting data ingested for Defender For Identity.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Microsoft Defender For Identity; templateRelativePath=MicrosoftDefenderForIdentity.json; subtitle=; provider=Microsoft Sentinel Community}.description",
                "parentId": "[variables('workbookId3')]",
                "contentId": "[variables('_workbookContentId3')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Microsoft Defender XDR",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "IdentityLogonEvents",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "IdentityQueryEvents",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "IdentityDirectoryEvents",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "SecurityAlert",
                      "kind": "DataType"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId3')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook3-name')]",
        "contentProductId": "[variables('_workbookcontentProductId3')]",
        "id": "[variables('_workbookcontentProductId3')]",
        "version": "[variables('workbookVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.13",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Microsoft Defender XDR",
        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p> Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Microsoft%20Defender%20XDR/ReleaseNotes.md\">Release Notes</a></p>\n<p> There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href=\"https://www.microsoft.com/security/business/threat-protection/microsoft-365-defender\">Microsoft Defender XDR</a> solution for Microsoft Sentinel enables you to ingest Security Alerts/Incidents and raw logs from the products within Microsoft Defender XDR suite into Microsoft Sentinel.</p>\n<p>Additional Hunting Queries to support proactive and reactive hunting for the Microsoft Defender XDR solution can be found on <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Hunting%20Queries/Microsoft%20365%20Defender\">GitHub</a>. This repository has a collection of queries developed by Microsoft Security Research and Microsoft Sentinel community contributions.</p>\n<p><strong>Underlying Microsoft Technologies used:</strong></p>\n<p>This solution takes a dependency on the following technologies, and some of these dependencies either may be in <a href=\"https://azure.microsoft.com/support/legal/preview-supplemental-terms/\">Preview</a> state or might result in additional ingestion or operational costs:</p>\n<ol type=\"a\">\n<li><a href=\"https://docs.microsoft.com/azure/azure-monitor/logs/data-collector-api\">Azure Monitor HTTP Data Collector API</a></li>\n</ol>\n<p><strong>Data Connectors:</strong> 1, <strong>Workbooks:</strong> 3, <strong>Analytic Rules:</strong> 40, <strong>Hunting Queries:</strong> 326</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Azure_Sentinel.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Microsoft Defender XDR",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
              "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
              "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
              "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
              "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
              "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
              "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
              "version": "[variables('analyticRuleObject11').analyticRuleVersion11]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
              "version": "[variables('analyticRuleObject12').analyticRuleVersion12]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
              "version": "[variables('analyticRuleObject13').analyticRuleVersion13]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
              "version": "[variables('analyticRuleObject14').analyticRuleVersion14]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
              "version": "[variables('analyticRuleObject15').analyticRuleVersion15]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
              "version": "[variables('analyticRuleObject16').analyticRuleVersion16]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
              "version": "[variables('analyticRuleObject17').analyticRuleVersion17]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
              "version": "[variables('analyticRuleObject18').analyticRuleVersion18]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject19')._analyticRulecontentId19]",
              "version": "[variables('analyticRuleObject19').analyticRuleVersion19]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject20')._analyticRulecontentId20]",
              "version": "[variables('analyticRuleObject20').analyticRuleVersion20]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject21')._analyticRulecontentId21]",
              "version": "[variables('analyticRuleObject21').analyticRuleVersion21]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject22')._analyticRulecontentId22]",
              "version": "[variables('analyticRuleObject22').analyticRuleVersion22]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject23')._analyticRulecontentId23]",
              "version": "[variables('analyticRuleObject23').analyticRuleVersion23]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject24')._analyticRulecontentId24]",
              "version": "[variables('analyticRuleObject24').analyticRuleVersion24]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject25')._analyticRulecontentId25]",
              "version": "[variables('analyticRuleObject25').analyticRuleVersion25]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject26')._analyticRulecontentId26]",
              "version": "[variables('analyticRuleObject26').analyticRuleVersion26]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject27')._analyticRulecontentId27]",
              "version": "[variables('analyticRuleObject27').analyticRuleVersion27]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject28')._analyticRulecontentId28]",
              "version": "[variables('analyticRuleObject28').analyticRuleVersion28]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject29')._analyticRulecontentId29]",
              "version": "[variables('analyticRuleObject29').analyticRuleVersion29]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject30')._analyticRulecontentId30]",
              "version": "[variables('analyticRuleObject30').analyticRuleVersion30]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject31')._analyticRulecontentId31]",
              "version": "[variables('analyticRuleObject31').analyticRuleVersion31]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject32')._analyticRulecontentId32]",
              "version": "[variables('analyticRuleObject32').analyticRuleVersion32]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject33')._analyticRulecontentId33]",
              "version": "[variables('analyticRuleObject33').analyticRuleVersion33]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject34')._analyticRulecontentId34]",
              "version": "[variables('analyticRuleObject34').analyticRuleVersion34]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject35')._analyticRulecontentId35]",
              "version": "[variables('analyticRuleObject35').analyticRuleVersion35]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject36')._analyticRulecontentId36]",
              "version": "[variables('analyticRuleObject36').analyticRuleVersion36]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject37')._analyticRulecontentId37]",
              "version": "[variables('analyticRuleObject37').analyticRuleVersion37]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject38')._analyticRulecontentId38]",
              "version": "[variables('analyticRuleObject38').analyticRuleVersion38]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject39')._analyticRulecontentId39]",
              "version": "[variables('analyticRuleObject39').analyticRuleVersion39]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject40')._analyticRulecontentId40]",
              "version": "[variables('analyticRuleObject40').analyticRuleVersion40]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
              "version": "[variables('huntingQueryObject1').huntingQueryVersion1]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
              "version": "[variables('huntingQueryObject2').huntingQueryVersion2]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
              "version": "[variables('huntingQueryObject3').huntingQueryVersion3]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
              "version": "[variables('huntingQueryObject4').huntingQueryVersion4]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
              "version": "[variables('huntingQueryObject5').huntingQueryVersion5]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject6')._huntingQuerycontentId6]",
              "version": "[variables('huntingQueryObject6').huntingQueryVersion6]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject7')._huntingQuerycontentId7]",
              "version": "[variables('huntingQueryObject7').huntingQueryVersion7]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject8')._huntingQuerycontentId8]",
              "version": "[variables('huntingQueryObject8').huntingQueryVersion8]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject9')._huntingQuerycontentId9]",
              "version": "[variables('huntingQueryObject9').huntingQueryVersion9]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject10')._huntingQuerycontentId10]",
              "version": "[variables('huntingQueryObject10').huntingQueryVersion10]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject11')._huntingQuerycontentId11]",
              "version": "[variables('huntingQueryObject11').huntingQueryVersion11]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject12')._huntingQuerycontentId12]",
              "version": "[variables('huntingQueryObject12').huntingQueryVersion12]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject13')._huntingQuerycontentId13]",
              "version": "[variables('huntingQueryObject13').huntingQueryVersion13]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject14')._huntingQuerycontentId14]",
              "version": "[variables('huntingQueryObject14').huntingQueryVersion14]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject15')._huntingQuerycontentId15]",
              "version": "[variables('huntingQueryObject15').huntingQueryVersion15]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject16')._huntingQuerycontentId16]",
              "version": "[variables('huntingQueryObject16').huntingQueryVersion16]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject17')._huntingQuerycontentId17]",
              "version": "[variables('huntingQueryObject17').huntingQueryVersion17]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject18')._huntingQuerycontentId18]",
              "version": "[variables('huntingQueryObject18').huntingQueryVersion18]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject19')._huntingQuerycontentId19]",
              "version": "[variables('huntingQueryObject19').huntingQueryVersion19]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject20')._huntingQuerycontentId20]",
              "version": "[variables('huntingQueryObject20').huntingQueryVersion20]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject21')._huntingQuerycontentId21]",
              "version": "[variables('huntingQueryObject21').huntingQueryVersion21]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject22')._huntingQuerycontentId22]",
              "version": "[variables('huntingQueryObject22').huntingQueryVersion22]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject23')._huntingQuerycontentId23]",
              "version": "[variables('huntingQueryObject23').huntingQueryVersion23]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject24')._huntingQuerycontentId24]",
              "version": "[variables('huntingQueryObject24').huntingQueryVersion24]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject25')._huntingQuerycontentId25]",
              "version": "[variables('huntingQueryObject25').huntingQueryVersion25]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject26')._huntingQuerycontentId26]",
              "version": "[variables('huntingQueryObject26').huntingQueryVersion26]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject27')._huntingQuerycontentId27]",
              "version": "[variables('huntingQueryObject27').huntingQueryVersion27]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject28')._huntingQuerycontentId28]",
              "version": "[variables('huntingQueryObject28').huntingQueryVersion28]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject29')._huntingQuerycontentId29]",
              "version": "[variables('huntingQueryObject29').huntingQueryVersion29]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject30')._huntingQuerycontentId30]",
              "version": "[variables('huntingQueryObject30').huntingQueryVersion30]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject31')._huntingQuerycontentId31]",
              "version": "[variables('huntingQueryObject31').huntingQueryVersion31]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject32')._huntingQuerycontentId32]",
              "version": "[variables('huntingQueryObject32').huntingQueryVersion32]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject33')._huntingQuerycontentId33]",
              "version": "[variables('huntingQueryObject33').huntingQueryVersion33]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject34')._huntingQuerycontentId34]",
              "version": "[variables('huntingQueryObject34').huntingQueryVersion34]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject35')._huntingQuerycontentId35]",
              "version": "[variables('huntingQueryObject35').huntingQueryVersion35]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject36')._huntingQuerycontentId36]",
              "version": "[variables('huntingQueryObject36').huntingQueryVersion36]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject37')._huntingQuerycontentId37]",
              "version": "[variables('huntingQueryObject37').huntingQueryVersion37]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject38')._huntingQuerycontentId38]",
              "version": "[variables('huntingQueryObject38').huntingQueryVersion38]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject39')._huntingQuerycontentId39]",
              "version": "[variables('huntingQueryObject39').huntingQueryVersion39]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject40')._huntingQuerycontentId40]",
              "version": "[variables('huntingQueryObject40').huntingQueryVersion40]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject41')._huntingQuerycontentId41]",
              "version": "[variables('huntingQueryObject41').huntingQueryVersion41]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject42')._huntingQuerycontentId42]",
              "version": "[variables('huntingQueryObject42').huntingQueryVersion42]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject43')._huntingQuerycontentId43]",
              "version": "[variables('huntingQueryObject43').huntingQueryVersion43]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject44')._huntingQuerycontentId44]",
              "version": "[variables('huntingQueryObject44').huntingQueryVersion44]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject45')._huntingQuerycontentId45]",
              "version": "[variables('huntingQueryObject45').huntingQueryVersion45]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject46')._huntingQuerycontentId46]",
              "version": "[variables('huntingQueryObject46').huntingQueryVersion46]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject47')._huntingQuerycontentId47]",
              "version": "[variables('huntingQueryObject47').huntingQueryVersion47]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject48')._huntingQuerycontentId48]",
              "version": "[variables('huntingQueryObject48').huntingQueryVersion48]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject49')._huntingQuerycontentId49]",
              "version": "[variables('huntingQueryObject49').huntingQueryVersion49]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject50')._huntingQuerycontentId50]",
              "version": "[variables('huntingQueryObject50').huntingQueryVersion50]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject51')._huntingQuerycontentId51]",
              "version": "[variables('huntingQueryObject51').huntingQueryVersion51]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject52')._huntingQuerycontentId52]",
              "version": "[variables('huntingQueryObject52').huntingQueryVersion52]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject53')._huntingQuerycontentId53]",
              "version": "[variables('huntingQueryObject53').huntingQueryVersion53]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject54')._huntingQuerycontentId54]",
              "version": "[variables('huntingQueryObject54').huntingQueryVersion54]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject55')._huntingQuerycontentId55]",
              "version": "[variables('huntingQueryObject55').huntingQueryVersion55]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject56')._huntingQuerycontentId56]",
              "version": "[variables('huntingQueryObject56').huntingQueryVersion56]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject57')._huntingQuerycontentId57]",
              "version": "[variables('huntingQueryObject57').huntingQueryVersion57]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject58')._huntingQuerycontentId58]",
              "version": "[variables('huntingQueryObject58').huntingQueryVersion58]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject59')._huntingQuerycontentId59]",
              "version": "[variables('huntingQueryObject59').huntingQueryVersion59]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject60')._huntingQuerycontentId60]",
              "version": "[variables('huntingQueryObject60').huntingQueryVersion60]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject61')._huntingQuerycontentId61]",
              "version": "[variables('huntingQueryObject61').huntingQueryVersion61]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject62')._huntingQuerycontentId62]",
              "version": "[variables('huntingQueryObject62').huntingQueryVersion62]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject63')._huntingQuerycontentId63]",
              "version": "[variables('huntingQueryObject63').huntingQueryVersion63]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject64')._huntingQuerycontentId64]",
              "version": "[variables('huntingQueryObject64').huntingQueryVersion64]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject65')._huntingQuerycontentId65]",
              "version": "[variables('huntingQueryObject65').huntingQueryVersion65]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject66')._huntingQuerycontentId66]",
              "version": "[variables('huntingQueryObject66').huntingQueryVersion66]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject67')._huntingQuerycontentId67]",
              "version": "[variables('huntingQueryObject67').huntingQueryVersion67]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject68')._huntingQuerycontentId68]",
              "version": "[variables('huntingQueryObject68').huntingQueryVersion68]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject69')._huntingQuerycontentId69]",
              "version": "[variables('huntingQueryObject69').huntingQueryVersion69]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject70')._huntingQuerycontentId70]",
              "version": "[variables('huntingQueryObject70').huntingQueryVersion70]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject71')._huntingQuerycontentId71]",
              "version": "[variables('huntingQueryObject71').huntingQueryVersion71]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject72')._huntingQuerycontentId72]",
              "version": "[variables('huntingQueryObject72').huntingQueryVersion72]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject73')._huntingQuerycontentId73]",
              "version": "[variables('huntingQueryObject73').huntingQueryVersion73]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject74')._huntingQuerycontentId74]",
              "version": "[variables('huntingQueryObject74').huntingQueryVersion74]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject75')._huntingQuerycontentId75]",
              "version": "[variables('huntingQueryObject75').huntingQueryVersion75]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject76')._huntingQuerycontentId76]",
              "version": "[variables('huntingQueryObject76').huntingQueryVersion76]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject77')._huntingQuerycontentId77]",
              "version": "[variables('huntingQueryObject77').huntingQueryVersion77]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject78')._huntingQuerycontentId78]",
              "version": "[variables('huntingQueryObject78').huntingQueryVersion78]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject79')._huntingQuerycontentId79]",
              "version": "[variables('huntingQueryObject79').huntingQueryVersion79]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject80')._huntingQuerycontentId80]",
              "version": "[variables('huntingQueryObject80').huntingQueryVersion80]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject81')._huntingQuerycontentId81]",
              "version": "[variables('huntingQueryObject81').huntingQueryVersion81]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject82')._huntingQuerycontentId82]",
              "version": "[variables('huntingQueryObject82').huntingQueryVersion82]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject83')._huntingQuerycontentId83]",
              "version": "[variables('huntingQueryObject83').huntingQueryVersion83]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject84')._huntingQuerycontentId84]",
              "version": "[variables('huntingQueryObject84').huntingQueryVersion84]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject85')._huntingQuerycontentId85]",
              "version": "[variables('huntingQueryObject85').huntingQueryVersion85]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject86')._huntingQuerycontentId86]",
              "version": "[variables('huntingQueryObject86').huntingQueryVersion86]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject87')._huntingQuerycontentId87]",
              "version": "[variables('huntingQueryObject87').huntingQueryVersion87]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject88')._huntingQuerycontentId88]",
              "version": "[variables('huntingQueryObject88').huntingQueryVersion88]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject89')._huntingQuerycontentId89]",
              "version": "[variables('huntingQueryObject89').huntingQueryVersion89]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject90')._huntingQuerycontentId90]",
              "version": "[variables('huntingQueryObject90').huntingQueryVersion90]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject91')._huntingQuerycontentId91]",
              "version": "[variables('huntingQueryObject91').huntingQueryVersion91]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject92')._huntingQuerycontentId92]",
              "version": "[variables('huntingQueryObject92').huntingQueryVersion92]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject93')._huntingQuerycontentId93]",
              "version": "[variables('huntingQueryObject93').huntingQueryVersion93]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject94')._huntingQuerycontentId94]",
              "version": "[variables('huntingQueryObject94').huntingQueryVersion94]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject95')._huntingQuerycontentId95]",
              "version": "[variables('huntingQueryObject95').huntingQueryVersion95]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject96')._huntingQuerycontentId96]",
              "version": "[variables('huntingQueryObject96').huntingQueryVersion96]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject97')._huntingQuerycontentId97]",
              "version": "[variables('huntingQueryObject97').huntingQueryVersion97]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject98')._huntingQuerycontentId98]",
              "version": "[variables('huntingQueryObject98').huntingQueryVersion98]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject99')._huntingQuerycontentId99]",
              "version": "[variables('huntingQueryObject99').huntingQueryVersion99]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject100')._huntingQuerycontentId100]",
              "version": "[variables('huntingQueryObject100').huntingQueryVersion100]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject101')._huntingQuerycontentId101]",
              "version": "[variables('huntingQueryObject101').huntingQueryVersion101]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject102')._huntingQuerycontentId102]",
              "version": "[variables('huntingQueryObject102').huntingQueryVersion102]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject103')._huntingQuerycontentId103]",
              "version": "[variables('huntingQueryObject103').huntingQueryVersion103]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject104')._huntingQuerycontentId104]",
              "version": "[variables('huntingQueryObject104').huntingQueryVersion104]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject105')._huntingQuerycontentId105]",
              "version": "[variables('huntingQueryObject105').huntingQueryVersion105]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject106')._huntingQuerycontentId106]",
              "version": "[variables('huntingQueryObject106').huntingQueryVersion106]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject107')._huntingQuerycontentId107]",
              "version": "[variables('huntingQueryObject107').huntingQueryVersion107]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject108')._huntingQuerycontentId108]",
              "version": "[variables('huntingQueryObject108').huntingQueryVersion108]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject109')._huntingQuerycontentId109]",
              "version": "[variables('huntingQueryObject109').huntingQueryVersion109]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject110')._huntingQuerycontentId110]",
              "version": "[variables('huntingQueryObject110').huntingQueryVersion110]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject111')._huntingQuerycontentId111]",
              "version": "[variables('huntingQueryObject111').huntingQueryVersion111]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject112')._huntingQuerycontentId112]",
              "version": "[variables('huntingQueryObject112').huntingQueryVersion112]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject113')._huntingQuerycontentId113]",
              "version": "[variables('huntingQueryObject113').huntingQueryVersion113]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject114')._huntingQuerycontentId114]",
              "version": "[variables('huntingQueryObject114').huntingQueryVersion114]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject115')._huntingQuerycontentId115]",
              "version": "[variables('huntingQueryObject115').huntingQueryVersion115]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject116')._huntingQuerycontentId116]",
              "version": "[variables('huntingQueryObject116').huntingQueryVersion116]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject117')._huntingQuerycontentId117]",
              "version": "[variables('huntingQueryObject117').huntingQueryVersion117]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject118')._huntingQuerycontentId118]",
              "version": "[variables('huntingQueryObject118').huntingQueryVersion118]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject119')._huntingQuerycontentId119]",
              "version": "[variables('huntingQueryObject119').huntingQueryVersion119]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject120')._huntingQuerycontentId120]",
              "version": "[variables('huntingQueryObject120').huntingQueryVersion120]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject121')._huntingQuerycontentId121]",
              "version": "[variables('huntingQueryObject121').huntingQueryVersion121]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject122')._huntingQuerycontentId122]",
              "version": "[variables('huntingQueryObject122').huntingQueryVersion122]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject123')._huntingQuerycontentId123]",
              "version": "[variables('huntingQueryObject123').huntingQueryVersion123]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject124')._huntingQuerycontentId124]",
              "version": "[variables('huntingQueryObject124').huntingQueryVersion124]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject125')._huntingQuerycontentId125]",
              "version": "[variables('huntingQueryObject125').huntingQueryVersion125]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject126')._huntingQuerycontentId126]",
              "version": "[variables('huntingQueryObject126').huntingQueryVersion126]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject127')._huntingQuerycontentId127]",
              "version": "[variables('huntingQueryObject127').huntingQueryVersion127]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject128')._huntingQuerycontentId128]",
              "version": "[variables('huntingQueryObject128').huntingQueryVersion128]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject129')._huntingQuerycontentId129]",
              "version": "[variables('huntingQueryObject129').huntingQueryVersion129]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject130')._huntingQuerycontentId130]",
              "version": "[variables('huntingQueryObject130').huntingQueryVersion130]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject131')._huntingQuerycontentId131]",
              "version": "[variables('huntingQueryObject131').huntingQueryVersion131]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject132')._huntingQuerycontentId132]",
              "version": "[variables('huntingQueryObject132').huntingQueryVersion132]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject133')._huntingQuerycontentId133]",
              "version": "[variables('huntingQueryObject133').huntingQueryVersion133]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject134')._huntingQuerycontentId134]",
              "version": "[variables('huntingQueryObject134').huntingQueryVersion134]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject135')._huntingQuerycontentId135]",
              "version": "[variables('huntingQueryObject135').huntingQueryVersion135]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject136')._huntingQuerycontentId136]",
              "version": "[variables('huntingQueryObject136').huntingQueryVersion136]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject137')._huntingQuerycontentId137]",
              "version": "[variables('huntingQueryObject137').huntingQueryVersion137]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject138')._huntingQuerycontentId138]",
              "version": "[variables('huntingQueryObject138').huntingQueryVersion138]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject139')._huntingQuerycontentId139]",
              "version": "[variables('huntingQueryObject139').huntingQueryVersion139]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject140')._huntingQuerycontentId140]",
              "version": "[variables('huntingQueryObject140').huntingQueryVersion140]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject141')._huntingQuerycontentId141]",
              "version": "[variables('huntingQueryObject141').huntingQueryVersion141]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject142')._huntingQuerycontentId142]",
              "version": "[variables('huntingQueryObject142').huntingQueryVersion142]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject143')._huntingQuerycontentId143]",
              "version": "[variables('huntingQueryObject143').huntingQueryVersion143]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject144')._huntingQuerycontentId144]",
              "version": "[variables('huntingQueryObject144').huntingQueryVersion144]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject145')._huntingQuerycontentId145]",
              "version": "[variables('huntingQueryObject145').huntingQueryVersion145]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject146')._huntingQuerycontentId146]",
              "version": "[variables('huntingQueryObject146').huntingQueryVersion146]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject147')._huntingQuerycontentId147]",
              "version": "[variables('huntingQueryObject147').huntingQueryVersion147]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject148')._huntingQuerycontentId148]",
              "version": "[variables('huntingQueryObject148').huntingQueryVersion148]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject149')._huntingQuerycontentId149]",
              "version": "[variables('huntingQueryObject149').huntingQueryVersion149]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject150')._huntingQuerycontentId150]",
              "version": "[variables('huntingQueryObject150').huntingQueryVersion150]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject151')._huntingQuerycontentId151]",
              "version": "[variables('huntingQueryObject151').huntingQueryVersion151]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject152')._huntingQuerycontentId152]",
              "version": "[variables('huntingQueryObject152').huntingQueryVersion152]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject153')._huntingQuerycontentId153]",
              "version": "[variables('huntingQueryObject153').huntingQueryVersion153]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject154')._huntingQuerycontentId154]",
              "version": "[variables('huntingQueryObject154').huntingQueryVersion154]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject155')._huntingQuerycontentId155]",
              "version": "[variables('huntingQueryObject155').huntingQueryVersion155]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject156')._huntingQuerycontentId156]",
              "version": "[variables('huntingQueryObject156').huntingQueryVersion156]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject157')._huntingQuerycontentId157]",
              "version": "[variables('huntingQueryObject157').huntingQueryVersion157]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject158')._huntingQuerycontentId158]",
              "version": "[variables('huntingQueryObject158').huntingQueryVersion158]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject159')._huntingQuerycontentId159]",
              "version": "[variables('huntingQueryObject159').huntingQueryVersion159]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject160')._huntingQuerycontentId160]",
              "version": "[variables('huntingQueryObject160').huntingQueryVersion160]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject161')._huntingQuerycontentId161]",
              "version": "[variables('huntingQueryObject161').huntingQueryVersion161]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject162')._huntingQuerycontentId162]",
              "version": "[variables('huntingQueryObject162').huntingQueryVersion162]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject163')._huntingQuerycontentId163]",
              "version": "[variables('huntingQueryObject163').huntingQueryVersion163]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject164')._huntingQuerycontentId164]",
              "version": "[variables('huntingQueryObject164').huntingQueryVersion164]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject165')._huntingQuerycontentId165]",
              "version": "[variables('huntingQueryObject165').huntingQueryVersion165]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject166')._huntingQuerycontentId166]",
              "version": "[variables('huntingQueryObject166').huntingQueryVersion166]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject167')._huntingQuerycontentId167]",
              "version": "[variables('huntingQueryObject167').huntingQueryVersion167]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject168')._huntingQuerycontentId168]",
              "version": "[variables('huntingQueryObject168').huntingQueryVersion168]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject169')._huntingQuerycontentId169]",
              "version": "[variables('huntingQueryObject169').huntingQueryVersion169]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject170')._huntingQuerycontentId170]",
              "version": "[variables('huntingQueryObject170').huntingQueryVersion170]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject171')._huntingQuerycontentId171]",
              "version": "[variables('huntingQueryObject171').huntingQueryVersion171]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject172')._huntingQuerycontentId172]",
              "version": "[variables('huntingQueryObject172').huntingQueryVersion172]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject173')._huntingQuerycontentId173]",
              "version": "[variables('huntingQueryObject173').huntingQueryVersion173]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject174')._huntingQuerycontentId174]",
              "version": "[variables('huntingQueryObject174').huntingQueryVersion174]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject175')._huntingQuerycontentId175]",
              "version": "[variables('huntingQueryObject175').huntingQueryVersion175]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject176')._huntingQuerycontentId176]",
              "version": "[variables('huntingQueryObject176').huntingQueryVersion176]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject177')._huntingQuerycontentId177]",
              "version": "[variables('huntingQueryObject177').huntingQueryVersion177]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject178')._huntingQuerycontentId178]",
              "version": "[variables('huntingQueryObject178').huntingQueryVersion178]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject179')._huntingQuerycontentId179]",
              "version": "[variables('huntingQueryObject179').huntingQueryVersion179]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject180')._huntingQuerycontentId180]",
              "version": "[variables('huntingQueryObject180').huntingQueryVersion180]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject181')._huntingQuerycontentId181]",
              "version": "[variables('huntingQueryObject181').huntingQueryVersion181]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject182')._huntingQuerycontentId182]",
              "version": "[variables('huntingQueryObject182').huntingQueryVersion182]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject183')._huntingQuerycontentId183]",
              "version": "[variables('huntingQueryObject183').huntingQueryVersion183]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject184')._huntingQuerycontentId184]",
              "version": "[variables('huntingQueryObject184').huntingQueryVersion184]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject185')._huntingQuerycontentId185]",
              "version": "[variables('huntingQueryObject185').huntingQueryVersion185]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject186')._huntingQuerycontentId186]",
              "version": "[variables('huntingQueryObject186').huntingQueryVersion186]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject187')._huntingQuerycontentId187]",
              "version": "[variables('huntingQueryObject187').huntingQueryVersion187]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject188')._huntingQuerycontentId188]",
              "version": "[variables('huntingQueryObject188').huntingQueryVersion188]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject189')._huntingQuerycontentId189]",
              "version": "[variables('huntingQueryObject189').huntingQueryVersion189]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject190')._huntingQuerycontentId190]",
              "version": "[variables('huntingQueryObject190').huntingQueryVersion190]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject191')._huntingQuerycontentId191]",
              "version": "[variables('huntingQueryObject191').huntingQueryVersion191]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject192')._huntingQuerycontentId192]",
              "version": "[variables('huntingQueryObject192').huntingQueryVersion192]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject193')._huntingQuerycontentId193]",
              "version": "[variables('huntingQueryObject193').huntingQueryVersion193]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject194')._huntingQuerycontentId194]",
              "version": "[variables('huntingQueryObject194').huntingQueryVersion194]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject195')._huntingQuerycontentId195]",
              "version": "[variables('huntingQueryObject195').huntingQueryVersion195]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject196')._huntingQuerycontentId196]",
              "version": "[variables('huntingQueryObject196').huntingQueryVersion196]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject197')._huntingQuerycontentId197]",
              "version": "[variables('huntingQueryObject197').huntingQueryVersion197]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject198')._huntingQuerycontentId198]",
              "version": "[variables('huntingQueryObject198').huntingQueryVersion198]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject199')._huntingQuerycontentId199]",
              "version": "[variables('huntingQueryObject199').huntingQueryVersion199]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject200')._huntingQuerycontentId200]",
              "version": "[variables('huntingQueryObject200').huntingQueryVersion200]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject201')._huntingQuerycontentId201]",
              "version": "[variables('huntingQueryObject201').huntingQueryVersion201]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject202')._huntingQuerycontentId202]",
              "version": "[variables('huntingQueryObject202').huntingQueryVersion202]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject203')._huntingQuerycontentId203]",
              "version": "[variables('huntingQueryObject203').huntingQueryVersion203]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject204')._huntingQuerycontentId204]",
              "version": "[variables('huntingQueryObject204').huntingQueryVersion204]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject205')._huntingQuerycontentId205]",
              "version": "[variables('huntingQueryObject205').huntingQueryVersion205]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject206')._huntingQuerycontentId206]",
              "version": "[variables('huntingQueryObject206').huntingQueryVersion206]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject207')._huntingQuerycontentId207]",
              "version": "[variables('huntingQueryObject207').huntingQueryVersion207]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject208')._huntingQuerycontentId208]",
              "version": "[variables('huntingQueryObject208').huntingQueryVersion208]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject209')._huntingQuerycontentId209]",
              "version": "[variables('huntingQueryObject209').huntingQueryVersion209]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject210')._huntingQuerycontentId210]",
              "version": "[variables('huntingQueryObject210').huntingQueryVersion210]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject211')._huntingQuerycontentId211]",
              "version": "[variables('huntingQueryObject211').huntingQueryVersion211]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject212')._huntingQuerycontentId212]",
              "version": "[variables('huntingQueryObject212').huntingQueryVersion212]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject213')._huntingQuerycontentId213]",
              "version": "[variables('huntingQueryObject213').huntingQueryVersion213]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject214')._huntingQuerycontentId214]",
              "version": "[variables('huntingQueryObject214').huntingQueryVersion214]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject215')._huntingQuerycontentId215]",
              "version": "[variables('huntingQueryObject215').huntingQueryVersion215]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject216')._huntingQuerycontentId216]",
              "version": "[variables('huntingQueryObject216').huntingQueryVersion216]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject217')._huntingQuerycontentId217]",
              "version": "[variables('huntingQueryObject217').huntingQueryVersion217]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject218')._huntingQuerycontentId218]",
              "version": "[variables('huntingQueryObject218').huntingQueryVersion218]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject219')._huntingQuerycontentId219]",
              "version": "[variables('huntingQueryObject219').huntingQueryVersion219]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject220')._huntingQuerycontentId220]",
              "version": "[variables('huntingQueryObject220').huntingQueryVersion220]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject221')._huntingQuerycontentId221]",
              "version": "[variables('huntingQueryObject221').huntingQueryVersion221]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject222')._huntingQuerycontentId222]",
              "version": "[variables('huntingQueryObject222').huntingQueryVersion222]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject223')._huntingQuerycontentId223]",
              "version": "[variables('huntingQueryObject223').huntingQueryVersion223]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject224')._huntingQuerycontentId224]",
              "version": "[variables('huntingQueryObject224').huntingQueryVersion224]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject225')._huntingQuerycontentId225]",
              "version": "[variables('huntingQueryObject225').huntingQueryVersion225]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject226')._huntingQuerycontentId226]",
              "version": "[variables('huntingQueryObject226').huntingQueryVersion226]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject227')._huntingQuerycontentId227]",
              "version": "[variables('huntingQueryObject227').huntingQueryVersion227]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject228')._huntingQuerycontentId228]",
              "version": "[variables('huntingQueryObject228').huntingQueryVersion228]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject229')._huntingQuerycontentId229]",
              "version": "[variables('huntingQueryObject229').huntingQueryVersion229]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject230')._huntingQuerycontentId230]",
              "version": "[variables('huntingQueryObject230').huntingQueryVersion230]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject231')._huntingQuerycontentId231]",
              "version": "[variables('huntingQueryObject231').huntingQueryVersion231]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject232')._huntingQuerycontentId232]",
              "version": "[variables('huntingQueryObject232').huntingQueryVersion232]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject233')._huntingQuerycontentId233]",
              "version": "[variables('huntingQueryObject233').huntingQueryVersion233]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject234')._huntingQuerycontentId234]",
              "version": "[variables('huntingQueryObject234').huntingQueryVersion234]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject235')._huntingQuerycontentId235]",
              "version": "[variables('huntingQueryObject235').huntingQueryVersion235]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject236')._huntingQuerycontentId236]",
              "version": "[variables('huntingQueryObject236').huntingQueryVersion236]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject237')._huntingQuerycontentId237]",
              "version": "[variables('huntingQueryObject237').huntingQueryVersion237]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject238')._huntingQuerycontentId238]",
              "version": "[variables('huntingQueryObject238').huntingQueryVersion238]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject239')._huntingQuerycontentId239]",
              "version": "[variables('huntingQueryObject239').huntingQueryVersion239]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject240')._huntingQuerycontentId240]",
              "version": "[variables('huntingQueryObject240').huntingQueryVersion240]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject241')._huntingQuerycontentId241]",
              "version": "[variables('huntingQueryObject241').huntingQueryVersion241]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject242')._huntingQuerycontentId242]",
              "version": "[variables('huntingQueryObject242').huntingQueryVersion242]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject243')._huntingQuerycontentId243]",
              "version": "[variables('huntingQueryObject243').huntingQueryVersion243]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject244')._huntingQuerycontentId244]",
              "version": "[variables('huntingQueryObject244').huntingQueryVersion244]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject245')._huntingQuerycontentId245]",
              "version": "[variables('huntingQueryObject245').huntingQueryVersion245]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject246')._huntingQuerycontentId246]",
              "version": "[variables('huntingQueryObject246').huntingQueryVersion246]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject247')._huntingQuerycontentId247]",
              "version": "[variables('huntingQueryObject247').huntingQueryVersion247]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject248')._huntingQuerycontentId248]",
              "version": "[variables('huntingQueryObject248').huntingQueryVersion248]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject249')._huntingQuerycontentId249]",
              "version": "[variables('huntingQueryObject249').huntingQueryVersion249]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject250')._huntingQuerycontentId250]",
              "version": "[variables('huntingQueryObject250').huntingQueryVersion250]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject251')._huntingQuerycontentId251]",
              "version": "[variables('huntingQueryObject251').huntingQueryVersion251]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject252')._huntingQuerycontentId252]",
              "version": "[variables('huntingQueryObject252').huntingQueryVersion252]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject253')._huntingQuerycontentId253]",
              "version": "[variables('huntingQueryObject253').huntingQueryVersion253]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject254')._huntingQuerycontentId254]",
              "version": "[variables('huntingQueryObject254').huntingQueryVersion254]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject255')._huntingQuerycontentId255]",
              "version": "[variables('huntingQueryObject255').huntingQueryVersion255]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject256')._huntingQuerycontentId256]",
              "version": "[variables('huntingQueryObject256').huntingQueryVersion256]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject257')._huntingQuerycontentId257]",
              "version": "[variables('huntingQueryObject257').huntingQueryVersion257]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject258')._huntingQuerycontentId258]",
              "version": "[variables('huntingQueryObject258').huntingQueryVersion258]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject259')._huntingQuerycontentId259]",
              "version": "[variables('huntingQueryObject259').huntingQueryVersion259]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject260')._huntingQuerycontentId260]",
              "version": "[variables('huntingQueryObject260').huntingQueryVersion260]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject261')._huntingQuerycontentId261]",
              "version": "[variables('huntingQueryObject261').huntingQueryVersion261]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject262')._huntingQuerycontentId262]",
              "version": "[variables('huntingQueryObject262').huntingQueryVersion262]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject263')._huntingQuerycontentId263]",
              "version": "[variables('huntingQueryObject263').huntingQueryVersion263]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject264')._huntingQuerycontentId264]",
              "version": "[variables('huntingQueryObject264').huntingQueryVersion264]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject265')._huntingQuerycontentId265]",
              "version": "[variables('huntingQueryObject265').huntingQueryVersion265]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject266')._huntingQuerycontentId266]",
              "version": "[variables('huntingQueryObject266').huntingQueryVersion266]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject267')._huntingQuerycontentId267]",
              "version": "[variables('huntingQueryObject267').huntingQueryVersion267]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject268')._huntingQuerycontentId268]",
              "version": "[variables('huntingQueryObject268').huntingQueryVersion268]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject269')._huntingQuerycontentId269]",
              "version": "[variables('huntingQueryObject269').huntingQueryVersion269]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject270')._huntingQuerycontentId270]",
              "version": "[variables('huntingQueryObject270').huntingQueryVersion270]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject271')._huntingQuerycontentId271]",
              "version": "[variables('huntingQueryObject271').huntingQueryVersion271]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject272')._huntingQuerycontentId272]",
              "version": "[variables('huntingQueryObject272').huntingQueryVersion272]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject273')._huntingQuerycontentId273]",
              "version": "[variables('huntingQueryObject273').huntingQueryVersion273]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject274')._huntingQuerycontentId274]",
              "version": "[variables('huntingQueryObject274').huntingQueryVersion274]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject275')._huntingQuerycontentId275]",
              "version": "[variables('huntingQueryObject275').huntingQueryVersion275]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject276')._huntingQuerycontentId276]",
              "version": "[variables('huntingQueryObject276').huntingQueryVersion276]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject277')._huntingQuerycontentId277]",
              "version": "[variables('huntingQueryObject277').huntingQueryVersion277]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject278')._huntingQuerycontentId278]",
              "version": "[variables('huntingQueryObject278').huntingQueryVersion278]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject279')._huntingQuerycontentId279]",
              "version": "[variables('huntingQueryObject279').huntingQueryVersion279]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject280')._huntingQuerycontentId280]",
              "version": "[variables('huntingQueryObject280').huntingQueryVersion280]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject281')._huntingQuerycontentId281]",
              "version": "[variables('huntingQueryObject281').huntingQueryVersion281]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject282')._huntingQuerycontentId282]",
              "version": "[variables('huntingQueryObject282').huntingQueryVersion282]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject283')._huntingQuerycontentId283]",
              "version": "[variables('huntingQueryObject283').huntingQueryVersion283]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject284')._huntingQuerycontentId284]",
              "version": "[variables('huntingQueryObject284').huntingQueryVersion284]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject285')._huntingQuerycontentId285]",
              "version": "[variables('huntingQueryObject285').huntingQueryVersion285]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject286')._huntingQuerycontentId286]",
              "version": "[variables('huntingQueryObject286').huntingQueryVersion286]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject287')._huntingQuerycontentId287]",
              "version": "[variables('huntingQueryObject287').huntingQueryVersion287]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject288')._huntingQuerycontentId288]",
              "version": "[variables('huntingQueryObject288').huntingQueryVersion288]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject289')._huntingQuerycontentId289]",
              "version": "[variables('huntingQueryObject289').huntingQueryVersion289]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject290')._huntingQuerycontentId290]",
              "version": "[variables('huntingQueryObject290').huntingQueryVersion290]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject291')._huntingQuerycontentId291]",
              "version": "[variables('huntingQueryObject291').huntingQueryVersion291]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject292')._huntingQuerycontentId292]",
              "version": "[variables('huntingQueryObject292').huntingQueryVersion292]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject293')._huntingQuerycontentId293]",
              "version": "[variables('huntingQueryObject293').huntingQueryVersion293]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject294')._huntingQuerycontentId294]",
              "version": "[variables('huntingQueryObject294').huntingQueryVersion294]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject295')._huntingQuerycontentId295]",
              "version": "[variables('huntingQueryObject295').huntingQueryVersion295]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject296')._huntingQuerycontentId296]",
              "version": "[variables('huntingQueryObject296').huntingQueryVersion296]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject297')._huntingQuerycontentId297]",
              "version": "[variables('huntingQueryObject297').huntingQueryVersion297]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject298')._huntingQuerycontentId298]",
              "version": "[variables('huntingQueryObject298').huntingQueryVersion298]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject299')._huntingQuerycontentId299]",
              "version": "[variables('huntingQueryObject299').huntingQueryVersion299]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject300')._huntingQuerycontentId300]",
              "version": "[variables('huntingQueryObject300').huntingQueryVersion300]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject301')._huntingQuerycontentId301]",
              "version": "[variables('huntingQueryObject301').huntingQueryVersion301]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject302')._huntingQuerycontentId302]",
              "version": "[variables('huntingQueryObject302').huntingQueryVersion302]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject303')._huntingQuerycontentId303]",
              "version": "[variables('huntingQueryObject303').huntingQueryVersion303]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject304')._huntingQuerycontentId304]",
              "version": "[variables('huntingQueryObject304').huntingQueryVersion304]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject305')._huntingQuerycontentId305]",
              "version": "[variables('huntingQueryObject305').huntingQueryVersion305]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject306')._huntingQuerycontentId306]",
              "version": "[variables('huntingQueryObject306').huntingQueryVersion306]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject307')._huntingQuerycontentId307]",
              "version": "[variables('huntingQueryObject307').huntingQueryVersion307]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject308')._huntingQuerycontentId308]",
              "version": "[variables('huntingQueryObject308').huntingQueryVersion308]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject309')._huntingQuerycontentId309]",
              "version": "[variables('huntingQueryObject309').huntingQueryVersion309]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject310')._huntingQuerycontentId310]",
              "version": "[variables('huntingQueryObject310').huntingQueryVersion310]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject311')._huntingQuerycontentId311]",
              "version": "[variables('huntingQueryObject311').huntingQueryVersion311]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject312')._huntingQuerycontentId312]",
              "version": "[variables('huntingQueryObject312').huntingQueryVersion312]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject313')._huntingQuerycontentId313]",
              "version": "[variables('huntingQueryObject313').huntingQueryVersion313]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject314')._huntingQuerycontentId314]",
              "version": "[variables('huntingQueryObject314').huntingQueryVersion314]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject315')._huntingQuerycontentId315]",
              "version": "[variables('huntingQueryObject315').huntingQueryVersion315]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject316')._huntingQuerycontentId316]",
              "version": "[variables('huntingQueryObject316').huntingQueryVersion316]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject317')._huntingQuerycontentId317]",
              "version": "[variables('huntingQueryObject317').huntingQueryVersion317]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject318')._huntingQuerycontentId318]",
              "version": "[variables('huntingQueryObject318').huntingQueryVersion318]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject319')._huntingQuerycontentId319]",
              "version": "[variables('huntingQueryObject319').huntingQueryVersion319]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject320')._huntingQuerycontentId320]",
              "version": "[variables('huntingQueryObject320').huntingQueryVersion320]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject321')._huntingQuerycontentId321]",
              "version": "[variables('huntingQueryObject321').huntingQueryVersion321]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject322')._huntingQuerycontentId322]",
              "version": "[variables('huntingQueryObject322').huntingQueryVersion322]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject323')._huntingQuerycontentId323]",
              "version": "[variables('huntingQueryObject323').huntingQueryVersion323]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject324')._huntingQuerycontentId324]",
              "version": "[variables('huntingQueryObject324').huntingQueryVersion324]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject325')._huntingQuerycontentId325]",
              "version": "[variables('huntingQueryObject325').huntingQueryVersion325]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject326')._huntingQuerycontentId326]",
              "version": "[variables('huntingQueryObject326').huntingQueryVersion326]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId2')]",
              "version": "[variables('workbookVersion2')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId3')]",
              "version": "[variables('workbookVersion3')]"
            }
          ]
        },
        "firstPublishDate": "2022-05-02",
        "providers": [
          "Microsoft"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
