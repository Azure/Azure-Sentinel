id: a3619c75-a927-4dbb-91cc-9adc55e95bda
name: Malware detections by detection methods
description: |
  This query helps reviewing malware detections by detection methods
description-detailed: |
  This query helps reviewing malware detections by detection methods in Defender for Office 365
requiredDataConnectors:
  - connectorId: MicrosoftThreatProtection
    dataTypes:
      - EmailEvents
tactics:
  - InitialAccess
relevantTechniques:
  - T1566
query: |
  EmailEvents
  | where Timestamp > ago(30d)
  | where isnotempty(DetectionMethods)
  | extend MDO_detection = parse_json(DetectionMethods)
  | where MDO_detection.Malware in 
          (
            @'["File detonation reputation"]',
            @'["File detonation"]',
            @'["File reputation"]',
            @'["Antimalware engine"]',
            @'["URL malicious reputation"]',
            @'["URL detonation reputation"]',
            @'["URL detonation"]'
          )
  | extend SenderFromAddress_IPv4 = strcat(SenderFromAddress, ", ", SenderIPv4)
  | project Timestamp, NetworkMessageId, Subject, SenderFromAddress_IPv4, RecipientEmailAddress, DeliveryLocation, MDO_detection.Malware
version: 1.0.0