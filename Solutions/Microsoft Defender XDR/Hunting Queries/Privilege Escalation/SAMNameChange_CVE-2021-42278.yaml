id: 1299962c-804e-459a-8d3d-41d68bc45ba2
name: SAM Name Change CVE-2021-42278
description: |
  The following query detects possible CVE-2021-42278 exploitation by finding changes of device names in the network using Microsoft Defender for Identity.
description-detailed: |
  The following query detects possible CVE-2021-42278 exploitation by finding changes of device names in the network using Microsoft Defender for Identity.
  The query looks for changes in the SAM account name of devices in the network. The query uses the Microsoft Defender for Identity connector to search for IdentityDirectoryEvents where the ActionType is "SAM Account Name changed". The query then filters the results to find changes where the FROMSAM has a "$" and the TOSAM does not have a "$" or the TOSAM is one of the domain controllers in the organization.
  Reference: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42278
requiredDataConnectors:
  - connectorId: MicrosoftThreatProtection
    dataTypes:
      - IdentityDirectoryEvents
tactics:
  - PrivilegeEscalation
  - Vulnerability
tags:
  - CVE-2021-42278
  - Vulnerability
query: |
  IdentityDirectoryEvents
  | where TimeGenerated > ago(1d)
  | where ActionType == "SAM Account Name changed"
  | extend FROMSAM = parse_json(AdditionalFields)['FROM SAM Account Name']
  | extend TOSAM = parse_json(AdditionalFields)['TO SAM Account Name']
  | where (FROMSAM has "$" and TOSAM !has "$") 
          or TOSAM in ("DC1", "DC2", "DC3", "DC4") // DC Names in the org
  | project TimeGenerated, Application, ActionType, TargetDeviceName, FROMSAM, TOSAM, ReportId, AdditionalFields
version: 1.0.0