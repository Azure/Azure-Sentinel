{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Data443 Risk Mitigation, Inc. - support@data443.com",
    "comments": "Solution template for TacitRed-Defender-ThreatIntelligence"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "email": "support@data443.com",
    "_email": "[variables('email')]",
    "_solutionName": "TacitRed-Defender-ThreatIntelligence",
    "_solutionVersion": "3.0.0",
    "solutionId": "data443riskmitigationinc1761580347231.azure-sentinel-solution-tacitred-defender-ti",
    "_solutionId": "[variables('solutionId')]",
    "TacitRedDefenderTI_FunctionApp": "TacitRedDefenderTI_FunctionApp",
    "_TacitRedDefenderTI_FunctionApp": "[variables('TacitRedDefenderTI_FunctionApp')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "TacitRedDefenderTI_FunctionApp",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-fa-',uniquestring(variables('_playbookContentId1'))))]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','fa','-', uniqueString(concat(variables('_solutionId'),'-','AzureFunction','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
    "TacitRedToDefenderTI": "TacitRedToDefenderTI",
    "_TacitRedToDefenderTI": "[variables('TacitRedToDefenderTI')]",
    "TemplateEmptyArray": "[json('[]')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "TacitRedToDefenderTI",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))))]",
    "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "TacitRedDefenderTI_FunctionApp Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "FunctionAppName": {
              "defaultValue": "tacitreddefenderti",
              "type": "string",
              "metadata": {
                "description": "Prefix for the Azure Function App name"
              }
            },
            "FunctionAppCodeUrl": {
              "type": "string",
              "metadata": {
                "description": "URL to the Function App code zip file"
              },
              "defaultValue": "https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/TacitRed-Defender-ThreatIntelligence/Package/functionCode.zip"
            },
            "workspace": {
              "type": "string",
              "metadata": {
                "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
              }
            }
          },
          "variables": {
            "functionAppName": "[[concat(parameters('FunctionAppName'), uniqueString(resourceGroup().id))]",
            "hostingPlanName": "[[concat('plan-', variables('functionAppName'))]",
            "storageAccountName": "[[concat('st', uniqueString(resourceGroup().id))]",
            "appInsightsName": "[[concat('appi-', variables('functionAppName'))]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId1": "TacitRedDefenderTI_FunctionApp",
            "playbookId1": "[[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[[variables('storageAccountName')]",
              "location": "[[variables('workspace-location-inline')]",
              "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
              },
              "kind": "StorageV2",
              "properties": {
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                  "services": {
                    "file": {
                      "keyType": "Account",
                      "enabled": true
                    },
                    "blob": {
                      "keyType": "Account",
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.Storage"
                }
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[[variables('appInsightsName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web"
              }
            },
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2024-04-01",
              "name": "[[variables('hostingPlanName')]",
              "location": "[[variables('workspace-location-inline')]",
              "sku": {
                "name": "Y1",
                "tier": "Dynamic",
                "size": "Y1",
                "family": "Y"
              },
              "properties": {
                "computeMode": "Dynamic",
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2024-04-01",
              "name": "[[variables('functionAppName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
                "[[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                "[[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
              ],
              "properties": {
                "reserved": true,
                "httpsOnly": true,
                "serverFarmId": "[[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
                "siteConfig": {
                  "linuxFxVersion": "python|3.11",
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';EndpointSuffix=', environment().suffixes.storage, ';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-05-01').keys[0].value)]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "python"
                    },
                    {
                      "name": "WEBSITE_RUN_FROM_PACKAGE",
                      "value": "[[parameters('FunctionAppCodeUrl')]"
                    },
                    {
                      "name": "SENTINEL_WORKSPACE_ID",
                      "value": "[[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').InstrumentationKey]"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[[guid(resourceGroup().id, variables('functionAppName'), 'Reader')]",
              "scope": "[[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
              "properties": {
                "roleDefinitionId": "[[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                "principalId": "[[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2024-04-01', 'Full').identity.principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[[guid(resourceGroup().id, variables('functionAppName'), 'SentinelContributor')]",
              "scope": "[[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
              "properties": {
                "roleDefinitionId": "[[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ab8e14d6-4a74-4a29-9ba8-549422addade')]",
                "principalId": "[[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2024-04-01', 'Full').identity.principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
              ]
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('AzureFunction-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "AzureFunction",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "TacitRed-Defender-ThreatIntelligence",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Data443 Risk Mitigation, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Data443 Risk Mitigation, Inc.",
                  "email": "support@data443.com",
                  "tier": "Partner",
                  "link": "https://www.data443.com"
                }
              }
            }
          ],
          "metadata": {
            "title": "TacitRedDefenderTI_FunctionApp",
            "description": "This Azure Function connects to TacitRed API to retrieve compromised credentials and pushes them to Microsoft Defender Threat Intelligence.",
            "prerequisites": [
              "TacitRed API Key",
              "Microsoft Sentinel workspace with Defender TI enabled"
            ],
            "lastUpdateTime": "2025-12-09T00:00:00Z",
            "tags": [
              "TacitRed",
              "Threat Intelligence",
              "Azure Function"
            ],
            "postDeployment": [
              "Deploy the TacitRedToDefenderTI playbook and provide the Function App URL"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "TacitRedDefenderTI_FunctionApp",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId1')]",
        "contentKind": "AzureFunction",
        "displayName": "TacitRedDefenderTI_FunctionApp",
        "contentProductId": "[variables('_playbookcontentProductId1')]",
        "id": "[variables('_playbookcontentProductId1')]",
        "version": "[variables('playbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "TacitRedToDefenderTI Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "TacitRedToDefenderTI",
              "type": "string",
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "TacitRed_ApiKey": {
              "type": "securestring",
              "metadata": {
                "description": "TacitRed API Key for authentication"
              }
            },
            "FunctionAppName": {
              "defaultValue": "tacitreddefenderti",
              "type": "string",
              "metadata": {
                "description": "Prefix for the Azure Function App name. Must match the Function App deployment parameter (before uniqueString is applied)."
              }
            }
          },
          "variables": {
            "logicAppName": "[[parameters('PlaybookName')]",
            "functionAppName": "[[concat(parameters('FunctionAppName'), uniqueString(resourceGroup().id))]",
            "functionAppId": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/', variables('functionAppName'))]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "TacitRedToDefenderTI",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "TacitRed_ApiKey": {
                      "type": "securestring"
                    },
                    "FunctionAppName": {
                      "type": "string",
                      "defaultValue": "[[parameters('FunctionAppName')]"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "type": "Recurrence",
                      "recurrence": {
                        "frequency": "Hour",
                        "interval": 6,
                        "timeZone": "UTC"
                      }
                    }
                  },
                  "actions": {
                    "Initialize_Config": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Domains",
                            "type": "Array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      }
                    },
                    "Call_Function_App": {
                      "type": "Function",
                      "inputs": {
                        "method": "POST",
                        "function": {
                          "id": "[[concat(variables('functionAppId'), '/functions/TacitRedToDefenderTI')]"
                        },
                        "body": {
                          "domains": "@variables('Domains')",
                          "date_from": "@{formatDateTime(addDays(utcNow(), -30), 'yyyy-MM-ddTHH:mm:ssZ')}",
                          "date_until": "@{formatDateTime(utcNow(), 'yyyy-MM-ddTHH:mm:ssZ')}",
                          "tacitred_api_key": "@parameters('TacitRed_ApiKey')"
                        }
                      },
                      "runAfter": {
                        "Initialize_Config": [
                          "Succeeded"
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "TacitRed_ApiKey": {
                    "value": "[[parameters('TacitRed_ApiKey')]"
                  },
                  "FunctionAppName": {
                    "value": "[[parameters('FunctionAppName')]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "TacitRed-Defender-ThreatIntelligence",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Data443 Risk Mitigation, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Data443 Risk Mitigation, Inc.",
                  "email": "support@data443.com",
                  "tier": "Partner",
                  "link": "https://www.data443.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "AzureFunction",
                      "contentId": "[variables('_TacitRedDefenderTI_FunctionApp')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "TacitRed to Defender TI",
            "description": "This playbook ingests TacitRed threat intelligence into Microsoft Defender Threat Intelligence via an Azure Function. It runs on a recurring schedule, retrieves compromised credentials from TacitRed, and pushes indicators using the Upload API.",
            "mainSteps": [
              "1. Triggers on a recurring schedule (every 6 hours).",
              "2. Calls the TacitRed Defender TI Azure Function with configured domains and API key.",
              "3. The Azure Function retrieves compromised credentials from TacitRed and ingests them into Defender Threat Intelligence."
            ],
            "prerequisites": [
              "1. Deploy the TacitRed Defender TI Function App under the same subscription and resource group.",
              "2. Use the same FunctionAppName prefix in this playbook as the Function App deployment.",
              "3. TacitRed API Key is required for authentication.",
              "4. Microsoft Sentinel workspace with Defender TI enabled."
            ],
            "postDeployment": [
              "**a. Configure playbook parameters**",
              "1. Open the Logic App in the Azure portal.",
              "2. Enter the TacitRed API Key.",
              "3. Confirm the FunctionAppName prefix matches the deployed Function App.",
              "**b. Configure in Sentinel**",
              "1. Optionally configure automation rules to trigger the playbook."
            ],
            "lastUpdateTime": "2026-01-30T00:00:00Z",
            "tags": [
              "TacitRed",
              "Threat Intelligence"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "TacitRed to Defender TI",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId2')]",
        "contentKind": "Playbook",
        "displayName": "TacitRedToDefenderTI",
        "contentProductId": "[variables('_playbookcontentProductId2')]",
        "id": "[variables('_playbookcontentProductId2')]",
        "version": "[variables('playbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "TacitRed-Defender-ThreatIntelligence",
        "publisherDisplayName": "Data443 Risk Mitigation, Inc.",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>• Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/TacitRed-Defender-ThreatIntelligence/ReleaseNotes.md\">Release Notes</a></p>\n<p>• There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The TacitRed Defender Threat Intelligence solution integrates TacitRed's threat intelligence feed with Microsoft Sentinel. It automatically retrieves compromised credentials and other threat indicators from TacitRed and ingests them into Microsoft Sentinel using the Upload API for enhanced threat detection.</p>\n<p><strong>Function Apps:</strong> 1, <strong>Playbooks:</strong> 1</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/tacitred_logo.svg\"width=\"75px\"height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "TacitRed-Defender-ThreatIntelligence",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Data443 Risk Mitigation, Inc.",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Data443 Risk Mitigation, Inc.",
          "email": "support@data443.com",
          "tier": "Partner",
          "link": "https://www.data443.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "AzureFunction",
              "contentId": "[variables('_TacitRedDefenderTI_FunctionApp')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_TacitRedToDefenderTI')]",
              "version": "[variables('playbookVersion2')]"
            }
          ]
        },
        "firstPublishDate": "2025-11-10",
        "providers": [
          "Data443 Risk Mitigation, Inc."
        ],
        "categories": {
          "domains": [
            "Security - Threat Intelligence"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
