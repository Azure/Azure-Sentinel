{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Global Report Parameters\n---\n"
            },
            "name": "Global Parameters - Title"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "da560c64-0f1b-4d78-aed1-08b12ff4d5d8",
                  "version": "KqlParameterItem/1.0",
                  "name": "p_TimeSelect",
                  "label": "Time Range",
                  "type": 4,
                  "isGlobal": true,
                  "value": {
                    "durationMs": 5184000000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 2592000000
                  }
                },
                {
                  "id": "c02a503c-24a5-429b-ab54-681e5e31a8e6",
                  "version": "KqlParameterItem/1.0",
                  "name": "p_Summary",
                  "label": "Show/Hide Summary",
                  "type": 2,
                  "isRequired": true,
                  "isGlobal": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    { \"value\":\"SHOW\", \"label\":\"Show Summary\" },\r\n    { \"value\":\"HIDE\", \"label\":\"Hide Summary\", \"selected\":true }\r\n]"
                }
              ],
              "style": "above",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "Global Parameters - Data"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "1d8c721a-9325-4890-999b-6dae03fdf534",
                  "version": "KqlParameterItem/1.0",
                  "name": "p_System",
                  "label": "SAP System",
                  "type": 2,
                  "isRequired": true,
                  "isGlobal": true,
                  "query": "SAP_AGR_TCODES | summarize  by  SystemID;",
                  "value": "ECD",
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                {
                  "id": "102235d8-ba09-45d3-8891-ebb781b22c12",
                  "version": "KqlParameterItem/1.0",
                  "name": "p_Client",
                  "label": "SAP Client",
                  "type": 2,
                  "isRequired": true,
                  "isGlobal": true,
                  "query": "SAP_AGR_TCODES | where SystemID == \"{p_System}\" | summarize  by  MANDT;",
                  "value": "800",
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                }
              ],
              "style": "above",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "Global Parameters - SAP System Details"
          }
        ],
        "exportParameters": true
      },
      "name": "Parameterisation"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Summary\n---\n"
            },
            "conditionalVisibility": {
              "parameterName": "p_Summary",
              "comparison": "isEqualTo",
              "value": "SHOW"
            },
            "name": "text - 2 - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "ABAP_AGR_USERS_CL\n| extend  TimeGenerated =bin(TimeGenerated,1h)\n| where SystemID_s == \"{p_System}\" | where MANDT_s == \"{p_Client}\"\n| summarize count() by TimeGenerated , SystemID_s, MANDT_s\n| extend Source=\"ABAP_AGR_USERS_CL\"\n| union (ABAP_AGR_TCODES_CL\n   | extend  TimeGenerated =bin(TimeGenerated,1h)\n   | where SystemID_s == \"{p_System}\" | where MANDT_s == \"{p_Client}\"\n   | summarize count() by TimeGenerated, SystemID_s, MANDT_s\n   | extend Source=\"ABAP_AGR_TCODES_CL\")\n   | project Time=TimeGenerated, Client=strcat(SystemID_s, \"/\", MANDT_s), Source\n   | order by Time desc;\n\n",
              "size": 1,
              "title": "Log Contents",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "sortBy": []
            },
            "customWidth": "30",
            "conditionalVisibility": {
              "parameterName": "p_Summary",
              "comparison": "isEqualTo",
              "value": "SHOW"
            },
            "name": "Log Content",
            "styleSettings": {
              "maxWidth": "30"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let GRCRISKS = _GetWatchlist('AliterSODRisks');\r\nGRCRISKS\r\n| project BusinessProcess=BP, Risk, Description, FunctionA=Func1, FunctionB=Func2, Severity\r\n| order by BusinessProcess asc, Risk asc\r\n;",
              "size": 0,
              "title": "Risks Watchlist",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "40",
            "name": "Risks"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let GRCFUNCS = _GetWatchlist('AliterSODFunctions');\r\nGRCFUNCS\r\n| summarize Transactions = make_list(TCODE) by Function\r\n| order by Function asc \r\n;",
              "size": 0,
              "title": "Functions Watchlist",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "30",
            "name": "Functions"
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "p_Summary",
          "comparison": "isEqualTo",
          "value": "SHOW"
        },
        {
          "parameterName": "p_System",
          "comparison": "isNotEqualTo"
        },
        {
          "parameterName": "p_Client",
          "comparison": "isNotEqualTo"
        }
      ],
      "name": "SOD Report Summary"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Report 1 - Summary of Risks by Users\n---\n"
                  },
                  "name": "Report 1 - Summary of Risks by Users - Custom Roles"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "03a43f6b-3c33-4471-9555-723e914fceed",
                        "version": "KqlParameterItem/1.0",
                        "name": "p_SOD1_BP",
                        "label": "Business Process Area",
                        "type": 2,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "let GRCRISKS = _GetWatchlist('AliterSODRisks');\r\nGRCRISKS\r\n| project BusinessProcess=BP | summarize by BusinessProcess | order by BusinessProcess asc\r\n;",
                        "value": [
                          "Purchasing",
                          "Basis",
                          "Finance",
                          "People",
                          "Sales"
                        ],
                        "typeSettings": {
                          "additionalResourceOptions": []
                        },
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      },
                      {
                        "id": "b3d72f7e-a9f9-4b9e-8a30-581d44fd0e18",
                        "version": "KqlParameterItem/1.0",
                        "name": "p_SOD1_Prefix",
                        "label": "Role Prefix",
                        "type": 2,
                        "description": "Analyse SAP Standard or Customer Roles",
                        "isRequired": true,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "jsonData": "[\r\n    { \"value\":\"SAP\", \"label\":\"Standard Roles (SAP)\" },\r\n    { \"value\":\"Y\", \"label\":\"Custom Roles (Y)\" },\r\n    { \"value\":\"Z\", \"label\":\"Custom Roles (Z)\", \"selected\":true }\r\n]"
                      }
                    ],
                    "style": "above",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "Parameters - SOD2 - Copy"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "// Load GRC master data from WatchList\r\nlet GRCRISKS = _GetWatchlist('AliterSODRisks');\r\nlet GRCFUNCS = _GetWatchlist('AliterSODFunctions');\r\n// Build summary list of transactions and the functions they're contained in\r\nlet RISKStoFUNCTION1 = GRCFUNCS\r\n| join GRCRISKS on $left.Function == $right.Func1\r\n;\r\nlet RISKStoFUNCTION2 = GRCFUNCS\r\n| join GRCRISKS on $left.Function == $right.Func2\r\n;\r\nlet RISKStoFUNCTIONS = RISKStoFUNCTION1\r\n| union RISKStoFUNCTION2\r\n| order by Function asc, Risk asc\r\n;\r\n//RISKStoFUNCTIONS | project Risk, Function, Func1, Func2 | order by Risk asc, Function asc;\r\n// End of Rule processing section\r\n// ################################################################################\r\n// Process the customer information\r\n// ################################################################################\r\n// --------------------------------------------------------------------------------\r\n// Find the last post for AGR_TCODES and AGR_USERS from the SAP system\r\n// --------------------------------------------------------------------------------\r\nlet LASTUSERSPOST=SAP_AGR_USERS\r\n| where SystemID == \"{p_System}\" and MANDT == \"{p_Client}\" and AGR_NAME startswith \"{p_SOD1_Prefix}\"\r\n| summarize TimeGenerated=max(TimeGenerated) by AGR_NAME, UNAME | order by AGR_NAME asc, UNAME asc\r\n;\r\nlet LASTTCODEPOST=SAP_AGR_TCODES\r\n| where SystemID == \"{p_System}\" and MANDT == \"{p_Client}\" and AGR_NAME startswith \"{p_SOD1_Prefix}\"\r\n| summarize TimeGenerated=max(TimeGenerated) by AGR_NAME | order by AGR_NAME asc \r\n;\r\n// --------------------------------------------------------------------------------\r\n// List of functions for every role that contains a transaction on the risk list\r\n// --------------------------------------------------------------------------------\r\nlet ROLEStoFUNCTIONS = LASTTCODEPOST \r\n| join SAP_AGR_TCODES on AGR_NAME, TimeGenerated\r\n| join kind=inner GRCFUNCS on TCODE\r\n| summarize Transactions = make_list(TCODE) by AGR_NAME, Function\r\n| order by AGR_NAME asc, Function asc\r\n;\r\nlet ROLEStoFUNCTIONSCount=toscalar(ROLEStoFUNCTIONS | count);\r\n//ROLEStoFUNCTIONS | project AGR_NAME, Function, Transactions, ROLEStoFUNCTIONSCount | order by AGR_NAME asc, Function asc;\r\n// --------------------------------------------------------------------------------\r\n// List of functions assigned to user assigned roles\r\n// --------------------------------------------------------------------------------\r\nlet USERStoFUNCTIONS = LASTUSERSPOST\r\n| join SAP_AGR_USERS on AGR_NAME, UNAME, TimeGenerated\r\n| join ROLEStoFUNCTIONS on AGR_NAME\r\n| project AGR_NAME, UNAME, Function, Transactions\r\n| order by AGR_NAME asc, UNAME asc, Function asc\r\n;\r\nlet USERStoFUNCTIONSCount=toscalar(USERStoFUNCTIONS | count);\r\n//USERStoFUNCTIONS | project UNAME, AGR_NAME, Function, Transactions, USERStoFUNCTIONSCount | order by UNAME asc, AGR_NAME asc, Function asc;\r\n// --------------------------------------------------------------------------------\r\n// Get list of user and role combinations containing functions at risk\r\n// --------------------------------------------------------------------------------\r\nlet USERStoRISKS = USERStoFUNCTIONS\r\n| join kind=inner RISKStoFUNCTIONS on $left.Function == $right.Function\r\n| where BP in ({p_SOD1_BP})\r\n| order by UNAME asc, AGR_NAME asc, Risk asc, BP asc\r\n;\r\nlet USERStoRISKSCount=toscalar(USERStoRISKS | count);\r\n//USERStoRISKS | project UNAME, AGR_NAME, Function, Func1, Func2, Risk, Transactions, USERStoRISKSCount | order by UNAME asc, AGR_NAME asc, Func1 asc;\r\n// --------------------------------------------------------------------------------\r\n// Identify rows with duplicate \"Risk\" column - these are the risks\r\n// --------------------------------------------------------------------------------\r\nlet X=USERStoRISKS | summarize count() by BP, Risk, UNAME, AGR_NAME | where count_ > 1 | order by BP, Risk asc, AGR_NAME asc, UNAME asc | project BP, Risk, AGR_NAME, UNAME, count_;\r\n// --------------------------------------------------------------------------------\r\n// Prepare data for pie chart\r\n// --------------------------------------------------------------------------------\r\nlet SummaryTotal=toscalar(X | count);\r\nlet SUMMARY = X\r\n| summarize SummaryItems=count() by BP\r\n| extend SummaryPcent=round(((SummaryItems * 100.0) / SummaryTotal), 2)\r\n| project BP, SummaryItems, SummaryPcent, SummaryTotal\r\n| order by BP;\r\nSUMMARY;",
                    "size": 0,
                    "title": "User Assigned Roles by Buisness Process Area",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "piechart",
                    "gridSettings": {
                      "rowLimit": 9999,
                      "filter": true
                    },
                    "sortBy": [],
                    "chartSettings": {
                      "xAxis": "Severity",
                      "yAxis": [
                        "SummaryPcent"
                      ],
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 1,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "20",
                  "name": "Report 1 - Summary of Risks by Users (Pie Chart)",
                  "styleSettings": {
                    "maxWidth": "20"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "// Load GRC master data from WatchList\r\nlet GRCRISKS = _GetWatchlist('AliterSODRisks');\r\nlet GRCFUNCS = _GetWatchlist('AliterSODFunctions');\r\n// Build summary list of transactions and the functions they're contained in\r\nlet RISKStoFUNCTION1 = GRCFUNCS\r\n| join GRCRISKS on $left.Function == $right.Func1\r\n;\r\nlet RISKStoFUNCTION2 = GRCFUNCS\r\n| join GRCRISKS on $left.Function == $right.Func2\r\n;\r\nlet RISKStoFUNCTIONS = RISKStoFUNCTION1\r\n| union RISKStoFUNCTION2\r\n| order by Function asc, Risk asc\r\n;\r\n//RISKStoFUNCTIONS | project Risk, Function, Func1, Func2 | order by Risk asc, Function asc;\r\n// End of Rule processing section\r\n// ################################################################################\r\n// Process the customer information\r\n// ################################################################################\r\n// --------------------------------------------------------------------------------\r\n// Find the last post for AGR_TCODES and AGR_USERS from the SAP system\r\n// --------------------------------------------------------------------------------\r\nlet LASTUSERSPOST=SAP_AGR_USERS\r\n| where SystemID == \"{p_System}\" and MANDT == \"{p_Client}\" and AGR_NAME startswith \"{p_SOD1_Prefix}\"\r\n| summarize TimeGenerated=max(TimeGenerated) by AGR_NAME, UNAME | order by AGR_NAME asc, UNAME asc\r\n;\r\nlet LASTTCODEPOST=SAP_AGR_TCODES\r\n| where SystemID == \"{p_System}\" and MANDT == \"{p_Client}\" and AGR_NAME startswith \"{p_SOD1_Prefix}\"\r\n| summarize TimeGenerated=max(TimeGenerated) by AGR_NAME | order by AGR_NAME asc \r\n;\r\n// --------------------------------------------------------------------------------\r\n// List of functions for every role that contains a transaction on the risk list\r\n// --------------------------------------------------------------------------------\r\nlet ROLEStoFUNCTIONS = LASTTCODEPOST \r\n| join SAP_AGR_TCODES on AGR_NAME, TimeGenerated\r\n| join kind=inner GRCFUNCS on TCODE\r\n| summarize Transactions = make_list(TCODE) by AGR_NAME, Function\r\n| order by AGR_NAME asc, Function asc\r\n;\r\nlet ROLEStoFUNCTIONSCount=toscalar(ROLEStoFUNCTIONS | count);\r\n//ROLEStoFUNCTIONS | project AGR_NAME, Function, Transactions, ROLEStoFUNCTIONSCount | order by AGR_NAME asc, Function asc;\r\n// --------------------------------------------------------------------------------\r\n// List of functions assigned to user assigned roles\r\n// --------------------------------------------------------------------------------\r\nlet USERStoFUNCTIONS = LASTUSERSPOST\r\n| join SAP_AGR_USERS on AGR_NAME, UNAME, TimeGenerated\r\n| join ROLEStoFUNCTIONS on AGR_NAME\r\n| project AGR_NAME, UNAME, Function, Transactions\r\n| order by AGR_NAME asc, UNAME asc, Function asc\r\n;\r\nlet USERStoFUNCTIONSCount=toscalar(USERStoFUNCTIONS | count);\r\n//USERStoFUNCTIONS | project UNAME, AGR_NAME, Function, Transactions, USERStoFUNCTIONSCount | order by UNAME asc, AGR_NAME asc, Function asc;\r\n// --------------------------------------------------------------------------------\r\n// Get list of user and role combinations containing functions at risk\r\n// --------------------------------------------------------------------------------\r\nlet USERStoRISKS = USERStoFUNCTIONS\r\n| join kind=inner RISKStoFUNCTIONS on $left.Function == $right.Function\r\n| where BP in ({p_SOD1_BP})\r\n| order by UNAME asc, AGR_NAME asc, Risk asc, BP asc\r\n;\r\nUSERStoRISKS | project Risk, User=UNAME, Severity, Role=AGR_NAME | order by Risk asc, User asc, Role asc\r\n;",
                    "size": 0,
                    "title": "User Assigned Roles by Buisness Process Area",
                    "exportFieldName": "",
                    "exportParameterName": "p_SOD1_selection",
                    "exportDefaultValue": "",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "table",
                    "gridSettings": {
                      "rowLimit": 9999
                    },
                    "sortBy": [],
                    "chartSettings": {
                      "xAxis": "Severity",
                      "yAxis": [
                        "SummaryPcent"
                      ],
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 1,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "40",
                  "name": "Report 1 - Summary of Risks by Users (Grid)",
                  "styleSettings": {
                    "maxWidth": "40"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "// Load GRC master data from Storage Account\r\nlet GRCRISKS = _GetWatchlist('AliterSODRisks');\r\nlet GRCFUNCS = _GetWatchlist('AliterSODFunctions');\r\n// Build summary list of transactions and the functions they're contained in\r\nlet RISKStoFUNCTION1 = GRCFUNCS\r\n| join GRCRISKS on $left.Function == $right.Func1\r\n;\r\nlet RISKStoFUNCTION2 = GRCFUNCS\r\n| join GRCRISKS on $left.Function == $right.Func2\r\n;\r\nlet RISKStoFUNCTIONS = RISKStoFUNCTION1\r\n| union RISKStoFUNCTION2\r\n| order by Function asc, Risk asc\r\n;\r\n//RISKStoFUNCTIONS | project Risk, Function, Func1, Func2 | order by Risk asc, Function asc;\r\n// End of Rule processing section\r\n// ################################################################################\r\n// Process the customer information\r\n// ################################################################################\r\n// --------------------------------------------------------------------------------\r\n// Find the last post for AGR_TCODES and AGR_USERS from the SAP system\r\n// --------------------------------------------------------------------------------\r\nlet LASTUSERSPOST=SAP_AGR_USERS\r\n| where SystemID == \"{p_System}\" and MANDT == \"{p_Client}\" and AGR_NAME startswith \"{p_SOD1_Prefix}\"\r\n| summarize TimeGenerated=max(TimeGenerated) by AGR_NAME, UNAME | order by AGR_NAME asc, UNAME asc\r\n;\r\nlet LASTTCODEPOST=SAP_AGR_TCODES\r\n| where SystemID == \"{p_System}\" and MANDT == \"{p_Client}\" and AGR_NAME startswith \"{p_SOD1_Prefix}\"\r\n| summarize TimeGenerated=max(TimeGenerated) by AGR_NAME | order by AGR_NAME asc \r\n;\r\n// --------------------------------------------------------------------------------\r\n// List of functions for every role that contains a transaction on the risk list\r\n// --------------------------------------------------------------------------------\r\nlet ROLEStoFUNCTIONS = LASTTCODEPOST \r\n| join SAP_AGR_TCODES on AGR_NAME, TimeGenerated\r\n| join kind=inner GRCFUNCS on TCODE\r\n| summarize Transactions = make_list(TCODE) by AGR_NAME, Function\r\n| order by AGR_NAME asc, Function asc\r\n;\r\nlet ROLEStoFUNCTIONSCount=toscalar(ROLEStoFUNCTIONS | count);\r\n//ROLEStoFUNCTIONS | project AGR_NAME, Function, Transactions, ROLEStoFUNCTIONSCount | order by AGR_NAME asc, Function asc;\r\n// --------------------------------------------------------------------------------\r\n// List of functions assigned to user assigned roles\r\n// --------------------------------------------------------------------------------\r\nlet USERStoFUNCTIONS = LASTUSERSPOST\r\n| join SAP_AGR_USERS on AGR_NAME, UNAME, TimeGenerated\r\n| join ROLEStoFUNCTIONS on AGR_NAME\r\n| project AGR_NAME, UNAME, Function, Transactions\r\n| order by AGR_NAME asc, UNAME asc, Function asc\r\n;\r\nlet USERStoFUNCTIONSCount=toscalar(USERStoFUNCTIONS | count);\r\n//USERStoFUNCTIONS | project UNAME, AGR_NAME, Function, Transactions, USERStoFUNCTIONSCount | order by UNAME asc, AGR_NAME asc, Function asc;\r\n// --------------------------------------------------------------------------------\r\n// Get list of user and role combinations containing functions at risk\r\n// --------------------------------------------------------------------------------\r\nlet USERStoRISKS = USERStoFUNCTIONS\r\n| join kind=inner RISKStoFUNCTIONS on $left.Function == $right.Function\r\n| where BP in ({p_SOD1_BP})\r\n| order by UNAME asc, AGR_NAME asc, Risk asc, BP asc\r\n;\r\nlet USERStoRISKSCount=toscalar(USERStoRISKS | count);\r\n//USERStoRISKS | project UNAME, AGR_NAME, Function, Func1, Func2, Risk, Transactions, USERStoRISKSCount | order by UNAME asc, AGR_NAME asc, Func1 a\r\n// --------------------------------------------------------------------------------\r\n// Now output the user risks\r\n// --------------------------------------------------------------------------------\r\nUSERStoRISKS | top-hitters 10 of BP;\r\n//USERStoRISKS | summarize by Risk;\r\n",
                    "size": 0,
                    "title": "User Assigned Roles - Top Hitters by Business Process Area",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "barchart",
                    "gridSettings": {
                      "rowLimit": 1000,
                      "filter": true
                    },
                    "sortBy": [],
                    "graphSettings": {
                      "type": 0
                    },
                    "chartSettings": {
                      "xAxis": "BP",
                      "showLegend": true
                    }
                  },
                  "customWidth": "40",
                  "name": "Report 1 - Summary of Risks by Users (Bar Chart)",
                  "styleSettings": {
                    "maxWidth": "40"
                  }
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "p_System",
              "comparison": "isNotEqualTo"
            },
            "name": "SOD Report 1"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Report 2 - Summary of Risks for Roles\n---\n"
                  },
                  "name": "Report 1 - Summary of Risks by Users - Custom Roles - Copy"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "ac1640eb-c028-4d82-a713-89891edb50c5",
                        "version": "KqlParameterItem/1.0",
                        "name": "p_SOD2_BP",
                        "label": "Business Process Area",
                        "type": 2,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "let GRCRISKS = _GetWatchlist('AliterSODRisks');\r\nGRCRISKS\r\n| project BusinessProcess=BP | summarize by BusinessProcess | order by BusinessProcess asc\r\n;",
                        "value": [
                          "Basis",
                          "Finance",
                          "Purchasing",
                          "Sales",
                          "People"
                        ],
                        "typeSettings": {
                          "additionalResourceOptions": []
                        },
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      },
                      {
                        "id": "4d490a78-a366-48f6-a894-4c5af44a661e",
                        "version": "KqlParameterItem/1.0",
                        "name": "p_SOD2_Prefix",
                        "label": "Role Prefix",
                        "type": 2,
                        "description": "Analyse SAP Standard or Customer Roles",
                        "isRequired": true,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "jsonData": "[\r\n    { \"value\":\"SAP\", \"label\":\"Standard Roles (SAP)\" },\r\n    { \"value\":\"Y\", \"label\":\"Custom Roles (Y)\" },\r\n    { \"value\":\"Z\", \"label\":\"Custom Roles (Z)\", \"selected\":true }\r\n]"
                      }
                    ],
                    "style": "above",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "Parameters - SOD2"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "// Load GRC master data from WatchList\r\nlet GRCRISKS = _GetWatchlist('AliterSODRisks');\r\nlet GRCFUNCS = _GetWatchlist('AliterSODFunctions');\r\n// ################################################################################\r\n// Process the customer information\r\n// ################################################################################\r\n// --------------------------------------------------------------------------------\r\n// Find the last post for AGR_TCODES from the SAP system\r\n// --------------------------------------------------------------------------------\r\nlet LASTTCODEPOST = SAP_AGR_TCODES\r\n| where SystemID == \"{p_System}\" and MANDT == \"{p_Client}\" and AGR_NAME startswith \"{p_SOD2_Prefix}\"\r\n| summarize TimeGenerated=max(TimeGenerated) by AGR_NAME | order by AGR_NAME asc \r\n;\r\n// --------------------------------------------------------------------------------\r\n// List of functions for every role that contains a transaction on the risk list\r\n// --------------------------------------------------------------------------------\r\nlet ROLEStoFUNCTIONS = LASTTCODEPOST \r\n| join SAP_AGR_TCODES on AGR_NAME, TimeGenerated\r\n| join kind=inner GRCFUNCS on TCODE\r\n| summarize Transactions = make_list(TCODE) by AGR_NAME, Function\r\n| order by AGR_NAME asc, Function asc\r\n;\r\nlet ROLEStoFUNCTIONSCount=toscalar(ROLEStoFUNCTIONS | count);\r\n//ROLEStoFUNCTIONS | project AGR_NAME, Function, Transactions, ROLEStoFUNCTIONSCount;\r\n// --------------------------------------------------------------------------------\r\n// Include the associated risk for function-1\r\n// --------------------------------------------------------------------------------\r\nlet ROLEStoRISK1 = ROLEStoFUNCTIONS\r\n| join kind=inner GRCRISKS on $left.Function == $right.Func1\r\n| where BP in ({p_SOD2_BP})\r\n| order by AGR_NAME asc, Func1 asc, Risk asc\r\n;\r\nlet ROLEStoRISK1Count=toscalar(ROLEStoRISK1 | count);\r\n//ROLEStoRISK1 | project AGR_NAME, Func1, Risk, BP, \"{p_SOD2_BP}\", ROLEStoRISK1Count;\r\n// --------------------------------------------------------------------------------\r\n// Include the associated risk for function-2\r\n// --------------------------------------------------------------------------------\r\nlet ROLEStoRISK2 = ROLEStoFUNCTIONS\r\n| join kind=inner GRCRISKS on $left.Function == $right.Func2\r\n| where BP in ({p_SOD2_BP})\r\n| order by AGR_NAME asc, Func2 asc, Risk asc\r\n;\r\nlet ROLEStoRISK2Count=toscalar(ROLEStoRISK2 | count);\r\n//ROLEStoRISK2 | project AGR_NAME, TCODE, Func2, Risk, BP, ROLEStoRISK2Count;\r\n// --------------------------------------------------------------------------------\r\n// Determine which roles have risk\r\n// --------------------------------------------------------------------------------\r\nlet ROLEStoRISKS = ROLEStoRISK1\r\n| join ROLEStoRISK2 on $left.AGR_NAME == $right.AGR_NAME,\r\n                       $left.Risk == $right.Risk\r\n| order by AGR_NAME asc, Risk asc\r\n| project AGR_NAME, Risk, Func1, Func2, BP\r\n;\r\nlet ROLEStoRISKCount=toscalar(ROLEStoRISKS | count);\r\n//ROLEStoRISKS | project AGR_NAME, Risk, Func2, ROLEStoRISKCount, ROLEStoRISK1Count, ROLEStoRISK2Count;\r\nlet SummaryTotal=toscalar(ROLEStoRISKS | count)\r\n;\r\nlet SUMMARY = ROLEStoRISKS\r\n| summarize SummaryItems=count() by BP\r\n| extend SummaryPcent=round(((SummaryItems * 100.0) / SummaryTotal), 2)\r\n| project BP, SummaryItems, SummaryPcent, SummaryTotal\r\n| order by BP\r\n;\r\nSUMMARY;",
                    "size": 0,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "piechart",
                    "gridSettings": {
                      "rowLimit": 9999,
                      "filter": true
                    },
                    "sortBy": [],
                    "chartSettings": {
                      "xAxis": "Severity",
                      "yAxis": [
                        "SummaryPcent"
                      ],
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 1,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "20",
                  "name": "Report 2 – Summary of Risks by Roles (Pie Chart)",
                  "styleSettings": {
                    "maxWidth": "20"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "// Load GRC master data from WatchList\r\nlet GRCRISKS = _GetWatchlist('AliterSODRisks');\r\nlet GRCFUNCS = _GetWatchlist('AliterSODFunctions');\r\n// ################################################################################\r\n// Process the customer information\r\n// ################################################################################\r\n// --------------------------------------------------------------------------------\r\n// Find the last post for AGR_TCODES from the SAP system\r\n// --------------------------------------------------------------------------------\r\nlet LASTTCODEPOST = SAP_AGR_TCODES\r\n| where SystemID == \"{p_System}\" and MANDT == \"{p_Client}\" and AGR_NAME startswith \"{p_SOD2_Prefix}\"\r\n| summarize TimeGenerated=max(TimeGenerated) by AGR_NAME | order by AGR_NAME asc \r\n;\r\n// --------------------------------------------------------------------------------\r\n// List of functions for every role that contains a transaction on the risk list\r\n// --------------------------------------------------------------------------------\r\nlet ROLEStoFUNCTIONS = LASTTCODEPOST \r\n| join SAP_AGR_TCODES on AGR_NAME, TimeGenerated\r\n| join kind=inner GRCFUNCS on TCODE\r\n| summarize Transactions = make_list(TCODE) by AGR_NAME, Function\r\n| order by AGR_NAME asc, Function asc\r\n;\r\nlet ROLEStoFUNCTIONSCount=toscalar(ROLEStoFUNCTIONS | count);\r\n//ROLEStoFUNCTIONS | project AGR_NAME, Function, Transactions, ROLEStoFUNCTIONSCount;\r\n// --------------------------------------------------------------------------------\r\n// Include the associated risk for function-1\r\n// --------------------------------------------------------------------------------\r\nlet ROLEStoRISK1 = ROLEStoFUNCTIONS\r\n| join kind=inner GRCRISKS on $left.Function == $right.Func1\r\n| where BP in ({p_SOD2_BP})\r\n| order by AGR_NAME asc, Func1 asc, Risk asc\r\n;\r\nlet ROLEStoRISK1Count=toscalar(ROLEStoRISK1 | count);\r\n//ROLEStoRISK1 | project AGR_NAME, Func1, Risk, BP, \"{p_SOD2_BP}\", ROLEStoRISK1Count;\r\n// --------------------------------------------------------------------------------\r\n// Include the associated risk for function-2\r\n// --------------------------------------------------------------------------------\r\nlet ROLEStoRISK2 = ROLEStoFUNCTIONS\r\n| join kind=inner GRCRISKS on $left.Function == $right.Func2\r\n| where BP in ({p_SOD2_BP})\r\n| order by AGR_NAME asc, Func2 asc, Risk asc\r\n;\r\nlet ROLEStoRISK2Count=toscalar(ROLEStoRISK2 | count);\r\n//ROLEStoRISK2 | project AGR_NAME, TCODE, Func2, Risk, BP, ROLEStoRISK2Count;\r\n// --------------------------------------------------------------------------------\r\n// Determine which roles have risk\r\n// --------------------------------------------------------------------------------\r\nlet ROLEStoRISKS = ROLEStoRISK1\r\n| join ROLEStoRISK2 on $left.AGR_NAME == $right.AGR_NAME,\r\n                       $left.Risk == $right.Risk\r\n| order by AGR_NAME asc, Risk asc\r\n| project AGR_NAME, Risk, Func1, Func2, BP, Transactions, Severity\r\n;\r\nlet ROLEStoRISKCount=toscalar(ROLEStoRISKS | count);\r\nROLEStoRISKS | project BP, Risk, Role=AGR_NAME, Severity | order by Severity asc;",
                    "size": 0,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "table",
                    "gridSettings": {
                      "rowLimit": 9999
                    },
                    "sortBy": [],
                    "chartSettings": {
                      "xAxis": "Severity",
                      "yAxis": [
                        "SummaryPcent"
                      ],
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 1,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "40",
                  "name": "Report 2 – Summary of Risks by Roles (Grid)",
                  "styleSettings": {
                    "maxWidth": "40"
                  }
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "p_System",
              "comparison": "isNotEqualTo"
            },
            "name": "SOD Report 2"
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "p_System",
          "comparison": "isNotEqualTo"
        },
        {
          "parameterName": "p_Client",
          "comparison": "isNotEqualTo"
        }
      ],
      "name": "SOD Report"
    }
  ],
  "fallbackResourceIds": [],
  "fromTemplateId": "sentinel-UserWorkbook",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
