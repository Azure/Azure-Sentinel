id: 2b7f9e4e-6c3a-4c8f-9b1d-1a2f3e4c5d6b
name: AWS Security Hub - EC2 instances with public IPv4 address
description: |
  This query finds EC2 instances that have a public IPv4 address using AWS Security Hub findings (control EC2.9).
description-detailed: |
  This query can be used to identify EC2 instances that have a public IPv4 address, using AWS Security Hub findings (control EC2.9).
  Public exposure increases attack surface and can enable unauthorized access, lateral movement, or data exfiltration if the instance is misconfigured or vulnerable.
requiredDataConnectors:
  - connectorId: AWSSecurityHub
    dataTypes:
      - AWSSecurityHubFindings
tactics:
  - InitialAccess
  - Exfiltration
relevantTechniques:
  - T1133
  - T1021
query: |
  AWSSecurityHubFindings
  | where RecordState == "ACTIVE" and ComplianceStatus == "FAILED"
  | where AwsSecurityFindingGeneratorId == "security-control/EC2.9" or ComplianceSecurityControlId == "EC2.9"
  | mv-expand Resource = Resources
  | where tostring(Resource.Type) == "AwsEc2Instance"
  | extend InstanceArn = tostring(Resource.Id)
  | extend Details = Resource.Details.AwsEc2Instance
  | project TimeGenerated,
            AwsAccountId,
            AwsRegion,
            InstanceArn,
            AwsSecurityFindingId,
            AwsSecurityFindingTitle,
            AwsSecurityFindingDescription,
            ComplianceSecurityControlId,
            ImageId = tostring(Details.ImageId),
            VpcId = tostring(Details.VpcId), SubnetId = tostring(Details.SubnetId),
            InstanceProfile = tostring(Details.IamInstanceProfileArn)
  | order by TimeGenerated desc
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: CloudAppAccountId
        columnName: AwsAccountId
version: 1.0.0
