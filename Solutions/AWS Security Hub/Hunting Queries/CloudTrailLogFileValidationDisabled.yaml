id: e40c3c7d-0b6d-4f2d-90a4-4d9d77c2e3f5
name: AWS Security Hub - CloudTrail trails without log file validation
description: |
  This query finds CloudTrail trails with log file validation disabled using AWS Security Hub findings.
description-detailed: |
  This query can be used to identify CloudTrail trails that do not have log file validation enabled.
  Without CloudTrail log file validation, a threat actor who gains access to logging storage could tamper with or delete log files to obscure malicious actions
  (e.g., privilege escalation, lateral movement, data exfiltration) without reliable detection. Enabling validation provides cryptographic integrity checks
  that increase evidentiary value of logs during incident response and forensics.
requiredDataConnectors:
  - connectorId: AWSSecurityHub
    dataTypes:
      - AWSSecurityHubFindings
tactics:
  - DefenseEvasion
relevantTechniques:
  - T1070.004  
  - T1562.001  
tags:
  - CIS AWS Foundations Benchmark v1.4.0
  - NIST 800-53 r5
  - PCI DSS v3.2.1
query: |
  AWSSecurityHubFindings
  | where RecordState == "ACTIVE" and ComplianceStatus == "FAILED"
  | where AwsSecurityFindingGeneratorId == "security-control/CloudTrail.4"
     or ComplianceSecurityControlId == "CloudTrail.4"
  | mv-expand Resource = Resources
  | where tostring(Resource.Type) == "AwsCloudTrailTrail"
  | extend TrailId = tostring(Resource.Id)
  | summarize TimeGenerated = max(TimeGenerated) by 
      AwsAccountId,
      AwsRegion,
      TrailId,
      AwsSecurityFindingId
  | extend TrailName = tostring(split(TrailId, "/")[1])
  | order by TimeGenerated desc
entityMappings:
  - entityType: CloudApplication
    fieldMappings:
      - identifier: Name
        columnName: TrailId
version: 1.0.0
