id: d5818873-a2ab-4467-8e97-60fe56ca10cc
name: AWS Security Hub - IAM users with console password and no MFA
description: |
  This query identifies IAM users in AWS Security Hub findings (control IAM.5) who have a console password but do not have multi-factor authentication (MFA) enabled.
description-detailed: |
  This query identifies IAM users in AWS Security Hub findings (control IAM.5) who have a console password but multi-factor authentication (MFA) is disabled. 
  This may be an indicator of adversary activity of account compromise, privilege escalation, or misconfiguration.
requiredDataConnectors:
  - connectorId: AWSSecurityHub
    dataTypes:
      - AWSSecurityHubFindings
tactics:
  - PrivilegeEscalation
  - CredentialAccess
  - DefenseEvasion
relevantTechniques:
  - T1098
  - T1110
  - T1556.006
tags:
  - PCI DSS v3.2.1
  - NIST 800-53 r5
  - CIS AWS Foundations Benchmark v1.4.0
query: |
  AWSSecurityHubFindings
  | where RecordState == "ACTIVE" and ComplianceStatus == "FAILED"
  | where AwsSecurityFindingGeneratorId == "security-control/IAM.5"
    or ComplianceSecurityControlId == "IAM.5"
  | mv-expand Resource = Resources
  | where tostring(Resource.Type) == "AwsIamUser"
  | extend
      UserName = tostring(Resource.Details.AwsIamUser.UserName),
      UserId = tostring(Resource.Details.AwsIamUser.UserId),
      UserARN = tostring(Resource.Id),
      AttachedPolicies = Resource.Details.AwsIamUser.AttachedManagedPolicies
  | extend HasAdminAccess = iif(array_length(AttachedPolicies) > 0 and (AttachedPolicies has_cs "AdministratorAccess"), true, false)
  | summarize TimeGenerated = max(TimeGenerated) by 
    AwsAccountId,
    AwsRegion,
    UserName,
    UserARN,
    UserId,
    HasAdminAccess,
    AwsSecurityFindingId,
    AwsSecurityFindingTitle,
    AwsSecurityFindingDescription
  | order by TimeGenerated
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: UserName
      - identifier: CloudAppAccountId
        columnName: UserARN
version: 1.0.0
