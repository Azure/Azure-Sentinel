{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "CTERA Networks - support@ctera.com",
    "comments": "Solution template for CTERA"
  },
  "parameters": {
		"location": {
		  "type": "string",
		  "minLength": 1,
		  "defaultValue": "[resourceGroup().location]",
		  "metadata": {
			"description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
		  }
		},
		"workspace-location": {
		  "type": "string",
		  "defaultValue": "",
		  "metadata": {
			"description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
		  }
		},
		"workspace": {
		  "defaultValue": "",
		  "type": "string",
		  "metadata": {
			"description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
		  }
		},
		"workbook1-name": {
		  "type": "string",
		  "defaultValue": "Linux machines",
		  "minLength": 1,
		  "metadata": {
			"description": "Name for the workbook"
		  }
		}
	},
  "variables": {
    "solutionName": "CTERA",
    "_solutionName": "[variables('solutionName')]",
    "solutionVersion": "1.0.0",
    "_solutionVersion": "[variables('solutionVersion')]",
    "solutionId": "ctera.solution",
    "_solutionId": "[variables('solutionId')]",
    "analyticRuleVersion1": "1.0.0",
    "analyticRulecontentId1": "d5d4766b-e547-44da-9d85-48ff393db201",
    "_analyticRulecontentId1": "[variables('analyticRulecontentId1')]",
	"analyticRuleVersion2": "1.0.0",
	"analyticRulecontentId2": "7a075edf-1cf2-4038-ba9c-c354db6409de",
    "_analyticRulecontentId2": "[variables('analyticRulecontentId2')]",
	"huntingQueryVersion": "1.0.0",
    "huntingQueryId": "694ce74e-968b-4ca0-ae24-53bcfd87bf0a",
    "_huntingQueryId": "[variables('huntingQueryId')]",
	"huntingQueryVersion": "1.0.0",
    "huntingQueryId": "694ce74e-968b-4ca0-ae24-53bcfd87bf0a",
    "_huntingQueryId": "[variables('huntingQueryId')]",
	"huntingQueryVersion": "1.0.0",
    "huntingQueryId2": "23206903-0c36-4d68-ba4b-169c67355b53",
    "_huntingQueryId2": "[variables('huntingQueryId2')]",
	"workbookVersion": "1.0.0",
    "workbookId": "[concat(parameters('workspaceName'), '/workbooks/CTERAWB')]",
    "_workbookId": "[variables('workbookId')]"
  },
  "resources": [
		{
		  "type": "Microsoft.SecurityInsights/alertRules",
		  "apiVersion": "2021-09-01-preview",
		  "name": "[variables('_analyticRulecontentId1')]",
		  "location": "[parameters('location')]",
		  "properties": {
			"alertRuleTemplateName": "[variables('_solutionName')] Ransom Protect User Blocked",
			"description": "Detects malicious users blocked by CTERA Ransom Protect AI engine.",
			"severity": "High",
			"enabled": true,
			"query": "Syslog\n| where SyslogMessage contains \"[com.ctera.db.jpa.log.RansomLogEntityListener] - Ransom Protect mechanism blocked\"\n| extend \n    Portal = extract(\"portal:(\\\\w+)\", 1, SyslogMessage),\n    EdgeFiler = extract(\"Edge Filer:(\\\\w+-\\\\d+)\", 1, SyslogMessage),\n    IP = extract(\"IP:([0-9.]+)\", 1, SyslogMessage),\n    User = extract(\"user:(\\\\w+)\", 1, SyslogMessage),\n    BlockedTime = extract(\"at ([^ ]+)\", 1, SyslogMessage)\n| project TimeGenerated, Portal, EdgeFiler, IP, User, BlockedTime",
			"queryFrequency": "PT5M",
			"queryPeriod": "PT5M",
			"triggerOperator": "GreaterThan",
			"triggerThreshold": 0,
			"tactics": [
			  "Impact"
			],
			"techniques": [
			  "T1486"
			],
			"incidentConfiguration": {
			  "createIncident": true,
			  "groupingConfiguration": {
				"enabled": false,
				"reopenClosedIncident": false,
				"lookbackDuration": "PT5H",
				"matchingMethod": "AllEntities"
			  }
			},
			"eventGroupingSettings": {
			  "aggregationKind": "SingleAlert"
			},
			"alertDetailsOverride": {
			  "alertnameFormat": "[variables('_solutionName')] Ransom Protect User Blocked",
			  "alertDescriptionFormat": "[variables('_solutionName')] Ransom Protect blocked a malicious user at {{TimeGenerated}}."
			},
			"customDetails": {
			  "EdgeFiler": "EdgeFiler"
			},
			"entityMappings": [
			  {
				"entityType": "User",
				"fieldMappings": [
				  {
					"identifier": "Name",
					"columnName": "User"
				  }
				]
			  },
			  {
				"entityType": "IP",
				"fieldMappings": [
				  {
					"identifier": "Address",
					"columnName": "IP"
				  }
				]
			  }
			],
			"suppressionDuration": "PT5H",
			"suppressionEnabled": false
		  }
		},
		{
		  "type": "Microsoft.SecurityInsights/alertRules",
		  "apiVersion": "2021-09-01-preview",
		  "name": "[variables('_analyticRulecontentId2')]",
		  "location": "[parameters('location')]",
		  "properties": {
			"alertRuleTemplateName": "[variables('_solutionName')] Ransom Protect Detected a Ransomware Attack",
			"description": "This analytics rule monitors CTERA platform to detect potential ransomware attacks detected by CTERA Ransom Protect AI engine. Once detected the following information will be exposed: Virtual portal, Edge Filer, IP, User, Incident Type, Start and end time.",
			"severity": "High",
			"enabled": true,
			"queryFrequency": "PT5M",
			"queryPeriod": "PT5M",
			"triggerOperator": "GreaterThan",
			"triggerThreshold": 0,
			"query": "Syslog\n| where SyslogMessage contains \"[com.ctera.db.jpa.log.RansomLogEntityListener] - Ransomware incident detected\"\n| extend \n    Portal = extract(\"portal:(\\\\w+)\", 1, SyslogMessage),\n    EdgeFiler = extract(\"Edge Filer:(\\\\w+-\\\\d+)\", 1, SyslogMessage),\n    IP = extract(\"\\\\(IP:([0-9.]+)\\\\)\", 1, SyslogMessage),\n    User = extract(\"user:(\\\\w+)\", 1, SyslogMessage),\n    IncidentType = extract(\"Incident type:(\\\\w+)\", 1, SyslogMessage),\n    StartTime = extract(\"started at \\"([^\"]+)\\"\", 1, SyslogMessage),\n    EndTime = extract(\"ended at \\"([^\"]+)\\"\", 1, SyslogMessage)\n| project TimeGenerated, Portal, EdgeFiler, IP, User, IncidentType, StartTime, EndTime",

			"tactics": [
			  "Impact"
			],
			"techniques": [
			  "T1486"
			],
			"incidentConfiguration": {
			  "createIncident": true,
			  "groupingConfiguration": {
				"enabled": false,
				"reopenClosedIncident": false,
				"lookbackDuration": "PT5H",
				"matchingMethod": "AllEntities"
			  }
			},
			"eventGroupingSettings": {
			  "aggregationKind": "SingleAlert"
			},
			"alertDetailsOverride": {
			  "alertnameFormat": "[variables('_solutionName')] Ransom Protect Detected a Ransomware Attack",
			  "alertDescriptionFormat": "[variables('_solutionName')] Ransom Protect Detected a Ransomware Attack at {{TimeGenerated}}."
			},
			"customDetails": {
			  "EdgeFiler": "EdgeFiler"
			},
			"entityMappings": [
			  {
				"entityType": "Engine",
				"fieldMappings": [
				  {
					"identifier": "Type",
					"columnName": "IncidentType"
				  }
				]
			  }
			],
			"suppressionDuration": "PT5H",
			"suppressionEnabled": false
		  }
		},
		{
		  "type": "Microsoft.OperationalInsights/workspaces/queries",
		  "apiVersion": "2019-08-01",
		  "name": "[variables('_huntingQueryId')]",
		  "location": "[parameters('location')]",
		  "properties": {
			"displayName": "CTERA Mass Permission Change Detection",
			"description": "This query detects permission changes generated by the CTERA Edge Filer.",
			"query": "Syslog\n    | where ProcessName == 'gw-audit'\n    | extend\n        TenantName = extract(\"\\\"vportal\\\":\\\"([^\\\"]*)\\\"\", 1, SyslogMessage),\n        UserName = extract(\"user=([^|]*)\", 1, SyslogMessage),\n        Operation = extract(\"op=([^|]*)\", 1, SyslogMessage),\n        EdgeFiler = extract(\"\\\"client\\\":\\\"([^\\\"]*)\\\"\", 1, SyslogMessage),\n        RootPath = extract(\"rootPath=([^|]*)\", 1, SyslogMessage),\n        Share = extract(\"share=([^|]*)\", 1, SyslogMessage),\n        LocalPath = extract(\"path=([^|]*)\", 1, SyslogMessage),\n        Timestamp = todatetime(extract(\"\\\"@timestamp\\\":\\\"([^\\\"]*)\\\"\", 1, SyslogMessage))\n    | where Operation in ('ACLAdded', 'ACLDeleted', 'ACLProtectionAdded', 'ACLProtectionDeleted', 'ACEChanged', 'setdacl')\n    | summarize Count = count() by UserName, bin(Timestamp, 2m)\n    | where Count > 10",
			"version": "[variables('huntingQueryVersion')]",
			"tags": {
			  "tactics": [
				"Privilege Escalation"
			  ],
			  "techniques": [
				"T1068"
			  ]
			},
			"requiredDataConnectors": [
			  {
				"connectorId": "CTERA",
				"dataTypes": [
				  "Syslog"
				]
			  }
			],
			"entityMappings": [
			  {
				"entityType": "EdgeFiler",
				"fieldMappings": [
				  {
					"identifier": "Name",
					"columnName": "EdgeFiler_Name"
				  }
				]
			  },
			  {
				"entityType": "UserName",
				"fieldMappings": [
				  {
					"identifier": "Name",
					"columnName": "User Name"
				  }
				]
			  },
			  {
				"entityType": "Share",
				"fieldMappings": [
				  {
					"identifier": "Name",
					"columnName": "ShareName"
				  }
				]
			  },
			  {
				"entityType": "LocalPath",
				"fieldMappings": [
				  {
					"identifier": "fileName",
					"columnName": "filename"
				  },
				  {
					"identifier": "Directory",
					"columnName": "directorypath"
				  }
				]
			  }
			]
		  }
		},
		{
		  "type": "Microsoft.OperationalInsights/workspaces/queries",
		  "apiVersion": "2019-08-01",
		  "name": "[variables('_huntingQueryId')]",
		  "location": "[parameters('location')]",
		  "properties": {
			"displayName": "CTERA Mass Permission Change Detection",
			"description": "This query detects permission changes generated by the CTERA Edge Filer.",
			"query": "Syslog\n    | where ProcessName == 'gw-audit'\n    | extend\n        TenantName = extract(\"\\\"vportal\\\":\\\"([^\\\"]*)\\\"\", 1, SyslogMessage),\n        UserName = extract(\"user=([^|]*)\", 1, SyslogMessage),\n        Operation = extract(\"op=([^|]*)\", 1, SyslogMessage),\n        EdgeFiler = extract(\"\\\"client\\\":\\\"([^\\\"]*)\\\"\", 1, SyslogMessage),\n        RootPath = extract(\"rootPath=([^|]*)\", 1, SyslogMessage),\n        Share = extract(\"share=([^|]*)\", 1, SyslogMessage),\n        LocalPath = extract(\"path=([^|]*)\", 1, SyslogMessage),\n        Timestamp = todatetime(extract(\"\\\"@timestamp\\\":\\\"([^\\\"]*)\\\"\", 1, SyslogMessage))\n    | where Operation in ('ACLAdded', 'ACLDeleted', 'ACLProtectionAdded', 'ACLProtectionDeleted', 'ACEChanged', 'setdacl')\n    | summarize Count = count() by UserName, bin(Timestamp, 2m)\n    | where Count > 10",
			"version": "[variables('huntingQueryVersion')]",
			"tags": {
			  "tactics": [
				"Privilege Escalation"
			  ],
			  "techniques": [
				"T1068"
			  ]
			},
			"requiredDataConnectors": [
			  {
				"connectorId": "CTERA",
				"dataTypes": [
				  "Syslog"
				]
			  }
			],
			"entityMappings": [
			  {
				"entityType": "EdgeFiler",
				"fieldMappings": [
				  {
					"identifier": "Name",
					"columnName": "EdgeFiler_Name"
				  }
				]
			  },
			  {
				"entityType": "UserName",
				"fieldMappings": [
				  {
					"identifier": "Name",
					"columnName": "User Name"
				  }
				]
			  },
			  {
				"entityType": "Share",
				"fieldMappings": [
				  {
					"identifier": "Name",
					"columnName": "ShareName"
				  }
				]
			  },
			  {
				"entityType": "LocalPath",
				"fieldMappings": [
				  {
					"identifier": "fileName",
					"columnName": "filename"
				  },
				  {
					"identifier": "Directory",
					"columnName": "directorypath"
				  }
				]
			  }
			]
		  }
		},
		  {
		  "type": "Microsoft.OperationalInsights/workspaces/queries",
		  "apiVersion": "2019-08-01",
		  "name": "[variables('_huntingQueryId2')]",
		  "location": "[parameters('location')]",
		  "properties": {
			"displayName": "CTERA Mass File Deletions Detection",
			"description": "This query detects file deletions generated by the CTERA Edge Filer.",
			"query": "Syslog\n    | where ProcessName == 'gw-audit'\n    | extend\n        TenantName = extract(\"\\\"vportal\\\":\\\"([^\\\"]*)\\\"\", 1, SyslogMessage),\n        UserName = extract(\"user=([^|]*)\", 1, SyslogMessage),\n        Permission = extract(\"op=([^|]*)\", 1, SyslogMessage),\n        EdgeFiler = extract(\"\\\"client\\\":\\\"([^\\\"]*)\\\"\", 1, SyslogMessage),\n        RootPath = extract(\"rootPath=([^|]*)\", 1, SyslogMessage),\n        Share = extract(\"share=([^|]*)\", 1, SyslogMessage),\n        LocalPath = extract(\"path=([^|]*)\", 1, SyslogMessage),\n        Timestamp = todatetime(extract(\"\\\"@timestamp\\\":\\\"([^\\\"]*)\\\"\", 1, SyslogMessage))\n    | where Permission == 'delete'\n    | summarize Count = count() by UserName, bin(Timestamp, 2m)\n    | where Count > 10",
			"version": "[variables('huntingQueryVersion')]",
			"tags": {
			  "tactics": [
				"Impact"
			  ],
			  "techniques": [
				"T1485"
			  ]
			},
			"requiredDataConnectors": [
			  {
				"connectorId": "CTERA",
				"dataTypes": [
				  "Syslog"
				]
			  }
			],
			"entityMappings": [
			  {
				"entityType": "EdgeFiler",
				"fieldMappings": [
				  {
					"identifier": "Name",
					"columnName": "EdgeFiler_Name"
				  }
				]
			  },
			  {
				"entityType": "UserName",
				"fieldMappings": [
				  {
					"identifier": "Name",
					"columnName": "User Name"
				  }
				]
			  },
			  {
				"entityType": "Share",
				"fieldMappings": [
				  {
					"identifier": "Name",
					"columnName": "ShareName"
				  }
				]
			  },
			  {
				"entityType": "LocalPath",
				"fieldMappings": [
				  {
					"identifier": "fileName",
					"columnName": "filename"
				  },
				  {
					"identifier": "Directory",
					"columnName": "directorypath"
				  }
				]
			  }
			]
		  }
		},
		{
		  "type": "microsoft.insights/workbooks",
		  "apiVersion": "2020-10-01",
		  "name": "[variables('_workbookId')]",
		  "location": "[parameters('location')]",
		  "properties": {
			"displayName": "CTERA Workbook",
			"serializedData": "{version":"Notebook/1.0","items":[{"type":1,"content":{"json":"Welcome to your CTERA workbook.  This area will display relevant graphs and metrics for the CTERA workspace.\n\n\nWe've included relevant graphs of your SMB audit logs collected from the selected filers."},"name":"text - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"\tSyslog\r\n\t| where ProcessName == 'gw-audit'\r\n\t| extend\r\n\t   TenantName = extract(\"(\\\"vportal\\\":\\\"[^\\\"]*\\\")\", 1, SyslogMessage),\r\n\t   UserName = extract(\"(user=[^|]*)\", 1, SyslogMessage)\r\n\t| extend Permission = extract(\"(op=[^|]*)\", 1, SyslogMessage)\r\n    | where Permission matches regex @\"(?i).*denied.*\" or Permission == \"op=delete\" // Regex pattern to filter denied operations\r\n    | summarize Count = count() by Permission","size":1,"timeContext":{"durationMs":2592000000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"areachart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Permission","formatter":1},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"name":"query - 5"},{"type":3,"content":{"version":"KqlItem/1.0","query":"\t\r\n\tSyslog\r\n\t| where ProcessName == 'gw-audit'\r\n\t| extend user = extract(\"user=([^|]*)\", 1, SyslogMessage)\r\n\t| extend operation = extract(\"op=([^|]*)\", 1, SyslogMessage)\r\n    | where operation matches regex @\"(?i).*denied.*\" or operation == \"op=delete\"\r\n\t| summarize operation_count=count() by bin(TimeGenerated, 1m), user\r\n\t| project TimeGenerated, user, operation_count\r\n","size":0,"timeContext":{"durationMs":2592000000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"linechart"},"name":"query - 4"},{"type":3,"content":{"version":"KqlItem/1.0","query":"\tSyslog\r\n\t| where SyslogMessage contains \"ctera_audit\" and SyslogMessage contains \"op=delete\"\r\n\t| extend user = extract(\"user=([^|]*)\", 1, SyslogMessage)\r\n\t| extend timestamp = extract(\"timestamp=([^|]*)\", 1, SyslogMessage)\r\n\t| extend TimeGenerated = todatetime(timestamp)\r\n\t| summarize deletion_count = count() by bin(TimeGenerated, 1m), user\r\n\t| where deletion_count > 1\r\n| project TimeGenerated, user, deletion_count","size":1,"timeContext":{"durationMs":2592000000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"name":"query - 2"}],"fallbackResourceIds":["/subscriptions/0dfe0fcb-a5a0-4b3b-898d-31c327799113/resourcegroups/product-robert/providers/microsoft.operationalinsights/workspaces/robertsentinel2"],"fromTemplateId":"sentinel-UserWorkbook","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"},
			"version": "[variables('workbookVersion')]",
			"category": "workbook"
		}
	]
}