id: 694ce74e-968b-4ca0-ae24-53bcfd87bf0a
name: CTERA Mass Permission Change Detection
description:  'This query detects permission changes generated by the CTERA Edge Filer.'
requiredDataConnectors:
  - connectorId: CTERA
    dataTypes:
    - Syslog
tactics:
  - Privilege Escalation 
relevantTechniques:
  - T1068 
query: |
    Syslog
    | where ProcessName == 'gw-audit'
    | extend
        TenantName = extract("\"vportal\":\"([^\"]*)\"", 1, SyslogMessage),
        UserName = extract("user=([^|]*)", 1, SyslogMessage),
        Operation = extract("op=([^|]*)", 1, SyslogMessage),
        EdgeFiler = extract("\"client\":\"([^\"]*)\"", 1, SyslogMessage),
        RootPath = extract("rootPath=([^|]*)", 1, SyslogMessage),
        Share = extract("share=([^|]*)", 1, SyslogMessage),
        LocalPath = extract("path=([^|]*)", 1, SyslogMessage),
        Timestamp = todatetime(extract("\"@timestamp\":\"([^\"]*)\"", 1, SyslogMessage))
    | where Operation in ('ACLAdded', 'ACLDeleted', 'ACLProtectionAdded', 'ACLProtectionDeleted', 'ACEChanged', 'setdacl')
    | summarize Count = count() by UserName, bin(Timestamp, 2m)
    | where Count > 10
entityMappings:
  - entityType: EdgeFiler
    fieldMappings:
      - identifier: Name
        columnName: EdgeFiler_Name
  - entityType: UserName
    fieldMappings:
      - identifier: Name
        columnName: User Name
  - entityType: Share
    fieldMappings:
      - identifier: Name
        columnName: ShareName
  - entityType: LocalPath
    fieldMappings:
      - identifier: fileName
        columnName: filename
      - identifier: Directory
        columnName: directorypath
version: 1.0.0