[
  {
    "name": "dcr-tacitred-findings",
    "apiVersion": "2024-03-11",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "{{location}}",
    "properties": {
      "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
      "streamDeclarations": {
        "Custom-TacitRed_Findings_Raw": {
          "columns": [
            { "name": "finding", "type": "dynamic" },
            { "name": "severity", "type": "string" }
          ]
        }
      },
      "destinations": {
        "logAnalytics": [
          {
            "workspaceResourceId": "{{workspaceResourceId}}",
            "name": "clv2ws1"
          }
        ]
      },
      "dataFlows": [
        {
          "streams": [ "Custom-TacitRed_Findings_Raw" ],
          "destinations": [ "clv2ws1" ],
          "transformKql": "source | extend f = todynamic(finding) | extend TimeGenerated = todatetime(f['supporting_data']['date_compromised']), email_s = tostring(f['supporting_data']['credential']), domain_s = tostring(f['supporting_data']['domain']), findingType_s = tostring(f['types'][0]), confidence_d = toint(50), firstSeen_t = todatetime(f['supporting_data']['date_compromised']), lastSeen_t = todatetime(f['supporting_data']['date_compromised']), notes_s = tostring(f['title']), source_s = tostring(f['supporting_data']['stealer']), severity_s = tostring(f['supporting_data']['subtype']), status_s = tostring(f['supporting_data']['subtype']), campaign_id_s = tostring(f['supporting_data']['stealer']), user_id_s = tostring(f['supporting_data']['machine_id']), username_s = tostring(f['supporting_data']['machine_name']), detection_ts_t = todatetime(f['supporting_data']['date_compromised']), metadata_s = tostring(f) | project TimeGenerated, email_s, domain_s, findingType_s, confidence_d, firstSeen_t, lastSeen_t, notes_s, source_s, severity_s, status_s, campaign_id_s, user_id_s, username_s, detection_ts_t, metadata_s",
          "outputStream": "Custom-TacitRed_Findings_CL"
        }
      ]
    }
  }
]
