[
  {
    "name": "dcr-tacitred-findings",
    "apiVersion": "2024-03-11",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "{{location}}",
    "properties": {
      "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
      "streamDeclarations": {
        "Custom-TacitRed_Findings_Raw": {
          "columns": [
            { "name": "finding", "type": "dynamic" },
            { "name": "severity", "type": "string" }
          ]
        },
        "Custom-TacitRed_Findings_CL": {
          "columns": [
            { "name": "TimeGenerated", "type": "datetime" },
            { "name": "email_s", "type": "string" },
            { "name": "domain_s", "type": "string" },
            { "name": "findingType_s", "type": "string" },
            { "name": "confidence_d", "type": "int" },
            { "name": "firstSeen_t", "type": "datetime" },
            { "name": "lastSeen_t", "type": "datetime" },
            { "name": "notes_s", "type": "string" },
            { "name": "source_s", "type": "string" },
            { "name": "severity_s", "type": "string" },
            { "name": "status_s", "type": "string" },
            { "name": "campaign_id_s", "type": "string" },
            { "name": "user_id_s", "type": "string" },
            { "name": "username_s", "type": "string" },
            { "name": "detection_ts_t", "type": "datetime" },
            { "name": "metadata_s", "type": "string" }
          ]
        }
      },
      "destinations": {
        "logAnalytics": [
          {
            "workspaceResourceId": "{{workspaceResourceId}}",
            "name": "clv2ws1"
          }
        ]
      },
      "dataFlows": [
        {
          "streams": [ "Custom-TacitRed_Findings_Raw" ],
          "destinations": [ "clv2ws1" ],
          "transformKql": "source | extend p = parse_json(finding) | extend s = p.supporting_data | extend TimeGenerated = datetime(null) | project TimeGenerated, email_s=tostring(s.credential), domain_s=tostring(s.domain), findingType_s='credential', confidence_d=int(75), firstSeen_t=TimeGenerated, lastSeen_t=TimeGenerated, notes_s='test', source_s='test', severity_s=tostring(severity), status_s='test', campaign_id_s='test', user_id_s='test', username_s='test', detection_ts_t=TimeGenerated, metadata_s=tostring(finding)",
          "outputStream": "Custom-TacitRed_Findings_CL"
        }
      ]
    }
  }
]
