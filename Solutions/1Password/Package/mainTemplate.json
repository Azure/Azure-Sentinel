{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Rogier Dijkman (SecureHats)",
    "comments": "Solution template for 1Password"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is setup"
      }
    },
    "subscription": {
      "type": "string",
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "1Password Events Workbook",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "_solutionName": "1Password",
    "_solutionVersion": "3.0.2",
    "solutionId": "1password1617200969773.azure-sentinel-solution-1password",
    "_solutionId": "[variables('solutionId')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "dataConnectorCCPVersion": "1.0.0",
    "_dataConnectorContentIdConnectorDefinition1": "1PasswordCCPDefinition",
    "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
    "_dataConnectorContentIdConnections1": "1PasswordCCPDefinitionConnections",
    "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
    "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
    "blanks": "[replace('b', 'b', '')]",
    "uiConfigId2": "1Password",
    "_uiConfigId2": "[variables('uiConfigId2')]",
    "dataConnectorContentId2": "1Password",
    "_dataConnectorContentId2": "[variables('dataConnectorContentId2')]",
    "dataConnectorId2": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId2'))]",
    "_dataConnectorId2": "[variables('dataConnectorId2')]",
    "dataConnectorTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId2'))))]",
    "dataConnectorVersion2": "1.0.0",
    "_dataConnectorcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentId2'),'-', variables('dataConnectorVersion2'))))]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "1PasswordWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "analyticRuleObject1": {
      "analyticRuleVersion1": "1.0.0",
      "_analyticRulecontentId1": "54e6bb8e-2935-422f-9387-dba1961abfd7",
      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '54e6bb8e-2935-422f-9387-dba1961abfd7')]",
      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('54e6bb8e-2935-422f-9387-dba1961abfd7')))]",
      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','54e6bb8e-2935-422f-9387-dba1961abfd7','-', '1.0.0')))]"
    },
    "analyticRuleObject2": {
      "analyticRuleVersion2": "1.0.1",
      "_analyticRulecontentId2": "9406f5ab-1197-4db9-8042-9f3345be061c",
      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '9406f5ab-1197-4db9-8042-9f3345be061c')]",
      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('9406f5ab-1197-4db9-8042-9f3345be061c')))]",
      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','9406f5ab-1197-4db9-8042-9f3345be061c','-', '1.0.1')))]"
    },
    "analyticRuleObject3": {
      "analyticRuleVersion3": "1.0.0",
      "_analyticRulecontentId3": "92ab0938-1e7c-4671-9810-392e8b9714da",
      "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '92ab0938-1e7c-4671-9810-392e8b9714da')]",
      "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('92ab0938-1e7c-4671-9810-392e8b9714da')))]",
      "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','92ab0938-1e7c-4671-9810-392e8b9714da','-', '1.0.0')))]"
    },
    "analyticRuleObject4": {
      "analyticRuleVersion4": "1.0.0",
      "_analyticRulecontentId4": "bf9132c7-9d4d-4244-98c7-7d994703c208",
      "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'bf9132c7-9d4d-4244-98c7-7d994703c208')]",
      "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('bf9132c7-9d4d-4244-98c7-7d994703c208')))]",
      "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','bf9132c7-9d4d-4244-98c7-7d994703c208','-', '1.0.0')))]"
    },
    "analyticRuleObject5": {
      "analyticRuleVersion5": "1.0.0",
      "_analyticRulecontentId5": "9a264487-bcb8-4c7f-a461-b289a46377b8",
      "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '9a264487-bcb8-4c7f-a461-b289a46377b8')]",
      "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('9a264487-bcb8-4c7f-a461-b289a46377b8')))]",
      "_analyticRulecontentProductId5": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','9a264487-bcb8-4c7f-a461-b289a46377b8','-', '1.0.0')))]"
    },
    "analyticRuleObject6": {
      "analyticRuleVersion6": "1.0.0",
      "_analyticRulecontentId6": "26daed54-cea5-469c-9b6e-0d85a40dc463",
      "analyticRuleId6": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '26daed54-cea5-469c-9b6e-0d85a40dc463')]",
      "analyticRuleTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('26daed54-cea5-469c-9b6e-0d85a40dc463')))]",
      "_analyticRulecontentProductId6": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','26daed54-cea5-469c-9b6e-0d85a40dc463','-', '1.0.0')))]"
    },
    "analyticRuleObject7": {
      "analyticRuleVersion7": "1.0.0",
      "_analyticRulecontentId7": "327e0579-7c03-4ec7-acf5-a29dcc4a12b6",
      "analyticRuleId7": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '327e0579-7c03-4ec7-acf5-a29dcc4a12b6')]",
      "analyticRuleTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('327e0579-7c03-4ec7-acf5-a29dcc4a12b6')))]",
      "_analyticRulecontentProductId7": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','327e0579-7c03-4ec7-acf5-a29dcc4a12b6','-', '1.0.0')))]"
    },
    "analyticRuleObject8": {
      "analyticRuleVersion8": "1.0.0",
      "_analyticRulecontentId8": "398a1cf1-f56f-4700-912c-9bf4c8409ebc",
      "analyticRuleId8": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '398a1cf1-f56f-4700-912c-9bf4c8409ebc')]",
      "analyticRuleTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('398a1cf1-f56f-4700-912c-9bf4c8409ebc')))]",
      "_analyticRulecontentProductId8": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','398a1cf1-f56f-4700-912c-9bf4c8409ebc','-', '1.0.0')))]"
    },
    "analyticRuleObject9": {
      "analyticRuleVersion9": "1.0.0",
      "_analyticRulecontentId9": "a00ffbd8-1d1c-47a3-b0a6-7d70bd8017ed",
      "analyticRuleId9": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'a00ffbd8-1d1c-47a3-b0a6-7d70bd8017ed')]",
      "analyticRuleTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('a00ffbd8-1d1c-47a3-b0a6-7d70bd8017ed')))]",
      "_analyticRulecontentProductId9": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','a00ffbd8-1d1c-47a3-b0a6-7d70bd8017ed','-', '1.0.0')))]"
    },
    "analyticRuleObject10": {
      "analyticRuleVersion10": "1.0.0",
      "_analyticRulecontentId10": "76e386eb-f51a-4600-97d1-f0db3b7e41f1",
      "analyticRuleId10": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '76e386eb-f51a-4600-97d1-f0db3b7e41f1')]",
      "analyticRuleTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('76e386eb-f51a-4600-97d1-f0db3b7e41f1')))]",
      "_analyticRulecontentProductId10": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','76e386eb-f51a-4600-97d1-f0db3b7e41f1','-', '1.0.0')))]"
    },
    "analyticRuleObject11": {
      "analyticRuleVersion11": "1.0.0",
      "_analyticRulecontentId11": "6711b747-16d7-4df4-9f61-8633617f45d7",
      "analyticRuleId11": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '6711b747-16d7-4df4-9f61-8633617f45d7')]",
      "analyticRuleTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('6711b747-16d7-4df4-9f61-8633617f45d7')))]",
      "_analyticRulecontentProductId11": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','6711b747-16d7-4df4-9f61-8633617f45d7','-', '1.0.0')))]"
    },
    "analyticRuleObject12": {
      "analyticRuleVersion12": "1.0.0",
      "_analyticRulecontentId12": "d54a3cf9-6169-449c-83f1-e7def3359702",
      "analyticRuleId12": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'd54a3cf9-6169-449c-83f1-e7def3359702')]",
      "analyticRuleTemplateSpecName12": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('d54a3cf9-6169-449c-83f1-e7def3359702')))]",
      "_analyticRulecontentProductId12": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','d54a3cf9-6169-449c-83f1-e7def3359702','-', '1.0.0')))]"
    },
    "analyticRuleObject13": {
      "analyticRuleVersion13": "1.0.0",
      "_analyticRulecontentId13": "ceb20a5c-adce-4eba-9728-541361d47d87",
      "analyticRuleId13": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'ceb20a5c-adce-4eba-9728-541361d47d87')]",
      "analyticRuleTemplateSpecName13": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('ceb20a5c-adce-4eba-9728-541361d47d87')))]",
      "_analyticRulecontentProductId13": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','ceb20a5c-adce-4eba-9728-541361d47d87','-', '1.0.0')))]"
    },
    "analyticRuleObject14": {
      "analyticRuleVersion14": "1.0.0",
      "_analyticRulecontentId14": "3c8140eb-e946-4bf2-8c61-03e4df56d400",
      "analyticRuleId14": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '3c8140eb-e946-4bf2-8c61-03e4df56d400')]",
      "analyticRuleTemplateSpecName14": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('3c8140eb-e946-4bf2-8c61-03e4df56d400')))]",
      "_analyticRulecontentProductId14": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','3c8140eb-e946-4bf2-8c61-03e4df56d400','-', '1.0.0')))]"
    },
    "analyticRuleObject15": {
      "analyticRuleVersion15": "1.0.0",
      "_analyticRulecontentId15": "849ea271-cd9c-4afe-a13b-ddbbac5fc6d3",
      "analyticRuleId15": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '849ea271-cd9c-4afe-a13b-ddbbac5fc6d3')]",
      "analyticRuleTemplateSpecName15": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('849ea271-cd9c-4afe-a13b-ddbbac5fc6d3')))]",
      "_analyticRulecontentProductId15": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','849ea271-cd9c-4afe-a13b-ddbbac5fc6d3','-', '1.0.0')))]"
    },
    "analyticRuleObject16": {
      "analyticRuleVersion16": "1.0.0",
      "_analyticRulecontentId16": "969e2e5c-9cc6-423c-a3de-514f7ad75fe7",
      "analyticRuleId16": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '969e2e5c-9cc6-423c-a3de-514f7ad75fe7')]",
      "analyticRuleTemplateSpecName16": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('969e2e5c-9cc6-423c-a3de-514f7ad75fe7')))]",
      "_analyticRulecontentProductId16": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','969e2e5c-9cc6-423c-a3de-514f7ad75fe7','-', '1.0.0')))]"
    },
    "analyticRuleObject17": {
      "analyticRuleVersion17": "1.0.0",
      "_analyticRulecontentId17": "51617533-cf51-4415-9020-b15bd47d69d2",
      "analyticRuleId17": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '51617533-cf51-4415-9020-b15bd47d69d2')]",
      "analyticRuleTemplateSpecName17": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('51617533-cf51-4415-9020-b15bd47d69d2')))]",
      "_analyticRulecontentProductId17": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','51617533-cf51-4415-9020-b15bd47d69d2','-', '1.0.0')))]"
    },
    "analyticRuleObject18": {
      "analyticRuleVersion18": "1.0.0",
      "_analyticRulecontentId18": "dae4c601-51c9-47f5-83d3-e6eaef929cf6",
      "analyticRuleId18": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'dae4c601-51c9-47f5-83d3-e6eaef929cf6')]",
      "analyticRuleTemplateSpecName18": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('dae4c601-51c9-47f5-83d3-e6eaef929cf6')))]",
      "_analyticRulecontentProductId18": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','dae4c601-51c9-47f5-83d3-e6eaef929cf6','-', '1.0.0')))]"
    },
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "displayName": "1Password (Serverless)",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "apiVersion": "2022-09-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "title": "1Password (Serverless)",
                  "publisher": "1Password",
                  "id": "1PasswordCCPDefinition",
                  "descriptionMarkdown": "The 1Password CCP connector allows the user to ingest 1Password Audit, Signin & ItemUsage events into Microsoft Sentinel.",
                  "graphQueriesTableName": "OnePasswordEventLogs_CL",
                  "graphQueries": [
                    {
                      "metricName": "Total Sign In Attempts received",
                      "legend": "SignIn Attempts",
                      "baseQuery": "{{graphQueriesTableName}} | where log_source == 'signinattempts'"
                    },
                    {
                      "metricName": "Total Audit Events received",
                      "legend": "Audit Events",
                      "baseQuery": "{{graphQueriesTableName}} | where log_source == 'auditevents'"
                    },
                    {
                      "metricName": "Total Item Usage Events received",
                      "legend": "Item Usage Events",
                      "baseQuery": "{{graphQueriesTableName}} | where log_source == 'itemusages'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Get Sample of 1Password events",
                      "query": "{{graphQueriesTableName}}\n | take 10"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "OnePasswordEventLogs_CL",
                      "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(7d) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "HasDataConnectors"
                    }
                  ],
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "1Password API token",
                        "description": "A 1Password API Token is required. See the [1Password documentation](https://support.1password.com/events-reporting/#appendix-issue-or-revoke-bearer-tokens) on how to create an API token."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "STEP 1 - Create a 1Password API token:",
                      "description": "Follow the [1Password documentation](https://support.1password.com/events-reporting/#appendix-issue-or-revoke-bearer-tokens) for guidance on this step."
                    },
                    {
                      "title": "STEP 2 - Choose the correct base URL:",
                      "description": "There are multiple 1Password servers which might host your events. The correct server depends on your license and region. Follow the [1Password documentation](https://developer.1password.com/docs/events-api/reference/#servers) to choose the correct server. Input the base URL as displayed by the documentation (including 'https://' and without a trailing '/')."
                    },
                    {
                      "title": "STEP 3 - Enter your 1Password Details:",
                      "description": "Enter the 1Password base URL & API Token below:",
                      "instructions": [
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "Base Url",
                            "placeholder": "Enter your Base Url",
                            "type": "text",
                            "name": "BaseUrl"
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "API Token",
                            "placeholder": "Enter your API Token",
                            "type": "password",
                            "name": "ApiToken"
                          }
                        },
                        {
                          "type": "ConnectionToggleButton",
                          "parameters": {
                            "connectLabel": "connect",
                            "name": "connect"
                          }
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "1PasswordDCR",
              "apiVersion": "2022-06-01",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]",
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-OnePasswordEventLogs_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "outputStream": "Custom-OnePasswordEventLogs_CL",
                    "transformKql": "source | extend TimeGenerated = now(), log_source = case(isnotempty(used_version) or isnotempty(aux_id), 'itemusages', isnotempty(country), 'signinattempts', isempty(used_version) and isempty(aux_id) and isempty(country), 'auditevents', 'unknown')"
                  }
                ]
              }
            },
            {
              "name": "OnePasswordEventLogs_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "schema": {
                  "name": "OnePasswordEventLogs_CL",
                  "columns": [
                    {
                      "name": "SourceSystem",
                      "type": "string"
                    },
                    {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    },
                    {
                      "name": "uuid_s",
                      "type": "string"
                    },
                    {
                      "name": "session_uuid",
                      "type": "string"
                    },
                    {
                      "name": "timestamp",
                      "type": "datetime"
                    },
                    {
                      "name": "country",
                      "type": "string"
                    },
                    {
                      "name": "category",
                      "type": "string"
                    },
                    {
                      "name": "action_type",
                      "type": "string"
                    },
                    {
                      "name": "details",
                      "type": "dynamic"
                    },
                    {
                      "name": "target_user",
                      "type": "dynamic"
                    },
                    {
                      "name": "client",
                      "type": "dynamic"
                    },
                    {
                      "name": "location",
                      "type": "dynamic"
                    },
                    {
                      "name": "actor_uuid",
                      "type": "string"
                    },
                    {
                      "name": "actor_details",
                      "type": "dynamic"
                    },
                    {
                      "name": "action",
                      "type": "string"
                    },
                    {
                      "name": "object_type",
                      "type": "string"
                    },
                    {
                      "name": "object_uuid",
                      "type": "string"
                    },
                    {
                      "name": "object_details",
                      "type": "dynamic"
                    },
                    {
                      "name": "aux_id",
                      "type": "int"
                    },
                    {
                      "name": "aux_uuid",
                      "type": "string"
                    },
                    {
                      "name": "aux_details",
                      "type": "dynamic"
                    },
                    {
                      "name": "aux_info",
                      "type": "string"
                    },
                    {
                      "name": "session",
                      "type": "dynamic"
                    },
                    {
                      "name": "used_version",
                      "type": "int"
                    },
                    {
                      "name": "vault_uuid",
                      "type": "string"
                    },
                    {
                      "name": "item_uuid",
                      "type": "string"
                    },
                    {
                      "name": "user",
                      "type": "dynamic"
                    },
                    {
                      "name": "log_source",
                      "type": "string"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
      "apiVersion": "2022-09-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "title": "1Password (Serverless)",
          "publisher": "1Password",
          "id": "1PasswordCCPDefinition",
          "descriptionMarkdown": "The 1Password CCP connector allows the user to ingest 1Password Audit, Signin & ItemUsage events into Microsoft Sentinel.",
          "graphQueriesTableName": "OnePasswordEventLogs_CL",
          "graphQueries": [
            {
              "metricName": "Total Sign In Attempts received",
              "legend": "SignIn Attempts",
              "baseQuery": "{{graphQueriesTableName}} | where log_source == 'signinattempts'"
            },
            {
              "metricName": "Total Audit Events received",
              "legend": "Audit Events",
              "baseQuery": "{{graphQueriesTableName}} | where log_source == 'auditevents'"
            },
            {
              "metricName": "Total Item Usage Events received",
              "legend": "Item Usage Events",
              "baseQuery": "{{graphQueriesTableName}} | where log_source == 'itemusages'"
            }
          ],
          "sampleQueries": [
            {
              "description": "Get Sample of 1Password events",
              "query": "{{graphQueriesTableName}}\n | take 10"
            }
          ],
          "dataTypes": [
            {
              "name": "OnePasswordEventLogs_CL",
              "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(7d) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "HasDataConnectors"
            }
          ],
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "Read and Write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "1Password API token",
                "description": "A 1Password API Token is required. See the [1Password documentation](https://support.1password.com/events-reporting/#appendix-issue-or-revoke-bearer-tokens) on how to create an API token."
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "STEP 1 - Create a 1Password API token:",
              "description": "Follow the [1Password documentation](https://support.1password.com/events-reporting/#appendix-issue-or-revoke-bearer-tokens) for guidance on this step."
            },
            {
              "title": "STEP 2 - Choose the correct base URL:",
              "description": "There are multiple 1Password servers which might host your events. The correct server depends on your license and region. Follow the [1Password documentation](https://developer.1password.com/docs/events-api/reference/#servers) to choose the correct server. Input the base URL as displayed by the documentation (including 'https://' and without a trailing '/')."
            },
            {
              "title": "STEP 3 - Enter your 1Password Details:",
              "description": "Enter the 1Password base URL & API Token below:",
              "instructions": [
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "Base Url",
                    "placeholder": "Enter your Base Url",
                    "type": "text",
                    "name": "BaseUrl"
                  }
                },
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "API Token",
                    "placeholder": "Enter your API Token",
                    "type": "password",
                    "name": "ApiToken"
                  }
                },
                {
                  "type": "ConnectionToggleButton",
                  "parameters": {
                    "connectLabel": "connect",
                    "name": "connect"
                  }
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Rogier Dijkman (SecureHats)"
        },
        "support": {
          "name": "1Password",
          "tier": "Partner",
          "link": "https://support.1password.com/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections1')]",
        "displayName": "1Password (Serverless)",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "apikey": {
              "defaultValue": "-NA-",
              "type": "securestring",
              "minLength": 1
            },
            "baseUrl": {
              "defaultValue": "Enter baseUrl value",
              "type": "string",
              "minLength": 1
            },
            "BasrUrl": {
              "defaultValue": "Enter BasrUrl value",
              "type": "string",
              "minLength": 1
            },
            "connectorDefinitionName": {
              "defaultValue": "1Password (Serverless)",
              "type": "string",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "string"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            },
            "ApiToken": {
              "defaultValue": "ApiToken",
              "type": "string",
              "minLength": 1
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', 'OnePasswordSignInEvents')]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "RestApiPoller",
              "properties": {
                "connectorDefinitionName": "1PasswordCCPDefinition",
                "dataType": "OnePasswordEventLogs_CL",
                "dcrConfig": {
                  "streamName": "Custom-OnePasswordEventLogs_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "APIKey",
                  "ApiKey": "[[parameters('apikey')]",
                  "ApiKeyName": "Authorization",
                  "ApiKeyIdentifier": "Bearer"
                },
                "request": {
                  "apiEndpoint": "[[concat('[[format('{0}/api/v1/signinattempts', ', parameters('baseUrl'), ')]')]",
                  "httpMethod": "Post",
                  "queryWindowInMin": 5,
                  "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
                  "rateLimitQps": 1,
                  "retryCount": 3,
                  "timeoutInSeconds": 60,
                  "headers": {
                    "Content-Type": "application/json"
                  },
                  "queryParametersTemplate": "{\"limit\": 1000, \"start_time\": \"{_QueryWindowStartTime}\", \"end_time\": \"{_QueryWindowEndTime}\" }",
                  "isPostPayloadJson": true
                },
                "response": {
                  "format": "json",
                  "eventsJsonPaths": [
                    "$.items"
                  ]
                },
                "paging": {
                  "pagingType": "NextPageToken",
                  "nextPageParaName": "cursor",
                  "nextPageTokenJsonPath": "$.cursor",
                  "hasNextFlagJsonPath": "$.has_more"
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', 'OnePasswordAuditEvents')]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "RestApiPoller",
              "properties": {
                "connectorDefinitionName": "1PasswordCCPDefinition",
                "dataType": "OnePasswordEventLogs_CL",
                "dcrConfig": {
                  "streamName": "Custom-OnePasswordEventLogs_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "APIKey",
                  "ApiKey": "[[parameters('apikey')]",
                  "ApiKeyName": "Authorization",
                  "ApiKeyIdentifier": "Bearer"
                },
                "request": {
                  "apiEndpoint": "[[concat('[[format('{0}/api/v1/auditevents', ', parameters('BasrUrl'), ')]')]",
                  "httpMethod": "Post",
                  "queryWindowInMin": 5,
                  "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
                  "rateLimitQps": 1,
                  "retryCount": 3,
                  "timeoutInSeconds": 60,
                  "headers": {
                    "Content-Type": "application/json"
                  },
                  "queryParametersTemplate": "{\"limit\": 1000, \"start_time\": \"{_QueryWindowStartTime}\", \"end_time\": \"{_QueryWindowEndTime}\" }",
                  "isPostPayloadJson": true
                },
                "response": {
                  "format": "json",
                  "eventsJsonPaths": [
                    "$.items"
                  ]
                },
                "paging": {
                  "pagingType": "NextPageToken",
                  "nextPageParaName": "cursor",
                  "nextPageTokenJsonPath": "$.cursor",
                  "hasNextFlagJsonPath": "$.has_more"
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', 'OnePasswordItemUsageEvents')]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "RestApiPoller",
              "properties": {
                "connectorDefinitionName": "1PasswordCCPDefinition",
                "dataType": "OnePasswordEventLogs_CL",
                "dcrConfig": {
                  "streamName": "Custom-OnePasswordEventLogs_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "APIKey",
                  "ApiKey": "[[parameters('apikey')]",
                  "ApiKeyName": "Authorization",
                  "ApiKeyIdentifier": "Bearer"
                },
                "request": {
                  "apiEndpoint": "[[concat('[[format('{0}/api/v1/itemusages', ', parameters('BaseUrl'), ')]')]",
                  "httpMethod": "Post",
                  "queryWindowInMin": 1,
                  "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
                  "rateLimitQps": 5,
                  "retryCount": 3,
                  "timeoutInSeconds": 60,
                  "headers": {
                    "Content-Type": "application/json"
                  },
                  "queryParametersTemplate": "{\"limit\": 1000, \"start_time\": \"{_QueryWindowStartTime}\", \"end_time\": \"{_QueryWindowEndTime}\" }",
                  "isPostPayloadJson": true
                },
                "response": {
                  "format": "json",
                  "eventsJsonPaths": [
                    "$.items"
                  ]
                },
                "paging": {
                  "pagingType": "NextPageToken",
                  "nextPageParaName": "cursor",
                  "nextPageTokenJsonPath": "$.cursor",
                  "hasNextFlagJsonPath": "$.has_more"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('dataConnectorTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password data connector with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId2'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId2')]",
                  "title": "1Password (using Azure Functions)",
                  "publisher": "1Password",
                  "descriptionMarkdown": "The [1Password](https://www.1password.com) solution for Microsoft Sentinel enables you to ingest sign-in attempts, item usage, and audit events from your 1Password Business account using the [1Password Events Reporting API](https://developer.1password.com/docs/events-api). This allows you to monitor and investigate events in 1Password in Microsoft Sentinel along with the other applications and services your organization uses.\n\n**Underlying Microsoft Technologies used:**\n\nThis solution depends on the following technologies, and some of which may be in [Preview](https://azure.microsoft.com/support/legal/preview-supplemental-terms/) state or may incur additional ingestion or operational costs:\n\n-  [Azure Functions](https://azure.microsoft.com/services/functions/#overview)",
                  "additionalRequirementBanner": "These queries are dependent on a parser based on a Kusto Function deployed as part of the solution.",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "1Password",
                      "baseQuery": "OnePasswordEventLogs_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Top 10 Users",
                      "query": "OnePasswordEventLogs_CL\n | summarize count() by tostring(target_user.name) \n | top 10 by count_"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "OnePasswordEventLogs_CL",
                      "lastDataReceivedQuery": "OnePasswordEventLogs_CL\n | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "OnePasswordEventLogs_CL\n | summarize LastLogReceived = max(TimeGenerated)\n | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft.Web/sites permissions",
                        "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
                      },
                      {
                        "name": "1Password Events API Token",
                        "description": "A 1Password Events API Token is required. [See the documentation to learn more about the 1Password API](https://developer.1password.com/docs/events-api/reference). \n\n**Note:** A 1Password Business account is required"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": ">**NOTE:** This connector uses Azure Functions to connect to 1Password to pull logs into Microsoft Sentinel. This might result in additional data ingestion costs from Azure. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
                    },
                    {
                      "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
                    },
                    {
                      "description": "**STEP 1 - Configuration steps for the 1Password Events Reporting API**\n\n [Follow these instructions](https://support.1password.com/events-reporting/#appendix-issue-or-revoke-bearer-tokens) provided by 1Password to obtain an Events Reporting API Token. **Note:** A 1Password Business account is required"
                    },
                    {
                      "description": "**STEP 2 - Deploy the functionApp using DeployToAzure button to create the table, dcr and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the 1Password connector, a custom table needs to be created."
                    },
                    {
                      "description": "This method provides an automated deployment of the 1Password connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-OnePassword-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Workspace Name**, **Workspace Name**, **1Password Events API Key**, and **URI**.\n - The default **Time Interval** is set to five (5) minutes. If you'd like to modify the interval, you can adjust the Function App Timer Trigger accordingly (in the function.json file, post deployment) to prevent overlapping data ingestion.\n - Note: If using Azure Key Vault secrets for any of the values above, use the`@Microsoft.KeyVault(SecretUri={Security Identifier})`schema in place of the string values. Refer to [Key Vault references documentation](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) for further details. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy.",
                      "title": "Option 1 - Azure Resource Manager (ARM) Template"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2023-04-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId2'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId2'))]",
                "contentId": "[variables('_dataConnectorContentId2')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_dataConnectorContentId2')]",
        "contentKind": "DataConnector",
        "displayName": "1Password (using Azure Functions)",
        "contentProductId": "[variables('_dataConnectorcontentProductId2')]",
        "id": "[variables('_dataConnectorcontentProductId2')]",
        "version": "[variables('dataConnectorVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId2'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId2')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId2'))]",
        "contentId": "[variables('_dataConnectorContentId2')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion2')]",
        "source": {
          "kind": "Solution",
          "name": "1Password",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Rogier Dijkman (SecureHats)"
        },
        "support": {
          "name": "1Password",
          "tier": "Partner",
          "link": "https://support.1password.com/"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId2'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "1Password (using Azure Functions)",
          "publisher": "1Password",
          "descriptionMarkdown": "The [1Password](https://www.1password.com) solution for Microsoft Sentinel enables you to ingest sign-in attempts, item usage, and audit events from your 1Password Business account using the [1Password Events Reporting API](https://developer.1password.com/docs/events-api). This allows you to monitor and investigate events in 1Password in Microsoft Sentinel along with the other applications and services your organization uses.\n\n**Underlying Microsoft Technologies used:**\n\nThis solution depends on the following technologies, and some of which may be in [Preview](https://azure.microsoft.com/support/legal/preview-supplemental-terms/) state or may incur additional ingestion or operational costs:\n\n-  [Azure Functions](https://azure.microsoft.com/services/functions/#overview)",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "1Password",
              "baseQuery": "OnePasswordEventLogs_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "OnePasswordEventLogs_CL",
              "lastDataReceivedQuery": "OnePasswordEventLogs_CL\n | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "OnePasswordEventLogs_CL\n | summarize LastLogReceived = max(TimeGenerated)\n | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "Top 10 Users",
              "query": "OnePasswordEventLogs_CL\n | summarize count() by tostring(target_user.name) \n | top 10 by count_"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "1Password Events API Token",
                "description": "A 1Password Events API Token is required. [See the documentation to learn more about the 1Password API](https://developer.1password.com/docs/events-api/reference). \n\n**Note:** A 1Password Business account is required"
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to 1Password to pull logs into Microsoft Sentinel. This might result in additional data ingestion costs from Azure. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
            },
            {
              "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
            },
            {
              "description": "**STEP 1 - Configuration steps for the 1Password Events Reporting API**\n\n [Follow these instructions](https://support.1password.com/events-reporting/#appendix-issue-or-revoke-bearer-tokens) provided by 1Password to obtain an Events Reporting API Token. **Note:** A 1Password Business account is required"
            },
            {
              "description": "**STEP 2 - Deploy the functionApp using DeployToAzure button to create the table, dcr and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the 1Password connector, a custom table needs to be created."
            },
            {
              "description": "This method provides an automated deployment of the 1Password connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-OnePassword-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Workspace Name**, **Workspace Name**, **1Password Events API Key**, and **URI**.\n - The default **Time Interval** is set to five (5) minutes. If you'd like to modify the interval, you can adjust the Function App Timer Trigger accordingly (in the function.json file, post deployment) to prevent overlapping data ingestion.\n - Note: If using Azure Key Vault secrets for any of the values above, use the`@Microsoft.KeyVault(SecretUri={Security Identifier})`schema in place of the string values. Refer to [Key Vault references documentation](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) for further details. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy.",
              "title": "Option 1 - Azure Resource Manager (ARM) Template"
            }
          ],
          "id": "[variables('_uiConfigId2')]",
          "additionalRequirementBanner": "These queries are dependent on a parser based on a Kusto Function deployed as part of the solution."
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password Workbook with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Gain insights and comprehensive monitoring into 1Password events data by analyzing traffic and user activities.\nThis workbook provides insights into various 1Password events types.\nYou can use this workbook to get visibility in to your 1Password Security Events and quickly identify threats, anamolies, traffic patterns, application usage, blocked IP addresses and more."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## 1Password audit logs\"},\"name\":\"text - 1\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"1ca69445-60fc-4806-b43d-ac7e6aad630a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"value\":\"/subscriptions/7570c6f7-9ca9-409b-aeaf-cb0f5ac1ad50\",\"typeSettings\":{\"includeAll\":false},\"label\":\"☁️ Subscription\"},{\"id\":\"e94aafa3-c5d9-4523-89f0-4e87aa754511\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"isRequired\":true,\"query\":\"Resources \\n| where type =~ \\\"microsoft.operationalinsights/workspaces\\\" \\n| order by name \\n| project id, name, selected=row_number()==1, group=resourceGroup\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.operationalinsights/workspaces\":true}},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"label\":\"🗂️ Workspace\",\"value\":\"\"},{\"id\":\"c4b69c01-2263-4ada-8d9c-43433b739ff3\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":604800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"label\":\"⏱️ Time Range\"},{\"id\":\"6ed3bbc6-be3f-44ed-84b3-9908e7c92315\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Help\",\"type\":10,\"isRequired\":true,\"jsonData\":\"[\\r\\n { \\\"value\\\": \\\"Yes\\\", \\\"label\\\": \\\"Yes\\\"},\\r\\n {\\\"value\\\": \\\"No\\\", \\\"label\\\": \\\"No\\\", \\\"selected\\\":true },\\r\\n { \\\"value\\\": \\\"Change Log\\\", \\\"label\\\": \\\"Change Log\\\"}\\r\\n]\",\"label\":\"📖 Help\",\"value\":\"Yes\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"customWidth\":\"70\",\"name\":\"parameters - 1\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"e648443b-bf59-4ae6-8c04-a5edf7097da6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Measurement\",\"type\":10,\"isRequired\":true,\"jsonData\":\"[\\r\\n{\\\"value\\\": \\\"KM\\\", \\\"label\\\": \\\"KM\\\"},\\r\\n{\\\"value\\\": \\\"Miles\\\", \\\"label\\\": \\\"Miles\\\", \\\"selected\\\":true}\\r\\n]\",\"value\":\"KM\"},{\"id\":\"ba4eb749-336e-4aa0-8a4b-2b7987507852\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Top\",\"label\":\"Show Top locations\",\"type\":2,\"description\":\"Only show this amount of locations om the map\",\"isRequired\":true,\"typeSettings\":{\"showDefault\":false},\"jsonData\":\"[\\r\\n{ \\\"value\\\": \\\"5\\\", \\\"label\\\": \\\"5\\\"},\\r\\n{\\\"value\\\": \\\"10\\\", \\\"label\\\": \\\"10\\\", \\\"selected\\\":true },\\r\\n{\\\"value\\\": \\\"20\\\", \\\"label\\\": \\\"20\\\" },\\r\\n{\\\"value\\\": \\\"30\\\", \\\"label\\\": \\\"30\\\" },\\r\\n{\\\"value\\\": \\\"50\\\", \\\"label\\\": \\\"50\\\" }\\r\\n]\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"30\",\"name\":\"parameters - settings\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"182ff415-dc4f-42d3-a39a-eab397510bc7\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"All Data\",\"subTarget\":\"AllData\",\"style\":\"link\"},{\"id\":\"0d78c03f-f8d7-40da-8761-3ef454b14ad8\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"User Data\",\"subTarget\":\"UserData\",\"style\":\"link\"}]},\"name\":\"links - 5\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"All Data\",\"loadType\":\"always\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| summarize count() by bin (timestamp, 1d), log_source\",\"size\":1,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\",\"chartSettings\":{\"xAxis\":\"timestamp\"}},\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where log_source contains \\\"signinattempts\\\"\\r\\n| extend city_  = tostring(location.city) \\r\\n| extend state_ = tostring(location.state) \\r\\n| extend countryOrRegion_ =  tostring((geo_info_from_ip_address (tostring(client.ip_address))).region)\\r\\n| extend latitude_  = tostring(location.latitude)\\r\\n| extend longitude_ = tostring(location.longitude) \\r\\n| order by timestamp asc, city_ asc\\r\\n| serialize \\r\\n| extend pLat = prev(latitude_, 1)\\r\\n| extend pLon = prev(longitude_, 1)\\r\\n| extend distanceType = iif('{Measurement}' == \\\"KM\\\", todouble(1000), todouble(1609.344))\\r\\n| extend distance_in = iif(row_number() > 1,tostring(round(geo_distance_2points(todouble(longitude_), todouble(latitude_), todouble(pLon), todouble(pLat))/distanceType ,2)),\\\"FirstLocation\\\")\\r\\n| where distance_in !=\\\"0.0\\\"\\r\\n| summarize by bin(timestamp, {TimeRange:grain}),\\r\\n                       City=city_ ,\\r\\n                       CountryorRegion=countryOrRegion_, \\r\\n                       visitedInThisOrder = row_number(),\\r\\n                       distanceTravelled = distance_in,\\r\\n                       distanceTravelled2 = strcat(distance_in,' ','{Measurement}'),\\r\\n                       latitude_,\\r\\n                       longitude_\\r\\n| order by timestamp asc, visitedInThisOrder asc\",\"size\":0,\"title\":\"User Locations\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude_\",\"longitude\":\"longitude_\",\"sizeSettings\":\"City\",\"sizeAggregation\":\"Count\",\"minSize\":20,\"labelSettings\":\"distanceTravelled\",\"legendMetric\":\"distanceTravelled\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"CountryorRegion\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = \\r\\nOnePasswordEventLogs_CL\\r\\n| where log_source == 'signinattempts'\\r\\n  and tostring(target_user.name) notcontains 'Provisioning';\\r\\ndata\\r\\n| summarize count() by tostring(target_user.name), bin (timestamp, 1d)\",\"size\":1,\"title\":\"User Sign-ins\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where log_source contains \\\"signinattempts\\\"\\r\\n| extend countryOrRegion_ =  tostring((geo_info_from_ip_address (tostring(client.ip_address))).country)\\r\\n| order by TimeGenerated asc\\r\\n| summarize count() by bin(TimeGenerated, {TimeRange:grain}),\\r\\n                       Country=countryOrRegion_ \\r\\n| order by count_ desc\",\"size\":1,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"countries\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where log_source contains \\\"signinattempts\\\"\\r\\n| distinct tostring(target_user.name)\\r\\n| count\\r\\n\\r\\n\",\"size\":4,\"title\":\"Active Users\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":false,\"sortOrderField\":1}},\"customWidth\":\"15\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where object_type == \\\"group\\\"\\r\\n| where action == \\\"create\\\"\\r\\n| count\",\"size\":4,\"title\":\"Groups Added\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":false}},\"customWidth\":\"15\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where object_type == \\\"group\\\"\\r\\n| where action == \\\"delete\\\"\\r\\n| count\",\"size\":4,\"title\":\"Groups deleted\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":false}},\"customWidth\":\"15\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where log_source contains \\\"signinattempts\\\"\\r\\n//| where category != \\\"success\\\"\\r\\n| extend actiontype_ = tostring(action_type)\\r\\n| order by TimeGenerated asc, category asc\\r\\n| summarize count() by Category=category \\r\\n| order by count_ desc\",\"size\":1,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Category\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where log_source contains \\\"signinattempts\\\"\\r\\n| extend applicationName_ = tostring(client.app_name)\\r\\n| where applicationName_ notcontains \\\"SCIM\\\"\\r\\n| order by timestamp asc , applicationName_\\r\\n| summarize count() by bin(timestamp, {TimeRange:grain}),\\r\\n                       ApplicationName=applicationName_ \\r\\n| order by count_ desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"All Users : Used Application by most frequent\",\"color\":\"green\",\"noDataMessage\":\"Select a workspace\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Namespace\",\"exportParameterName\":\"Namespace\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"areachart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"visit_order\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"UserDisplayName\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"userNameLocation\",\"sourceIdField\":\"TimeGenerated\",\"targetIdField\":\"MilesTravelled\",\"staticNodeSize\":100,\"hivesMargin\":5},\"chartSettings\":{\"group\":\"ApplicationName\",\"showMetrics\":false,\"showLegend\":true},\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude_\",\"longitude\":\"longitude_\",\"sizeSettings\":\"MilesTravelled\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"visit_order\",\"legendMetric\":\"MilesTravelled\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"MilesTravelled\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"redDark\"}}},\"customWidth\":\"50\",\"name\":\"query - 6 - by Location  - All User - Copy - Copy\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"AllData\"},\"name\":\"Group: AllData\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Group: UserMap\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"268ebde4-5b20-4106-9e91-8e7d36b26d4f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Select\",\"label\":\"Select Users method\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"showDefault\":false},\"jsonData\":\"[\\r\\n {\\\"value\\\": \\\"name\\\", \\\"label\\\": \\\"Select User by Name\\\", \\\"selected\\\":true },\\r\\n {\\\"value\\\": \\\"letter\\\", \\\"label\\\": \\\"Select User by letter\\\"},\\r\\n {\\\"value\\\": \\\"free\\\", \\\"label\\\": \\\"Select User using free text search\\\"}\\r\\n]\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 10\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Workspace}\"],\"parameters\":[{\"id\":\"4fd13b3f-9856-4e1d-93f5-c4681a6b4c16\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectUserName\",\"type\":2,\"isRequired\":true,\"query\":\"OnePasswordEventLogs_CL\\r\\n| extend UserDisplayName = tostring(target_user.name)\\r\\n| where timestamp  {TimeRange:query}\\r\\n| where isnotempty(UserDisplayName) and  UserDisplayName !=\\\"On-Premises Directory Synchronization Service Account\\\"\\r\\n| summarize Count = count() by UserDisplayName\\r\\n| order by Count desc, UserDisplayName asc\\r\\n| project Value = UserDisplayName, Label = strcat(UserDisplayName, ' - ', Count, ' sign-ins'), Selected = false\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"value\":\"Rogier Dijkman\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"label\":\"\"},{\"id\":\"8aa43840-1b93-449a-861e-450856dc1297\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"userCount\",\"label\":\"How many unique Users?\",\"type\":10,\"description\":\"1000 users max are shown\",\"isRequired\":true,\"query\":\"OnePasswordEventLogs_CL\\r\\n| extend UserDisplayName = tostring(target_user.name)\\r\\n| where isnotempty(UserDisplayName) and  UserDisplayName !=\\\"On-Premises Directory Synchronization Service Account\\\"\\r\\n| distinct UserDisplayName\\r\\n| summarize Count = strcat(count(),\\\" of 1000\\\")\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"showDefault\":false},\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"above\",\"doNotRunWhenHidden\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Select\",\"comparison\":\"isEqualTo\",\"value\":\"name\"},\"name\":\"parameters - 7\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Workspace}\"],\"parameters\":[{\"id\":\"adb47350-f652-4bd3-b2c7-dcfc3e380a23\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"UserFilter\",\"type\":2,\"query\":\"OnePasswordEventLogs_CL\\r\\n| extend UserDisplayName = tostring(target_user.name)\\r\\n| distinct UserDisplayName\\r\\n| project  Alpha = toupper(substring(UserDisplayName,0,1))\\r\\n| summarize Count = count() by Alpha\\r\\n| order by Alpha asc\\r\\n| project Value=Alpha, Label=Alpha, selected = false\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"showDefault\":false},\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"ad7f576a-5df8-49c1-99c2-f8fdbca5557b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectUserLetter\",\"label\":\" Select User Letter\",\"type\":2,\"query\":\"OnePasswordEventLogs_CL\\r\\n| extend UserDisplayName = tostring(target_user.name)\\r\\n| where UserDisplayName startswith '{UserFilter:label}'\\r\\n| summarize by UserDisplayName\\r\\n| order by UserDisplayName asc\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"showDefault\":false},\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"96d46227-91be-4519-a83d-449e38b5f32c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"selectedUserCount\",\"label\":\"How many unique Users?\",\"type\":10,\"description\":\"1000 users max are shown\",\"isRequired\":true,\"query\":\"SigninLogs\\r\\n| where UserDisplayName startswith '{UserFilter:label}'\\r\\n| distinct UserDisplayName\\r\\n| summarize Count = strcat(count(),\\\" of 1000\\\")\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"showDefault\":false},\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"above\",\"doNotRunWhenHidden\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Select\",\"comparison\":\"isEqualTo\",\"value\":\"letter\"},\"name\":\"parameters - 9\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Workspace}\"],\"parameters\":[{\"id\":\"c2577785-56e7-415e-b95d-4af62446fb49\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectUserFree\",\"label\":\"Search for a User here\",\"type\":1,\"description\":\"Enter a free text search for a User Name \",\"value\":\"\",\"timeContext\":{\"durationMs\":86400000},\"timeContextFromParameter\":\"TimeRange\"},{\"id\":\"38ee7b13-de6b-48da-a98f-0ae75ae0517e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectUserwithin\",\"label\":\"Matched User(s)\",\"type\":2,\"query\":\"OnePasswordEventLogs_CL\\r\\n| extend UserDisplayName = tostring(target_user.name)\\r\\n| where UserDisplayName contains '{SelectUserFree}'\\r\\n| distinct UserDisplayName\\r\\n| project UserDisplayName \\r\\n| order by UserDisplayName asc\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"showDefault\":false},\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"1407f53f-c0b3-4eae-a3a8-8d60c737fb4d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"selectedUserCount2\",\"label\":\"How many unique Users?\",\"type\":10,\"description\":\"1000 users max are shown\",\"isRequired\":true,\"query\":\"OnePasswordEventLogs_CL\\r\\n| extend UserDisplayName = tostring(target_user.name)\\r\\n| where UserDisplayName contains '{SelectUserFree}'\\r\\n| distinct UserDisplayName\\r\\n| summarize Count = strcat(count(),\\\" of 1000\\\")\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"showDefault\":false},\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Select\",\"comparison\":\"isEqualTo\",\"value\":\"free\"},\"name\":\"parameters - 12\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Workspace}\"],\"parameters\":[{\"id\":\"ba660562-9b21-4412-b2d7-cc12bb64c33d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectUser\",\"type\":1,\"description\":\"Only shows user from name or letter parameter - depending on Toggle\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| extend SelectUser = case( '{Select}' == \\\"name\\\"   , '{SelectUserName}',\\r\\n                            '{Select}' == \\\"letter\\\" , '{SelectUserLetter}',\\r\\n                            '{Select}' == \\\"free\\\"   , '{SelectUserwithin}',\\r\\n                            // else\\r\\n                            \\\"error\\\"\\r\\n                            )\\r\\n| limit 1\\r\\n| project SelectUser\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 12\"},{\"type\":1,\"content\":{\"json\":\"### Missing Input data Warning: diagnostics\\r\\n\\r\\nUser Name displayed, from the selected parameter: \\r\\n## {SelectUser}\\r\\n\\r\\n|Parameter|Value detected|\\r\\n|---|---|\\r\\n|Name|{SelectUserName}|\\r\\n|Letter|{SelectUserLetter}|\\r\\n|Free|{SelectUserFree}|\"},\"conditionalVisibility\":{\"parameterName\":\"SelectUser\",\"comparison\":\"isEqualTo\"},\"name\":\"text - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where log_source contains \\\"signinattempts\\\"\\r\\n| extend UserDisplayName = tostring(target_user.name)\\r\\n| where UserDisplayName == '{SelectUser}'\\r\\n| extend city_  = tostring(location.city) \\r\\n| extend state_ = tostring(location.state) \\r\\n| extend countryOrRegion_ = tostring(location.region) \\r\\n| extend latitude_  = tostring(location.latitude)\\r\\n| extend longitude_ = tostring(location.longitude) \\r\\n| order by TimeGenerated asc, city_ asc\\r\\n| serialize \\r\\n| extend pLat = prev(latitude_, 1)\\r\\n| extend pLon = prev(longitude_, 1)\\r\\n| extend distanceType = iif('{Measurement}' == \\\"KM\\\", todouble(1000), todouble(1609.344))\\r\\n| extend distance_in = iif(row_number() > 0,tostring(round(geo_distance_2points(todouble(longitude_), todouble(latitude_), todouble(pLon), todouble(pLat))/distanceType, 2)), \\\"FirstLocation\\\")\\r\\n| where distance_in !=\\\"0.0\\\"\\r\\n| summarize by bin(TimeGenerated, {TimeRange:grain}),\\r\\n                       UserDisplayName,\\r\\n                       City=city_ ,\\r\\n                       CountryorRegion=countryOrRegion_, \\r\\n                       visitedInThisOrder = row_number(),\\r\\n                       distanceTravelled = distance_in,\\r\\n                       distanceTravelled2 = strcat(distance_in,' ','{Measurement}'),\\r\\n                       latitude_,\\r\\n                       longitude_\\r\\n| order by TimeGenerated asc, visitedInThisOrder asc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Map showing locations for user: '{SelectUser}'\",\"timeContextFromParameter\":\"TimeRange\",\"exportedParameters\":[{\"fieldName\":\"Namespace\",\"parameterName\":\"Namespace\",\"defaultValue\":\"All\"},{\"parameterName\":\"SelectedUsers\",\"parameterType\":1}],\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"map\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"visit_order\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"UserDisplayName\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"userNameLocation\",\"sourceIdField\":\"TimeGenerated\",\"targetIdField\":\"MilesTravelled\",\"staticNodeSize\":100,\"hivesMargin\":5},\"chartSettings\":{\"yAxis\":[\"City\"]},\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude_\",\"longitude\":\"longitude_\",\"sizeSettings\":\"distanceTravelled\",\"sizeAggregation\":\"Sum\",\"opacity\":0.7,\"labelSettings\":\"City\",\"legendMetric\":\"distanceTravelled\",\"numberOfMetrics\":10,\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"distanceTravelled\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"categorical\"}}},\"customWidth\":\"50\",\"name\":\"query - 6 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"extend a = parse_json('{SelectedUsers}')\\r\\n| project  ['User']='{SelectUser}', ['city']=a.regionName, ['latitude']=a.latitude, ['longitude']=a.longitude\\r\\n| limit 1\",\"size\":4,\"title\":\"Please select a map region for more details\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"]},\"customWidth\":\"50\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = \\r\\nOnePasswordEventLogs_CL\\r\\n| where log_source == 'signinattempts'\\r\\n  and tostring(target_user.name) in ('{SelectUser}');\\r\\ndata\\r\\n| summarize count() by tostring(target_user.name), bin (TimeGenerated,1h)\",\"size\":1,\"title\":\"'{SelectUser}': Sign-in pattern\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"name\":\"query - 16\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where log_source contains \\\"signinattempts\\\"\\r\\n| where target_user.name == '{SelectUser}'\\r\\n| extend city_  = tostring(location.city) \\r\\n| extend state_ = tostring(location.state) \\r\\n| extend countryOrRegion_ = tostring(location.region) \\r\\n| extend latitude_  = tostring(location.latitude)\\r\\n| extend longitude_ = tostring(location.longitude)\\r\\n| order by TimeGenerated asc , city_ asc\\r\\n| serialize \\r\\n| extend pLat = prev(latitude_,1)\\r\\n| extend pLon = prev(longitude_,1)\\r\\n| extend distanceType = iif('{Measurement}' == \\\"KM\\\", todouble(1000), todouble(1609.344))\\r\\n| extend distance_in = iif(row_number() > 1,tostring(round(geo_distance_2points(todouble(longitude_), todouble(latitude_), todouble(pLon), todouble(pLat))/distanceType ,2)),strcat(\\\"FirstLocation\\\",' ','({Measurement})') ) \\r\\n| extend dwell_in = datetime_diff(\\\"second\\\",TimeGenerated, prev(TimeGenerated))\\r\\n| where distance_in !=\\\"0.0\\\"\\r\\n| extend\\r\\n    UserDisplayName = tostring(target_user.name)\\r\\n    , City = city_\\r\\n    , State = state_\\r\\n    , location = location.country\\r\\n    , IPAddress = tostring(client.ip_address)\\r\\n    , ClientAppUsed = tostring(client.app_version)\\r\\n    , AppDisplayName = tostring(client.app_name)\\r\\n| extend ResourceGroup = 'Microsoft.aadiam'\\r\\n| summarize by TimeGenerated,\\r\\n                       UserDisplayName,\\r\\n                       City=city_ ,\\r\\n                       State = state_,\\r\\n                       Location=countryOrRegion_, \\r\\n                       visitOrder = row_number(),\\r\\n                       distanceBetweenLocations = distance_in, // strcat(distance_in,' ','({Measurement})')\\r\\n                       dwell_in, IPAddress, ResourceGroup, AppDisplayName, ClientAppUsed\\r\\n| order by TimeGenerated asc, visitOrder asc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Looking for '{SelectUser}' - click a row for more IP detail\",\"color\":\"green\",\"timeContextFromParameter\":\"TimeRange\",\"exportedParameters\":[{\"fieldName\":\"Namespace\",\"parameterName\":\"Namespace\",\"defaultValue\":\"All\"},{\"fieldName\":\"IPAddress\",\"parameterName\":\"ipAddress\",\"parameterType\":1},{\"fieldName\":\"ResourceGroup\",\"parameterName\":\"resourceGroup\",\"parameterType\":1}],\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"distanceBetweenLocations\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"dwell_in\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":24,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumSignificantDigits\":3}}},{\"columnMatch\":\"ResourceGroup\",\"formatter\":5},{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\"},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\"}}],\"filter\":true,\"sortBy\":[{\"itemKey\":\"visitOrder\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"visitOrder\",\"sortOrder\":1}],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"visit_order\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"UserDisplayName\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"userNameLocation\",\"sourceIdField\":\"TimeGenerated\",\"targetIdField\":\"MilesTravelled\",\"staticNodeSize\":100,\"hivesMargin\":5},\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude_\",\"longitude\":\"longitude_\",\"sizeSettings\":\"MilesTravelled\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"visit_order\",\"legendMetric\":\"MilesTravelled\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"MilesTravelled\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"redDark\"}}},\"name\":\"query - get User details\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"method\\\":\\\"GET\\\",\\\"path\\\":\\\"/subscriptions/{Workspace:subscriptionid}/resourceGroups/Microsoft.aadiam/providers/Microsoft.SecurityInsights/enrichment/ip/geodata/?ipaddress={ipAddress}&api-version=2021-09-01-preview\\\",\\\"batchDisabled\\\":false,\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$\\\"}}]}\\r\\n\",\"size\":4,\"title\":\"🖧 Lookup IP Address: {ipAddress} from Microsoft geoLocation api\",\"queryType\":12,\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"country\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"representation\":\"Globe\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"ipAddr\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"representation\":\"gray\",\"text\":\"{0}{1}\"}]}}]}},\"conditionalVisibility\":{\"parameterName\":\"ipAddress\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - geoLocation api\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let IP_Data = external_data(network:string,geoname_id:long,continent_code:string,continent_name:string ,country_iso_code:string,country_name:string,is_anonymous_proxy:bool,is_satellite_provider:bool)\\r\\n    ['https://raw.githubusercontent.com/datasets/geoip2-ipv4/master/data/geoip2-ipv4.csv']\\r\\n    with (ignoreFirstRecord=true, format=\\\"csv\\\");\\r\\nIP_Data\\r\\n| evaluate ipv4_lookup(IP_Data, '{ipAddress}', network)\\r\\n| summarize arg_max(network,*) by '{ipAddress}'\\r\\n| extend IPaddress = '{ipAddress}'\\r\\n| project-away *1\\r\\n| project-reorder IPaddress\\r\\n\\r\\n\",\"size\":4,\"title\":\"🖧  Lookup IP Address: {ipAddress} from GeoIP2\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"IPaddress\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"representation\":\"gray\",\"text\":\"{0}{1}\"}]}}]}},\"conditionalVisibility\":{\"parameterName\":\"ipAddress\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - ip lookup GeoIP2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where log_source contains \\\"signinattempts\\\"\\r\\n| extend UserDisplayName = tostring(target_user.name)\\r\\n| where UserDisplayName !=\\\"On-Premises Directory Synchronization Service Account\\\"\\r\\n| where UserDisplayName == '{SelectUser}'\\r\\n| extend city_  = tostring(location.city) \\r\\n| extend state_ = tostring(location.state) \\r\\n| extend countryOrRegion_ = tostring(location.region) \\r\\n| extend latitude_  = tostring(location.latitude)\\r\\n| extend longitude_ = tostring(location.longitude)  \\r\\n| order by TimeGenerated asc , city_ asc\\r\\n| serialize \\r\\n| extend pLat = prev(latitude_,1)\\r\\n| extend pLon = prev(longitude_,1)\\r\\n| extend distanceType = iif('{Measurement}' == \\\"KM\\\", todouble(1000), todouble(1609.344))\\r\\n| extend distance_in = iif(isnotempty(pLat),tostring(round(geo_distance_2points(todouble(longitude_), todouble(latitude_), todouble(pLon), todouble(pLat))/distanceType ,2)),\\\"FirstLocation\\\")\\r\\n| where distance_in !=\\\"0.0\\\"\\r\\n| summarize by bin(TimeGenerated, {TimeRange:grain}),\\r\\n                       UserDisplayName,\\r\\n                       City=city_ ,\\r\\n                       CountryorRegion=countryOrRegion_, \\r\\n                       visitedInThisOrder = row_number(),\\r\\n                       distanceTravelled = strcat(distance_in,' ','{Measurement}')\\r\\n//| top {Top} by City\\r\\n| order by TimeGenerated asc, visitedInThisOrder asc\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\" '{SelectUser}' : Cities visitied\",\"color\":\"green\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Namespace\",\"exportParameterName\":\"Namespace\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"unstackedbar\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"visit_order\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"UserDisplayName\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"userNameLocation\",\"sourceIdField\":\"TimeGenerated\",\"targetIdField\":\"MilesTravelled\",\"staticNodeSize\":100,\"hivesMargin\":5},\"chartSettings\":{\"group\":\"City\",\"createOtherGroup\":10,\"showMetrics\":false,\"showLegend\":true},\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude_\",\"longitude\":\"longitude_\",\"sizeSettings\":\"MilesTravelled\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"visit_order\",\"legendMetric\":\"MilesTravelled\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"MilesTravelled\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"redDark\"}}},\"customWidth\":\"50\",\"name\":\"query - 6 - by Location  - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where log_source contains \\\"signinattempts\\\"\\r\\n| extend UserDisplayName = tostring(target_user.name)\\r\\n| where UserDisplayName == '{SelectUser}'\\r\\n| extend city_  = tostring(location.city) \\r\\n| extend state_ = tostring(location.state) \\r\\n| extend countryOrRegion_ = tostring(location.region) \\r\\n| extend latitude_  = tostring(location.latitude)\\r\\n| extend longitude_ = tostring(location.longitude)\\r\\n| order by TimeGenerated asc , city_ asc\\r\\n| serialize \\r\\n| extend pLat = prev(latitude_,1)\\r\\n| extend pLon = prev(longitude_,1)\\r\\n| extend distanceType = iif('{Measurement}' == \\\"KM\\\", todouble(1000), todouble(1609.344))\\r\\n| extend distance_in = iif(isnotempty(pLat),tostring(round(geo_distance_2points(todouble(longitude_), todouble(latitude_), todouble(pLon), todouble(pLat))/distanceType ,2)),\\\"FirstLocation\\\")\\r\\n| where distance_in !=\\\"0.0\\\"\\r\\n| summarize by bin(TimeGenerated, {TimeRange:grain}),\\r\\n                       UserDisplayName,\\r\\n                       City=city_ ,\\r\\n                       CountryorRegion=countryOrRegion_, \\r\\n                       visitedInThisOrder = row_number(),\\r\\n                       distanceTravelled = strcat(distance_in,' ','{Measurement}')\\r\\n| order by TimeGenerated asc, visitedInThisOrder asc\",\"size\":1,\"showAnalytics\":true,\"title\":\" '{SelectUser}' : distance travelled\",\"color\":\"green\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Namespace\",\"exportParameterName\":\"Namespace\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"unstackedbar\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"visit_order\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"UserDisplayName\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"userNameLocation\",\"sourceIdField\":\"TimeGenerated\",\"targetIdField\":\"MilesTravelled\",\"staticNodeSize\":100,\"hivesMargin\":5},\"chartSettings\":{\"group\":\"distanceTravelled\",\"showMetrics\":false,\"showLegend\":true},\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude_\",\"longitude\":\"longitude_\",\"sizeSettings\":\"MilesTravelled\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"visit_order\",\"legendMetric\":\"MilesTravelled\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"MilesTravelled\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"redDark\"}}},\"customWidth\":\"50\",\"name\":\"query - 6 - by Location \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where log_source contains \\\"signinattempts\\\"\\r\\n| extend UserDisplayName = tostring(target_user.name)\\r\\n| where target_user.name == '{SelectUser}'\\r\\n| extend city_  = tostring(location.city) \\r\\n| extend state_ = tostring(location.state) \\r\\n| extend countryOrRegion_ = tostring(location.region) \\r\\n| extend latitude_  = tostring(location.latitude)\\r\\n| extend longitude_ = tostring(location.longitude)\\r\\n| order by TimeGenerated asc , city_ asc\\r\\n| serialize \\r\\n| extend pLat = prev(latitude_,1)\\r\\n| extend pLon = prev(longitude_,1)\\r\\n| extend distanceType = iif('{Measurement}' == \\\"KM\\\", todouble(1000), todouble(1609.344))\\r\\n| extend distance_in = iif(isnotempty(pLat),tostring(round(geo_distance_2points(todouble(longitude_), todouble(latitude_), todouble(pLon), todouble(pLat))/distanceType ,2)),\\\"FirstLocation\\\")\\r\\n| where distance_in !=\\\"0.0\\\"\\r\\n| summarize by bin(TimeGenerated, {TimeRange:grain}),\\r\\n                       UserDisplayName,\\r\\n                       City=city_ ,\\r\\n                       CountryorRegion=countryOrRegion_, \\r\\n                       visitedInThisOrder = row_number(),\\r\\n                       distanceTravelled = strcat(distance_in,' ','{Measurement}')\\r\\n| order by TimeGenerated asc, visitedInThisOrder asc\",\"size\":4,\"showAnalytics\":true,\"title\":\" '{SelectUser}' : Regions visitied \",\"color\":\"green\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Namespace\",\"exportParameterName\":\"Namespace\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"visit_order\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"UserDisplayName\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"userNameLocation\",\"sourceIdField\":\"TimeGenerated\",\"targetIdField\":\"MilesTravelled\",\"staticNodeSize\":100,\"hivesMargin\":5},\"chartSettings\":{\"group\":\"CountryorRegion\",\"showMetrics\":false,\"showLegend\":true},\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude_\",\"longitude\":\"longitude_\",\"sizeSettings\":\"MilesTravelled\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"visit_order\",\"legendMetric\":\"MilesTravelled\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"MilesTravelled\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"redDark\"}}},\"customWidth\":\"50\",\"name\":\"query - 6 - by Location  - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where log_source contains \\\"signinattempts\\\"\\r\\n| extend UserDisplayName = tostring(target_user.name)\\r\\n| where UserDisplayName == '{SelectUser}'\\r\\n| extend applicationName_ = tostring(client.app_name)\\r\\n| where applicationName_ notcontains \\\"SCIM\\\"\\r\\n| order by TimeGenerated asc , applicationName_\\r\\n| summarize count() by bin(TimeGenerated, {TimeRange:grain}),\\r\\n                       ApplicationName=applicationName_ \\r\\n| order by count_ desc\",\"size\":4,\"showAnalytics\":true,\"title\":\"'{SelectUser}' : Used Application by most frequent\",\"color\":\"green\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Namespace\",\"exportParameterName\":\"Namespace\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"visit_order\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"UserDisplayName\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"userNameLocation\",\"sourceIdField\":\"TimeGenerated\",\"targetIdField\":\"MilesTravelled\",\"staticNodeSize\":100,\"hivesMargin\":5},\"chartSettings\":{\"group\":\"ApplicationName\",\"showMetrics\":false,\"showLegend\":true},\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude_\",\"longitude\":\"longitude_\",\"sizeSettings\":\"MilesTravelled\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"visit_order\",\"legendMetric\":\"MilesTravelled\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"MilesTravelled\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"redDark\"}}},\"customWidth\":\"50\",\"name\":\"query - 6 - by Location  - All User - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OnePasswordEventLogs_CL\\r\\n| where log_source contains \\\"signinattempts\\\"\\r\\n| extend UserDisplayName = tostring(target_user.name)\\r\\n| where UserDisplayName == '{SelectUser}'\\r\\n//| where category != \\\"success\\\"\\r\\n| extend actiontype_ = tostring(action_type)\\r\\n| order by TimeGenerated asc, category asc\\r\\n| summarize count() by bin(TimeGenerated, {TimeRange:grain}),\\r\\n                       Category=category \\r\\n| order by count_ desc\",\"size\":4,\"showAnalytics\":true,\"title\":\"'{SelectUser}' : Authentication\",\"color\":\"green\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Namespace\",\"exportParameterName\":\"Namespace\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"visit_order\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"UserDisplayName\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"userNameLocation\",\"sourceIdField\":\"TimeGenerated\",\"targetIdField\":\"MilesTravelled\",\"staticNodeSize\":100,\"hivesMargin\":5},\"chartSettings\":{\"group\":\"Category\",\"showMetrics\":false,\"showLegend\":true},\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude_\",\"longitude\":\"longitude_\",\"sizeSettings\":\"MilesTravelled\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"visit_order\",\"legendMetric\":\"MilesTravelled\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"MilesTravelled\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"redDark\"}}},\"customWidth\":\"50\",\"name\":\"query - 6 - by Location  - All User - Copy - Copy\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"UserData\"},\"name\":\"group - UserMap\"}],\"fromTemplateId\":\"1Password\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=1PasswordWorkbook; logoFileName=1password.svg; description=Gain insights and comprehensive monitoring into 1Password events data by analyzing traffic and user activities.\nThis workbook provides insights into various 1Password events types.\nYou can use this workbook to get visibility in to your 1Password Security Events and quickly identify threats, anamolies, traffic patterns, application usage, blocked IP addresses and more.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=1Password Events Workbook; templateRelativePath=1Password.json; subtitle=; provider=1Password}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "OnePasswordEventLogs_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "1Password",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Changes to firewall rules_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when changes have been made to the firewall rules. Once this analytics rule is triggered it will group all related future alerts for upto an hour when all related entities are the same.\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Changes to firewall rules",
                "enabled": false,
                "query": "OnePasswordEventLogs_CL\n| where log_source == \"auditevents\"\n| where action == \"updatfw\"\n| where object_type == \"account\"\n| extend\n    ActorUsername = actor_details.email\n    , SrcIpAddr = session.ip",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ActorUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 1",
                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Changes to firewall rules",
        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Changes to SSO configuration_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when changes have been made to the SSO configuration. Once this analytics rule is triggered it will group all related future alerts for upto an hour when all related entities are the same.\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Changes to SSO configuration",
                "enabled": false,
                "query": "OnePasswordEventLogs_CL\n| where log_source == \"auditevents\"\n| where action has_any(\"enblsso\", \"disblsso\", \"chngpsso\", \"chngasso\", \"chngdsso\", \"addgsso\", \"delgsso\")\n| where object_type == \"sso\"\n| extend\n    ActorUsername = actor_details.email\n    , SrcIpAddr = session.ip",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "techniques": [
                  "T1556"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ActorUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDynamicProperties": []
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 2",
                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Changes to SSO configuration",
        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject3').analyticRuleTemplateSpecName3]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Disable MFA factor or type for all user accounts_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject3').analyticRuleVersion3]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when the MFA factor or type for all user accounts are disabled. Once this analytics rule is triggered it will group all related future alerts for upto an hour when all related entities are the same.\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Disable MFA factor or type for all user accounts",
                "enabled": false,
                "query": "OnePasswordEventLogs_CL\n| where log_source == \"auditevents\"\n| where action == \"disblmfa\"\n| where object_type == \"account\"\n| extend\n    ActorUsername = actor_details.email\n    , SrcIpAddr = session.ip",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1556"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ActorUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject3').analyticRuleId3,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 3",
                "parentId": "[variables('analyticRuleObject3').analyticRuleId3]",
                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Disable MFA factor or type for all user accounts",
        "contentProductId": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "id": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject4').analyticRuleTemplateSpecName4]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Log Ingestion Failure_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject4').analyticRuleVersion4]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when the log ingestion for the OnePasswordEventLogs_CL logs is failing. The alert is based on the healthevents that are created every 5 minutes and will trigger if no logs have been received for 1 hour.\n\nLog ingestion troubleshooting:\n<insert URL>\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Log Ingestion Failure",
                "enabled": false,
                "query": "OnePasswordEventLogs_CL\n| where log_source == \"healthevents\"",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "Equal",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1562"
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": false,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "5h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject4').analyticRuleId4,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 4",
                "parentId": "[variables('analyticRuleObject4').analyticRuleId4]",
                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Log Ingestion Failure",
        "contentProductId": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "id": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject5').analyticRuleTemplateSpecName5]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Manual account creation_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject5').analyticRuleVersion5]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when a new account was created manually within 1Password. This should only be used when a 1Password integration via a SCIM Bridge has been implemented.\n\nRef: https://support.1password.com/scim/\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Manual account creation",
                "enabled": false,
                "query": "OnePasswordEventLogs_CL\n| where action == \"create\"\n| where object_type == \"invite\"\n| where actor_details.email !endswith \"@1passwordserviceaccounts.com\"\n| extend\n    ActorUsername = actor_details.email\n    , SrcIpAddr = session.ip\n    , TargetUsername = aux_info",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "techniques": [
                  "T1136"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ActorUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "TargetUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AnyAlert",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject5').analyticRuleId5,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 5",
                "parentId": "[variables('analyticRuleObject5').analyticRuleId5]",
                "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Manual account creation",
        "contentProductId": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
        "id": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
        "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject6').analyticRuleTemplateSpecName6]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - New service account integration created_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject6').analyticRuleVersion6]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when a new integration has been created. Once this analytics rule is triggered it will group all related future alerts for upto an hour when all related entities are the same.\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - New service account integration created",
                "enabled": false,
                "query": "OnePasswordEventLogs_CL\n| where log_source == \"auditevents\"\n| where action == \"create\"\n| where object_type == \"sa\"\n| extend\n    ActorUsername = actor_details.email\n    , SrcIpAddr = session.ip",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "techniques": [
                  "T1136"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ActorUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject6').analyticRuleId6,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 6",
                "parentId": "[variables('analyticRuleObject6').analyticRuleId6]",
                "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject6').analyticRuleVersion6]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - New service account integration created",
        "contentProductId": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
        "id": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
        "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject7').analyticRuleTemplateSpecName7]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Non-privileged vault user permission change_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject7').analyticRuleVersion7]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when user permissions have changed within a non-privileged vault which have been implemented by an actor that was not the target user account. Once this analytics rule is triggered it will group all related future alerts for upto an hour when all related entities are the same.\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Non-privileged vault user permission change",
                "enabled": false,
                "query": "let watchlist =\n    _GetWatchlist(\"PV1PW\")\n    | project SearchKey\n;\n// Insert the vault UUIDs below when using the dynamic vaults list within the analytics rule itself\nlet vaults = dynamic([\"\"]);\nOnePasswordEventLogs_CL\n| where log_source == \"auditevents\"\n| where action has_any(\"grant\", \"revoke\", \"update\")\n| where object_type == \"uva\"\n| where tostring(actor_details.email) != tostring(aux_details.email)\n// Enable the line below when using the \"Privileged Vaults - 1PW\" watchlist\n| where object_uuid !in (watchlist)\n// Enable the line below when using the dynamic vaults list within the analytics rule itself\n// | where object_uuid !in (vaults)\n| extend\n    TargetUsername = aux_details.email\n    , ActorUsername = actor_details.email\n    , SrcIpAddr = session.ip",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "techniques": [
                  "T1098"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ActorUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "TargetUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject7').analyticRuleId7,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 7",
                "parentId": "[variables('analyticRuleObject7').analyticRuleId7]",
                "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject7').analyticRuleVersion7]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Non-privileged vault user permission change",
        "contentProductId": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
        "id": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
        "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject8').analyticRuleTemplateSpecName8]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Potential insider privilege escalation via group_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject8').analyticRuleVersion8]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when an actor grants, or updates their own permissions via a group. Once this analytics rule is triggered it will group all related future alerts for upto an hour when all related entities are the same.\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Potential insider privilege escalation via group",
                "enabled": false,
                "query": "OnePasswordEventLogs_CL\n| where log_source == \"auditevents\"\n| where action has_any(\"join\", \"role\")\n| where object_type == \"gm\"\n| where tostring(actor_details.email) == tostring(aux_details.email)\n| extend\n    TargetUsername = aux_details.email\n    , ActorUsername = actor_details.email\n    , SrcIpAddr = session.ip\n    , GroupRole = case(\n        aux_info == \"R\", \"Group member\"\n        , aux_info == \"A\", \"Group manager\"\n        , aux_info\n    )",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "PrivilegeEscalation"
                ],
                "techniques": [
                  "T1078"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ActorUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "TargetUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject8').analyticRuleId8,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 8",
                "parentId": "[variables('analyticRuleObject8').analyticRuleId8]",
                "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject8').analyticRuleVersion8]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Potential insider privilege escalation via group",
        "contentProductId": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
        "id": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
        "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject9').analyticRuleTemplateSpecName9]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Potential insider privilege escalation via vault_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject9').analyticRuleVersion9]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when an actor grants, or updates their own permissions via a vault. Once this analytics rule is triggered it will group all related future alerts for upto an hour when all related entities are the same.\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Potential insider privilege escalation via vault",
                "enabled": false,
                "query": "OnePasswordEventLogs_CL\n| where log_source == \"auditevents\"\n| where action has_any(\"grant\", \"update\")\n| where object_type == \"uva\"\n| where tostring(actor_details.email) == tostring(aux_details.email)\n| extend\n    TargetUsername = aux_details.email\n    , ActorUsername = actor_details.email\n    , SrcIpAddr = session.ip",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "PrivilegeEscalation"
                ],
                "techniques": [
                  "T1078"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ActorUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "TargetUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject9').analyticRuleId9,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 9",
                "parentId": "[variables('analyticRuleObject9').analyticRuleId9]",
                "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject9').analyticRuleVersion9]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Potential insider privilege escalation via vault",
        "contentProductId": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
        "id": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
        "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject10').analyticRuleTemplateSpecName10]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Privileged vault permission change_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject10').analyticRuleVersion10]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when permissions have changed within a privileged vault. Once this analytics rule is triggered it will group all related future alerts for upto an hour when all related entities are the same.\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Privileged vault permission change",
                "enabled": false,
                "query": "let watchlist =\n    _GetWatchlist(\"PV1PW\")\n    | project SearchKey\n;\n// Insert the vault UUIDs below when using the dynamic vaults list within the analytics rule itself\nlet vaults = dynamic([\"\"]);\nOnePasswordEventLogs_CL\n| where log_source == \"auditevents\"\n| where\n    (action has_any(\"grant\", \"revoke\", \"update\") and object_type == \"uva\") or\n    (action has_any(\"grant\", \"revoke\", \"update\") and object_type == \"gva\")\n// Enable the line below when using the \"Privileged Vaults - 1PW\" watchlist\n| where object_uuid in (watchlist)\n// Enable the line below when using the dynamic vaults list within the analytics rule itself\n// | where object_uuid in (vaults)\n| extend\n    TargetUsername = case(isnotempty(aux_details), aux_details.email, \"\")\n    , TargetGroupUUID = case(isempty(aux_details), aux_uuid, \"\")\n    , ActorUsername = actor_details.email\n    , SrcIpAddr = session.ip",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "techniques": [
                  "T1098"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ActorUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "TargetUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject10').analyticRuleId10,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 10",
                "parentId": "[variables('analyticRuleObject10').analyticRuleId10]",
                "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject10').analyticRuleVersion10]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Privileged vault permission change",
        "contentProductId": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
        "id": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
        "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject11').analyticRuleTemplateSpecName11]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Secret extraction post vault access change by administrator_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject11').analyticRuleVersion11]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when a secret extraction has occurred after an administrator has changed their own vault access permissions within that same vault.\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Secret extraction post vault access change by administrator",
                "enabled": false,
                "query": "let lookback = 1h;\nlet secretExtractionActivity =\n    OnePasswordEventLogs_CL\n    | where TimeGenerated between (ago(lookback) .. now())\n    | where log_source == \"itemusages\"\n    | where action has_any(\"server-fetch\", \"reveal\", \"secure-copy\")\n;\nOnePasswordEventLogs_CL\n| where log_source == \"auditevents\"\n| where (action == \"grant\" and object_type  == \"uva\") or (action == \"update\" and object_type  == \"uva\")\n| where tostring(actor_details.uuid) == tostring(aux_details.uuid)\n| extend\n    userUuid = tostring(actor_details.uuid)\n    , vaultUuid = tostring(object_uuid)\n| join (\n    secretExtractionActivity\n    | extend\n        userUuid = tostring(user.uuid)\n        , vaultUuid = tostring(vault_uuid)\n    )\n    on $left.userUuid == $right.userUuid and $left.vaultUuid == $right.vaultUuid\n| extend\n    auditevents = bag_pack(\"action\", action, \"object_type\", object_type)\n    , itemusages = bag_pack(\"action\", action1, \"object_type\", object_type1)\n    , vault_details = bag_pack(\"vault_uuid\", vault_uuid1, \"item_uuid\", item_uuid1)\n| project\n    TimeGenerated\n    , actor_details\n    , target_details = aux_details\n    , location_details = location\n    , client_details = client1\n    , auditevents\n    , itemusages\n    , vault_details\n    , TargetUsername = tostring(user1.email)\n    , SrcIpAddr = tostring(client1.ip_address)",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CredentialAccess"
                ],
                "techniques": [
                  "T1555"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "TargetUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject11').analyticRuleId11,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 11",
                "parentId": "[variables('analyticRuleObject11').analyticRuleId11]",
                "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject11').analyticRuleVersion11]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Secret extraction post vault access change by administrator",
        "contentProductId": "[variables('analyticRuleObject11')._analyticRulecontentProductId11]",
        "id": "[variables('analyticRuleObject11')._analyticRulecontentProductId11]",
        "version": "[variables('analyticRuleObject11').analyticRuleVersion11]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject12').analyticRuleTemplateSpecName12]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Service account integration token adjustment_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject12').analyticRuleVersion12]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when a service account integration token has been created, renamed, verified, or revoked. Once this analytics rule is triggered it will group all related future alerts for upto an hour when all related entities are the same.\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Service account integration token adjustment",
                "enabled": false,
                "query": "OnePasswordEventLogs_CL\n| where log_source == \"auditevents\"\n| where action has_any(\"create\", \"trename\", \"tverify\", \"trevoke\")\n| where object_type == \"satoken\"\n| extend\n    ActorUsername = actor_details.email\n    , SrcIpAddr = session.ip",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1134"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ActorUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject12').analyticRuleId12,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 12",
                "parentId": "[variables('analyticRuleObject12').analyticRuleId12]",
                "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject12').analyticRuleVersion12]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Service account integration token adjustment",
        "contentProductId": "[variables('analyticRuleObject12')._analyticRulecontentProductId12]",
        "id": "[variables('analyticRuleObject12')._analyticRulecontentProductId12]",
        "version": "[variables('analyticRuleObject12').analyticRuleVersion12]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject13').analyticRuleTemplateSpecName13]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Successful anomalous sign-in_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject13').analyticRuleVersion13]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when a new successful MFA confirmed sign-in has occurred from a location that was not seen within the last 14 days.\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Successful anomalous sign-in",
                "enabled": false,
                "query": "let rulefrequency = 1h;\nlet lookback = 14d;\nlet onePasswordSigninBaseline =\n    OnePasswordEventLogs_CL\n    | where TimeGenerated between (ago(lookback) .. now())\n    | where log_source == \"signinattempts\"\n    | where (category == \"success\" and action_type == \"mfa_ok\") or (category == \"success\" and action_type == \"credentials_ok\")\n    | summarize count() by tostring(target_user.uuid), tostring(target_user.email), tostring(client.ip_address), tostring(location.country)\n    | extend identifier = strcat(target_user_uuid, client_ip_address)\n    | summarize make_list(identifier)\n;\nOnePasswordEventLogs_CL\n| where TimeGenerated between (ago(rulefrequency) .. now())\n| where log_source == \"signinattempts\"\n| where (category == \"success\" and action_type == \"mfa_ok\") or (category == \"success\" and action_type == \"credentials_ok\")\n// limit the amount of incident triggers by enabling and adjusting the following in order to exclude country specific sign-ins\n// | where country !in~ (\"CA\", \"US\")\n| extend identifier = strcat(target_user.uuid, client.ip_address)\n| where identifier !in (onePasswordSigninBaseline)\n| extend\n    TargetUsername = target_user.email\n    , SrcIpAddr = client.ip_address",
                "queryFrequency": "PT1H",
                "queryPeriod": "P14D",
                "severity": "Low",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1078"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "TargetUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDynamicProperties": []
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": false,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject13').analyticRuleId13,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 13",
                "parentId": "[variables('analyticRuleObject13').analyticRuleId13]",
                "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject13').analyticRuleVersion13]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Successful anomalous sign-in",
        "contentProductId": "[variables('analyticRuleObject13')._analyticRulecontentProductId13]",
        "id": "[variables('analyticRuleObject13')._analyticRulecontentProductId13]",
        "version": "[variables('analyticRuleObject13').analyticRuleVersion13]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject14').analyticRuleTemplateSpecName14]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - User account MFA settings changed_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject14').analyticRuleVersion14]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when a user creates, updates, or disables the user account MFA settings. Once this analytics rule is triggered it will group all related future alerts for upto an hour when all related entities are the same.\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - User account MFA settings changed",
                "enabled": false,
                "query": "OnePasswordEventLogs_CL\n| where log_source == \"auditevents\"\n| where action has_any(\"enblmfa\", \"updatmfa\", \"disblmfa\")\n| where object_type == \"user\"\n| extend\n    ActorUsername = actor_details.email\n    , SrcIpAddr = session.ip",
                "queryFrequency": "PT30M",
                "queryPeriod": "PT30M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence",
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1556"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ActorUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject14').analyticRuleId14,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 14",
                "parentId": "[variables('analyticRuleObject14').analyticRuleId14]",
                "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject14').analyticRuleVersion14]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - User account MFA settings changed",
        "contentProductId": "[variables('analyticRuleObject14')._analyticRulecontentProductId14]",
        "id": "[variables('analyticRuleObject14')._analyticRulecontentProductId14]",
        "version": "[variables('analyticRuleObject14').analyticRuleVersion14]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject15').analyticRuleTemplateSpecName15]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - User added to privileged group_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject15').analyticRuleVersion15]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when a user is added to a privileged group which has been implemented by an actor that was not the target user account. Once the analytics rule is triggered it will group all related future alerts for upto 30 minutes when all related entities are the same.\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - User added to privileged group",
                "enabled": false,
                "query": "let watchlist =\n    _GetWatchlist(\"PG1PW\")\n    | project SearchKey\n;\nlet groups = dynamic([\"\"]);\nOnePasswordEventLogs_CL\n| where log_source == \"auditevents\"\n| where action == \"join\"\n| where object_type == \"gm\"\n| where tostring(actor_details.email) != tostring(aux_details.email)\n// Enable the line below when using the \"Privileged Groups - 1PW\" watchlist\n| where object_uuid in (watchlist)\n// Enable the line below when using the dynamic groups list within the analytics rule itself\n// | where object_uuid in (groups)\n| extend\n    TargetUsername = aux_details.email\n    , ActorUsername = actor_details.email\n    , SrcIpAddr = session.ip\n    , GroupRole = case(\n        aux_info == \"R\", \"Group member\"\n        , aux_info == \"A\", \"Group manager\"\n        , aux_info\n    )",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "techniques": [
                  "T1098"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ActorUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "TargetUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "30m"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject15').analyticRuleId15,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 15",
                "parentId": "[variables('analyticRuleObject15').analyticRuleId15]",
                "contentId": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject15').analyticRuleVersion15]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - User added to privileged group",
        "contentProductId": "[variables('analyticRuleObject15')._analyticRulecontentProductId15]",
        "id": "[variables('analyticRuleObject15')._analyticRulecontentProductId15]",
        "version": "[variables('analyticRuleObject15').analyticRuleVersion15]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject16').analyticRuleTemplateSpecName16]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Vault export post account creation_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject16').analyticRuleVersion16]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when a successful vault export has occurred within 14 days of a new account being created within 1Password.\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Vault export post account creation",
                "enabled": false,
                "query": "let ruleFrequency = 1h;\nlet lookback = 14d;\nlet onePasswordUserCreationCheck =\n    OnePasswordEventLogs_CL\n    | where TimeGenerated between (ago(lookback) .. ago(now() - ago(ruleFrequency)))\n    | extend creationActivityFound = iff(action == \"activate\" and object_type == \"user\", bool(1), bool(0))\n;\nOnePasswordEventLogs_CL\n| where action == \"export\" and object_type == \"vault\"\n| extend userUuid = tostring(actor_details.uuid)\n| join (\n    onePasswordUserCreationCheck\n    | where creationActivityFound == true\n    | extend userUuid = tostring(object_details.uuid)\n    )\n    on $left.userUuid == $right.userUuid\n| extend\n    TargetUsername = object_details1.email\n    , SrcIpAddr = session1.ip_address",
                "queryFrequency": "PT1H",
                "queryPeriod": "P14D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CredentialAccess",
                  "Persistence"
                ],
                "techniques": [
                  "T1555",
                  "T1136"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "TargetUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject16').analyticRuleId16,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 16",
                "parentId": "[variables('analyticRuleObject16').analyticRuleId16]",
                "contentId": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject16').analyticRuleVersion16]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Vault export post account creation",
        "contentProductId": "[variables('analyticRuleObject16')._analyticRulecontentProductId16]",
        "id": "[variables('analyticRuleObject16')._analyticRulecontentProductId16]",
        "version": "[variables('analyticRuleObject16').analyticRuleVersion16]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject17').analyticRuleTemplateSpecName17]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Vault export prior to account suspension or deletion_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject17').analyticRuleVersion17]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when a successful vault export has occurred within the last 14 days prior to an account being suspended or deleted from 1Password.\n\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Vault export prior to account suspension or deletion",
                "enabled": false,
                "query": "let ruleFrequency = 1h;\nlet lookback = 14d;\nlet onePasswordVaultExportCheck =\n    OnePasswordEventLogs_CL\n    | where TimeGenerated between (ago(lookback) .. ago(now() - ago(ruleFrequency)))\n    | where action == \"export\" and object_type == \"vault\"\n;\nOnePasswordEventLogs_CL\n| where (action == \"suspend\" and object_type == \"user\") or (action == \"delete\" and object_type == \"user\")\n| extend\n    userUuid = tostring(object_details.uuid)\n    , auditevents = bag_pack(\"action\", action, \"object_type\", object_type)\n| join (\n    onePasswordVaultExportCheck\n    | extend userUuid = tostring(actor_details.uuid)\n    )\n    on $left.userUuid == $right.userUuid\n| extend\n    TargetUsername = actor_details1.email\n    , SrcIpAddr = session1.ip_address\n| project\n    TimeGenerated\n    , auditevents\n    , actor_details\n    , location_details = location\n    , session_details = session\n    , exported_vault = object_details\n    , TargetUsername\n    , SrcIpAddr",
                "queryFrequency": "PT1H",
                "queryPeriod": "P14D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CredentialAccess"
                ],
                "techniques": [
                  "T1555"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "TargetUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject17').analyticRuleId17,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 17",
                "parentId": "[variables('analyticRuleObject17').analyticRuleId17]",
                "contentId": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject17').analyticRuleVersion17]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Vault export prior to account suspension or deletion",
        "contentProductId": "[variables('analyticRuleObject17')._analyticRulecontentProductId17]",
        "id": "[variables('analyticRuleObject17')._analyticRulecontentProductId17]",
        "version": "[variables('analyticRuleObject17').analyticRuleVersion17]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject18').analyticRuleTemplateSpecName18]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "1Password - Vault export_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject18').analyticRuleVersion18]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will alert when a successful vault export has occurred within 1Password.\nRef: https://1password.com/\nRef: https://github.com/securehats/",
                "displayName": "1Password - Vault export",
                "enabled": false,
                "query": "OnePasswordEventLogs_CL\n| where action == \"export\"\n| where object_type == \"vault\"\n| extend\n    TargetUsername = actor_details.email\n    , SrcIpAddr = session.ip",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Low",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "1Password",
                    "dataTypes": [
                      "OnePasswordEventLogs_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CredentialAccess"
                ],
                "techniques": [
                  "T1555"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "TargetUsername",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcIpAddr",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "enabled": true,
                    "matchingMethod": "AllEntities",
                    "reopenClosedIncident": false,
                    "lookbackDuration": "1h"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject18').analyticRuleId18,'/'))))]",
              "properties": {
                "description": "1Password Analytics Rule 18",
                "parentId": "[variables('analyticRuleObject18').analyticRuleId18]",
                "contentId": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject18').analyticRuleVersion18]",
                "source": {
                  "kind": "Solution",
                  "name": "1Password",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Rogier Dijkman (SecureHats)"
                },
                "support": {
                  "name": "1Password",
                  "tier": "Partner",
                  "link": "https://support.1password.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
        "contentKind": "AnalyticsRule",
        "displayName": "1Password - Vault export",
        "contentProductId": "[variables('analyticRuleObject18')._analyticRulecontentProductId18]",
        "id": "[variables('analyticRuleObject18')._analyticRulecontentProductId18]",
        "version": "[variables('analyticRuleObject18').analyticRuleVersion18]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.2",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "1Password",
        "publisherDisplayName": "1Password",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>• Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/1Password/ReleaseNotes.md\">Release Notes</a></p>\n<p>• There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href=\"https://www.1password.com\">1Password</a> solution for Microsoft Sentinel enables you to ingest sign-in attempts, item usage, and audit events from your 1Password Business account using the <a href=\"https://developer.1password.com/docs/events-api\">1Password Events Reporting API</a>. This allows you to monitor and investigate events in 1Password in Microsoft Sentinel along with the other applications and services your organization uses.</p>\n<p><strong>Underlying Microsoft Technologies used:</strong></p>\n<p>This solution depends on the following technologies, and some of which may be in <a href=\"https://azure.microsoft.com/support/legal/preview-supplemental-terms/\">Preview</a> state or may incur additional ingestion or operational costs:</p>\n<ol type=\"a\">\n<li><a href=\"https://azure.microsoft.com/services/functions/#overview\">Azure Functions</a></li>\n</ol>\n<p><strong>Data Connectors:</strong> 2, <strong>Workbooks:</strong> 1, <strong>Analytic Rules:</strong> 18</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/azurekid/Azure-Sentinel/master/Logos/1password.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "1Password",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Rogier Dijkman (SecureHats)"
        },
        "support": {
          "name": "1Password",
          "tier": "Partner",
          "link": "https://support.1password.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId2')]",
              "version": "[variables('dataConnectorVersion2')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
              "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
              "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
              "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
              "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
              "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
              "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
              "version": "[variables('analyticRuleObject11').analyticRuleVersion11]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
              "version": "[variables('analyticRuleObject12').analyticRuleVersion12]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
              "version": "[variables('analyticRuleObject13').analyticRuleVersion13]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
              "version": "[variables('analyticRuleObject14').analyticRuleVersion14]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
              "version": "[variables('analyticRuleObject15').analyticRuleVersion15]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
              "version": "[variables('analyticRuleObject16').analyticRuleVersion16]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
              "version": "[variables('analyticRuleObject17').analyticRuleVersion17]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
              "version": "[variables('analyticRuleObject18').analyticRuleVersion18]"
            }
          ]
        },
        "firstPublishDate": "2023-12-01",
        "providers": [
          "1password"
        ],
        "categories": {
          "domains": [
            "Security - Others",
            "Identity"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
