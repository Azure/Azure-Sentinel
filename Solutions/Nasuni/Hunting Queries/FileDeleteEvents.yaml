id: 64a3477e-d06f-4491-86a5-6f99702e267f
name: Nasuni File Delete Activity
description: |
  'This query looks for file delete audit events generated by a Nasuni Edge Appliance.'
requiredDataConnectors:
  - connectorId: NasuniEdgeAppliance
    dataTypes:
      - Syslog
  - connectorId: SyslogAma
    datatypes:
      - Syslog
tactics:
  - Impact
relevantTechniques:
  - T1485
query: |
  Syslog 
  | where SyslogMessage matches regex "(nasuni.)([0-9A-Za-z]{8}-[0-9A-Za-z]{4}-[0-9A-Za-z]{4}-[0-9A-Za-z]{4}-[0-9A-Za-z]{1})"
  | extend SyslogMessageJson = extract('{(.*?)}', 0, SyslogMessage)
  | extend event_details = parse_json(SyslogMessageJson)
  | extend path_parts = parse_path(tostring(event_details.path))
  | extend SrcIpAdr = event_details.ipaddr
  | extend sAMAccountName = trim(@"(?s)^.*\\\s*", tostring(event_details.username))
  | extend sid = event_details.sid
  | extend domainName = trim_end(@"[\\]\S*", tostring(event_details.username))
  | extend HostName
  | extend filename = path_parts.Filename
  | extend directorypath = path_parts.DirectoryPath
  | where event_details.event_type == "AUDIT_UNLINK"
  | project
      TimeGenerated,
      HostName,
      event_type = event_details.event_type,
      sAMAccountName,
      domainName,
      filename,
      directorypath,
      SrcIpAdr,
      sid,
      volume_guid = event_details.volume,
      access_point = event_details.resource,
      primary_group_name = trim(@"(?s)^.*\\\s*", tostring(event_details.groupname)),
      new_path = event_details.newpath
  | extend Host_0_HostName = HostName
  | extend Account_0_Name = sAMAccountName
  | extend Account_0_NTDomain = domainName
  | extend Account_0_Sid = sid
  | extend File_0_Name = filename
  | extend File_0_Directory = directorypath
  | extend IP_0_Address = SrcIpAdr
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAdr
  - entityType: Account
    fieldMappings:
      - identifier: Sid
        columnName: sid
      - identifier: Name
        columnName: sAMAccountName
      - identifier: NTDomain
        columnName: domainName
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: HostName
  - entityType: File
    fieldMappings:
      - identifier: Name
        columnName: filename
      - identifier: Directory
        columnName: directorypath
version: 1.0.1