{
  "name": "CTM360_CBS_DCR",
  "type": "Microsoft.Insights/dataCollectionRules",
  "apiVersion": "2021-09-01-preview",
  "location": "{{location}}",
  "properties": {
    "description": "Data collection rule for CTM360 Cyber Blind Spot connector - 6 module types",
    "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
    "streamDeclarations": {
      "Custom-CBSLog_Azure_1_CL": {
        "columns": [
          {
            "name": "id",
            "type": "string"
          },
          {
            "name": "subject",
            "type": "string"
          },
          {
            "name": "severity",
            "type": "string"
          },
          {
            "name": "type",
            "type": "string"
          },
          {
            "name": "class",
            "type": "string"
          },
          {
            "name": "status",
            "type": "string"
          },
          {
            "name": "coa",
            "type": "string"
          },
          {
            "name": "screenshots",
            "type": "dynamic"
          },
          {
            "name": "remarks",
            "type": "string"
          },
          {
            "name": "external_link",
            "type": "string"
          },
          {
            "name": "first_seen",
            "type": "string"
          },
          {
            "name": "last_seen",
            "type": "string"
          },
          {
            "name": "brand",
            "type": "string"
          },
          {
            "name": "timestamp",
            "type": "long"
          },
          {
            "name": "raw_payload",
            "type": "dynamic"
          }
        ]
      },
      "Custom-CBS_MalwareLogs_CL": {
        "columns": [
          {
            "name": "id",
            "type": "string"
          },
          {
            "name": "domain",
            "type": "string"
          },
          {
            "name": "hostname",
            "type": "string"
          },
          {
            "name": "type",
            "type": "string"
          },
          {
            "name": "masked_password",
            "type": "string"
          },
          {
            "name": "user",
            "type": "string"
          },
          {
            "name": "user_domain",
            "type": "string"
          },
          {
            "name": "website",
            "type": "string"
          },
          {
            "name": "sources",
            "type": "dynamic"
          },
          {
            "name": "source_uri",
            "type": "dynamic"
          },
          {
            "name": "brand",
            "type": "string"
          },
          {
            "name": "remarks",
            "type": "string"
          },
          {
            "name": "external_link",
            "type": "string"
          },
          {
            "name": "status",
            "type": "string"
          },
          {
            "name": "stealer_family",
            "type": "dynamic"
          },
          {
            "name": "compromise_details",
            "type": "dynamic"
          },
          {
            "name": "date_compromised",
            "type": "string"
          },
          {
            "name": "computer_name",
            "type": "string"
          },
          {
            "name": "operating_system",
            "type": "string"
          },
          {
            "name": "malware_path",
            "type": "string"
          },
          {
            "name": "url_path",
            "type": "dynamic"
          },
          {
            "name": "first_seen",
            "type": "string"
          },
          {
            "name": "last_seen",
            "type": "string"
          },
          {
            "name": "timestamp",
            "type": "long"
          },
          {
            "name": "raw_payload",
            "type": "dynamic"
          }
        ]
      },
      "Custom-CBS_BreachedCredentials_CL": {
        "columns": [
          {
            "name": "id",
            "type": "string"
          },
          {
            "name": "domain",
            "type": "string"
          },
          {
            "name": "email",
            "type": "string"
          },
          {
            "name": "username",
            "type": "string"
          },
          {
            "name": "breach_source",
            "type": "dynamic"
          },
          {
            "name": "type",
            "type": "string"
          },
          {
            "name": "remarks",
            "type": "string"
          },
          {
            "name": "external_link",
            "type": "string"
          },
          {
            "name": "brand",
            "type": "string"
          },
          {
            "name": "status",
            "type": "string"
          },
          {
            "name": "first_seen",
            "type": "string"
          },
          {
            "name": "last_seen",
            "type": "string"
          },
          {
            "name": "timestamp",
            "type": "long"
          },
          {
            "name": "raw_payload",
            "type": "dynamic"
          }
        ]
      },
      "Custom-CBS_CompromisedCards_CL": {
        "columns": [
          {
            "name": "id",
            "type": "string"
          },
          {
            "name": "domain",
            "type": "string"
          },
          {
            "name": "hostname",
            "type": "string"
          },
          {
            "name": "type",
            "type": "string"
          },
          {
            "name": "masked_password",
            "type": "string"
          },
          {
            "name": "user",
            "type": "string"
          },
          {
            "name": "user_domain",
            "type": "string"
          },
          {
            "name": "website",
            "type": "string"
          },
          {
            "name": "software",
            "type": "string"
          },
          {
            "name": "sources",
            "type": "dynamic"
          },
          {
            "name": "source_uri",
            "type": "dynamic"
          },
          {
            "name": "brand",
            "type": "string"
          },
          {
            "name": "remarks",
            "type": "string"
          },
          {
            "name": "external_link",
            "type": "string"
          },
          {
            "name": "status",
            "type": "string"
          },
          {
            "name": "first_seen",
            "type": "string"
          },
          {
            "name": "last_seen",
            "type": "string"
          },
          {
            "name": "timestamp",
            "type": "long"
          },
          {
            "name": "raw_payload",
            "type": "dynamic"
          }
        ]
      },
      "Custom-CBS_DomainInfringement_CL": {
        "columns": [
          {
            "name": "id",
            "type": "string"
          },
          {
            "name": "subject",
            "type": "string"
          },
          {
            "name": "confirmation_time",
            "type": "long"
          },
          {
            "name": "remarks",
            "type": "string"
          },
          {
            "name": "external_link",
            "type": "string"
          },
          {
            "name": "severity",
            "type": "string"
          },
          {
            "name": "type",
            "type": "string"
          },
          {
            "name": "risks",
            "type": "dynamic"
          },
          {
            "name": "status",
            "type": "string"
          },
          {
            "name": "incident_status",
            "type": "string"
          },
          {
            "name": "brand",
            "type": "string"
          },
          {
            "name": "first_seen",
            "type": "string"
          },
          {
            "name": "last_seen",
            "type": "string"
          },
          {
            "name": "timestamp",
            "type": "long"
          }
        ]
      },
      "Custom-CBS_SubdomainInfringement_CL": {
        "columns": [
          {
            "name": "id",
            "type": "string"
          },
          {
            "name": "subject",
            "type": "string"
          },
          {
            "name": "remarks",
            "type": "string"
          },
          {
            "name": "external_link",
            "type": "string"
          },
          {
            "name": "severity",
            "type": "string"
          },
          {
            "name": "type",
            "type": "string"
          },
          {
            "name": "risks",
            "type": "dynamic"
          },
          {
            "name": "status",
            "type": "string"
          },
          {
            "name": "brand",
            "type": "string"
          },
          {
            "name": "first_seen",
            "type": "string"
          },
          {
            "name": "last_seen",
            "type": "string"
          },
          {
            "name": "timestamp",
            "type": "long"
          },
          {
            "name": "raw_payload",
            "type": "dynamic"
          }
        ]
      }
    },
    "destinations": {
      "logAnalytics": [
        {
          "workspaceResourceId": "{{workspaceResourceId}}",
          "workspaceId": "{{workspaceId}}",
          "name": "CTM360CBSWorkspace"
        }
      ]
    },
    "dataFlows": [
      {
        "streams": [
          "Custom-CBSLog_Azure_1_CL"
        ],
        "destinations": [
          "CTM360CBSWorkspace"
        ],
        "outputStream": "Custom-CBSLog_AzureV2_CL",
        "transformKql": "source | extend TimeGenerated = now(), IncidentId = tostring(['id']), Subject = tostring(subject), Severity = tostring(severity), IncidentType = tostring(['type']), Class = tostring(class), Status = tostring(['status']), COA = tostring(coa), Screenshots = screenshots, Remarks = tostring(remarks), ExternalLink = tostring(external_link), FirstSeen = tostring(first_seen), LastSeen = tostring(last_seen), Brand = tostring(brand), RawPayload = todynamic(columnifexists('raw_payload', '{}')) | project TimeGenerated, IncidentId, Subject, Severity, IncidentType, Class, Status, COA, Screenshots, Remarks, ExternalLink, FirstSeen, LastSeen, Brand, RawPayload"
      },
      {
        "streams": [
          "Custom-CBS_MalwareLogs_CL"
        ],
        "destinations": [
          "CTM360CBSWorkspace"
        ],
        "outputStream": "Custom-CBS_MalwareLogs_AzureV2_CL",
        "transformKql": "source | extend TimeGenerated = now(), Id = tostring(['id']), Domain = tostring(domain), Hostname = tostring(hostname), IncidentType = tostring(['type']), MaskedPassword = tostring(masked_password), User = tostring(user), UserDomain = tostring(user_domain), Website = tostring(website), Sources = sources, SourceUri = source_uri, Brand = tostring(brand), Remarks = tostring(remarks), ExternalLink = tostring(external_link), Status = tostring(['status']), StealerFamily = stealer_family, CompromiseDetails = compromise_details, DateCompromised = tostring(date_compromised), ComputerName = tostring(computer_name), OperatingSystem = tostring(operating_system), MalwarePath = tostring(malware_path), UrlPath = url_path, FirstSeen = tostring(first_seen), LastSeen = tostring(last_seen), RawPayload = todynamic(columnifexists('raw_payload', '{}')) | project TimeGenerated, Id, Domain, Hostname, IncidentType, MaskedPassword, User, UserDomain, Website, Sources, SourceUri, Brand, Remarks, ExternalLink, Status, StealerFamily, CompromiseDetails, DateCompromised, ComputerName, OperatingSystem, MalwarePath, UrlPath, FirstSeen, LastSeen, RawPayload"
      },
      {
        "streams": [
          "Custom-CBS_BreachedCredentials_CL"
        ],
        "destinations": [
          "CTM360CBSWorkspace"
        ],
        "outputStream": "Custom-CBS_BreachedCredentials_AzureV2_CL",
        "transformKql": "source | extend TimeGenerated = now(), Id = tostring(['id']), Domain = tostring(domain), Email = tostring(email), Username = tostring(username), BreachSource = breach_source, IncidentType = tostring(['type']), Remarks = tostring(remarks), ExternalLink = tostring(external_link), Brand = tostring(brand), Status = tostring(['status']), FirstSeen = tostring(first_seen), LastSeen = tostring(last_seen), RawPayload = todynamic(columnifexists('raw_payload', '{}')) | project TimeGenerated, Id, Domain, Email, Username, BreachSource, IncidentType, Remarks, ExternalLink, Brand, Status, FirstSeen, LastSeen, RawPayload"
      },
      {
        "streams": [
          "Custom-CBS_CompromisedCards_CL"
        ],
        "destinations": [
          "CTM360CBSWorkspace"
        ],
        "outputStream": "Custom-CBS_CompromisedCards_AzureV2_CL",
        "transformKql": "source | extend TimeGenerated = now(), Id = tostring(['id']), Domain = tostring(domain), Hostname = tostring(hostname), IncidentType = tostring(['type']), MaskedPassword = tostring(masked_password), User = tostring(user), UserDomain = tostring(user_domain), Website = tostring(website), Software = tostring(software), Sources = sources, SourceUri = source_uri, Brand = tostring(brand), Remarks = tostring(remarks), ExternalLink = tostring(external_link), Status = tostring(['status']), FirstSeen = tostring(first_seen), LastSeen = tostring(last_seen), RawPayload = todynamic(columnifexists('raw_payload', '{}')) | project TimeGenerated, Id, Domain, Hostname, IncidentType, MaskedPassword, User, UserDomain, Website, Software, Sources, SourceUri, Brand, Remarks, ExternalLink, Status, FirstSeen, LastSeen, RawPayload"
      },
      {
        "streams": [
          "Custom-CBS_DomainInfringement_CL"
        ],
        "destinations": [
          "CTM360CBSWorkspace"
        ],
        "outputStream": "Custom-CBS_DomainInfringement_AzureV2_CL",
        "transformKql": "source | extend TimeGenerated = now(), Id = tostring(['id']), Subject = tostring(subject), ConfirmationTime = tolong(confirmation_time), Remarks = tostring(remarks), ExternalLink = tostring(external_link), Severity = tostring(severity), IncidentType = tostring(['type']), Risks = risks, Status = tostring(['status']), IncidentStatus = tostring(incident_status), Brand = tostring(brand), FirstSeen = tostring(first_seen), LastSeen = tostring(last_seen), RawPayload = todynamic(columnifexists('raw_payload', '{}')) | project TimeGenerated, Id, Subject, ConfirmationTime, Remarks, ExternalLink, Severity, IncidentType, Risks, Status, IncidentStatus, Brand, FirstSeen, LastSeen, RawPayload"
      },
      {
        "streams": [
          "Custom-CBS_SubdomainInfringement_CL"
        ],
        "destinations": [
          "CTM360CBSWorkspace"
        ],
        "outputStream": "Custom-CBS_SubdomainInfringement_AzureV2_CL",
        "transformKql": "source | extend TimeGenerated = now(), Id = tostring(['id']), Subject = tostring(subject), Remarks = tostring(remarks), ExternalLink = tostring(external_link), Severity = tostring(severity), IncidentType = tostring(['type']), Risks = risks, Status = tostring(['status']), Brand = tostring(brand), FirstSeen = tostring(first_seen), LastSeen = tostring(last_seen), RawPayload = todynamic(columnifexists('raw_payload', '{}')) | project TimeGenerated, Id, Subject, Remarks, ExternalLink, Severity, IncidentType, Risks, Status, Brand, FirstSeen, LastSeen, RawPayload"
      }
    ]
  }
}