{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Joao Paulo Oliveira Santos - jsantos@keepersecurity.com",
    "comments": "Solution template for Keeper Security"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is setup"
      }
    },
    "subscription": {
      "type": "string",
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Keeper Security Dashboard",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "email": "jsantos@keepersecurity.com",
    "_email": "[variables('email')]",
    "_solutionName": "Keeper Security",
    "_solutionVersion": "3.0.1",
    "solutionId": "keepersecurity.keeper-security-integration",
    "_solutionId": "[variables('solutionId')]",
    "analyticRuleObject1": {
      "analyticRuleVersion1": "1.0.3",
      "_analyticRulecontentId1": "f031fbbc-37d8-4667-b795-d386bf2b5ab2",
      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'f031fbbc-37d8-4667-b795-d386bf2b5ab2')]",
      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('f031fbbc-37d8-4667-b795-d386bf2b5ab2')))]",
      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','f031fbbc-37d8-4667-b795-d386bf2b5ab2','-', '1.0.3')))]"
    },
    "analyticRuleObject2": {
      "analyticRuleVersion2": "1.0.3",
      "_analyticRulecontentId2": "75ffc8a4-86db-4f48-8506-cb4c049be484",
      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '75ffc8a4-86db-4f48-8506-cb4c049be484')]",
      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('75ffc8a4-86db-4f48-8506-cb4c049be484')))]",
      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','75ffc8a4-86db-4f48-8506-cb4c049be484','-', '1.0.3')))]"
    },
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "dataConnectorCCPVersion": "1.0.0",
    "_dataConnectorContentIdConnectorDefinition1": "KeeperSecurityPush2",
    "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
    "_dataConnectorContentIdConnections1": "KeeperSecurityPush2Connections",
    "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
    "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
    "blanks": "[replace('b', 'b', '')]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "KeeperSecurityDashboard",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Keeper Security - Alternate Master Password_AnalyticalRules Analytics Rule with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "apiVersion": "2023-02-01-preview",
              "kind": "NRT",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Creates an informational incident based on Keeper Security Password Changed data in Microsoft Sentinel",
                "displayName": "Keeper Security - Password Changed",
                "enabled": false,
                "query": "KeeperSecurityEventNewLogs_CL\n| where AuditEvent == \"change_master_password\"\n",
                "severity": "Informational",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "KeeperSecurityEventNewLogs_CL"
                    ],
                    "connectorId": "KeeperSecurityPush2"
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "Username",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "RemoteAddress",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "AlertPerResult"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "{{AuditEvent}} has been captured in the Keeper Security Event Logs",
                  "alertDisplayNameFormat": "{{AuditEvent}} on {{RemoteAddress}}"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5H",
                    "enabled": false,
                    "matchingMethod": "AllEntities"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
              "properties": {
                "description": "Keeper Security Analytics Rule 1",
                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "Keeper Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Joao Paulo Oliveira Santos",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Keeper Security",
                  "email": "support@keepersecurity.com",
                  "tier": "Partner",
                  "link": "https://www.keepersecurity.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
        "contentKind": "AnalyticsRule",
        "displayName": "Keeper Security - Password Changed",
        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Keeper Security - User MFA Changed_AnalyticalRules Analytics Rule with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "apiVersion": "2023-02-01-preview",
              "kind": "NRT",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Creates an informational incident based on Keeper Security User MFA Changed data in Microsoft Sentinel",
                "displayName": "Keeper Security - User MFA Changed",
                "enabled": false,
                "query": "KeeperSecurityEventNewLogs_CL\n| where AuditEvent in (```set_two_factor_off```, ```set_two_factor_on```)\n",
                "severity": "Informational",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "KeeperSecurityEventNewLogs_CL"
                    ],
                    "connectorId": "KeeperSecurityPush2"
                  }
                ],
                "tactics": [
                  "Persistence"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "Username",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "RemoteAddress",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "AlertPerResult"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "{{AuditEvent}} has been captured in the Keeper Security Event Logs",
                  "alertDisplayNameFormat": "{{AuditEvent}} on {{RemoteAddress}}"
                },
                "incidentConfiguration": {
                  "groupingConfiguration": {
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5H",
                    "enabled": false,
                    "matchingMethod": "AllEntities"
                  },
                  "createIncident": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
              "properties": {
                "description": "Keeper Security Analytics Rule 2",
                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "Keeper Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Joao Paulo Oliveira Santos",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Keeper Security",
                  "email": "support@keepersecurity.com",
                  "tier": "Partner",
                  "link": "https://www.keepersecurity.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
        "contentKind": "AnalyticsRule",
        "displayName": "Keeper Security - User MFA Changed",
        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "displayName": "Keeper Security Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "apiVersion": "2022-09-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "KeeperSecurityPush2",
                  "title": "Keeper Security Push Connector",
                  "publisher": "Keeper Security",
                  "descriptionMarkdown": "The [Keeper Security](https://keepersecurity.com) connector provides the capability to read raw event data from Keeper Security in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "Events Logs",
                      "legend": "KeeperSecurityEventNewLogs_CL",
                      "baseQuery": "KeeperSecurityEventNewLogs_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Keeper Security - All Events Logs",
                      "query": "KeeperSecurityEventNewLogs_CL\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "KeeperSecurityEventNewLogs_CL",
                      "lastDataReceivedQuery": "KeeperSecurityEventNewLogs_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "KeeperSecurityEventNewLogs_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Keeper Security uses in a Microsoft Analytics Workspace, if the [data forwarding](https://docs.keepersecurity.com/docs/data-forwarding) option is enabled in Keeper Security then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Keeper Security connector resources",
                            "applicationDisplayName": "Keeper Security Connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Events Logs Stream Name",
                            "value": "Custom-KeeperSecurityEventNewLogs"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    },
                    {
                      "title": "3. Update Keeper Admin Console",
                      "description": "Configure the Keeper Admin Console with the Azure connection details to enable data forwarding to Microsoft Sentinel.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Configure Azure Monitor Logs in Keeper Admin Console\n\nIn the [Keeper Admin Console](https://keepersecurity.com/console/), login as the Keeper Administrator. Then go to **Reporting & Alerts** and select **Azure Monitor Logs**.\n\nProvide the following information from Step 2 above into the Admin Console:\n\n- **Azure Tenant ID**: You can find this from Azure's \"Subscriptions\" area.\n- **Application (client) ID**: This is located in the App registration (KeeperLogging) overview screen\n- **Client Secret Value**: This is the Client Secret Value from the app registration secrets.\n- **Endpoint URL**: This is a URL that is created in the following specific format:\n  `https://<collection_url>/dataCollectionRules/<dcr_id>/streams/<table>?api-version=2023-01-01`\n\nTo assemble the Endpoint URL:\n\n- **<Collection URL>** This comes from Step 2 above\n- **<DCR_ID>** From the Data Collector Rule, copy the \"Immutable Id\" value, e.g. `dcr-xxxxxxx`\n- **<TABLE>** This is the table name created by Azure, e.g. `Custom-KeeperSecurityEventNewLogs`\n\nExample: `https://<Collection_URL>/dataCollectionRules/<DCR_ID>/streams/Custom-KeeperSecurityEventNewLogs?api-version=2023-01-01`"
                          }
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Joao Paulo Oliveira Santos",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Keeper Security",
                  "email": "support@keepersecurity.com",
                  "tier": "Partner",
                  "link": "https://www.keepersecurity.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "KeeperSecurityEventLogs_DCR",
              "apiVersion": "2022-06-01",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]",
                "streamDeclarations": {
                  "Custom-KeeperSecurityEventNewLogs": {
                    "columns": [
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "audit_event",
                        "type": "string"
                      },
                      {
                        "name": "remote_address",
                        "type": "string"
                      },
                      {
                        "name": "category",
                        "type": "string"
                      },
                      {
                        "name": "client_version",
                        "type": "string"
                      },
                      {
                        "name": "enterprise_id",
                        "type": "int"
                      },
                      {
                        "name": "username",
                        "type": "string"
                      },
                      {
                        "name": "timestamp",
                        "type": "datetime"
                      },
                      {
                        "name": "data",
                        "type": "dynamic"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-KeeperSecurityEventNewLogs"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | extend TimeGenerated = now() | project-rename AuditEvent = audit_event, RemoteAddress = remote_address, Category = category, ClientVersion = client_version, EnterpriseId = enterprise_id, Username = username, Timestamp = timestamp, Data = data",
                    "outputStream": "Custom-KeeperSecurityEventNewLogs_CL"
                  }
                ]
              }
            },
            {
              "name": "KeeperSecurityEventNewLogs_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "plan": "Analytics",
                "schema": {
                  "name": "KeeperSecurityEventNewLogs_CL",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    },
                    {
                      "name": "AuditEvent",
                      "type": "string"
                    },
                    {
                      "name": "RemoteAddress",
                      "type": "string"
                    },
                    {
                      "name": "Category",
                      "type": "string"
                    },
                    {
                      "name": "ClientVersion",
                      "type": "string"
                    },
                    {
                      "name": "EnterpriseId",
                      "type": "int"
                    },
                    {
                      "name": "Username",
                      "type": "string"
                    },
                    {
                      "name": "Timestamp",
                      "type": "datetime"
                    },
                    {
                      "name": "Data",
                      "type": "dynamic"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
      "apiVersion": "2022-09-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "KeeperSecurityPush2",
          "title": "Keeper Security Push Connector",
          "publisher": "Keeper Security",
          "descriptionMarkdown": "The [Keeper Security](https://keepersecurity.com) connector provides the capability to read raw event data from Keeper Security in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "Events Logs",
              "legend": "KeeperSecurityEventNewLogs_CL",
              "baseQuery": "KeeperSecurityEventNewLogs_CL"
            }
          ],
          "sampleQueries": [
            {
              "description": "Keeper Security - All Events Logs",
              "query": "KeeperSecurityEventNewLogs_CL\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "KeeperSecurityEventNewLogs_CL",
              "lastDataReceivedQuery": "KeeperSecurityEventNewLogs_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "KeeperSecurityEventNewLogs_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Keeper Security uses in a Microsoft Analytics Workspace, if the [data forwarding](https://docs.keepersecurity.com/docs/data-forwarding) option is enabled in Keeper Security then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Keeper Security connector resources",
                    "applicationDisplayName": "Keeper Security Connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Events Logs Stream Name",
                    "value": "Custom-KeeperSecurityEventNewLogs"
                  },
                  "type": "CopyableLabel"
                }
              ]
            },
            {
              "title": "3. Update Keeper Admin Console",
              "description": "Configure the Keeper Admin Console with the Azure connection details to enable data forwarding to Microsoft Sentinel.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Configure Azure Monitor Logs in Keeper Admin Console\n\nIn the [Keeper Admin Console](https://keepersecurity.com/console/), login as the Keeper Administrator. Then go to **Reporting & Alerts** and select **Azure Monitor Logs**.\n\nProvide the following information from Step 2 above into the Admin Console:\n\n- **Azure Tenant ID**: You can find this from Azure's \"Subscriptions\" area.\n- **Application (client) ID**: This is located in the App registration (KeeperLogging) overview screen\n- **Client Secret Value**: This is the Client Secret Value from the app registration secrets.\n- **Endpoint URL**: This is a URL that is created in the following specific format:\n  `https://<collection_url>/dataCollectionRules/<dcr_id>/streams/<table>?api-version=2023-01-01`\n\nTo assemble the Endpoint URL:\n\n- **<Collection URL>** This comes from Step 2 above\n- **<DCR_ID>** From the Data Collector Rule, copy the \"Immutable Id\" value, e.g. `dcr-xxxxxxx`\n- **<TABLE>** This is the table name created by Azure, e.g. `Custom-KeeperSecurityEventNewLogs`\n\nExample: `https://<Collection_URL>/dataCollectionRules/<DCR_ID>/streams/Custom-KeeperSecurityEventNewLogs?api-version=2023-01-01`"
                  }
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Joao Paulo Oliveira Santos",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Keeper Security",
          "email": "support@keepersecurity.com",
          "tier": "Partner",
          "link": "https://www.keepersecurity.com"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections1')]",
        "displayName": "Keeper Security Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Keeper Security Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Joao Paulo Oliveira Santos",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Keeper Security",
                  "email": "support@keepersecurity.com",
                  "tier": "Partner",
                  "link": "https://www.keepersecurity.com"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'KeeperSecurityPushConnectorPolling', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "KeeperSecurityPush2",
                "dcrConfig": {
                  "streamName": "Custom-KeeperSecurityEventNewLogs",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "KeeperSecurityDashboard Workbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "This workbook contains visualizations and insights in the Keeper Security environment."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Keeper Security Audit Logs Analysis\"},\"name\":\"text - 1\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"1ca69445-60fc-4806-b43d-ac7e6aad630a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"value\":\"/subscriptions/8c6a2ccf-3647-416c-b18c-4d9299c73e59\",\"typeSettings\":{\"includeAll\":false},\"label\":\"☁️ Subscription\"},{\"id\":\"e94aafa3-c5d9-4523-89f0-4e87aa754511\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"isRequired\":true,\"query\":\"Resources \\n| where type =~ \\\"microsoft.operationalinsights/workspaces\\\" \\n| order by name \\n| project id, name, selected=row_number()==1, group=resourceGroup\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.operationalinsights/workspaces\":true}},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"label\":\"🗂️ Workspace\",\"value\":\"\"},{\"id\":\"c4b69c01-2263-4ada-8d9c-43433b739ff3\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":2592000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000}],\"allowCustom\":true},\"label\":\"⏱️ Time Range\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 1\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"182ff415-dc4f-42d3-a39a-eab397510bc7\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"0d78c03f-f8d7-40da-8761-3ef454b14ad8\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"User Analysis\",\"subTarget\":\"UserAnalysis\",\"style\":\"link\"},{\"id\":\"security-events-tab\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Security Events\",\"subTarget\":\"SecurityEvents\",\"style\":\"link\"}]},\"name\":\"links - tabs\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Overview\",\"loadType\":\"always\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| summarize count() by bin(TimeGenerated, 1h), Category\\n| order by TimeGenerated asc\",\"size\":1,\"title\":\"Events Over Time by Category\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"name\":\"events-timeline\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| where isnotempty(RemoteAddress)\\n| extend GeoIP = geo_info_from_ip_address(RemoteAddress)\\n| extend Country = tostring(GeoIP.country), City = tostring(GeoIP.city)\\n| extend Latitude = toreal(GeoIP.latitude), Longitude = toreal(GeoIP.longitude)\\n| where isnotempty(Country)\\n| summarize EventCount = count() by Country, City, Latitude, Longitude\\n| top 20 by EventCount\",\"size\":0,\"title\":\"Geographic Distribution of Events\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"CountryRegion\",\"locInfoColumn\":\"Country\",\"sizeSettings\":\"EventCount\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"EventCount\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"EventCount\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"name\":\"geographic-map\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| distinct Username\\n| count\",\"size\":4,\"title\":\"Active Users\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":false}},\"customWidth\":\"25\",\"name\":\"active-users-tile\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| summarize TotalEvents = count()\\n| extend TotalEvents\",\"size\":4,\"title\":\"Total Events\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"formatter\":1},\"leftContent\":{\"columnMatch\":\"TotalEvents\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":false}},\"customWidth\":\"25\",\"name\":\"total-events-tile\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| summarize count() by Category\\n| order by count_ desc\",\"size\":1,\"title\":\"Events by Category\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"events-by-category\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| summarize count() by AuditEvent\\n| order by count_ desc\\n| limit 10\",\"size\":1,\"title\":\"Top 10 Audit Events\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"top-audit-events\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"Group: Overview\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"User Analysis\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"user-selection-method\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"UserSelectionMethod\",\"label\":\"Select User Method\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"showDefault\":false},\"jsonData\":\"[\\n {\\\"value\\\": \\\"name\\\", \\\"label\\\": \\\"Select User by Name\\\", \\\"selected\\\":true },\\n {\\\"value\\\": \\\"search\\\", \\\"label\\\": \\\"Search User\\\"}\\n]\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"user-selection-method\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"selected-username\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectedUsername\",\"label\":\"Select User\",\"type\":2,\"isRequired\":true,\"query\":\"KeeperSecurityEventNewLogs_CL\\n| where TimeGenerated {TimeRange:query}\\n| where isnotempty(Username)\\n| summarize Count = count() by Username\\n| order by Count desc, Username asc\\n| project Value = Username, Label = strcat(Username, ' - ', Count, ' events'), Selected = false\",\"typeSettings\":{\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"\"}],\"style\":\"above\",\"doNotRunWhenHidden\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"UserSelectionMethod\",\"comparison\":\"isEqualTo\",\"value\":\"name\"},\"name\":\"user-selection-dropdown\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| where Username == '{SelectedUsername:query}'\\n| where isnotempty(RemoteAddress)\\n| extend GeoIP = geo_info_from_ip_address(RemoteAddress)\\n| extend Country = tostring(GeoIP.country), City = tostring(GeoIP.city)\\n| extend Latitude = toreal(GeoIP.latitude), Longitude = toreal(GeoIP.longitude)\\n| where isnotempty(Country) and isnotempty(Latitude)\\n| summarize EventCount = count() by Country, City, Latitude, Longitude\\n| order by EventCount desc\\n\",\"size\":0,\"title\":\"User Geographic Activity:\",\"timeContextFromParameter\":\"TimeRange\",\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"EventCount\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"City\",\"legendMetric\":\"EventCount\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"EventCount\",\"heatmapPalette\":\"categorical\"}}},\"customWidth\":\"50\",\"name\":\"user-geographic-activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| where Username == '{SelectedUsername:query}'\\n| summarize count() by bin(TimeGenerated, 1h)\\n| order by TimeGenerated asc\",\"size\":1,\"title\":\"User Activity Pattern: {SelectedUsername}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"user-activity-pattern\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| where Username == '{SelectedUsername:query}'\\n| extend GeoIP = geo_info_from_ip_address(RemoteAddress)\\n| extend Country = tostring(GeoIP.country), City = tostring(GeoIP.city)\\n| project TimeGenerated, Username, AuditEvent, Category, RemoteAddress, City, Country, ClientVersion, Data\\n| order by TimeGenerated desc\",\"size\":1,\"title\":\"Detailed Activity for User: {SelectedUsername}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6},{\"columnMatch\":\"RemoteAddress\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"representation\":\"gray\"}]}}],\"filter\":true}},\"name\":\"user-detailed-activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| where Username == '{SelectedUsername:query}'\\n| summarize count() by Category\\n| order by count_ desc\",\"size\":4,\"title\":\"Event Categories for {SelectedUsername}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"user-event-categories\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| where Username == '{SelectedUsername}'\\n| summarize count() by AuditEvent\\n| order by count_ desc\\n| limit 10\",\"size\":4,\"title\":\"Top Audit Events: {SelectedUsername}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"user-top-events\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"UserAnalysis\"},\"name\":\"Group: UserAnalysis\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Security Events\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| extend GeoIP = geo_info_from_ip_address(RemoteAddress)\\n| extend Country = tostring(GeoIP.country)\\n| where isnotempty(Country)\\n| summarize UniqueUsers = dcount(Username), TotalEvents = count() by Country\\n| order by TotalEvents desc\\n| limit 20\",\"size\":1,\"title\":\"Security Events by Country\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalEvents\",\"formatter\":3,\"formatOptions\":{\"palette\":\"greenRed\"}},{\"columnMatch\":\"UniqueUsers\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blue\"}}]}},\"customWidth\":\"50\",\"name\":\"security-events-by-country\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| summarize EventCount = count() by Username\\n| order by EventCount desc\\n| limit 20\",\"size\":1,\"title\":\"Most Active Users\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"most-active-users\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| extend Hour = datetime_part('hour', TimeGenerated)\\n| summarize EventCount = count() by Hour\\n| order by Hour asc\",\"size\":1,\"title\":\"Activity by Hour of Day\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"columnchart\"},\"name\":\"activity-by-hour\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"KeeperSecurityEventNewLogs_CL\\n| summarize EventCount = count() by RemoteAddress\\n| order by EventCount desc\\n| limit 20\",\"size\":1,\"title\":\"Top Source IP Addresses\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"RemoteAddress\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"representation\":\"gray\"}]}},{\"columnMatch\":\"EventCount\",\"formatter\":3,\"formatOptions\":{\"palette\":\"greenRed\"}}]}},\"name\":\"top-source-ips\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"SecurityEvents\"},\"name\":\"Group: SecurityEvents\"}],\"fromTemplateId\":\"sentinel-KeeperSecurityDashboard\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=KeeperSecurityDashboard; logoFileName=keeper_security.svg; description=This workbook contains visualizations and insights in the Keeper Security environment.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Keeper Security Dashboard; templateRelativePath=KeeperSecurityDashboard.json; subtitle=; provider=Keeper Security}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Keeper Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Joao Paulo Oliveira Santos",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Keeper Security",
                  "email": "support@keepersecurity.com",
                  "tier": "Partner",
                  "link": "https://www.keepersecurity.com"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "KeeperSecurityEventNewLogs_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "KeeperSecurityPush2",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.1",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Keeper Security",
        "publisherDisplayName": "Keeper Security",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>• Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Keeper%20Security/ReleaseNotes.md\">Release Notes</a></p>\n<p>• There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href=\"https://keepersecurity.com/\">Keeper Security</a> solution for Microsoft Sentinel enables you to ingest <a href=\"https://keepersecurity.com/\">Keeper Security</a> forwarded into Microsoft Sentinel using the Microsoft Sentinel Analytics Workspace.</p>\n<p><strong>Data Connectors:</strong> 1, <strong>Workbooks:</strong> 1, <strong>Analytic Rules:</strong> 2</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/keeper_security.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Keeper Security",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Joao Paulo Oliveira Santos",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Keeper Security",
          "email": "support@keepersecurity.com",
          "tier": "Partner",
          "link": "https://www.keepersecurity.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            }
          ]
        },
        "firstPublishDate": "2025-06-03",
        "lastPublishDate": "2025-06-03",
        "providers": [
          "Keeper Security"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection",
            "Security - Information Protection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
