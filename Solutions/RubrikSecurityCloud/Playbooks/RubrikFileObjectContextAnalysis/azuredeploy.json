{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "title": "Rubrik File Object Context Analysis",
        "description": "This playbook will retrieve policy hits from Rubrik Security Cloud for a given object, for a particular file, folder, or file share.",
        "prerequisites": [
            "1. The Rubrik Security Cloud solution should be configured to [connect to Rubrik Security Cloud API end points using a Service Account](https://docs.rubrik.com/en-us/saas/saas/polaris_api_access_with_service_accounts.html), the service account should be assigned a role that includes the relevant privileges necessary to perform the desired operations (see [Roles and Permissions](https://docs.rubrik.com/en-us/saas/saas/common/roles_and_permissions.html) in the Rubrik Security Cloud user guide).",
            "2. Obtain Teams GroupId and ChannelId",
            "a. Create a Team with public channel.",
            "b. Click on three dots (...) present on right side of the your newly created teams channel and Get link to the channel.",
            "c. copy the text from the link between /channel and /, decode it using online url decoder and copy it to use as channelId.",
            "d. copy the text of groupId parameter from link to use as groupId. ",
            "3. Store Service account credentials in Key Vault and obtain keyvault name and tenantId",
            "a. Create a Key Vault with unique name",
            "b. Go to KeyVault -> secrets, click on Generate/import and create 'Rubrik-AS-Int-ClientId' & 'Rubrik-AS-Int-ClientSecret' for storing client_id and client_secret respectively",
            "NOTE: Make sure Permission model in Access Configuration of Keyvault is selected to Vault access policy. If not then change it to 'Vault access policy'"
        ],
        "postDeployment": [
            "**a. Authorize connections**",
            "Once deployment is complete, authorize each connection.",
            "1. Go to your logic app -> API connections -> Select keyvault connection resource",
            "2. Go to General -> edit API connection",
            "3. Click the Keyvault connection resource",
            "4. Click edit API connection",
            "5. Click Authorize",
            "6. Sign in",
            "7. Click Save",
            "8. Repeat steps for other connections",
            "**b. Add Access policy in Keyvault**",
            "Add access policy for playbook's managed identity to read, write secrets of keyvault.",
            "1. Go to logic app → <your logic app> → identity → System assigned Managed identity and copy Object (principal) ID.",
            "2. Go to keyvaults → <your keyvault> → Access policies → create.",
            "3. Select all keys & secrets permissions. Click next.",
            "4. In principal section, search by copied object ID. Click next.",
            "5. Click review + create."
        ],
        "lastUpdateTime": "2024-04-22T00:14:08.736Z",
        "entities": [
            "account",
            "url"
        ],
        "tags": [
            "File Object",
            "Policy Hits",
            "Security",
            "Rubrik"
        ],
        "support": {
            "tier": "community",
            "armtemplate": "Generated from https://github.com/Azure/Azure-Sentinel/tree/master/Tools/Playbook-ARM-Template-Generator"
        },
        "author": {
            "name": "Rubrik"
        }
    },
    "parameters": {
        "PlaybookName": {
            "defaultValue": "RubrikFileObjectContextAnalysis",
            "minLength": 1,
            "type": "string",
            "metadata": {
                "description": "Please do not keep 'PlaybookName' parameter empty, else you will receive validation failure"
            }
        },
        "TeamsGroupId": {
            "type": "string",
            "metadata": {
                "description": "Enter Id of the Teams Group where the adaptive card will be posted"
            }
        },
        "TeamsChannelId": {
            "type": "string",
            "metadata": {
                "description": "Enter Id of the Teams Channel where the adaptive card will be posted"
            }
        },
        "KeyvaultName": {
            "type": "string",
            "metadata": {
                "description": "Enter name of keyvault where service account credentials are stored.(e.g. RubrikSentinelKeyVault)"
            }
        },
        "TenantId": {
            "type": "string",
            "metadata": {
                "description": "Enter Tenant Id of your Microsoft EntraID where keyvault is available"
            }
        },
        "BaseUrl": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Base Url of the RubrikApi instance(e.g. https://rubrik-rcf-32348.my.rubrik.com)"
            }
        },
        "LogAnalyticsWorkspaceId": {
            "type": "string",
            "metadata": {
                "description": "Id of log analytics workspace where you want to ingest data in Microsoft Sentinel"
            }
        },
        "LogAnalyticsWorkspaceKey": {
            "type": "securestring",
            "metadata": {
                "description": "PrimaryKey of log analytics workspace where you want to ingest data in Microsoft Sentinel"
            }
        },
        "PolicyHitsTableName": {
            "type": "string",
            "metadata": {
                "description": "Table name in which you want to store policy hits data in log analytics workspace(e.g. Rubrik_File_Object_Policy_Hits)"
            }
        }
    },
    "variables": {
        "AzureloganalyticsdatacollectorConnectionName": "[concat('Azureloganalyticsdatacollector-', parameters('PlaybookName'))]",
        "KeyvaultConnectionName": "[concat('Keyvault-', parameters('PlaybookName'))]",
        "TeamsConnectionName": "[concat('Teams-', parameters('PlaybookName'))]"
    },
    "resources": [
        {
            "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"
                        },
                        "Baseurl": {
                            "type": "string",
                            "defaultValue": "[parameters('Baseurl')]"
                        }
                    },
                    "triggers": {
                        "manual": {
                            "type": "Request",
                            "kind": "Http",
                            "inputs": {
                                "schema": {
                                    "properties": {
                                        "Baseurl": {
                                            "type": "string"
                                        },
                                        "ObjectId": {
                                            "type": "string"
                                        },
                                        "ObjectName": {
                                            "type": "string"
                                        },
                                        "ObjectType": {
                                            "type": "string"
                                        },
                                        "incidentStartTime": {
                                            "type": "string"
                                        }
                                    },
                                    "type": "object"
                                }
                            }
                        }
                    },
                    "actions": {
                        "Check_if_nextPage_available": {
                            "actions": {
                                "Until_all_policy_hits_data_retrieved": {
                                    "actions": {
                                        "Does_status_code_to_get_policy_hits_get_status_code_equal_to_200": {
                                            "actions": {
                                                "Does_get_policy_hits_response_contain_error": {
                                                    "actions": {
                                                        "Set_errorMessage_as_response_contain_error": {
                                                            "runAfter": {
                                                                "Set_hasNextPage_to_false_as_response_contain_error": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "errorMessage",
                                                                "value": "@{body('Get_policy_hits_for_file_based_object')?['errors'][0]?['message']}"
                                                            }
                                                        },
                                                        "Set_hasNextPage_to_false_as_response_contain_error": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "hasNextPage",
                                                                "value": false
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {},
                                                    "else": {
                                                        "actions": {
                                                            "Check_if_nextPage_exist": {
                                                                "actions": {
                                                                    "Set_hasNextPage_to_true": {
                                                                        "runAfter": {},
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "hasNextPage",
                                                                            "value": "@body('Parse_policy_hits_json_response')?['data']?['policyObj']?['fileResultConnection']?['pageInfo']?['hasNextPage']"
                                                                        }
                                                                    },
                                                                    "Set_variables_for_pagination": {
                                                                        "runAfter": {
                                                                            "Set_hasNextPage_to_true": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "variables",
                                                                            "value": {
                                                                                "after": "@{body('Parse_policy_hits_json_response')?['data']?['policyObj']?['fileResultConnection']?['pageInfo']?['endCursor']}",
                                                                                "filters": {
                                                                                    "analyzerGroupIds": [],
                                                                                    "fileType": "HITS",
                                                                                    "searchText": "@{body('Get_file_folder_or_fileshare_from_user_for_given_Object')?['data']?['searchText']}",
                                                                                    "snappablePaths": [
                                                                                        {
                                                                                            "snappableFid": "@{variables('objectId')}",
                                                                                            "stdPath": "@{body('Get_file_folder_or_fileshare_from_user_for_given_Object')?['data']?['filePath']}"
                                                                                        }
                                                                                    ],
                                                                                    "whitelistEnabled": true
                                                                                },
                                                                                "first": 100,
                                                                                "snappableFid": "@{variables('objectId')}",
                                                                                "snapshotFid": "@{variables('snapshotId')}",
                                                                                "sort": {
                                                                                    "sortBy": "HITS",
                                                                                    "sortOrder": "DESC"
                                                                                },
                                                                                "timezone": "America/Los_Angeles"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "Set_policy_hits_data_to_null": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "else": {
                                                                    "actions": {
                                                                        "Set_hasNextPage_to_false": {
                                                                            "runAfter": {},
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "hasNextPage",
                                                                                "value": "@body('Parse_policy_hits_json_response')?['data']?['policyObj']?['fileResultConnection']?['pageInfo']?['hasNextPage']"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "expression": {
                                                                    "and": [
                                                                        {
                                                                            "equals": [
                                                                                "@body('Parse_policy_hits_json_response')?['data']?['policyObj']?['fileResultConnection']?['pageInfo']?['hasNextPage']",
                                                                                "@true"
                                                                            ]
                                                                        }
                                                                    ]
                                                                },
                                                                "type": "If"
                                                            },
                                                            "Compose": {
                                                                "runAfter": {
                                                                    "For_each": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Compose",
                                                                "inputs": "@variables('policyhits')"
                                                            },
                                                            "For_each": {
                                                                "foreach": "@body('Parse_policy_hits_json_response')?['data']?['policyObj']?['fileResultConnection']?['edges']",
                                                                "actions": {
                                                                    "Append_objectId_to_policy_hits_data": {
                                                                        "runAfter": {},
                                                                        "type": "AppendToArrayVariable",
                                                                        "inputs": {
                                                                            "name": "policyhits",
                                                                            "value": "@setProperty(items('For_each')?['node'], 'ObjectId', variables('objectId'))"
                                                                        }
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "Parse_policy_hits_json_response": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Foreach",
                                                                "runtimeConfiguration": {
                                                                    "concurrency": {
                                                                        "repetitions": 1
                                                                    }
                                                                }
                                                            },
                                                            "Parse_policy_hits_json_response": {
                                                                "runAfter": {},
                                                                "type": "ParseJson",
                                                                "inputs": {
                                                                    "content": "@body('Get_policy_hits_for_file_based_object')",
                                                                    "schema": {
                                                                        "properties": {
                                                                            "data": {
                                                                                "properties": {
                                                                                    "policyObj": {
                                                                                        "properties": {
                                                                                            "__typename": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "fileResultConnection": {
                                                                                                "properties": {
                                                                                                    "__typename": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "edges": {
                                                                                                        "items": {
                                                                                                            "properties": {
                                                                                                                "__typename": {
                                                                                                                    "type": "string"
                                                                                                                },
                                                                                                                "cursor": {
                                                                                                                    "type": "string"
                                                                                                                },
                                                                                                                "node": {
                                                                                                                    "properties": {
                                                                                                                        "__typename": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "analyzerGroupResults": {
                                                                                                                            "items": {
                                                                                                                                "properties": {
                                                                                                                                    "__typename": {
                                                                                                                                        "type": "string"
                                                                                                                                    },
                                                                                                                                    "analyzerGroup": {
                                                                                                                                        "properties": {
                                                                                                                                            "__typename": {
                                                                                                                                                "type": "string"
                                                                                                                                            },
                                                                                                                                            "groupType": {
                                                                                                                                                "type": "string"
                                                                                                                                            },
                                                                                                                                            "id": {
                                                                                                                                                "type": "string"
                                                                                                                                            },
                                                                                                                                            "name": {
                                                                                                                                                "type": "string"
                                                                                                                                            }
                                                                                                                                        },
                                                                                                                                        "type": [
                                                                                                                                            "object",
                                                                                                                                            "null"
                                                                                                                                        ]
                                                                                                                                    },
                                                                                                                                    "analyzerResults": {
                                                                                                                                        "items": {
                                                                                                                                            "properties": {
                                                                                                                                                "__typename": {
                                                                                                                                                    "type": "string"
                                                                                                                                                },
                                                                                                                                                "analyzer": {
                                                                                                                                                    "properties": {
                                                                                                                                                        "__typename": {
                                                                                                                                                            "type": "string"
                                                                                                                                                        },
                                                                                                                                                        "analyzerType": {
                                                                                                                                                            "type": "string"
                                                                                                                                                        },
                                                                                                                                                        "id": {
                                                                                                                                                            "type": "string"
                                                                                                                                                        },
                                                                                                                                                        "name": {
                                                                                                                                                            "type": "string"
                                                                                                                                                        }
                                                                                                                                                    },
                                                                                                                                                    "type": [
                                                                                                                                                        "object",
                                                                                                                                                        "null"
                                                                                                                                                    ]
                                                                                                                                                },
                                                                                                                                                "hits": {
                                                                                                                                                    "properties": {
                                                                                                                                                        "__typename": {
                                                                                                                                                            "type": "string"
                                                                                                                                                        },
                                                                                                                                                        "totalHits": {
                                                                                                                                                            "type": "integer"
                                                                                                                                                        },
                                                                                                                                                        "violations": {
                                                                                                                                                            "type": "integer"
                                                                                                                                                        }
                                                                                                                                                    },
                                                                                                                                                    "type": [
                                                                                                                                                        "object",
                                                                                                                                                        "null"
                                                                                                                                                    ]
                                                                                                                                                }
                                                                                                                                            },
                                                                                                                                            "type": "object"
                                                                                                                                        },
                                                                                                                                        "type": "array"
                                                                                                                                    },
                                                                                                                                    "hits": {
                                                                                                                                        "properties": {
                                                                                                                                            "__typename": {
                                                                                                                                                "type": "string"
                                                                                                                                            },
                                                                                                                                            "totalHits": {
                                                                                                                                                "type": "integer"
                                                                                                                                            },
                                                                                                                                            "totalHitsDelta": {
                                                                                                                                                "type": "integer"
                                                                                                                                            },
                                                                                                                                            "violations": {
                                                                                                                                                "type": "integer"
                                                                                                                                            },
                                                                                                                                            "violationsDelta": {
                                                                                                                                                "type": "integer"
                                                                                                                                            }
                                                                                                                                        },
                                                                                                                                        "type": [
                                                                                                                                            "object",
                                                                                                                                            "null"
                                                                                                                                        ]
                                                                                                                                    }
                                                                                                                                },
                                                                                                                                "type": "object"
                                                                                                                            },
                                                                                                                            "type": "array"
                                                                                                                        },
                                                                                                                        "directory": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "errorCode": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "filename": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "filesWithHits": {
                                                                                                                            "properties": {
                                                                                                                                "__typename": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "totalHits": {
                                                                                                                                    "type": "integer"
                                                                                                                                },
                                                                                                                                "violations": {
                                                                                                                                    "type": "integer"
                                                                                                                                }
                                                                                                                            },
                                                                                                                            "type": [
                                                                                                                                "object",
                                                                                                                                "null"
                                                                                                                            ]
                                                                                                                        },
                                                                                                                        "hits": {
                                                                                                                            "properties": {
                                                                                                                                "__typename": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "totalHits": {
                                                                                                                                    "type": "integer"
                                                                                                                                },
                                                                                                                                "totalHitsDelta": {
                                                                                                                                    "type": "integer"
                                                                                                                                },
                                                                                                                                "violations": {
                                                                                                                                    "type": "integer"
                                                                                                                                },
                                                                                                                                "violationsDelta": {
                                                                                                                                    "type": "integer"
                                                                                                                                }
                                                                                                                            },
                                                                                                                            "type": [
                                                                                                                                "object",
                                                                                                                                "null"
                                                                                                                            ]
                                                                                                                        },
                                                                                                                        "lastAccessTime": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "lastModifiedTime": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "mode": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "nativePath": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "numActivities": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "numActivitiesDelta": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "numDescendantErrorFiles": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "numDescendantFiles": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "numDescendantSkippedExtFiles": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "numDescendantSkippedSizeFiles": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "openAccessFilesWithHits": {
                                                                                                                            "properties": {
                                                                                                                                "__typename": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "totalHits": {
                                                                                                                                    "type": "integer"
                                                                                                                                },
                                                                                                                                "violations": {
                                                                                                                                    "type": "integer"
                                                                                                                                }
                                                                                                                            },
                                                                                                                            "type": [
                                                                                                                                "object",
                                                                                                                                "null"
                                                                                                                            ]
                                                                                                                        },
                                                                                                                        "openAccessType": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "sensitiveFiles": {
                                                                                                                            "properties": {
                                                                                                                                "__typename": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "highRiskFileCount": {
                                                                                                                                    "properties": {
                                                                                                                                        "__typename": {
                                                                                                                                            "type": "string"
                                                                                                                                        },
                                                                                                                                        "totalCount": {
                                                                                                                                            "type": "integer"
                                                                                                                                        },
                                                                                                                                        "violatedCount": {
                                                                                                                                            "type": "integer"
                                                                                                                                        }
                                                                                                                                    },
                                                                                                                                    "type": "object"
                                                                                                                                },
                                                                                                                                "lowRiskFileCount": {
                                                                                                                                    "properties": {
                                                                                                                                        "__typename": {
                                                                                                                                            "type": "string"
                                                                                                                                        },
                                                                                                                                        "totalCount": {
                                                                                                                                            "type": "integer"
                                                                                                                                        },
                                                                                                                                        "violatedCount": {
                                                                                                                                            "type": "integer"
                                                                                                                                        }
                                                                                                                                    },
                                                                                                                                    "type": "object"
                                                                                                                                },
                                                                                                                                "mediumRiskFileCount": {
                                                                                                                                    "properties": {
                                                                                                                                        "__typename": {
                                                                                                                                            "type": "string"
                                                                                                                                        },
                                                                                                                                        "totalCount": {
                                                                                                                                            "type": "integer"
                                                                                                                                        },
                                                                                                                                        "violatedCount": {
                                                                                                                                            "type": "integer"
                                                                                                                                        }
                                                                                                                                    },
                                                                                                                                    "type": "object"
                                                                                                                                }
                                                                                                                            },
                                                                                                                            "type": [
                                                                                                                                "object",
                                                                                                                                "null"
                                                                                                                            ]
                                                                                                                        },
                                                                                                                        "size": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "staleFilesWithHits": {
                                                                                                                            "properties": {
                                                                                                                                "__typename": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "totalHits": {
                                                                                                                                    "type": "integer"
                                                                                                                                },
                                                                                                                                "violations": {
                                                                                                                                    "type": "integer"
                                                                                                                                }
                                                                                                                            },
                                                                                                                            "type": [
                                                                                                                                "object",
                                                                                                                                "null"
                                                                                                                            ]
                                                                                                                        },
                                                                                                                        "stalenessType": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "stdPath": {
                                                                                                                            "type": "string"
                                                                                                                        }
                                                                                                                    },
                                                                                                                    "type": "object"
                                                                                                                }
                                                                                                            },
                                                                                                            "required": [
                                                                                                                "cursor",
                                                                                                                "node",
                                                                                                                "__typename"
                                                                                                            ],
                                                                                                            "type": "object"
                                                                                                        },
                                                                                                        "type": "array"
                                                                                                    },
                                                                                                    "pageInfo": {
                                                                                                        "properties": {
                                                                                                            "__typename": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "endCursor": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "hasNextPage": {
                                                                                                                "type": "boolean"
                                                                                                            }
                                                                                                        },
                                                                                                        "type": "object"
                                                                                                    }
                                                                                                },
                                                                                                "type": "object"
                                                                                            },
                                                                                            "id": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        },
                                                                                        "type": "object"
                                                                                    }
                                                                                },
                                                                                "type": "object"
                                                                            }
                                                                        },
                                                                        "type": "object"
                                                                    }
                                                                }
                                                            },
                                                            "Send_Policy_Hits_data_to_log_analytics": {
                                                                "runAfter": {
                                                                    "Compose": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection",
                                                                "inputs": {
                                                                    "body": "@{outputs('Compose')}",
                                                                    "headers": {
                                                                        "Log-Type": "Rubrik_File_Object_Policy_Hits_Test1601"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "post",
                                                                    "path": "/api/logs"
                                                                }
                                                            },
                                                            "Set_dataFound_to_true": {
                                                                "runAfter": {
                                                                    "Send_Policy_Hits_data_to_log_analytics": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "dataFound",
                                                                    "value": "@true"
                                                                }
                                                            },
                                                            "Set_policy_hits_data_to_null": {
                                                                "runAfter": {
                                                                    "Set_dataFound_to_true": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "policyhits",
                                                                    "value": "@null"
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "contains": [
                                                                    "@body('Get_policy_hits_for_file_based_object')",
                                                                    "errors"
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "type": "If"
                                                }
                                            },
                                            "runAfter": {
                                                "Get_policy_hits_for_file_based_object": [
                                                    "Succeeded",
                                                    "Failed"
                                                ]
                                            },
                                            "else": {
                                                "actions": {
                                                    "Set_errorMessage_as_status_code_is_not_equal_to_200": {
                                                        "runAfter": {
                                                            "Set_hasNextPage": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "errorMessage",
                                                            "value": "@{body('Get_policy_hits_for_file_based_object')?['message']}"
                                                        }
                                                    },
                                                    "Set_hasNextPage": {
                                                        "runAfter": {},
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "hasNextPage",
                                                            "value": "@false"
                                                        }
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@outputs('Get_policy_hits_for_file_based_object')['statusCode']",
                                                            200
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Get_policy_hits_for_file_based_object": {
                                            "runAfter": {},
                                            "type": "Http",
                                            "inputs": {
                                                "body": {
                                                    "query": "query CrawlsFileListQuery($snappableFid: String!, $snapshotFid: String!, $first: Int!, $after: String, $filters: ListFileResultFiltersInput, $sort: FileResultSortInput, $timezone: String!) {\r\n  policyObj(snappableFid: $snappableFid, snapshotFid: $snapshotFid) {\r\n    id: snapshotFid\r\n    fileResultConnection(first: $first, after: $after, filter: $filters, sort: $sort, timezone: $timezone) {\r\n      edges {\r\n        cursor\r\n        node {\r\n          ...DiscoveryFileFragment\r\n          __typename\r\n        }\r\n        __typename\r\n      }\r\n      pageInfo {\r\n        endCursor\r\n        hasNextPage\r\n        __typename\r\n      }\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n}\r\n\r\nfragment DiscoveryFileFragment on FileResult {\r\n  nativePath\r\n  stdPath\r\n  filename\r\n  mode\r\n  size\r\n  lastAccessTime\r\n  lastModifiedTime\r\n  directory\r\n  numDescendantFiles\r\n  numDescendantErrorFiles\r\n  numDescendantSkippedExtFiles\r\n  numDescendantSkippedSizeFiles\r\n  errorCode\r\n  hits {\r\n    totalHits\r\n    violations\r\n    violationsDelta\r\n    totalHitsDelta\r\n    __typename\r\n  }\r\n  filesWithHits {\r\n    totalHits\r\n    violations\r\n    __typename\r\n  }\r\n  openAccessFilesWithHits {\r\n    totalHits\r\n    violations\r\n    __typename\r\n  }\r\n  staleFilesWithHits {\r\n    totalHits\r\n    violations\r\n    __typename\r\n  }\r\n  analyzerGroupResults {\r\n    ...AnalyzerGroupResultFragment\r\n    __typename\r\n  }\r\n  sensitiveFiles {\r\n    highRiskFileCount {\r\n      totalCount\r\n      violatedCount\r\n      __typename\r\n    }\r\n    mediumRiskFileCount {\r\n      totalCount\r\n      violatedCount\r\n      __typename\r\n    }\r\n    lowRiskFileCount {\r\n      totalCount\r\n      violatedCount\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  openAccessType\r\n  stalenessType\r\n  numActivities\r\n  numActivitiesDelta\r\n  __typename\r\n}\r\n\r\nfragment AnalyzerGroupResultFragment on AnalyzerGroupResult {\r\n  analyzerGroup {\r\n    groupType\r\n    id\r\n    name\r\n    __typename\r\n  }\r\n  analyzerResults {\r\n    hits {\r\n      totalHits\r\n      violations\r\n      __typename\r\n    }\r\n    analyzer {\r\n      id\r\n      name\r\n      analyzerType\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  hits {\r\n    totalHits\r\n    violations\r\n    violationsDelta\r\n    totalHitsDelta\r\n    __typename\r\n  }\r\n  __typename\r\n}",
                                                    "variables": "@variables('variables')"
                                                },
                                                "headers": {
                                                    "Authorization": "Bearer @{variables('accessToken')}"
                                                },
                                                "method": "POST",
                                                "uri": "@{variables('BaseUrl')}/api/graphql"
                                            }
                                        }
                                    },
                                    "runAfter": {},
                                    "expression": "@equals(variables('hasNextPage'), false)",
                                    "limit": {
                                        "timeout": "PT12H"
                                    },
                                    "type": "Until"
                                }
                            },
                            "runAfter": {
                                "Until_snapshotFound_with_policy_hits": [
                                    "Succeeded"
                                ]
                            },
                            "expression": {
                                "and": [
                                    {
                                        "equals": [
                                            "@variables('hasNextPage')",
                                            "@true"
                                        ]
                                    }
                                ]
                            },
                            "type": "If"
                        },
                        "Does_ObjectId_available_in_request": {
                            "actions": {},
                            "runAfter": {
                                "Initialize_access_token": [
                                    "Succeeded"
                                ]
                            },
                            "else": {
                                "actions": {
                                    "Does_object_list_request_get_status_code_equal_to_200_": {
                                        "actions": {
                                            "Does_object_list_response_contain_error": {
                                                "actions": {
                                                    "Terminate_as_object_list_api_response_contain_errors": {
                                                        "runAfter": {
                                                            "failure_as_object_list_api_response_contain_errors": [
                                                                "Succeeded",
                                                                "Skipped",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Terminate",
                                                        "inputs": {
                                                            "runError": {
                                                                "message": "@{body('Get_Object_List')?['errors'][0]?['message']}"
                                                            },
                                                            "runStatus": "Failed"
                                                        }
                                                    },
                                                    "failure_as_object_list_api_response_contain_errors": {
                                                        "runAfter": {},
                                                        "type": "Response",
                                                        "kind": "Http",
                                                        "inputs": {
                                                            "body": "@body('Get_Object_List')?['errors'][0]?['message']",
                                                            "statusCode": 200
                                                        }
                                                    }
                                                },
                                                "runAfter": {},
                                                "else": {
                                                    "actions": {
                                                        "Does_response_contain_object_data": {
                                                            "actions": {},
                                                            "runAfter": {
                                                                "Parse_JSON_object_list": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "else": {
                                                                "actions": {
                                                                    "Respond_as_no_object_detail_found": {
                                                                        "runAfter": {},
                                                                        "type": "Response",
                                                                        "kind": "Http",
                                                                        "inputs": {
                                                                            "body": "No such object details are availble for @{body('Get_objectName_from_user')?['data']?['objectName']} in rubrik",
                                                                            "statusCode": 200
                                                                        }
                                                                    },
                                                                    "Terminate_as_no_object_detail_found": {
                                                                        "runAfter": {
                                                                            "Respond_as_no_object_detail_found": [
                                                                                "Succeeded",
                                                                                "Skipped",
                                                                                "Failed"
                                                                            ]
                                                                        },
                                                                        "type": "Terminate",
                                                                        "inputs": {
                                                                            "runError": {
                                                                                "message": "No such object details are availble for @{body('Get_objectName_from_user')?['data']?['objectName']} in rubrik"
                                                                            },
                                                                            "runStatus": "Failed"
                                                                        }
                                                                    }
                                                                }
                                                            },
                                                            "expression": {
                                                                "and": [
                                                                    {
                                                                        "equals": [
                                                                            "@empty(body('Parse_JSON_object_list')?['data']?['policyObjs']?['edges'])",
                                                                            "@false"
                                                                        ]
                                                                    }
                                                                ]
                                                            },
                                                            "type": "If"
                                                        },
                                                        "For_each_object": {
                                                            "foreach": "@body('Parse_JSON_object_list')?['data']?['policyObjs']?['edges']",
                                                            "actions": {
                                                                "Set_objectId": {
                                                                    "runAfter": {},
                                                                    "type": "SetVariable",
                                                                    "inputs": {
                                                                        "name": "objectId",
                                                                        "value": "@items('For_each_object')?['node']?['snappable']?['id']"
                                                                    }
                                                                }
                                                            },
                                                            "runAfter": {
                                                                "Does_response_contain_object_data": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "Foreach",
                                                            "runtimeConfiguration": {
                                                                "concurrency": {
                                                                    "repetitions": 1
                                                                }
                                                            }
                                                        },
                                                        "Parse_JSON_object_list": {
                                                            "runAfter": {},
                                                            "type": "ParseJson",
                                                            "inputs": {
                                                                "content": "@body('Get_Object_List')",
                                                                "schema": {
                                                                    "properties": {
                                                                        "data": {
                                                                            "properties": {
                                                                                "policyObjs": {
                                                                                    "properties": {
                                                                                        "__typename": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "edges": {
                                                                                            "items": {
                                                                                                "properties": {
                                                                                                    "__typename": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "cursor": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "node": {
                                                                                                        "properties": {
                                                                                                            "__typename": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "accessRiskReasons": {
                                                                                                                "items": {
                                                                                                                    "type": "string"
                                                                                                                },
                                                                                                                "type": "array"
                                                                                                            },
                                                                                                            "analysisStatus": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "hasInsights": {
                                                                                                                "type": "boolean"
                                                                                                            },
                                                                                                            "id": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "isUserAccessEnabledObject": {
                                                                                                                "type": "boolean"
                                                                                                            },
                                                                                                            "riskLevel": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "rootFileResult": {
                                                                                                                "properties": {
                                                                                                                    "__typename": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "analyzerGroupResults": {
                                                                                                                        "items": {
                                                                                                                            "properties": {
                                                                                                                                "__typename": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "analyzerGroup": {
                                                                                                                                    "properties": {
                                                                                                                                        "__typename": {
                                                                                                                                            "type": "string"
                                                                                                                                        },
                                                                                                                                        "groupType": {
                                                                                                                                            "type": "string"
                                                                                                                                        },
                                                                                                                                        "id": {
                                                                                                                                            "type": "string"
                                                                                                                                        },
                                                                                                                                        "name": {
                                                                                                                                            "type": "string"
                                                                                                                                        }
                                                                                                                                    },
                                                                                                                                    "type": [
                                                                                                                                        "object",
                                                                                                                                        "null"
                                                                                                                                    ]
                                                                                                                                },
                                                                                                                                "analyzerResults": {
                                                                                                                                    "type": "array"
                                                                                                                                },
                                                                                                                                "hits": {
                                                                                                                                    "properties": {
                                                                                                                                        "__typename": {
                                                                                                                                            "type": "string"
                                                                                                                                        },
                                                                                                                                        "totalHits": {
                                                                                                                                            "type": "integer"
                                                                                                                                        },
                                                                                                                                        "totalHitsDelta": {
                                                                                                                                            "type": "integer"
                                                                                                                                        },
                                                                                                                                        "violations": {
                                                                                                                                            "type": "integer"
                                                                                                                                        },
                                                                                                                                        "violationsDelta": {
                                                                                                                                            "type": "integer"
                                                                                                                                        }
                                                                                                                                    },
                                                                                                                                    "type": [
                                                                                                                                        "object",
                                                                                                                                        "null"
                                                                                                                                    ]
                                                                                                                                }
                                                                                                                            },
                                                                                                                            "type": [
                                                                                                                                "object",
                                                                                                                                "null"
                                                                                                                            ]
                                                                                                                        },
                                                                                                                        "type": "array"
                                                                                                                    },
                                                                                                                    "filesWithHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "totalHitsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violations": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violationsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "hits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "totalHitsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violations": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violationsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "numActivities": {
                                                                                                                        "type": "integer"
                                                                                                                    },
                                                                                                                    "numActivitiesDelta": {
                                                                                                                        "type": "integer"
                                                                                                                    },
                                                                                                                    "openAccessFiles": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "totalHitsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violations": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violationsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "openAccessFilesWithHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "totalHitsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violations": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violationsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "openAccessFolders": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "totalHitsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violations": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violationsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "openAccessStaleFiles": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "totalHitsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violations": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violationsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "staleFiles": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "totalHitsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violations": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violationsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "staleFilesWithHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "totalHitsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violations": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violationsDelta": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    }
                                                                                                                },
                                                                                                                "type": [
                                                                                                                    "object",
                                                                                                                    "null"
                                                                                                                ]
                                                                                                            },
                                                                                                            "sensitiveFiles": {
                                                                                                                "properties": {
                                                                                                                    "__typename": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "highRiskFileCount": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalCount": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedCount": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "lowRiskFileCount": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalCount": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedCount": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "mediumRiskFileCount": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalCount": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedCount": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    }
                                                                                                                },
                                                                                                                "type": [
                                                                                                                    "object",
                                                                                                                    "null"
                                                                                                                ]
                                                                                                            },
                                                                                                            "shareType": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "snappable": {
                                                                                                                "properties": {
                                                                                                                    "__typename": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "cluster": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "id": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "name": {
                                                                                                                                "type": "string"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": "object"
                                                                                                                    },
                                                                                                                    "effectiveSlaDomain": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "id": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "name": {
                                                                                                                                "type": "string"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "id": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "logicalPath": {
                                                                                                                        "items": {
                                                                                                                            "properties": {
                                                                                                                                "__typename": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "fid": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "name": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "objectType": {
                                                                                                                                    "type": "string"
                                                                                                                                }
                                                                                                                            },
                                                                                                                            "type": [
                                                                                                                                "object",
                                                                                                                                "null"
                                                                                                                            ]
                                                                                                                        },
                                                                                                                        "type": "array"
                                                                                                                    },
                                                                                                                    "name": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "objectType": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "physicalPath": {
                                                                                                                        "items": {
                                                                                                                            "properties": {
                                                                                                                                "__typename": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "fid": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "name": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "objectType": {
                                                                                                                                    "type": "string"
                                                                                                                                }
                                                                                                                            },
                                                                                                                            "type": [
                                                                                                                                "object",
                                                                                                                                "null"
                                                                                                                            ]
                                                                                                                        },
                                                                                                                        "type": "array"
                                                                                                                    },
                                                                                                                    "slaAssignment": {
                                                                                                                        "type": "string"
                                                                                                                    }
                                                                                                                },
                                                                                                                "type": "object"
                                                                                                            },
                                                                                                            "snapshotFid": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "snapshotTimestamp": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "userCounts": {
                                                                                                                "properties": {
                                                                                                                    "__typename": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "highRiskCount": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalCount": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedCount": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "lowRiskCount": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalCount": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedCount": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "mediumRiskCount": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalCount": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedCount": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    }
                                                                                                                },
                                                                                                                "type": [
                                                                                                                    "object",
                                                                                                                    "null"
                                                                                                                ]
                                                                                                            }
                                                                                                        },
                                                                                                        "type": "object"
                                                                                                    }
                                                                                                },
                                                                                                "required": [
                                                                                                    "cursor",
                                                                                                    "node",
                                                                                                    "__typename"
                                                                                                ],
                                                                                                "type": "object"
                                                                                            },
                                                                                            "type": "array"
                                                                                        },
                                                                                        "pageInfo": {
                                                                                            "properties": {
                                                                                                "__typename": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "endCursor": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "hasNextPage": {
                                                                                                    "type": "boolean"
                                                                                                },
                                                                                                "hasPreviousPage": {
                                                                                                    "type": "boolean"
                                                                                                },
                                                                                                "startCursor": {
                                                                                                    "type": "string"
                                                                                                }
                                                                                            },
                                                                                            "type": "object"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                }
                                                            }
                                                        }
                                                    }
                                                },
                                                "expression": {
                                                    "and": [
                                                        {
                                                            "contains": [
                                                                "@body('Get_Object_List')",
                                                                "errors"
                                                            ]
                                                        }
                                                    ]
                                                },
                                                "type": "If"
                                            }
                                        },
                                        "runAfter": {
                                            "Get_Object_List": [
                                                "Succeeded",
                                                "Failed"
                                            ]
                                        },
                                        "else": {
                                            "actions": {
                                                "Failure_respone_as_object_list_request_failed": {
                                                    "runAfter": {},
                                                    "type": "Response",
                                                    "kind": "Http",
                                                    "inputs": {
                                                        "body": "@body('Get_Object_List')?['message']",
                                                        "statusCode": "@outputs('Get_Object_List')['statusCode']"
                                                    }
                                                },
                                                "Terminate_as_object_list_api_request_failed": {
                                                    "runAfter": {
                                                        "Failure_respone_as_object_list_request_failed": [
                                                            "Succeeded",
                                                            "Skipped",
                                                            "Failed"
                                                        ]
                                                    },
                                                    "type": "Terminate",
                                                    "inputs": {
                                                        "runError": {
                                                            "code": "@{outputs('Get_Object_List')['statusCode']}",
                                                            "message": "@{body('Get_Object_List')?['message']}"
                                                        },
                                                        "runStatus": "Failed"
                                                    }
                                                }
                                            }
                                        },
                                        "expression": {
                                            "and": [
                                                {
                                                    "equals": [
                                                        "@outputs('Get_Object_List')['statusCode']",
                                                        200
                                                    ]
                                                }
                                            ]
                                        },
                                        "type": "If"
                                    },
                                    "Get_Object_List": {
                                        "runAfter": {
                                            "Set_objectName": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "body": {
                                                "query": "query ObjectsListTableQuery($day: String!, $timezone: String!, $objectTypes: [DataGovObjectType!]!, $searchObjectName: String, $sortBy: String, $sortOrder: SortOrder, $analysisStatusesFilter: [AnalysisStatus!], $policyIdsFilter: [String!], $riskLevelsFilter: [RiskLevelType!], $clusterIdsFilter: [String!], $subscriptionIdsFilter: [String!], $includeWhitelistedResults: Boolean, $first: Int!, $after: String, $includeInsightsMarker: Boolean) {\r\n  policyObjs(\r\n    day: $day\r\n    timezone: $timezone\r\n    workloadTypes: $objectTypes\r\n    searchObjectName: $searchObjectName\r\n    sortBy: $sortBy\r\n    sortOrder: $sortOrder\r\n    analysisStatusesFilter: $analysisStatusesFilter\r\n    policyIdsFilter: $policyIdsFilter\r\n    riskLevelsFilter: $riskLevelsFilter\r\n    clusterIdsFilter: $clusterIdsFilter\r\n    subscriptionIdsFilter: $subscriptionIdsFilter\r\n    includeWhitelistedResults: $includeWhitelistedResults\r\n    first: $first\r\n    after: $after\r\n    includeInsightsMarker: $includeInsightsMarker\r\n  ) {\r\n    edges {\r\n      cursor\r\n      node {\r\n        ...PolicyObjOptimizedFragment\r\n        __typename\r\n      }\r\n      __typename\r\n    }\r\n    pageInfo {\r\n      startCursor\r\n      endCursor\r\n      hasNextPage\r\n      hasPreviousPage\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n}\r\n\r\nfragment PolicyObjOptimizedFragment on PolicyObj {\r\n  id\r\n  snapshotFid\r\n  snapshotTimestamp\r\n  shareType\r\n  analysisStatus\r\n  riskLevel\r\n  accessRiskReasons\r\n  isUserAccessEnabledObject\r\n  sensitiveFiles {\r\n    highRiskFileCount {\r\n      totalCount\r\n      violatedCount\r\n      __typename\r\n    }\r\n    mediumRiskFileCount {\r\n      totalCount\r\n      violatedCount\r\n      __typename\r\n    }\r\n    lowRiskFileCount {\r\n      totalCount\r\n      violatedCount\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  rootFileResult {\r\n    hits {\r\n      totalHits\r\n      violations\r\n      violationsDelta\r\n      totalHitsDelta\r\n      __typename\r\n    }\r\n    analyzerGroupResults {\r\n      ...AnalyzerGroupResultFragment\r\n      __typename\r\n    }\r\n    filesWithHits {\r\n      totalHits\r\n      violations\r\n      violationsDelta\r\n      totalHitsDelta\r\n      __typename\r\n    }\r\n    openAccessFiles {\r\n      totalHits\r\n      violations\r\n      violationsDelta\r\n      totalHitsDelta\r\n      __typename\r\n    }\r\n    openAccessFolders {\r\n      totalHits\r\n      violations\r\n      violationsDelta\r\n      totalHitsDelta\r\n      __typename\r\n    }\r\n    openAccessFilesWithHits {\r\n      totalHits\r\n      violations\r\n      violationsDelta\r\n      totalHitsDelta\r\n      __typename\r\n    }\r\n    staleFiles {\r\n      totalHits\r\n      violations\r\n      violationsDelta\r\n      totalHitsDelta\r\n      __typename\r\n    }\r\n    staleFilesWithHits {\r\n      totalHits\r\n      violations\r\n      violationsDelta\r\n      totalHitsDelta\r\n      __typename\r\n    }\r\n    openAccessStaleFiles {\r\n      totalHits\r\n      violations\r\n      violationsDelta\r\n      totalHitsDelta\r\n      __typename\r\n    }\r\n    numActivities\r\n    numActivitiesDelta\r\n    __typename\r\n  }\r\n  userCounts {\r\n    highRiskCount {\r\n      totalCount\r\n      violatedCount\r\n      __typename\r\n    }\r\n    mediumRiskCount {\r\n      totalCount\r\n      violatedCount\r\n      __typename\r\n    }\r\n    lowRiskCount {\r\n      totalCount\r\n      violatedCount\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  snappable {\r\n    ...SnappableFragment\r\n    __typename\r\n  }\r\n  hasInsights\r\n  __typename\r\n}\r\n\r\nfragment AnalyzerGroupResultFragment on AnalyzerGroupResult {\r\n  analyzerGroup {\r\n    groupType\r\n    id\r\n    name\r\n    __typename\r\n  }\r\n  analyzerResults {\r\n    hits {\r\n      totalHits\r\n      violations\r\n      __typename\r\n    }\r\n    analyzer {\r\n      id\r\n      name\r\n      analyzerType\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  hits {\r\n    totalHits\r\n    violations\r\n    violationsDelta\r\n    totalHitsDelta\r\n    __typename\r\n  }\r\n  __typename\r\n}\r\n\r\nfragment SnappableFragment on HierarchyObject {\r\n  id\r\n  name\r\n  objectType\r\n  slaAssignment\r\n  logicalPath {\r\n    fid\r\n    name\r\n    objectType\r\n    __typename\r\n  }\r\n  physicalPath {\r\n    fid\r\n    name\r\n    objectType\r\n    __typename\r\n  }\r\n  effectiveSlaDomain {\r\n    id\r\n    name\r\n    __typename\r\n  }\r\n  ... on VsphereVm {\r\n    cluster {\r\n      id\r\n      name\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  ... on LinuxFileset {\r\n    cluster {\r\n      id\r\n      name\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  ... on ShareFileset {\r\n    cluster {\r\n      id\r\n      name\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  ... on WindowsFileset {\r\n    cluster {\r\n      id\r\n      name\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  ... on NutanixVm {\r\n    cluster {\r\n      id\r\n      name\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  ... on HyperVVirtualMachine {\r\n    cluster {\r\n      id\r\n      name\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  ... on VolumeGroup {\r\n    cluster {\r\n      id\r\n      name\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  ... on O365Onedrive {\r\n    userPrincipalName\r\n    __typename\r\n  }\r\n  ... on O365SharepointDrive {\r\n    url\r\n    __typename\r\n  }\r\n  ... on AzureNativeVirtualMachine {\r\n    region\r\n    resourceGroup {\r\n      subscription {\r\n        id\r\n        name\r\n        __typename\r\n      }\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  ... on AzureNativeManagedDisk {\r\n    region\r\n    resourceGroup {\r\n      subscription {\r\n        id\r\n        name\r\n        __typename\r\n      }\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  ... on CloudDirectNasExport {\r\n    exportPath\r\n    __typename\r\n  }\r\n  ... on CloudDirectHierarchyObject {\r\n    cluster {\r\n      id\r\n      name\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  __typename\r\n}",
                                                "variables": {
                                                    "analysisStatusesFilter": [],
                                                    "clusterIdsFilter": [],
                                                    "day": "@{formatDateTime(utcNow(), 'yyyy-MM-dd')}",
                                                    "first": 50,
                                                    "includeInsightsMarker": false,
                                                    "includeWhitelistedResults": false,
                                                    "objectTypes": [],
                                                    "policyIdsFilter": [],
                                                    "riskLevelsFilter": [],
                                                    "searchObjectName": "@{variables('objectName')}",
                                                    "subscriptionIdsFilter": [],
                                                    "timezone": ""
                                                }
                                            },
                                            "headers": {
                                                "Authorization": "Bearer @{variables('accessToken')}"
                                            },
                                            "method": "POST",
                                            "uri": "@{variables('BaseUrl')}/api/graphql"
                                        }
                                    },
                                    "Get_objectName_from_user": {
                                        "runAfter": {},
                                        "type": "ApiConnectionWebhook",
                                        "inputs": {
                                            "body": {
                                                "body": {
                                                    "messageBody": "{\n    \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n    \"type\": \"AdaptiveCard\",\n    \"version\": \"1.3\",\n    \"body\": [\n        {\n            \"type\": \"TextBlock\",\n            \"size\": \"Large\",\n            \"weight\": \"Bolder\",\n            \"text\": \"File Based Object\",\n            \"horizontalAlignment\": \"Center\",\n            \"style\": \"heading\",\n            \"color\": \"Accent\",\n            \"fontType\": \"Default\",\n            \"wrap\": true,\n            \"id\": \"heading\"\n        },\n        {\n            \"type\": \"TextBlock\",\n            \"text\": \"Please provide objectName to get policy hits.\",\n            \"wrap\": true,\n            \"style\": \"default\",\n            \"weight\": \"Bolder\",\n            \"separator\": true,\n            \"id\": \"info\",\n            \"size\": \"Medium\",\n            \"spacing\": \"Large\"\n        },\n        {\n            \"type\": \"Input.Text\",\n            \"id\": \"objectName\",\n            \"isRequired\": true,\n            \"label\": \"Object Name(required)\",\n            \"errorMessage\": \"objectName is a required field.\"\n        },\n        {\n            \"type\": \"TextBlock\",\n            \"text\": \"NOTE: If you don't have an objectName, please click the link below to find the list of available objects and provide name of object found from the list in above text box.\",\n            \"wrap\": true,\n            \"style\": \"default\",\n            \"weight\": \"Bolder\",\n            \"separator\": true,\n            \"id\": \"info2\",\n            \"spacing\": \"Medium\",\n            \"size\": \"Default\"\n        }\n    ],\n    \"actions\": [\n        {\n            \"type\": \"Action.OpenUrl\",\n            \"title\": \"CLICK HERE TO VIEW AVAILABLE OBJECTS ON RUBRIK INSTANCE\",\n            \"url\": \"@{variables('baseUrl')}/sonar/objects/data_center/overview\",\n            \"role\": \"Button\"\n        },\n        {\n            \"type\": \"Action.Submit\",\n            \"title\": \"Submit Answer\",\n            \"data\": {\n                \"id\": \"LoginVal\"\n            },\n            \"style\": \"positive\",\n            \"id\": \"Submit\"\n        }\n    ]\n}",
                                                    "recipient": {
                                                        "channelId": "[parameters('TeamsChannelId')]",
                                                        "groupId": "[parameters('TeamsGroupId')]"
                                                    },
                                                    "updateMessage": "Thanks for your response!"
                                                },
                                                "notificationUrl": "@{listCallbackUrl()}"
                                            },
                                            "host": {
                                                "connection": {
                                                    "name": "@parameters('$connections')['teams']['connectionId']"
                                                }
                                            },
                                            "path": "/v1.0/teams/conversation/gatherinput/poster/Flow bot/location/@{encodeURIComponent('Channel')}/$subscriptions"
                                        }
                                    },
                                    "Set_objectName": {
                                        "runAfter": {
                                            "Get_objectName_from_user": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "objectName",
                                            "value": "@{body('Get_objectName_from_user')?['data']?['objectName']}"
                                        }
                                    }
                                }
                            },
                            "expression": {
                                "and": [
                                    {
                                        "equals": [
                                            "@empty(triggerBody()?['ObjectId'])",
                                            "@false"
                                        ]
                                    }
                                ]
                            },
                            "type": "If"
                        },
                        "Does_error_occurred_while_retrieving_data": {
                            "actions": {
                                "Failure_Response": {
                                    "runAfter": {},
                                    "type": "Response",
                                    "kind": "Http",
                                    "inputs": {
                                        "body": "@variables('errorMessage')",
                                        "statusCode": 400
                                    }
                                },
                                "Terminate": {
                                    "runAfter": {
                                        "Failure_Response": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Terminate",
                                    "inputs": {
                                        "runError": {
                                            "code": "400",
                                            "message": "@variables('errorMessage')"
                                        },
                                        "runStatus": "Failed"
                                    }
                                }
                            },
                            "runAfter": {
                                "Check_if_nextPage_available": [
                                    "Succeeded"
                                ]
                            },
                            "else": {
                                "actions": {
                                    "Does_policy_hits_data_found": {
                                        "actions": {
                                            "Success_Response": {
                                                "runAfter": {},
                                                "type": "Response",
                                                "kind": "Http",
                                                "inputs": {
                                                    "body": "Policy Hits for object @{variables('objectId')} ingested in log analytics workspace successfully.",
                                                    "statusCode": 200
                                                }
                                            }
                                        },
                                        "runAfter": {},
                                        "else": {
                                            "actions": {
                                                "Success_Response_with_no_data": {
                                                    "runAfter": {},
                                                    "type": "Response",
                                                    "kind": "Http",
                                                    "inputs": {
                                                        "body": "No policy hits data found for object @{variables('objectId')}.",
                                                        "statusCode": 200
                                                    }
                                                }
                                            }
                                        },
                                        "expression": {
                                            "and": [
                                                {
                                                    "equals": [
                                                        "@variables('dataFound')",
                                                        "@true"
                                                    ]
                                                }
                                            ]
                                        },
                                        "type": "If"
                                    }
                                }
                            },
                            "expression": {
                                "and": [
                                    {
                                        "equals": [
                                            "@empty(variables('errorMessage'))",
                                            "@false"
                                        ]
                                    }
                                ]
                            },
                            "type": "If"
                        },
                        "Does_get_access_token_get_status_code_equal_to_200_": {
                            "actions": {},
                            "runAfter": {
                                "Get_Access_Token": [
                                    "Succeeded",
                                    "Failed"
                                ]
                            },
                            "else": {
                                "actions": {
                                    "Authentication_Failure_Response": {
                                        "runAfter": {},
                                        "type": "Response",
                                        "kind": "Http",
                                        "inputs": {
                                            "body": "@body('Get_Access_Token')?['message']",
                                            "statusCode": "@outputs('Get_Access_Token')['statusCode']"
                                        }
                                    },
                                    "Terminate_due_to_authentication_failure": {
                                        "runAfter": {
                                            "Authentication_Failure_Response": [
                                                "Succeeded",
                                                "Skipped",
                                                "Failed"
                                            ]
                                        },
                                        "type": "Terminate",
                                        "inputs": {
                                            "runError": {
                                                "code": "@{outputs('Get_Access_Token')['statusCode']}",
                                                "message": "@{body('Get_Access_Token')?['message']}"
                                            },
                                            "runStatus": "Failed"
                                        }
                                    }
                                }
                            },
                            "expression": {
                                "and": [
                                    {
                                        "equals": [
                                            "@outputs('Get_Access_Token')['statusCode']",
                                            200
                                        ]
                                    }
                                ]
                            },
                            "type": "If"
                        },
                        "Does_status_code_for_getting_latest_snapshotId_equal_to_200": {
                            "actions": {
                                "Does_get_snapshotId_response_conatin_error": {
                                    "actions": {
                                        "Failure_as_snapshot_list_api_response_contain_errors": {
                                            "runAfter": {},
                                            "type": "Response",
                                            "kind": "Http",
                                            "inputs": {
                                                "body": "@body('Get_Latest_SnapshotId_for_given_ObjectId')?['errors'][0]?['message']",
                                                "statusCode": 400
                                            }
                                        },
                                        "Terminate_as_snapshot_list_api_response_contain_erros": {
                                            "runAfter": {
                                                "Failure_as_snapshot_list_api_response_contain_errors": [
                                                    "Succeeded",
                                                    "Skipped",
                                                    "Failed"
                                                ]
                                            },
                                            "type": "Terminate",
                                            "inputs": {
                                                "runError": {
                                                    "message": "@{body('Get_Latest_SnapshotId_for_given_ObjectId')?['errors'][0]?['message']}"
                                                },
                                                "runStatus": "Failed"
                                            }
                                        }
                                    },
                                    "runAfter": {},
                                    "else": {
                                        "actions": {
                                            "Increment_snapshotcount": {
                                                "runAfter": {
                                                    "Set_SnapshotId": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "IncrementVariable",
                                                "inputs": {
                                                    "name": "count",
                                                    "value": 1
                                                }
                                            },
                                            "Parse_JSON": {
                                                "runAfter": {},
                                                "type": "ParseJson",
                                                "inputs": {
                                                    "content": "@body('Get_Latest_SnapshotId_for_given_ObjectId')",
                                                    "schema": {
                                                        "properties": {
                                                            "data": {
                                                                "properties": {
                                                                    "snapshotsListConnection": {
                                                                        "properties": {
                                                                            "edges": {
                                                                                "items": {
                                                                                    "properties": {
                                                                                        "node": {
                                                                                            "properties": {
                                                                                                "cdmVersion": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "cluster": {
                                                                                                    "properties": {
                                                                                                        "id": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "name": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "status": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "version": {
                                                                                                            "type": "string"
                                                                                                        }
                                                                                                    },
                                                                                                    "type": [
                                                                                                        "object",
                                                                                                        "null"
                                                                                                    ]
                                                                                                },
                                                                                                "date": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "expirationDate": {},
                                                                                                "id": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "isDownloadedSnapshot": {
                                                                                                    "type": "boolean"
                                                                                                },
                                                                                                "isOnDemandSnapshot": {
                                                                                                    "type": "boolean"
                                                                                                },
                                                                                                "legalHoldInfo": {},
                                                                                                "pendingSla": {},
                                                                                                "pendingSnapshotDeletion": {},
                                                                                                "sapHanaAppMetadata": {},
                                                                                                "slaDomain": {
                                                                                                    "properties": {
                                                                                                        "id": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "name": {
                                                                                                            "type": "string"
                                                                                                        }
                                                                                                    },
                                                                                                    "type": [
                                                                                                        "object",
                                                                                                        "null"
                                                                                                    ]
                                                                                                },
                                                                                                "snapshotRetentionInfo": {
                                                                                                    "properties": {
                                                                                                        "archivalInfos": {
                                                                                                            "type": "array"
                                                                                                        },
                                                                                                        "localInfo": {
                                                                                                            "properties": {
                                                                                                                "expirationTime": {},
                                                                                                                "isExpirationDateCalculated": {
                                                                                                                    "type": "boolean"
                                                                                                                },
                                                                                                                "name": {
                                                                                                                    "type": "string"
                                                                                                                }
                                                                                                            },
                                                                                                            "type": [
                                                                                                                "object",
                                                                                                                "null"
                                                                                                            ]
                                                                                                        },
                                                                                                        "replicationInfos": {
                                                                                                            "type": "array"
                                                                                                        }
                                                                                                    },
                                                                                                    "type": [
                                                                                                        "object",
                                                                                                        "null"
                                                                                                    ]
                                                                                                }
                                                                                            },
                                                                                            "type": "object"
                                                                                        }
                                                                                    },
                                                                                    "required": [
                                                                                        "node"
                                                                                    ],
                                                                                    "type": "object"
                                                                                },
                                                                                "type": "array"
                                                                            },
                                                                            "pageInfo": {
                                                                                "properties": {
                                                                                    "endCursor": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "hasNextPage": {
                                                                                        "type": "boolean"
                                                                                    }
                                                                                },
                                                                                "type": "object"
                                                                            }
                                                                        },
                                                                        "type": "object"
                                                                    }
                                                                },
                                                                "type": "object"
                                                            }
                                                        },
                                                        "type": "object"
                                                    }
                                                }
                                            },
                                            "Set_SnapshotId": {
                                                "runAfter": {
                                                    "Set_totalSnapshotCount": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "snapshotId",
                                                    "value": "@{body('Parse_JSON')?['data']?['snapshotsListConnection']?['edges'][variables('count')]?['node']?['id']}"
                                                }
                                            },
                                            "Set_totalSnapshotCount": {
                                                "runAfter": {
                                                    "Parse_JSON": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "TotalSnapshotCount",
                                                    "value": "@length(body('Parse_JSON')?['data']?['snapshotsListConnection']?['edges'])"
                                                }
                                            }
                                        }
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "contains": [
                                                    "@body('Get_Latest_SnapshotId_for_given_ObjectId')",
                                                    "errors"
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If"
                                }
                            },
                            "runAfter": {
                                "Get_Latest_SnapshotId_for_given_ObjectId": [
                                    "Succeeded"
                                ]
                            },
                            "else": {
                                "actions": {
                                    "Failure_response_as_snapshot_list_api_request_failed": {
                                        "runAfter": {},
                                        "type": "Response",
                                        "kind": "Http",
                                        "inputs": {
                                            "body": "@body('Get_Latest_SnapshotId_for_given_ObjectId')?['message']",
                                            "statusCode": "@outputs('Get_Latest_SnapshotId_for_given_ObjectId')['statusCode']"
                                        }
                                    },
                                    "Terminate_as_snapshot_list_api_request_failed": {
                                        "runAfter": {
                                            "Failure_response_as_snapshot_list_api_request_failed": [
                                                "Succeeded",
                                                "Skipped",
                                                "Failed"
                                            ]
                                        },
                                        "type": "Terminate",
                                        "inputs": {
                                            "runError": {
                                                "code": "@{outputs('Get_Latest_SnapshotId_for_given_ObjectId')['statusCode']}",
                                                "message": "@{body('Get_Latest_SnapshotId_for_given_ObjectId')?['message']}"
                                            },
                                            "runStatus": "Failed"
                                        }
                                    }
                                }
                            },
                            "expression": {
                                "and": [
                                    {
                                        "equals": [
                                            "@outputs('Get_Latest_SnapshotId_for_given_ObjectId')['statusCode']",
                                            200
                                        ]
                                    }
                                ]
                            },
                            "type": "If"
                        },
                        "Get_Access_Token": {
                            "runAfter": {
                                "Get_Rubrik_ClientSecret": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Http",
                            "inputs": {
                                "body": {
                                    "client_id": "@{body('Get_Rubrik_ClientId')?['value']}",
                                    "client_secret": "@{body('Get_Rubrik_ClientSecret')?['value']}"
                                },
                                "method": "POST",
                                "uri": "@{variables('BaseUrl')}/api/client_token"
                            },
                            "runtimeConfiguration": {
                                "secureData": {
                                    "properties": [
                                        "inputs",
                                        "outputs"
                                    ]
                                }
                            }
                        },
                        "Get_Latest_SnapshotId_for_given_ObjectId": {
                            "runAfter": {
                                "Get_file_folder_or_fileshare_from_user_for_given_Object": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Http",
                            "inputs": {
                                "body": {
                                    "query": "query SnapshotsListSingleQuery($workloadId: String!, $first: Int, $after: String, $snapshotFilter: [SnapshotQueryFilterInput!], $sortBy: SnapshotQuerySortByField, $sortOrder: SortOrder, $timeRange: TimeRangeInput) {\r\n  snapshotsListConnection: snapshotOfASnappableConnection(\r\n    workloadId: $workloadId\r\n    first: $first\r\n    after: $after\r\n    snapshotFilter: $snapshotFilter\r\n    sortBy: $sortBy\r\n    sortOrder: $sortOrder\r\n    timeRange: $timeRange\r\n  ) {\r\n    edges {\r\n      node {\r\n        id\r\n        date\r\n        expirationDate\r\n        isOnDemandSnapshot\r\n        ... on CdmSnapshot {\r\n          cdmVersion\r\n          isDownloadedSnapshot\r\n          cluster {\r\n            id\r\n            name\r\n            version\r\n            status\r\n          }\r\n          pendingSnapshotDeletion {\r\n            id: snapshotFid\r\n            status\r\n          }\r\n          slaDomain {\r\n            name\r\n            ... on ClusterSlaDomain {\r\n              fid\r\n              cluster {\r\n                id\r\n                name\r\n              }\r\n            }\r\n            ... on GlobalSlaReply {\r\n              id\r\n            }\r\n          }\r\n          pendingSla {\r\n            id\r\n            name\r\n          }\r\n          snapshotRetentionInfo {\r\n            archivalInfos {\r\n              name\r\n              isExpirationDateCalculated\r\n              expirationTime\r\n            }\r\n            localInfo {\r\n              name\r\n              isExpirationDateCalculated\r\n              expirationTime\r\n            }\r\n            replicationInfos {\r\n              name\r\n              isExpirationDateCalculated\r\n              expirationTime\r\n            }\r\n          }\r\n          sapHanaAppMetadata {\r\n            backupId\r\n            backupPrefix\r\n            snapshotType\r\n            files {\r\n              backupFileSizeInBytes\r\n            }\r\n          }\r\n          legalHoldInfo {\r\n            shouldHoldInPlace\r\n          }\r\n        }\r\n        ... on PolarisSnapshot {\r\n          isDownloadedSnapshot\r\n          isReplica\r\n          isArchivalCopy\r\n          slaDomain {\r\n            name\r\n            ... on ClusterSlaDomain {\r\n              fid\r\n              cluster {\r\n                id\r\n                name\r\n              }\r\n            }\r\n            ... on GlobalSlaReply {\r\n              id\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    pageInfo {\r\n      endCursor\r\n      hasNextPage\r\n    }\r\n  }\r\n}",
                                    "variables": {
                                        "sortBy": "CREATION_TIME",
                                        "sortOrder": "DESC",
                                        "workloadId": "@{variables('objectId')}"
                                    }
                                },
                                "headers": {
                                    "Authorization": "Bearer @{variables('accessToken')}"
                                },
                                "method": "POST",
                                "uri": "@{variables('BaseUrl')}/api/graphql"
                            }
                        },
                        "Get_Rubrik_ClientId": {
                            "runAfter": {
                                "Initialize_dataFound": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['keyvault']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "/secrets/@{encodeURIComponent('Rubrik-AS-Int-ClientId')}/value"
                            },
                            "runtimeConfiguration": {
                                "secureData": {
                                    "properties": [
                                        "inputs",
                                        "outputs"
                                    ]
                                }
                            }
                        },
                        "Get_Rubrik_ClientSecret": {
                            "runAfter": {
                                "Get_Rubrik_ClientId": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['keyvault']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "/secrets/@{encodeURIComponent('Rubrik-AS-Int-ClientSecret')}/value"
                            },
                            "runtimeConfiguration": {
                                "secureData": {
                                    "properties": [
                                        "inputs",
                                        "outputs"
                                    ]
                                }
                            }
                        },
                        "Get_file_folder_or_fileshare_from_user_for_given_Object": {
                            "runAfter": {
                                "Does_ObjectId_available_in_request": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnectionWebhook",
                            "inputs": {
                                "body": {
                                    "body": {
                                        "messageBody": "{\n    \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n    \"type\": \"AdaptiveCard\",\n    \"version\": \"1.3\",\n    \"body\": [\n        {\n            \"type\": \"TextBlock\",\n            \"size\": \"Large\",\n            \"weight\": \"Bolder\",\n            \"text\": \"File Based Object\",\n            \"horizontalAlignment\": \"Center\",\n            \"style\": \"heading\",\n            \"color\": \"Accent\",\n            \"fontType\": \"Default\",\n            \"wrap\": true,\n            \"id\": \"heading\"\n        },\n{\n            \"type\": \"TextBlock\",\n            \"text\": \"Object Name=@{variables('objectName')} \\n\\nObject Id = @{variables('objectId')} \\n\\n@{if(empty(triggerBody()?['incidentStartTime']), '', concat('Incident Start Time = ', triggerBody()?['incidentStartTime']))} \",\n            \"wrap\": true,\n            \"style\": \"default\",\n            \"color\": \"accent\",\n            \"separator\": true,\n            \"id\": \"x\"\n        },\n         {\n            \"type\": \"TextBlock\",\n            \"text\": \"Input arguments to fetch policy hits for a particular file or specified path\\n\",\n            \"wrap\": true,\n            \"weight\": \"Bolder\",\n            \"separator\": true,\n            \"id\": \"title\",\n            \"size\": \"Medium\",\n            \"spacing\": \"Large\"\n        },\n        {\n            \"type\": \"TextBlock\",\n            \"text\": \"Enter file/folder/fileshare name for given object (case-insensitive)\\n\",\n            \"wrap\": true,\n            \"weight\": \"Bolder\",\n            \"separator\": true,\n            \"id\": \"Ip1\"\n        },\n        {\n            \"type\": \"Input.Text\",\n            \"id\": \"searchText\",\n            \"isMultiline\": false,\n            \"isRequired\": false\n        },\n{\n            \"type\": \"TextBlock\",\n            \"text\": \"Standard FilePath to get policy hits within\\n e.g. /C: or /var/www\\n(CASE-SENSITIVE)\",\n            \"wrap\": true,\n            \"weight\": \"Bolder\",\n            \"separator\": true,\n            \"id\": \"Ip2\"\n        },\n        {\n            \"type\": \"Input.Text\",\n            \"id\": \"filePath\",\n            \"isMultiline\": false,\n            \"isRequired\": false\n        }\n    ],\n    \"actions\": [\n        {\n            \"type\": \"Action.Submit\",\n            \"title\": \"Submit Answer\",\n            \"data\": {\n                \"id\": \"LoginVal\"\n            },\n            \"style\": \"positive\",\n            \"id\": \"Submit\"\n        }\n    ]\n}\n",
                                        "recipient": {
                                            "channelId": "[parameters('TeamsChannelId')]",
                                            "groupId": "[parameters('TeamsGroupId')]"
                                        },
                                        "updateMessage": "Thanks for your response!"
                                    },
                                    "notificationUrl": "@{listCallbackUrl()}"
                                },
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['teams']['connectionId']"
                                    }
                                },
                                "path": "/v1.0/teams/conversation/gatherinput/poster/Flow bot/location/@{encodeURIComponent('Channel')}/$subscriptions"
                            }
                        },
                        "Initialize_BaseUrl": {
                            "runAfter": {},
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "BaseUrl",
                                        "type": "string",
                                        "value": "@{if(empty(triggerBody()?['Baseurl']),parameters('Baseurl'),triggerBody()?['Baseurl'])}"
                                    }
                                ]
                            }
                        },
                        "Initialize_access_token": {
                            "runAfter": {
                                "Does_get_access_token_get_status_code_equal_to_200_": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "accessToken",
                                        "type": "string",
                                        "value": "@{body('Get_Access_Token')?['access_token']}"
                                    }
                                ]
                            }
                        },
                        "Initialize_dataFound": {
                            "runAfter": {
                                "Initialize_totalSnapshotCount": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "dataFound",
                                        "type": "boolean",
                                        "value": "@false"
                                    }
                                ]
                            }
                        },
                        "Initialize_errormessage": {
                            "runAfter": {
                                "Initialize_hasNextPage": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "errorMessage",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_hasNextPage": {
                            "runAfter": {
                                "Initialize_policy_hits_data": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "hasNextPage",
                                        "type": "boolean",
                                        "value": "@true"
                                    }
                                ]
                            }
                        },
                        "Initialize_objectId": {
                            "runAfter": {
                                "Initialize_snapshotId": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "objectId",
                                        "type": "string",
                                        "value": "@triggerBody()?['ObjectId']"
                                    }
                                ]
                            }
                        },
                        "Initialize_objectName": {
                            "runAfter": {
                                "Initialize_objectId": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "objectName",
                                        "type": "string",
                                        "value": "@triggerBody()?['ObjectName']"
                                    }
                                ]
                            }
                        },
                        "Initialize_policy_hits_data": {
                            "runAfter": {
                                "Initialize_objectName": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "policyhits",
                                        "type": "array"
                                    }
                                ]
                            }
                        },
                        "Initialize_snapshotCount": {
                            "runAfter": {
                                "Initialize_snpahotfound": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "count",
                                        "type": "integer",
                                        "value": 0
                                    }
                                ]
                            }
                        },
                        "Initialize_snapshotId": {
                            "runAfter": {
                                "Initialize_BaseUrl": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "snapshotId",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_snpahotfound": {
                            "runAfter": {
                                "Initialize_errormessage": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "snapshotFound",
                                        "type": "boolean"
                                    }
                                ]
                            }
                        },
                        "Initialize_totalSnapshotCount": {
                            "runAfter": {
                                "Initialize_snapshotCount": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TotalSnapshotCount",
                                        "type": "integer"
                                    }
                                ]
                            }
                        },
                        "Initialize_variable": {
                            "runAfter": {
                                "Does_status_code_for_getting_latest_snapshotId_equal_to_200": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "variables",
                                        "type": "object",
                                        "value": {
                                            "filters": {
                                                "analyzerGroupIds": [],
                                                "fileType": "HITS",
                                                "searchText": "@{body('Get_file_folder_or_fileshare_from_user_for_given_Object')?['data']?['searchText']}",
                                                "snappablePaths": [
                                                    {
                                                        "snappableFid": "@{variables('objectId')}",
                                                        "stdPath": "@{body('Get_file_folder_or_fileshare_from_user_for_given_Object')?['data']?['filePath']}"
                                                    }
                                                ],
                                                "whitelistEnabled": true
                                            },
                                            "first": 100,
                                            "snappableFid": "@{variables('objectId')}",
                                            "snapshotFid": "@{variables('snapshotId')}",
                                            "sort": {
                                                "sortBy": "HITS",
                                                "sortOrder": "DESC"
                                            },
                                            "timezone": "America/Los_Angeles"
                                        }
                                    }
                                ]
                            }
                        },
                        "Until_snapshotFound_with_policy_hits": {
                            "actions": {
                                "Does_status_code_to_get_policy_hits_for_a_snapshot_get_status_code_200": {
                                    "actions": {
                                        "Does_data_not_available_in_response_for_current_snapshot": {
                                            "actions": {
                                                "Check_for_iteration_of_all_Snapshot_is_completed_or_not": {
                                                    "actions": {
                                                        "Set_error_message_that_no_snapshot_found_with_sensitive_hits_data": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "errorMessage",
                                                                "value": "No snapshot found with sensitive policy hits data information for @{variables('objectName')}"
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {},
                                                    "else": {
                                                        "actions": {
                                                            "Increment_count_of_snapshot": {
                                                                "runAfter": {
                                                                    "Set_snapshotId_after_current": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "IncrementVariable",
                                                                "inputs": {
                                                                    "name": "count",
                                                                    "value": 1
                                                                }
                                                            },
                                                            "Set_errorMessage_empty": {
                                                                "runAfter": {
                                                                    "Set_variable_for_next_snapshot_policyhits": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "errorMessage",
                                                                    "value": "@{null}"
                                                                }
                                                            },
                                                            "Set_snapshotId_after_current": {
                                                                "runAfter": {},
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "snapshotId",
                                                                    "value": "@{body('Parse_JSON')?['data']?['snapshotsListConnection']?['edges'][variables('count')]?['node']?['id']}"
                                                                }
                                                            },
                                                            "Set_variable_for_next_snapshot_policyhits": {
                                                                "runAfter": {
                                                                    "Increment_count_of_snapshot": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "variables",
                                                                    "value": {
                                                                        "filters": {
                                                                            "analyzerGroupIds": [],
                                                                            "fileType": "HITS",
                                                                            "searchText": "@{body('Get_file_folder_or_fileshare_from_user_for_given_Object')?['data']?['searchText']}",
                                                                            "snappablePaths": [
                                                                                {
                                                                                    "snappableFid": "@{variables('objectId')}",
                                                                                    "stdPath": "@{body('Get_file_folder_or_fileshare_from_user_for_given_Object')?['data']?['filePath']}"
                                                                                }
                                                                            ],
                                                                            "whitelistEnabled": true
                                                                        },
                                                                        "first": 100,
                                                                        "snappableFid": "@{variables('objectId')}",
                                                                        "snapshotFid": "@{variables('snapshotId')}",
                                                                        "sort": {
                                                                            "sortBy": "HITS",
                                                                            "sortOrder": "DESC"
                                                                        },
                                                                        "timezone": "America/Los_Angeles"
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "equals": [
                                                                    "@variables('count')",
                                                                    "@variables('TotalSnapshotCount')"
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "type": "If"
                                                }
                                            },
                                            "runAfter": {
                                                "Does_response_to_get_policy_hits_for_a_snapshot_contain_errors": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "else": {
                                                "actions": {
                                                    "Check_if_next_page_available": {
                                                        "actions": {
                                                            "Set_has_Next_Page_to_true": {
                                                                "runAfter": {},
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "hasNextPage",
                                                                    "value": "@true"
                                                                }
                                                            },
                                                            "Set_variables_for_next_page_API_call": {
                                                                "runAfter": {
                                                                    "Set_has_Next_Page_to_true": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "variables",
                                                                    "value": {
                                                                        "after": "@body('Parse_JSON_2')?['data']?['policyObj']?['fileResultConnection']?['pageInfo']?['endCursor']",
                                                                        "filters": {
                                                                            "analyzerGroupIds": [],
                                                                            "fileType": "HITS",
                                                                            "searchText": "@{body('Get_file_folder_or_fileshare_from_user_for_given_Object')?['data']?['searchText']}",
                                                                            "snappablePaths": [
                                                                                {
                                                                                    "snappableFid": "@{variables('objectId')}",
                                                                                    "stdPath": "@{body('Get_file_folder_or_fileshare_from_user_for_given_Object')?['data']?['filePath']}"
                                                                                }
                                                                            ],
                                                                            "whitelistEnabled": true
                                                                        },
                                                                        "first": 100,
                                                                        "snappableFid": "@{variables('objectId')}",
                                                                        "snapshotFid": "@{variables('snapshotId')}",
                                                                        "sort": {
                                                                            "sortBy": "HITS",
                                                                            "sortOrder": "DESC"
                                                                        },
                                                                        "timezone": "America/Los_Angeles"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Set_policyhits_to_null": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "else": {
                                                            "actions": {
                                                                "Set_hasNextPage_to_false_as_next_is_not_available": {
                                                                    "runAfter": {},
                                                                    "type": "SetVariable",
                                                                    "inputs": {
                                                                        "name": "hasNextPage",
                                                                        "value": "@false"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "expression": {
                                                            "and": [
                                                                {
                                                                    "equals": [
                                                                        "@body('Parse_JSON_2')?['data']?['policyObj']?['fileResultConnection']?['pageInfo']?['hasNextPage']",
                                                                        true
                                                                    ]
                                                                }
                                                            ]
                                                        },
                                                        "type": "If"
                                                    },
                                                    "Compose_2": {
                                                        "runAfter": {
                                                            "For_each_2": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Compose",
                                                        "inputs": "@variables('policyhits')"
                                                    },
                                                    "For_each_2": {
                                                        "foreach": "@body('Parse_JSON_2')?['data']?['policyObj']?['fileResultConnection']?['edges']",
                                                        "actions": {
                                                            "Add_Objectname_property_for_each_policyHits_data": {
                                                                "runAfter": {},
                                                                "type": "AppendToArrayVariable",
                                                                "inputs": {
                                                                    "name": "policyhits",
                                                                    "value": "@setProperty(items('For_each_2')?['node'],'ObjectId',variables('objectId'))"
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Set_snapshotFound_to_true": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Foreach"
                                                    },
                                                    "Parse_JSON_2": {
                                                        "runAfter": {},
                                                        "type": "ParseJson",
                                                        "inputs": {
                                                            "content": "@body('HTTP')",
                                                            "schema": {
                                                                "properties": {
                                                                    "data": {
                                                                        "properties": {
                                                                            "policyObj": {
                                                                                "properties": {
                                                                                    "__typename": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "fileResultConnection": {
                                                                                        "properties": {
                                                                                            "__typename": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "edges": {
                                                                                                "items": {
                                                                                                    "properties": {
                                                                                                        "__typename": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "cursor": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "node": {
                                                                                                            "properties": {
                                                                                                                "__typename": {
                                                                                                                    "type": "string"
                                                                                                                },
                                                                                                                "analyzerGroupResults": {
                                                                                                                    "items": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "analyzerGroup": {
                                                                                                                                "properties": {
                                                                                                                                    "__typename": {
                                                                                                                                        "type": "string"
                                                                                                                                    },
                                                                                                                                    "groupType": {
                                                                                                                                        "type": "string"
                                                                                                                                    },
                                                                                                                                    "id": {
                                                                                                                                        "type": "string"
                                                                                                                                    },
                                                                                                                                    "name": {
                                                                                                                                        "type": "string"
                                                                                                                                    }
                                                                                                                                },
                                                                                                                                "type": [
                                                                                                                                    "object",
                                                                                                                                    "null"
                                                                                                                                ]
                                                                                                                            },
                                                                                                                            "analyzerResults": {
                                                                                                                                "items": {
                                                                                                                                    "properties": {
                                                                                                                                        "__typename": {
                                                                                                                                            "type": "string"
                                                                                                                                        },
                                                                                                                                        "analyzer": {
                                                                                                                                            "properties": {
                                                                                                                                                "__typename": {
                                                                                                                                                    "type": "string"
                                                                                                                                                },
                                                                                                                                                "analyzerType": {
                                                                                                                                                    "type": "string"
                                                                                                                                                },
                                                                                                                                                "id": {
                                                                                                                                                    "type": "string"
                                                                                                                                                },
                                                                                                                                                "name": {
                                                                                                                                                    "type": "string"
                                                                                                                                                }
                                                                                                                                            },
                                                                                                                                            "type": [
                                                                                                                                                "object",
                                                                                                                                                "null"
                                                                                                                                            ]
                                                                                                                                        },
                                                                                                                                        "hits": {
                                                                                                                                            "properties": {
                                                                                                                                                "__typename": {
                                                                                                                                                    "type": "string"
                                                                                                                                                },
                                                                                                                                                "totalHits": {
                                                                                                                                                    "type": "integer"
                                                                                                                                                },
                                                                                                                                                "violations": {
                                                                                                                                                    "type": "integer"
                                                                                                                                                }
                                                                                                                                            },
                                                                                                                                            "type": [
                                                                                                                                                "object",
                                                                                                                                                "null"
                                                                                                                                            ]
                                                                                                                                        }
                                                                                                                                    },
                                                                                                                                    "type": "object"
                                                                                                                                },
                                                                                                                                "type": "array"
                                                                                                                            },
                                                                                                                            "hits": {
                                                                                                                                "properties": {
                                                                                                                                    "__typename": {
                                                                                                                                        "type": "string"
                                                                                                                                    },
                                                                                                                                    "totalHits": {
                                                                                                                                        "type": "integer"
                                                                                                                                    },
                                                                                                                                    "totalHitsDelta": {
                                                                                                                                        "type": "integer"
                                                                                                                                    },
                                                                                                                                    "violations": {
                                                                                                                                        "type": "integer"
                                                                                                                                    },
                                                                                                                                    "violationsDelta": {
                                                                                                                                        "type": "integer"
                                                                                                                                    }
                                                                                                                                },
                                                                                                                                "type": [
                                                                                                                                    "object",
                                                                                                                                    "null"
                                                                                                                                ]
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": "object"
                                                                                                                    },
                                                                                                                    "type": "array"
                                                                                                                },
                                                                                                                "directory": {
                                                                                                                    "type": "string"
                                                                                                                },
                                                                                                                "errorCode": {
                                                                                                                    "type": "string"
                                                                                                                },
                                                                                                                "filename": {
                                                                                                                    "type": "string"
                                                                                                                },
                                                                                                                "filesWithHits": {
                                                                                                                    "properties": {
                                                                                                                        "__typename": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "totalHits": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "violations": {
                                                                                                                            "type": "integer"
                                                                                                                        }
                                                                                                                    },
                                                                                                                    "type": [
                                                                                                                        "object",
                                                                                                                        "null"
                                                                                                                    ]
                                                                                                                },
                                                                                                                "hits": {
                                                                                                                    "properties": {
                                                                                                                        "__typename": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "totalHits": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "totalHitsDelta": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "violations": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "violationsDelta": {
                                                                                                                            "type": "integer"
                                                                                                                        }
                                                                                                                    },
                                                                                                                    "type": [
                                                                                                                        "object",
                                                                                                                        "null"
                                                                                                                    ]
                                                                                                                },
                                                                                                                "lastAccessTime": {
                                                                                                                    "type": "integer"
                                                                                                                },
                                                                                                                "lastModifiedTime": {
                                                                                                                    "type": "integer"
                                                                                                                },
                                                                                                                "mode": {
                                                                                                                    "type": "string"
                                                                                                                },
                                                                                                                "nativePath": {
                                                                                                                    "type": "string"
                                                                                                                },
                                                                                                                "numActivities": {
                                                                                                                    "type": "integer"
                                                                                                                },
                                                                                                                "numActivitiesDelta": {
                                                                                                                    "type": "integer"
                                                                                                                },
                                                                                                                "numDescendantErrorFiles": {
                                                                                                                    "type": "integer"
                                                                                                                },
                                                                                                                "numDescendantFiles": {
                                                                                                                    "type": "integer"
                                                                                                                },
                                                                                                                "numDescendantSkippedExtFiles": {
                                                                                                                    "type": "integer"
                                                                                                                },
                                                                                                                "numDescendantSkippedSizeFiles": {
                                                                                                                    "type": "integer"
                                                                                                                },
                                                                                                                "openAccessFilesWithHits": {
                                                                                                                    "properties": {
                                                                                                                        "__typename": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "totalHits": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "violations": {
                                                                                                                            "type": "integer"
                                                                                                                        }
                                                                                                                    },
                                                                                                                    "type": [
                                                                                                                        "object",
                                                                                                                        "null"
                                                                                                                    ]
                                                                                                                },
                                                                                                                "openAccessType": {
                                                                                                                    "type": "string"
                                                                                                                },
                                                                                                                "sensitiveFiles": {
                                                                                                                    "properties": {
                                                                                                                        "__typename": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "highRiskFileCount": {
                                                                                                                            "properties": {
                                                                                                                                "__typename": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "totalCount": {
                                                                                                                                    "type": "integer"
                                                                                                                                },
                                                                                                                                "violatedCount": {
                                                                                                                                    "type": "integer"
                                                                                                                                }
                                                                                                                            },
                                                                                                                            "type": "object"
                                                                                                                        },
                                                                                                                        "lowRiskFileCount": {
                                                                                                                            "properties": {
                                                                                                                                "__typename": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "totalCount": {
                                                                                                                                    "type": "integer"
                                                                                                                                },
                                                                                                                                "violatedCount": {
                                                                                                                                    "type": "integer"
                                                                                                                                }
                                                                                                                            },
                                                                                                                            "type": "object"
                                                                                                                        },
                                                                                                                        "mediumRiskFileCount": {
                                                                                                                            "properties": {
                                                                                                                                "__typename": {
                                                                                                                                    "type": "string"
                                                                                                                                },
                                                                                                                                "totalCount": {
                                                                                                                                    "type": "integer"
                                                                                                                                },
                                                                                                                                "violatedCount": {
                                                                                                                                    "type": "integer"
                                                                                                                                }
                                                                                                                            },
                                                                                                                            "type": "object"
                                                                                                                        }
                                                                                                                    },
                                                                                                                    "type": [
                                                                                                                        "object",
                                                                                                                        "null"
                                                                                                                    ]
                                                                                                                },
                                                                                                                "size": {
                                                                                                                    "type": "integer"
                                                                                                                },
                                                                                                                "staleFilesWithHits": {
                                                                                                                    "properties": {
                                                                                                                        "__typename": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "totalHits": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "violations": {
                                                                                                                            "type": "integer"
                                                                                                                        }
                                                                                                                    },
                                                                                                                    "type": [
                                                                                                                        "object",
                                                                                                                        "null"
                                                                                                                    ]
                                                                                                                },
                                                                                                                "stalenessType": {
                                                                                                                    "type": "string"
                                                                                                                },
                                                                                                                "stdPath": {
                                                                                                                    "type": "string"
                                                                                                                }
                                                                                                            },
                                                                                                            "type": "object"
                                                                                                        }
                                                                                                    },
                                                                                                    "required": [
                                                                                                        "cursor",
                                                                                                        "node",
                                                                                                        "__typename"
                                                                                                    ],
                                                                                                    "type": "object"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "pageInfo": {
                                                                                                "properties": {
                                                                                                    "__typename": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "endCursor": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "hasNextPage": {
                                                                                                        "type": "boolean"
                                                                                                    }
                                                                                                },
                                                                                                "type": "object"
                                                                                            }
                                                                                        },
                                                                                        "type": "object"
                                                                                    },
                                                                                    "id": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "type": "object"
                                                                            }
                                                                        },
                                                                        "type": "object"
                                                                    }
                                                                },
                                                                "type": "object"
                                                            }
                                                        }
                                                    },
                                                    "Send_Data": {
                                                        "runAfter": {
                                                            "Compose_2": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "ApiConnection",
                                                        "inputs": {
                                                            "body": "@{outputs('Compose_2')}",
                                                            "headers": {
                                                                "Log-Type": "[parameters('PolicyHitsTableName')]"
                                                            },
                                                            "host": {
                                                                "connection": {
                                                                    "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                                                                }
                                                            },
                                                            "method": "post",
                                                            "path": "/api/logs"
                                                        }
                                                    },
                                                    "Set_data_Found": {
                                                        "runAfter": {
                                                            "Send_Data": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "dataFound",
                                                            "value": "@true"
                                                        }
                                                    },
                                                    "Set_policyhits_to_null": {
                                                        "runAfter": {
                                                            "Set_data_Found": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "policyhits",
                                                            "value": "@null"
                                                        }
                                                    },
                                                    "Set_snapshotFound_to_true": {
                                                        "runAfter": {
                                                            "Parse_JSON_2": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "snapshotFound",
                                                            "value": "@true"
                                                        }
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@body('HTTP')?['data']",
                                                            "@null"
                                                        ]
                                                    },
                                                    {
                                                        "contains": [
                                                            "@variables('errorMessage')",
                                                            "No result rows returned"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Does_response_to_get_policy_hits_for_a_snapshot_contain_errors": {
                                            "actions": {
                                                "Set_errorMessage": {
                                                    "runAfter": {},
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "errorMessage",
                                                        "value": "@{body('HTTP')?['errors'][0]?['message']}"
                                                    }
                                                },
                                                "Set_has_Next_Page_to_false": {
                                                    "runAfter": {
                                                        "Set_errorMessage": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "hasNextPage",
                                                        "value": "@false"
                                                    }
                                                }
                                            },
                                            "runAfter": {},
                                            "expression": {
                                                "and": [
                                                    {
                                                        "contains": [
                                                            "@body('HTTP')",
                                                            "errors"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        }
                                    },
                                    "runAfter": {
                                        "HTTP": [
                                            "Succeeded"
                                        ]
                                    },
                                    "else": {
                                        "actions": {
                                            "Set_errorMessage_": {
                                                "runAfter": {},
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "errorMessage",
                                                    "value": "@{body('HTTP')?['message']}"
                                                }
                                            },
                                            "Set_variable": {
                                                "runAfter": {
                                                    "Set_errorMessage_": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "hasNextPage",
                                                    "value": "@false"
                                                }
                                            }
                                        }
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@outputs('HTTP')['statusCode']",
                                                    200
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If"
                                },
                                "HTTP": {
                                    "runAfter": {},
                                    "type": "Http",
                                    "inputs": {
                                        "body": {
                                            "query": "query CrawlsFileListQuery($snappableFid: String!, $snapshotFid: String!, $first: Int!, $after: String, $filters: ListFileResultFiltersInput, $sort: FileResultSortInput, $timezone: String!) {\r\n  policyObj(snappableFid: $snappableFid, snapshotFid: $snapshotFid) {\r\n    id: snapshotFid\r\n    fileResultConnection(first: $first, after: $after, filter: $filters, sort: $sort, timezone: $timezone) {\r\n      edges {\r\n        cursor\r\n        node {\r\n          ...DiscoveryFileFragment\r\n          __typename\r\n        }\r\n        __typename\r\n      }\r\n      pageInfo {\r\n        endCursor\r\n        hasNextPage\r\n        __typename\r\n      }\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n}\r\n\r\nfragment DiscoveryFileFragment on FileResult {\r\n  nativePath\r\n  stdPath\r\n  filename\r\n  mode\r\n  size\r\n  lastAccessTime\r\n  lastModifiedTime\r\n  directory\r\n  numDescendantFiles\r\n  numDescendantErrorFiles\r\n  numDescendantSkippedExtFiles\r\n  numDescendantSkippedSizeFiles\r\n  errorCode\r\n  hits {\r\n    totalHits\r\n    violations\r\n    violationsDelta\r\n    totalHitsDelta\r\n    __typename\r\n  }\r\n  filesWithHits {\r\n    totalHits\r\n    violations\r\n    __typename\r\n  }\r\n  openAccessFilesWithHits {\r\n    totalHits\r\n    violations\r\n    __typename\r\n  }\r\n  staleFilesWithHits {\r\n    totalHits\r\n    violations\r\n    __typename\r\n  }\r\n  analyzerGroupResults {\r\n    ...AnalyzerGroupResultFragment\r\n    __typename\r\n  }\r\n  sensitiveFiles {\r\n    highRiskFileCount {\r\n      totalCount\r\n      violatedCount\r\n      __typename\r\n    }\r\n    mediumRiskFileCount {\r\n      totalCount\r\n      violatedCount\r\n      __typename\r\n    }\r\n    lowRiskFileCount {\r\n      totalCount\r\n      violatedCount\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  openAccessType\r\n  stalenessType\r\n  numActivities\r\n  numActivitiesDelta\r\n  __typename\r\n}\r\n\r\nfragment AnalyzerGroupResultFragment on AnalyzerGroupResult {\r\n  analyzerGroup {\r\n    groupType\r\n    id\r\n    name\r\n    __typename\r\n  }\r\n  analyzerResults {\r\n    hits {\r\n      totalHits\r\n      violations\r\n      __typename\r\n    }\r\n    analyzer {\r\n      id\r\n      name\r\n      analyzerType\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n  hits {\r\n    totalHits\r\n    violations\r\n    violationsDelta\r\n    totalHitsDelta\r\n    __typename\r\n  }\r\n  __typename\r\n}",
                                            "variables": "@variables('variables')"
                                        },
                                        "headers": {
                                            "Authorization": "Bearer @{variables('accessToken')}"
                                        },
                                        "method": "POST",
                                        "uri": "@{variables('BaseUrl')}/api/graphql"
                                    }
                                }
                            },
                            "runAfter": {
                                "Initialize_variable": [
                                    "Succeeded"
                                ]
                            },
                            "expression": "@equals(or(equals(variables('snapshotFound'), true), not(empty(variables('errorMessage')))), true)",
                            "limit": {
                                "timeout": "PT12H"
                            },
                            "type": "Until"
                        }
                    },
                    "outputs": {}
                },
                "parameters": {
                    "$connections": {
                        "value": {
                            "azureloganalyticsdatacollector": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]",
                                "connectionName": "[variables('AzureloganalyticsdatacollectorConnectionName')]",
                                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Azureloganalyticsdatacollector')]"
                            },
                            "keyvault": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('KeyvaultConnectionName'))]",
                                "connectionName": "[variables('KeyvaultConnectionName')]",
                                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Keyvault')]"
                            },
                            "teams": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                                "connectionName": "[variables('TeamsConnectionName')]",
                                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Teams')]"
                            }
                        }
                    }
                }
            },
            "name": "[parameters('PlaybookName')]",
            "type": "Microsoft.Logic/workflows",
            "location": "[resourceGroup().location]",
            "tags": {
                "Rubrik": "Rubrik",
                "feature": "ObjectPolicyHits",
                "hidden-SentinelTemplateName": "RubrikFileObjectContextAnalysis",
                "hidden-SentinelTemplateVersion": "1.0"
            },
            "identity": {
                "type": "SystemAssigned"
            },
            "apiVersion": "2017-07-01",
            "dependsOn": [
                "[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]",
                "[resourceId('Microsoft.Web/connections', variables('KeyvaultConnectionName'))]",
                "[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
            ]
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('AzureloganalyticsdatacollectorConnectionName')]",
            "location": "[resourceGroup().location]",
            "kind": "V1",
            "properties": {
                "displayName": "[variables('AzureloganalyticsdatacollectorConnectionName')]",
                "customParameterValues": {},
                "api": {
                    "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Azureloganalyticsdatacollector')]"
                },
                "parameterValues": {
                    "username": "[parameters('LogAnalyticsWorkspaceId')]",
                    "password": "[parameters('LogAnalyticsWorkspaceKey')]"
                }
            }
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('KeyvaultConnectionName')]",
            "location": "[resourceGroup().location]",
            "kind": "V1",
            "properties": {
                "displayName": "[variables('KeyvaultConnectionName')]",
                "customParameterValues": {},
                "api": {
                    "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Keyvault')]"
                },
                "parameterValues": {
                    "token:TenantId": "[parameters('TenantId')]",
                    "token:grantType": "code",
                    "vaultName": "[parameters('KeyvaultName')]"
                }
            }
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('TeamsConnectionName')]",
            "location": "[resourceGroup().location]",
            "kind": "V1",
            "properties": {
                "displayName": "[variables('TeamsConnectionName')]",
                "customParameterValues": {},
                "api": {
                    "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Teams')]"
                }
            }
        }
    ]
}
