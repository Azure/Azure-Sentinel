{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "title": "Rubrik Retrieve User Intelligence Information",
        "description": "This playbook queries Rubrik Security Cloud to get risk detail and policy hits details for a username or email address, and enriches the incident by adding incident comment",
        "prerequisites": [
            "1. The Rubrik Security Cloud solution should be configured to [connect to Rubrik Security Cloud API end points using a Service Account](https://docs.rubrik.com/en-us/saas/saas/polaris_api_access_with_service_accounts.html), the service account should be assigned a role that includes the relevant privileges necessary to perform the desired operations (see [Roles and Permissions](https://docs.rubrik.com/en-us/saas/saas/common/roles_and_permissions.html) in the Rubrik Security Cloud user guide)."
        ],
        "postDeployment": [
            "**a. Authorize connections**",
            "Once deployment is complete, authorize each connection.",
            "1. Go to your logic app -> API connections -> Select azureloganalyticscollector connection resource",
            "2. Go to General -> edit API connection",
            "3. Click Authorize",
            "4. Sign in",
            "5. Click Save",
            "6. Repeat steps for other connections",
            "**b. Assign Role to add comment in incident**",
            "After authorizing each connection, assign role to this playbook.",
            "1. Go to Log Analytics Workspace → <your workspace> → Access Control → Add",
            "2. Add role assignment",
            "3. Assignment type: Job function roles",
            "4. Role: Microsoft Sentinel Contributor",
            "5. Members: select managed identity for assigned access to and add your logic app as member",
            "6. Click on review+assign"
        ],
        "entities": ["account"],
        "tags": ["User", "Risk", "Rubrik", "Policy"],
        "support": {
            "tier": "community",
            "armtemplate": "Generated from https://github.com/Azure/Azure-Sentinel/tree/master/Tools/Playbook-ARM-Template-Generator"
        },
        "lastUpdateTime": "2024-07-23T10:00:00.000Z",
        "author": {
            "name": "Rubrik"
        }
    },
    "parameters": {
        "PlaybookName": {
            "defaultValue": "RubrikRetrieveUserIntelligenceInformation",
            "minLength": 1,
            "type": "string",
            "metadata": {
                "description": "Please do not keep 'PlaybookName' parameter empty. Else you will receive validation failure"
            }
        },
        "LogAnalyticsWorkspaceId": {
            "type": "string",
            "metadata": {
                "description": "Id of log analytics workspace where you want to ingest data in Microsoft Sentinel"
            }
        },
        "LogAnalyticsWorkspaceKey": {
            "type": "string",
            "metadata": {
                "description": "PrimaryKey of log analytics workspace where you want to ingest data in Microsoft Sentinel"
            }
        },
        "UserDetailsTableName": {
            "type": "string",
            "metadata": {
                "description": "Table name in which you want to store user details data in Log Analytics Workspace(e.g. Rubrik_User_Access_Details)"
            }
        },
        "UserPolicyHitsTableName": {
            "type": "string",
            "metadata": {
                "description": "Table name in which you want to store policy hits data in Log Analytics Workspace(e.g. Rubrik_User_Policy_Hits_Details)"
            }
        }

    },
    "variables": {
        "AzureloganalyticsdatacollectorConnectionName": "[concat('Azureloganalyticsdatacollector-', parameters('PlaybookName'))]",
        "MicrosoftSentinelConnectionName": "[concat('MicrosoftSentinel-', parameters('PlaybookName'))]"
    },
    "resources": [
        {
            "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"
                        }
                    },
                    "triggers": {
                        "manual": {
                            "type": "Request",
                            "kind": "Http",
                            "inputs": {
                                "schema": {
                                    "properties": {
                                        "accessToken": {
                                            "type": "string"
                                        },
                                        "baseUrl": {
                                            "type": "string"
                                        },
                                        "incidentARMId": {
                                            "type": "string"
                                        },
                                        "userData": {
                                            "type": "array"
                                        },
                                        "userId": {
                                            "type": "string"
                                        }
                                    },
                                    "type": "object"
                                }
                            }
                        }
                    },
                    "actions": {
                        "Does_UserId_available": {
                            "actions": {
                                "Does_User_Details_request_get_status_code_equal_to_200": {
                                    "actions": {
                                        "Does_get_user_details_response_contain_errors": {
                                            "actions": {
                                                "Add_comment_to_incident_with_userDetails": {
                                                    "runAfter": {},
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": {
                                                            "incidentArmId": "@triggerBody()?['incidentARMId']",
                                                            "message": "<p><strong>USER DETAILS:</strong><br>\n<strong>User Fullname</strong>: @{variables('userData')[0]?['userDetails']?['userFullName']}<br>\n<strong>User Email:</strong> @{variables('userData')[0]?['userDetails']?['userEmail']}<br>\n<strong>User Id:</strong> @{variables('userData')[0]?['userDetails']?['userId']}<br>\n<br>\n<strong>SENSITIVE DATA ACCESS:</strong><br>\n<strong>HighRiskFiles:</strong> @{variables('userData')[0]?['sensitiveData']?['highRiskFiles']}<br>\n<strong>MediumRiskFiles:</strong> @{variables('userData')[0]?['sensitiveData']?['mediumRiskFiles']}<br>\n<strong>LowRiskFiles:</strong> @{variables('userData')[0]?['sensitiveData']?['lowRiskFiles']}<br>\n<strong>SensitiveObject:</strong> @{variables('userData')[0]?['sensitiveData']?['sensitiveObjects']}<br>\n<strong>SensitiveHits:</strong> @{variables('userData')[0]?['sensitiveData']?['sensitiveHits']}<br>\n<br>\n<strong>RISK DETAILS:</strong><br>\n<strong>RiskLevel:</strong> @{variables('userData')[0]?['RiskDetails']?['riskLevel']}<br>\n<br>\n<strong>Click here to view user on rubrik:</strong> @{variables('userHyperLink')}</p>"
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "path": "/Incidents/Comment"
                                                    }
                                                },
                                                "Failure_Response_": {
                                                    "runAfter": {
                                                        "Add_comment_to_incident_with_userDetails": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Response",
                                                    "kind": "Http",
                                                    "inputs": {
                                                        "body": "Unable to get user details due to error: @{body('Get_User_Details')?['errors'][0]?['message']}",
                                                        "statusCode": 200
                                                    }
                                                },
                                                "Terminate__due_to_error_in_response_of_get_user_riskdetails": {
                                                    "runAfter": {
                                                        "Failure_Response_": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Terminate",
                                                    "inputs": {
                                                        "runError": {
                                                            "message": "Unable to get user details due to error: @{body('Get_User_Details')?['errors'][0]?['message']}"
                                                        },
                                                        "runStatus": "Failed"
                                                    }
                                                }
                                            },
                                            "runAfter": {},
                                            "else": {
                                                "actions": {
                                                    "Compose_userdetails": {
                                                        "runAfter": {
                                                            "Prepapre_risk_reasons_data": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Compose",
                                                        "inputs": "@body('Parse_JSON_2')?['data']?['principalDetails']?['principalSummary']"
                                                    },
                                                    "For_each_usergroup": {
                                                        "foreach": "@body('Parse_JSON_2')?['data']?['principalDetails']?['directGroups']",
                                                        "actions": {
                                                            "Append_to_array_variable": {
                                                                "runAfter": {},
                                                                "type": "AppendToArrayVariable",
                                                                "inputs": {
                                                                    "name": "userGroups",
                                                                    "value": "@items('For_each_usergroup')?['name']"
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Parse_JSON_2": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Foreach",
                                                        "runtimeConfiguration": {
                                                            "concurrency": {
                                                                "repetitions": 1
                                                            }
                                                        }
                                                    },
                                                    "Parse_JSON_2": {
                                                        "runAfter": {},
                                                        "type": "ParseJson",
                                                        "inputs": {
                                                            "content": "@body('Get_User_Details')",
                                                            "schema": {
                                                                "properties": {
                                                                    "data": {
                                                                        "properties": {
                                                                            "principalDetails": {
                                                                                "properties": {
                                                                                    "__typename": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "directGroups": {
                                                                                        "items": {
                                                                                            "properties": {
                                                                                                "__typename": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "name": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "sid": {
                                                                                                    "type": "string"
                                                                                                }
                                                                                            },
                                                                                            "type": [
                                                                                                "object",
                                                                                                "null"
                                                                                            ]
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "principalSummary": {
                                                                                        "properties": {
                                                                                            "__typename": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "domainName": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "fullName": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "numDescendants": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "principalId": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "riskLevel": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "riskReasons": {
                                                                                                "properties": {
                                                                                                    "__typename": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "accessRiskReasons": {
                                                                                                        "items": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "type": "array"
                                                                                                    },
                                                                                                    "insecureReasons": {
                                                                                                        "items": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "type": "array"
                                                                                                    }
                                                                                                },
                                                                                                "type": [
                                                                                                    "object",
                                                                                                    "null"
                                                                                                ]
                                                                                            },
                                                                                            "sensitiveFiles": {
                                                                                                "properties": {
                                                                                                    "__typename": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "highRiskFileCount": {
                                                                                                        "properties": {
                                                                                                            "__typename": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "totalCount": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "violatedCount": {
                                                                                                                "type": "integer"
                                                                                                            }
                                                                                                        },
                                                                                                        "type": [
                                                                                                            "object",
                                                                                                            "null"
                                                                                                        ]
                                                                                                    },
                                                                                                    "lowRiskFileCount": {
                                                                                                        "properties": {
                                                                                                            "__typename": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "totalCount": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "violatedCount": {
                                                                                                                "type": "integer"
                                                                                                            }
                                                                                                        },
                                                                                                        "type": [
                                                                                                            "object",
                                                                                                            "null"
                                                                                                        ]
                                                                                                    },
                                                                                                    "mediumRiskFileCount": {
                                                                                                        "properties": {
                                                                                                            "__typename": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "totalCount": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "violatedCount": {
                                                                                                                "type": "integer"
                                                                                                            }
                                                                                                        },
                                                                                                        "type": [
                                                                                                            "object",
                                                                                                            "null"
                                                                                                        ]
                                                                                                    }
                                                                                                },
                                                                                                "type": [
                                                                                                    "object",
                                                                                                    "null"
                                                                                                ]
                                                                                            },
                                                                                            "sensitiveObjectCount": {
                                                                                                "properties": {
                                                                                                    "__typename": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "totalCount": {
                                                                                                        "type": "integer"
                                                                                                    },
                                                                                                    "violatedCount": {
                                                                                                        "type": "integer"
                                                                                                    }
                                                                                                },
                                                                                                "type": [
                                                                                                    "object",
                                                                                                    "null"
                                                                                                ]
                                                                                            },
                                                                                            "totalSensitiveHits": {
                                                                                                "properties": {
                                                                                                    "__typename": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "totalHits": {
                                                                                                        "type": "integer"
                                                                                                    },
                                                                                                    "violatedHits": {
                                                                                                        "type": "integer"
                                                                                                    }
                                                                                                },
                                                                                                "type": [
                                                                                                    "object",
                                                                                                    "null"
                                                                                                ]
                                                                                            },
                                                                                            "upn": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        },
                                                                                        "type": "object"
                                                                                    }
                                                                                },
                                                                                "type": "object"
                                                                            }
                                                                        },
                                                                        "type": "object"
                                                                    }
                                                                },
                                                                "type": "object"
                                                            }
                                                        }
                                                    },
                                                    "Prepapre_risk_reasons_data": {
                                                        "runAfter": {
                                                            "For_each_usergroup": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Compose",
                                                        "inputs": {
                                                            "accessRiskReasons": "@body('Parse_JSON_2')?['data']?['principalDetails']?['principalSummary']?['riskReasons']?['accessRiskReasons']",
                                                            "groups": "@variables('userGroups')",
                                                            "insecureReasons": "@body('Parse_JSON_2')?['data']?['principalDetails']?['principalSummary']?['riskReasons']?['insecureReasons']"
                                                        }
                                                    },
                                                    "Send_User_Details_to_Workspace": {
                                                        "runAfter": {
                                                            "Compose_userdetails": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "ApiConnection",
                                                        "inputs": {
                                                            "body": "@{outputs('Compose_userdetails')}",
                                                            "headers": {
                                                                "Log-Type": "@variables('userDetailsLogType')"
                                                            },
                                                            "host": {
                                                                "connection": {
                                                                    "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                                                                }
                                                            },
                                                            "method": "post",
                                                            "path": "/api/logs"
                                                        }
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "contains": [
                                                            "@body('Get_User_Details')",
                                                            "errors"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        }
                                    },
                                    "runAfter": {
                                        "Get_User_Details": [
                                            "Succeeded",
                                            "Failed"
                                        ]
                                    },
                                    "else": {
                                        "actions": {
                                            "Add_comment_to_incident_with_user_access_details_only": {
                                                "runAfter": {},
                                                "type": "ApiConnection",
                                                "inputs": {
                                                    "body": {
                                                        "incidentArmId": "@triggerBody()?['incidentARMId']",
                                                        "message": "<p><strong>USER DETAILS:<br>\nUser Fullname: </strong><strong>@{variables('userData')[0]?['userDetails']?['userFullName']}</strong><strong><br>\nUser Email: </strong><strong>@{variables('userData')[0]?['userDetails']?['userEmail']}</strong><strong><br>\nUser Id: </strong><strong>@{variables('userData')[0]?['userDetails']?['userId']}</strong><strong><br>\n<br>\nSENSITIVE DATA ACCESS:<br>\nHighRiskFiles: </strong><strong>@{variables('userData')[0]?['sensitiveData']?['highRiskFiles']}</strong><strong><br>\nMediumRiskFiles: </strong><strong>@{variables('userData')[0]?['sensitiveData']?['mediumRiskFiles']}</strong><strong><br>\nLowRiskFiles: </strong><strong>@{variables('userData')[0]?['sensitiveData']?['lowRiskFiles']}</strong><strong><br>\nSensitiveObject: </strong><strong>@{variables('userData')[0]?['sensitiveData']?['sensitiveObjects']}</strong><strong><br>\nSensitiveHits: </strong><strong>@{variables('userData')[0]?['sensitiveData']?['sensitiveHits']}</strong><strong><br>\n<br>\nRISK DETAILS:<br>\nRiskLevel: </strong><strong>@{variables('userData')[0]?['RiskDetails']?['riskLevel']}</strong><strong><br>\n<br>\nClick here to view user on rubrik: </strong>@{variables('userHyperLink')}</p>"
                                                    },
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                        }
                                                    },
                                                    "method": "post",
                                                    "path": "/Incidents/Comment"
                                                }
                                            },
                                            "Failure_response_with_userData_added": {
                                                "runAfter": {
                                                    "Add_comment_to_incident_with_user_access_details_only": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Response",
                                                "kind": "Http",
                                                "inputs": {
                                                    "body": "User Access Details are added as incident comment. Error Occurred while retrieving user risk details: @{body('Get_User_Details')?['message']}",
                                                    "statusCode": 400
                                                }
                                            },
                                            "Terminate": {
                                                "runAfter": {
                                                    "Failure_response_with_userData_added": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Terminate",
                                                "inputs": {
                                                    "runError": {
                                                        "code": "@{outputs('Get_User_Details')['statusCode']}",
                                                        "message": "Unable to get user risk details due to error: @{body('Get_User_Details')?['message']}"
                                                    },
                                                    "runStatus": "Failed"
                                                }
                                            }
                                        }
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@outputs('Get_User_Details')['statusCode']",
                                                    200
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If"
                                },
                                "Does_policy_hits_for_user_request_get_status_code_equal_to_200": {
                                    "actions": {
                                        "Does_response_of_policy_hits_of_user_contain_errors": {
                                            "actions": {
                                                "Add_comment_to_incident_with_user_and_risk_details": {
                                                    "runAfter": {},
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": {
                                                            "incidentArmId": "@triggerBody()?['incidentARMId']",
                                                            "message": "<p><span style=\"font-size: 14px\"><strong>USER DETAILS:</strong></span><br>\n<strong>User Fullname:</strong> @{variables('userData')[0]?['userDetails']?['userFullName']}<br>\n<strong>User Email:</strong> @{variables('userData')[0]?['userDetails']?['userEmail']}<br>\n<strong>User Id:</strong> @{variables('userData')[0]?['userDetails']?['userId']}<br>\n<br>\n<span style=\"font-size: 14px\"><strong>SENSITIVE DATA ACCESS:</strong></span><br>\n<strong>HighRiskFiles:</strong> @{variables('userData')[0]?['sensitiveData']?['highRiskFiles']}<br>\n<strong>MediumRiskFiles: </strong>@{variables('userData')[0]?['sensitiveData']?['mediumRiskFiles']}<br>\n<strong>LowRiskFiles:</strong> @{variables('userData')[0]?['sensitiveData']?['lowRiskFiles']}<br>\n<strong>SensitiveObject:</strong> @{variables('userData')[0]?['sensitiveData']?['sensitiveObjects']}<br>\n<strong>SensitiveHits:</strong> @{variables('userData')[0]?['sensitiveData']?['sensitiveHits']}<br>\n<br>\n<span style=\"font-size: 14px\"><strong>RISK DETAILS:</strong></span><br>\n<strong>RiskLevel:</strong> @{variables('userData')[0]?['RiskDetails']?['riskLevel']}<br>\n<br>\n<span style=\"font-size: 14px\"><strong>RISK REASONS:</strong></span><br>\n<strong>AccessRiskReasons:</strong> @{variables('userData')[0]?['riskReasons']?['accessRiskReasons']}<br>\n<strong>InsecureReasons:</strong> @{variables('userData')[0]?['riskReasons']?['insecureReasons']}<br>\n<strong>Groups:</strong> @{variables('userData')[0]?['riskReasons']?['groups']}<br>\n<br>\n<strong>Click here to view user on rubrik:</strong> @{variables('userHyperLink')}</p>"
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "path": "/Incidents/Comment"
                                                    }
                                                },
                                                "Failure_Response_2": {
                                                    "runAfter": {
                                                        "Add_comment_to_incident_with_user_and_risk_details": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Response",
                                                    "kind": "Http",
                                                    "inputs": {
                                                        "body": "Unable to get policy hits detail for user. Error: @{body('Get_Policy_hits_details_for_user')?['errors'][0]?['message']}",
                                                        "statusCode": 200
                                                    }
                                                },
                                                "Terminate_due_to_error_in_response_of_users_policy_hits": {
                                                    "runAfter": {
                                                        "Failure_Response_2": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Terminate",
                                                    "inputs": {
                                                        "runError": {
                                                            "message": "Unable to get policy hits detail for user. Error: @{body('Get_Policy_hits_details_for_user')?['errors'][0]?['message']}"
                                                        },
                                                        "runStatus": "Failed"
                                                    }
                                                }
                                            },
                                            "runAfter": {},
                                            "else": {
                                                "actions": {
                                                    "Add_comment_to_incident_with_user_data": {
                                                        "runAfter": {
                                                            "Does_policy_hits_reponse_contain_data": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "ApiConnection",
                                                        "inputs": {
                                                            "body": {
                                                                "incidentArmId": "@triggerBody()?['incidentARMId']",
                                                                "message": "<p><span style=\"font-size: 14px\"><strong>USER DETAILS:</strong></span><br>\n<strong>User Fullname:</strong> @{variables('userData')[0]?['userDetails']?['userFullName']}<br>\n<strong>User Email:</strong> @{variables('userData')[0]?['userDetails']?['userEmail']}<br>\n<strong>User Id:</strong> @{variables('userData')[0]?['userDetails']?['userId']}<br>\n<br>\n<span style=\"font-size: 14px\"><strong>SENSITIVE DATA ACCESS:</strong></span><br>\n<strong>HighRiskFiles:</strong> @{variables('userData')[0]?['sensitiveData']?['highRiskFiles']}<br>\n<strong>MediumRiskFiles:</strong> @{variables('userData')[0]?['sensitiveData']?['mediumRiskFiles']}<br>\n<strong>LowRiskFiles:</strong> @{variables('userData')[0]?['sensitiveData']?['lowRiskFiles']}<br>\n<strong>SensitiveObject:</strong> @{variables('userData')[0]?['sensitiveData']?['sensitiveObjects']}<br>\n<strong>SensitiveHits:</strong> @{variables('userData')[0]?['sensitiveData']?['sensitiveHits']}<br>\n<br>\n<span style=\"font-size: 14px\"><strong>RISK DETAILS:</strong></span><br>\n<strong>RiskLevel:</strong> @{variables('userData')[0]?['RiskDetails']?['riskLevel']}<br>\n<br>\n<span style=\"font-size: 14px\"><strong>RISK REASONS:</strong></span><br>\n<strong>AccessRiskReasons: </strong>@{outputs('Prepapre_risk_reasons_data')?['accessRiskReasons']}<br>\n<strong>InsecureReasons: </strong>@{outputs('Prepapre_risk_reasons_data')?['insecureReasons']}<br>\n<strong>Groups:</strong> @{outputs('Prepapre_risk_reasons_data')?['groups']}<br>\n<br>\n<strong>Click here to view user on rubrik:</strong> @{variables('userHyperLink')}</p>"
                                                            },
                                                            "host": {
                                                                "connection": {
                                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                }
                                                            },
                                                            "method": "post",
                                                            "path": "/Incidents/Comment"
                                                        }
                                                    },
                                                    "Does_policy_hits_reponse_contain_data": {
                                                        "actions": {
                                                            "Add_comment_to_incident_with_user_policy_data": {
                                                                "runAfter": {
                                                                    "Create_HTML_table": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection",
                                                                "inputs": {
                                                                    "body": {
                                                                        "incidentArmId": "@triggerBody()?['incidentARMId']",
                                                                        "message": "<p><strong>User Policy Hits Data(id = </strong><strong>@{variables('userId')}</strong><strong>)</strong><br>\n@{body('Create_HTML_table')}</p>"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "post",
                                                                    "path": "/Incidents/Comment"
                                                                }
                                                            },
                                                            "Create_HTML_table": {
                                                                "runAfter": {
                                                                    "Send_Policy_hits_details_to_Workspace": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Table",
                                                                "inputs": {
                                                                    "columns": [
                                                                        {
                                                                            "header": "policyName",
                                                                            "value": "@item()?['policyName']"
                                                                        },
                                                                        {
                                                                            "header": "fileCount",
                                                                            "value": "@item()?['fileCount']"
                                                                        },
                                                                        {
                                                                            "header": "highRiskHits",
                                                                            "value": "@item()?['hitsCount']?['HighRiskHits']"
                                                                        },
                                                                        {
                                                                            "header": "mediumRiskHits",
                                                                            "value": "@item()?['hitsCount']?['MediumRiskHits']"
                                                                        },
                                                                        {
                                                                            "header": "lowRiskHits",
                                                                            "value": "@item()?['hitsCount']?['LowRiskHits']"
                                                                        },
                                                                        {
                                                                            "header": "totalHits",
                                                                            "value": "@item()?['hitsCount']?['TotalHits']"
                                                                        }
                                                                    ],
                                                                    "format": "HTML",
                                                                    "from": "@variables('userPolicyData')"
                                                                }
                                                            },
                                                            "For_each_userId": {
                                                                "foreach": "@body('Parse_JSON_3')?['data']?['sidsPolicyHitsSummary']?['sidSummaries']",
                                                                "actions": {
                                                                    "For_each_policy": {
                                                                        "foreach": "@items('For_each_userId')?['summary']",
                                                                        "actions": {
                                                                            "Append_to_userPolicyData": {
                                                                                "runAfter": {},
                                                                                "type": "AppendToArrayVariable",
                                                                                "inputs": {
                                                                                    "name": "userPolicyData",
                                                                                    "value": {
                                                                                        "fileCount": "@items('For_each_policy')?['sidSensitiveFiles']?['totalFileCount']?['totalCount']",
                                                                                        "hitsCount": {
                                                                                            "HighRiskHits": "@items('For_each_policy')?['sidAnalyzerHits']?['highRiskHits']?['totalHits']",
                                                                                            "LowRiskHits": "@items('For_each_policy')?['sidAnalyzerHits']?['lowRiskHits']?['totalHits']",
                                                                                            "MediumRiskHits": "@items('For_each_policy')?['sidAnalyzerHits']?['mediumRiskHits']?['totalHits']",
                                                                                            "TotalHits": "@items('For_each_policy')?['sidAnalyzerHits']?['totalHits']?['totalHits']"
                                                                                        },
                                                                                        "policyName": "@items('For_each_policy')?['policyName']",
                                                                                        "userId": "@variables('userId')"
                                                                                    }
                                                                                }
                                                                            }
                                                                        },
                                                                        "runAfter": {},
                                                                        "type": "Foreach"
                                                                    }
                                                                },
                                                                "runAfter": {},
                                                                "type": "Foreach",
                                                                "runtimeConfiguration": {
                                                                    "concurrency": {
                                                                        "repetitions": 1
                                                                    }
                                                                }
                                                            },
                                                            "Send_Policy_hits_details_to_Workspace": {
                                                                "runAfter": {
                                                                    "For_each_userId": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection",
                                                                "inputs": {
                                                                    "body": "@{variables('userPolicyData')}",
                                                                    "headers": {
                                                                        "Log-Type": "@variables('userPolicyHitsDataLogType')"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "post",
                                                                    "path": "/api/logs"
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Parse_JSON_3": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "else": {
                                                            "actions": {
                                                                "Add_comment_to_incident_for_no_policy_hits_data": {
                                                                    "runAfter": {},
                                                                    "type": "ApiConnection",
                                                                    "inputs": {
                                                                        "body": {
                                                                            "incidentArmId": "@triggerBody()?['incidentARMId']",
                                                                            "message": "<p>No policy hits details available for user @{variables('userId')}</p>"
                                                                        },
                                                                        "host": {
                                                                            "connection": {
                                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                            }
                                                                        },
                                                                        "method": "post",
                                                                        "path": "/Incidents/Comment"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "expression": {
                                                            "and": [
                                                                {
                                                                    "equals": [
                                                                        "@empty(body('Parse_JSON_3')?['data']?['sidsPolicyHitsSummary']?['sidSummaries'])",
                                                                        "@false"
                                                                    ]
                                                                }
                                                            ]
                                                        },
                                                        "type": "If"
                                                    },
                                                    "Parse_JSON_3": {
                                                        "runAfter": {},
                                                        "type": "ParseJson",
                                                        "inputs": {
                                                            "content": "@body('Get_Policy_hits_details_for_user')",
                                                            "schema": {
                                                                "properties": {
                                                                    "data": {
                                                                        "properties": {
                                                                            "sidsPolicyHitsSummary": {
                                                                                "properties": {
                                                                                    "__typename": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "sidSummaries": {
                                                                                        "items": {
                                                                                            "properties": {
                                                                                                "__typename": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "principal": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "summary": {
                                                                                                    "items": {
                                                                                                        "properties": {
                                                                                                            "__typename": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "policyId": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "policyName": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "sidAnalyzerHits": {
                                                                                                                "properties": {
                                                                                                                    "__typename": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "highRiskHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "lowRiskHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "mediumRiskHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "totalHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    }
                                                                                                                },
                                                                                                                "type": [
                                                                                                                    "object",
                                                                                                                    "null"
                                                                                                                ]
                                                                                                            },
                                                                                                            "sidDeltaAnalyzerHits": {
                                                                                                                "properties": {
                                                                                                                    "__typename": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "highRiskHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "lowRiskHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "mediumRiskHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "totalHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    }
                                                                                                                },
                                                                                                                "type": [
                                                                                                                    "object",
                                                                                                                    "null"
                                                                                                                ]
                                                                                                            },
                                                                                                            "sidDeltaRiskHits": {
                                                                                                                "properties": {
                                                                                                                    "__typename": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "highRiskHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "lowRiskHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "mediumRiskHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "totalHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    }
                                                                                                                },
                                                                                                                "type": [
                                                                                                                    "object",
                                                                                                                    "null"
                                                                                                                ]
                                                                                                            },
                                                                                                            "sidRiskHits": {
                                                                                                                "properties": {
                                                                                                                    "__typename": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "highRiskHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "lowRiskHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "mediumRiskHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    },
                                                                                                                    "totalHits": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalHits": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedHits": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    }
                                                                                                                },
                                                                                                                "type": [
                                                                                                                    "object",
                                                                                                                    "null"
                                                                                                                ]
                                                                                                            },
                                                                                                            "sidSensitiveFiles": {
                                                                                                                "properties": {
                                                                                                                    "__typename": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "totalFileCount": {
                                                                                                                        "properties": {
                                                                                                                            "__typename": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "totalCount": {
                                                                                                                                "type": "integer"
                                                                                                                            },
                                                                                                                            "violatedCount": {
                                                                                                                                "type": "integer"
                                                                                                                            }
                                                                                                                        },
                                                                                                                        "type": [
                                                                                                                            "object",
                                                                                                                            "null"
                                                                                                                        ]
                                                                                                                    }
                                                                                                                },
                                                                                                                "type": [
                                                                                                                    "object",
                                                                                                                    "null"
                                                                                                                ]
                                                                                                            }
                                                                                                        },
                                                                                                        "type": [
                                                                                                            "object",
                                                                                                            "null"
                                                                                                        ]
                                                                                                    },
                                                                                                    "type": "array"
                                                                                                }
                                                                                            },
                                                                                            "required": [
                                                                                                "principal",
                                                                                                "summary",
                                                                                                "__typename"
                                                                                            ],
                                                                                            "type": "object"
                                                                                        },
                                                                                        "type": "array"
                                                                                    }
                                                                                },
                                                                                "type": "object"
                                                                            }
                                                                        },
                                                                        "type": "object"
                                                                    }
                                                                },
                                                                "type": "object"
                                                            }
                                                        }
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "contains": [
                                                            "@body('Get_Policy_hits_details_for_user')",
                                                            "errors"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        }
                                    },
                                    "runAfter": {
                                        "Get_Policy_hits_details_for_user": [
                                            "Succeeded",
                                            "Failed"
                                        ]
                                    },
                                    "else": {
                                        "actions": {
                                            "Add_comment_to_incident_with_user_and_risk_details_only": {
                                                "runAfter": {},
                                                "type": "ApiConnection",
                                                "inputs": {
                                                    "body": {
                                                        "incidentArmId": "@triggerBody()?['incidentARMId']",
                                                        "message": "<p><strong>USER DETAILS:</strong><br>\n<strong>User Fullname: </strong>@{variables('userData')[0]?['userDetails']?['userFullName']}<br>\n<strong>User Email:</strong> @{variables('userData')[0]?['userDetails']?['userEmail']}<br>\n<strong>User Id:</strong> @{variables('userData')[0]?['userDetails']?['userId']}<br>\n<br>\n<strong>SENSITIVE DATA ACCESS:</strong><br>\n<strong>HighRiskFiles: </strong>@{variables('userData')[0]?['sensitiveData']?['highRiskFiles']}<br>\n<strong>MediumRiskFiles:</strong> @{variables('userData')[0]?['sensitiveData']?['mediumRiskFiles']}<br>\n<strong>LowRiskFiles:</strong> @{variables('userData')[0]?['sensitiveData']?['lowRiskFiles']}<br>\n<strong>SensitiveObject:</strong> @{variables('userData')[0]?['sensitiveData']?['sensitiveObjects']}<br>\n<strong>SensitiveHits:</strong> @{variables('userData')[0]?['sensitiveData']?['sensitiveHits']}<br>\n<br>\n<strong>RISK DETAILS:</strong><br>\n<strong>RiskLevel:</strong> @{variables('userData')[0]?['RiskDetails']?['riskLevel']}<br>\n<br>\n<strong>RISK REASONS:<br>\nAccessRiskReasons: </strong><strong>@{variables('userData')[0]?['riskReasons']?['accessRiskReasons']}</strong><strong><br>\nInsecureReasons: </strong><strong>@{variables('userData')[0]?['riskReasons']?['insecureReasons']}</strong><strong><br>\nGroups: </strong><strong>@{variables('userData')[0]?['riskReasons']?['groups']}</strong><strong><br>\n<br>\nClick here to view user on rubrik: </strong>@{variables('userHyperLink')}</p>"
                                                    },
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                        }
                                                    },
                                                    "method": "post",
                                                    "path": "/Incidents/Comment"
                                                }
                                            },
                                            "Failure_Response_with_user_access_and_risk_data_success": {
                                                "runAfter": {
                                                    "Add_comment_to_incident_with_user_and_risk_details_only": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Response",
                                                "kind": "Http",
                                                "inputs": {
                                                    "body": "Comments are added to the incident with User Access and Risk Details. Error Occurred while retrieving policy hits data for user: @{body('Get_Policy_hits_details_for_user')?['message']}",
                                                    "statusCode": 400
                                                }
                                            },
                                            "Terminate_due_to_api_failure_of_get_policy_hits_of_user": {
                                                "runAfter": {
                                                    "Failure_Response_with_user_access_and_risk_data_success": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Terminate",
                                                "inputs": {
                                                    "runError": {
                                                        "code": "@{outputs('Get_Policy_hits_details_for_user')['statusCode']}",
                                                        "message": "Unable to get policy hits detail for user. Error: @{body('Get_Policy_hits_details_for_user')?['message']}"
                                                    },
                                                    "runStatus": "Failed"
                                                }
                                            }
                                        }
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@outputs('Get_Policy_hits_details_for_user')['statusCode']",
                                                    200
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If"
                                },
                                "Failure_Response": {
                                    "runAfter": {
                                        "Does_policy_hits_for_user_request_get_status_code_equal_to_200": [
                                            "Skipped",
                                            "TimedOut",
                                            "Failed"
                                        ]
                                    },
                                    "type": "Response",
                                    "kind": "Http",
                                    "inputs": {
                                        "body": "@if(or(equals(body('Add_comment_to_incident_with_user_policy_data'), 400), equals(body('Add_comment_to_incident_with_user_data'),400)), 'Incident reached maximum number of comments (100)', 'Error occurred: Please check detailed execution in subplaybook RubrikRetrieveUserIntelligenceInformation')",
                                        "statusCode": 400
                                    }
                                },
                                "Get_Policy_hits_details_for_user": {
                                    "runAfter": {
                                        "Does_User_Details_request_get_status_code_equal_to_200": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Http",
                                    "inputs": {
                                        "body": {
                                            "query": "query PrincipalPolicyHitsSummaryChartQuery($sids: [String!]!, $day: String!, $historicalDeltaDays: Int!, $includeWhitelistedResults: Boolean) {\r\n  sidsPolicyHitsSummary(\r\n    sids: $sids\r\n    day: $day\r\n    historicalDeltaDays: $historicalDeltaDays\r\n    includeWhitelistedResults: $includeWhitelistedResults\r\n  ) {\r\n    sidSummaries {\r\n      principal\r\n      summary {\r\n        policyId\r\n        policyName\r\n        sidSensitiveFiles {\r\n          totalFileCount {\r\n            totalCount\r\n            violatedCount\r\n            __typename\r\n          }\r\n          __typename\r\n        }\r\n        sidAnalyzerHits {\r\n          ...PrincipalSensitiveHitsFragment\r\n          __typename\r\n        }\r\n        sidDeltaAnalyzerHits {\r\n          ...PrincipalSensitiveHitsFragment\r\n          __typename\r\n        }\r\n        sidRiskHits {\r\n          ...PrincipalSensitiveHitsFragment\r\n          __typename\r\n        }\r\n        sidDeltaRiskHits {\r\n          ...PrincipalSensitiveHitsFragment\r\n          __typename\r\n        }\r\n        __typename\r\n      }\r\n      __typename\r\n    }\r\n    __typename\r\n  }\r\n}\r\n\r\nfragment PrincipalSensitiveHitsFragment on SensitiveHits {\r\n  highRiskHits {\r\n    ...SummaryHitsFragment\r\n    __typename\r\n  }\r\n  mediumRiskHits {\r\n    ...SummaryHitsFragment\r\n    __typename\r\n  }\r\n  lowRiskHits {\r\n    ...SummaryHitsFragment\r\n    __typename\r\n  }\r\n  totalHits {\r\n    ...SummaryHitsFragment\r\n    __typename\r\n  }\r\n  __typename\r\n}\r\n\r\nfragment SummaryHitsFragment on SummaryHits {\r\n  totalHits\r\n  violatedHits\r\n  __typename\r\n}",
                                            "variables": {
                                                "day": "@{concat(formatDateTime(utcNow(),'yyyy-MM-dd'),'T00:00:00+00:00')}",
                                                "historicalDeltaDays": 7,
                                                "includeWhitelistedResults": false,
                                                "sids": [
                                                    "@{variables('userId')}"
                                                ]
                                            }
                                        },
                                        "headers": {
                                            "Authorization": "@variables('AccessToken')"
                                        },
                                        "method": "POST",
                                        "uri": "@{variables('BaseUrl')}/api/graphql"
                                    }
                                },
                                "Get_User_Details": {
                                    "runAfter": {},
                                    "type": "Http",
                                    "inputs": {
                                        "body": {
                                            "query": "query UserAccessUserDetailsQuery($sid: String!, $timelineDate: String!, $includeWhitelistedResults: Boolean) {\r\n    principalDetails(\r\n        sid: $sid\r\n        timelineDate: $timelineDate\r\n        includeWhitelistedResults: $includeWhitelistedResults\r\n    ) {\r\n        ...UserAccessUserSummaryFragment\r\n        __typename\r\n    }\r\n}\r\n\r\n\r\nfragment UserAccessUserSummaryFragment on PrincipalDetails {\r\n    principalSummary {\r\n        principalId\r\n        fullName\r\n        upn\r\n        riskLevel\r\n        riskReasons {\r\n            accessRiskReasons\r\n            insecureReasons\r\n            __typename\r\n        }\r\n        sensitiveFiles {\r\n            ...SensitiveFilesTableCellFragment\r\n            __typename\r\n        }\r\n        totalSensitiveHits {\r\n            ...SummaryHitsFragment\r\n            __typename\r\n        }\r\n        sensitiveObjectCount {\r\n            ...SummaryCountFragment\r\n            __typename\r\n        }\r\n        numDescendants\r\n        domainName\r\n        __typename\r\n    }\r\n    directGroups {\r\n        name\r\n        sid\r\n        __typename\r\n    }\r\n    __typename\r\n}\r\n\r\n\r\nfragment SensitiveFilesTableCellFragment on SensitiveFiles {\r\n  highRiskFileCount {\r\n    ...SummaryCountFragment\r\n    __typename\r\n  }\r\n  mediumRiskFileCount {\r\n    ...SummaryCountFragment\r\n    __typename\r\n  }\r\n  lowRiskFileCount {\r\n    ...SummaryCountFragment\r\n    __typename\r\n  }\r\n  __typename\r\n}\r\n\r\n\r\nfragment SummaryCountFragment on SummaryCount {\r\n  totalCount\r\n  violatedCount\r\n  __typename\r\n}\r\n\r\n\r\nfragment SummaryHitsFragment on SummaryHits {\r\n  totalHits\r\n  violatedHits\r\n  __typename\r\n}\r\n",
                                            "variables": {
                                                "sid": "@{variables('userId')}",
                                                "timelineDate": "@{concat(formatDateTime(utcNow(),'yyyy-MM-dd'),'T00:00:00+00:00')}"
                                            }
                                        },
                                        "headers": {
                                            "Authorization": "Bearer @{variables('AccessToken')}"
                                        },
                                        "method": "POST",
                                        "uri": "@{variables('BaseUrl')}/api/graphql"
                                    }
                                },
                                "Success_Response": {
                                    "runAfter": {
                                        "Does_policy_hits_for_user_request_get_status_code_equal_to_200": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Response",
                                    "kind": "Http",
                                    "inputs": {
                                        "body": "Comments are added to incident related to Risk Details and Policy Hits Data for user @{variables('userId')}",
                                        "statusCode": 200
                                    }
                                }
                            },
                            "runAfter": {
                                "Username_or_Email": [
                                    "Succeeded"
                                ]
                            },
                            "else": {
                                "actions": {
                                    "Add_comment_to_incident_(V3)": {
                                        "runAfter": {},
                                        "type": "ApiConnection",
                                        "inputs": {
                                            "body": {
                                                "incidentArmId": "@triggerBody()?['incidentARMId']",
                                                "message": "<p>No user with name @{outputs('Username_or_Email')} is available.</p>"
                                            },
                                            "host": {
                                                "connection": {
                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                }
                                            },
                                            "method": "post",
                                            "path": "/Incidents/Comment"
                                        }
                                    },
                                    "Terminate_as_user_does_not_exist": {
                                        "runAfter": {
                                            "Add_comment_to_incident_(V3)": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "Terminate",
                                        "inputs": {
                                            "runStatus": "Succeeded"
                                        }
                                    }
                                }
                            },
                            "expression": {
                                "and": [
                                    {
                                        "not": {
                                            "equals": [
                                                "@empty(variables('userId'))",
                                                "@true"
                                            ]
                                        }
                                    }
                                ]
                            },
                            "type": "If"
                        },
                        "Initialize_AccessToken": {
                            "runAfter": {
                                "Initialize_userId": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "AccessToken",
                                        "type": "string",
                                        "value": "@triggerBody()?['accessToken']"
                                    }
                                ]
                            }
                        },
                        "Initialize_BaseUrl": {
                            "runAfter": {
                                "Initialize_AccessToken": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "BaseUrl",
                                        "type": "string",
                                        "value": "@triggerBody()?['baseUrl']"
                                    }
                                ]
                            }
                        },
                        "Initialize_Email": {
                            "runAfter": {
                                "Initialize_userGroups": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "UserEmail",
                                        "type": "string",
                                        "value": "@triggerBody()?['userEmail']"
                                    }
                                ]
                            }
                        },
                        "Initialize_Username": {
                            "runAfter": {
                                "Initialize_status": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Username",
                                        "type": "string",
                                        "value": "@triggerBody()?['userName']"
                                    }
                                ]
                            }
                        },
                        "Initialize_errormessage": {
                            "runAfter": {
                                "Initialize_users_data": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "errorMessage",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_status": {
                            "runAfter": {
                                "Initialize_errormessage": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "useremailFound",
                                        "type": "boolean",
                                        "value": "@false"
                                    }
                                ]
                            }
                        },
                        "Initialize_userGroups": {
                            "runAfter": {
                                "Initialize_Username": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "userGroups",
                                        "type": "array"
                                    }
                                ]
                            }
                        },
                        "Initialize_userHyperLink": {
                            "runAfter": {
                                "Initialize_user_policy_hits_data_logType": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "userHyperLink",
                                        "type": "string",
                                        "value": "@{concat(variables('BaseUrl'),'/sonar/user_intelligence?redirected_user_id=',variables('userId'))}"
                                    }
                                ]
                            }
                        },
                        "Initialize_userId": {
                            "runAfter": {},
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "userId",
                                        "type": "string",
                                        "value": "@triggerBody()?['userId']"
                                    }
                                ]
                            }
                        },
                        "Initialize_userPolicy": {
                            "runAfter": {
                                "Initialize_BaseUrl": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "userPolicyData",
                                        "type": "array"
                                    }
                                ]
                            }
                        },
                        "Initialize_user_policy_hits_data_logType": {
                            "runAfter": {
                                "Initialize_userdetails_logType": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "userPolicyHitsDataLogType",
                                        "type": "string",
                                        "value": "[parameters('UserPolicyHitsTableName')]"
                                    }
                                ]
                            }
                        },
                        "Initialize_userdetails_logType": {
                            "runAfter": {
                                "Initialize_Email": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "userDetailsLogType",
                                        "type": "string",
                                        "value": "[parameters('UserDetailsTableName')]"
                                    }
                                ]
                            }
                        },
                        "Initialize_users_data": {
                            "runAfter": {
                                "Initialize_userPolicy": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "userData",
                                        "type": "array",
                                        "value": "@triggerBody()?['userData']"
                                    }
                                ]
                            }
                        },
                        "Username_or_Email": {
                            "inputs": "@if(empty(variables('Username')),variables('UserEmail'),variables('Username'))",
                            "runAfter": {
                                "Initialize_userHyperLink": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Compose"
                        }
                    },
                    "outputs": {}
                },
                "parameters": {
                    "$connections": {
                        "value": {
                            "azureloganalyticsdatacollector": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]",
                                "connectionName": "[variables('AzureloganalyticsdatacollectorConnectionName')]",
                                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Azureloganalyticsdatacollector')]"
                            },
                            "azuresentinel": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                "connectionName": "[variables('MicrosoftSentinelConnectionName')]",
                                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Azuresentinel')]",
                                "connectionProperties": {
                                    "authentication": {
                                        "type": "ManagedServiceIdentity"
                                    }
                                }
                            }
                        }
                    }
                }
            },
            "name": "[parameters('PlaybookName')]",
            "type": "Microsoft.Logic/workflows",
            "location": "[resourceGroup().location]",
            "tags": {
                "hidden-SentinelTemplateName": "RubrikRetrieveUserIntelligenceInformation",
                "hidden-SentinelTemplateVersion": "1.0"
            },
            "identity": {
                "type": "SystemAssigned"
            },
            "apiVersion": "2017-07-01",
            "dependsOn": [
                "[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]",
                "[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]"
            ]
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('AzureloganalyticsdatacollectorConnectionName')]",
            "location": "[resourceGroup().location]",
            "kind": "V1",
            "properties": {
                "displayName": "[variables('AzureloganalyticsdatacollectorConnectionName')]",
                "customParameterValues": {},
                "api": {
                    "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Azureloganalyticsdatacollector')]"
                },
                "parameterValues": {
                    "username": "[parameters('LogAnalyticsWorkspaceId')]",
                    "password": "[parameters('LogAnalyticsWorkspaceKey')]"
                }
            }
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('MicrosoftSentinelConnectionName')]",
            "location": "[resourceGroup().location]",
            "kind": "V1",
            "properties": {
                "displayName": "[variables('MicrosoftSentinelConnectionName')]",
                "customParameterValues": {},
                "parameterValueType": "Alternative",
                "api": {
                    "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Azuresentinel')]"
                }
            }
        }
    ]
}
