[
  {
    "location": "[parameters('workspace-location')]",
    "apiVersion": "2022-06-01",
    "name": "RubrikProtectionStatusDCE",
    "properties": {
      "networkAcls": {
        "publicNetworkAccess": "Enabled"
      }
    },
    "type": "Microsoft.Insights/dataCollectionEndpoints"
  },
  {
    "location": "[parameters('workspace-location')]",
    "apiVersion": "2022-06-01",
    "name": "RubrikProtectionStatusDCR",
    "properties": {
      "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', 'RSCBackupStatusDCE')]",
      "streamDeclarations": {
        "Custom-RubrikBackupStatus_API": {
          "columns": [
            {
              "name": "id",
              "type": "string"
            },
            {
              "name": "name",
              "type": "string"
            },
            {
              "name": "objectType",
              "type": "string"
            },
            {
              "name": "objectState",
              "type": "string"
            },
            {
              "name": "protectionStatus",
              "type": "string"
            },
            {
              "name": "complianceStatus",
              "type": "string"
            },
            {
              "name": "archivalComplianceStatus",
              "type": "string"
            },
            {
              "name": "replicationComplianceStatus",
              "type": "string"
            },
            {
              "name": "lastSnapshot",
              "type": "datetime"
            },
            {
              "name": "latestArchivalSnapshot",
              "type": "datetime"
            },
            {
              "name": "latestReplicationSnapshot",
              "type": "datetime"
            },
            {
              "name": "protectedOn",
              "type": "datetime"
            },
            {
              "name": "pullTime",
              "type": "datetime"
            },
            {
              "name": "location",
              "type": "string"
            },
            {
              "name": "cluster",
              "type": "dynamic"
            },
            {
              "name": "slaDomain",
              "type": "dynamic"
            },
            {
              "name": "workloadOrg",
              "type": "dynamic"
            },
            {
              "name": "orgName",
              "type": "string"
            },
            {
              "name": "fid",
              "type": "string"
            },
            {
              "name": "orgId",
              "type": "string"
            },
            {
              "name": "awaitingFirstFull",
              "type": "boolean"
            },
            {
              "name": "archivalSnapshotLag",
              "type": "int"
            },
            {
              "name": "replicationSnapshotLag",
              "type": "int"
            },
            {
              "name": "missedSnapshots",
              "type": "int"
            },
            {
              "name": "totalSnapshots",
              "type": "int"
            },
            {
              "name": "localSnapshots",
              "type": "int"
            },
            {
              "name": "localSlaSnapshots",
              "type": "int"
            },
            {
              "name": "localOnDemandSnapshots",
              "type": "int"
            },
            {
              "name": "archiveSnapshots",
              "type": "int"
            },
            {
              "name": "replicaSnapshots",
              "type": "int"
            },
            {
              "name": "localStorage",
              "type": "long"
            },
            {
              "name": "archiveStorage",
              "type": "long"
            },
            {
              "name": "replicaStorage",
              "type": "long"
            },
            {
              "name": "localEffectiveStorage",
              "type": "long"
            },
            {
              "name": "logicalBytes",
              "type": "long"
            },
            {
              "name": "physicalBytes",
              "type": "long"
            },
            {
              "name": "usedBytes",
              "type": "long"
            },
            {
              "name": "provisionedBytes",
              "type": "long"
            },
            {
              "name": "transferredBytes",
              "type": "long"
            },
            {
              "name": "localProtectedData",
              "type": "long"
            },
            {
              "name": "localMeteredData",
              "type": "long"
            },
            {
              "name": "lastSnapshotLogicalBytes",
              "type": "long"
            },
            {
              "name": "dataReduction",
              "type": "real"
            },
            {
              "name": "logicalDataReduction",
              "type": "real"
            },
            {
              "name": "sourceProtocol",
              "type": "string"
            },
            {
              "name": "ncdPolicyName",
              "type": "string"
            },
            {
              "name": "ncdSnapshotType",
              "type": "string"
            },
            {
              "name": "ncdLatestArchiveSnapshot",
              "type": "datetime"
            }
          ]
        }
      },
      "destinations": {
        "logAnalytics": [
          {
            "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace'))]",
            "name": "clv2ws1"
          }
        ]
      },
      "dataFlows": [
        {
          "streams": [
            "Custom-RubrikBackupStatus_API"
          ],
          "destinations": [
            "clv2ws1"
          ],
          "transformKql": "source | project TimeGenerated = now(), AssetId = id, AssetName = name, ObjectType = objectType, ObjectState = objectState, ProtectionStatus = protectionStatus, ComplianceStatus = complianceStatus, ArchivalComplianceStatus = archivalComplianceStatus, ReplicationComplianceStatus = replicationComplianceStatus, LastSnapshot = todatetime(lastSnapshot), LatestArchivalSnapshot = todatetime(latestArchivalSnapshot), LatestReplicationSnapshot = todatetime(latestReplicationSnapshot), ProtectedOn = todatetime(protectedOn), PullTime = todatetime(pullTime), Location = location, ClusterName = tostring(cluster.name), SlaDomainName = tostring(slaDomain.name), WorkloadOrgName = tostring(workloadOrg.name), OrgName = orgName, Fid = fid, OrgId = orgId, AwaitingFirstFull = tobool(awaitingFirstFull), ArchivalSnapshotLag = toint(archivalSnapshotLag), ReplicationSnapshotLag = toint(replicationSnapshotLag), MissedSnapshots = toint(missedSnapshots), TotalSnapshots = toint(totalSnapshots), LocalSnapshots = toint(localSnapshots), LocalSlaSnapshots = toint(localSlaSnapshots), LocalOnDemandSnapshots = toint(localOnDemandSnapshots), ArchiveSnapshots = toint(archiveSnapshots), ReplicaSnapshots = toint(replicaSnapshots), LocalStorage = tolong(localStorage), ArchiveStorage = tolong(archiveStorage), ReplicaStorage = tolong(replicaStorage), LocalEffectiveStorage = tolong(localEffectiveStorage), LogicalBytes = tolong(logicalBytes), PhysicalBytes = tolong(physicalBytes), UsedBytes = tolong(usedBytes), ProvisionedBytes = tolong(provisionedBytes), TransferredBytes = tolong(transferredBytes), LocalProtectedData = tolong(localProtectedData), LocalMeteredData = tolong(localMeteredData), LastSnapshotLogicalBytes = tolong(lastSnapshotLogicalBytes), DataReduction = toreal(dataReduction), LogicalDataReduction = toreal(logicalDataReduction), SourceProtocol = sourceProtocol, NcdPolicyName = ncdPolicyName, NcdSnapshotType = ncdSnapshotType, NcdLatestArchiveSnapshot = todatetime(ncdLatestArchiveSnapshot), SourceSystem = 'Rubrik Security Cloud'",
          "outputStream": "Custom-RubrikProtectionStatus_CL"
        }
      ]
    },
    "type": "Microsoft.Insights/dataCollectionRules"
  }
]
