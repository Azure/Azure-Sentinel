[
    {
        "name": "GCPAuditLogs",
        "apiVersion": "2021-09-01-preview",
        "type": "Microsoft.Insights/dataCollectionRules",
        "properties": {
            "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
            "streamDeclarations": {
                "Custom-GCPAuditLogs": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "operation",
                            "type": "dynamic"
                        },
                        {
                            "name": "jsonPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "receiveTimestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        },
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "protoPayload",
                            "type": "dynamic"
                        }
                    ]
                }
            },
            "destinations": {
                "logAnalytics": [
                    {
                        "name": "clv2ws1"
                    }
                ]
            },
            "dataFlows": [
                {
                    "streams": [
                        "Custom-GCPAuditLogs"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source | extend statusJson = protoPayload.status, authenticationInfoProperties = protoPayload.authenticationInfo, requestProperties = protoPayload.request, resourceLabel = resource.labels, TimeGenerated = todatetime(receiveTimestamp), ServiceName = tostring(protoPayload.serviceName), MethodName = tostring(protoPayload.methodName), GCPResourceName = tostring(protoPayload.resourceName), NumResponseItems = tostring(protoPayload.numResponseItems), Status = todynamic(protoPayload.status), AuthenticationInfo = todynamic(protoPayload.authenticationInfo), AuthorizationInfo = todynamic(protoPayload.authorizationInfo), RequestMetadata = todynamic(protoPayload.requestMetadata), Request = todynamic(protoPayload.request), Response = todynamic(protoPayload.response), Metadata = todynamic(protoPayload.metadata), StatusMessage = tostring(protoPayload.status.message), PrincipalEmail = tostring(protoPayload.authenticationInfo.principalEmail), LogName = logName, Timestamp = todatetime(timestamp), ProjectId = tostring(resource.labels.project_id), Severity = severity, GCPResourceType = tostring(resource.type), Subscription = tostring(resource.subscription), ResourceLocation = todynamic(protoPayload.resourceLocation), ResourceOriginalState = todynamic(protoPayload.resourceOriginalState), ServiceData = todynamic(protoPayload.serviceData), InsertId = tostring(insertId), JsonPayloadDynamic = parse_json(jsonPayload), OperationDynamic = parse_json(operation), ResourceDynamic = parse_json(resource) | extend JsonPayloadType = tostring(JsonPayloadDynamic['@type']), JsonPayloadAccesses = tostring(JsonPayloadDynamic['accesses']), JsonPayloadEventId = tostring(JsonPayloadDynamic['eventId']), JsonPayloadLocationPrincipalEmployingEntity = tostring(JsonPayloadDynamic['location']['principalEmployingEntity']), JsonPayloadLocationPrincipalOfficeCountry = tostring(JsonPayloadDynamic['location']['principalOfficeCountry']), JsonPayloadLocationPrincipalPhysicalLocationCountry = tostring(JsonPayloadDynamic['location']['principalPhysicalLocationCountry']), JsonPayloadLogMode = tostring(JsonPayloadDynamic['logMode']), JsonPayloadPrincipalJobTitle = tostring(JsonPayloadDynamic['principalJobTitle']), JsonPayloadProduct = tostring(JsonPayloadDynamic['product']), JsonPayloadReason = tostring(JsonPayloadDynamic['reason']), OperationId = tostring(OperationDynamic['id']), ResourceLabelsProjectId = tostring(ResourceDynamic['labels']['project_id']), ResourceType = tostring(ResourceDynamic['type']) | project TimeGenerated, InsertId, LogName, Severity, ProjectId, Timestamp, JsonPayloadType, JsonPayloadAccesses, JsonPayloadEventId, JsonPayloadLocationPrincipalEmployingEntity, JsonPayloadLocationPrincipalOfficeCountry, JsonPayloadLocationPrincipalPhysicalLocationCountry, JsonPayloadLogMode, JsonPayloadPrincipalJobTitle, JsonPayloadProduct, JsonPayloadReason, OperationId, ResourceLabelsProjectId, ResourceType, GCPResourceType, ServiceName, MethodName, GCPResourceName, NumResponseItems, Status, AuthenticationInfo, AuthorizationInfo, RequestMetadata, Request, Response, Metadata, StatusMessage, PrincipalEmail, Subscription, ResourceLocation, ResourceOriginalState, ServiceData ",
                    "outputStream": "Custom-GCPAuditLogsV2_CL"
                }
            ]
        }
    }
]