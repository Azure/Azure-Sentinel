[
    {
        "name": "GCPAuditLogs",
        "apiVersion": "2021-09-01-preview",
        "type": "Microsoft.Insights/dataCollectionRules",
        "properties": {
            "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
            "streamDeclarations": {
                "Custom-GCPAuditLogs": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "jsonPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "receiveTimestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        },
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "protoPayload",
                            "type": "dynamic"
                        }
                    ]
                },
                "Custom-GCPTransparencyLogs": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "operation",
                            "type": "dynamic"
                        },
                        {
                            "name": "jsonPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "receiveTimestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        },
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "protoPayload",
                            "type": "dynamic"
                        }
                    ]
                }
            },
            "destinations": {
                "logAnalytics": [
                    {
                        "name": "clv2ws1"
                    }
                ]
            },
            "dataFlows": [
                {
                    "streams": [
                        "Custom-GCPAuditLogs"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source | extend TimeGenerated = todatetime(receiveTimestamp),InsertId = tostring(insertId),LogName = tostring(logName),Resource = todynamic(resource),Timestamp = todatetime(timestamp), Severity = tostring(severity) ,ProtoPayload= todynamic(protoPayload), ResourceDynamic = parse_json(resource) | project TimeGenerated, InsertId,Resource,ProtoPayload, LogName, Severity, Timestamp ",
                    "outputStream": "Custom-GCPAuditLogsV2_CL"
                },
                {
                    "streams": [
                        "Custom-GCPTransparencyLogs"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source | extend JsonPayloadDynamic = parse_json(jsonPayload), extend ResourceDynamic = parse_json(resource), Operation = parse_json(operation) | extend TimeGenerated = todatetime(receiveTimestamp), LogName = tostring(logName), Timestamp = todatetime(timestamp), Severity = tostring(severity), InsertId = tostring(insertId), JsonPayloadType = tostring(JsonPayloadDynamic['@type']), JsonPayloadAccesses = tostring(JsonPayloadDynamic['accesses']), JsonPayloadEventId = tostring(JsonPayloadDynamic['eventId']), JsonPayloadLocationPrincipalEmployingEntity = tostring(JsonPayloadDynamic['location']['principalEmployingEntity']), JsonPayloadLocationPrincipalOfficeCountry = tostring(JsonPayloadDynamic['location']['principalOfficeCountry']), JsonPayloadLocationPrincipalPhysicalLocationCountry = tostring(JsonPayloadDynamic['location']['principalPhysicalLocationCountry']), JsonPayloadLogMode = tostring(JsonPayloadDynamic['logMode']), JsonPayloadPrincipalJobTitle = tostring(JsonPayloadDynamic['principalJobTitle']), JsonPayloadProduct = tostring(JsonPayloadDynamic['product']), JsonPayloadReason = tostring(JsonPayloadDynamic['reason']), OperationId = tostring(Operation['id']), ResourceLabelsProjectId = tostring(ResourceDynamic['labels']['project_id']), ResourceType = tostring(ResourceDynamic['type']) | project TimeGenerated, InsertId, LogName, Severity, Timestamp, JsonPayloadType, JsonPayloadAccesses, JsonPayloadEventId, JsonPayloadLocationPrincipalEmployingEntity, JsonPayloadLocationPrincipalOfficeCountry, JsonPayloadLocationPrincipalPhysicalLocationCountry, JsonPayloadLogMode, JsonPayloadPrincipalJobTitle, JsonPayloadProduct, JsonPayloadReason, ResourceLabelsProjectId,ResourceType, OperationId",
                    "outputStream": "Custom-GCPTransparencyLogsV2_CL"
                }
            ]
        }
    }
]

