{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for VMware Carbon Black Cloud"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "VMware Carbon Black Cloud",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "solutionId": "azuresentinel.azure-sentinel-solution-vmwarecarbonblack",
    "_solutionId": "[variables('solutionId')]",
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "uiConfigId1": "VMwareCarbonBlack",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "VMwareCarbonBlack",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1')))]",
    "dataConnectorVersion1": "1.0.0",
    "analyticRuleVersion1": "1.0.1",
    "analyticRulecontentId1": "2ca4e7fc-c61a-49e5-9736-5da8035c47e0",
    "_analyticRulecontentId1": "[variables('analyticRulecontentId1')]",
    "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId1'))]",
    "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId1')))]",
    "analyticRuleVersion2": "1.0.1",
    "analyticRulecontentId2": "9f86885f-f31f-4e66-a39d-352771ee789e",
    "_analyticRulecontentId2": "[variables('analyticRulecontentId2')]",
    "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId2'))]",
    "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId2')))]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "VMwareCarbonBlack",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1')))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "CarbonBlackConnector": "CarbonBlackConnector",
    "_CarbonBlackConnector": "[variables('CarbonBlackConnector')]",
    "TemplateEmptyArray": "[json('[]')]",
    "blanks": "[replace('b', 'b', '')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "CarbonBlackConnector",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'-lc-',uniquestring(variables('_playbookContentId1')))]",
    "CarbonBlack-TakeDeviceActionFromTeams": "CarbonBlack-TakeDeviceActionFromTeams",
    "_CarbonBlack-TakeDeviceActionFromTeams": "[variables('CarbonBlack-TakeDeviceActionFromTeams')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "CarbonBlack-TakeDeviceActionFromTeams",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2')))]",
    "CarbonBlack-QuarantineDevice": "CarbonBlack-QuarantineDevice",
    "_CarbonBlack-QuarantineDevice": "[variables('CarbonBlack-QuarantineDevice')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "CarbonBlack-QuarantineDevice",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3')))]",
    "CarbonBlack-DeviceEnrichment": "CarbonBlack-DeviceEnrichment",
    "_CarbonBlack-DeviceEnrichment": "[variables('CarbonBlack-DeviceEnrichment')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "CarbonBlack-DeviceEnrichment",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "properties": {
        "description": "VMware Carbon Black Cloud data connector with template",
        "displayName": "VMware Carbon Black Cloud template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('dataConnectorTemplateSpecName1'),'/',variables('dataConnectorVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('dataConnectorTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "VMware Carbon Black Cloud data connector with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "VMware Carbon Black Cloud (using Azure Functions)",
                  "publisher": "VMware",
                  "descriptionMarkdown": "The [VMware Carbon Black Cloud](https://www.vmware.com/products/carbon-black-cloud.html) connector provides the capability to ingest Carbon Black data into Microsoft Sentinel. The connector provides visibility into Audit, Notification and Event logs in Microsoft Sentinel to view dashboards, create custom alerts, and to improve monitoring and investigation capabilities.",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "CarbonBlackEvents_CL",
                      "baseQuery": "CarbonBlackEvents_CL"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "CarbonBlackNotifications_CL",
                      "baseQuery": "CarbonBlackNotifications_CL"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "CarbonBlackAuditLogs_CL",
                      "baseQuery": "CarbonBlackAuditLogs_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Top 10 Event Generating Endpoints",
                      "query": "CarbonBlackEvents_CL\n | summarize count() by deviceDetails_deviceName_s \n| top 10 by count_"
                    },
                    {
                      "description": "Top 10 User Console Logins",
                      "query": "CarbonBlackAuditLogs_CL\n | summarize count() by loginName_s \n| top 10 by count_"
                    },
                    {
                      "description": "Top 10 Threats",
                      "query": "CarbonBlackNotifications_CL\n | summarize count() by threatHunterInfo_reportName_s \n| top 10 by count_"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CarbonBlackEvents_CL",
                      "lastDataReceivedQuery": "CarbonBlackEvents_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "CarbonBlackAuditLogs_CL",
                      "lastDataReceivedQuery": "CarbonBlackAuditLogs_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "CarbonBlackNotifications_CL",
                      "lastDataReceivedQuery": "CarbonBlackNotifications_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CarbonBlackEvents_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                        "CarbonBlackNotifications_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                        "CarbonBlackAuditLogs_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft.Web/sites permissions",
                        "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
                      },
                      {
                        "name": "VMware Carbon Black API Key(s)",
                        "description": "Carbon Black API and/or SIEM Level API Key(s) are required. See the documentation to learn more about the [Carbon Black API](https://developer.carbonblack.com/reference/carbon-black-cloud/cb-defense/latest/rest-api/).\n - A Carbon Black **API** access level API ID and Key is required for [Audit](https://developer.carbonblack.com/reference/carbon-black-cloud/cb-defense/latest/rest-api/#audit-log-events) and [Event](https://developer.carbonblack.com/reference/carbon-black-cloud/platform/latest/data-forwarder-config-api/) logs. \n - A Carbon Black **SIEM** access level  API ID and Key is required for [Notification](https://developer.carbonblack.com/reference/carbon-black-cloud/cb-defense/latest/rest-api/#notifications) alerts."
                      },
                      {
                        "name": "Amazon S3 REST API Credentials/permissions",
                        "description": "**AWS Access Key Id**, **AWS Secret Access Key**, **AWS S3 Bucket Name**, **Folder Name in AWS S3 Bucket** are required for Amazon S3 REST API."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": ">**NOTE:** This connector uses Azure Functions to connect to VMware Carbon Black to pull its logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
                    },
                    {
                      "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
                    },
                    {
                      "description": "**STEP 1 - Configuration steps for the VMware Carbon Black API**\n\n [Follow these instructions](https://developer.carbonblack.com/reference/carbon-black-cloud/authentication/#creating-an-api-key) to create an API Key."
                    },
                    {
                      "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the VMware Carbon Black connector, have the Workspace ID and Workspace Primary Key (can be copied from the following), as well as the VMware Carbon Black API Authorization Key(s), readily available.",
                      "instructions": [
                        {
                          "parameters": {
                            "fillWith": [
                              "WorkspaceId"
                            ],
                            "label": "Workspace ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "fillWith": [
                              "PrimaryKey"
                            ],
                            "label": "Primary Key"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    },
                    {
                      "description": "This method provides an automated deployment of the VMware Carbon Black connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinelcarbonblackazuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Workspace ID**, **Workspace Key**, **Log Types**, **API ID(s)**, **API Key(s)**, **Carbon Black Org Key**, **S3 Bucket Name**, **AWS Access Key Id**, **AWS Secret Access Key**, **EventPrefixFolderName**,**AlertPrefixFolderName**,  and validate the **URI**.\n> - Enter the URI that corresponds to your region. The complete list of API URLs can be [found here](https://community.carbonblack.com/t5/Knowledge-Base/PSC-What-URLs-are-used-to-access-the-APIs/ta-p/67346)\n - The default **Time Interval** is set to pull the last five (5) minutes of data. If the time interval needs to be modified, it is recommended to change the Function App Timer Trigger accordingly (in the function.json file, post deployment) to prevent overlapping data ingestion. \n - Carbon Black requires a seperate set of API ID/Keys to ingest Notification alerts. Enter the SIEM API ID/Key values or leave blank, if not required. \n> - Note: If using Azure Key Vault secrets for any of the values above, use the`@Microsoft.KeyVault(SecretUri={Security Identifier})`schema in place of the string values. Refer to [Key Vault references documentation](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) for further details. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy.",
                      "title": "Option 1 - Azure Resource Manager (ARM) Template"
                    },
                    {
                      "description": "Use the following step-by-step instructions to deploy the VMware Carbon Black connector manually with Azure Functions.",
                      "title": "Option 2 - Manual Deployment of Azure Functions"
                    },
                    {
                      "description": "**1. Create a Function App**\n\n1.  From the Azure Portal, navigate to [Function App](https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Web%2Fsites/kind/functionapp), and select **+ Add**.\n2. In the **Basics** tab, ensure Runtime stack is set to **Powershell Core**. \n3. In the **Hosting** tab, ensure the **Consumption (Serverless)** plan type is selected.\n4. Make other preferrable configuration changes, if needed, then click **Create**."
                    },
                    {
                      "description": "**2. Import Function App Code**\n\n1. In the newly created Function App, select **Functions** on the left pane and click **+ Add**.\n2. Select **Timer Trigger**.\n3. Enter a unique Function **Name** and modify the cron schedule, if needed. The default value is set to run the Function App every 5 minutes. (Note: the Timer trigger should match the `timeInterval` value below to prevent overlapping data), click **Create**.\n4. Click on **Code + Test** on the left pane. \n5. Copy the [Function App Code](https://aka.ms/sentinelcarbonblackazurefunctioncode) and paste into the Function App `run.ps1` editor.\n5. Click **Save**."
                    },
                    {
                      "description": "**3. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select **+ New application setting**.\n3. Add each of the following thirteen to sixteen (13-16) application settings individually, with their respective string values (case-sensitive): \n\t\tapiId\n\t\tapiKey\n\t\tworkspaceID\n\t\tworkspaceKey\n\t\turi\n\t\ttimeInterval\n\t\tCarbonBlackOrgKey\n\t\tCarbonBlackLogTypes \n\t\ts3BucketName \n\t\tEventPrefixFolderName \n\t\tAlertPrefixFolderName \n\t\tAWSAccessKeyId \n\t\tAWSSecretAccessKey \n\t\tSIEMapiId (Optional)\n\t\tSIEMapiKey (Optional)\n\t\tlogAnalyticsUri (optional) \n> - Enter the URI that corresponds to your region. The complete list of API URLs can be [found here](https://community.carbonblack.com/t5/Knowledge-Base/PSC-What-URLs-are-used-to-access-the-APIs/ta-p/67346). The `uri` value must follow the following schema: `https://<API URL>.conferdeploy.net` - There is no need to add a time suffix to the URI, the Function App will dynamically append the Time Value to the URI in the proper format.\n> - Set the `timeInterval` (in minutes) to the default value of `5` to correspond to the default Timer Trigger of every `5` minutes. If the time interval needs to be modified, it is recommended to change the Function App Timer Trigger accordingly to prevent overlapping data ingestion.\n> - Carbon Black requires a seperate set of API ID/Keys to ingest Notification alerts. Enter the `SIEMapiId` and `SIEMapiKey` values, if needed, or omit, if not required. \n> - Note: If using Azure Key Vault, use the`@Microsoft.KeyVault(SecretUri={Security Identifier})`schema in place of the string values. Refer to [Key Vault references documentation](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) for further details. \n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`\n4. Once all application settings have been entered, click **Save**."
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "VMware Carbon Black Cloud",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft",
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "VMware Carbon Black Cloud",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft",
          "tier": "Microsoft",
          "email": "support@microsoft.com",
          "link": "https://support.microsoft.com/"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "VMware Carbon Black Cloud (using Azure Functions)",
          "publisher": "VMware",
          "descriptionMarkdown": "The [VMware Carbon Black Cloud](https://www.vmware.com/products/carbon-black-cloud.html) connector provides the capability to ingest Carbon Black data into Microsoft Sentinel. The connector provides visibility into Audit, Notification and Event logs in Microsoft Sentinel to view dashboards, create custom alerts, and to improve monitoring and investigation capabilities.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "CarbonBlackEvents_CL",
              "baseQuery": "CarbonBlackEvents_CL"
            },
            {
              "metricName": "Total data received",
              "legend": "CarbonBlackNotifications_CL",
              "baseQuery": "CarbonBlackNotifications_CL"
            },
            {
              "metricName": "Total data received",
              "legend": "CarbonBlackAuditLogs_CL",
              "baseQuery": "CarbonBlackAuditLogs_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "CarbonBlackEvents_CL",
              "lastDataReceivedQuery": "CarbonBlackEvents_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "CarbonBlackAuditLogs_CL",
              "lastDataReceivedQuery": "CarbonBlackAuditLogs_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "CarbonBlackNotifications_CL",
              "lastDataReceivedQuery": "CarbonBlackNotifications_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CarbonBlackEvents_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                "CarbonBlackNotifications_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                "CarbonBlackAuditLogs_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "Top 10 Event Generating Endpoints",
              "query": "CarbonBlackEvents_CL\n | summarize count() by deviceDetails_deviceName_s \n| top 10 by count_"
            },
            {
              "description": "Top 10 User Console Logins",
              "query": "CarbonBlackAuditLogs_CL\n | summarize count() by loginName_s \n| top 10 by count_"
            },
            {
              "description": "Top 10 Threats",
              "query": "CarbonBlackNotifications_CL\n | summarize count() by threatHunterInfo_reportName_s \n| top 10 by count_"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "VMware Carbon Black API Key(s)",
                "description": "Carbon Black API and/or SIEM Level API Key(s) are required. See the documentation to learn more about the [Carbon Black API](https://developer.carbonblack.com/reference/carbon-black-cloud/cb-defense/latest/rest-api/).\n - A Carbon Black **API** access level API ID and Key is required for [Audit](https://developer.carbonblack.com/reference/carbon-black-cloud/cb-defense/latest/rest-api/#audit-log-events) and [Event](https://developer.carbonblack.com/reference/carbon-black-cloud/platform/latest/data-forwarder-config-api/) logs. \n - A Carbon Black **SIEM** access level  API ID and Key is required for [Notification](https://developer.carbonblack.com/reference/carbon-black-cloud/cb-defense/latest/rest-api/#notifications) alerts."
              },
              {
                "name": "Amazon S3 REST API Credentials/permissions",
                "description": "**AWS Access Key Id**, **AWS Secret Access Key**, **AWS S3 Bucket Name**, **Folder Name in AWS S3 Bucket** are required for Amazon S3 REST API."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to VMware Carbon Black to pull its logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
            },
            {
              "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
            },
            {
              "description": "**STEP 1 - Configuration steps for the VMware Carbon Black API**\n\n [Follow these instructions](https://developer.carbonblack.com/reference/carbon-black-cloud/authentication/#creating-an-api-key) to create an API Key."
            },
            {
              "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the VMware Carbon Black connector, have the Workspace ID and Workspace Primary Key (can be copied from the following), as well as the VMware Carbon Black API Authorization Key(s), readily available.",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "fillWith": [
                      "PrimaryKey"
                    ],
                    "label": "Primary Key"
                  },
                  "type": "CopyableLabel"
                }
              ]
            },
            {
              "description": "This method provides an automated deployment of the VMware Carbon Black connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinelcarbonblackazuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Workspace ID**, **Workspace Key**, **Log Types**, **API ID(s)**, **API Key(s)**, **Carbon Black Org Key**, **S3 Bucket Name**, **AWS Access Key Id**, **AWS Secret Access Key**, **EventPrefixFolderName**,**AlertPrefixFolderName**,  and validate the **URI**.\n> - Enter the URI that corresponds to your region. The complete list of API URLs can be [found here](https://community.carbonblack.com/t5/Knowledge-Base/PSC-What-URLs-are-used-to-access-the-APIs/ta-p/67346)\n - The default **Time Interval** is set to pull the last five (5) minutes of data. If the time interval needs to be modified, it is recommended to change the Function App Timer Trigger accordingly (in the function.json file, post deployment) to prevent overlapping data ingestion. \n - Carbon Black requires a seperate set of API ID/Keys to ingest Notification alerts. Enter the SIEM API ID/Key values or leave blank, if not required. \n> - Note: If using Azure Key Vault secrets for any of the values above, use the`@Microsoft.KeyVault(SecretUri={Security Identifier})`schema in place of the string values. Refer to [Key Vault references documentation](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) for further details. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy.",
              "title": "Option 1 - Azure Resource Manager (ARM) Template"
            },
            {
              "description": "Use the following step-by-step instructions to deploy the VMware Carbon Black connector manually with Azure Functions.",
              "title": "Option 2 - Manual Deployment of Azure Functions"
            },
            {
              "description": "**1. Create a Function App**\n\n1.  From the Azure Portal, navigate to [Function App](https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Web%2Fsites/kind/functionapp), and select **+ Add**.\n2. In the **Basics** tab, ensure Runtime stack is set to **Powershell Core**. \n3. In the **Hosting** tab, ensure the **Consumption (Serverless)** plan type is selected.\n4. Make other preferrable configuration changes, if needed, then click **Create**."
            },
            {
              "description": "**2. Import Function App Code**\n\n1. In the newly created Function App, select **Functions** on the left pane and click **+ Add**.\n2. Select **Timer Trigger**.\n3. Enter a unique Function **Name** and modify the cron schedule, if needed. The default value is set to run the Function App every 5 minutes. (Note: the Timer trigger should match the `timeInterval` value below to prevent overlapping data), click **Create**.\n4. Click on **Code + Test** on the left pane. \n5. Copy the [Function App Code](https://aka.ms/sentinelcarbonblackazurefunctioncode) and paste into the Function App `run.ps1` editor.\n5. Click **Save**."
            },
            {
              "description": "**3. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select **+ New application setting**.\n3. Add each of the following thirteen to sixteen (13-16) application settings individually, with their respective string values (case-sensitive): \n\t\tapiId\n\t\tapiKey\n\t\tworkspaceID\n\t\tworkspaceKey\n\t\turi\n\t\ttimeInterval\n\t\tCarbonBlackOrgKey\n\t\tCarbonBlackLogTypes \n\t\ts3BucketName \n\t\tEventPrefixFolderName \n\t\tAlertPrefixFolderName \n\t\tAWSAccessKeyId \n\t\tAWSSecretAccessKey \n\t\tSIEMapiId (Optional)\n\t\tSIEMapiKey (Optional)\n\t\tlogAnalyticsUri (optional) \n> - Enter the URI that corresponds to your region. The complete list of API URLs can be [found here](https://community.carbonblack.com/t5/Knowledge-Base/PSC-What-URLs-are-used-to-access-the-APIs/ta-p/67346). The `uri` value must follow the following schema: `https://<API URL>.conferdeploy.net` - There is no need to add a time suffix to the URI, the Function App will dynamically append the Time Value to the URI in the proper format.\n> - Set the `timeInterval` (in minutes) to the default value of `5` to correspond to the default Timer Trigger of every `5` minutes. If the time interval needs to be modified, it is recommended to change the Function App Timer Trigger accordingly to prevent overlapping data ingestion.\n> - Carbon Black requires a seperate set of API ID/Keys to ingest Notification alerts. Enter the `SIEMapiId` and `SIEMapiKey` values, if needed, or omit, if not required. \n> - Note: If using Azure Key Vault, use the`@Microsoft.KeyVault(SecretUri={Security Identifier})`schema in place of the string values. Refer to [Key Vault references documentation](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) for further details. \n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`\n4. Once all application settings have been entered, click **Save**."
            }
          ],
          "id": "[variables('_uiConfigId1')]"
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "VMware Carbon Black Cloud Analytics Rule 1 with template",
        "displayName": "VMware Carbon Black Cloud Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName1'),'/',variables('analyticRuleVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "CriticalThreatDetected_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId1')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This creates an incident in the event a critical threat was identified on a Carbon Black managed endpoint.",
                "displayName": "Critical Threat Detected",
                "enabled": false,
                "query": "let threshold = 8;\nCarbonBlackNotifications_CL\n| where threatHunterInfo_score_d >= threshold\n| extend eventTime = datetime(1970-01-01) + tolong(threatHunterInfo_time_d/1000) * 1sec\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), count() by eventTime, Threat_Name = threatHunterInfo_reportName_s, Device_Name = deviceInfo_deviceName_s,  Internal_IP = deviceInfo_internalIpAddress_s, External_IP = deviceInfo_externalIpAddress_s, Threat_Score = threatHunterInfo_score_d\n| project-away count_\n| extend timestamp = StartTime, HostCustomEntity = Device_Name, IPCustomEntity = Internal_IP\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "VMwareCarbonBlack",
                    "dataTypes": [
                      "CarbonBlackNotifications_CL"
                    ]
                  }
                ],
                "tactics": [
                  "LateralMovement"
                ],
                "techniques": [
                  "T1210"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "HostCustomEntity",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Host"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId1'),'/'))))]",
              "properties": {
                "description": "VMware Carbon Black Cloud Analytics Rule 1",
                "parentId": "[variables('analyticRuleId1')]",
                "contentId": "[variables('_analyticRulecontentId1')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "VMware Carbon Black Cloud",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft",
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "VMware Carbon Black Cloud Analytics Rule 2 with template",
        "displayName": "VMware Carbon Black Cloud Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName2'),'/',variables('analyticRuleVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "KnownMalwareDetected_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId2')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This creates an incident when a known Malware is detected on a endpoint managed by a Carbon Black.",
                "displayName": "Known Malware Detected",
                "enabled": false,
                "query": "CarbonBlackEvents_CL\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\n| where targetApp_effectiveReputation_s =~ \"KNOWN_MALWARE\"\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), count() by eventTime, deviceDetails_deviceName_s, deviceDetails_deviceIpAddress_s, processDetails_fullUserName_s, processDetails_targetName_s\n| extend timestamp = StartTime, AccountCustomEntity = processDetails_fullUserName_s, HostCustomEntity = deviceDetails_deviceName_s, IPCustomEntity = deviceDetails_deviceIpAddress_s\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "VMwareCarbonBlack",
                    "dataTypes": [
                      "CarbonBlackEvents_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Execution"
                ],
                "techniques": [
                  "T1204"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "HostCustomEntity",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Host"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId2'),'/'))))]",
              "properties": {
                "description": "VMware Carbon Black Cloud Analytics Rule 2",
                "parentId": "[variables('analyticRuleId2')]",
                "contentId": "[variables('_analyticRulecontentId2')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "VMware Carbon Black Cloud",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft",
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "properties": {
        "description": "VMware Carbon Black Cloud Workbook with template",
        "displayName": "VMware Carbon Black Cloud workbook template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('workbookTemplateSpecName1'),'/',variables('workbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('workbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "VMwareCarbonBlackWorkbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Sets the time name for analysis"
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"7276a9d6-ba34-4f06-9a14-785f03cedf52\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":2419200000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"resourceType\":\"microsoft.insights/components\"},{\"id\":\"e10ce65c-0f31-4def-a81b-2c565d36a1d6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"EventType\",\"label\":\"Event Type\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CarbonBlackEvents_CL\\n| distinct eventType_s\\n| sort by eventType_s asc\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"b7f7d6bb-20af-4f36-9d0e-389147598e04\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ThreatIndicator\",\"label\":\"Threat Indicator\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| distinct tostring(threatIndicators_s)\\r\\n| sort by threatIndicators_s asc\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"34e19468-ad9e-4170-bd1e-d9970cc6df5b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"PriorityType\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CarbonBlackEvents_CL\\r\\n|mvexpandtodynamic(deviceDetails_targetPriorityType_s)\\r\\n|distincttostring(deviceDetails_targetPriorityType_s)\\r\\n|sort bydeviceDetails_targetPriorityType_s asc\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"label\":\"Priority Type\"},{\"id\":\"b06c1de8-163e-4f8a-8cc5-5aa0fe3fccfc\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Location\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CarbonBlackEvents_CL\\r\\n| summarize count() by deviceDetails_deviceLocation_countryName_s\\r\\n| project deviceDetails_deviceLocation_countryName_s\\r\\n| order by deviceDetails_deviceLocation_countryName_s asc\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"046ce247-834a-49d5-9896-9d2bd5a559ce\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SensorOS\",\"label\":\"Sensor OS\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CarbonBlackEvents_CL\\n| distinct deviceDetails_deviceVersion_s\\n| sort by deviceDetails_deviceVersion_s asc\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize count() by bin(eventTime,{TimeRange:grain}), tostring(threatIndicators_s)\",\"size\":0,\"title\":\"Total Events by Threat Indicators\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"threatIndicators_s\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n|summarize count() bybin(eventTime, {TimeRange:grain}), deviceDetails_targetPriorityType_s\",\"size\":0,\"title\":\"Total Events by Priority Type\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"MEDIUM\",\"color\":\"orange\"},{\"seriesName\":\"HIGH\",\"color\":\"redBright\"}]}},\"customWidth\":\"50\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\n| mvexpand todynamic(threatIndicators_s)\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\n| summarize count() by City = netFlow_peerLocation_city_s, netFlow_peerLocation_countryName_s, latitude = netFlow_peerLocation_latitude_d, longitude = netFlow_peerLocation_longitude_d\\n| where isnotempty(City)\",\"size\":0,\"title\":\"Net Data Flow by City\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude\",\"longitude\":\"longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"City\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"},\"numberFormatSettings\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}}},\"customWidth\":\"50\",\"name\":\"query - 17 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\n| mvexpand todynamic(threatIndicators_s)\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\n| summarize count() by City = deviceDetails_deviceLocation_city_s, IPAddress = deviceDetails_deviceIpV4Address_s, Country = deviceDetails_deviceLocation_countryName_s, latitude = deviceDetails_deviceLocation_latitude_d, longitude = deviceDetails_deviceLocation_longitude_d\",\"size\":0,\"title\":\"Endpoint Generated Events by City\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude\",\"longitude\":\"longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"City\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"},\"numberFormatSettings\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}}},\"customWidth\":\"50\",\"name\":\"query - 17\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize HIGH = countif(deviceDetails_targetPriorityType_s == \\\"HIGH\\\"), MEDIUM = countif(deviceDetails_targetPriorityType_s == \\\"MEDIUM\\\"), LOW = countif(deviceDetails_targetPriorityType_s == \\\"LOW\\\"),  Total = count() by ParentProcess = processDetails_name_s\\r\\n| top 10 by Total\",\"size\":0,\"title\":\"Top 10 Parent Processes\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"HIGH\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}},{\"columnMatch\":\"MEDIUM\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}}},{\"columnMatch\":\"LOW\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"yellowOrangeRed\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"Count\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}],\"labelSettings\":[{\"columnId\":\"ParentProcess\",\"label\":\"Parent Process\"},{\"columnId\":\"HIGH\"},{\"columnId\":\"MEDIUM\"},{\"columnId\":\"LOW\"},{\"columnId\":\"Total\"}]},\"sortBy\":\"[]\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ApplicationName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 9 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize count() by eventType_s\",\"size\":0,\"title\":\"Event Types\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize count() by targetApp_effectiveReputation_s\",\"size\":0,\"title\":\"Trageted Application Reputation Types\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 7 - Copy\",\"styleSettings\":{\"progressStyle\":\"squares\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize Sensors = dcount(deviceDetails_deviceName_s)\",\"size\":0,\"title\":\"Total Sensors\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}}}]},\"sortBy\":\"[]\",\"tileSettings\":{\"titleContent\":{\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Sensors\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":false,\"size\":\"auto\"}},\"customWidth\":\"20\",\"name\":\"query - 9 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize Total = count() by Sensor = deviceDetails_deviceName_s\\r\\n| top 10 by Total\",\"size\":0,\"title\":\"Top 10 Event Generating Sensors\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"hotCold\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}}},{\"columnMatch\":\"Count\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}}}]},\"sortBy\":\"[]\"},\"customWidth\":\"40\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize Total = dcount(deviceDetails_deviceName_s) by ['OS Version'] = deviceDetails_deviceVersion_s\",\"size\":0,\"title\":\"Top 10 Sensor Operating Systems\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blue\"}}]},\"sortBy\":\"[]\"},\"customWidth\":\"40\",\"name\":\"query - 9 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| where targetApp_effectiveReputation_s == \\\"KNOWN_MALWARE\\\"\\r\\n| summarize count() by eventTime, processDetails_fullUserName_s, deviceDetails_deviceName_s, processDetails_targetName_s, targetApp_applicationName_s\\r\\n| project-away count_\\r\\n| sort by eventTime desc, deviceDetails_deviceName_s asc\",\"size\":0,\"title\":\"Recent Known Malware Detected\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"HIGH\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}},{\"columnMatch\":\"MEDIUM\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}}},{\"columnMatch\":\"LOW\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"yellowOrangeRed\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"Count\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}],\"labelSettings\":[{\"columnId\":\"eventTime\",\"label\":\"Event Time\"},{\"columnId\":\"processDetails_fullUserName_s\",\"label\":\"User\"},{\"columnId\":\"deviceDetails_deviceName_s\",\"label\":\"Endpoint\"},{\"columnId\":\"processDetails_targetName_s\",\"label\":\"Process Name\"},{\"columnId\":\"targetApp_applicationName_s\",\"label\":\"Application Name\"}]},\"sortBy\":\"[]\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ApplicationName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 9 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| where targetApp_effectiveReputation_s == \\\"KNOWN_MALWARE\\\"\\r\\n| summarize count() by deviceDetails_deviceName_s, bin(TimeGenerated,{TimeRange:grain})\",\"size\":0,\"title\":\"Known Malware Activity by Endpoint\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"HIGH\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}},{\"columnMatch\":\"MEDIUM\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}}},{\"columnMatch\":\"LOW\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"yellowOrangeRed\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"Count\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}],\"labelSettings\":[{\"columnId\":\"eventTime\",\"label\":\"Event Time\"},{\"columnId\":\"processDetails_fullUserName_s\",\"label\":\"User\"},{\"columnId\":\"deviceDetails_deviceName_s\",\"label\":\"Endpoint\"},{\"columnId\":\"processDetails_targetName_s\",\"label\":\"Process Name\"},{\"columnId\":\"targetApp_applicationName_s\",\"label\":\"Application Name\"}]},\"sortBy\":\"[]\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ApplicationName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 9 - Copy - Copy - Copy\"}],\"fromTemplateId\":\"sentinel-VMwareCarbonBlack\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=VMwareCarbonBlack; logoFileName=Azure_Sentinel.svg; description=Sets the time name for analysis; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=VMware Carbon Black Cloud; templateRelativePath=VMwareCarbonBlack.json; subtitle=; provider=Microsoft}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "VMware Carbon Black Cloud",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft",
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "CarbonBlackEvents_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "CarbonBlackAuditLogs_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "CarbonBlackNotifications_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "VMwareCarbonBlack",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "LogicAppsCustomConnector"
      },
      "properties": {
        "description": "CarbonBlackConnector",
        "displayName": "CarbonBlackConnector"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName1'),'/',variables('playbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "LogicAppsCustomConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "CarbonBlackConnector Playbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "CustomConnectorName": {
              "defaultValue": "CarbonBlackCloudConnector",
              "type": "string",
              "metadata": {
                "description": "Name of the carbon black connector"
              }
            },
            "Service EndPoint": {
              "defaultValue": "https://{CarbonblackBaseURL}",
              "type": "string",
              "metadata": {
                "description": "enter the carbonblack baseURL (ex: https://defense.conferdeploy.net)"
              }
            }
          },
          "variables": {
            "operationId-SearchdevicesInOrganization": "SearchdevicesInOrganization",
            "_operationId-SearchdevicesInOrganization": "[[variables('operationId-SearchdevicesInOrganization')]",
            "operationId-DeviceActions": "DeviceActions",
            "_operationId-DeviceActions": "[[variables('operationId-DeviceActions')]",
            "operationId-ProcessSearchSuggestionsByQuery": "ProcessSearchSuggestionsByQuery",
            "_operationId-ProcessSearchSuggestionsByQuery": "[[variables('operationId-ProcessSearchSuggestionsByQuery')]",
            "operationId-ProcessMetadataSearchByProcessGUID": "ProcessMetadataSearchByProcessGUID",
            "_operationId-ProcessMetadataSearchByProcessGUID": "[[variables('operationId-ProcessMetadataSearchByProcessGUID')]",
            "operationId-SearchForProcessEventsByProcessGUID": "SearchForProcessEventsByProcessGUID",
            "_operationId-SearchForProcessEventsByProcessGUID": "[[variables('operationId-SearchForProcessEventsByProcessGUID')]",
            "operationId-DismissAnAlert": "DismissAnAlert",
            "_operationId-DismissAnAlert": "[[variables('operationId-DismissAnAlert')]",
            "operationId-AddNoteToAnAlert": "AddNoteToAnAlert",
            "_operationId-AddNoteToAnAlert": "[[variables('operationId-AddNoteToAnAlert')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId1": "CarbonBlackConnector",
            "playbookId1": "[[resourceId('Microsoft.Web/customApis', parameters('CustomConnectorName'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('CustomConnectorName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "connectionParameters": {
                  "api_key": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "API Key",
                      "description": "The API Key for this api",
                      "tooltip": "Provide your API Key",
                      "constraints": {
                        "tabIndex": 2,
                        "clearText": false,
                        "required": "true"
                      }
                    }
                  }
                },
                "backendService": {
                  "serviceUrl": "[[parameters('Service EndPoint')]"
                },
                "description": "The Carbon Black Cloud is a cloud-native endpoint protection platform (EPP) that provides what you need to secure your endpoints using a single, lightweight agent and an easy-to-use console.",
                "displayName": "[[parameters('CustomConnectorName')]",
                "iconUri": "data:image/jpeg;base64,/9j/2wCEAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDIBCQkJDAsMGA0NGDIhHCEyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMv/AABEIAMgAyAMBIgACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/AMeiiivuT5MKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKfFFJPKsUUbSSMcKqDJJ9hW14Y8Nv4kvjALuG3VOW3NlyP9le9ew6H4X0vw/FizgBmIw08nLt+PYewrgxeYU8P7u8ux2YfBzra7I8E8mTz/I2N5u7ZsxzuzjH50SxSQStFLG0cinDK4wQfcVp/wDM2/8Ab/8A+1K9o1zwvpfiCLF5ABMBhZ4+HX8e/wBDRiMcsPKPOtGFHCOspcr1R4DRW74n8Nv4bvhAbuG4V+V2thwP9pe1YVdlOpGpFSi9Gc04ShLlluFFFFWQFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRVixsLvUrlbazt5J5m6Kgz+J9B711938P30nw+1/qNxm5MkaiGL7qhnAOT3OD2/WsamIp02oyerNYUZzTcVojntE8N6nr82yytyYwcNM/CL9T/AEHNep+HvAGmaNsnuQL27HO+RflU/wCyv9T+lLFFrXhSNYoozqukxjCqihbiFfoOHH61vaXrNhrMHm2NwsmOHToyH0YHkV4WMxlaovcfueX69j1sNhqUH73xef6HMeHtB0/WvDKi6h/epczeXPGdskZ8w8qw/wD1Vc+0674c4vEfV9OH/LeJf9IjH+0v8Q9xzT/BkscHhhpZpFjjS4nLO5wAPMPU0kniO91iRrfw3bCVAcNfzgrCv+73c/SsZucqsotXim99l8+hrFRjTi07O3Tr8up5B9qi/wCEh+15Pk/a/Mzj+Hfnp9K9d+0674k4s0fSNOP/AC3lX/SJB/sr/CPc815F5c3/AAkPl+cPP+17fN2/xb/vY+vOK9fj8R3ujyLb+JLYRKThL+AFoW/3u6H616OYp+44JN2/qy6/1ocWCfxczsv669Cj4i0HT9F8NN9lizK9zD5k8h3SSHzByzH/APVVjxD4A0zWd89sBZXZ53xr8rH/AGl/qP1qx4yljn8MLLDIskb3EBV0OQR5g6GtfVNZsNGg82+uFjzwidWc+igcmvMjWrKMZQb5rv8AQ7nTpNyUkrWX6nhut+G9T0CbZe25EZOFmTlG+h/oeaya9qli1rxXG0UsZ0rSZBhldQ1xMv0PCD9a4y0+H76toC3+nXGLkSSKYZfusFcgYPY4Hf8ASvZoY+PL++aT20/ryPMq4R837pNo4iirF9YXem3LW15byQTL1Vxj8R6j3qvXoppq6OJpp2YUUUUxBRRRQAUUUUAFFFFABRRRQAVpaJpcuq3xjS2muEhTzZY4GAkKAgHbnqeRxWbXc/Cv/kZ7n/ryb/0NKwxNR06MprobUIKdRRfU77wrNoBsjDoqJCU/1sLDbKp/2wec+9M8c/8AIsv/ANd4f/Ri1b1bw3Y6rItx89tep9y7tztkX8e49jXGeLdX1PS9N/snV2guy7o8NzCwV2CsD86djx1HFfOUIKrXjKD1vqnv9/X8z2qsnTpOMlpbdbf8A9LrhfEb6Zd6kU0WKeXxAvSWwbbs/wCurfdx7Hn6VatV1PxjAtzPdrY6S/3be0kDSyD0dx0+g+hrptP02z0q1FtY26QRDsg6+5Pc+5rKNsPK7d5dlt8+/ovvNJXrKyVl3/y/zPLNCQR28c3iWG7m0oSv5bId0CSbjuMirz16E8V6tZy2s1pG9k8TW5X5DERtx7YrB8EqH8NlWAKm4nBB7/O1Fz4YksZ3vfDt0LCcnc9uwzby/Vf4fqK2xU41ajjJ2afy/wCAZ0ISpwUkr3+//gnkf/M2/wDb/wD+1K96vJbWG0ke9eJbcL85lI249818++ZN/b3mYj8/7Vuxn5N2719M17JbeGJL6dL3xFdC/nB3JbqMW8X0X+L6mu3M4x9xydrL5nLgJS99RV7s4fXUElvJN4bhuodKaVPMZztgeTcNpjVuevUjiuj8OPplpqQTWop4vEDdZb9t2/8A65N93HsOe3NavjZVTw2FUAKLiAADt861t6hptnqtqba+t0niPZx09wex9xXJPEqVFJrR3169N+50RoNVG09Vb06/cWq5zwN/yLKf9d5v/RjVSul1PwdA1zBdrfaSn3re7kCyxj0Rz1+h/CsTwlq+p6ppv9kaQ0FoUd3luZmDOAzE/JH3PPU8VEcO3Rk4tWutfv3/AK9C5VkqqTWtnp9x1fiqbQBZCHWkSYv/AKqFRulY/wCwBzn3rxrW9Ll0q+Eb201ukyebFHOwLhCSBux0PB4r23SfDdjpUjXHz3N6/wDrLu4O6Rvx7D2Fec/FT/kZ7b/ryX/0N668sqqNX2UG2v62RzY6m3D2ktH/AFuzhqKKK988cKKKKACiiigAooooAKKKKACuw+HN/aaZrt3c3twkEK2bZdzjnenA9T7Vx9dJ4K0dtZ1uSOK4EE8EBnicxh13BlAyp6jk1z4tRdGSk7I2w7kqsXHc9J/tHWvEfy6TEdO089b24T944/6Zp/U1Q8ReHbDSPDU0kSNNdSTw+ZdTnfI/7xepP8hWnD4luNMmW18SWotGJ2peRZa3k/Hqp9jS+NXSXwqzxsro00JDKcgjzFr56m5wqwilaLa26/Pr/Wh7U1GVOTbu7Pfp8ug688LCK5e+0K5Om3jcsqDMMv8AvJ0/EUlt4oezuEsvENt/Z9wxwk4OYJfo3b6GtjUtVsdItjcX1ykMfbceWPoB1J+lc7cHV/F0DW8dsNO0mThpLmMNNKP9lDwo9zz3FZ071I/vfh79f+D6a/IudoP93v2/rb1M7RfFeleH/DH+kzb5zPMUgi5dvnP5D3Ncb4h8capr26EP9lszx5MR+8P9pu/8vaueuYxDdTRKSVR2UZ64BqKvoKWCpQm6lrt66njVMVUlFQ2SLGnxpNqVrFIu5HmRWHqCRXsp0rWPDvz6LMb2xHWwuX+ZR/0zft9DXjul/wDIXsv+u6f+hCvctU8TWenTi0hWS91Bvu2luNz/APAuyj61yZm588IxV730/rb1OnAKHLKUnbzOe8ReI7HVfD7wgvb3kdxD5trcDZInzjseo9xWvc+KHvLh7Lw9bf2hcKcPOTiCI+7d/oK5nxZo2pajpy6prTwwuskccVrbqD5aswB3P1Jwe3FbludX8IwLbyWw1HSY+Fktows0Q/2kHDD3HPc1wyp0vZx5dXd6X06dev8AW51KdTnfNotNba9enT+ti3Z+FhLcrfa7cnUrwcqrjEMX+6nT8TWT4c8O2Gr+GYZJUaG6jnm8u6gOyRP3jdCP5Gut03VbHV7YXFjcpNH32nlT6EdQfrWN4KdIvCqvIyoizTFmY4AHmNWPtaqhJt2aa8rb9DX2dNzVtU0/0Iv7S1rw58urRHUdPHS9t0/eIP8Apon9RXBfEa/tNT120ubK4SeFrNcOhzzvfg+h9q6rxD8S7Sz32+kKt1OOPOb/AFa/Tu38vevK7q5lvLqS5mKmSRizbVCjP0HFepl+Gnz+2nHlf5/Lp/WhwYyvHl9nF3/T5kNFFFeweYFFFFABRRRQAUUUUAFFFFABXc/Cv/kZ7n/ryb/0NK4auk8E6w2j63JJHb/aJ54DBDGXCAuWUjLHoODXNjIudCUVvY3w0lGrFs9tuxbG0l+2eV9n2/vPNxtx754xXlGvbRazDwybs6T5qedv/wCPfzN42+Xu5+91xxXbReGrrVJVuvEl0Lkg7ksocrBH9R1c/WneNY0i8KtHGioizQhVUYAHmL0FfP4WcaVRRTvdr0/4LPYrxlUg5NWsvn/wDK8Of2a2pj+3PPPiH0v8f+Qv4cemOa7qqWpaTY6vbG3vrZJk7Z6qfUHqD9K56f8AtfwlC063H9paTGMslw4WeFfZjww9jzWUrYh3Ts+z2+Xb0/E1jeirNXXf/P8AzPHr/wD5CFz/ANdW/mar1LcyCa6mlUEK7swz1wTUVfWx2R849yW2x9qhz5mN658r73X+H39K9z8LDQPsJOieWf8AnqT/AK3d/t55z9fwrxLS/wDkL2X/AF3T/wBCFe46p4Zs9QnF5A8ljqC/durc7W/4EOjD614+ayjeMJNq/wB3zR6WXp+9JK/9dCt44/5F3/t5h/8ARgrpK828WazqWn6auma3HFLI0sckV1bsB5iqwJ3IeQcD6Zrbg/tfxdCs7XH9m6RIMqlu4aeZfdhwo9hzXmyw7VGLk0ld6/dt/Xqd0aydRpLWy0+8p+I/7NXUz/YZnHiH0sMf+Rf4ceuea88vTr39iRC487+zPMfbs/1e/ec7sd85xn8K9w03SbHSLYW9jbJCnfHVj6k9SfrWP4KjSXwqsciK6NNMGVhkEeY3UVvQxipQuldJrffr93kY1cM6krN2untt0+88Nor1jxD8NLW73XGjutrMeTA3+rb6d1/l9K8turaWzupLacKJY2KsFYMAfqOK9vD4uniFeD17Hl1sPOi7SIaKKK6TAKKKKACiiigAooooAKKKKACuv+HWn2mp67d217bpPC1m2Vcd96cj0PvXIV3Pwr/5Ge5/68m/9DSuXGtrDza7HRhUnWimdp/Z+t+HPm0uVtT08dbO4b97GP8AYfv9DVHxF4hsNY8MTJC7RXMc8PmW0w2SIfMXqp/mK6HVvEdjpLrAxe4vH/1drAN8jfh2Hua4rxbpOparp39r6tHb2ex0SK2iUNIAzAfO/fr0HFeFh1zzjKqra6Pv8uvr97PWrPljKNN3027fPp6HVXnilZLlrHRLZtSvRwxQ4ii/336fgKZb+GJL2dLzxFci/nU5S3UYt4j7L/F9TVO0fUvBtuttc2a3mlJ0ubSMLJGPV0HX6j8a6ew1Gz1S1W5sriOeI/xIensfQ+xrGpekr0tu/wDW3pv6msLVH+837f1v6nE6L4S0rxB4Z/0mHy5xPMFni4YfOcD3Hsa43xD4I1XQS0uz7TZj/lvEOg/2h2/l716b4JYL4bLMQALiYknt87UXXidr2d7Lw/a/2hcA4ecnFvF/vN3+grrp4uvTrSUdY367L59Dmnh6M6UXLR26f5dTxbT5Ei1K1kkbaiTIzH0AIr2X+19X8QnZocP2OyPXULlOWHrGh6/U8V4/5c39veX+68/7Vt6fJu3enpmvZLXxO1lOll4gtf7PuCcJODm3l/3W7fQ11Zkr8soxu/66df60OfAu3Mm7L+uvQyfEXhux0vQHn+e5vZLiESXVwd8jfOM89h7Cta48MSWU73nh25FhOxy9uwzbyn3X+H6il8bMG8NhlIINxAQR3/eLW1f6jZ6Xatc3txHBEP4nPX2HqfYV5ftqrhGzu2359uh6Hsqam+lkv1Mez8UrHcrY65bNpt6eFLnMUv8AuP0/A1k+HfENho/hiFJnaW5knm8u2hG+Rz5jdFH8zU92+peMrdra2s1s9Kfrc3cYaSQeqIen1P4VieEtJ1LStO/tfSY7e83u6S20qhZCFYj5H7dOh4reNKl7N82jutL+vXoZOpU51y6qz1t6dOp0X9n634j+bVJW03Tz0s7dv3sg/wBt+30FcD8RdPtNM120tbK3SCFbNcKg7735PqfevUdJ8R2OrO0Cl7e8T/WWs42SL+Hce4rzj4qf8jPbf9eS/wDob1pgJz+sqElZWen9b+pni4w9hzJ3fc4aiiivoTxgooooAKKKKACiiigAooooAK0tD1SXSr8yR3MtskyeVLLCoZ1QkE7c9+BzWbRUyipLlZUZOLuj3fwtb6CtkbjRnSdn/wBbOzbpWP8Atk8g+3FM8c/8iy//AF3h/wDRi14pY6hd6Zcrc2VxJBKv8SHr7H1Hsa6+8+IDav4faw1C323IkjYSxfdYK4JyOxwP/wBVeJPLqkK8akXzK69T1IY2nKk4NWdvkev1wviJNNsdR36LNNDrz9ILFd3mf9dE+7j3OD35q9FNrXiqNZIHOk6S/KupBuJl9uyD9a3NK0Ww0aAxWVuqFuXkPLufVmPJrzoWoO8nd9l+v+X5HdK9ZaLTv/l/meZaFIJbeO38ST3VvpTSv5aoNsEkm47hI689ex44616tZw2sFpHHZJEluB8giAC49sVz/g2GK48LvDNGskb3EwZHGQR5h6ikfw7faM7T+G7kJGTltPuCWhb/AHT1Q/pWuJnGrUcb8tn8v+A/60MqEXTgpWvdfM8m/wCZt/7f/wD2pXvV5Daz2kkd6kT25HziUArj3zXz/wCZN/wkPmeT+/8Ate7ytw+9v+7n68Zr19PDt9rMgn8SXIeMHK6fbkrCvpuPVz+lduZxXuOTtZfP5HNgZP30le7OK12QRW8lv4bnurjSllTzFcboI5Nw2iN2569hx710fh1NNvtR361NNNrydYL5dvl/9c0+7j3GT34rT8ZQxW/hdIYY1jjS4hCogwAPMHQVr6rothrMAivbdXK8pIOHQ+qsORXLPExlSSd1dvXr037/AIG8aDVR21tbTp12NCuc8Df8iyn/AF3m/wDRjVWlm1vwrG0k7nVtJQZZ2IFxCvv2cfrXGWfxAbSPD62Gn2+65MkjGWX7qhnJGB3OD/8ArqKWEqVKbjT1u1r95dTEQhNOelk/0O/8U2+gtZC41l0gZP8AVTq22VT/ALBHJPtzXjWuapLqt+JJLmW5SFPKilmUK7ICSN2O/J5qtfahd6nctc3txJPK38Tnp7D0HsKrV7eDwfsF7zu/y9DysTifbPRWX5+oUUUV3HIFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAa+ieJdU0CbdZTnyictC/KN+Hb6jmvVPD3j7TNa2QTkWd4ePLkb5WP+y39Dg14pRXFicDSr6tWfc6qGLqUdFqux7F4d13T9F8Mq13NiR7mYRwoN0kh8w8Ko5NW/I17xJzcu+j6af8AljGf9IkH+038H0HNeX+GPEjeHL4z/Y4bhW4YsPnUf7Ldq9i0PxNpfiCLdZzjzQMtA/Dr+Hf6jivJxlCdCTnGN79e3y6erPRw1WNaKhJ2t0PEPs0f/CQ/ZMHyvtfl4zzt346/SvXfI17w3zau+saaP+WMh/0iMf7Lfx/Q815R/wAzb/2//wDtSvadc8TaX4fi3Xk480jKwJy7fh2+p4rpzGU26cYrmutjDBKKU5N2s9zC8Ra7p+teGWa0mzIlzCJIXG2SM+YOGU8irPiHx9pmi74ICLy8HHlxt8qn/ab+gya8x8T+JG8R3wn+xw26rwpUZdh/tN3rCq6WWQcY+06XdvW3X5EVMdJSfJ9//ANfW/Euqa/NuvZz5QOVhThF/Dv9TzWRRRXqwhGC5YqyOCUnJ3k7sKKKKokKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAp8U0kEqywyPHIhyrocEH2NMooGSefL9o8/efN379/fdnOfzpJZpJ5WlmkeSRzlnc5JPuaZRSsguwooopiCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//Z",
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "title": "Default title",
                    "description": "The Carbon Black Cloud is a cloud-native endpoint protection platform (EPP) that provides what you need to secure your endpoints using a single, lightweight agent and an easy-to-use console.",
                    "version": "1.0"
                  },
                  "host": "defense.conferdeploy.net",
                  "basePath": "/",
                  "schemes": [
                    "https"
                  ],
                  "consumes": "[variables('TemplateEmptyArray')]",
                  "produces": "[variables('TemplateEmptyArray')]",
                  "paths": {
                    "/appservices/v6/orgs/{org_key}/devices/_search": {
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "results": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "activation_code": {
                                        "type": "string",
                                        "description": "Device activation code to register the sensor with a specific org",
                                        "title": "[variables('blanks')]"
                                      },
                                      "activation_code_expiry_time": {
                                        "type": "string",
                                        "description": "When the activation code expires and cannot be used to register a device",
                                        "title": "[variables('blanks')]"
                                      },
                                      "ad_group_id": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "Active Directory group ID to match",
                                        "title": "[variables('blanks')]"
                                      },
                                      "appliance_name": {
                                        "type": "string",
                                        "description": "Name of the Appliance the Virtual Machine (VM) is associated with",
                                        "title": "[variables('blanks')]"
                                      },
                                      "appliance_uuid": {
                                        "type": "string",
                                        "description": "The Uuid of the appliance the VM is associated with",
                                        "title": "[variables('blanks')]"
                                      },
                                      "av_ave_version": {
                                        "type": "string",
                                        "description": "AVE version (part of AV Version)",
                                        "title": "[variables('blanks')]"
                                      },
                                      "av_engine": {
                                        "type": "string",
                                        "description": "Current anti virus (AV) version",
                                        "title": "[variables('blanks')]"
                                      },
                                      "av_last_scan_time": {
                                        "type": "string",
                                        "description": "The last time a local scan completed",
                                        "title": "[variables('blanks')]"
                                      },
                                      "av_master": {
                                        "type": "boolean",
                                        "description": "Whether the device is an AV Master",
                                        "title": "[variables('blanks')]",
                                        "enum": [
                                          "",
                                          "true",
                                          "false"
                                        ]
                                      },
                                      "av_pack_version": {
                                        "type": "string",
                                        "description": "Pack version (part of AV Version)",
                                        "title": "[variables('blanks')]"
                                      },
                                      "av_product_version": {
                                        "type": "string",
                                        "description": "Product version (part of AV Version)",
                                        "title": "[variables('blanks')]"
                                      },
                                      "av_status": {
                                        "type": "array",
                                        "items": {
                                          "type": "string"
                                        },
                                        "description": "av_status"
                                      },
                                      "av_update_servers": {
                                        "type": "string",
                                        "description": "A list of devices AV servers",
                                        "title": "[variables('blanks')]"
                                      },
                                      "av_vdf_version": {
                                        "type": "string",
                                        "description": "VDF version (part of AV Version)",
                                        "title": "[variables('blanks')]"
                                      },
                                      "cluster_name": {
                                        "type": "string",
                                        "description": "Name of the cluster. A cluster is a group of hosts",
                                        "title": "[variables('blanks')]"
                                      },
                                      "current_sensor_policy_name": {
                                        "type": "string",
                                        "description": "The name of the policy currently configured on the sensor",
                                        "title": "[variables('blanks')]"
                                      },
                                      "datacenter_name": {
                                        "type": "string",
                                        "description": "Name of the underlying datacenter. The datacenter managed object provides the interface to the common container object for hosts, virtual machines, networks, and datastores",
                                        "title": "[variables('blanks')]"
                                      },
                                      "deployment_type": {
                                        "type": "string",
                                        "description": "The devices deployment type, a classification that is determined by its lifecycle management policy",
                                        "title": "[variables('blanks')]"
                                      },
                                      "deregistered_time": {
                                        "type": "string",
                                        "description": "Time when the deregister request was received",
                                        "title": "[variables('blanks')]"
                                      },
                                      "device_meta_data_item_list": {
                                        "type": "array",
                                        "items": {
                                          "type": "object",
                                          "properties": {
                                            "key_name": {
                                              "type": "string",
                                              "description": "key_name"
                                            },
                                            "key_value": {
                                              "type": "string",
                                              "description": "key_value"
                                            },
                                            "position": {
                                              "type": "integer",
                                              "format": "int32",
                                              "description": "position"
                                            }
                                          }
                                        },
                                        "description": "device_meta_data_item_list"
                                      },
                                      "device_owner_id": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "The identifier for the device owner associated with the device",
                                        "title": "[variables('blanks')]"
                                      },
                                      "email": {
                                        "type": "string",
                                        "description": "The email address for the device owner",
                                        "title": "[variables('blanks')]"
                                      },
                                      "esx_host_name": {
                                        "type": "string",
                                        "description": "Name of the ESX host on which the VM is deployed",
                                        "title": "[variables('blanks')]"
                                      },
                                      "esx_host_uuid": {
                                        "type": "string",
                                        "description": "Uuid of the ESX host on which VM is deployed",
                                        "title": "[variables('blanks')]"
                                      },
                                      "first_name": {
                                        "type": "string",
                                        "description": "The first name of the device owner",
                                        "title": "[variables('blanks')]"
                                      },
                                      "id": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "id"
                                      },
                                      "last_contact_time": {
                                        "type": "string",
                                        "description": "Last contact time",
                                        "title": "[variables('blanks')]"
                                      },
                                      "last_device_policy_changed_time": {
                                        "type": "string",
                                        "description": "The last time the sensor changed from one policy to another",
                                        "title": "[variables('blanks')]"
                                      },
                                      "last_device_policy_requested_time": {
                                        "type": "string",
                                        "description": "The last time the sensor checked for changes to the policy",
                                        "title": "[variables('blanks')]"
                                      },
                                      "last_external_ip_address": {
                                        "type": "string",
                                        "description": "The last IP address of the device according to the Carbon Black Cloud; can differ from last_internal_ip_address due to network proxy or NAT",
                                        "title": "[variables('blanks')]"
                                      },
                                      "last_internal_ip_address": {
                                        "type": "string",
                                        "description": "The last IP address of the device reported by the sensor",
                                        "title": "[variables('blanks')]"
                                      },
                                      "last_location": {
                                        "type": "string",
                                        "description": "The devices current location relative to the organizations network, based on the current IP address and the devices registered DNS domain suffix",
                                        "title": "[variables('blanks')]"
                                      },
                                      "last_name": {
                                        "type": "string",
                                        "description": "The last name of the device owner",
                                        "title": "[variables('blanks')]"
                                      },
                                      "last_policy_updated_time": {
                                        "type": "string",
                                        "description": "The last time the current policy received an update",
                                        "title": "[variables('blanks')]"
                                      },
                                      "last_reported_time": {
                                        "type": "string",
                                        "description": "The last time when the Carbon Black Cloud received one or more events reported by the sensor",
                                        "title": "[variables('blanks')]"
                                      },
                                      "last_reset_time": {
                                        "type": "string",
                                        "description": "The last time the device was reset",
                                        "title": "[variables('blanks')]"
                                      },
                                      "last_shutdown_time": {
                                        "type": "string",
                                        "description": "The last time the device was shutdown",
                                        "title": "[variables('blanks')]"
                                      },
                                      "linux_kernel_version": {
                                        "type": "string",
                                        "description": "Not implemented",
                                        "title": "[variables('blanks')]"
                                      },
                                      "login_user_name": {
                                        "type": "string",
                                        "description": "The last user logged in on the device",
                                        "title": "[variables('blanks')]"
                                      },
                                      "mac_address": {
                                        "type": "string",
                                        "description": "The media access control (MAC) address for the devices primary interface",
                                        "title": "[variables('blanks')]"
                                      },
                                      "middle_name": {
                                        "type": "string",
                                        "description": "The middle name of the device owner",
                                        "title": "[variables('blanks')]"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "name"
                                      },
                                      "organization_id": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "Organization identifier",
                                        "title": "[variables('blanks')]"
                                      },
                                      "organization_name": {
                                        "type": "string",
                                        "description": "Organization name",
                                        "title": "[variables('blanks')]"
                                      },
                                      "os": {
                                        "type": "string",
                                        "description": "Operating System",
                                        "title": "[variables('blanks')]"
                                      },
                                      "os_version": {
                                        "type": "string",
                                        "description": "The operating system and version of the endpoint",
                                        "title": "[variables('blanks')]"
                                      },
                                      "passive_mode": {
                                        "type": "boolean",
                                        "description": "Whether the device is in bypass",
                                        "title": "[variables('blanks')]",
                                        "enum": [
                                          "",
                                          "true",
                                          "false"
                                        ]
                                      },
                                      "policy_id": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "The policy identifier assigned to the device",
                                        "title": "[variables('blanks')]"
                                      },
                                      "policy_name": {
                                        "type": "string",
                                        "description": "The policy name assigned to the device. May not match",
                                        "title": "[variables('blanks')]"
                                      },
                                      "policy_override": {
                                        "type": "boolean",
                                        "description": "Whether the policy was manually assigned to override mass sensor management",
                                        "title": "[variables('blanks')]",
                                        "enum": [
                                          "",
                                          "true",
                                          "false"
                                        ]
                                      },
                                      "quarantined": {
                                        "type": "boolean",
                                        "description": "An indicator that the device is in quarantine mode",
                                        "title": "[variables('blanks')]",
                                        "enum": [
                                          "",
                                          "true",
                                          "false"
                                        ]
                                      },
                                      "registered_time": {
                                        "type": "string",
                                        "description": "When the device was registered with the Carbon Black Cloud",
                                        "title": "[variables('blanks')]"
                                      },
                                      "scan_last_action_time": {
                                        "type": "string",
                                        "description": "The last time the background scan was started or stopped",
                                        "title": "[variables('blanks')]"
                                      },
                                      "scan_last_complete_time": {
                                        "type": "string",
                                        "description": "The time the last background scan completed",
                                        "title": "[variables('blanks')]"
                                      },
                                      "scan_status": {
                                        "type": "string",
                                        "description": "The status of the background scan",
                                        "title": "[variables('blanks')]"
                                      },
                                      "sensor_kit_type": {
                                        "type": "string",
                                        "description": "The type of sensor installed on the device",
                                        "title": "[variables('blanks')]"
                                      },
                                      "sensor_out_of_date": {
                                        "type": "boolean",
                                        "description": "Whether there is a new version available to be installed",
                                        "title": "[variables('blanks')]",
                                        "enum": [
                                          "",
                                          "true",
                                          "false"
                                        ]
                                      },
                                      "sensor_pending_update": {
                                        "type": "boolean",
                                        "description": "Whether the sensor is marked by the Sensor Update Service for a sensor upgrade",
                                        "title": "[variables('blanks')]",
                                        "enum": [
                                          "",
                                          "true",
                                          "false"
                                        ]
                                      },
                                      "sensor_states": {
                                        "type": "array",
                                        "items": {
                                          "type": "string"
                                        },
                                        "description": "sensor_states"
                                      },
                                      "sensor_version": {
                                        "type": "string",
                                        "description": "The version of the installed sensor",
                                        "title": "[variables('blanks')]"
                                      },
                                      "status": {
                                        "type": "string",
                                        "description": "The status of the device",
                                        "title": "[variables('blanks')]"
                                      },
                                      "target_priority": {
                                        "type": "string",
                                        "description": "The Target value configured in the policy assigned to the sensor",
                                        "title": "[variables('blanks')]"
                                      },
                                      "uninstall_code": {
                                        "type": "string",
                                        "description": "The code to enter when uninstalling the sensor",
                                        "title": "[variables('blanks')]"
                                      },
                                      "vcenter_host_url": {
                                        "type": "string",
                                        "description": "vcenter_host_url"
                                      },
                                      "vcenter_name": {
                                        "type": "string",
                                        "description": "Name of the vcenter the vm is associated with",
                                        "title": "[variables('blanks')]"
                                      },
                                      "vcenter_uuid": {
                                        "type": "string",
                                        "description": "128-bit SMBIOS UUID of a vcenter represented as a hexadecimal string",
                                        "title": "[variables('blanks')]"
                                      },
                                      "vdi_base_device": {
                                        "type": "string",
                                        "description": "The identifier of the device from which this device was cloned/re-registered",
                                        "title": "[variables('blanks')]"
                                      },
                                      "virtual_machine": {
                                        "type": "boolean",
                                        "description": "Whether this device is a Virtual Machine (VMware AppDefense integration)",
                                        "title": "[variables('blanks')]",
                                        "enum": [
                                          "",
                                          "true",
                                          "false"
                                        ]
                                      },
                                      "virtualization_provider": {
                                        "type": "string",
                                        "description": "Name of the VM Virtualization Provider",
                                        "title": "[variables('blanks')]"
                                      },
                                      "vm_ip": {
                                        "type": "string",
                                        "description": "VMs Ip",
                                        "title": "[variables('blanks')]"
                                      },
                                      "vm_name": {
                                        "type": "string",
                                        "description": "Name of the Virtual Machine that the sensor is deployed on",
                                        "title": "[variables('blanks')]"
                                      },
                                      "vm_uuid": {
                                        "type": "string",
                                        "description": "128-bit SMBIOS UUID of a virtual machine represented as a hexadecimal string",
                                        "title": "[variables('blanks')]"
                                      },
                                      "vulnerability_score": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "A score from 0 to 100 indicating the workloads level of vulnerability with 100 being highly vulnerable",
                                        "title": "[variables('blanks')]"
                                      },
                                      "vulnerability_severity": {
                                        "type": "string",
                                        "description": "The severity level indicating the workloads vulnerability",
                                        "title": "[variables('blanks')]"
                                      },
                                      "windows_platform": {
                                        "type": "string",
                                        "description": "Deprecated for os_version",
                                        "title": "[variables('blanks')]"
                                      }
                                    }
                                  },
                                  "description": "results"
                                },
                                "num_found": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "Number of records found",
                                  "title": "[variables('blanks')]"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Search devices",
                        "description": "Search devices in your organization",
                        "operationId": "[[variables('_operationId-SearchdevicesInOrganization')]",
                        "x-ms-visibility": "important",
                        "parameters": [
                          {
                            "name": "org_key",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Organization Key",
                            "x-ms-visibility": "important"
                          },
                          {
                            "name": "Content-Type",
                            "in": "header",
                            "required": true,
                            "type": "string",
                            "default": "application/json",
                            "x-ms-visibility": "important"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "criteria": {
                                  "type": "object",
                                  "properties": {
                                    "status": {
                                      "type": "array",
                                      "items": {
                                        "type": "string",
                                        "description": "Device statuses to match",
                                        "title": "[variables('blanks')]",
                                        "enum": [
                                          "PENDING",
                                          "REGISTERED",
                                          "UNINSTALLED",
                                          "DEREGISTERED",
                                          "ACTIVE",
                                          "INACTIVE",
                                          "ERROR",
                                          "ALL",
                                          "BYPASS_ON",
                                          "BYPASS",
                                          "QUARANTINE",
                                          "SENSOR_OUTOFDATE",
                                          "DELETED",
                                          "LIVE"
                                        ]
                                      },
                                      "description": "status"
                                    },
                                    "os": {
                                      "type": "array",
                                      "items": {
                                        "type": "string",
                                        "description": "Operating System",
                                        "title": "[variables('blanks')]"
                                      },
                                      "description": "os"
                                    },
                                    "last_contact_time": {
                                      "type": "object",
                                      "properties": {
                                        "end": {
                                          "type": "string",
                                          "description": "Last contact time end [ start and end are specified as ISO-8601 strings ]",
                                          "title": "[variables('blanks')]"
                                        },
                                        "range": {
                                          "type": "string",
                                          "description": "Last contact time range range can be either all (to indicate all time), or a specific duration specified as -[quantity][unit], where unit is one of",
                                          "title": "[variables('blanks')]",
                                          "enum": [
                                            "s",
                                            "m",
                                            "h",
                                            "d",
                                            "w",
                                            "y"
                                          ]
                                        },
                                        "start": {
                                          "type": "string",
                                          "description": "Last contact time start [ start and end are specified as ISO-8601 strings ]",
                                          "title": "[variables('blanks')]"
                                        }
                                      },
                                      "description": "last_contact_time"
                                    },
                                    "ad_group_id": {
                                      "type": "array",
                                      "items": {
                                        "type": "string",
                                        "description": "Active Directory group ID to match",
                                        "title": "[variables('blanks')]"
                                      },
                                      "description": "Active Directory group ID to match"
                                    },
                                    "policy_id": {
                                      "type": "array",
                                      "items": {
                                        "type": "string",
                                        "description": "Carbon Black Cloud Policy ID to match",
                                        "title": "[variables('blanks')]"
                                      },
                                      "description": "Carbon Black Cloud Policy ID to match"
                                    },
                                    "id": {
                                      "type": "array",
                                      "items": {
                                        "type": "string"
                                      },
                                      "description": "id"
                                    },
                                    "target_priority": {
                                      "type": "array",
                                      "items": {
                                        "type": "string",
                                        "description": "Device target priorities to match",
                                        "title": "[variables('blanks')]",
                                        "enum": [
                                          "LOW",
                                          "MEDIUM",
                                          "HIGH",
                                          "MISSION_CRITICAL"
                                        ]
                                      },
                                      "description": "target_priority"
                                    },
                                    "deployment_type": {
                                      "type": "array",
                                      "items": {
                                        "type": "string",
                                        "description": "The devices deployment type, a classification that is determined by its lifecycle management policy",
                                        "title": "[variables('blanks')]"
                                      },
                                      "description": "The devices deployment type, a classification that is determined by its lifecycle management policy"
                                    },
                                    "vm_uuid": {
                                      "type": "array",
                                      "items": {
                                        "type": "string",
                                        "description": "128-bit SMBIOS UUID of a virtual machine represented as a hexadecimal string",
                                        "title": "[variables('blanks')]"
                                      },
                                      "description": "128-bit SMBIOS UUID of a virtual machine represented as a hexadecimal string"
                                    },
                                    "vcenter_uuid": {
                                      "type": "array",
                                      "items": {
                                        "type": "string",
                                        "description": "128-bit SMBIOS UUID of a vcenter represented as a hexadecimal string",
                                        "title": "[variables('blanks')]"
                                      },
                                      "description": "128-bit SMBIOS UUID of a vcenter represented as a hexadecimal string"
                                    }
                                  },
                                  "description": "criteria"
                                },
                                "exclusions": {
                                  "type": "object",
                                  "properties": {
                                    "sensor_version": {
                                      "type": "array",
                                      "items": {
                                        "type": "string",
                                        "description": "The version of the installed sensor [ Format: #.#.#.# ]",
                                        "title": "[variables('blanks')]"
                                      },
                                      "description": "The version of the installed sensor [ Format: #.#.#.# ]"
                                    }
                                  },
                                  "description": "exclusions"
                                },
                                "query": {
                                  "type": "string",
                                  "description": "query format [ fieldname : value OR/AND fieldname : value ]",
                                  "title": "[variables('blanks')]"
                                },
                                "sort": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "field": {
                                        "type": "string",
                                        "description": "Field to sort results by",
                                        "title": "[variables('blanks')]"
                                      },
                                      "order": {
                                        "type": "string",
                                        "description": "Sort order",
                                        "title": "[variables('blanks')]"
                                      }
                                    }
                                  },
                                  "description": "sort"
                                },
                                "rows": {
                                  "type": "string",
                                  "description": "Maximum number of rows to return",
                                  "title": "[variables('blanks')]"
                                },
                                "start": {
                                  "type": "string",
                                  "description": "What row to begin returning results from",
                                  "title": "[variables('blanks')]"
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "/appservices/v6/orgs/{org_key}/device_actions": {
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "string"
                            }
                          }
                        },
                        "summary": "Take action on device",
                        "description": "device actions",
                        "operationId": "[[variables('_operationId-DeviceActions')]",
                        "parameters": [
                          {
                            "name": "org_key",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Organization Key"
                          },
                          {
                            "name": "Content-Type",
                            "in": "header",
                            "required": true,
                            "type": "string",
                            "x-ms-visibility": "important",
                            "default": "application/json"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "action_type": {
                                  "type": "string",
                                  "description": "Action to perform on selected devices",
                                  "title": "[variables('blanks')]",
                                  "enum": [
                                    "QUARANTINE",
                                    "UPDATE_POLICY"
                                  ],
                                  "default": "QUARANTINE"
                                },
                                "device_id": {
                                  "type": "array",
                                  "items": {
                                    "type": "string",
                                    "description": "List of devices to perform action on",
                                    "title": "[variables('blanks')]",
                                    "default": "List of devices to perform action on"
                                  },
                                  "description": "device_id"
                                },
                                "options": {
                                  "type": "object",
                                  "properties": {
                                    "toggle": {
                                      "type": "string",
                                      "description": "Determines whether to enable or disable the action [ Required if action_type is set to QUARANTINE, BYPASS, or BACKGROUND_SCAN ]",
                                      "title": "[variables('blanks')]",
                                      "x-ms-visibility": "advanced",
                                      "enum": [
                                        "ON",
                                        "OFF"
                                      ]
                                    },
                                    "policy_id": {
                                      "type": "string",
                                      "description": "Devices will be updated to this policy ID [ Required if action_type is set to UPDATE_POLICY ]",
                                      "title": "[variables('blanks')]"
                                    }
                                  },
                                  "description": "options"
                                }
                              },
                              "required": [
                                "action_type",
                                "device_id"
                              ]
                            }
                          }
                        ]
                      }
                    },
                    "/api/investigate/v1/orgs/{org_key}/processes/search_suggestions": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "suggestions": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "term": {
                                        "type": "string",
                                        "description": "term"
                                      },
                                      "weight": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "weight"
                                      },
                                      "required_skus_all": {
                                        "type": "array",
                                        "description": "required_skus_all"
                                      },
                                      "required_skus_some": {
                                        "type": "array",
                                        "items": {
                                          "type": "string"
                                        },
                                        "description": "required_skus_some"
                                      }
                                    }
                                  },
                                  "description": "suggestions"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Search for processes by query",
                        "description": "Search for processes by query",
                        "operationId": "[[variables('_operationId-ProcessSearchSuggestionsByQuery')]",
                        "parameters": [
                          {
                            "name": "org_key",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Organization Key"
                          },
                          {
                            "name": "suggest.q",
                            "in": "query",
                            "required": true,
                            "type": "string",
                            "default": "process_cmd",
                            "description": "Query to generate suggestions for"
                          },
                          {
                            "name": "suggest.count",
                            "in": "query",
                            "required": false,
                            "type": "integer",
                            "default": 50,
                            "description": "Number of suggestions to return"
                          }
                        ]
                      }
                    },
                    "/api/investigate/v2/orgs/{org_key}/processes/detail_jobs/{job_id}/results": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "completed": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "completed"
                                },
                                "contacted": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "contacted"
                                },
                                "num_available": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "num_available"
                                },
                                "num_found": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "num_found"
                                },
                                "results": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "backend_timestamp": {
                                        "type": "string",
                                        "description": "backend_timestamp"
                                      },
                                      "childproc_count": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "childproc_count"
                                      },
                                      "crossproc_count": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "crossproc_count"
                                      },
                                      "device_external_ip": {
                                        "type": "string",
                                        "description": "device_external_ip"
                                      },
                                      "device_group_id": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "device_group_id"
                                      },
                                      "device_id": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "device_id"
                                      },
                                      "device_location": {
                                        "type": "string",
                                        "description": "device_location"
                                      },
                                      "device_name": {
                                        "type": "string",
                                        "description": "device_name"
                                      },
                                      "device_os": {
                                        "type": "string",
                                        "description": "device_os"
                                      },
                                      "device_os_version": {
                                        "type": "string",
                                        "description": "device_os_version"
                                      },
                                      "device_policy": {
                                        "type": "string",
                                        "description": "device_policy"
                                      },
                                      "device_policy_id": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "device_policy_id"
                                      },
                                      "device_target_priority": {
                                        "type": "string",
                                        "description": "device_target_priority"
                                      },
                                      "device_timestamp": {
                                        "type": "string",
                                        "description": "device_timestamp"
                                      },
                                      "document_guid": {
                                        "type": "string",
                                        "description": "document_guid"
                                      },
                                      "filemod_count": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "filemod_count"
                                      },
                                      "ingress_time": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "ingress_time"
                                      },
                                      "modload_count": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "modload_count"
                                      },
                                      "netconn_count": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "netconn_count"
                                      },
                                      "org_id": {
                                        "type": "string",
                                        "description": "org_id"
                                      },
                                      "parent_effective_reputation": {
                                        "type": "string",
                                        "description": "parent_effective_reputation"
                                      },
                                      "parent_guid": {
                                        "type": "string",
                                        "description": "parent_guid"
                                      },
                                      "parent_hash": {
                                        "type": "array",
                                        "items": {
                                          "type": "string"
                                        },
                                        "description": "parent_hash"
                                      },
                                      "parent_name": {
                                        "type": "string",
                                        "description": "parent_name"
                                      },
                                      "parent_pid": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "parent_pid"
                                      },
                                      "parent_publisher_state": {
                                        "type": "array",
                                        "items": {
                                          "type": "string"
                                        },
                                        "description": "parent_publisher_state"
                                      },
                                      "parent_reputation": {
                                        "type": "string",
                                        "description": "parent_reputation"
                                      },
                                      "process_cmdline": {
                                        "type": "array",
                                        "items": {
                                          "type": "string"
                                        },
                                        "description": "process_cmdline"
                                      },
                                      "process_cmdline_length": {
                                        "type": "array",
                                        "items": {
                                          "type": "integer",
                                          "format": "int32"
                                        },
                                        "description": "process_cmdline_length"
                                      },
                                      "process_effective_reputation": {
                                        "type": "string",
                                        "description": "process_effective_reputation"
                                      },
                                      "process_guid": {
                                        "type": "string",
                                        "description": "process_guid"
                                      },
                                      "process_hash": {
                                        "type": "array",
                                        "items": {
                                          "type": "string"
                                        },
                                        "description": "process_hash"
                                      },
                                      "process_name": {
                                        "type": "string",
                                        "description": "process_name"
                                      },
                                      "process_pid": {
                                        "type": "array",
                                        "items": {
                                          "type": "integer",
                                          "format": "int32"
                                        },
                                        "description": "process_pid"
                                      },
                                      "process_publisher_state": {
                                        "type": "array",
                                        "items": {
                                          "type": "string"
                                        },
                                        "description": "process_publisher_state"
                                      },
                                      "process_reputation": {
                                        "type": "string",
                                        "description": "process_reputation"
                                      },
                                      "process_sha256": {
                                        "type": "string",
                                        "description": "process_sha256"
                                      },
                                      "process_start_time": {
                                        "type": "string",
                                        "description": "process_start_time"
                                      },
                                      "process_username": {
                                        "type": "array",
                                        "items": {
                                          "type": "string"
                                        },
                                        "description": "process_username"
                                      },
                                      "regmod_count": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "regmod_count"
                                      },
                                      "scriptload_count": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "scriptload_count"
                                      }
                                    }
                                  },
                                  "description": "results"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Search for a process metadata by process GUID",
                        "description": "Retrieves the process detail results for a given job_id. Confirm the search has completed by verifying that contacted equals completed",
                        "operationId": "[[variables('_operationId-ProcessMetadataSearchByProcessGUID')]",
                        "parameters": [
                          {
                            "name": "org_key",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Organization Key"
                          },
                          {
                            "name": "job_id",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Job Id"
                          }
                        ]
                      }
                    },
                    "/api/investigate/v2/orgs/{org_key}/events/{process_guid}/_search": {
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "results": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "backend_timestamp": {
                                        "type": "string",
                                        "description": "backend_timestamp"
                                      },
                                      "created_timestamp": {
                                        "type": "string",
                                        "description": "created_timestamp"
                                      },
                                      "enriched": {
                                        "type": "boolean",
                                        "description": "enriched"
                                      },
                                      "enriched_event_type": {
                                        "type": "string",
                                        "description": "enriched_event_type"
                                      },
                                      "event_description": {
                                        "type": "string",
                                        "description": "event_description"
                                      },
                                      "event_guid": {
                                        "type": "string",
                                        "description": "event_guid"
                                      },
                                      "event_hash": {
                                        "type": "string",
                                        "description": "event_hash"
                                      },
                                      "event_timestamp": {
                                        "type": "string",
                                        "description": "event_timestamp"
                                      },
                                      "event_type": {
                                        "type": "string",
                                        "description": "event_type"
                                      },
                                      "legacy": {
                                        "type": "boolean",
                                        "description": "legacy"
                                      },
                                      "legacy_description": {
                                        "type": "string",
                                        "description": "legacy_description"
                                      },
                                      "netconn_action": {
                                        "type": "string",
                                        "description": "netconn_action"
                                      },
                                      "netconn_inbound": {
                                        "type": "boolean",
                                        "description": "netconn_inbound"
                                      },
                                      "netconn_local_ipv4": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "netconn_local_ipv4"
                                      },
                                      "netconn_local_port": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "netconn_local_port"
                                      },
                                      "netconn_protocol": {
                                        "type": "string",
                                        "description": "netconn_protocol"
                                      },
                                      "netconn_remote_ipv4": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "netconn_remote_ipv4"
                                      },
                                      "netconn_remote_port": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "netconn_remote_port"
                                      },
                                      "process_guid": {
                                        "type": "string",
                                        "description": "process_guid"
                                      },
                                      "process_pid": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "process_pid"
                                      }
                                    }
                                  },
                                  "description": "results"
                                },
                                "num_found": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "num_found"
                                },
                                "num_available": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "num_available"
                                },
                                "total_segments": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "total_segments"
                                },
                                "processed_segments": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "processed_segments"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Search for processes events by process GUID",
                        "description": "Fetch the events associated with a given process. These events are often more complete than the enriched events but, unlike the enriched event searches, must be limited to one process at a time.",
                        "operationId": "[[variables('_operationId-SearchForProcessEventsByProcessGUID')]",
                        "parameters": [
                          {
                            "name": "org_key",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Organization Key"
                          },
                          {
                            "name": "process_guid",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Process GUID"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "criteria": {
                                  "type": "string",
                                  "description": "Criteria is an object that represents values that must be in the results. Either query or criteria/exclusion must be included",
                                  "title": "[variables('blanks')]"
                                },
                                "exclusions": {
                                  "type": "string",
                                  "description": "Exclusions is a map that represents values that must not be in the results. Either query or criteria/exclusion must be included",
                                  "title": "[variables('blanks')]"
                                },
                                "fields": {
                                  "type": "array",
                                  "items": {
                                    "type": "string",
                                    "description": "A list of fields to include in the results, specify * to return all the default fields and add additional fields that are not returned by default",
                                    "title": "[variables('blanks')]"
                                  },
                                  "description": "fields"
                                },
                                "query": {
                                  "type": "string",
                                  "description": "Query in lucene syntax and/or including value searches. Either query or criteria/exclusion must be included",
                                  "title": "[variables('blanks')]"
                                },
                                "rows": {
                                  "type": "string",
                                  "description": "Number of rows to request, can be paginated",
                                  "title": "[variables('blanks')]"
                                },
                                "sort": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "field": {
                                        "type": "string",
                                        "description": "field"
                                      },
                                      "order": {
                                        "type": "string",
                                        "description": "Sorting Order [ asc , desc ]",
                                        "title": "[variables('blanks')]",
                                        "enum": [
                                          "asc",
                                          "desc"
                                        ]
                                      }
                                    }
                                  },
                                  "description": "sort"
                                },
                                "start": {
                                  "type": "string",
                                  "description": "First row to use for pagination",
                                  "title": "[variables('blanks')]"
                                },
                                "time_range": {
                                  "type": "object",
                                  "properties": {
                                    "end": {
                                      "type": "string",
                                      "description": "Time Range end [ ISO 8601 timestamp ]",
                                      "title": "[variables('blanks')]"
                                    },
                                    "start": {
                                      "type": "string",
                                      "description": "Time Range start [ ISO 8601 timestamp ]",
                                      "title": "[variables('blanks')]"
                                    },
                                    "window": {
                                      "type": "string",
                                      "description": "Window will take priority over start and end if provided",
                                      "title": "[variables('blanks')]"
                                    }
                                  },
                                  "description": "time_range"
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "/appservices/v6/orgs/{org_key}/alerts/{alert_id}/workflow": {
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "state": {
                                  "type": "string",
                                  "description": "Workflow state",
                                  "title": "[variables('blanks')]"
                                },
                                "remediation": {
                                  "type": "string",
                                  "description": "Description or justification for the change",
                                  "title": "[variables('blanks')]"
                                },
                                "last_update_time": {
                                  "type": "string",
                                  "description": "The last time the alert was updated",
                                  "title": "[variables('blanks')]"
                                },
                                "comment": {
                                  "type": "string",
                                  "description": "Comment to include with the operation",
                                  "title": "[variables('blanks')]"
                                },
                                "changed_by": {
                                  "type": "string",
                                  "description": "changed_by",
                                  "title": "[variables('blanks')]"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Dismiss an alert",
                        "description": "Update the alert with the current state of the remediation",
                        "operationId": "[[variables('_operationId-DismissAnAlert')]",
                        "x-ms-visibility": "important",
                        "parameters": [
                          {
                            "name": "org_key",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Organization Key",
                            "x-ms-visibility": "important"
                          },
                          {
                            "name": "alert_id",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Alert Id",
                            "x-ms-visibility": "important"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "state": {
                                  "type": "string",
                                  "description": "Workflow state to set",
                                  "title": "[variables('blanks')]",
                                  "x-ms-visibility": "important",
                                  "default": "DISMISSED",
                                  "enum": [
                                    "DISMISSED",
                                    "OPEN"
                                  ]
                                },
                                "comment": {
                                  "type": "string",
                                  "description": "Comment to include with the operation",
                                  "title": "[variables('blanks')]",
                                  "x-ms-visibility": "important"
                                },
                                "remediation_state": {
                                  "type": "string",
                                  "description": "Description or justification for the change",
                                  "title": "[variables('blanks')]",
                                  "x-ms-visibility": "important"
                                }
                              },
                              "x-ms-visibility": "important",
                              "required": [
                                "state",
                                "comment",
                                "remediation_state"
                              ]
                            },
                            "x-ms-visibility": "important"
                          }
                        ]
                      }
                    },
                    "/appservices/v6/orgs/{org_key}/alerts/{alert_id}/notes": {
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "author": {
                                  "type": "string",
                                  "description": "author"
                                },
                                "create_time": {
                                  "type": "string",
                                  "description": "create_time"
                                },
                                "id": {
                                  "type": "string",
                                  "description": "id"
                                },
                                "note": {
                                  "type": "string",
                                  "description": "note"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Add a note to an alert",
                        "description": "Add a comment to provide context, in the case someone looks in the CBC console.",
                        "operationId": "[[variables('_operationId-AddNoteToAnAlert')]",
                        "x-ms-visibility": "important",
                        "parameters": [
                          {
                            "name": "org_key",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Organization Key",
                            "x-ms-visibility": "important"
                          },
                          {
                            "name": "alert_id",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Alert Id",
                            "x-ms-visibility": "important"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "note": {
                                  "type": "string",
                                  "description": "A segment of text to attach to the specified Alert [ Max: 255 characters ]",
                                  "title": "[variables('blanks')]",
                                  "x-ms-visibility": "important"
                                }
                              },
                              "required": [
                                "note"
                              ]
                            }
                          }
                        ]
                      }
                    }
                  },
                  "securityDefinitions": {
                    "api_key": {
                      "type": "apiKey",
                      "in": "header",
                      "name": "X-Auth-Token"
                    }
                  },
                  "security": "[variables('TemplateEmptyArray')]",
                  "tags": "[variables('TemplateEmptyArray')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('LogicAppsCustomConnector-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "LogicAppsCustomConnector",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "VMware Carbon Black Cloud",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft",
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "comments": "This connector used to perform different actions on alerts , device and threats using CarbonBlack cloud endpoint API.",
            "lastUpdateTime": "2023-06-29T18:09:22.124Z",
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "EndpointTakeActionFromTeams-CarbonBlack playbook",
        "displayName": "EndpointTakeActionFromTeams-CarbonBlack playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName2'),'/',variables('playbookVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "EndpointTakeActionFromTeams-CarbonBlack Playbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "EndpointTakeActionFromTeams-CarbonBlack",
              "type": "string",
              "metadata": {
                "description": "Name of the Logic Apps resource to be created"
              }
            },
            "CustomConnectorName": {
              "defaultValue": "CarbonBlackCloudConnector",
              "type": "string",
              "metadata": {
                "description": "Name of the custom connector which interacts with Carbon Black"
              }
            },
            "OrganizationKey": {
              "defaultValue": "OrganizationKey",
              "type": "string",
              "metadata": {
                "description": "CarbonBlack Org Key"
              }
            },
            "PolicyId": {
              "defaultValue": 0,
              "type": "int",
              "metadata": {
                "description": "CarbonBlack PolicyId"
              }
            },
            "Teams GroupId": {
              "defaultValue": "TeamgroupId",
              "type": "string",
              "metadata": {
                "description": "GroupId of the Team channel"
              }
            },
            "Teams ChannelId": {
              "defaultValue": "TeamChannelId",
              "type": "string",
              "metadata": {
                "description": "Team ChannelId"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "CarbonBlackConnectionName": "[[concat('CarbonBlackCloudConnector-', parameters('PlaybookName'))]",
            "TeamsConnectionName": "[[concat('teamsconnector-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('CarbonBlackConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('TeamsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('CarbonBlackConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
              ],
              "tags": {
                "hidden-SentinelTemplateName": "EndpointResponseTeams-CarbonBlack",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered_(Private_Preview_only)": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Action_information_note": {
                      "runAfter": {
                        "Organization_Id": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "ActionInfo",
                            "type": "string"
                          }
                        ]
                      },
                      "description": "Variable to show the note n the adaptive card [ Quarantined , Update_Policy ]"
                    },
                    "Action_summary_to_display_in_the_adaptive_card": {
                      "runAfter": {
                        "Action_information_note": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "ActionSummary",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "description": "Variable to store the summary of the actions taken for each device"
                    },
                    "Action_taken_on_each_device": {
                      "runAfter": {
                        "Adaptive_card_columns_list": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "DeviceActions",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "description": "Variable to store the actions to taken on each device"
                    },
                    "Adaptive_card_body": {
                      "runAfter": {
                        "Adaptive_card_columns": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "AdaptivecardBody",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "description": "Variable to store the adaptive card body"
                    },
                    "Adaptive_card_columns": {
                      "runAfter": {
                        "Action_taken_on_each_device": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "AdaptivecardColumns",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "description": "Prepare adaptive card columns list to show the devices information returned from carbon black"
                    },
                    "Adaptive_card_columns_list": {
                      "runAfter": {
                        "Action_summary_to_display_in_the_adaptive_card": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "AdaptivecardColumnsList",
                            "type": "object"
                          }
                        ]
                      },
                      "description": "Prepare adaptive card columns list to show the devices information returned from carbon black"
                    },
                    "Add_comment_to_incident_(V3)": {
                      "runAfter": {
                        "Compose": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "message": "<p><strong></strong><strong>@{outputs('Compose')}</strong><strong> &nbsp;</strong><span style=\"font-size: 16px\"><strong>CarbonBlack TakeDeviceActionFromTeams Playbook<br>\n</strong></span><strong><br>\nCarbonBlack TakeDeviceActionFromTeams playbook was triggered and collected the following information from Carbon Black:<br>\n<br>\n</strong><strong>@{body('Create_HTML_table_-_Carbon_black_device_information')}</strong><strong><br>\n<br>\nSummary of Device's Action taken :</strong><br>\n<br>\n@{body('Create_HTML_table')}<br>\n<br>\n</p>"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/Incidents/Comment"
                      }
                    },
                    "Carbon_black_devices_information": {
                      "runAfter": {
                        "Incident_hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "CarbonBlackDeviceInfo",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "description": "Variable to store the each device information returned by carbon black cloud"
                    },
                    "Compose": {
                      "runAfter": {
                        "Create_HTML_table_-_Carbon_black_device_information": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "<img src=\"https://avatars.githubusercontent.com/u/2071378?s=280&v=4\" alt=\"Lamp\" width=\"32\" height=\"32\">"
                    },
                    "Compose_adaptive_card_body": {
                      "runAfter": {
                        "For_each_incident_configuration": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "@variables('AdaptivecardBody')"
                    },
                    "Compose_incident_configuration": {
                      "runAfter": {
                        "For_each_adaptive_card_columns": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": [
                        {
                          "columns": [
                            {
                              "items": [
                                {
                                  "size": "Small",
                                  "style": "Person",
                                  "type": "Image",
                                  "url": "https://connectoricons-prod.azureedge.net/releases/v1.0.1391/1.0.1391.2130/azuresentinel/icon.png"
                                }
                              ],
                              "type": "Column",
                              "width": "auto"
                            }
                          ],
                          "type": "ColumnSet"
                        },
                        {
                          "columns": [
                            {
                              "items": [
                                {
                                  "size": "Medium",
                                  "text": "Incident configuration",
                                  "type": "TextBlock",
                                  "weight": "Bolder",
                                  "wrap": true
                                }
                              ],
                              "type": "Column",
                              "width": "auto"
                            }
                          ],
                          "type": "ColumnSet"
                        },
                        {
                          "text": "Close Microsoft Sentinel incident?",
                          "type": "TextBlock"
                        },
                        {
                          "choices": [
                            {
                              "isSelected": true,
                              "title": "False Positive - Inaccurate Data",
                              "value": "False Positive - Inaccurate Data"
                            },
                            {
                              "isSelected": true,
                              "title": "False Positive - Incorrect Alert Logic",
                              "value": "False Positive - Incorrect Alert Logic"
                            },
                            {
                              "title": "True Positive - Suspicious Activity",
                              "value": "True Positive - Suspicious Activity"
                            },
                            {
                              "title": "Benign Positive - Suspicious But Expected",
                              "value": "Benign Positive - Suspicious But Expected"
                            },
                            {
                              "title": "Undetermined",
                              "value": "Undetermined"
                            }
                          ],
                          "id": "incidentStatus",
                          "style": "compact",
                          "type": "Input.ChoiceSet",
                          "value": "Benign Positive - Suspicious But Expected"
                        },
                        {
                          "text": "Change Microsoft Sentinel Incident Severity?",
                          "type": "TextBlock"
                        },
                        {
                          "choices": [
                            {
                              "title": "High",
                              "value": "High"
                            },
                            {
                              "title": "Medium",
                              "value": "Medium"
                            },
                            {
                              "title": "Low",
                              "value": "Low"
                            },
                            {
                              "title": "Don't change",
                              "value": "same"
                            }
                          ],
                          "id": "incidentSeverity",
                          "style": "compact",
                          "type": "Input.ChoiceSet",
                          "value": "@{triggerBody()?['object']?['properties']?['severity']}"
                        }
                      ],
                      "description": "Compose incident configuration"
                    },
                    "Compose_product_name": {
                      "runAfter": {
                        "Select_alert_product_names": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "@body('Select_alert_product_names')?[0]?['text']",
                      "description": "compose to select the incident alert product name"
                    },
                    "Condition_to_check_the_summary_action_Ignore_or_Submit": {
                      "actions": {
                        "Update_incident": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "classification": {
                                "ClassificationAndReason": "@{body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response')?['data']?['incidentStatus']}"
                              },
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "severity": "@{body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response')?['data']?['incidentSeverity']}",
                              "status": "Closed"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Incidents"
                          }
                        }
                      },
                      "runAfter": {
                        "Add_comment_to_incident_(V3)": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "equals": [
                              "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response')?['submitActionId']",
                              "Submit"
                            ]
                          }
                        ]
                      },
                      "type": "If",
                      "description": "Condition to check the summary action taken from SOC \"Ignore\" or \"Change Incident Configuration\""
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "For_each_hosts_information": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "columns": [
                          {
                            "header": "DeviceId",
                            "value": "@item()?['device']"
                          },
                          {
                            "header": "Action",
                            "value": "@item()?['action']"
                          },
                          {
                            "header": "StatusCode",
                            "value": "@item()?['statuscode']"
                          }
                        ],
                        "format": "HTML",
                        "from": "@variables('ActionSummary')"
                      }
                    },
                    "Create_HTML_table_-_Carbon_black_device_information": {
                      "runAfter": {
                        "Select_action_summary": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "columns": [
                          {
                            "header": "Devicename",
                            "value": "@item()?['name']"
                          },
                          {
                            "header": "Quarantined",
                            "value": "@item()?['quarantined']"
                          },
                          {
                            "header": "Policyname",
                            "value": "@item()?['policy_name']"
                          },
                          {
                            "header": "PolicyId",
                            "value": "@item()?['policy_id']"
                          },
                          {
                            "header": "DeviceownerId",
                            "value": "@item()?['device_owner_id']"
                          },
                          {
                            "header": "DeviceId",
                            "value": "@item()?['id']"
                          },
                          {
                            "header": "Devicestatus",
                            "value": "@item()?['status']"
                          },
                          {
                            "header": "Operatingsystem",
                            "value": "@item()?['os']"
                          },
                          {
                            "header": "OperatingsystemVersion",
                            "value": "@item()?['os_version']"
                          },
                          {
                            "header": "Organizationname",
                            "value": "@item()?['organization_name']"
                          },
                          {
                            "header": "Email",
                            "value": "@item()?['email']"
                          },
                          {
                            "header": "Sensorstates",
                            "value": "@join(item()?['sensor_states'],',')"
                          },
                          {
                            "header": "LastreportedTime",
                            "value": "@item()?['last_reported_time']"
                          },
                          {
                            "header": "SensorVersion",
                            "value": "@{item()?['sensor_version']}"
                          }
                        ],
                        "format": "HTML",
                        "from": "@variables('CarbonBlackDeviceInfo')"
                      }
                    },
                    "DeviceIds": {
                      "runAfter": {
                        "Compose_product_name": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "deviceids",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "description": "Variable to store the device ids information"
                    },
                    "Devices_action_needed": {
                      "runAfter": {
                        "Carbon_black_devices_information": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "DevicesActionNeeded",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "description": "Variable to store the devices that needs SOC action"
                    },
                    "Entities_-_Get_Hosts": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      }
                    },
                    "For_each_Hosts": {
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "actions": {
                        "Append_Hosts": {
                          "runAfter": {
                            "Search_devices_in_your_organization": [
                              "Succeeded"
                            ]
                          },
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "Hosts",
                            "value": "@items('For_each_Hosts')?['HostName']"
                          },
                          "description": "Append each host name to the Hosts"
                        },
                        "Condition_to_check_the_filter_criteria_returns_records": {
                          "actions": {
                            "For_each_results": {
                              "foreach": "@body('Search_devices_in_your_organization')?['results']",
                              "actions": {
                                "Append_adaptive_card_columns": {
                                  "runAfter": {
                                    "Condition_to_check_the_device_actions": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "AdaptivecardColumns",
                                    "value": {
                                      "columns": [
                                        "@variables('AdaptivecardColumnsList')"
                                      ],
                                      "type": "ColumnSet"
                                    }
                                  },
                                  "description": "Prepare adaptive card columns list"
                                },
                                "Append_carbon_black_device_information": {
                                  "runAfter": {
                                    "Append_deviceids_information": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "CarbonBlackDeviceInfo",
                                    "value": "@item()"
                                  },
                                  "description": "Append each device information returned by carbon black cloud"
                                },
                                "Append_deviceids_information": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "deviceids",
                                    "value": "@items('For_each_results')?['id']"
                                  }
                                },
                                "Condition__to_check_the_device_is_Quarantined_and_policy_configured": {
                                  "actions": {
                                    "Empty_actions_if_the_device_is_in_quarantine_and_assigned_to_predefined_policy": {
                                      "type": "SetVariable",
                                      "inputs": {
                                        "name": "DeviceActions",
                                        "value": "[variables('TemplateEmptyArray')]"
                                      },
                                      "description": "Empty actions if the device is in quarantine and assigned to predefined policy"
                                    },
                                    "Set_action_information": {
                                      "runAfter": {
                                        "Empty_actions_if_the_device_is_in_quarantine_and_assigned_to_predefined_policy": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable",
                                      "inputs": {
                                        "name": "ActionInfo",
                                        "value": "Note: The device is in qurantine and configured to predefined policy"
                                      },
                                      "description": "Set action information - The device is in quarantine and configured to predefined policy"
                                    }
                                  },
                                  "runAfter": {
                                    "Append_carbon_black_device_information": [
                                      "Succeeded"
                                    ]
                                  },
                                  "else": {
                                    "actions": {
                                      "Condition_to_check_the_quarantine_and_assigned_to_predefined_policy": {
                                        "actions": {
                                          "Append__device_ids_to_array": {
                                            "runAfter": {
                                              "Set_device_actions_Quarantine_and_Update_Policy": [
                                                "Succeeded"
                                              ]
                                            },
                                            "type": "AppendToArrayVariable",
                                            "inputs": {
                                              "name": "DevicesActionNeeded",
                                              "value": "@items('For_each_results')?['id']"
                                            }
                                          },
                                          "Set_action_info": {
                                            "runAfter": {
                                              "Append__device_ids_to_array": [
                                                "Succeeded"
                                              ]
                                            },
                                            "type": "SetVariable",
                                            "inputs": {
                                              "name": "ActionInfo",
                                              "value": " "
                                            }
                                          },
                                          "Set_device_actions_Quarantine_and_Update_Policy": {
                                            "type": "SetVariable",
                                            "inputs": {
                                              "name": "DeviceActions",
                                              "value": [
                                                {
                                                  "title": "QUARANTINE",
                                                  "value": "QUARANTINE"
                                                },
                                                {
                                                  "title": "UPDATE_POLICY",
                                                  "value": "UPDATE_POLICY"
                                                },
                                                {
                                                  "title": "Ignore",
                                                  "value": "Ignore"
                                                }
                                              ]
                                            },
                                            "description": "Set device actions [ Quarantine , Update_Policy and Ignore ]"
                                          }
                                        },
                                        "else": {
                                          "actions": {
                                            "Condition_to_set_the_actions_dynamically": {
                                              "actions": {
                                                "Append_to_array_device_id": {
                                                  "runAfter": {
                                                    "Set_device_actions_[_Update_Policy,_Ignore_]": [
                                                      "Succeeded"
                                                    ]
                                                  },
                                                  "type": "AppendToArrayVariable",
                                                  "inputs": {
                                                    "name": "DevicesActionNeeded",
                                                    "value": "@items('For_each_results')?['id']"
                                                  }
                                                },
                                                "Set_action_information_-_The_device_is_in_quarantine": {
                                                  "type": "SetVariable",
                                                  "inputs": {
                                                    "name": "ActionInfo",
                                                    "value": "Note: The device is in qurantine"
                                                  },
                                                  "description": "Set action information - The device is in quarantine"
                                                },
                                                "Set_device_actions_[_Update_Policy,_Ignore_]": {
                                                  "runAfter": {
                                                    "Set_action_information_-_The_device_is_in_quarantine": [
                                                      "Succeeded"
                                                    ]
                                                  },
                                                  "type": "SetVariable",
                                                  "inputs": {
                                                    "name": "DeviceActions",
                                                    "value": [
                                                      {
                                                        "title": "UPDATE_POLICY",
                                                        "value": "UPDATE_POLICY"
                                                      },
                                                      {
                                                        "title": "Ignore",
                                                        "value": "Ignore"
                                                      }
                                                    ]
                                                  },
                                                  "description": "Set device actions [ Update_Policy , Ignore ]"
                                                }
                                              },
                                              "else": {
                                                "actions": {
                                                  "Condition": {
                                                    "actions": {
                                                      "Device_actions__are_not_required": {
                                                        "runAfter": {
                                                          "Set_action_information_-_Quarantine_is_not_supported_on_devices_of_OS_type_Linux": [
                                                            "Succeeded"
                                                          ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                          "name": "DeviceActions",
                                                          "value": "[variables('TemplateEmptyArray')]"
                                                        },
                                                        "description": "Quarantine  action is not supported on devices of OS type Linux"
                                                      },
                                                      "Set_action_information_-_Quarantine_is_not_supported_on_devices_of_OS_type_Linux": {
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                          "name": "ActionInfo",
                                                          "value": "Note: Quarantine is not supported on devices of OS type Linux"
                                                        },
                                                        "description": "Set action information - Quarantine is not supported on devices of OS type Linux"
                                                      }
                                                    },
                                                    "else": {
                                                      "actions": {
                                                        "Append_device_name": {
                                                          "runAfter": {
                                                            "Set_device_actions_[_Quarantine_,_Ignore_]": [
                                                              "Succeeded"
                                                            ]
                                                          },
                                                          "type": "AppendToArrayVariable",
                                                          "inputs": {
                                                            "name": "DevicesActionNeeded",
                                                            "value": "@items('For_each_results')?['id']"
                                                          },
                                                          "description": "Append device name which needs SOC action"
                                                        },
                                                        "Set_action_information_-_The_device_is_assigned_to_predefined_policy": {
                                                          "type": "SetVariable",
                                                          "inputs": {
                                                            "name": "ActionInfo",
                                                            "value": "Note: The device is added to predefined policy @{items('For_each_results')?['policy_name']}"
                                                          },
                                                          "description": "Set action information - The device is added to predefined policy"
                                                        },
                                                        "Set_device_actions_[_Quarantine_,_Ignore_]": {
                                                          "runAfter": {
                                                            "Set_action_information_-_The_device_is_assigned_to_predefined_policy": [
                                                              "Succeeded"
                                                            ]
                                                          },
                                                          "type": "SetVariable",
                                                          "inputs": {
                                                            "name": "DeviceActions",
                                                            "value": [
                                                              {
                                                                "title": "QUARANTINE",
                                                                "value": "QUARANTINE"
                                                              },
                                                              {
                                                                "title": "Ignore",
                                                                "value": "Ignore"
                                                              }
                                                            ]
                                                          },
                                                          "description": "Set device actions [ Quarantine , Ignore ]"
                                                        }
                                                      }
                                                    },
                                                    "expression": {
                                                      "and": [
                                                        {
                                                          "equals": [
                                                            "@toLower(items('For_each_results')?['os'])",
                                                            "linux"
                                                          ]
                                                        }
                                                      ]
                                                    },
                                                    "type": "If"
                                                  }
                                                }
                                              },
                                              "expression": {
                                                "and": [
                                                  {
                                                    "equals": [
                                                      "@items('For_each_results')?['quarantined']",
                                                      true
                                                    ]
                                                  },
                                                  {
                                                    "not": {
                                                      "equals": [
                                                        "@items('For_each_results')?['policy_id']",
                                                        "@variables('PredefinedPolicy')"
                                                      ]
                                                    }
                                                  }
                                                ]
                                              },
                                              "type": "If"
                                            }
                                          }
                                        },
                                        "expression": {
                                          "and": [
                                            {
                                              "not": {
                                                "equals": [
                                                  "@items('For_each_results')?['policy_id']",
                                                  "@variables('PredefinedPolicy')"
                                                ]
                                              }
                                            },
                                            {
                                              "not": {
                                                "equals": [
                                                  "@items('For_each_results')?['quarantined']",
                                                  true
                                                ]
                                              }
                                            },
                                            {
                                              "not": {
                                                "equals": [
                                                  "@tolower(items('For_each_results')?['os'])",
                                                  "linux"
                                                ]
                                              }
                                            }
                                          ]
                                        },
                                        "type": "If"
                                      }
                                    }
                                  },
                                  "expression": {
                                    "and": [
                                      {
                                        "equals": [
                                          "@items('For_each_results')?['quarantined']",
                                          true
                                        ]
                                      },
                                      {
                                        "equals": [
                                          "@items('For_each_results')?['policy_id']",
                                          "@variables('PredefinedPolicy')"
                                        ]
                                      },
                                      {
                                        "equals": [
                                          "",
                                          ""
                                        ]
                                      }
                                    ]
                                  },
                                  "type": "If",
                                  "description": "Verify the device is Quarantied"
                                },
                                "Condition_to_check_the_device_actions": {
                                  "actions": {
                                    "Set_adaptive_card_columns_list_with_choices": {
                                      "type": "SetVariable",
                                      "inputs": {
                                        "name": "AdaptivecardColumnsList",
                                        "value": {
                                          "items": [
                                            {
                                              "text": "@{items('For_each_results')?['id']} @{items('For_each_results')?['name']} @{items('For_each_results')?['organization_name']}",
                                              "type": "TextBlock",
                                              "weight": "Bolder"
                                            },
                                            {
                                              "text": "Device system operation is @{items('For_each_results')?['os']} @{items('For_each_results')?['os_version']}",
                                              "type": "TextBlock"
                                            },
                                            {
                                              "text": "Owner is @{items('For_each_results')?['first_name']} @{items('For_each_results')?['last_name']} @{items('For_each_results')?['email']}",
                                              "type": "TextBlock"
                                            },
                                            {
                                              "text": "Device policy is @{items('For_each_results')?['policy_name']} @{items('For_each_results')?['policy_id']}",
                                              "type": "TextBlock"
                                            },
                                            {
                                              "text": "Sensor states are : @{body('Join_sensor_states_results')}",
                                              "type": "TextBlock",
                                              "wrap": true
                                            },
                                            {
                                              "text": "@{variables('ActionInfo')}",
                                              "type": "TextBlock",
                                              "weight": "Bolder",
                                              "wrap": true
                                            },
                                            {
                                              "choices": "@variables('DeviceActions')",
                                              "id": "@{items('For_each_results')?['id']}",
                                              "placeholder": "Please choose",
                                              "style": "compact",
                                              "type": "Input.ChoiceSet",
                                              "value": "Ignore"
                                            }
                                          ],
                                          "type": "Column",
                                          "width": "stretch"
                                        }
                                      },
                                      "description": "Set adaptive card columns list with choice list [ Quarantine , Update_Policy , Ignore ]"
                                    }
                                  },
                                  "runAfter": {
                                    "Join_sensor_states_results": [
                                      "Succeeded"
                                    ]
                                  },
                                  "else": {
                                    "actions": {
                                      "Set_adaptive_card_columns_list_without_choices": {
                                        "type": "SetVariable",
                                        "inputs": {
                                          "name": "AdaptivecardColumnsList",
                                          "value": {
                                            "items": [
                                              {
                                                "text": "@{items('For_each_results')?['id']} @{items('For_each_results')?['name']} @{items('For_each_results')?['organization_name']}",
                                                "type": "TextBlock",
                                                "weight": "Bolder"
                                              },
                                              {
                                                "text": "Device system operation is @{items('For_each_results')?['os']} @{items('For_each_results')?['os_version']}",
                                                "type": "TextBlock"
                                              },
                                              {
                                                "text": "Owner is @{items('For_each_results')?['first_name']} @{items('For_each_results')?['last_name']} @{items('For_each_results')?['email']}",
                                                "type": "TextBlock"
                                              },
                                              {
                                                "text": "Device policy is @{items('For_each_results')?['policy_name']} @{items('For_each_results')?['policy_id']}",
                                                "type": "TextBlock"
                                              },
                                              {
                                                "text": "Sensor states are: @{body('Join_sensor_states_results')}",
                                                "type": "TextBlock",
                                                "wrap": true
                                              },
                                              {
                                                "text": "@{variables('ActionInfo')}",
                                                "type": "TextBlock",
                                                "weight": "Bolder",
                                                "wrap": true
                                              }
                                            ],
                                            "type": "Column",
                                            "width": "stretch"
                                          }
                                        },
                                        "description": "Set adaptive card columns list without choice list"
                                      }
                                    }
                                  },
                                  "expression": {
                                    "and": [
                                      {
                                        "greater": [
                                          "@length(variables('DeviceActions'))",
                                          0
                                        ]
                                      }
                                    ]
                                  },
                                  "type": "If"
                                },
                                "Join_sensor_states_results": {
                                  "runAfter": {
                                    "Condition__to_check_the_device_is_Quarantined_and_policy_configured": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "Join",
                                  "inputs": {
                                    "from": "@items('For_each_results')?['sensor_states']",
                                    "joinWith": ","
                                  },
                                  "description": "Join sensor states with comma separated to show in the adaptive card"
                                }
                              },
                              "type": "Foreach",
                              "description": "Iterate over results and take proper action to Quarantine or Update_Policy on device"
                            }
                          },
                          "runAfter": {
                            "Append_Hosts": [
                              "Succeeded"
                            ]
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@body('Search_devices_in_your_organization')?['num_found']",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If",
                          "description": "Verify the filter criteria provided in the search devices in the organization returned records"
                        },
                        "Search_devices_in_your_organization": {
                          "runAfter": {
                            "Set_adaptive_card_body": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "query": "name : @{items('For_each_Hosts')?['HostName']}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['CarbonBlackCloudConnector']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/appservices/v6/orgs/@{encodeURIComponent(variables('OrganizationKey'))}/devices/_search"
                          }
                        },
                        "Set_adaptive_card_body": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "AdaptivecardBody",
                            "value": [
                              {
                                "size": "large",
                                "text": "Suspicious Device - Microsoft Sentinel",
                                "type": "TextBlock",
                                "weight": "bolder",
                                "wrap": true
                              },
                              {
                                "text": "Possible comprised device detected by the provider:  @{outputs('Compose_product_name')}",
                                "type": "TextBlock",
                                "wrap": true
                              },
                              {
                                "text": " @{triggerBody()?['object']?['properties']?['severity']} Incident - Carbon Black Device Actions ",
                                "type": "TextBlock",
                                "weight": "Bolder",
                                "wrap": true
                              },
                              {
                                "text": " Incident No : @{triggerBody()?['object']?['properties']?['incidentNumber']}  ",
                                "type": "TextBlock",
                                "weight": "Bolder",
                                "wrap": true
                              },
                              {
                                "text": "Incident description",
                                "type": "TextBlock",
                                "weight": "Bolder",
                                "wrap": true
                              },
                              {
                                "text": "@{triggerBody()?['object']?['properties']?['description']}",
                                "type": "TextBlock",
                                "wrap": true
                              },
                              {
                                "text": "[[Click here to view the Incident](@{triggerBody()?['object']?['properties']?['incidentUrl']})",
                                "type": "TextBlock",
                                "wrap": true
                              },
                              {
                                "size": "Small",
                                "style": "Person",
                                "type": "Image",
                                "url": "https://avatars.githubusercontent.com/u/2071378?s=280&v=4"
                              },
                              {
                                "text": "Carbon Black",
                                "type": "TextBlock",
                                "weight": "Bolder"
                              },
                              {
                                "text": "Take action on the devices in this incident: ",
                                "type": "TextBlock",
                                "weight": "Bolder"
                              }
                            ]
                          },
                          "description": "Set adaptive card body "
                        }
                      },
                      "runAfter": {
                        "DeviceIds": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "description": "For each host found from the provider",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    },
                    "For_each_adaptive_card_columns": {
                      "foreach": "@variables('AdaptivecardColumns')",
                      "actions": {
                        "Append_device_columns_to_adaptive_card_body": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "AdaptivecardBody",
                            "value": "@item()"
                          },
                          "description": "Append each device columns list to adaptive card body"
                        }
                      },
                      "runAfter": {
                        "For_each_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_hosts_information": {
                      "foreach": "@variables('deviceids')",
                      "actions": {
                        "Condition_to_check_the_device_that_needs_SOC_action": {
                          "actions": {
                            "Switch": {
                              "cases": {
                                "Case_Ignore": {
                                  "case": "Ignore",
                                  "actions": {
                                    "Append_action_summary_-_Ignore": {
                                      "type": "AppendToArrayVariable",
                                      "inputs": {
                                        "name": "ActionSummary",
                                        "value": {
                                          "action": "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response')?['data'][outputs('SOC_Action')]",
                                          "device": "@outputs('Device_id')",
                                          "statuscode": "204"
                                        }
                                      },
                                      "description": "Append action summary - Ignore"
                                    }
                                  }
                                },
                                "Case_QUARANTINE": {
                                  "case": "QUARANTINE",
                                  "actions": {
                                    "Condition_to_check_the_status_codes_on_QUARANTINE": {
                                      "actions": {
                                        "Append_action_summary_-_Quarantine": {
                                          "type": "AppendToArrayVariable",
                                          "inputs": {
                                            "name": "ActionSummary",
                                            "value": {
                                              "action": "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response')?['data'][outputs('SOC_Action')]",
                                              "device": "@outputs('Device_id')",
                                              "statuscode": "@outputs('device_actions_QUARANTINE')['statusCode']"
                                            }
                                          },
                                          "description": "Append action summary - Quarantine"
                                        }
                                      },
                                      "runAfter": {
                                        "device_actions_QUARANTINE": [
                                          "Succeeded"
                                        ]
                                      },
                                      "else": {
                                        "actions": {
                                          "Append_action_summary_-_Action_not_successful": {
                                            "type": "AppendToArrayVariable",
                                            "inputs": {
                                              "name": "ActionSummary",
                                              "value": {
                                                "action": "Not successful",
                                                "device": "@outputs('Device_id')",
                                                "statuscode": "@outputs('device_actions_QUARANTINE')['statusCode']"
                                              }
                                            }
                                          }
                                        }
                                      },
                                      "expression": {
                                        "or": [
                                          {
                                            "equals": [
                                              "@outputs('device_actions_QUARANTINE')?['statusCode']",
                                              200
                                            ]
                                          },
                                          {
                                            "equals": [
                                              "@outputs('device_actions_QUARANTINE')?['statusCode']",
                                              204
                                            ]
                                          }
                                        ]
                                      },
                                      "type": "If"
                                    },
                                    "device_actions_QUARANTINE": {
                                      "type": "ApiConnection",
                                      "inputs": {
                                        "body": {
                                          "action_type": "QUARANTINE",
                                          "device_id": [
                                            "@{outputs('Device_id')}"
                                          ],
                                          "options": {
                                            "toggle": "ON"
                                          }
                                        },
                                        "headers": {
                                          "Content-Type": "application/json"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['CarbonBlackCloudConnector']['connectionId']"
                                          }
                                        },
                                        "method": "post",
                                        "path": "/appservices/v6/orgs/@{encodeURIComponent(variables('OrganizationKey'))}/device_actions"
                                      }
                                    }
                                  }
                                },
                                "Case_UPDATE_POLICY": {
                                  "case": "UPDATE_POLICY",
                                  "actions": {
                                    "Condition__to_check_the_status_codes_-_UPDATE_POLICY": {
                                      "actions": {
                                        "Append_action_summary_-_Update_Policy": {
                                          "type": "AppendToArrayVariable",
                                          "inputs": {
                                            "name": "ActionSummary",
                                            "value": {
                                              "action": "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response')?['data'][outputs('SOC_Action')]",
                                              "device": "@outputs('Device_id')",
                                              "statuscode": "@outputs('device_actions_UPDATE_POLICY')['statusCode']"
                                            }
                                          }
                                        }
                                      },
                                      "runAfter": {
                                        "device_actions_UPDATE_POLICY": [
                                          "Succeeded"
                                        ]
                                      },
                                      "else": {
                                        "actions": {
                                          "Append_action_summary_-_Update_Policy_-_Action_not_successful": {
                                            "type": "AppendToArrayVariable",
                                            "inputs": {
                                              "name": "ActionSummary",
                                              "value": {
                                                "action": "Not successful",
                                                "device": "@outputs('Device_id')",
                                                "statuscode": "@outputs('device_actions_UPDATE_POLICY')['statusCode']"
                                              }
                                            }
                                          }
                                        }
                                      },
                                      "expression": {
                                        "or": [
                                          {
                                            "equals": [
                                              "@outputs('device_actions_UPDATE_POLICY')?['statusCode']",
                                              204
                                            ]
                                          },
                                          {
                                            "equals": [
                                              "@outputs('device_actions_UPDATE_POLICY')?['statusCode']",
                                              200
                                            ]
                                          }
                                        ]
                                      },
                                      "type": "If"
                                    },
                                    "device_actions_UPDATE_POLICY": {
                                      "type": "ApiConnection",
                                      "inputs": {
                                        "body": {
                                          "action_type": "UPDATE_POLICY",
                                          "device_id": [
                                            "@{outputs('Device_id')}"
                                          ],
                                          "options": {
                                            "policy_id": "@{variables('PredefinedPolicy')}"
                                          }
                                        },
                                        "headers": {
                                          "Content-Type": "application/json"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['CarbonBlackCloudConnector']['connectionId']"
                                          }
                                        },
                                        "method": "post",
                                        "path": "/appservices/v6/orgs/@{encodeURIComponent(variables('OrganizationKey'))}/device_actions"
                                      }
                                    }
                                  }
                                }
                              },
                              "expression": "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response')?['data'][outputs('SOC_Action')]",
                              "type": "Switch"
                            }
                          },
                          "runAfter": {
                            "SOC_Action": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "Append_-_No_action_required": {
                                "type": "AppendToArrayVariable",
                                "inputs": {
                                  "name": "ActionSummary",
                                  "value": {
                                    "action": "No action is required",
                                    "device": "@outputs('Device_id')",
                                    "statuscode": "204"
                                  }
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@length(body('Filter_the_action_needed_device'))",
                                  0
                                ]
                              },
                              {
                                "not": {
                                  "equals": [
                                    "@toLower(body('Filter_each_device_information')?[0]?['os'])",
                                    "linux"
                                  ]
                                }
                              }
                            ]
                          },
                          "type": "If",
                          "description": "Condition to check the device that needs SOC action"
                        },
                        "Device_id": {
                          "type": "Compose",
                          "inputs": "@item()",
                          "description": "Compose device name"
                        },
                        "Filter_each_device_information": {
                          "runAfter": {
                            "Device_id": [
                              "Succeeded"
                            ]
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@variables('CarbonBlackDeviceInfo')",
                            "where": "@equals(item()?['id'], outputs('Device_id'))"
                          },
                          "description": "Filter device information returned from carbon black cloud"
                        },
                        "Filter_the_action_needed_device": {
                          "runAfter": {
                            "Filter_each_device_information": [
                              "Succeeded"
                            ]
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@variables('DevicesActionNeeded')",
                            "where": "@equals(item(), outputs('Device_id'))"
                          },
                          "description": "Filter the action needed device"
                        },
                        "SOC_Action": {
                          "runAfter": {
                            "Filter_the_action_needed_device": [
                              "Succeeded"
                            ]
                          },
                          "type": "Compose",
                          "inputs": "@string(outputs('Device_id'))"
                        }
                      },
                      "runAfter": {
                        "Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    },
                    "For_each_incident_configuration": {
                      "foreach": "@outputs('Compose_incident_configuration')",
                      "actions": {
                        "Append_incident_configuration_to_adaptive_card_body": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "AdaptivecardBody",
                            "value": "@item()"
                          },
                          "description": "Append each incident configuration item to adaptive card body"
                        }
                      },
                      "runAfter": {
                        "Compose_incident_configuration": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    },
                    "Incident_hosts": {
                      "runAfter": {
                        "Adaptive_card_body": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Hosts",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "description": "Variable to store the hosts information"
                    },
                    "Organization_Id": {
                      "runAfter": {
                        "Predefined_PolicyId": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "OrganizationKey",
                            "type": "string",
                            "value": "[[parameters('OrganizationKey')]"
                          }
                        ]
                      },
                      "description": "Configured Organization Id"
                    },
                    "Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response": {
                      "runAfter": {
                        "Compose_adaptive_card_body": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "body": {
                            "messageBody": "{\n    \"type\": \"AdaptiveCard\",\n    \"body\": @{outputs('Compose_adaptive_card_body')},\n     \"width\":\"auto\",\n   \"actions\": [\n                    {\n                        \"type\": \"Action.Submit\",\n                        \"title\": \"Submit\"\n                    },\n                  {\n                        \"type\": \"Action.Submit\",\n                        \"title\": \"Ignore\"\n                    }\n   ],\n    \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n    \"version\": \"1.2\"\n}",
                            "recipient": {
                              "channelId": "[[parameters('Teams ChannelId')]"
                            },
                            "shouldUpdateCard": true
                          },
                          "notificationUrl": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['teams']['connectionId']"
                          }
                        },
                        "path": "/flowbot/actions/flowcontinuation/recipienttypes/channel/$subscriptions",
                        "queries": {
                          "groupId": "[[parameters('Teams GroupId')]"
                        }
                      }
                    },
                    "Post_your_own_adaptive_card_as_the_Flow_bot_to_a_channel": {
                      "runAfter": {
                        "Condition_to_check_the_summary_action_Ignore_or_Submit": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "messageBody": "{\n    \"type\": \"AdaptiveCard\",\n    \"body\": [\n  {\n    \"size\": \"large\",\n    \"text\": \"Suspicious Device - Microsoft Sentinel\",\n    \"type\": \"TextBlock\",\n    \"weight\": \"bolder\",\n    \"wrap\": true\n  },\n  {\n    \"text\": \"Possible comprised device detected by the provider :  @{outputs('Compose_product_name')}\",\n    \"type\": \"TextBlock\",\n    \"wrap\": true\n  },\n  {\n    \"text\": \" @{triggerBody()?['object']?['properties']?['severity']} Incident - Carbon Black Device Actions \",\n    \"type\": \"TextBlock\",\n    \"weight\": \"Bolder\",\n    \"wrap\": true\n  },\n  {\n    \"text\": \" Incident No: @{triggerBody()?['object']?['properties']?['incidentNumber']}  \",\n    \"type\": \"TextBlock\",\n    \"weight\": \"Bolder\",\n    \"wrap\": true\n  },\n  {\n    \"text\": \"Incident description\",\n    \"type\": \"TextBlock\",\n    \"weight\": \"Bolder\",\n    \"wrap\": true\n  },\n  {\n    \"text\": \"@{triggerBody()?['object']?['properties']?['description']}\",\n    \"type\": \"TextBlock\",\n    \"wrap\": true\n  },\n  {\n    \"text\": \"[Click here to view the Incident](@{triggerBody()?['object']?['properties']?['incidentUrl']})\",\n    \"type\": \"TextBlock\",\n    \"wrap\": true\n  },\n        {\n            \"type\": \"TextBlock\",\n           \n            \"weight\": \"Bolder\",\n            \"text\": \"Below is the summary of actions taken on Devices by SOC\",\n            \"wrap\": true\n        },\n    {\n  \"columns\": [\n    {\n      \"items\": @{body('Select_action_summary')},\n      \"type\": \"Column\",\n      \"wrap\": true\n    }\n  ],\n  \"separator\": \"true\",\n  \"type\": \"ColumnSet\",\n  \"width\": \"stretch\"\n}\n ],\n\"width\":\"auto\",\n \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n \"version\": \"1.2\"\n}",
                          "recipient": {
                            "channelId": "[[parameters('Teams ChannelId')]"
                          }
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['teams']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/flowbot/actions/adaptivecard/recipienttypes/channel",
                        "queries": {
                          "groupId": "[[parameters('Teams GroupId')]"
                        }
                      }
                    },
                    "Predefined_PolicyId": {
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "PredefinedPolicy",
                            "type": "integer",
                            "value": "[[parameters('PolicyId')]"
                          }
                        ]
                      },
                      "description": "Variable to store the predefined PolicyId"
                    },
                    "Select_action_summary": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "Select",
                      "inputs": {
                        "from": "@variables('ActionSummary')",
                        "select": {
                          "text": "DeviceId : @{item()?['device']}     Action: @{item()?['action']}  StatusCode: @{item()?['statuscode']}",
                          "type": "TextBlock",
                          "wrap": "true"
                        }
                      }
                    },
                    "Select_alert_product_names": {
                      "runAfter": {
                        "Devices_action_needed": [
                          "Succeeded"
                        ]
                      },
                      "type": "Select",
                      "inputs": {
                        "from": "@triggerBody()?['object']?['properties']?['additionalData']?['alertProductNames']",
                        "select": {
                          "text": "@item()"
                        }
                      },
                      "description": "data operator to select the alert product name"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "CarbonBlackCloudConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('CarbonBlackConnectionName'))]",
                        "connectionName": "[[variables('CarbonBlackConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]"
                      },
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "teams": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                        "connectionName": "[[variables('TeamsConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "VMware Carbon Black Cloud",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft",
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_CarbonBlackConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Endpoint take action from Teams - Carbon Black",
            "description": "This playbook sends an adaptive card to the SOC Teams channel, lets the analyst decide on action: Quarantine the device or Update the policy. It posts a comment on the incident with the information collected from the Carbon Black and summary of the actions taken, and closes the incident if required.",
            "mainSteps": [
              "When a new Sentinel incident is created,this playbook gets triggered and performs below actions: \n\n 1. Fetches the devices information from CarbonBlack \n\n 2. Sends an adaptive card to the SOC Teams channel, let the analyst decide on action: Quarantine the device or Update the policy based on SOC action \n\n ![card example](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/CarbonBlack/Playbooks/CarbonBlack-TakeDeviceActionFromTeams/images/adaptiveCard.png?raw=true) \n\n 3. Add a comment to the incident with the information collected from the carbon black, summary of the actions taken and close the incident ![Comment example](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/CarbonBlack/Playbooks/CarbonBlack-TakeDeviceActionFromTeams/images/Incident_Comment.png?raw=true)"
            ],
            "prerequisites": [
              "1. CarbonBlack Custom Connector needs to be deployed prior to the deployment of this playbook under the same subscription. \n\n 2. Generate an API key.Refer this link [ how to generate the API Key](https://developer.carbonblack.com/reference/carbon-black-cloud/authentication/#creating-an-api-key) \n\n 3. Find Organization key by referring this link [ Find Organization key by referring this link ](https://developer.carbonblack.com/reference/carbon-black-cloud/authentication/#creating-an-api-key)"
            ],
            "lastUpdateTime": "2022-07-29T00:00:00Z",
            "postDeployment": [
              "** Authorize connections ** \n\n Once deployment is complete, you will need to authorize each connection. \n\n 1. Click the Microsoft Sentinel connection resource \n\n 2. Click edit API connection \n\n 3. Click Authorize \n\n 4. Sign in \n\n 5. Click Save \n\n 6. Repeat step 2&3 while for CarbonBlack connector Connection to authorize connector API of the playbook (For authorizing the CarbonBlack API connection, API Key needs to be provided. API Key Value is the combination of API Key / API ID) \n\n ** Configurations in Sentinel ** \n\n 1. In Microsoft Sentinel analytical rules should be configured to trigger an incident with risky device \n\n 2. Configure the automation rules to trigger this playbook"
            ],
            "entities": [
              "Host"
            ],
            "tags": [
              "Remediation",
              "Response from teams"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Endpoint take action from Teams - Carbon Black",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "IsolateEndpoint-CarbonBlack playbook",
        "displayName": "IsolateEndpoint-CarbonBlack playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName3'),'/',variables('playbookVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "IsolateEndpoint-CarbonBlack Playbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "IsolateEndpoint-CarbonBlack",
              "type": "string",
              "metadata": {
                "description": "Name of the Logic Apps resource to be created"
              }
            },
            "CustomConnectorName": {
              "defaultValue": "CarbonBlackCloudConnector",
              "type": "string",
              "metadata": {
                "description": "Name of the custom connector which interacts with Carbon Black"
              }
            },
            "OrganizationKey": {
              "defaultValue": "OrganizationKey",
              "type": "string",
              "metadata": {
                "description": "CarbonBlack Org Key"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "CarbonBlackConnectionName": "[[concat('CarbonBlackCloudConnector-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('CarbonBlackConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('CarbonBlackConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "tags": {
                "hidden-SentinelTemplateName": "IsolateEndpoint-CarbonBlack",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered_(Private_Preview_only)": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Add_comment_to_incident_(V3)": {
                      "runAfter": {
                        "Compose": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "message": "<p><strong></strong><strong>@{outputs('Compose')}</strong><strong> &nbsp;</strong><span style=\"font-size: 16px\"><strong>CarbonBlack QuarantineDevice Playbook</strong></span><strong><br>\n<br>\nCarbonBlack QuarantineDevice playbook was triggered and collected the following information from Carbon Black:<br>\n<br>\n</strong><strong>@{body('Create_HTML_table_-_Carbon_Black')}</strong><strong><br>\n<br>\nDevices that were quarantined by this playbook:<br>\n<br>\n</strong><strong>@{body('Create_HTML_table_-_Quarantined_devices')}</strong><strong></strong></p>"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/Incidents/Comment"
                      }
                    },
                    "Carbon_black_information": {
                      "runAfter": {
                        "Organization_Id": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "CarbonblackInformation",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "description": "Variable to store the devices information returned from carbon black cloud"
                    },
                    "Compose": {
                      "runAfter": {
                        "Create_HTML_table_-_Quarantined_devices": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "<img src=\"https://avatars.githubusercontent.com/u/2071378?s=280&v=4\" alt=\"Lamp\" width=\"32\" height=\"32\">"
                    },
                    "Condition_to_check_the_devices_that_failed_for_quarantine": {
                      "actions": {
                        "Update_incident": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "classification": {
                                "ClassificationAndReason": "True Positive - Suspicious Activity"
                              },
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "severity": "@triggerBody()?['object']?['properties']?['severity']",
                              "status": "Closed"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Incidents"
                          }
                        }
                      },
                      "runAfter": {
                        "Add_comment_to_incident_(V3)": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "equals": [
                              "@length(variables('FailedforQuarantine'))",
                              0
                            ]
                          }
                        ]
                      },
                      "type": "If",
                      "description": "Close the incident if there are no devices that failed for quarantine"
                    },
                    "Create_HTML_table_-_Carbon_Black": {
                      "runAfter": {
                        "For_each_hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "columns": [
                          {
                            "header": "Devicename",
                            "value": "@item()?['name']"
                          },
                          {
                            "header": "Quarantined",
                            "value": "@item()?['quarantined']"
                          },
                          {
                            "header": "Policyname",
                            "value": "@item()?['policy_name']"
                          },
                          {
                            "header": "PolicyId",
                            "value": "@item()?['policy_id']"
                          },
                          {
                            "header": "DeviceownerId",
                            "value": "@item()?['device_owner_id']"
                          },
                          {
                            "header": "DeviceId",
                            "value": "@item()?['id']"
                          },
                          {
                            "header": "Devicestatus",
                            "value": "@item()?['status']"
                          },
                          {
                            "header": "Operatingsystem",
                            "value": "@item()?['os']"
                          },
                          {
                            "header": "OperatingsystemVersion",
                            "value": "@item()?['os_version']"
                          },
                          {
                            "header": "Organizationname",
                            "value": "@item()?['organization_name']"
                          },
                          {
                            "header": "Email",
                            "value": "@item()?['email']"
                          },
                          {
                            "header": "Sensorstates",
                            "value": "@join(item()?['sensor_states'],',')"
                          },
                          {
                            "header": "LastreportedTime",
                            "value": "@item()?['last_reported_time']"
                          },
                          {
                            "header": "SensorVersion",
                            "value": "@{item()?['sensor_version']}"
                          }
                        ],
                        "format": "HTML",
                        "from": "@variables('CarbonblackInformation')"
                      }
                    },
                    "Create_HTML_table_-_Quarantined_devices": {
                      "runAfter": {
                        "Create_HTML_table_-_Carbon_Black": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "columns": [
                          {
                            "header": "DeviceId",
                            "value": "@item()?['id']"
                          },
                          {
                            "header": "Devicename",
                            "value": "@item()?['name']"
                          },
                          {
                            "header": "Action",
                            "value": "@item()?['Action']"
                          }
                        ],
                        "format": "HTML",
                        "from": "@variables('ActiontakendDevices')"
                      }
                    },
                    "Entities_-_Get_Hosts": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      }
                    },
                    "Failed_for_Quarantine": {
                      "runAfter": {
                        "Quarantined_devices": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "FailedforQuarantine",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "description": "Variable to store the devices information that failed for Quarantine"
                    },
                    "For_each_hosts": {
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "actions": {
                        "Condition": {
                          "actions": {
                            "For_each_results": {
                              "foreach": "@body('Search_devices_in_your_organization')?['results']",
                              "actions": {
                                "Condition_to_check_the_device_is_in_quarantine": {
                                  "actions": {
                                    "Condition_to_check_the_success_status_codes": {
                                      "actions": {
                                        "Condition_to_check_the_search_devices_returned_the_results": {
                                          "actions": {
                                            "For_each_search_results": {
                                              "foreach": "@body('Search_devices_in_your_organization_based_on_device_name')?['results']",
                                              "actions": {
                                                "Append_to_device_information": {
                                                  "type": "AppendToArrayVariable",
                                                  "inputs": {
                                                    "name": "CarbonblackInformation",
                                                    "value": "@item()"
                                                  },
                                                  "description": "Append device information that returned from carbon black"
                                                }
                                              },
                                              "type": "Foreach"
                                            }
                                          },
                                          "runAfter": {
                                            "Search_devices_in_your_organization_based_on_device_name": [
                                              "Succeeded"
                                            ]
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "greater": [
                                                  "@body('Search_devices_in_your_organization_based_on_device_name')?['num_found']",
                                                  0
                                                ]
                                              }
                                            ]
                                          },
                                          "type": "If"
                                        },
                                        "Search_devices_in_your_organization_based_on_device_name": {
                                          "runAfter": {
                                            "Store_devices_information_-_Quarantined": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "ApiConnection",
                                          "inputs": {
                                            "body": {
                                              "query": "name : @{items('For_each_hosts')?['HostName']}"
                                            },
                                            "headers": {
                                              "Content-Type": "application/json"
                                            },
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['CarbonBlackCloudConnector']['connectionId']"
                                              }
                                            },
                                            "method": "post",
                                            "path": "/appservices/v6/orgs/@{encodeURIComponent(variables('OrganizationKey'))}/devices/_search"
                                          }
                                        },
                                        "Store_devices_information_-_Quarantined": {
                                          "type": "AppendToArrayVariable",
                                          "inputs": {
                                            "name": "ActiontakendDevices",
                                            "value": {
                                              "Action": "This device was quarantined successfully",
                                              "id": "@items('For_each_results')?['id']",
                                              "name": "@items('For_each_results')?['name']"
                                            }
                                          },
                                          "description": "Append each devices that quarantined"
                                        }
                                      },
                                      "runAfter": {
                                        "device_actions": [
                                          "Succeeded"
                                        ]
                                      },
                                      "else": {
                                        "actions": {
                                          "Append_carbon_black_information_-_device_id_in_Quarantine": {
                                            "type": "AppendToArrayVariable",
                                            "inputs": {
                                              "name": "CarbonblackInformation",
                                              "value": "@item()"
                                            },
                                            "description": "Append device information that returned from carbon black"
                                          },
                                          "Devices_that_Failed_for_quarantined": {
                                            "runAfter": {
                                              "Append_carbon_black_information_-_device_id_in_Quarantine": [
                                                "Succeeded"
                                              ]
                                            },
                                            "type": "AppendToArrayVariable",
                                            "inputs": {
                                              "name": "FailedforQuarantine",
                                              "value": "@item()"
                                            },
                                            "description": "Variable to store the devices that failed to set the devices in quarantine"
                                          }
                                        }
                                      },
                                      "expression": {
                                        "or": [
                                          {
                                            "equals": [
                                              "@outputs('device_actions')?['statusCode']",
                                              200
                                            ]
                                          },
                                          {
                                            "equals": [
                                              "@outputs('device_actions')?['statusCode']",
                                              204
                                            ]
                                          }
                                        ]
                                      },
                                      "type": "If"
                                    },
                                    "device_actions": {
                                      "type": "ApiConnection",
                                      "inputs": {
                                        "body": {
                                          "action_type": "QUARANTINE",
                                          "device_id": [
                                            "@{items('For_each_results')?['id']}"
                                          ],
                                          "options": {
                                            "toggle": "ON"
                                          }
                                        },
                                        "headers": {
                                          "Content-Type": "application/json"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['CarbonBlackCloudConnector']['connectionId']"
                                          }
                                        },
                                        "method": "post",
                                        "path": "/appservices/v6/orgs/@{encodeURIComponent(variables('OrganizationKey'))}/device_actions"
                                      }
                                    }
                                  },
                                  "else": {
                                    "actions": {
                                      "Append_to_array_variable": {
                                        "type": "AppendToArrayVariable",
                                        "inputs": {
                                          "name": "CarbonblackInformation",
                                          "value": "@item()"
                                        }
                                      },
                                      "Condition_to_check_the_device_OS": {
                                        "actions": {
                                          "Store_devices_information_-_Linux": {
                                            "type": "AppendToArrayVariable",
                                            "inputs": {
                                              "name": "ActiontakendDevices",
                                              "value": {
                                                "Action": "Not supported on devices of OS type Linux",
                                                "id": "@items('For_each_results')?['id']",
                                                "name": "@items('For_each_results')?['name']"
                                              }
                                            },
                                            "description": "Quarantined is not supported for Linux OS"
                                          }
                                        },
                                        "runAfter": {
                                          "Append_to_array_variable": [
                                            "Succeeded"
                                          ]
                                        },
                                        "expression": {
                                          "and": [
                                            {
                                              "equals": [
                                                "@toLower(item()?['os'])",
                                                "linux"
                                              ]
                                            }
                                          ]
                                        },
                                        "type": "If"
                                      }
                                    }
                                  },
                                  "expression": {
                                    "and": [
                                      {
                                        "equals": [
                                          "@items('For_each_results')?['quarantined']",
                                          false
                                        ]
                                      },
                                      {
                                        "not": {
                                          "equals": [
                                            "@toLower(item()?['os'])",
                                            "linux"
                                          ]
                                        }
                                      }
                                    ]
                                  },
                                  "type": "If"
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Search_devices_in_your_organization": [
                              "Succeeded"
                            ]
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@body('Search_devices_in_your_organization')?['num_found']",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Search_devices_in_your_organization": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "query": "name : @{items('For_each_hosts')?['HostName']}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['CarbonBlackCloudConnector']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/appservices/v6/orgs/@{encodeURIComponent(variables('OrganizationKey'))}/devices/_search"
                          }
                        }
                      },
                      "runAfter": {
                        "Failed_for_Quarantine": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    },
                    "Organization_Id": {
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "OrganizationKey",
                            "type": "string",
                            "value": "[[parameters('OrganizationKey')]"
                          }
                        ]
                      },
                      "description": "Pre-configured Organization Id"
                    },
                    "Quarantined_devices": {
                      "runAfter": {
                        "Carbon_black_information": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "ActiontakendDevices",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "description": "Variable to store the quarantined devices information"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "CarbonBlackCloudConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('CarbonBlackConnectionName'))]",
                        "connectionName": "[[variables('CarbonBlackConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]"
                      },
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "VMware Carbon Black Cloud",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft",
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_CarbonBlackConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Isolate endpoint - Carbon Black",
            "description": "This playbook will quarantine the host in Carbon Black.",
            "mainSteps": [
              "When a new Sentinel incident is created,this playbook gets triggered and performs below actions: \n\n 1. Fetches the devices information from CarbonBlack \n\n 2. Quarantine the device \n\n 3. Enrich the incident with device information by fetching from CarbonBlack \n\n ![CarbonBlack-Enrich Incident With devices information](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/CarbonBlack/Playbooks/CarbonBlack-QuarantineDevice/images/Incident_Comment.png?raw=true) \n\n ![CarbonBlack-Enrich Incident With devices information](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/CarbonBlack/Playbooks/CarbonBlack-QuarantineDevice/images/designerOverviewLight1.png?raw=true) \n\n ![CarbonBlack-Enrich Incident With devices information](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/CarbonBlack/Playbooks/CarbonBlack-QuarantineDevice/images/designerOverviewLight2.png?raw=true)"
            ],
            "prerequisites": [
              "1. CarbonBlack Custom Connector needs to be deployed prior to the deployment of this playbook under the same subscription. \n\n 2. Generate an API key.Refer this link [ how to generate the API Key](https://developer.carbonblack.com/reference/carbon-black-cloud/authentication/#creating-an-api-key) \n\n 3. Find Organization key by referring this link [ Find Organization key by referring this link ](https://developer.carbonblack.com/reference/carbon-black-cloud/authentication/#creating-an-api-key)"
            ],
            "lastUpdateTime": "2022-07-29T00:00:00Z",
            "entities": [
              "Host"
            ],
            "tags": [
              "Remediation"
            ],
            "postDeployment": [
              "** Authorize connections ** \n\n Once deployment is complete, you will need to authorize each connection. \n\n 1. Click the Microsoft Sentinel connection resource \n\n 2. Click edit API connection \n\n 3. Click Authorize \n\n 4. Sign in \n\n 5. Click Save \n\n 6. Repeat step 2&3 while for CarbonBlack connector Connection to authorize connector API of the playbook (For authorizing the CarbonBlack API connection, API Key needs to be provided. API Key Value is the combination of API Key / API ID) \n\n ** Configurations in Sentinel ** \n\n 1. In Microsoft Sentinel analytical rules should be configured to trigger an incident with risky device \n\n 2. Configure the automation rules to trigger this playbook \n\n [![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FAzure-Sentinel%2Fmaster%2FSolutions%2FCarbonBlack%2FPlaybooks%2FCarbonBlack-QuarantineDevice%2Fazuredeploy.json) \n\n [![Deploy to Azure](https://aka.ms/deploytoazuregovbutton)](https://portal.azure.us/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FAzure-Sentinel%2Fmaster%2FSolutions%2FCarbonBlack%2FPlaybooks%2FCarbonBlack-QuarantineDevice%2Fazuredeploy.json)"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Isolate endpoint - Carbon Black",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "EndpointEnrichment-CarbonBlack playbook",
        "displayName": "EndpointEnrichment-CarbonBlack playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName4'),'/',variables('playbookVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "EndpointEnrichment-CarbonBlack Playbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "EndpointEnrichment-CarbonBlack",
              "type": "string",
              "metadata": {
                "description": "Name of the Logic Apps resource to be created"
              }
            },
            "CustomConnectorName": {
              "defaultValue": "CarbonBlackCloudConnector",
              "type": "string",
              "metadata": {
                "description": "Name of the custom connector which interacts with Carbon Black"
              }
            },
            "OrganizationKey": {
              "defaultValue": "OrganizationKey",
              "type": "string",
              "metadata": {
                "description": "CarbonBlack Org Key"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "CarbonBlackConnectionName": "[[concat('CarbonBlackCloudConnector-', parameters('PlaybookName'))]",
            "TeamsConnectionName": "[[concat('teamsconnector-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('CarbonBlackConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('CarbonBlackConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "tags": {
                "hidden-SentinelTemplateName": "EndpointEnrichment-CarbonBlack",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered_(Private_Preview_only)": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Add_comment_to_incident_(V3)": {
                      "runAfter": {
                        "Compose": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "message": "<p>@{outputs('Compose')} &nbsp;<span style=\"font-size: 16px\"><strong>CarbonBlack DeviceEnrichment Playbook<br>\n</strong></span><span style=\"font-size: 16px\">CarbonBlack DeviceEnrichment playbook was triggered and collected the following information from Carbon Black:<br>\n<br>\n</span><span style=\"font-size: 16px\">@{body('Create_HTML_table_to_format_the_results_returned')}</span><span style=\"font-size: 16px\"></span></p>"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/Incidents/Comment"
                      }
                    },
                    "Append_Hosts_list": {
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "HostsList",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "description": "Variable to append all the hosts returned from provider"
                    },
                    "Compose": {
                      "runAfter": {
                        "Create_HTML_table_to_format_the_results_returned": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "<img src=\"https://avatars.githubusercontent.com/u/2071378?s=280&v=4\" alt=\"Lamp\" width=\"32\" height=\"32\">"
                    },
                    "Create_HTML_table_to_format_the_results_returned": {
                      "runAfter": {
                        "Search_devices_in_your_organization": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "columns": [
                          {
                            "header": "Devicename",
                            "value": "@item()?['name']"
                          },
                          {
                            "header": "Quarantined",
                            "value": "@item()?['quarantined']"
                          },
                          {
                            "header": "Policyname",
                            "value": "@item()?['policy_name']"
                          },
                          {
                            "header": "PolicyId",
                            "value": "@item()?['policy_id']"
                          },
                          {
                            "header": "DeviceownerId",
                            "value": "@item()?['device_owner_id']"
                          },
                          {
                            "header": "DeviceId",
                            "value": "@item()?['id']"
                          },
                          {
                            "header": "Devicestatus",
                            "value": "@item()?['status']"
                          },
                          {
                            "header": "Operatingsystem",
                            "value": "@item()?['os']"
                          },
                          {
                            "header": "OperatingsystemVersion",
                            "value": "@item()?['os_version']"
                          },
                          {
                            "header": "Organizationname",
                            "value": "@item()?['organization_name']"
                          },
                          {
                            "header": "Email",
                            "value": "@item()?['email']"
                          },
                          {
                            "header": "Sensorstates",
                            "value": "@join(item()?['sensor_states'],',')"
                          },
                          {
                            "header": "LastreportedTime",
                            "value": "@item()?['last_reported_time']"
                          },
                          {
                            "header": "SensorVersion",
                            "value": "@{item()?['sensor_version']}"
                          }
                        ],
                        "format": "HTML",
                        "from": "@body('Search_devices_in_your_organization')?['results']"
                      },
                      "description": "Format the device information"
                    },
                    "Entities_-_Get_Hosts": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      }
                    },
                    "For_each_Hosts": {
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "actions": {
                        "Append_hosts_to_format_the_Lucense_query": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "HostsList",
                            "value": "name : @{items('For_each_Hosts')?['HostName']}"
                          }
                        }
                      },
                      "runAfter": {
                        "Organization_Id": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "description": "Iterate over hosts returned from provider"
                    },
                    "Join_Hosts_with_OR_operator": {
                      "runAfter": {
                        "For_each_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "Join",
                      "inputs": {
                        "from": "@variables('HostsList')",
                        "joinWith": " OR "
                      },
                      "description": "Format the Lucense query to pass as a parameter to the search organizations in your organization"
                    },
                    "Organization_Id": {
                      "runAfter": {
                        "Append_Hosts_list": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "OrganizationKey",
                            "type": "string",
                            "value": "[[parameters('OrganizationKey')]"
                          }
                        ]
                      },
                      "description": "Configured Organization Id"
                    },
                    "Search_devices_in_your_organization": {
                      "runAfter": {
                        "Join_Hosts_with_OR_operator": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "query": "@body('Join_Hosts_with_OR_operator')"
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['CarbonBlackCloudConnector']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/appservices/v6/orgs/@{encodeURIComponent(variables('OrganizationKey'))}/devices/_search"
                      },
                      "description": "Search devices in organization by providing filter criteria"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "CarbonBlackCloudConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('CarbonBlackConnectionName'))]",
                        "connectionName": "[[variables('CarbonBlackConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('CustomConnectorName'))]"
                      },
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "VMware Carbon Black Cloud",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft",
                  "tier": "Microsoft",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_CarbonBlackConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Endpoint enrichment - Carbon Black",
            "description": "This playbook will collect device information from Carbon Black and post a report on the incident.",
            "prerequisites": [
              "1. CarbonBlack Custom Connector needs to be deployed prior to the deployment of this playbook under the same subscription.\n\n 2. Generate an API key.Refer this link [ how to generate the API Key](https://developer.carbonblack.com/reference/carbon-black-cloud/authentication/#creating-an-api-key) \n\n 3. Find Organization key by referring this link [ Find Organization key by referring this link ](https://developer.carbonblack.com/reference/carbon-black-cloud/authentication/#creating-an-api-key)"
            ],
            "lastUpdateTime": "2022-07-29T00:00:00Z",
            "mainSteps": [
              "When a new Sentinel incident is created,this playbook gets triggered and performs below actions \n\n 1. Fetches the devices information from CarbonBlack \n\n 2. Enrich the incident with device information by adding a comment to the incident \n\n ![Comment example](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/CarbonBlack/Playbooks/CarbonBlack-DeviceEnrichment/images/Incident_Comment.PNG?raw=true) \n\n ![CarbonBlack-Enrich Incident With devices information](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/CarbonBlack/Playbooks/CarbonBlack-DeviceEnrichment/images/designerOverviewLight.png?raw=true)"
            ],
            "entities": [
              "Host"
            ],
            "tags": [
              "Enrichment"
            ],
            "postDeployment": [
              "** Authorize connections ** \n\n Once deployment is complete, you will need to authorize each connection. \n\n 1. Click the Microsoft Sentinel connection resource \n\n 2. Click edit API connection \n\n 3. Click Authorize \n\n 4. Sign in \n\n 5. Click Save \n\n 6. Repeat step 2&3 while for CarbonBlack connector Connection to authorize connector API of the playbook (For authorizing the CarbonBlack API connection, API Key needs to be provided. API Key Value is the combination of API Key / API ID) \n\n ** Configurations in Sentinel ** \n\n 1. In Microsoft Sentinel analytical rules should be configured to trigger an incident with risky device \n\n 2. Configure the automation rules to trigger this playbook"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Endpoint enrichment - Carbon Black",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "2.0.2",
        "kind": "Solution",
        "contentSchemaVersion": "2.0.0",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "VMware Carbon Black Cloud",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId1')]",
              "version": "[variables('analyticRuleVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId2')]",
              "version": "[variables('analyticRuleVersion2')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "LogicAppsCustomConnector",
              "contentId": "[variables('_CarbonBlackConnector')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CarbonBlack-TakeDeviceActionFromTeams')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CarbonBlack-QuarantineDevice')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CarbonBlack-DeviceEnrichment')]",
              "version": "[variables('playbookVersion4')]"
            }
          ]
        },
        "firstPublishDate": "2022-06-01",
        "providers": [
          "VMware"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
