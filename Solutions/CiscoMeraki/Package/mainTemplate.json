{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for CiscoMeraki"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "CiscoMerakiWorkbook",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "_solutionName": "CiscoMeraki",
    "_solutionVersion": "3.0.1",
    "solutionId": "azuresentinel.azure-sentinel-solution-ciscomeraki",
    "_solutionId": "[variables('solutionId')]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "CiscoMerakiWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))),variables('workbookVersion1')))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "uiConfigId1": "CiscoMeraki",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "CiscoMeraki",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1'))),variables('dataConnectorVersion1')))]",
    "dataConnectorVersion1": "1.0.0",
    "_dataConnectorcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentId1'),'-', variables('dataConnectorVersion1'))))]",
    "parserName1": "Cisco Meraki Data Parser",
    "_parserName1": "[concat(parameters('workspace'),'/',variables('parserName1'))]",
    "parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
    "_parserId1": "[variables('parserId1')]",
    "parserTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pr-',uniquestring(variables('_parserContentId1'))),variables('parserVersion1')))]",
    "parserVersion1": "1.0.0",
    "parserContentId1": "CiscoMeraki-Parser",
    "_parserContentId1": "[variables('parserContentId1')]",
    "_parsercontentProductId1": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('_parserContentId1'),'-', variables('parserVersion1'))))]",
    "MerakiConnector": "MerakiConnector",
    "_MerakiConnector": "[variables('MerakiConnector')]",
    "TemplateEmptyArray": "[json('[]')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "MerakiConnector",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-lc-',uniquestring(variables('_playbookContentId1'))),variables('playbookVersion1')))]",
    "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','lc','-', uniqueString(concat(variables('_solutionId'),'-','LogicAppsCustomConnector','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
    "blanks": "[replace('b', 'b', '')]",
    "Block-Device-Client": "Block-Device-Client",
    "_Block-Device-Client": "[variables('Block-Device-Client')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "Block-Device-Client",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))),variables('playbookVersion2')))]",
    "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
    "Block-IP-Address": "Block-IP-Address",
    "_Block-IP-Address": "[variables('Block-IP-Address')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "Block-IP-Address",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3'))),variables('playbookVersion3')))]",
    "_playbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId3'),'-', variables('playbookVersion3'))))]",
    "Block-URL": "Block-URL",
    "_Block-URL": "[variables('Block-URL')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "Block-URL",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4'))),variables('playbookVersion4')))]",
    "_playbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId4'),'-', variables('playbookVersion4'))))]",
    "IP-Address-Enrichment": "IP-Address-Enrichment",
    "_IP-Address-Enrichment": "[variables('IP-Address-Enrichment')]",
    "playbookVersion5": "1.0",
    "playbookContentId5": "IP-Address-Enrichment",
    "_playbookContentId5": "[variables('playbookContentId5')]",
    "playbookId5": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId5'))]",
    "playbookTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId5'))),variables('playbookVersion5')))]",
    "_playbookcontentProductId5": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId5'),'-', variables('playbookVersion5'))))]",
    "URL-Enrichment": "URL-Enrichment",
    "_URL-Enrichment": "[variables('URL-Enrichment')]",
    "playbookVersion6": "1.0",
    "playbookContentId6": "URL-Enrichment",
    "_playbookContentId6": "[variables('playbookContentId6')]",
    "playbookId6": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId6'))]",
    "playbookTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId6'))),variables('playbookVersion6')))]",
    "_playbookcontentProductId6": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId6'),'-', variables('playbookVersion6'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CiscoMerakiWorkbookWorkbook Workbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Gain insights into the Events from Cisco Meraki Solution and analyzing all the different types of Security Events. This workbook also helps in identifying the Events from affected devices, IPs and the nodes where malware was successfully detected.\nIP data received in Events is correlated with Threat Intelligence to identify if the reported IP address is known bad based on threat intelligence data."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Cisco Meraki\"},\"name\":\"textWorkbookTitle\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"c3f513c2-4160-4261-9ac0-d98aa05599bd\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"label\":\"Subscription Name\",\"type\":6,\"description\":\"Select the Subscription Name that will be used for the queries\",\"isRequired\":true,\"typeSettings\":{\"includeAll\":true,\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"d13a868b-818e-483a-b601-81ff9bee3097\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"description\":\"Select the Workspce Name that will be used for the queries.\",\"isRequired\":true,\"typeSettings\":{\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"1e854ea2-2ffd-4cb0-a63b-e941b422f752\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"description\":\"Select the Time Range that will be used for the queries.\",\"isRequired\":true,\"value\":{\"durationMs\":2592000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parametersAllTabs\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"570639ed-d7a3-4fca-86be-4b2b28cf39c1\",\"cellValue\":\"VisibleTabName\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Summary\",\"subTarget\":\"summary\",\"style\":\"link\"},{\"id\":\"79a2acf6-7858-4a8d-ad27-cf84211b3505\",\"cellValue\":\"VisibleTabName\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Events from Device\",\"subTarget\":\"DeviceThreats\",\"style\":\"link\"},{\"id\":\"f767421e-ac72-46a5-b33a-1ea6bd24db09\",\"cellValue\":\"VisibleTabName\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Events from IP\",\"subTarget\":\"IPThreats\",\"style\":\"link\"},{\"id\":\"7573a16c-8c26-4d4c-9b51-53b527bc4e78\",\"cellValue\":\"VisibleTabName\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Malware Detected\",\"subTarget\":\"MalwareThreats\",\"style\":\"link\"},{\"id\":\"9be11d6c-f6f7-4e9c-b1ba-33b8c377aa37\",\"cellValue\":\"VisibleTabName\",\"linkTarget\":\"parameter\",\"linkLabel\":\"All Events\",\"subTarget\":\"allEvents\",\"style\":\"link\"}]},\"name\":\"tabs\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"4ebf255c-233d-44bc-9cfb-7d21559344fa\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectLogType\",\"label\":\"Log Types\",\"type\":2,\"description\":\"Select the Log Type to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct LogType\\r\\n| extend LogType = iff(isempty(LogType),\\\"empty\\\",LogType)\\r\\n| sort by LogType asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"2158e08c-7ff7-435a-8ab6-d84bac37ca69\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectNetworkDirection\",\"label\":\"Network Direction\",\"type\":2,\"description\":\"Select the Network Direction to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct NetworkDirection\\r\\n| extend NetworkDirection = iif(isempty(NetworkDirection),\\\"empty\\\",NetworkDirection)\\r\\n| order by NetworkDirection asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parametersSummaryTab\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| extend LogType = iif(isempty(LogType),\\\"empty\\\",LogType)\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| extend NetworkDirection = iif(isempty(NetworkDirection),\\\"empty\\\",NetworkDirection)\\r\\n| where NetworkDirection in ('' {SelectNetworkDirection})\\r\\n| make-series Trend = count() default = 0 on TimeGenerated step 1h by LogType\",\"size\":0,\"title\":\"Total Events by Log Type\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"TimeRangeLogType\",\"exportFieldName\":\"LogType\",\"exportParameterName\":\"SelectedLogType\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"chartSettings\":{\"showLegend\":true}},\"customWidth\":\"50\",\"name\":\"timelineLogType\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| where bin(TimeGenerated,1h) {TimeRangeLogType}\\r\\n| extend LogType = iff(isempty(LogType),\\\"empty\\\",LogType)\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| extend NetworkDirection = iif(isempty(NetworkDirection),\\\"empty\\\",NetworkDirection)\\r\\n| where NetworkDirection in ('' {SelectNetworkDirection})\\r\\n| project TimeGenerated, DeviceName, LogType, EventType, SrcIpAddr, SrcPortNumber, SrcMacAddr, DstIpAddr, DstPortNumber, DstMacAddr, HttpRequestMethod, Url,  NetworkProtocol, NetworkDirection\\r\\n| order by TimeGenerated\",\"size\":0,\"title\":\"Total Events by Log Type - Details\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"timelineLogTypeDetails\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| where isnotempty(EventType)\\r\\n| summarize count() by EventType\\r\\n| sort by count_ \",\"size\":0,\"title\":\"Total Events by Event Type\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"EventType\",\"parameterName\":\"EventType\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blueDark\"}}]},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"count_\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"name\":\"topEventType\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki \\r\\n| where LogType in ('' {SelectLogType})\\r\\n| where isnotempty(EventType) and EventType in ('' {EventType:value})\\r\\n| project DeviceName, LogType, EventType, SrcIpAddr, SrcPortNumber, SrcMacAddr, DstIpAddr, DstPortNumber, DstMacAddr\",\"size\":0,\"title\":\"Total Events by Event Type - Details\",\"noDataMessage\":\"Please select Event Type(s) from the left section to view results.\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SyslogMessage_s\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"100ch\"}}]}},\"customWidth\":\"50\",\"name\":\"topEventTypeDetails\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| extend LogType = iif(isempty(LogType),\\\"empty\\\",LogType)\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| extend NetworkDirection = iif(isempty(NetworkDirection),\\\"empty\\\",NetworkDirection)\\r\\n| where NetworkDirection in ('' {SelectNetworkDirection})\\r\\n| make-series Trend = count() default = 0 on TimeGenerated step 1h by NetworkDirection\",\"size\":0,\"title\":\"Total Events by Network Direction\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"TimeRangeNetworkDirection\",\"exportFieldName\":\"LogType\",\"exportParameterName\":\"SelectedLogType\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"chartSettings\":{\"showLegend\":true}},\"customWidth\":\"50\",\"name\":\"timelineNetworkDirection\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| where bin(TimeGenerated,1h) {TimeRangeNetworkDirection}\\r\\n| extend LogType = iif(isempty(LogType),\\\"empty\\\",LogType)\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| extend NetworkDirection = iff(isempty(NetworkDirection),\\\"empty\\\",NetworkDirection)\\r\\n| where NetworkDirection in ('' {SelectNetworkDirection})\\r\\n| project TimeGenerated, DeviceName, LogType, EventType, SrcIpAddr, SrcPortNumber, SrcMacAddr, DstIpAddr, DstPortNumber, DstMacAddr, HttpRequestMethod, Url,NetworkProtocol, NetworkDirection\\r\\n| order by TimeGenerated\\r\\n\",\"size\":0,\"title\":\"Total Events by Network Direction - Details\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"timelineNetworkDirectionDetails\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| extend NetworkProtocol = iff(isempty(NetworkProtocol),\\\"empty\\\",NetworkProtocol)\\r\\n| extend LogType = iif(isempty(LogType),\\\"empty\\\",LogType)\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| extend NetworkDirection = iif(isempty(NetworkDirection),\\\"empty\\\",NetworkDirection)\\r\\n| where NetworkDirection in ('' {SelectNetworkDirection})\\r\\n| summarize count() by NetworkProtocol\",\"size\":2,\"title\":\"Total Events by Network Protocol\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"NetworkProtocol\",\"exportParameterName\":\"SelectedNetworkProtocol\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"eventsNetworkProtocol\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| extend NetworkProtocol = iff(isempty(NetworkProtocol),\\\"empty\\\",NetworkProtocol)\\r\\n| extend LogType = iif(isempty(LogType),\\\"empty\\\",LogType)\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| extend NetworkDirection = iif(isempty(NetworkDirection),\\\"empty\\\",NetworkDirection)\\r\\n| where NetworkDirection in ('' {SelectNetworkDirection})\\r\\n| summarize count() by Action\",\"size\":2,\"title\":\"Total Events by State\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"eventState\"}]},\"conditionalVisibility\":{\"parameterName\":\"VisibleTabName\",\"comparison\":\"isEqualTo\",\"value\":\"summary\"},\"name\":\"summary\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"bdcc13aa-9775-4bb2-9a61-ce37703d57dd\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectLogType\",\"label\":\"Log Types\",\"type\":2,\"description\":\"Select the Log Type to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct LogType\\r\\n| extend LogType = iff(isempty(LogType),\\\"empty\\\",LogType)\\r\\n| sort by LogType asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parametersDeviceEvents\"},{\"type\":1,\"content\":{\"json\":\"Found_in_Threat_Intel correlates SrcIPAddr and DestIPAddr with Threat Intelligence data present in Sentinel. This helps identify new threat intelligence information that you can use to further enhance your overall security posture. \\r\\n\",\"style\":\"info\"},\"showPin\":false,\"name\":\"noteDeviceEvents\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| where isnotempty(DeviceName)\\r\\n| extend LogType = iif(isempty(LogType), \\\"empty\\\", LogType)\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| summarize count() by DeviceName\\r\\n| project-rename Network_Device_name = DeviceName, Events_count = count_\\r\\n| sort by Events_count\",\"size\":0,\"title\":\"Top Affected Network Devices\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"Network_Device_name\",\"parameterName\":\"Network_Device_name\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"Events_count\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"Events_count\",\"sortOrder\":2}],\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Network_Device_name\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Events_count\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"topNetworkDevices\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let maliciousIP = ThreatIntelligenceIndicator | distinct NetworkIP | where isnotempty(NetworkIP);\\r\\nCiscoMeraki\\r\\n| where isnotempty(DeviceName)\\r\\n| extend LogType = iif(isempty(LogType), \\\"empty\\\", LogType)\\r\\n| where DeviceName in ('' {Network_Device_name}) and LogType in ('' {SelectLogType})\\r\\n| project DeviceName, LogType, SrcIpAddr, SrcPortNumber, SrcMacAddr, DstIpAddr, DstPortNumber, DstMacAddr, Action\\r\\n| extend Found_in_Threat_Intel = iif(SrcIpAddr in (maliciousIP) or DstIpAddr in (maliciousIP), \\\"Yes\\\", \\\"No\\\")\\r\\n| project-reorder Found_in_Threat_Intel\\r\\n| order by Found_in_Threat_Intel, LogType\",\"size\":0,\"title\":\"Events from Affected Network Device(s)\",\"noDataMessage\":\"Please select Affected Network Device(s) from the left section to view results.\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"50\",\"name\":\"topNetworkDevicesDetails\"}]},\"conditionalVisibility\":{\"parameterName\":\"VisibleTabName\",\"comparison\":\"isEqualTo\",\"value\":\"DeviceThreats\"},\"name\":\"DeviceThreat\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"0633e46b-060b-4665-99ce-1ff11b892575\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectLogType\",\"label\":\"Log Types\",\"type\":2,\"description\":\"Select the Log Type to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct LogType\\r\\n| extend LogType = iff(isempty(LogType),\\\"empty\\\",LogType)\\r\\n| sort by LogType asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parametersIPEvents\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| where isnotempty(SrcIpAddr)\\r\\n| summarize count() by SrcIpAddr\\r\\n| sort by count_\",\"size\":0,\"title\":\"Top Affected Source IP Addresses\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"SrcIpAddr\",\"parameterName\":\"SrcIpAddr\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blueDark\"}}]}},\"customWidth\":\"30\",\"name\":\"topIPAddress\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| where isnotempty(SrcIpAddr)\\r\\n| where SrcIpAddr in ('' {SrcIpAddr})\\r\\n| project DeviceName, LogType, SrcIpAddr, SrcPortNumber, SrcMacAddr, DstIpAddr, DstPortNumber, DstMacAddr\",\"size\":0,\"title\":\"Events from Affected IP Addresses\",\"noDataMessage\":\"Please select Affected IP(s) from the left section to view results.\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"70\",\"name\":\"topIPAddressDetails\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| where isnotempty(DstIpAddr)\\r\\n| summarize count() by DstIpAddr\\r\\n| sort by count_\",\"size\":0,\"title\":\"Top Affected Destination IP Addresses\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"DstIpAddr\",\"parameterName\":\"DstIpAddr\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blueDark\"}}]}},\"customWidth\":\"30\",\"name\":\"topOutboundDestination\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| where isnotempty(DstIpAddr)\\r\\n| where DstIpAddr in ('' {DstIpAddr})\\r\\n| project DeviceName, LogType, SrcIpAddr, SrcPortNumber, SrcMacAddr, DstIpAddr, DstPortNumber, DstMacAddr\",\"size\":0,\"title\":\"Events from Affected IP Addresses\",\"noDataMessage\":\"Please select Affected Outbound Destination(s) from the left section to view results.\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"70\",\"name\":\"topOutboundDestinationDetails\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| where isnotempty(SrcPortNumber)\\r\\n| summarize count() by SrcPortNumber\\r\\n| sort by count_\",\"size\":0,\"title\":\"Top Events by Source Port\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"SrcPortNumber\",\"parameterName\":\"SrcPortNumber\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blueDark\"}}]}},\"customWidth\":\"30\",\"name\":\"topSourcePort\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| where SrcPortNumber in (\\\"0\\\" {SrcPortNumber})\\r\\n| project DeviceName, LogType, SrcIpAddr, SrcPortNumber, SrcMacAddr, DstIpAddr, DstPortNumber, DstMacAddr\",\"size\":0,\"title\":\"Events from Affected Source Port(s)\",\"noDataMessage\":\"Please select Affected Port(s) from the left section to view results.\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"70\",\"name\":\"topSourcePortDetails\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| where isnotempty(DstPortNumber)\\r\\n| summarize count() by DstPortNumber\\r\\n| sort by count_\",\"size\":0,\"title\":\"Top Events by Destination Port\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"DstPortNumber\",\"parameterName\":\"DstPortNumber\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blueDark\"}}]}},\"customWidth\":\"30\",\"name\":\"topDestinationPort\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki\\r\\n| where LogType in ('' {SelectLogType})\\r\\n| where DstPortNumber in (\\\"0\\\" {DstPortNumber})\\r\\n| project DeviceName, LogType, SrcIpAddr, SrcPortNumber, SrcMacAddr, DstIpAddr, DstPortNumber, DstMacAddr\",\"size\":0,\"title\":\"Events from Affected Destination Port(s)\",\"noDataMessage\":\"Please select Affected Port(s) from the left section to view results.\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"70\",\"name\":\"topDestinationPortDetails\"}]},\"conditionalVisibility\":{\"parameterName\":\"VisibleTabName\",\"comparison\":\"isEqualTo\",\"value\":\"IPThreats\"},\"name\":\"IpThreat\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"Found_in_Threat_Intel correlates Sha256 with Threat Intelligence data present in Sentinel. This helps identify new threat intelligence information that you can use to further enhance your overall security posture.\",\"style\":\"info\"},\"name\":\"noteMalwareDetected\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let maliciousFileHash = ThreatIntelligenceIndicator | where isnotempty(FileHashValue) | distinct FileHashValue;\\r\\nCiscoMeraki\\r\\n| where Disposition == \\\"malicious\\\"\\r\\n| summarize Instances=count() by DeviceName, Sha256, Url, Action\\r\\n| extend Found_in_Threat_Intel = iif(isnotempty(Sha256) and Sha256 in (maliciousFileHash), \\\"Yes\\\", \\\"No\\\")\\r\\n| project-reorder Found_in_Threat_Intel, DeviceName, Sha256, Url, Action, Instances\\r\\n| order by Found_in_Threat_Intel, Instances\",\"size\":0,\"title\":\"Top Malware Detections\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"IsMalicious\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"blue\",\"compositeBarSettings\":{\"labelText\":\"\"}}},{\"columnMatch\":\"Sha256_s\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"80ch\"}},{\"columnMatch\":\"Url_s\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"70ch\"}}]}},\"name\":\"topMalwareDetected\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let maliciousFileHash = ThreatIntelligenceIndicator | where isnotempty(FileHashValue) | distinct FileHashValue;\\r\\nCiscoMeraki\\r\\n| where Disposition == \\\"malicious\\\" and Action == \\\"deny\\\"\\r\\n| summarize Instances=count() by DeviceName, Sha256, Url, Action\\r\\n| extend Found_in_Threat_Intel = iif(isnotempty(Sha256) and Sha256 in (maliciousFileHash), \\\"Yes\\\", \\\"No\\\")\\r\\n| project-reorder Found_in_Threat_Intel, DeviceName, Sha256, Url, Action, Instances\\r\\n| order by Found_in_Threat_Intel, Instances\",\"size\":0,\"title\":\"Top Retrospective Malware Detections\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Sha256_s\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"80ch\"}},{\"columnMatch\":\"Url_s\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"70ch\"}}]}},\"name\":\"topRetrospectiveMalwareDetected\"}]},\"conditionalVisibility\":{\"parameterName\":\"VisibleTabName\",\"comparison\":\"isEqualTo\",\"value\":\"MalwareThreats\"},\"name\":\"MalwareThreats\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"e75c556b-b636-4599-83cc-b8f9c38d7f60\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DeviceName\",\"label\":\"Device Name\",\"type\":2,\"description\":\"Select the Device Name to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct DeviceName\\r\\n| extend DeviceName = iif(isempty(DeviceName), \\\"empty\\\", DeviceName)\\r\\n| order by DeviceName asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"f67ad484-ff20-49cb-afa6-93c1be8debab\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"LogType\",\"label\":\"Log Type\",\"type\":2,\"description\":\"Select the Log Type to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct LogType\\r\\n| extend LogType = iif(isempty(LogType), \\\"empty\\\", LogType)\\r\\n| order by LogType asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"8077dc84-a7c8-4bb4-b826-fec999bbdc34\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SrcIpAddr\",\"label\":\"Source IP Address\",\"type\":2,\"description\":\"Select the Source IP Address to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct SrcIpAddr\\r\\n| extend SrcIpAddr = iif(isempty(SrcIpAddr), \\\"-\\\", SrcIpAddr)\\r\\n| sort by SrcIpAddr asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"928b0767-1430-4e75-9978-6bfbc7166af1\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SrcPortNumber\",\"label\":\"Source Port Number\",\"type\":2,\"description\":\"Select the Source Port Number to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct SrcPortNumber\\r\\n| extend SrcPortNumber = iif(isempty(SrcPortNumber), 0, SrcPortNumber)\\r\\n| sort by SrcPortNumber asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"648072e7-2c48-45fc-99ab-b1c963de1c1b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SrcMacAddr\",\"label\":\"Source Mac Address\",\"type\":2,\"description\":\"Select the Source MAC Address to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct SrcMacAddr\\r\\n| extend SrcMacAddr = iif(isempty(SrcMacAddr), \\\"-\\\", SrcMacAddr)\\r\\n| sort by SrcMacAddr asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"33c73a68-1916-4ca4-865c-40c456747c17\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DstIpAddr\",\"label\":\"Destination IP Address\",\"type\":2,\"description\":\"Select the Destination IP Address to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct DstIpAddr\\r\\n| extend DstIpAddr = iif(isempty(DstIpAddr), \\\"-\\\", DstIpAddr)\\r\\n| sort by DstIpAddr asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"d3a39bb1-1500-4274-ba6f-e987f1e732a8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DstPortNumber\",\"label\":\"Destination Port Number\",\"type\":2,\"description\":\"Select the Destination Port Number to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct DstPortNumber\\r\\n| extend DstPortNumber = iif(isempty(DstPortNumber), 0, DstPortNumber)\\r\\n| sort by DstPortNumber asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"06b715b9-0e2d-42c5-a7d4-8fb3398f2e0d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DstMacAddr\",\"label\":\"Destination Mac Address\",\"type\":2,\"description\":\"Select the Destination MAC Address to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct DstMacAddr\\r\\n| extend DstMacAddr = iif(isempty(DstMacAddr), \\\"-\\\", DstMacAddr)\\r\\n| sort by DstMacAddr asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"7b6901f3-d646-4e1c-8e83-10c48de6a68e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"HttpRequestMethod\",\"label\":\"HTTP Request Method\",\"type\":2,\"description\":\"Select the HTTP Request Method to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct HttpRequestMethod\\r\\n| extend HttpRequestMethod = iif(isempty(HttpRequestMethod), \\\"empty\\\", HttpRequestMethod)\\r\\n| order by HttpRequestMethod asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"f73f8622-3281-4f88-827a-0df99a944af6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Url\",\"type\":2,\"description\":\"Select the Url to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct Url\\r\\n| extend Url = iif(isempty(Url), \\\"empty\\\", Url)\\r\\n| order by Url asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"fe51c740-f63c-491c-9734-63e612bf68a8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"NetworkProtocol\",\"label\":\"Network Protocol\",\"type\":2,\"description\":\"Select the Network Protocol to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct NetworkProtocol\\r\\n| extend NetworkProtocol = iif(isempty(NetworkProtocol), \\\"empty\\\", NetworkProtocol)\\r\\n| order by NetworkProtocol asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"38c497b4-9962-4beb-b132-24eb267d68ac\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"NetworkDirection\",\"label\":\"Network Direction\",\"type\":2,\"description\":\"Select the Network Direction to filter the data\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"\\\"\",\"delimiter\":\",\",\"query\":\"CiscoMeraki\\r\\n| distinct NetworkDirection\\r\\n| extend NetworkDirection = iif(isempty(NetworkDirection), \\\"empty\\\", NetworkDirection)\\r\\n| order by NetworkDirection asc\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parametersAllEvents\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoMeraki \\r\\n| project\\r\\n    TimeGenerated,\\r\\n    DeviceName=coalesce(DeviceName,\\\"empty\\\"),\\r\\n    LogType=coalesce(LogType,\\\"empty\\\"),\\r\\n    SrcIpAddr=coalesce(SrcIpAddr,\\\"-\\\"),\\r\\n    SrcPortNumber=coalesce(SrcPortNumber,0),\\r\\n    SrcMacAddr=coalesce(SrcMacAddr,\\\"-\\\"),\\r\\n    DstIpAddr=coalesce(DstIpAddr,\\\"-\\\"),\\r\\n    DstPortNumber=coalesce(DstPortNumber,0),\\r\\n    DstMacAddr=coalesce(DstMacAddr,\\\"-\\\"),\\r\\n    HttpRequestMethod=coalesce(HttpRequestMethod,\\\"empty\\\"),\\r\\n    Url=coalesce(Url,\\\"empty\\\"),\\r\\n    NetworkProtocol=coalesce(NetworkProtocol,\\\"empty\\\"),\\r\\n    NetworkDirection=coalesce(NetworkDirection,\\\"empty\\\")\\r\\n| where DeviceName in ('' {DeviceName:value}) and LogType in ('' {LogType:value}) and SrcIpAddr in ('' {SrcIpAddr:value}) and SrcMacAddr in ('' {SrcMacAddr:value}) and DstIpAddr in ('' {DstIpAddr:value}) and DstMacAddr in ('' {DstMacAddr:value}) and HttpRequestMethod in ('' {HttpRequestMethod:value}) and Url in ('' {Url:value}) and NetworkProtocol in ('' {NetworkProtocol:value}) and NetworkDirection in ('' {NetworkDirection:value})\\r\\n| where SrcPortNumber in ('' {SrcPortNumber:value}) and DstPortNumber in ('' {DstPortNumber:value})\\r\\n| order by TimeGenerated\",\"size\":0,\"title\":\"All Events\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"allEvents\"}]},\"conditionalVisibility\":{\"parameterName\":\"VisibleTabName\",\"comparison\":\"isEqualTo\",\"value\":\"allEvents\"},\"name\":\"AllMerakiEvents\"}],\"fromTemplateId\":\"sentinel-CiscoMerakiWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=CiscoMerakiWorkbook; logoFileName=; description=Gain insights into the Events from Cisco Meraki Solution and analyzing all the different types of Security Events. This workbook also helps in identifying the Events from affected devices, IPs and the nodes where malware was successfully detected.\nIP data received in Events is correlated with Threat Intelligence to identify if the reported IP address is known bad based on threat intelligence data.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=CiscoMerakiWorkbook; templateRelativePath=CiscoMerakiWorkbook.json; subtitle=; provider=Microsoft}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoMeraki",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "meraki_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "CiscoMerakiNativePoller",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "ThreatIntelligenceIndicator",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "CiscoMeraki",
                      "kind": "DataConnector"
                    },
                    {
                      "contentId": "CiscoMerakiNativePolling",
                      "kind": "DataConnector"
                    },
                    {
                      "contentId": "ThreatIntelligence",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CiscoMeraki data connector with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "Cisco Meraki",
                  "publisher": "Cisco",
                  "descriptionMarkdown": "The [Cisco Meraki](https://meraki.cisco.com/) connector allows you to easily connect your Cisco Meraki (MX/MR/MS) logs with Microsoft Sentinel. This gives you more insight into your organization's network and improves your security operation capabilities.",
                  "additionalRequirementBanner": "These queries are dependent on a parser based on a Kusto Function deployed as part of the solution.",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "CiscoMeraki",
                      "baseQuery": "CiscoMeraki"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Total Events by Log Type",
                      "query": "CiscoMeraki \n | summarize count() by LogType"
                    },
                    {
                      "description": "Top 10 Blocked Connections",
                      "query": "CiscoMeraki \n | where LogType == \"security_event\" \n | where Action == \"block\" \n | summarize count() by SrcIpAddr, DstIpAddr, Action, Disposition \n | top 10 by count_"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "meraki_CL",
                      "lastDataReceivedQuery": "CiscoMeraki \n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CiscoMeraki \n      | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "write permission is required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Cisco Meraki",
                        "description": "must be configured to export logs via Syslog"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": "**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected which is deployed as part of the solution. To view the function code in Log Analytics, open Log Analytics/Microsoft Sentinel Logs blade, click Functions and search for the alias CiscoMeraki and load the function code or click [here](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/CiscoMeraki/Parsers/CiscoMeraki.txt). The function usually takes 10-15 minutes to activate after solution installation/update."
                    },
                    {
                      "description": "Typically, you should install the agent on a different computer from the one on which the logs are generated.\n\n>  Syslog logs are collected only from **Linux** agents.",
                      "instructions": [
                        {
                          "parameters": {
                            "title": "Choose where to install the agent:",
                            "instructionSteps": [
                              {
                                "title": "Install agent on Azure Linux Virtual Machine",
                                "description": "Select the machine to install the agent on and then click **Connect**.",
                                "instructions": [
                                  {
                                    "parameters": {
                                      "linkType": "InstallAgentOnLinuxVirtualMachine"
                                    },
                                    "type": "InstallAgent"
                                  }
                                ]
                              },
                              {
                                "title": "Install agent on a non-Azure Linux Machine",
                                "description": "Download the agent on the relevant machine and follow the instructions.",
                                "instructions": [
                                  {
                                    "parameters": {
                                      "linkType": "InstallAgentOnLinuxNonAzure"
                                    },
                                    "type": "InstallAgent"
                                  }
                                ]
                              }
                            ]
                          },
                          "type": "InstructionStepsGroup"
                        }
                      ],
                      "title": "1. Install and onboard the agent for Linux"
                    },
                    {
                      "description": "Follow the configuration steps below to get Cisco Meraki device logs into Microsoft Sentinel. Refer to the [Azure Monitor Documentation](https://docs.microsoft.com/azure/azure-monitor/agents/data-sources-json) for more details on these steps.\n For Cisco Meraki logs, we have issues while parsing the data by OMS agent data using default settings. \nSo we advice to capture the logs into custom table **meraki_CL** using below instructions. \n1. Login to the server where you have installed OMS agent.\n2. Download config file [meraki.conf](https://aka.ms/sentinel-ciscomerakioms-conf) \n\t\twget -v https://aka.ms/sentinel-ciscomerakioms-conf -O meraki.conf \n3. Copy meraki.conf to the /etc/opt/microsoft/omsagent/**workspace_id**/conf/omsagent.d/ folder. \n\t\tcp meraki.conf /etc/opt/microsoft/omsagent/<<workspace_id>>/conf/omsagent.d/\n4. Edit meraki.conf as follows:\n\n\t a. meraki.conf uses the port **22033** by default. Ensure this port is not being used by any other source on your server\n\n\t b. If you would like to change the default port for **meraki.conf** make sure that you dont use default Azure monitoring /log analytic agent ports I.e.(For example CEF uses TCP port **25226** or **25224**) \n\n\t c. replace **workspace_id** with real value of your Workspace ID (lines 14,15,16,19)\n5. Save changes and restart the Azure Log Analytics agent for Linux service with the following command:\n\t\tsudo /opt/microsoft/omsagent/bin/service_control restart\n6. Modify /etc/rsyslog.conf file - add below template preferably at the beginning / before directives section \n\t\t$template meraki,\"%timestamp% %hostname% %msg%\\n\" \n7. Create a custom conf file in /etc/rsyslog.d/ for example 10-meraki.conf and add following filter conditions.\n\n\t With an added statement you will need to create a filter which will specify the logs coming from the Cisco Meraki to be forwarded to the custom table.\n\n\t reference: [Filter Conditions  rsyslog 8.18.0.master documentation](https://rsyslog.readthedocs.io/en/latest/configuration/filters.html)\n\n\t Here is an example of filtering that can be defined, this is not complete and will require additional testing for each installation.\n\t\t if $rawmsg contains \"flows\" then @@127.0.0.1:22033;meraki\n\t\t & stop \n\t\t if $rawmsg contains \"urls\" then @@127.0.0.1:22033;meraki\n\t\t & stop\n\t\t if $rawmsg contains \"ids-alerts\" then @@127.0.0.1:22033;meraki\n\t\t & stop\n\t\t if $rawmsg contains \"events\" then @@127.0.0.1:22033;meraki\n\t\t & stop\n\t\t if $rawmsg contains \"ip_flow_start\" then @@127.0.0.1:22033;meraki\n\t\t & stop\n\t\t if $rawmsg contains \"ip_flow_end\" then @@127.0.0.1:22033;meraki\n\t\t & stop \n8. Restart rsyslog\n\t\t systemctl restart rsyslog",
                      "instructions": [
                        {
                          "parameters": {
                            "fillWith": [
                              "WorkspaceId"
                            ],
                            "label": "Workspace ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ],
                      "title": "2. Configure the logs to be collected"
                    },
                    {
                      "description": "[Follow these instructions](https://documentation.meraki.com/General_Administration/Monitoring_and_Reporting/Meraki_Device_Reporting_-_Syslog%2C_SNMP_and_API) to configure the Cisco Meraki device(s) to forward syslog. Use the IP address or hostname for the Linux device with the Linux agent installed as the Destination IP address.",
                      "title": "3. Configure and connect the Cisco Meraki device(s)"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2023-04-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoMeraki",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "contentKind": "DataConnector",
        "displayName": "Cisco Meraki",
        "contentProductId": "[variables('_dataConnectorcontentProductId1')]",
        "id": "[variables('_dataConnectorcontentProductId1')]",
        "version": "[variables('dataConnectorVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "CiscoMeraki",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Cisco Meraki",
          "publisher": "Cisco",
          "descriptionMarkdown": "The [Cisco Meraki](https://meraki.cisco.com/) connector allows you to easily connect your Cisco Meraki (MX/MR/MS) logs with Microsoft Sentinel. This gives you more insight into your organization's network and improves your security operation capabilities.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "CiscoMeraki",
              "baseQuery": "CiscoMeraki"
            }
          ],
          "dataTypes": [
            {
              "name": "meraki_CL",
              "lastDataReceivedQuery": "CiscoMeraki \n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CiscoMeraki \n      | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "Total Events by Log Type",
              "query": "CiscoMeraki \n | summarize count() by LogType"
            },
            {
              "description": "Top 10 Blocked Connections",
              "query": "CiscoMeraki \n | where LogType == \"security_event\" \n | where Action == \"block\" \n | summarize count() by SrcIpAddr, DstIpAddr, Action, Disposition \n | top 10 by count_"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "write permission is required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Cisco Meraki",
                "description": "must be configured to export logs via Syslog"
              }
            ]
          },
          "instructionSteps": [
            {
              "description": "**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected which is deployed as part of the solution. To view the function code in Log Analytics, open Log Analytics/Microsoft Sentinel Logs blade, click Functions and search for the alias CiscoMeraki and load the function code or click [here](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/CiscoMeraki/Parsers/CiscoMeraki.txt). The function usually takes 10-15 minutes to activate after solution installation/update."
            },
            {
              "description": "Typically, you should install the agent on a different computer from the one on which the logs are generated.\n\n>  Syslog logs are collected only from **Linux** agents.",
              "instructions": [
                {
                  "parameters": {
                    "title": "Choose where to install the agent:",
                    "instructionSteps": [
                      {
                        "title": "Install agent on Azure Linux Virtual Machine",
                        "description": "Select the machine to install the agent on and then click **Connect**.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxVirtualMachine"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      },
                      {
                        "title": "Install agent on a non-Azure Linux Machine",
                        "description": "Download the agent on the relevant machine and follow the instructions.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxNonAzure"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      }
                    ]
                  },
                  "type": "InstructionStepsGroup"
                }
              ],
              "title": "1. Install and onboard the agent for Linux"
            },
            {
              "description": "Follow the configuration steps below to get Cisco Meraki device logs into Microsoft Sentinel. Refer to the [Azure Monitor Documentation](https://docs.microsoft.com/azure/azure-monitor/agents/data-sources-json) for more details on these steps.\n For Cisco Meraki logs, we have issues while parsing the data by OMS agent data using default settings. \nSo we advice to capture the logs into custom table **meraki_CL** using below instructions. \n1. Login to the server where you have installed OMS agent.\n2. Download config file [meraki.conf](https://aka.ms/sentinel-ciscomerakioms-conf) \n\t\twget -v https://aka.ms/sentinel-ciscomerakioms-conf -O meraki.conf \n3. Copy meraki.conf to the /etc/opt/microsoft/omsagent/**workspace_id**/conf/omsagent.d/ folder. \n\t\tcp meraki.conf /etc/opt/microsoft/omsagent/<<workspace_id>>/conf/omsagent.d/\n4. Edit meraki.conf as follows:\n\n\t a. meraki.conf uses the port **22033** by default. Ensure this port is not being used by any other source on your server\n\n\t b. If you would like to change the default port for **meraki.conf** make sure that you dont use default Azure monitoring /log analytic agent ports I.e.(For example CEF uses TCP port **25226** or **25224**) \n\n\t c. replace **workspace_id** with real value of your Workspace ID (lines 14,15,16,19)\n5. Save changes and restart the Azure Log Analytics agent for Linux service with the following command:\n\t\tsudo /opt/microsoft/omsagent/bin/service_control restart\n6. Modify /etc/rsyslog.conf file - add below template preferably at the beginning / before directives section \n\t\t$template meraki,\"%timestamp% %hostname% %msg%\\n\" \n7. Create a custom conf file in /etc/rsyslog.d/ for example 10-meraki.conf and add following filter conditions.\n\n\t With an added statement you will need to create a filter which will specify the logs coming from the Cisco Meraki to be forwarded to the custom table.\n\n\t reference: [Filter Conditions  rsyslog 8.18.0.master documentation](https://rsyslog.readthedocs.io/en/latest/configuration/filters.html)\n\n\t Here is an example of filtering that can be defined, this is not complete and will require additional testing for each installation.\n\t\t if $rawmsg contains \"flows\" then @@127.0.0.1:22033;meraki\n\t\t & stop \n\t\t if $rawmsg contains \"urls\" then @@127.0.0.1:22033;meraki\n\t\t & stop\n\t\t if $rawmsg contains \"ids-alerts\" then @@127.0.0.1:22033;meraki\n\t\t & stop\n\t\t if $rawmsg contains \"events\" then @@127.0.0.1:22033;meraki\n\t\t & stop\n\t\t if $rawmsg contains \"ip_flow_start\" then @@127.0.0.1:22033;meraki\n\t\t & stop\n\t\t if $rawmsg contains \"ip_flow_end\" then @@127.0.0.1:22033;meraki\n\t\t & stop \n8. Restart rsyslog\n\t\t systemctl restart rsyslog",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                }
              ],
              "title": "2. Configure the logs to be collected"
            },
            {
              "description": "[Follow these instructions](https://documentation.meraki.com/General_Administration/Monitoring_and_Reporting/Meraki_Device_Reporting_-_Syslog%2C_SNMP_and_API) to configure the Cisco Meraki device(s) to forward syslog. Use the IP address or hostname for the Linux device with the Linux agent installed as the Destination IP address.",
              "title": "3. Configure and connect the Cisco Meraki device(s)"
            }
          ],
          "id": "[variables('_uiConfigId1')]",
          "additionalRequirementBanner": "These queries are dependent on a parser based on a Kusto Function deployed as part of the solution."
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('parserTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CiscoMeraki Data Parser with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName1')]",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cisco Meraki Data Parser",
                "category": "Samples",
                "functionAlias": "CiscoMeraki",
                "query": "\nlet MerakiSyslogDevices = pack_array(\"server1\", \"server2\"); // replace server1 and server2 with your actual Cisco Meraki device(s) and add more with comma separated\r\nunion isfuzzy=true\r\n        (\r\n\t\t\tmeraki_CL\r\n\t\t\t| project-rename LogMessage =  Message\r\n        ),\r\n        (\r\n\t\t\tSyslog\r\n\t\t\t| where Computer in (MerakiSyslogDevices)\r\n\t\t\t| project-rename LogMessage =  SyslogMessage\r\n        ),\r\n        (\r\n            CiscoMerakiNativePoller_CL\r\n            | extend LogMessage = \"\"\r\n            | extend\r\n                     Action = DvcAction,\r\n                     Message = EventMessage,\r\n                     NetworkProtocol = coalesce(NetworkProtocol, NetworkApplicationProtocol),\r\n                     Sha256 = Hash\r\n            | extend Signature = extract(@\"signature=(\\S+);\",1,tostring(AdditionalFields)),\r\n                     LogType = iff(EventOriginalType == \"IDS Alert\", \"ids-alerts\", \"security_event\")\r\n        )\r\n| extend Parser = extract_all(@\"(\\d+.\\d+)\\s([\\w\\-\\_]+)\\s([\\w\\-\\_]+)\\s([\\S\\s]+)$\", dynamic([1, 2, 3, 4]), LogMessage)[0]\r\n| extend Epoch = tostring(Parser[0]),\r\n        DeviceName = coalesce(tostring(Parser[1]),column_ifexists(\"SrcHostname\",\"\")),\r\n        LogType = coalesce(column_ifexists(\"LogType\",\"\"),tostring(Parser[2])),\r\n        Substring = tostring(Parser[3])\r\n| extend EpochTimestamp = split(Epoch,\".\")\r\n| extend EventTimestamp = unixtime_seconds_todatetime(tolong(EpochTimestamp[0]))\r\n| extend EventStartTime = coalesce(EventTimestamp,column_ifexists(\"EventStartTime\",datetime(null)))\r\n| extend SrcIpAddr = case(\r\n                        isnotempty(column_ifexists(\"SrcIpAddr\",\"\")), column_ifexists(\"SrcIpAddr\",\"\"),\r\n                        LogType has \"urls\", extract(@\"src=([0-9\\.]+)\\:\",1,Substring),\r\n                        LogType has \"flows\", extract(@\"src=([0-9\\.]+)\\s\",1,Substring),\r\n                        LogType has \"security_event\", extract(@\"src=([0-9\\.]+)\\:\",1,Substring),\r\n                        LogType has \"ids-alerts\", extract(@\"src=([0-9\\.]+)\\:\",1,Substring),\r\n                        LogType has \"events\", extract(@\"(peer_contact|ip_src)=\\'([0-9\\.]+)\\:\",2,Substring),\r\n                        \"\"\r\n                    ),\r\n\t\t SrcPortNumber = case(\r\n                            isnotnull(column_ifexists(\"SrcPortNumber\",int(null))),\r\n                            column_ifexists(\"SrcPortNumber\",int(null)),\r\n                            LogType has \"urls\", toint(extract(@\"src=([0-9\\.]+)\\:(\\d+)\\s\",2,Substring)),\r\n                            LogType has \"flows\", toint(extract(@\"sport=(\\S+)\",1,Substring)),\r\n                            LogType has \"security_event\", toint(extract(@\"src=([0-9\\.]+)\\:(\\d+)\",2,Substring)),\r\n                            LogType has \"ids-alerts\", toint(extract(@\"src=([0-9\\.]+)\\:(\\d+)\",2,Substring)),\r\n                            LogType has \"events\", toint(extract(@\"(peer_contact|ip_src)=\\'([0-9\\.]+)\\:(\\d+)\\'\",3,Substring)),\r\n                            int(null)\r\n                        ),\r\n\t\t DstIpAddr = case(\r\n                        isnotempty(column_ifexists(\"DstIpAddr\",\"\")), column_ifexists(\"DstIpAddr\",\"\"),\r\n                        LogType has \"urls\",extract(@\"dst=([0-9\\.]+)\\:\",1,Substring),\r\n                        LogType has \"flows\", extract(@\"dst=([0-9\\.]+)\\s\",1,Substring),\r\n                        LogType has \"security_event\", extract(@\"dst=([0-9\\.]+)\\:\",1,Substring),\r\n                        \"\"\r\n                    ),\r\n\t\t DstPortNumber = case(\r\n                            isnotnull(column_ifexists(\"DstPortNumber\",int(null))),\r\n                            column_ifexists(\"DstPortNumber\",int(null)),\r\n                            LogType has \"urls\", toint(extract(@\"dst=([0-9\\.]+)\\:(\\d+)\\s\",2,Substring)),\r\n                            LogType has \"flows\", toint(extract(@\"dport=(\\S+)\",1,Substring)),\r\n                            LogType has \"security_event\", toint(extract(@\"dst=([0-9\\.]+)\\:(\\d+)\",2,Substring)),\r\n                            int(null)\r\n                        ),\r\n\t\t HttpRequestMethod = iff(LogType has \"urls\", extract(@\"request: (\\w+)\\s\",1,Substring), dynamic(\"\")),\r\n\t\t Url = case(\r\n                    isnotempty(column_ifexists(\"Url\",\"\")), column_ifexists(\"Url\",\"\"),\r\n                    LogType has \"urls\", extract(@\"request: (\\w+)\\s(\\S+)\",2,Substring),\r\n                    LogType has \"security_event\", tostring(extract(@\"url=(\\S+)\\s\",1,Substring)),\r\n                    \"\"),\r\n\t\t SrcMacAddr = case(\r\n                        isnotempty(column_ifexists(\"SrcMacAddr\",\"\")), column_ifexists(\"SrcMacAddr\",\"\"),\r\n                        LogType has \"airmarshal_events\", tostring(extract(@\"src=\\'(\\S+)\\'\",1,Substring)),\r\n                        LogType has \"flows\", tostring(extract(@\"mac=(\\S+)\\s\",1,Substring)),\r\n                        LogType has \"security_event\", tostring(extract(@\"shost=(\\S+)\\s\",1,Substring)),\r\n                        \"\"\r\n                    ),\r\n\t\t NetworkProtocol = case(\r\n                            isnotempty(column_ifexists(\"NetworkProtocol\",\"\")), column_ifexists(\"NetworkProtocol\",\"\"),\r\n                            LogType has \"ids-alerts\", tostring(extract(@\"protocol=(\\w+)\\s\",1,Substring)),\r\n                            LogType has \"flows\", extract(@\"protocol=(\\w+)\\s\",1,Substring),\r\n                            LogType has \"security_event\", tostring(extract(@\"protocol=(\\w+)\\s\",1,Substring)),\r\n                            \"\"\r\n                        ),\r\n\t\t Pattern = iff(LogType has \"flows\", extract(@\"pattern\\: ([\\S\\s]+)\",1,Substring), dynamic(\"\")),\r\n\t\t EventType = case(\r\n                        isnotempty(column_ifexists(\"EventOriginalType\",\"\")), column_ifexists(\"EventOriginalType\",\"\"),\r\n                        LogType has \"airmarshal_events\", tostring(extract(@\"type= (\\S+)\",1,Substring)),\r\n                        LogType has \"events\", tostring(extract(@\"type=(\\S+)\",1,Substring)),\r\n                        LogType has \"security_event\", tostring(extract(@\"^(\\S+)\\s\\w+\\:\",1,Substring)),\r\n                        \"\"\r\n                    ),\r\n\t\t Ssid = iff(LogType has \"airmarshal_events\", tostring(extract(@\"ssid=\\'(\\S+)\\'\",1,Substring)),dynamic(\"\")),\r\n\t\t Vap = case(\r\n                    LogType has \"airmarshal_events\", toint(extract(@\"vap=\\'(\\S+)\\'\\s\",1,Substring)),\r\n                    LogType has \"events\", toint(extract(@\"vap=\\'(\\S+)\\'\\s\",1,Substring)),\r\n                    dynamic(\"\")\r\n                ),\r\n\t\t Bssid = iff(LogType has \"airmarshal_events\",tostring(extract(@\"bssid=\\'(\\S+)\\'\",1,Substring)),dynamic(\"\")),\r\n\t\t DstMacAddr = case(\r\n                        LogType has \"airmarshal_events\", tostring(extract(@\"dst=\\'(\\S+)\\'\",1,Substring)),\r\n                        LogType has \"security_event\", tostring(extract(@\"dhost=(\\S+)\\s\",1,Substring)),\r\n                        \"\"\r\n                    ),\r\n\t\t WiredMacAddr = iff(LogType has \"airmarshal_events\", tostring(extract(@\"wired_mac=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Channel = case(\r\n                    LogType has \"airmarshal_events\", toint(extract(@\"channel=\\'(\\d+)\\'\",1,Substring)),\r\n                    LogType has \"events\", toint(extract(@\"channel=\\'(\\S+)\\'\",1,Substring)),\r\n                    dynamic(\"\")\r\n                ),\r\n\t\t VlanId = iff(LogType has \"airmarshal_events\", toint(extract(@\"vlan_id=\\'(\\d+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Rssi = iff(LogType has \"airmarshal_events\" or LogType has \"events\", toint(extract(@\"rssi=\\'(\\d+)\\'\",1,Substring)), int(null)),\r\n\t\t FcType = iff(LogType has \"airmarshal_events\", toint(extract(@\"fc_type=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t FcSubType = iff(LogType has \"airmarshal_events\", toint(extract(@\"fc_subtype=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Signature = case(\r\n                    isnotempty(column_ifexists(\"Signature\",\"\")), column_ifexists(\"Signature\",\"\"),\r\n                    LogType has \"security_event\", tostring(extract(@\"signature=(\\S+)\\s\",1,Substring)),\r\n                    LogType has \"ids-alerts\", tostring(extract(@\"signature=(\\S+)\\s\",1,Substring)),\r\n                    \"\"\r\n                ),\r\n\t\t Priority = case(\r\n                    LogType has \"security_event\", toint(extract(@\"priority=(\\d+)\\s\",1,Substring)),\r\n                    LogType has \"ids-alerts\", toint(extract(@\"priority=(\\d+)\\s\",1,Substring)),\r\n                    dynamic(\"\")\r\n                ),\r\n\t\t EventEpoch = case(\r\n                        LogType has \"security_event\", tostring(extract(@\"timestamp=(\\S+)\\s\",1,Substring)),\r\n                        LogType has \"ids-alerts\", tostring(extract(@\"timestamp=(\\S+)\\s\",1,Substring)),\r\n                        \"\"\r\n                    ),\r\n\t\t NetworkDirection = case(\r\n                            LogType has \"security_event\", tostring(extract(@\"direction=(\\S+)\",1,Substring)),\r\n                            LogType has \"ids-alerts\", tostring(extract(@\"direction=(\\S+)\",1,Substring)),\r\n                            \"\"\r\n                        ),\r\n\t\t Action = case(\r\n                            isnotempty(column_ifexists(\"Action\",\"\")), column_ifexists(\"Action\",\"\"),\r\n                            LogType has \"security_event\", tostring(extract(@\"action=(\\w+)\",1,Substring)),\r\n                            \"\"\r\n                    ),\r\n\t\t Message = iff(LogType has \"security_event\", tostring(extract(@\"message: ([\\w\\.\\-\\+\\,\\s]+)(\\s\\w+\\=)?\",1,Substring)), column_ifexists(\"Message\",\"\")),\r\n\t\t VpnType = iff(LogType has \"events\",  tostring(extract(@\"vpn_type=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t PeerIdentity = iff(LogType has \"events\",  tostring(extract(@\"peer_ident=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Radio = iff(LogType has \"events\",  toint(extract(@\"radio=\\'(\\d+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Group = iff(LogType has \"events\",  toint(extract(@\"group=\\'(\\S+)?\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Attribute = iff(LogType has \"events\",  toint(extract(@\"attr=\\'(\\S+)?\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t ClientMacAddr = case(\r\n                        isnotempty(column_ifexists(\"SrcMacAddr\",\"\")), column_ifexists(\"SrcMacAddr\",\"\"),\r\n                        LogType has \"events\",  tostring(extract(@\"client_mac=\\'(\\S+)\\'\",1,Substring)),\r\n                        \"\"\r\n                ),\r\n\t\t Reason = iff(LogType has \"events\",  toint(extract(@\"reason=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t AppleDaReason = iff(LogType has \"events\",  toint(extract(@\"apple_da_reason=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Duration = iff(LogType has \"events\",  tostring(extract(@\"duration=\\'(\\S+)\\'\",1,Substring)), \"\"),\r\n\t\t FullConn = iff(LogType has \"events\",  tostring(extract(@\"full_conn=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t IpResp = iff(LogType has \"events\",  tostring(extract(@\"ip_resp=\\'(\\S+)\\'\\s\",1,Substring)), dynamic(\"\")),\r\n\t\t HttpResp = iff(LogType has \"events\",  tostring(extract(@\"http_resp=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t ArpResp = iff(LogType has \"events\",  tostring(extract(@\"arp_resp=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t ArpSrcIpAddr = case(\r\n                        isnotempty(column_ifexists(\"SrcIpAddr\",\"\")), column_ifexists(\"SrcIpAddr\",\"\"),\r\n                        LogType has \"events\",  tostring(extract(@\"arp_src=\\'(\\S+)\\'\",1,Substring)),\r\n                        \"\"\r\n                ),\r\n\t\t Connectivity = iff(LogType has \"events\",  tostring(extract(@\"connectivity=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Rtt = iff(LogType has \"events\",  tostring(extract(@\"rtt=\\'([\\w+\\.\\s]+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t UserName = iff(LogType has \"events\",  tostring(extract(@\"identity=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Aid = iff(LogType has \"events\",  tostring(extract(@\"aid=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Spi = iff(LogType has \"events\",  tostring(extract(@\"spi=(\\S+)$\",1,Substring)), dynamic(\"\")),\r\n\t\t DvcMacAddr = case(\r\n                        isnotempty(column_ifexists(\"DvcMacAddr\",\"\")), column_ifexists(\"DvcMacAddr\",\"\"),\r\n                        LogType has \"events\",  tostring(extract(@\"device=\\'(\\S+)\\'\",1,Substring)),\r\n                        \"\"\r\n                ),\r\n\t\t State = iff(LogType has \"events\",  tostring(extract(@\"state=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t AlarmId = iff(LogType has \"events\",  toint(extract(@\"alarm_id=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t DosCount = iff(LogType has \"events\",  tostring(extract(@\"dos_count=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t InterArrival = iff(LogType has \"events\",  tostring(extract(@\"inter_arrival=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t LogTimestamp = case(\r\n                            isnotnull(column_ifexists(\"EventStartTime\",datetime(null))), column_ifexists(\"EventStartTime\",datetime(null)),\r\n                            LogType has \"security_event\", unixtime_seconds_todatetime(tolong(split(tostring(extract(@\"timestamp=(\\S+)\\s\",1,Substring)),\".\")[0])),\r\n                            LogType has \"ids-alerts\", unixtime_seconds_todatetime(tolong(split(tostring(extract(@\"timestamp=(\\S+)\\s\",1,Substring)),\".\")[0])),\r\n                            datetime(null)\r\n                        ),\r\n\t\t IpAddr = iff(LogType has \"events\", tostring(extract(@\"dhcp lease of ip ([\\d\\.]+)\", 1, Substring)), dynamic(\"\")),\r\n\t\t ServerMacAddr = iff(LogType has \"events\", tostring(extract(@\"server mac ([\\w\\:]+)\", 1, Substring)), dynamic(\"\")),\r\n\t\t RouterIpAddr = iff(LogType has \"events\", tostring(extract(@\"router ([\\d\\.]+)\", 1, Substring)), dynamic(\"\")),\r\n\t\t Subnet = iff(LogType has \"events\",  tostring(extract(@\"subnet ([\\d\\.]+)\", 1, Substring)), dynamic(\"\")),\r\n\t\t Dns = iff(LogType has \"events\",  split(extract(@\"dns ([\\d\\.\\,\\:\\s]+)\", 1, Substring), \", \"), dynamic(\"\"))\r\n| extend\r\n            ClientMacAddr = iif(isempty(ClientMacAddr), tostring(extract(@\"client mac ([\\w\\:]+)\", 1, Substring)), ClientMacAddr),\r\n\t\t    SrcPortNumber = iif(isempty(SrcPortNumber), toint(extract(@\"port=\\'(\\S+)\\'\",1,Substring)), SrcPortNumber),\r\n            Dns = iif(Dns[0] == \"\", \"\", Dns)\r\n| extend LogType = case(\r\n                    isnotempty(LogType), LogType,\r\n                    LogType !in (\"urls\", \"airmarshal_events\",\"security_event\",\"ids-alerts\", \"events\") and LogType !contains \"flows\", iif(isempty(LogType), \"\", LogType),\r\n                    \"\"\r\n                ),\r\n         NetworkProtocol = case(NetworkProtocol has \"tcp\", \"TCP\",\r\n                                NetworkProtocol has \"udp\", \"UDP\",\r\n                                \"\"),\r\n         EventSeverity = case(\r\n                             isnotempty(column_ifexists(\"EventSeverity\",\"\")), column_ifexists(\"EventSeverity\",\"\"),\r\n                              Priority == 1, \"High\",\r\n                              Priority == 2, \"Medium\",\r\n                              Priority == 3, \"Low\",\r\n                              Priority == 4, \"Infomational\",\r\n                              \"\"),\r\n        Disposition = case(\r\n                            EventType contains \"File Scanned\", tolower(column_ifexists(\"EventOriginalSeverity\",\"\")),\r\n                            LogType has \"security_event\", tostring(extract(@\"disposition=(\\w+)\",1,Substring)),\r\n                            \"\"\r\n                        ),\r\n        ThreatName = case(\r\n                            LogType has \"security_event\", tostring(extract(@\"name=(\\S+)\",1,Substring)),\r\n                            \"\"\r\n                        ),\r\n        Sha256 = case (\r\n                            EventType == \"File Scanned\", column_ifexists(\"Sha256\",\"\"),\r\n                            LogType has \"security_event\",  tostring(extract(@\"sha256=(\\S+)?\",1,Substring)),\r\n                            \"\"\r\n                        ),\r\n        Action = case(\r\n                            Action == \"block\", \"deny\",\r\n                            tolower(Action)\r\n            )\r\n| project-away Substring, Parser\r\n",
                "functionParameters": "",
                "version": 1,
                "tags": [
                  {
                    "name": "description",
                    "value": "Cisco Meraki Data Parser"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
              "dependsOn": [
                "[variables('_parserName1')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
                "contentId": "[variables('_parserContentId1')]",
                "kind": "Parser",
                "version": "[variables('parserVersion1')]",
                "source": {
                  "name": "CiscoMeraki",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_parserContentId1')]",
        "contentKind": "Parser",
        "displayName": "Cisco Meraki Data Parser",
        "contentProductId": "[variables('_parsercontentProductId1')]",
        "id": "[variables('_parsercontentProductId1')]",
        "version": "[variables('parserVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2022-10-01",
      "name": "[variables('_parserName1')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "Cisco Meraki Data Parser",
        "category": "Samples",
        "functionAlias": "CiscoMeraki",
        "query": "\nlet MerakiSyslogDevices = pack_array(\"server1\", \"server2\"); // replace server1 and server2 with your actual Cisco Meraki device(s) and add more with comma separated\r\nunion isfuzzy=true\r\n        (\r\n\t\t\tmeraki_CL\r\n\t\t\t| project-rename LogMessage =  Message\r\n        ),\r\n        (\r\n\t\t\tSyslog\r\n\t\t\t| where Computer in (MerakiSyslogDevices)\r\n\t\t\t| project-rename LogMessage =  SyslogMessage\r\n        ),\r\n        (\r\n            CiscoMerakiNativePoller_CL\r\n            | extend LogMessage = \"\"\r\n            | extend\r\n                     Action = DvcAction,\r\n                     Message = EventMessage,\r\n                     NetworkProtocol = coalesce(NetworkProtocol, NetworkApplicationProtocol),\r\n                     Sha256 = Hash\r\n            | extend Signature = extract(@\"signature=(\\S+);\",1,tostring(AdditionalFields)),\r\n                     LogType = iff(EventOriginalType == \"IDS Alert\", \"ids-alerts\", \"security_event\")\r\n        )\r\n| extend Parser = extract_all(@\"(\\d+.\\d+)\\s([\\w\\-\\_]+)\\s([\\w\\-\\_]+)\\s([\\S\\s]+)$\", dynamic([1, 2, 3, 4]), LogMessage)[0]\r\n| extend Epoch = tostring(Parser[0]),\r\n        DeviceName = coalesce(tostring(Parser[1]),column_ifexists(\"SrcHostname\",\"\")),\r\n        LogType = coalesce(column_ifexists(\"LogType\",\"\"),tostring(Parser[2])),\r\n        Substring = tostring(Parser[3])\r\n| extend EpochTimestamp = split(Epoch,\".\")\r\n| extend EventTimestamp = unixtime_seconds_todatetime(tolong(EpochTimestamp[0]))\r\n| extend EventStartTime = coalesce(EventTimestamp,column_ifexists(\"EventStartTime\",datetime(null)))\r\n| extend SrcIpAddr = case(\r\n                        isnotempty(column_ifexists(\"SrcIpAddr\",\"\")), column_ifexists(\"SrcIpAddr\",\"\"),\r\n                        LogType has \"urls\", extract(@\"src=([0-9\\.]+)\\:\",1,Substring),\r\n                        LogType has \"flows\", extract(@\"src=([0-9\\.]+)\\s\",1,Substring),\r\n                        LogType has \"security_event\", extract(@\"src=([0-9\\.]+)\\:\",1,Substring),\r\n                        LogType has \"ids-alerts\", extract(@\"src=([0-9\\.]+)\\:\",1,Substring),\r\n                        LogType has \"events\", extract(@\"(peer_contact|ip_src)=\\'([0-9\\.]+)\\:\",2,Substring),\r\n                        \"\"\r\n                    ),\r\n\t\t SrcPortNumber = case(\r\n                            isnotnull(column_ifexists(\"SrcPortNumber\",int(null))),\r\n                            column_ifexists(\"SrcPortNumber\",int(null)),\r\n                            LogType has \"urls\", toint(extract(@\"src=([0-9\\.]+)\\:(\\d+)\\s\",2,Substring)),\r\n                            LogType has \"flows\", toint(extract(@\"sport=(\\S+)\",1,Substring)),\r\n                            LogType has \"security_event\", toint(extract(@\"src=([0-9\\.]+)\\:(\\d+)\",2,Substring)),\r\n                            LogType has \"ids-alerts\", toint(extract(@\"src=([0-9\\.]+)\\:(\\d+)\",2,Substring)),\r\n                            LogType has \"events\", toint(extract(@\"(peer_contact|ip_src)=\\'([0-9\\.]+)\\:(\\d+)\\'\",3,Substring)),\r\n                            int(null)\r\n                        ),\r\n\t\t DstIpAddr = case(\r\n                        isnotempty(column_ifexists(\"DstIpAddr\",\"\")), column_ifexists(\"DstIpAddr\",\"\"),\r\n                        LogType has \"urls\",extract(@\"dst=([0-9\\.]+)\\:\",1,Substring),\r\n                        LogType has \"flows\", extract(@\"dst=([0-9\\.]+)\\s\",1,Substring),\r\n                        LogType has \"security_event\", extract(@\"dst=([0-9\\.]+)\\:\",1,Substring),\r\n                        \"\"\r\n                    ),\r\n\t\t DstPortNumber = case(\r\n                            isnotnull(column_ifexists(\"DstPortNumber\",int(null))),\r\n                            column_ifexists(\"DstPortNumber\",int(null)),\r\n                            LogType has \"urls\", toint(extract(@\"dst=([0-9\\.]+)\\:(\\d+)\\s\",2,Substring)),\r\n                            LogType has \"flows\", toint(extract(@\"dport=(\\S+)\",1,Substring)),\r\n                            LogType has \"security_event\", toint(extract(@\"dst=([0-9\\.]+)\\:(\\d+)\",2,Substring)),\r\n                            int(null)\r\n                        ),\r\n\t\t HttpRequestMethod = iff(LogType has \"urls\", extract(@\"request: (\\w+)\\s\",1,Substring), dynamic(\"\")),\r\n\t\t Url = case(\r\n                    isnotempty(column_ifexists(\"Url\",\"\")), column_ifexists(\"Url\",\"\"),\r\n                    LogType has \"urls\", extract(@\"request: (\\w+)\\s(\\S+)\",2,Substring),\r\n                    LogType has \"security_event\", tostring(extract(@\"url=(\\S+)\\s\",1,Substring)),\r\n                    \"\"),\r\n\t\t SrcMacAddr = case(\r\n                        isnotempty(column_ifexists(\"SrcMacAddr\",\"\")), column_ifexists(\"SrcMacAddr\",\"\"),\r\n                        LogType has \"airmarshal_events\", tostring(extract(@\"src=\\'(\\S+)\\'\",1,Substring)),\r\n                        LogType has \"flows\", tostring(extract(@\"mac=(\\S+)\\s\",1,Substring)),\r\n                        LogType has \"security_event\", tostring(extract(@\"shost=(\\S+)\\s\",1,Substring)),\r\n                        \"\"\r\n                    ),\r\n\t\t NetworkProtocol = case(\r\n                            isnotempty(column_ifexists(\"NetworkProtocol\",\"\")), column_ifexists(\"NetworkProtocol\",\"\"),\r\n                            LogType has \"ids-alerts\", tostring(extract(@\"protocol=(\\w+)\\s\",1,Substring)),\r\n                            LogType has \"flows\", extract(@\"protocol=(\\w+)\\s\",1,Substring),\r\n                            LogType has \"security_event\", tostring(extract(@\"protocol=(\\w+)\\s\",1,Substring)),\r\n                            \"\"\r\n                        ),\r\n\t\t Pattern = iff(LogType has \"flows\", extract(@\"pattern\\: ([\\S\\s]+)\",1,Substring), dynamic(\"\")),\r\n\t\t EventType = case(\r\n                        isnotempty(column_ifexists(\"EventOriginalType\",\"\")), column_ifexists(\"EventOriginalType\",\"\"),\r\n                        LogType has \"airmarshal_events\", tostring(extract(@\"type= (\\S+)\",1,Substring)),\r\n                        LogType has \"events\", tostring(extract(@\"type=(\\S+)\",1,Substring)),\r\n                        LogType has \"security_event\", tostring(extract(@\"^(\\S+)\\s\\w+\\:\",1,Substring)),\r\n                        \"\"\r\n                    ),\r\n\t\t Ssid = iff(LogType has \"airmarshal_events\", tostring(extract(@\"ssid=\\'(\\S+)\\'\",1,Substring)),dynamic(\"\")),\r\n\t\t Vap = case(\r\n                    LogType has \"airmarshal_events\", toint(extract(@\"vap=\\'(\\S+)\\'\\s\",1,Substring)),\r\n                    LogType has \"events\", toint(extract(@\"vap=\\'(\\S+)\\'\\s\",1,Substring)),\r\n                    dynamic(\"\")\r\n                ),\r\n\t\t Bssid = iff(LogType has \"airmarshal_events\",tostring(extract(@\"bssid=\\'(\\S+)\\'\",1,Substring)),dynamic(\"\")),\r\n\t\t DstMacAddr = case(\r\n                        LogType has \"airmarshal_events\", tostring(extract(@\"dst=\\'(\\S+)\\'\",1,Substring)),\r\n                        LogType has \"security_event\", tostring(extract(@\"dhost=(\\S+)\\s\",1,Substring)),\r\n                        \"\"\r\n                    ),\r\n\t\t WiredMacAddr = iff(LogType has \"airmarshal_events\", tostring(extract(@\"wired_mac=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Channel = case(\r\n                    LogType has \"airmarshal_events\", toint(extract(@\"channel=\\'(\\d+)\\'\",1,Substring)),\r\n                    LogType has \"events\", toint(extract(@\"channel=\\'(\\S+)\\'\",1,Substring)),\r\n                    dynamic(\"\")\r\n                ),\r\n\t\t VlanId = iff(LogType has \"airmarshal_events\", toint(extract(@\"vlan_id=\\'(\\d+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Rssi = iff(LogType has \"airmarshal_events\" or LogType has \"events\", toint(extract(@\"rssi=\\'(\\d+)\\'\",1,Substring)), int(null)),\r\n\t\t FcType = iff(LogType has \"airmarshal_events\", toint(extract(@\"fc_type=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t FcSubType = iff(LogType has \"airmarshal_events\", toint(extract(@\"fc_subtype=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Signature = case(\r\n                    isnotempty(column_ifexists(\"Signature\",\"\")), column_ifexists(\"Signature\",\"\"),\r\n                    LogType has \"security_event\", tostring(extract(@\"signature=(\\S+)\\s\",1,Substring)),\r\n                    LogType has \"ids-alerts\", tostring(extract(@\"signature=(\\S+)\\s\",1,Substring)),\r\n                    \"\"\r\n                ),\r\n\t\t Priority = case(\r\n                    LogType has \"security_event\", toint(extract(@\"priority=(\\d+)\\s\",1,Substring)),\r\n                    LogType has \"ids-alerts\", toint(extract(@\"priority=(\\d+)\\s\",1,Substring)),\r\n                    dynamic(\"\")\r\n                ),\r\n\t\t EventEpoch = case(\r\n                        LogType has \"security_event\", tostring(extract(@\"timestamp=(\\S+)\\s\",1,Substring)),\r\n                        LogType has \"ids-alerts\", tostring(extract(@\"timestamp=(\\S+)\\s\",1,Substring)),\r\n                        \"\"\r\n                    ),\r\n\t\t NetworkDirection = case(\r\n                            LogType has \"security_event\", tostring(extract(@\"direction=(\\S+)\",1,Substring)),\r\n                            LogType has \"ids-alerts\", tostring(extract(@\"direction=(\\S+)\",1,Substring)),\r\n                            \"\"\r\n                        ),\r\n\t\t Action = case(\r\n                            isnotempty(column_ifexists(\"Action\",\"\")), column_ifexists(\"Action\",\"\"),\r\n                            LogType has \"security_event\", tostring(extract(@\"action=(\\w+)\",1,Substring)),\r\n                            \"\"\r\n                    ),\r\n\t\t Message = iff(LogType has \"security_event\", tostring(extract(@\"message: ([\\w\\.\\-\\+\\,\\s]+)(\\s\\w+\\=)?\",1,Substring)), column_ifexists(\"Message\",\"\")),\r\n\t\t VpnType = iff(LogType has \"events\",  tostring(extract(@\"vpn_type=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t PeerIdentity = iff(LogType has \"events\",  tostring(extract(@\"peer_ident=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Radio = iff(LogType has \"events\",  toint(extract(@\"radio=\\'(\\d+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Group = iff(LogType has \"events\",  toint(extract(@\"group=\\'(\\S+)?\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Attribute = iff(LogType has \"events\",  toint(extract(@\"attr=\\'(\\S+)?\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t ClientMacAddr = case(\r\n                        isnotempty(column_ifexists(\"SrcMacAddr\",\"\")), column_ifexists(\"SrcMacAddr\",\"\"),\r\n                        LogType has \"events\",  tostring(extract(@\"client_mac=\\'(\\S+)\\'\",1,Substring)),\r\n                        \"\"\r\n                ),\r\n\t\t Reason = iff(LogType has \"events\",  toint(extract(@\"reason=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t AppleDaReason = iff(LogType has \"events\",  toint(extract(@\"apple_da_reason=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Duration = iff(LogType has \"events\",  tostring(extract(@\"duration=\\'(\\S+)\\'\",1,Substring)), \"\"),\r\n\t\t FullConn = iff(LogType has \"events\",  tostring(extract(@\"full_conn=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t IpResp = iff(LogType has \"events\",  tostring(extract(@\"ip_resp=\\'(\\S+)\\'\\s\",1,Substring)), dynamic(\"\")),\r\n\t\t HttpResp = iff(LogType has \"events\",  tostring(extract(@\"http_resp=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t ArpResp = iff(LogType has \"events\",  tostring(extract(@\"arp_resp=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t ArpSrcIpAddr = case(\r\n                        isnotempty(column_ifexists(\"SrcIpAddr\",\"\")), column_ifexists(\"SrcIpAddr\",\"\"),\r\n                        LogType has \"events\",  tostring(extract(@\"arp_src=\\'(\\S+)\\'\",1,Substring)),\r\n                        \"\"\r\n                ),\r\n\t\t Connectivity = iff(LogType has \"events\",  tostring(extract(@\"connectivity=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Rtt = iff(LogType has \"events\",  tostring(extract(@\"rtt=\\'([\\w+\\.\\s]+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t UserName = iff(LogType has \"events\",  tostring(extract(@\"identity=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Aid = iff(LogType has \"events\",  tostring(extract(@\"aid=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t Spi = iff(LogType has \"events\",  tostring(extract(@\"spi=(\\S+)$\",1,Substring)), dynamic(\"\")),\r\n\t\t DvcMacAddr = case(\r\n                        isnotempty(column_ifexists(\"DvcMacAddr\",\"\")), column_ifexists(\"DvcMacAddr\",\"\"),\r\n                        LogType has \"events\",  tostring(extract(@\"device=\\'(\\S+)\\'\",1,Substring)),\r\n                        \"\"\r\n                ),\r\n\t\t State = iff(LogType has \"events\",  tostring(extract(@\"state=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t AlarmId = iff(LogType has \"events\",  toint(extract(@\"alarm_id=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t DosCount = iff(LogType has \"events\",  tostring(extract(@\"dos_count=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t InterArrival = iff(LogType has \"events\",  tostring(extract(@\"inter_arrival=\\'(\\S+)\\'\",1,Substring)), dynamic(\"\")),\r\n\t\t LogTimestamp = case(\r\n                            isnotnull(column_ifexists(\"EventStartTime\",datetime(null))), column_ifexists(\"EventStartTime\",datetime(null)),\r\n                            LogType has \"security_event\", unixtime_seconds_todatetime(tolong(split(tostring(extract(@\"timestamp=(\\S+)\\s\",1,Substring)),\".\")[0])),\r\n                            LogType has \"ids-alerts\", unixtime_seconds_todatetime(tolong(split(tostring(extract(@\"timestamp=(\\S+)\\s\",1,Substring)),\".\")[0])),\r\n                            datetime(null)\r\n                        ),\r\n\t\t IpAddr = iff(LogType has \"events\", tostring(extract(@\"dhcp lease of ip ([\\d\\.]+)\", 1, Substring)), dynamic(\"\")),\r\n\t\t ServerMacAddr = iff(LogType has \"events\", tostring(extract(@\"server mac ([\\w\\:]+)\", 1, Substring)), dynamic(\"\")),\r\n\t\t RouterIpAddr = iff(LogType has \"events\", tostring(extract(@\"router ([\\d\\.]+)\", 1, Substring)), dynamic(\"\")),\r\n\t\t Subnet = iff(LogType has \"events\",  tostring(extract(@\"subnet ([\\d\\.]+)\", 1, Substring)), dynamic(\"\")),\r\n\t\t Dns = iff(LogType has \"events\",  split(extract(@\"dns ([\\d\\.\\,\\:\\s]+)\", 1, Substring), \", \"), dynamic(\"\"))\r\n| extend\r\n            ClientMacAddr = iif(isempty(ClientMacAddr), tostring(extract(@\"client mac ([\\w\\:]+)\", 1, Substring)), ClientMacAddr),\r\n\t\t    SrcPortNumber = iif(isempty(SrcPortNumber), toint(extract(@\"port=\\'(\\S+)\\'\",1,Substring)), SrcPortNumber),\r\n            Dns = iif(Dns[0] == \"\", \"\", Dns)\r\n| extend LogType = case(\r\n                    isnotempty(LogType), LogType,\r\n                    LogType !in (\"urls\", \"airmarshal_events\",\"security_event\",\"ids-alerts\", \"events\") and LogType !contains \"flows\", iif(isempty(LogType), \"\", LogType),\r\n                    \"\"\r\n                ),\r\n         NetworkProtocol = case(NetworkProtocol has \"tcp\", \"TCP\",\r\n                                NetworkProtocol has \"udp\", \"UDP\",\r\n                                \"\"),\r\n         EventSeverity = case(\r\n                             isnotempty(column_ifexists(\"EventSeverity\",\"\")), column_ifexists(\"EventSeverity\",\"\"),\r\n                              Priority == 1, \"High\",\r\n                              Priority == 2, \"Medium\",\r\n                              Priority == 3, \"Low\",\r\n                              Priority == 4, \"Infomational\",\r\n                              \"\"),\r\n        Disposition = case(\r\n                            EventType contains \"File Scanned\", tolower(column_ifexists(\"EventOriginalSeverity\",\"\")),\r\n                            LogType has \"security_event\", tostring(extract(@\"disposition=(\\w+)\",1,Substring)),\r\n                            \"\"\r\n                        ),\r\n        ThreatName = case(\r\n                            LogType has \"security_event\", tostring(extract(@\"name=(\\S+)\",1,Substring)),\r\n                            \"\"\r\n                        ),\r\n        Sha256 = case (\r\n                            EventType == \"File Scanned\", column_ifexists(\"Sha256\",\"\"),\r\n                            LogType has \"security_event\",  tostring(extract(@\"sha256=(\\S+)?\",1,Substring)),\r\n                            \"\"\r\n                        ),\r\n        Action = case(\r\n                            Action == \"block\", \"deny\",\r\n                            tolower(Action)\r\n            )\r\n| project-away Substring, Parser\r\n",
        "functionParameters": "",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "Cisco Meraki Data Parser"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId1')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
        "contentId": "[variables('_parserContentId1')]",
        "kind": "Parser",
        "version": "[variables('parserVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "CiscoMeraki",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MerakiConnector Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "CustomConnectorName": {
              "type": "String",
              "defaultValue": "MerakiConnector",
              "metadata": {
                "description": "Enter the name for Cisco Meraki custom connector without spaces"
              },
              "minLength": 3
            },
            "ApiKey": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Enter the API KEY for Cisco Meraki Dashboard API Service End"
              },
              "minLength": 4
            },
            "ServiceEndPoint": {
              "type": "String",
              "defaultValue": "https://api-mp.meraki.com/api/v1",
              "metadata": {
                "description": "Enter the Cisco Meraki Dashboard API Service End Point as 'https://{CiscoMerakiDomain}/api/{VersionNumber}'"
              },
              "minLength": 3
            }
          },
          "variables": {
            "ApiKey": "parameters('ApiKey')",
            "operationId-GetOrganizations": "GetOrganizations",
            "_operationId-GetOrganizations": "[[variables('operationId-GetOrganizations')]",
            "operationId-GetNetworks": "GetNetworks",
            "_operationId-GetNetworks": "[[variables('operationId-GetNetworks')]",
            "operationId-GetNetworkDevices": "GetNetworkDevices",
            "_operationId-GetNetworkDevices": "[[variables('operationId-GetNetworkDevices')]",
            "operationId-GetNetworkClients": "GetNetworkClients",
            "_operationId-GetNetworkClients": "[[variables('operationId-GetNetworkClients')]",
            "operationId-GetNetworkApplianceContentFiltering": "GetNetworkApplianceContentFiltering",
            "_operationId-GetNetworkApplianceContentFiltering": "[[variables('operationId-GetNetworkApplianceContentFiltering')]",
            "operationId-UpdateNetworkApplianceContentFiltering": "UpdateNetworkApplianceContentFiltering",
            "_operationId-UpdateNetworkApplianceContentFiltering": "[[variables('operationId-UpdateNetworkApplianceContentFiltering')]",
            "operationId-GetNetworkApplianceL3FirewallRules": "GetNetworkApplianceL3FirewallRules",
            "_operationId-GetNetworkApplianceL3FirewallRules": "[[variables('operationId-GetNetworkApplianceL3FirewallRules')]",
            "operationId-UpdateNetworkApplianceL3FirewallRules": "UpdateNetworkApplianceL3FirewallRules",
            "_operationId-UpdateNetworkApplianceL3FirewallRules": "[[variables('operationId-UpdateNetworkApplianceL3FirewallRules')]",
            "operationId-GetNetworkApplianceFirewallL7FirewallRules": "GetNetworkApplianceFirewallL7FirewallRules",
            "_operationId-GetNetworkApplianceFirewallL7FirewallRules": "[[variables('operationId-GetNetworkApplianceFirewallL7FirewallRules')]",
            "operationId-UpdateNetworkApplianceFirewallL7FirewallRules": "UpdateNetworkApplianceFirewallL7FirewallRules",
            "_operationId-UpdateNetworkApplianceFirewallL7FirewallRules": "[[variables('operationId-UpdateNetworkApplianceFirewallL7FirewallRules')]",
            "operationId-GetNetworkClientPolicy": "GetNetworkClientPolicy",
            "_operationId-GetNetworkClientPolicy": "[[variables('operationId-GetNetworkClientPolicy')]",
            "operationId-UpdateNetworkClientPolicy": "UpdateNetworkClientPolicy",
            "_operationId-UpdateNetworkClientPolicy": "[[variables('operationId-UpdateNetworkClientPolicy')]",
            "operationId-GetNetworkGroupPolicies": "GetNetworkGroupPolicies",
            "_operationId-GetNetworkGroupPolicies": "[[variables('operationId-GetNetworkGroupPolicies')]",
            "operationId-GetNetworkGroupPolicy": "GetNetworkGroupPolicy",
            "_operationId-GetNetworkGroupPolicy": "[[variables('operationId-GetNetworkGroupPolicy')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId1": "MerakiConnector",
            "playbookId1": "[[resourceId('Microsoft.Web/customApis', parameters('CustomConnectorName'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('CustomConnectorName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "connectionParameters": {
                  "api_key": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "API Key",
                      "description": "The API Key for this api",
                      "tooltip": "Provide your API Key",
                      "constraints": {
                        "tabIndex": 2,
                        "clearText": false,
                        "required": "true"
                      }
                    }
                  }
                },
                "brandColor": "#FFFFFF",
                "description": "Cisco Meraki custom connector connects to Meraki Dashboard API service endpoint and programmatically manages and monitors Meraki networks at scale.",
                "displayName": "[[parameters('CustomConnectorName')]",
                "backendService": {
                  "serviceUrl": "[[parameters('ServiceEndPoint')]"
                },
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "version": "1.0",
                    "title": "Meraki Dashboard API",
                    "description": "Cisco Meraki custom connector connects to Meraki Dashboard API service endpoint and programmatically manages and monitors Meraki networks at scale."
                  },
                  "host": "api.meraki.com",
                  "basePath": "/api/v1",
                  "schemes": [
                    "https"
                  ],
                  "consumes": [
                    "application/json"
                  ],
                  "produces": [
                    "application/json"
                  ],
                  "paths": {
                    "/organizations": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "id": {
                                    "type": "string",
                                    "description": "id",
                                    "title": "Organization Id"
                                  },
                                  "name": {
                                    "type": "string",
                                    "description": "name",
                                    "title": "Organization Name"
                                  },
                                  "url": {
                                    "type": "string",
                                    "description": "url",
                                    "title": "Organization URL"
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get Organizations",
                        "operationId": "[[variables('_operationId-GetOrganizations')]",
                        "description": "List the organizations that the user has privileges on"
                      }
                    },
                    "/organizations/{organizationId}/networks": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "id": {
                                    "type": "string",
                                    "description": "id",
                                    "title": "Network Id"
                                  },
                                  "organizationId": {
                                    "type": "string",
                                    "description": "organizationId",
                                    "title": "Organization Id"
                                  },
                                  "name": {
                                    "type": "string",
                                    "description": "name",
                                    "title": "Network Name"
                                  },
                                  "timeZone": {
                                    "type": "string",
                                    "description": "timeZone",
                                    "title": "Time Zone"
                                  },
                                  "tags": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "description": "tags",
                                    "title": "Tags"
                                  },
                                  "productTypes": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "description": "productTypes",
                                    "title": "Product Types"
                                  },
                                  "enrollmentString": {
                                    "type": "string",
                                    "description": "enrollmentString",
                                    "title": "Enrollment String"
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get Networks",
                        "description": "List the networks that the user has privileges on in an organization",
                        "operationId": "[[variables('_operationId-GetNetworks')]",
                        "parameters": [
                          {
                            "name": "organizationId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Organization Id",
                            "x-ms-summary": "Organization Id"
                          },
                          {
                            "name": "configTemplateId",
                            "in": "query",
                            "required": false,
                            "type": "string",
                            "x-ms-summary": "Config Template Id",
                            "description": "An optional parameter that is the ID of a config template. Will return all networks bound to that template."
                          },
                          {
                            "name": "tags",
                            "in": "query",
                            "required": false,
                            "type": "string",
                            "description": "An optional parameter to filter networks by tags. The filtering is case-sensitive. If tags are included tagsFilterType should also be included.",
                            "x-ms-summary": "Tags"
                          },
                          {
                            "name": "tagsFilterType",
                            "in": "query",
                            "required": false,
                            "type": "string",
                            "x-ms-summary": "Tag          Filter Type",
                            "description": "An optional parameter of value withAnyTags or withAllTags to indicate whether to return networks which contain ANY or ALL of the included tags. If no type is included withAnyTags will be selected."
                          },
                          {
                            "name": "perPage",
                            "in": "query",
                            "required": false,
                            "type": "integer",
                            "default": 1000,
                            "x-ms-summary": "Per Page",
                            "description": "The number of entries per page returned. Acceptable range is 3 - 100000."
                          },
                          {
                            "name": "startingAfter",
                            "in": "query",
                            "required": false,
                            "type": "string",
                            "x-ms-summary": "Starting          After",
                            "description": "A token used by the server to indicate the start of the page. Often this is a timestamp or an ID but it is not limited to those. This parameter should not be defined by client applications. The link for the first last prev or next page in the HTTP Link header should define it."
                          },
                          {
                            "name": "endingBefore",
                            "in": "query",
                            "required": false,
                            "type": "string",
                            "x-ms-summary": "Ending          Before",
                            "description": "A token used by the server to indicate the end of the page. Often this is a timestamp or an ID but it is not limited to those. This parameter should not be defined by client applications. The link for the first last prev or next page in the HTTP Link header should define it."
                          }
                        ]
                      }
                    },
                    "/networks/{networkId}/devices": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "name": {
                                    "type": "string",
                                    "description": "name",
                                    "title": "Device Name"
                                  },
                                  "lat": {
                                    "type": "number",
                                    "format": "float",
                                    "description": "lat",
                                    "title": "Latitude"
                                  },
                                  "lng": {
                                    "type": "number",
                                    "format": "float",
                                    "description": "lng",
                                    "title": "Longitude"
                                  },
                                  "serial": {
                                    "type": "string",
                                    "description": "serial",
                                    "title": "Serial"
                                  },
                                  "mac": {
                                    "type": "string",
                                    "description": "mac",
                                    "title": "MAC"
                                  },
                                  "model": {
                                    "type": "string",
                                    "description": "model",
                                    "title": "Model"
                                  },
                                  "address": {
                                    "type": "string",
                                    "description": "address",
                                    "title": "Address"
                                  },
                                  "notes": {
                                    "type": "string",
                                    "description": "notes",
                                    "title": "Notes"
                                  },
                                  "lanIp": {
                                    "type": "string",
                                    "description": "lanIp",
                                    "title": "LAN IP Address"
                                  },
                                  "tags": {
                                    "type": "array",
                                    "items": {
                                      "type": "string"
                                    },
                                    "description": "tags",
                                    "title": "Tags"
                                  },
                                  "networkId": {
                                    "type": "string",
                                    "description": "networkId",
                                    "title": "Network Id"
                                  },
                                  "beaconIdParams": {
                                    "type": "object",
                                    "properties": {
                                      "uuid": {
                                        "type": "string",
                                        "description": "uuid",
                                        "title": "UUID"
                                      },
                                      "major": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "major",
                                        "title": "Major"
                                      },
                                      "minor": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "minor",
                                        "title": "Minor"
                                      }
                                    },
                                    "description": "beaconIdParams",
                                    "title": "Beacon Id Parameters"
                                  },
                                  "firmware": {
                                    "type": "string",
                                    "description": "firmware",
                                    "title": "Firmware"
                                  },
                                  "floorPlanId": {
                                    "type": "string",
                                    "description": "floorPlanId",
                                    "title": "Floor Plan Id"
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get Network Devices",
                        "description": "List the devices in a network",
                        "operationId": "[[variables('_operationId-GetNetworkDevices')]",
                        "parameters": [
                          {
                            "name": "networkId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Network Id",
                            "x-ms-summary": "Network Id"
                          }
                        ]
                      }
                    },
                    "/networks/{networkId}/clients": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "usage": {
                                    "type": "object",
                                    "properties": {
                                      "sent": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "sent",
                                        "title": "Usage Sent"
                                      },
                                      "recv": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "recv",
                                        "title": "Usage Receive"
                                      }
                                    },
                                    "description": "usage",
                                    "title": "Usage"
                                  },
                                  "id": {
                                    "type": "string",
                                    "description": "id",
                                    "title": "Client Id"
                                  },
                                  "description": {
                                    "type": "string",
                                    "description": "description",
                                    "title": "Description"
                                  },
                                  "mac": {
                                    "type": "string",
                                    "description": "mac",
                                    "title": "MAC"
                                  },
                                  "ip": {
                                    "type": "string",
                                    "description": "ip",
                                    "title": "IP Address"
                                  },
                                  "user": {
                                    "type": "string",
                                    "description": "user",
                                    "title": "User"
                                  },
                                  "vlan": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "vlan",
                                    "title": "VLAN"
                                  },
                                  "switchport": {
                                    "type": "string",
                                    "description": "switchport",
                                    "title": "Switch Port"
                                  },
                                  "adaptivePolicyGroup": {
                                    "type": "string",
                                    "description": "adaptivePolicyGroup",
                                    "title": "Adaptive Policy Group"
                                  },
                                  "ip6": {
                                    "type": "string",
                                    "description": "ip6",
                                    "title": "IP6"
                                  },
                                  "firstSeen": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "firstSeen",
                                    "title": "First Seen"
                                  },
                                  "lastSeen": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "lastSeen",
                                    "title": "Last Seen"
                                  },
                                  "manufacturer": {
                                    "type": "string",
                                    "description": "manufacturer",
                                    "title": "Manufacturer"
                                  },
                                  "os": {
                                    "type": "string",
                                    "description": "os",
                                    "title": "OS"
                                  },
                                  "recentDeviceSerial": {
                                    "type": "string",
                                    "description": "recentDeviceSerial",
                                    "title": "Recent Device Serial"
                                  },
                                  "recentDeviceName": {
                                    "type": "string",
                                    "description": "recentDeviceName",
                                    "title": "Recent Device Name"
                                  },
                                  "recentDeviceMac": {
                                    "type": "string",
                                    "description": "recentDeviceMac",
                                    "title": "Recent Device MAC"
                                  },
                                  "recentDeviceConnection": {
                                    "type": "string",
                                    "description": "recentDeviceConnection",
                                    "title": "Recent Device Connection"
                                  },
                                  "ssid": {
                                    "type": "string",
                                    "description": "ssid",
                                    "title": "SSID"
                                  },
                                  "status": {
                                    "type": "string",
                                    "description": "status",
                                    "title": "Status"
                                  },
                                  "notes": {
                                    "type": "string",
                                    "description": "notes",
                                    "title": "Notes"
                                  },
                                  "ip6Local": {
                                    "type": "string",
                                    "description": "ip6Local",
                                    "title": "IP6 Local"
                                  },
                                  "smInstalled": {
                                    "type": "boolean",
                                    "description": "smInstalled",
                                    "title": "SM Installed",
                                    "enum": [
                                      "",
                                      "true",
                                      "false"
                                    ]
                                  },
                                  "groupPolicy8021x": {
                                    "type": "string",
                                    "description": "groupPolicy8021x",
                                    "title": "Group Policy 8021x"
                                  }
                                }
                              }
                            }
                          }
                        },
                        "description": "List the clients that have used this network in the timespan",
                        "summary": "Get Network Clients",
                        "operationId": "[[variables('_operationId-GetNetworkClients')]",
                        "parameters": [
                          {
                            "name": "networkId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Network Id",
                            "x-ms-summary": "Network Id"
                          },
                          {
                            "name": "t0",
                            "in": "query",
                            "required": false,
                            "type": "string",
                            "description": "The beginning of the timespan for the data. The maximum lookback period is 31 days from today.",
                            "x-ms-summary": "Timespan Beginning"
                          },
                          {
                            "name": "timespan",
                            "in": "query",
                            "required": false,
                            "type": "number",
                            "x-ms-summary": "Timespan",
                            "description": "The timespan for which the information will be fetched. If specifying timespan do not specify parameter t0. The value must be in seconds and be less than or equal to 31 days. The default is 1 day."
                          },
                          {
                            "name": "perPage",
                            "in": "query",
                            "required": false,
                            "type": "integer",
                            "default": 10,
                            "description": "The number of entries per page returned. Acceptable range is 3 - 1000.",
                            "x-ms-summary": "Per Page"
                          },
                          {
                            "name": "startingAfter",
                            "in": "query",
                            "required": false,
                            "type": "string",
                            "x-ms-summary": "Starting After",
                            "description": "A token used by the server to indicate the start of the page. Often this is a timestamp or an ID but it is not limited to those. This parameter should not be defined by client applications. The link for the first last prev or next page in the HTTP Link header should define it."
                          },
                          {
                            "name": "endingBefore",
                            "in": "query",
                            "required": false,
                            "type": "string",
                            "x-ms-summary": "Ending Before",
                            "description": "A token used by the server to indicate the end of the page. Often this is a timestamp or an ID but it is not limited to those. This parameter should not be defined by client applications. The link for the first last prev or next page in the HTTP Link header should define it."
                          }
                        ]
                      }
                    },
                    "/networks/{networkId}/appliance/contentFiltering": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "allowedUrlPatterns": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "allowedUrlPatterns",
                                  "title": "Allowrd URL Patterns"
                                },
                                "blockedUrlPatterns": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "blockedUrlPatterns",
                                  "title": "Blocked URL Patterns"
                                },
                                "blockedUrlCategories": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "id": {
                                        "type": "string",
                                        "description": "id",
                                        "title": "Category Id"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "name",
                                        "title": "Category Name"
                                      }
                                    }
                                  },
                                  "description": "blockedUrlCategories",
                                  "title": "Blocked URL Categories"
                                },
                                "urlCategoryListSize": {
                                  "type": "string",
                                  "description": "urlCategoryListSize",
                                  "title": "URL Category List Size"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get Network Appliance Content Filtering",
                        "description": "Return the content filtering settings for an MX network",
                        "operationId": "[[variables('_operationId-GetNetworkApplianceContentFiltering')]",
                        "parameters": [
                          {
                            "name": "networkId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Network Id",
                            "x-ms-summary": "Network Id"
                          }
                        ]
                      },
                      "put": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "allowedUrlPatterns": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "allowedUrlPatterns",
                                  "title": "Allowed URL Patterns"
                                },
                                "blockedUrlPatterns": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "blockedUrlPatterns",
                                  "title": "Blocked URL Patterns"
                                },
                                "blockedUrlCategories": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "id": {
                                        "type": "string",
                                        "description": "id",
                                        "title": "Category Id"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "name",
                                        "title": "Category Name"
                                      }
                                    }
                                  },
                                  "description": "blockedUrlCategories",
                                  "title": "Blocked URL Categories"
                                },
                                "urlCategoryListSize": {
                                  "type": "string",
                                  "description": "urlCategoryListSize",
                                  "title": "URL Category List Size"
                                }
                              }
                            }
                          }
                        },
                        "description": "Update the content filtering settings for an MX network",
                        "summary": "Update Network Appliance Content Filtering",
                        "operationId": "[[variables('_operationId-UpdateNetworkApplianceContentFiltering')]",
                        "parameters": [
                          {
                            "name": "networkId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Network Id",
                            "x-ms-summary": "Network Id"
                          },
                          {
                            "name": "Content-Type",
                            "in": "header",
                            "required": true,
                            "type": "string",
                            "default": "application/json",
                            "description": "The content type of the request",
                            "x-ms-summary": "Content Type",
                            "x-ms-visibility": "internal"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "allowedUrlPatterns": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "A list of URL patterns that are allowed",
                                  "title": "Allowed URL Patterns"
                                },
                                "blockedUrlPatterns": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "A list of URL patterns that are blocked",
                                  "title": "Blocked URL Patterns"
                                },
                                "blockedUrlCategories": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "A list of URL categories to block",
                                  "title": "Blocked URL Categories"
                                },
                                "urlCategoryListSize": {
                                  "type": "string",
                                  "description": "URL category list size (topSites or fullList)",
                                  "title": "URL Category List Size",
                                  "enum": [
                                    "topSites",
                                    "fullList"
                                  ],
                                  "default": "topSites"
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "/networks/{networkId}/appliance/firewall/l3FirewallRules": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "rules": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "comment": {
                                        "type": "string",
                                        "description": "comment",
                                        "title": "Comment"
                                      },
                                      "policy": {
                                        "type": "string",
                                        "description": "policy",
                                        "title": "Policy"
                                      },
                                      "protocol": {
                                        "type": "string",
                                        "description": "protocol",
                                        "title": "Protocol"
                                      },
                                      "destPort": {
                                        "type": "string",
                                        "description": "destPort",
                                        "title": "Destination Port"
                                      },
                                      "destCidr": {
                                        "type": "string",
                                        "description": "destCidr",
                                        "title": "Destination IP Address"
                                      },
                                      "srcPort": {
                                        "type": "string",
                                        "description": "srcPort",
                                        "title": "Source Port"
                                      },
                                      "srcCidr": {
                                        "type": "string",
                                        "description": "srcCidr",
                                        "title": "Source IP Address"
                                      },
                                      "syslogEnabled": {
                                        "type": "boolean",
                                        "description": "syslogEnabled",
                                        "title": "Syslog Enabled"
                                      }
                                    }
                                  },
                                  "description": "rules",
                                  "title": "Rules"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get Network Appliance Firewall L3 Firewall Rules",
                        "description": "Return the L3 firewall rules for an MX network",
                        "operationId": "[[variables('_operationId-GetNetworkApplianceL3FirewallRules')]",
                        "parameters": [
                          {
                            "name": "networkId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Network Id",
                            "x-ms-summary": "Network Id"
                          }
                        ]
                      },
                      "put": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "rules": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "comment": {
                                        "type": "string",
                                        "description": "comment",
                                        "title": "Comment"
                                      },
                                      "policy": {
                                        "type": "string",
                                        "description": "policy",
                                        "title": "Policy"
                                      },
                                      "protocol": {
                                        "type": "string",
                                        "description": "protocol",
                                        "title": "Protocol"
                                      },
                                      "destPort": {
                                        "type": "string",
                                        "description": "destPort",
                                        "title": "Destination Port"
                                      },
                                      "destCidr": {
                                        "type": "string",
                                        "description": "destCidr",
                                        "title": "Destination IP Address"
                                      },
                                      "srcPort": {
                                        "type": "string",
                                        "description": "srcPort",
                                        "title": "Source Port"
                                      },
                                      "srcCidr": {
                                        "type": "string",
                                        "description": "srcCidr",
                                        "title": "Source IP Address"
                                      },
                                      "syslogEnabled": {
                                        "type": "boolean",
                                        "description": "syslogEnabled",
                                        "title": "Syslog Enabled"
                                      }
                                    }
                                  },
                                  "description": "rules",
                                  "title": "Rules"
                                }
                              }
                            }
                          }
                        },
                        "description": "Update the L3 firewall rules of an MX network",
                        "summary": "Update Network Appliance L3 Firewall Rules",
                        "operationId": "[[variables('_operationId-UpdateNetworkApplianceL3FirewallRules')]",
                        "parameters": [
                          {
                            "name": "networkId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Network Id",
                            "x-ms-summary": "Network Id"
                          },
                          {
                            "name": "Content-Type",
                            "in": "header",
                            "required": true,
                            "type": "string",
                            "default": "application/json",
                            "description": "The Content Type of the request",
                            "x-ms-summary": "Content Type",
                            "x-ms-visibility": "internal"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "rules": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "comment": {
                                        "type": "string",
                                        "description": "Description of the rule",
                                        "title": "Comment"
                                      },
                                      "policy": {
                                        "type": "string",
                                        "description": "allow or deny traffic specified by the rule",
                                        "title": "Policy",
                                        "enum": [
                                          "allow",
                                          "deny"
                                        ]
                                      },
                                      "protocol": {
                                        "type": "string",
                                        "description": "The type of protocol (tcp, udp, icmp or any)",
                                        "title": "Protocol",
                                        "enum": [
                                          "tcp",
                                          "udp",
                                          "icmp",
                                          "any"
                                        ]
                                      },
                                      "destPort": {
                                        "type": "string",
                                        "description": "Comma-separated list of destination port(s) (integer in the range 1-65535) or any",
                                        "title": "Destination Port"
                                      },
                                      "destCidr": {
                                        "type": "string",
                                        "description": "Comma-separated list of destination IP address(es) (in IP or CIDR notation) fully-qualified domain names (FQDN) or any",
                                        "title": "Destination IP Address"
                                      },
                                      "srcPort": {
                                        "type": "string",
                                        "description": "Comma-separated list of source IP address(es) (in IP or CIDR notation) or any (FQDN not supported for source addresses)",
                                        "title": "Source Port"
                                      },
                                      "srcCidr": {
                                        "type": "string",
                                        "description": "Comma-separated list of source port(s) (integer in the range 1-65535) or any",
                                        "title": "Source IP Address"
                                      },
                                      "syslogEnabled": {
                                        "type": "boolean",
                                        "description": "Log this rule to syslog (true or false - boolean value) - only applicable if a syslog has been configured",
                                        "title": "Syslog Enabled",
                                        "enum": [
                                          true,
                                          false
                                        ],
                                        "default": false
                                      }
                                    },
                                    "required": [
                                      "destCidr",
                                      "destPort",
                                      "policy",
                                      "protocol",
                                      "srcCidr",
                                      "srcPort"
                                    ]
                                  },
                                  "description": "rules",
                                  "title": "Rules"
                                }
                              },
                              "required": [
                                "rules"
                              ]
                            }
                          }
                        ]
                      }
                    },
                    "/networks/{networkId}/appliance/firewall/l7FirewallRules": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "rules": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "policy": {
                                        "type": "string",
                                        "description": "policy",
                                        "title": "Policy"
                                      },
                                      "type": {
                                        "type": "string",
                                        "description": "type",
                                        "title": "Type"
                                      },
                                      "value": {
                                        "type": "array",
                                        "items": {
                                          "type": "string"
                                        },
                                        "description": "value",
                                        "title": "Value"
                                      }
                                    }
                                  },
                                  "description": "rules",
                                  "title": "Rules"
                                }
                              }
                            }
                          }
                        },
                        "operationId": "[[variables('_operationId-GetNetworkApplianceFirewallL7FirewallRules')]",
                        "description": "List the MX L7 firewall rules for an MX network",
                        "summary": "Get Network Appliance Firewall L7 Firewall Rules",
                        "parameters": [
                          {
                            "name": "networkId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "x-ms-summary": "Network Id",
                            "description": "Network Id"
                          }
                        ]
                      },
                      "put": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "rules": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "policy": {
                                        "type": "string",
                                        "description": "policy",
                                        "title": "Policy"
                                      },
                                      "type": {
                                        "type": "string",
                                        "description": "type",
                                        "title": "Type"
                                      },
                                      "value": {
                                        "type": "array",
                                        "items": {
                                          "type": "string"
                                        },
                                        "description": "value",
                                        "title": "Value"
                                      }
                                    }
                                  },
                                  "description": "rules",
                                  "title": "Rules"
                                }
                              }
                            }
                          }
                        },
                        "operationId": "[[variables('_operationId-UpdateNetworkApplianceFirewallL7FirewallRules')]",
                        "summary": "Update Network Appliance Firewall L7 Firewall Rules",
                        "description": "Update the MX L7 firewall rules for an MX network",
                        "parameters": [
                          {
                            "name": "networkId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Network Id",
                            "x-ms-summary": "Network Id"
                          },
                          {
                            "name": "Content-Type",
                            "in": "header",
                            "required": true,
                            "type": "string",
                            "default": "application/json",
                            "x-ms-summary": "Content Type",
                            "x-ms-visibility": "internal",
                            "description": "The content type of the request"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "rules": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "policy": {
                                        "type": "string",
                                        "description": "Deny traffic specified by rule",
                                        "title": "Policy",
                                        "default": "deny"
                                      },
                                      "type": {
                                        "type": "string",
                                        "description": "Type of the L7 rule (application, applicationCategory, host, port, ipRange)",
                                        "title": "Type",
                                        "enum": [
                                          "application",
                                          "applicationCategory",
                                          "host",
                                          "port",
                                          "ipRange"
                                        ]
                                      },
                                      "value": {
                                        "type": "array",
                                        "items": {
                                          "type": "string"
                                        },
                                        "description": "The value of what you want to block. Format of value varies depending on type of the rule.",
                                        "title": "Value"
                                      }
                                    }
                                  },
                                  "description": "An ordered array of the MX L7 firewall rules",
                                  "title": "Rules"
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "/networks/{networkId}/clients/{clientId}/policy": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "mac": {
                                  "type": "string",
                                  "description": "mac",
                                  "title": "MAC"
                                },
                                "devicePolicy": {
                                  "type": "string",
                                  "description": "devicePolicy",
                                  "title": "Device Policy"
                                },
                                "groupPolicyId": {
                                  "type": "string",
                                  "description": "groupPolicyId",
                                  "title": "Group Policy Id"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get Network Client Policy",
                        "description": "Return the policy assigned to a client on the network. Clients can be identified by a client key or either the MAC or IP depending on whether the network uses Track-by-IP.",
                        "operationId": "[[variables('_operationId-GetNetworkClientPolicy')]",
                        "parameters": [
                          {
                            "name": "networkId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Network Id",
                            "x-ms-summary": "Network Id"
                          },
                          {
                            "name": "clientId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Client Id",
                            "x-ms-summary": "Client Id"
                          }
                        ]
                      },
                      "put": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "mac": {
                                  "type": "string",
                                  "description": "mac",
                                  "title": "MAC"
                                },
                                "devicePolicy": {
                                  "type": "string",
                                  "description": "devicePolicy",
                                  "title": "Device Policy"
                                },
                                "groupPolicyId": {
                                  "type": "string",
                                  "description": "groupPolicyId",
                                  "title": "Group Policy Id"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Update Network Client Policy",
                        "operationId": "[[variables('_operationId-UpdateNetworkClientPolicy')]",
                        "description": "Update the policy assigned to a client on the network. Clients can be identified by a client key or either the MAC or IP depending on whether the network uses Track-by-IP",
                        "parameters": [
                          {
                            "name": "networkId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Network Id",
                            "x-ms-summary": "Network Id"
                          },
                          {
                            "name": "clientId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Client Id",
                            "x-ms-summary": "Client Id"
                          },
                          {
                            "name": "Content-Type",
                            "in": "header",
                            "required": true,
                            "type": "string",
                            "default": "application/json",
                            "x-ms-summary": "Content Type",
                            "x-ms-visibility": "internal",
                            "description": "The content type of the request"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "devicePolicy": {
                                  "type": "string",
                                  "description": "The policy to assign (Whitelisted, Blocked, Normal, Group policy)",
                                  "title": "Device Policy",
                                  "enum": [
                                    "Whitelisted",
                                    "Blocked",
                                    "Normal",
                                    "Group policy"
                                  ]
                                },
                                "groupPolicyId": {
                                  "type": "string",
                                  "description": "If devicePolicy is set to Group policy this param is used to specify the group policy ID",
                                  "title": "Group Policy Id"
                                }
                              },
                              "required": [
                                "devicePolicy"
                              ]
                            }
                          }
                        ]
                      }
                    },
                    "/networks/{networkId}/groupPolicies": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "name": {
                                    "type": "string",
                                    "description": "name",
                                    "title": "Group Policy Name"
                                  },
                                  "groupPolicyId": {
                                    "type": "string",
                                    "description": "groupPolicyId",
                                    "title": "Group Policy Id"
                                  },
                                  "scheduling": {
                                    "type": "object",
                                    "properties": {
                                      "enabled": {
                                        "type": "boolean",
                                        "description": "enabled",
                                        "title": "Enabled"
                                      },
                                      "monday": {
                                        "type": "object",
                                        "properties": {
                                          "active": {
                                            "type": "boolean",
                                            "description": "active",
                                            "title": "Active"
                                          },
                                          "from": {
                                            "type": "string",
                                            "description": "from",
                                            "title": "From"
                                          },
                                          "to": {
                                            "type": "string",
                                            "description": "to",
                                            "title": "To"
                                          }
                                        },
                                        "description": "monday",
                                        "title": "Monday"
                                      },
                                      "tuesday": {
                                        "type": "object",
                                        "properties": {
                                          "active": {
                                            "type": "boolean",
                                            "description": "active",
                                            "title": "Active"
                                          },
                                          "from": {
                                            "type": "string",
                                            "description": "from",
                                            "title": "From"
                                          },
                                          "to": {
                                            "type": "string",
                                            "description": "to",
                                            "title": "To"
                                          }
                                        },
                                        "description": "tuesday",
                                        "title": "Tuesday"
                                      },
                                      "wednesday": {
                                        "type": "object",
                                        "properties": {
                                          "active": {
                                            "type": "boolean",
                                            "description": "active",
                                            "title": "Active"
                                          },
                                          "from": {
                                            "type": "string",
                                            "description": "from",
                                            "title": "From"
                                          },
                                          "to": {
                                            "type": "string",
                                            "description": "to",
                                            "title": "To"
                                          }
                                        },
                                        "description": "wednesday",
                                        "title": "Wednesday"
                                      },
                                      "thursday": {
                                        "type": "object",
                                        "properties": {
                                          "active": {
                                            "type": "boolean",
                                            "description": "active",
                                            "title": "Active"
                                          },
                                          "from": {
                                            "type": "string",
                                            "description": "from",
                                            "title": "From"
                                          },
                                          "to": {
                                            "type": "string",
                                            "description": "to",
                                            "title": "To"
                                          }
                                        },
                                        "description": "thursday",
                                        "title": "Thursday"
                                      },
                                      "friday": {
                                        "type": "object",
                                        "properties": {
                                          "active": {
                                            "type": "boolean",
                                            "description": "active",
                                            "title": "Active"
                                          },
                                          "from": {
                                            "type": "string",
                                            "description": "from",
                                            "title": "From"
                                          },
                                          "to": {
                                            "type": "string",
                                            "description": "to",
                                            "title": "To"
                                          }
                                        },
                                        "description": "friday",
                                        "title": "Friday"
                                      },
                                      "saturday": {
                                        "type": "object",
                                        "properties": {
                                          "active": {
                                            "type": "boolean",
                                            "description": "active",
                                            "title": "Active"
                                          },
                                          "from": {
                                            "type": "string",
                                            "description": "from",
                                            "title": "From"
                                          },
                                          "to": {
                                            "type": "string",
                                            "description": "to",
                                            "title": "To"
                                          }
                                        },
                                        "description": "saturday",
                                        "title": "Saturday"
                                      },
                                      "sunday": {
                                        "type": "object",
                                        "properties": {
                                          "active": {
                                            "type": "boolean",
                                            "description": "active",
                                            "title": "Active"
                                          },
                                          "from": {
                                            "type": "string",
                                            "description": "from",
                                            "title": "From"
                                          },
                                          "to": {
                                            "type": "string",
                                            "description": "to",
                                            "title": "To"
                                          }
                                        },
                                        "description": "sunday",
                                        "title": "Sunday"
                                      }
                                    },
                                    "description": "scheduling",
                                    "title": "Scheduling"
                                  },
                                  "bandwidth": {
                                    "type": "object",
                                    "properties": {
                                      "settings": {
                                        "type": "string",
                                        "description": "settings",
                                        "title": "Settings"
                                      },
                                      "bandwidthLimits": {
                                        "type": "object",
                                        "properties": {
                                          "limitUp": {
                                            "type": "integer",
                                            "format": "int32",
                                            "description": "limitUp",
                                            "title": "Limit Up"
                                          },
                                          "limitDown": {
                                            "type": "integer",
                                            "format": "int32",
                                            "description": "limitDown",
                                            "title": "Limit Down"
                                          }
                                        },
                                        "description": "bandwidthLimits",
                                        "title": "Bandwidth Limits"
                                      }
                                    },
                                    "description": "bandwidth",
                                    "title": "Bandwidth"
                                  },
                                  "firewallAndTrafficShaping": {
                                    "type": "object",
                                    "properties": {
                                      "settings": {
                                        "type": "string",
                                        "description": "settings",
                                        "title": "Settings"
                                      },
                                      "trafficShapingRules": {
                                        "type": "array",
                                        "items": {
                                          "type": "object",
                                          "properties": {
                                            "definitions": {
                                              "type": "array",
                                              "items": {
                                                "type": "object",
                                                "properties": {
                                                  "type": {
                                                    "type": "string",
                                                    "description": "type",
                                                    "title": "Type"
                                                  },
                                                  "value": {
                                                    "type": "object",
                                                    "properties": {
                                                      "id": {
                                                        "type": "string",
                                                        "description": "id",
                                                        "title": "Id"
                                                      },
                                                      "name": {
                                                        "type": "string",
                                                        "description": "name",
                                                        "title": "Name"
                                                      }
                                                    },
                                                    "description": "value",
                                                    "title": "Value"
                                                  }
                                                }
                                              },
                                              "description": "definitions",
                                              "title": "Definitions"
                                            },
                                            "perClientBandwidthLimits": {
                                              "type": "object",
                                              "properties": {
                                                "settings": {
                                                  "type": "string",
                                                  "description": "settings",
                                                  "title": "Settings"
                                                },
                                                "bandwidthLimits": {
                                                  "type": "object",
                                                  "properties": {
                                                    "limitUp": {
                                                      "type": "integer",
                                                      "format": "int32",
                                                      "description": "limitUp",
                                                      "title": "Limit Up"
                                                    },
                                                    "limitDown": {
                                                      "type": "integer",
                                                      "format": "int32",
                                                      "description": "limitDown",
                                                      "title": "Limit Down"
                                                    }
                                                  },
                                                  "description": "bandwidthLimits",
                                                  "title": "Bandwidth Limits"
                                                }
                                              },
                                              "description": "perClientBandwidthLimits",
                                              "title": "Per Client Bandwidth Limits"
                                            },
                                            "dscpTagValue": {
                                              "type": "string",
                                              "description": "dscpTagValue",
                                              "title": "DSCP Tag Value"
                                            },
                                            "pcpTagValue": {
                                              "type": "string",
                                              "description": "pcpTagValue",
                                              "title": "PCP Tag Value"
                                            }
                                          }
                                        },
                                        "description": "trafficShapingRules",
                                        "title": "Traffic Shaping Rules"
                                      },
                                      "l3FirewallRules": {
                                        "type": "array",
                                        "items": {
                                          "type": "object",
                                          "properties": {
                                            "comment": {
                                              "type": "string",
                                              "description": "comment",
                                              "title": "Comment"
                                            },
                                            "policy": {
                                              "type": "string",
                                              "description": "policy",
                                              "title": "Policy"
                                            },
                                            "protocol": {
                                              "type": "string",
                                              "description": "protocol",
                                              "title": "Protocol"
                                            },
                                            "destPort": {
                                              "type": "integer",
                                              "format": "int32",
                                              "description": "destPort",
                                              "title": "Destination Port"
                                            },
                                            "destCidr": {
                                              "type": "string",
                                              "description": "destCidr",
                                              "title": "Destination Cidr"
                                            }
                                          }
                                        },
                                        "description": "l3FirewallRules",
                                        "title": "L3 Firewall Rules"
                                      },
                                      "l7FirewallRules": {
                                        "type": "array",
                                        "items": {
                                          "type": "object",
                                          "properties": {
                                            "policy": {
                                              "type": "string",
                                              "description": "policy",
                                              "title": "Policy"
                                            },
                                            "type": {
                                              "type": "string",
                                              "description": "type",
                                              "title": "Type"
                                            },
                                            "value": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "description": "value",
                                              "title": "Value"
                                            }
                                          }
                                        },
                                        "description": "l7FirewallRules",
                                        "title": "L7 Firewall Rules"
                                      }
                                    },
                                    "description": "firewallAndTrafficShaping",
                                    "title": "Firewall And Traffic Shaping"
                                  },
                                  "contentFiltering": {
                                    "type": "object",
                                    "properties": {
                                      "allowedUrlPatterns": {
                                        "type": "object",
                                        "properties": {
                                          "settings": {
                                            "type": "string",
                                            "description": "settings",
                                            "title": "Settings"
                                          },
                                          "patterns": {
                                            "type": "array",
                                            "items": {
                                              "type": "string"
                                            },
                                            "description": "patterns",
                                            "title": "Patterns"
                                          }
                                        },
                                        "description": "allowedUrlPatterns",
                                        "title": "Allowed URL Patterns"
                                      },
                                      "blockedUrlPatterns": {
                                        "type": "object",
                                        "properties": {
                                          "settings": {
                                            "type": "string",
                                            "description": "settings",
                                            "title": "Settings"
                                          },
                                          "patterns": {
                                            "type": "array",
                                            "items": {
                                              "type": "string"
                                            },
                                            "description": "patterns",
                                            "title": "Patterns"
                                          }
                                        },
                                        "description": "blockedUrlPatterns",
                                        "title": "Blocked URL Patterns"
                                      },
                                      "blockedUrlCategories": {
                                        "type": "object",
                                        "properties": {
                                          "settings": {
                                            "type": "string",
                                            "description": "settings",
                                            "title": "Settings"
                                          },
                                          "categories": {
                                            "type": "array",
                                            "items": {
                                              "type": "string"
                                            },
                                            "description": "categories",
                                            "title": "Categories"
                                          }
                                        },
                                        "description": "blockedUrlCategories",
                                        "title": "Blocked URL Categories"
                                      }
                                    },
                                    "description": "contentFiltering",
                                    "title": "Content Filtering"
                                  },
                                  "splashAuthSettings": {
                                    "type": "string",
                                    "description": "splashAuthSettings",
                                    "title": "Splash Auth Settings"
                                  },
                                  "vlanTagging": {
                                    "type": "object",
                                    "properties": {
                                      "settings": {
                                        "type": "string",
                                        "description": "settings",
                                        "title": "Settings"
                                      },
                                      "vlanId": {
                                        "type": "string",
                                        "description": "vlanId",
                                        "title": "VLAN Id"
                                      }
                                    },
                                    "description": "vlanTagging",
                                    "title": "VLAN Tagging"
                                  },
                                  "bonjourForwarding": {
                                    "type": "object",
                                    "properties": {
                                      "settings": {
                                        "type": "string",
                                        "description": "settings",
                                        "title": "Settings"
                                      },
                                      "rules": {
                                        "type": "array",
                                        "items": {
                                          "type": "object",
                                          "properties": {
                                            "description": {
                                              "type": "string",
                                              "description": "description",
                                              "title": "Description"
                                            },
                                            "vlanId": {
                                              "type": "string",
                                              "description": "vlanId",
                                              "title": "VLAN Id"
                                            },
                                            "services": {
                                              "type": "array",
                                              "items": {
                                                "type": "string"
                                              },
                                              "description": "services",
                                              "title": "Services"
                                            }
                                          }
                                        },
                                        "description": "rules",
                                        "title": "Rules"
                                      }
                                    },
                                    "description": "bonjourForwarding",
                                    "title": "Bonjour Forwarding"
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get Network Group Policies",
                        "description": "List the group policies in a network",
                        "operationId": "[[variables('_operationId-GetNetworkGroupPolicies')]",
                        "parameters": [
                          {
                            "name": "networkId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Network Id",
                            "x-ms-summary": "Network Id"
                          }
                        ]
                      }
                    },
                    "/networks/{networkId}/groupPolicies/{groupPolicyId}": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "name": {
                                  "type": "string",
                                  "description": "name",
                                  "title": "Group Policy Name"
                                },
                                "groupPolicyId": {
                                  "type": "string",
                                  "description": "groupPolicyId",
                                  "title": "Group Policy Id"
                                },
                                "scheduling": {
                                  "type": "object",
                                  "properties": {
                                    "enabled": {
                                      "type": "boolean",
                                      "description": "enabled",
                                      "title": "Enabled"
                                    },
                                    "monday": {
                                      "type": "object",
                                      "properties": {
                                        "active": {
                                          "type": "boolean",
                                          "description": "active",
                                          "title": "Active"
                                        },
                                        "from": {
                                          "type": "string",
                                          "description": "from",
                                          "title": "From"
                                        },
                                        "to": {
                                          "type": "string",
                                          "description": "to",
                                          "title": "To"
                                        }
                                      },
                                      "description": "monday",
                                      "title": "Monday"
                                    },
                                    "tuesday": {
                                      "type": "object",
                                      "properties": {
                                        "active": {
                                          "type": "boolean",
                                          "description": "active",
                                          "title": "Active"
                                        },
                                        "from": {
                                          "type": "string",
                                          "description": "from",
                                          "title": "From"
                                        },
                                        "to": {
                                          "type": "string",
                                          "description": "to",
                                          "title": "To"
                                        }
                                      },
                                      "description": "tuesday",
                                      "title": "Tuesday"
                                    },
                                    "wednesday": {
                                      "type": "object",
                                      "properties": {
                                        "active": {
                                          "type": "boolean",
                                          "description": "active",
                                          "title": "Active"
                                        },
                                        "from": {
                                          "type": "string",
                                          "description": "from",
                                          "title": "From"
                                        },
                                        "to": {
                                          "type": "string",
                                          "description": "to",
                                          "title": "To"
                                        }
                                      },
                                      "description": "wednesday",
                                      "title": "Wednesday"
                                    },
                                    "thursday": {
                                      "type": "object",
                                      "properties": {
                                        "active": {
                                          "type": "boolean",
                                          "description": "active",
                                          "title": "Active"
                                        },
                                        "from": {
                                          "type": "string",
                                          "description": "from",
                                          "title": "From"
                                        },
                                        "to": {
                                          "type": "string",
                                          "description": "to",
                                          "title": "To"
                                        }
                                      },
                                      "description": "thursday",
                                      "title": "Thursday"
                                    },
                                    "friday": {
                                      "type": "object",
                                      "properties": {
                                        "active": {
                                          "type": "boolean",
                                          "description": "active",
                                          "title": "Active"
                                        },
                                        "from": {
                                          "type": "string",
                                          "description": "from",
                                          "title": "From"
                                        },
                                        "to": {
                                          "type": "string",
                                          "description": "to",
                                          "title": "To"
                                        }
                                      },
                                      "description": "friday",
                                      "title": "Friday"
                                    },
                                    "saturday": {
                                      "type": "object",
                                      "properties": {
                                        "active": {
                                          "type": "boolean",
                                          "description": "active",
                                          "title": "Active"
                                        },
                                        "from": {
                                          "type": "string",
                                          "description": "from",
                                          "title": "From"
                                        },
                                        "to": {
                                          "type": "string",
                                          "description": "to",
                                          "title": "To"
                                        }
                                      },
                                      "description": "saturday",
                                      "title": "Saturday"
                                    },
                                    "sunday": {
                                      "type": "object",
                                      "properties": {
                                        "active": {
                                          "type": "boolean",
                                          "description": "active",
                                          "title": "Active"
                                        },
                                        "from": {
                                          "type": "string",
                                          "description": "from",
                                          "title": "From"
                                        },
                                        "to": {
                                          "type": "string",
                                          "description": "to",
                                          "title": "To"
                                        }
                                      },
                                      "description": "sunday",
                                      "title": "Sunday"
                                    }
                                  },
                                  "description": "scheduling",
                                  "title": "Scheduling"
                                },
                                "bandwidth": {
                                  "type": "object",
                                  "properties": {
                                    "settings": {
                                      "type": "string",
                                      "description": "settings",
                                      "title": "Settings"
                                    },
                                    "bandwidthLimits": {
                                      "type": "object",
                                      "properties": {
                                        "limitUp": {
                                          "type": "integer",
                                          "format": "int32",
                                          "description": "limitUp",
                                          "title": "Limit Up"
                                        },
                                        "limitDown": {
                                          "type": "integer",
                                          "format": "int32",
                                          "description": "limitDown",
                                          "title": "Limit Down"
                                        }
                                      },
                                      "description": "bandwidthLimits",
                                      "title": "Bandwidth Limits"
                                    }
                                  },
                                  "description": "bandwidth",
                                  "title": "Bandwidth"
                                },
                                "firewallAndTrafficShaping": {
                                  "type": "object",
                                  "properties": {
                                    "settings": {
                                      "type": "string",
                                      "description": "settings",
                                      "title": "Settings"
                                    },
                                    "trafficShapingRules": {
                                      "type": "array",
                                      "items": {
                                        "type": "object",
                                        "properties": {
                                          "definitions": {
                                            "type": "array",
                                            "items": {
                                              "type": "object",
                                              "properties": {
                                                "type": {
                                                  "type": "string",
                                                  "description": "type",
                                                  "title": "Type"
                                                },
                                                "value": {
                                                  "type": "object",
                                                  "properties": {
                                                    "id": {
                                                      "type": "string",
                                                      "description": "id",
                                                      "title": "Id"
                                                    },
                                                    "name": {
                                                      "type": "string",
                                                      "description": "name",
                                                      "title": "Name"
                                                    }
                                                  },
                                                  "description": "value",
                                                  "title": "Value"
                                                }
                                              }
                                            },
                                            "description": "definitions",
                                            "title": "Definitions"
                                          },
                                          "perClientBandwidthLimits": {
                                            "type": "object",
                                            "properties": {
                                              "settings": {
                                                "type": "string",
                                                "description": "settings",
                                                "title": "Settings"
                                              },
                                              "bandwidthLimits": {
                                                "type": "object",
                                                "properties": {
                                                  "limitUp": {
                                                    "type": "integer",
                                                    "format": "int32",
                                                    "description": "limitUp",
                                                    "title": "Limit Up"
                                                  },
                                                  "limitDown": {
                                                    "type": "integer",
                                                    "format": "int32",
                                                    "description": "limitDown",
                                                    "title": "Limit Down"
                                                  }
                                                },
                                                "description": "bandwidthLimits",
                                                "title": "Bandwidth Limits"
                                              }
                                            },
                                            "description": "perClientBandwidthLimits",
                                            "title": "Per Client Bandwidth Limits"
                                          },
                                          "dscpTagValue": {
                                            "type": "string",
                                            "description": "dscpTagValue",
                                            "title": "DSCP ag Value"
                                          },
                                          "pcpTagValue": {
                                            "type": "string",
                                            "description": "pcpTagValue",
                                            "title": "PCP Tag Value"
                                          }
                                        }
                                      },
                                      "description": "trafficShapingRules",
                                      "title": "Traffic Shaping Rules"
                                    },
                                    "l3FirewallRules": {
                                      "type": "array",
                                      "items": {
                                        "type": "object",
                                        "properties": {
                                          "comment": {
                                            "type": "string",
                                            "description": "comment",
                                            "title": "Comment"
                                          },
                                          "policy": {
                                            "type": "string",
                                            "description": "policy",
                                            "title": "Policy"
                                          },
                                          "protocol": {
                                            "type": "string",
                                            "description": "protocol",
                                            "title": "Protocol"
                                          },
                                          "destPort": {
                                            "type": "integer",
                                            "format": "int32",
                                            "description": "destPort",
                                            "title": "Destination Port"
                                          },
                                          "destCidr": {
                                            "type": "string",
                                            "description": "destCidr",
                                            "title": "Destination CIDR"
                                          }
                                        }
                                      },
                                      "description": "l3FirewallRules",
                                      "title": "L3 Firewall Rules"
                                    },
                                    "l7FirewallRules": {
                                      "type": "array",
                                      "items": {
                                        "type": "object",
                                        "properties": {
                                          "policy": {
                                            "type": "string",
                                            "description": "policy",
                                            "title": "Policy"
                                          },
                                          "type": {
                                            "type": "string",
                                            "description": "type",
                                            "title": "Type"
                                          },
                                          "value": {
                                            "type": "array",
                                            "items": {
                                              "type": "string"
                                            },
                                            "description": "value",
                                            "title": "Value"
                                          }
                                        }
                                      },
                                      "description": "l7FirewallRules",
                                      "title": "L7 Firewall Rules"
                                    }
                                  },
                                  "description": "firewallAndTrafficShaping",
                                  "title": "Firewall And Traffic Shaping"
                                },
                                "contentFiltering": {
                                  "type": "object",
                                  "properties": {
                                    "allowedUrlPatterns": {
                                      "type": "object",
                                      "properties": {
                                        "settings": {
                                          "type": "string",
                                          "description": "settings",
                                          "title": "Settings"
                                        },
                                        "patterns": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "description": "patterns",
                                          "title": "Patterns"
                                        }
                                      },
                                      "description": "allowedUrlPatterns",
                                      "title": "Allowed URL Patterns"
                                    },
                                    "blockedUrlPatterns": {
                                      "type": "object",
                                      "properties": {
                                        "settings": {
                                          "type": "string",
                                          "description": "settings",
                                          "title": "Settings"
                                        },
                                        "patterns": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "description": "patterns",
                                          "title": "Patterns"
                                        }
                                      },
                                      "description": "blockedUrlPatterns",
                                      "title": "Blocked URL Patterns"
                                    },
                                    "blockedUrlCategories": {
                                      "type": "object",
                                      "properties": {
                                        "settings": {
                                          "type": "string",
                                          "description": "settings",
                                          "title": "Settings"
                                        },
                                        "categories": {
                                          "type": "array",
                                          "items": {
                                            "type": "string"
                                          },
                                          "description": "categories",
                                          "title": "Categories"
                                        }
                                      },
                                      "description": "blockedUrlCategories",
                                      "title": "Blocked URL Categories"
                                    }
                                  },
                                  "description": "contentFiltering",
                                  "title": "Content Filtering"
                                },
                                "splashAuthSettings": {
                                  "type": "string",
                                  "description": "splashAuthSettings",
                                  "title": "Splash Auth Settings"
                                },
                                "vlanTagging": {
                                  "type": "object",
                                  "properties": {
                                    "settings": {
                                      "type": "string",
                                      "description": "settings",
                                      "title": "Settings"
                                    },
                                    "vlanId": {
                                      "type": "string",
                                      "description": "vlanId",
                                      "title": "VLAN Id"
                                    }
                                  },
                                  "description": "vlanTagging",
                                  "title": "VLAN Tagging"
                                },
                                "bonjourForwarding": {
                                  "type": "object",
                                  "properties": {
                                    "settings": {
                                      "type": "string",
                                      "description": "settings",
                                      "title": "Settings"
                                    },
                                    "rules": {
                                      "type": "array",
                                      "items": {
                                        "type": "object",
                                        "properties": {
                                          "description": {
                                            "type": "string",
                                            "description": "description",
                                            "title": "Description"
                                          },
                                          "vlanId": {
                                            "type": "string",
                                            "description": "vlanId",
                                            "title": "VLAN Id"
                                          },
                                          "services": {
                                            "type": "array",
                                            "items": {
                                              "type": "string"
                                            },
                                            "description": "services",
                                            "title": "Services"
                                          }
                                        }
                                      },
                                      "description": "rules",
                                      "title": "Rules"
                                    }
                                  },
                                  "description": "bonjourForwarding",
                                  "title": "Bonjour Forwarding"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get Network Group Policy",
                        "description": "Display a group policy on the network",
                        "operationId": "[[variables('_operationId-GetNetworkGroupPolicy')]",
                        "parameters": [
                          {
                            "name": "networkId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Network Id",
                            "x-ms-summary": "Network Id"
                          },
                          {
                            "name": "groupPolicyId",
                            "in": "path",
                            "required": true,
                            "type": "string",
                            "description": "Group Policy Id",
                            "x-ms-summary": "Group Policy Id"
                          }
                        ]
                      }
                    }
                  },
                  "securityDefinitions": {
                    "API Key": {
                      "type": "apiKey",
                      "in": "header",
                      "name": "X-Cisco-Meraki-API-Key"
                    }
                  },
                  "security": [
                    {
                      "API Key": "[variables('TemplateEmptyArray')]"
                    }
                  ]
                },
                "iconUri": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEABAQEBAREBIUFBIZGxgbGSUiHx8iJTgoKygrKDhVNT41NT41VUtbSkVKW0uHal5eaoecg3yDnL2pqb3u4u7///8BEBAQEBEQEhQUEhkbGBsZJSIfHyIlOCgrKCsoOFU1PjU1PjVVS1tKRUpbS4dqXl5qh5yDfIOcvampve7i7v/////CABEIA4QDhAMBIgACEQEDEQH/xAAaAAEBAAMBAQAAAAAAAAAAAAAAAQQFBgMC/9oACAEBAAAAANmAAoAFRQAoAAAUAVAUACgAB4iFAURQBQAKAAACgAAUAoCKB4BQAUAAsKAKAAAFAABQAKAB4BQAFEUAKRQCgAAUAAAUAoCFeACgAUAAsKAKAFgAUALAUACgHgAFABQAAoAqKAABQAAKACgGOoAUAFAALCgAoBYABQCwCgAoeAgoKABQAAoigKAAAFAAAoChjqAAoABQAKAAUAAAKAACgFHgAABQACgAKIoFAAABQAAKAeABUoCpQAKAAqKAUAAAKAACgHgAFABQACgAKABQAAAoAAKB4ABRKBQAAoAKIoBQAAAKALAoeAABQAUAAoACgAKAAAFAACmOoACkUCpQAKAAoAFAAAAoAqB4FAABQBQACgABQBQAAAoAAeAoAAVFAqAoCgAFRQAUAAAoAHgBQAAUAKAAoAAUACgAAKAB4AFAAFRQLFABSKAFIUBQAAAoB4AAUAAUAFAAoAAUlBQAAAoB4AAKAAVFPTYzWRQAFAAKe+dj4QBQAABQxxQAoACgm92DU6kUACgAFdJ6ufxgCgFgAFMcFAAoAAdLkXA0IFABQAHp0tabXFAKAAAHgBQAFAAOlyWBoKBQABQD06X6aXXUACgAAGOoBQAUADpshgaAUFAAKgr06atLrqIUBQAAPAAKAACgnTZLA0FAAoAFB6dNWl1xUKAFAAHgIoBQAX08wOmyGBoKD08wUAL9fCj06atLrgfb4FAUAAxygAKCxehy8Tn4HTZDB58PToffX6QAoPbf+uq1RXp01aXXBl7y6fAAAoAGOKIUBQMnpU53EVOmyWBoA2O8Tl/NQKRtdu8uag9emrS62jdbBjc+EUBQAxwKAAoZPTJzuGHTZLA0AbLeJy3moAXbbV8cuHp09aXXCbzPeHOFgoBQDHACgApk9Mc5hh02SwNAGy3ict8CKBdttnny4enT1pdcRvM94c7ABQFAxwAoGbcEGX0pzmGHTZLA0AbLeJy3mqfeZ5YwNttr58uHp09aTXKbvPeHOwPXKxfMAFDHAAU2e7avShldMc5hh02SwNAGy3ict5hv81oMKjb7Z58uHp09ml1xW7z3hzgt6T08+c+CooBjlABW+2NxuYDK6Y5zDE6fJYHP0bLeJyvwL1Po1GpDbbd58vB69PWl1obzPeHOBk9DZz+KFADHBQA3+yY/LhldMc5hh02SwOfDZ7xOW+Beo9Go1FRt9u8+Xg9em+ml1obzYMfnAyeiOfxAoihjgUAb/ZMflwyumOcwlTp8lgc+Gy3qct5i9T6NRqFjb7d58vB69PWk1wbzYMfnAyeiTQYgVBQxwAoN/smNzAZXTJzmGHT5LA58NnvE5bzF6n0ajUBt9tfPl4PXp60muDeZ7H5wrJ6GufxACiLjgAUbra3A54X26izmPAOnyWBz4ZnRPPmPkOlyZpNaGy3bH5sPTp/ppNbRt9ow9AHt0lnN+NAUDHAApPTcXU+INjn4GvCdRksDn5Rs8vXYQXI2njqoF2vvq8YPXp/ppNap97W6rzBnZ2FgUACmMUAAFBZYVOoyLr+fUlAWCgAPXp/ppNZQCgAKAGOCgAFAFg6bKa/QFAAKAAenT/bRa8AoAFAAxwKAAoAC7HdufwwBQBQAG82PhzvnQFAAKAGOAFABQAWfb4oCygBQAS/fzFACgAKAY6KBQAFAAUACgAUABUUCgACopjooAoAFABQAFABQACxQAoABRjgAFAAUACgAoACgAFRQAKAKYwKABQACgCgAKAAoABQAoABjgFgoFAPb7nn8AAUeno+POFIr1+3n5lJT1+3l8FQoKAAY4AUAFR6bbZex84vNjYbw5jyFztx7/SfHPYor62uw9qnhznwLdlsvevnF1mCsKAKAGOABSFBcvoPYqeXKQ2W/TlfIbPeVYc5hhk7/ANyy/HL+Y9t/kgTX6X5FhQFAMYUAFAMjp/RA8+Thst+cp5H31Ponn5+n3zuIPXpfZAnLeZ99HkoFNbowFACgxgpFAoiulzPp563DZGXzsNl0ByfkZXTGs0cek+Kb/YnzrsOe2doPM3G2r51+Lc7Mqc/hAVBQKMYCgAqGV1SfHNYpQbLoDk/KMzpTA0PwB7dTb889hCo++o9E0GCXb7Yw+eAoAAYygUigWNtvk0+lChst+cp4r99V9nxg4GBBsd+us0QFZfRmu0QfXS5Dz5f5AFQUFxgAoALu9wnN4IKNlv15PxG23VVMLQeZtd2aLWUBsd+mi1wN5sjlvMACgDHEUCkKG73Kc3gKBdlv15PxDY7jIqNfz5td2aLWFBsd+aLWg32wTl/MABRFMYoAKAbXfGq0JQNl0JyXkJblbLZfcnK+TYdBWv5+UDK6UwOfsPvp/aefL/KgAKimMoIUFEMnqq+ef11Pr5Gy6GOT8gDdbhOZxXr1P1Zo9XSyW9R7Gk1h9bzYVr9AFAAFMYAoAoTo9hb84WGyMrlobPfnJeS+2XjeTI3mW+eV8TfbOxiYU9szm/NNtufpMTEuf7x887igUABUxwFCKAr16fIQPLk5Gz6A5LyMzpkLWDzZfvpchUJynwXos1BUajT0AoABjgAKAWPfo8oHlycjZ9Acl5Gb0oHhzuOHtvs0HzyvnT73mfQfOp1MoAUADGUAKAA+tjtMn7nlh6CGw3cc15Vk7/19E8Ndq/Oguw2OV9vjF0HyFztllejywtZjBQAoAYwoBQAA+7PkAFF+j4soA+rfgBZbUgFAAoBjAUAUABQAKACgAKAFABQAChjAUAKlABQAKAFAAoAUABQAKGMAFAFAAKACgAoAKABQAUAAuMigFhRSUACgAqKBQAFABQAKABjKABQBQACgAoAKACgAKAAoBjFABRFFJUUAsKAqKBQAFACkUAoBjAUAFAFAlAoACgFAAUAFAAKGMAoAFRQoJQCooCoUFAAUAFIoAVjABQBQAKAAoAWFAFABQAoABWMAAoAUAAUCiKAWFBQAFACiKAY4ABQAFACgAKABQBQAFACgBjooAFAen35/CgPv7+fhCgKhQFhRfXyAL6fHyUAFAMYUAAKN/ttRoQob7baTTFABQAUDK6Xk/gont1Wj1gUAFAxgFAAo6Da+fIfIUvX+uj0woACgAoyen5PzAfe51+IBQAUMYBQAA6DJydDrAWbLf+Ot04FAAoAKyen5LzoKACgBQxgCwoAOg9vDK5cB03hk4OlKWwAKlABldPyXmUAKAoAGOABQAdB76HrOVxKHt13Lb3B0qvfc5/38YWmxhn++v3me5XxbHa5V8tfpvkyun5LzPvdTSydDqMcACgBjKAFAB0HtzPU4ugBudpyfUYOmMvpcDUY/vtNpzeEbbN9fHWMP53O20uB55e6vMxldPyXnfTopz3lZ1/P4JQAUAxhQAKA6D25nZ7/kPkOs1Wo6jB0r66vB0Ibna8p8NtvNfz0PXrdBrR99Zotay+n5Lyy+iw9D82Ow57BCgAUGMBQBQHQe3M3sdDqxmdRyHl1OBpmy6DkfgT667Ra1tt9yeOX7ztf8ldNiaRl9PyOZ0Gp0xTr+ewQKAChjAFABR0HtzF32ZyqXoPTm3Va/TN/7c0UdF8aBtt1x4Av3kb3D0bK6jT7bRa0DsOdwVBQAFYwAUAUdD7cwyer5XFffX85gOq1+ldNkYVBl+fLtvteUUPfY5vv6eHtrNGyuparRAOw53BqUCgAY4AFAB0PtzMdViaFtN3yMdTgaV1F1pUPLXNvteTou52+Br8bHdH4aJl9Ro93pNUB2HO4IoAUAxhQAoA6H25mNn0HH/PU4WkjqcDSuh++cADb7TlQz+j5rBo6Tw0TL6jkM7oNLqYV2HO4IqKBQDGBQAoDofbmD67DRYXW8njnU4Glbbd8j8Bc7yxm32nKUbzN5Wh1eDo2T1PIfGf0Wn0wdjzuCFAAUMYBQAoOh9uYG9zsDN5cdTgaS/fXanSBk9Xzmvbba8oWbvZcmGf0uo0TK6nkPhn9DqNNY7DnsEAoAoYwAUAUdD7cvTI6755/WE6rA0psei1Go8rm9Dic4bfacoLl9Pp9P8fey3Hhj6JldRyPwmd0es0R2PO4IAKAoxgAKADe+vOqnS5PK/A6XB1JM/eZPn9XU6WGz2XNA2e8+/L0xdDsGnZPR8v5jN3+q1Lq9DhgAUAMcABQAKEUCg9vSeHyWKAuRfPxFAKEooAFihjgAFAAKAKlAAoAFAFAAKACgY5KAAUAFAAoACgApFCpQAKACoY4oAAUAUACgACgBQAUAAoAKYwFAAFAAKAoAAUAFRQqUACooBjgFAAFABQAoAAUAFAFAAKAGOigUAAUAKALKAAUhQURRQABSKGMCgKAAUAKAAoABQAUAKAAoGMAUFAAFACgAUAAKACwooIoFIY4AUFAAFAAoAKAAUABQCgAUYwAFBQAAoAoALBQAKAFAKEKAY4ACgUAAKACgAoABQAFACgBjgABQUAAKAKABYUAFAAoApChjKABYUBQACgCgAFAAKACgAUGMKAAFBQAAoAKAFhQAKACgCgYxYUAFhQFAAKAKAAUAAUAKAAuMAUAAUFAACgAoAVCgBQAKIopjABQABQCgAKABQAUAAoAKAGMUAUAAUCgACgAUAUAAKACiKYwoAUACxQCgAKABQAUAAoAKBjAoAFABUKCgACgBQBQAAoAKGMAoAUAAUBQACgAUAUAAKigFf//EABkBAQADAQEAAAAAAAAAAAAAAAABAwQFAv/aAAgBAhAAAADggAAAQAAIAAgsABAABAACAACLAAEAAEAABAAewAEAABAAAQAewAAgAAQAAQAewAAEAAIAABAewAACAAEAABAewAAgAAAQAAD2IAAEAAAQAAD2AgAAAgAiRAAD2AgAdCMABAE9KjGEAAWIAEBPYjjgAIe+zRygCACxAAQJ7EccAEST2qOUAEAWAgC2/HE9iORE7c1QI0WZI99mnkvezH4AQFgCA6OrkVuxHIi7rY+eB1buLHrs08lq6fOxgCCwAsrh0tXHrdiORF3Xx85Pus61vF8++zTyWvp87En3WAi1AL+nzs0dLVx6568chb18fObOhyaXWt4vn32aeU1dPnYnR18bwAsBDT0ufkdHVx6568cmLevi57du5ed1reLHvsU8pq6XPxulr4tYCwENPS52V0NXH8T145MW9bFgbd/KodW3jR77FPKaenzsjo6+NWAsAL6IeraDrxyYX1+E354WzS99mjlJvoh7tzwAsAIAOpHLACAnr0c4CAAsAAQJeUkAIHryAACLAACAQAEAAAAewAEy8w9RBMvAmZ8IT6iIAAewANG2xhx3dLLhbNsxya2jfYw4o0b7VPPpAA9gAv6SmKMlvUy8/wB9aMc5PNvVUxRit6s0zd45HgAHsAHR0YsYt6mXn++vGLN4dDXhxQdDXiwujr5+IAFgAh1LeVWLeplwNmyfPNp6l/KpQ6enk0tPTxYEACwARPQ04sSYt6mXATt2ZMG/XiwjfsxYXR1c/EACwAFvTVxnx29TLg97fNt+HHZ1JrjPis6s1rK+V5AgLAALttjDlt6WXF76kxnwwu22sWNbvtUYPEAEFgAETKBBMxAJeQlCABBYAAAgAAIACACwAgAEAABAAgAsAEAABAABACALAAIAAQAAEAITCwABAAAQAAQAFiABZdkDXRWAIB6toGirwQAWAgF+3nVlnS59IACHvViFnnyEAWAgF90YzVblp9aPVFSybsnrRNFXvVim6n34gCAsAENE3YYb6a6t+WvVVR0PGbzuxxsxtOTbno2Z6wCCwAF8vNF1kVzZlTtwdDD5e/E6q6trHW25qwAewAXzRsw7ct9fu/wMW7DDV7j3nq6ebGbM1YAPYAL2fbn04dPh7zHrzuwxddjafNerx6xtmasAHsAF857N2OjT4q3Za7/eTdhWacfrblr1YtPvHrz+EAD2AD3NbRni3z49aPdWddSX2+KvMWUr6vfjwAD2AAAEAAIAAID2AAABAACAAICwABAABAAIAAIsAAEAAQAAgAB7AAAQABAAIAB7ABAAABAACABYAgAAIABAAEAWAIAACAAQAAQFgAIAAIAAQAARYACAAAgABAAD2AAQAAEAAgAD/8QAGAEBAQEBAQAAAAAAAAAAAAAAAAIBAwT/2gAIAQMQAAAA5AAaAADQAAAEgAaAADQAAAEgABoAANAAAEgABoAANAAAEgAAGgAAaAAEgAABoAANAAEgAAAaAABoAENAAAA0AAGgAgaAAABoAAAAkGgAAAaAAAAkA0AtAAGi8kAAEgBoHRzAAG9MgAAEgAGnRzAAG9MgAAEgAVsnXOZc4Buy3pkFSAAkADpXLHbObekwBdcm9M5quYGgEAFYdK5Y6uW70mDcOm8m9M5quYbuAEAL6c5dK5Y7Zy3ekwq+eOm8jrnNVzDpvMAgBfSIdK5Y7Zyb1mFXEum88dc5quYdN5gEAL6RDpXLHVyb1nmu+eOm8jrnNVxK654AkAuWbuM7ORuG7jN3DrnMqTTAEaADWHVzANM0dMgAAEaAAGgANAAAAjQAGmaAAGgAAENAA0BjdwGmGgAAgaAXeucV1jm6WcSr1EKvWRgAEAAvqlMb2jnvbJQ3qxMb1Y3OYAEAGnWucDe0c97IhnWogXcQ6VEaAEAA7VxnSusc3S2c867ywdK5YrpPPQAgAHW45ab2jmbdzy61EC7iHSojQAgAFdk7HOu0c9tWxzrqxPOurG5zwNAgACuu5Eb1nnvXU88V01znKukxgNAgAABoAAGgAGkAAAGgAGgAAEgAAAaAAaAAEgAAAaAAaAAENAAAANAANAAgABoAAaAAaAEAGm1AdIwAAbUisw0AgAF9eOD0cZABo2oGsABDQBdOebdc8XsypXPa2Z24bm4ABA0Be1yOuTPWMuZ7ZGdeTpzXHSZucABADRbciqY2Dry7csG3k9c5lzgAIANLT05dedzvSRz68jpubGdp546TgAIAB0R159OXTGwM7clVzXmXm83SMNAIABexvbnHSc688rY6c29OW9Ym+d7z6RhoBAAN2XSFZm3uRlyy6ycVKs3MA0IAADQBoAAAAIGgANADQAAABA0AANAaAAAAIGgAAaA0AAABABoAA0BoAAAIANAABoBoAABAAGgADQA0AAIAANAADQGgABzDQAaAAGgAABAaAA0AANAAAIA0ABoAABoAB//EAD8QAAEDAQQIAwYFBAEDBQAAAAEAAgMEBREgMRASITIzQVFxEzRQIjBSU2FyFBVCQ4EjQGDRYiSRsGOQoKGx/9oACAEBAAE/AP8APx/4Am5XFX+ibFeP8JjjdKdVoTLN2bXqSziBe1yc1zSWuG0ehwUz5shs6oWds31LQyRi9vtf4TQQhkesczptGEXB49CDdYtAULAxgA0EKrjEcpu5/wCDnIqm4LOyu0V/Ad6FDxWhNyGm0uLH2/wc5Km4LO2m0PLuXIegw8RibkNNpcWPt/g/JU3BZ202h5dy5egw8RibkNNp8WPt6+e3uDkVS8BnbTaHl3LpiH93DxWJuQ0clafGj7e5Hq2a8GTPVOM5Kl4LO2m0PLuXTENuwAlGGS7a0rL+xa1zsgU6GQbSDjh4jE3IabT40fbGGPdk0p0b25g+rBpcQ0c1TUrIWrVHRVNKyVp2bU4Fhc05g4TkqXgs7abQ8u5DByUTDK9rAoadkTAA0LVHRVdK17S5o2/2FPD4z7uSjiZG0NAVzTyCrKUXGRmeKHiMTchptPjR9sVJT+MbzuprGNAAARa3mAqymEftt5+q0Y/6qNDTWtundhORVLwWdtNoeXchg6KzgDKTpIUt3jSXdff2Zk/TML439kdl4+uGHisTcho5FWnxY+2Kzx/SPfTVD+g/1Wi81GhpruPhORVLwGdtNoeXcumGzeI7SVNxZfu9/ZmT++mXccjvO74YeIxNyGjkVaXFj7YrP4J7o6KrgP8AVaLzUaGmu4+HkVS8BnbTaHl3LkMNm8R2kqbjSfd7+zMn6ZdxyO87vhh4jE3IaORVpcWPtis/gnvpquA/0y4nYFHQzvF9wCfZ87douKIINxFxGKi81GhpruOcPIql4LO2m0PLuXTDZvEdgm4sv3YT9ExjpDc0IWfMQpKSaIXkbMdl5P0y7jkd53fDDxGJuQ02nxY+2Kz+Ce+mq4D8cUMsu61fgJvopYZIt4Ll6FZ0DX6zz102hTt1PEGwjFReajQ013HwnIql4LO2gK0PLuXTDZvEdgm4sv3YfqFRwCOMG7adBaCLiq2ERSaw5rnhsvJ+mXccjvO74YeKxNyGm0+LH2xWfwT301XAfiiYZHtaOZUUbY2gBbFLGJG3EKRhZI9voVm8F3fTVgGnkvxUXmo0NNdx8JyKpeAztptDy7sVm8R2CXiy/dhbvBR7je2m0/0I4bLyf30y7jkd53fDDxWJuQ02nxY+2Kz+Ce+mp4D8VH5mPBWcc+hWbwT301XAkXXDReajQ013HOE5FUvAZ202h5d2KzeI7BLxZfuwtzCj3GdtHJWn+jFZeUnfTNuOTt53fDDxWJuQ0FWnxY+2Kz+Ce6Oiq4D8VH5mNDTW8Y+hWbwT301fAkxUXmo0NNdxzhORVLwGdtNocB2KzOI7BLxZfuwtzCj3GdtNp/oxWXlJ30zbjkc3d8MPFYm5DQVafFj7YrP4J7o6KrgPxUfmY0NNbxj6FZvAPfTV+XkRw0Xmo0NNd5g4eRVLwWdtNo8B2KzeI7SVLxpfuwt2EKPcZ202n+jFZeUnfTLuOTs3d8MPFYm5DQVafFj7YrP4J76argPxUfmY0NNbxz6FZkoLCzmr9FfKGwObzdipniOdjkCLtDnAbVUyeJM93IYTkVS8BnbTaPl3LlhoX6k46FA6Hv1WEp7taR56nD0UEgfE0hXi7RaMl72tCOGzpQ17mHnpqZAyJxKO3b1ww8VibkNBVp8aLtis6S9jm6ayQMiIPPFTv1JmOKa6/boc64XlVD/EmcR6FHI+N4e3YVFacd3t7FJacI3NqmnfM+92XLD1XRU1e+MXP2r8xp7t4qprzJ7LEOeE81S8BnbTaPAcuWEKntDUGrIjaNPyKqat0+wbAuV2KnqXQHZtCbaMBG0qa0RddGP5Tnl5LnG84mvcw3tUNotuAkTrRg/Sbyp6l85+mKHisTchptPjRdsUcjon6zSo7RZd7exOtGLbqqaZ07r3K/FBWuj9lwvC/MKf4lUVrpBqtFw6+h/Vc7/7E5FUvBj7abR8u73H0/uoeKxNyGgq0+NH2/sf49W6qkdfAz6DTaLroCOqHoMJukYSm5DQVaTgZWfQf4RRVYj9hyY9rxeDenyNYL3EBVlT477hkPQgqSqa5rWONzlepaiOIEuKlkMry48/8I+q8R43XuCL3neeT6J/9FeLJ8xyJJ3iT/7AwF+SbTzu3YyV+DqvklfhKr5JTopW7zCMd/u2wyu3WEr8JU/JK/CVPySjBM3ejIRF2YPu2wTO3WEr8JU/JK/C1PyUYZW7zCF9PdNhldusJX4Wp+SjS1PyinRvbvNI9ZZG+U6rReobMF18pvKZTxMyYFq3L+dBa05tBU9PC5jjqBEAEgYLOaHSOvaCvCj+Bq8KP4Grwo/gapuPLdkHYqegfLc5+xqipIYsmoNAyGkhOijObAqtrWTFoQxMY95uYL1DZozkKZTwsyYEGgadUHMBSwROBvYFKAHvAwhNaXm5rbyoLOc7bKf4UdNDHusQaBkBpLGnNoKlooZOVymoXxXlu0L6eqZKmpHzm+4hvVRQMibc1tyAxTcN/ZO3nd8FmcU4J+PN92GhpNf23hAY63jlAYYKZ85uu9nqoYGQi5oxuyKm4r++GGF07rgDcoKZkLbgNvX3NVRNkGs3YU5rmHVcLj6nTU5nku5KNgY0NbkMV+ibhv7J2bu+CzOKcE/Hm+7Axus9repUTAxjW4HSxtzeEauD40J4j+tqDgcnAqt45wwxGZ4aFDEImBo9w7IqXiv74GML3BozKp4BCwAe7raYSAvbvBXcvUfoqKARRDZtKGlzw0XkgBS2mxuxg1inWlOf03JtpTjMXplq/MZcEKqGaN+q7knbzu+CzOKcFRx5vuwUQvqI8FoVD4g1rc3IkuN5JV45oXJssrN2QhPc9+1xXTBQQCOPXI2nA4gbSbgpbQYw3M2p1pTE7Gr8xm6Jlpn9TEyqilBAdtuUvEf3wWfT3DxHIaS4AXkqa0I2bGbSjaUvywm2m/nGoKyKXnccBVbB4Ul43T6jSReLOwdNqGl7wxpJyCqal87jt2cvdWZxTgn4833YKI3VEYwVtN47LxvBSRvj2PBHuIGeJPG1AXN7IaHG4XlVdWZ3Frdwe4+qY0ve1nxFRs1GNb0GlxABJVXVumdqN3UNN92SoqzX9h+Cuj14T9PULlZbL3OfgtOYgCMc81d7qzOKcFRx5vuwRO8OVj+iY7Wa13UYHMY8XOAKks6F+WwqWz5Y9rTroi43EEHDZrL5XO6YLRm1Gagzcv8A89zRMDp2Houem0ZvDj1Rm7RlgDtUhwzCp5PEiY7rpe0Oa4dVILnvb0Pp4VkcKT7sFom+qd293ZnFOCo4833YaCqu/pPOOppGTDK5ykifE4tdgsrflwWmb5me6szjPwWk6+Vox2ab4iNJU3Gl+708KyOHL92C0W3VRP093ZnFOCo4833Yb/4Kpq98ZAk3VFUwy7rsVdTiWMuG8FlpsrfmwWmz+qw+6s0jxnDBaTf6rD1x2c26G/rpKm40v3eoWW+6RzMFpQa7NcDaPd2ZxTgn4833YwS3I3FR1s8XMuUNpMdcH7CmuBbeDeNJF4VQ3VmlH102c8NmLfiwV8PiREjML+Mlno2c8VG7UqGDrgr4PFi2ZhdsLGl72tGZUMYjjazoNMjtVjndAnnWe53U+oU0vhTtcgRdfpc0EXFVdC+MlzNq76e6axzt1pw2ZxTgn4833e6suRzg9p5YKzjyd9MLxHKx6a7WaD1GkhVtEWnXjX0y0901r37rb0R10tdcQ7mCoXiSNjtJGarKIj24wjs2HSxrnbGi8qjpBCNY7xQ018upEW8z6lQVPixXHeGAj6Kaghk5apRskcpSvykc5So7Nhbve0nRMjicGNA2J287vgszinBPx5vuwQQ+LKGX7CpLNmG5tTqSobmxFjx+lyEbzkxyiop5OVypqcQM+vPSTcL1UODppT9dJF+xWfUF7NRx2jBcpaKGTbq3FGyxfskX5V/6pUdmxN3nFybDHG06jQNim4r++CzqjOJx7YZKOCTbq7U6y28pCmWYwZvJUVPFFusAWzS43beQVXN40mw7B6lBM6GQPaoJ2TMDmn3E3Df2Tt53fBZfFOCfjzfdgoPMM06v0C1foMNbOIYj1OGOR8Tw4clTztnYHD3DsipeLJ3wA3EEZhUtS2dg27Rn7uvqrv6bD6pT1D6d97TsKp6uOcbCr8U3Df2Tt53fBZfFOnoqjjzfdgoPMMx3qaoZC29xVTOZ33k9lywwzPhde0qnq2TDO52C7S7J3ZTcV+GN7o3BzTtVNWsl2ONzlfjc4N2k3BVVfm2Mo7dp9T+mgOLTrAkH6KC05WbJBeFFXwSfquTZmO3XgrWHVa45kJ1RC3OQBVFfBquaNqJvJOCz5GRyEveAvxdP81q/F03zmoVVP85qnIM8habwTp5KkkEczXOyTaynI4gTZo3ZPBWsOoWsOoRewZuCfV07c5AprT5Rt2qSV8hve5DG03G8OuKhtCSPY7aFFXwvzOr3TZY3ZPBWuOoV46ozxNzeFNXwNB23p7tdxcAcWSgrpYtjtrVFXwyf8U2aN2Twtb6rXHVOqIm5vAUtpRt2NF6mqpZr9twXb1kOcMnELxJfmOWvJ8xyJJzN+O4dFcOgVw6K7D/CDnDJxC8ST5jl4knzHIvec3n3tyDnDJxC8R/xuXiSfMciScyfdgkZOKMknzHLxJPmORJOe3/4iTIpZBexhcF+GqPlFOY9huc0g+7Yx7zcxpcV+Gn+UU+N8d2u0t9DaC43NF5X4ef5RXO73IBOwLwJ/llOY9mxzSD6lZO2J6uVqQktbI0ZZq+/3Vlw3Rl55q5Wv+36HR+YZ3Tx7LuykF0j+/uYOMxNyCtPijt6lZPCeiQFMzxY3N6hPZqvLTyPuWtLntaOZuUMYijYzoNFr/t+h0fmGd0/dcpeK/v7mNwY9jihakI5FVdQ2okBb6lZPCeq+Qxw6w6qJ4kjY4cwrUhLJfE5HGNFmRF82vyCmeI4nuPJpVE8yU8bjzVsfteh0fmGd07dPZS8V/f12yeE9Wn5VysqYOj8Lm1V8PiwHqPcclZ8PhQfdtVqzasXh83KzvKRK2P2sdx6Farvgcrj0Pu7j8LlcfhdiuPwuVzvgcv4OKj8wzunbrlLxZO/rtk8J/dWn5V6o5fBmjJ/lC4juqyHwp3jkcdPGZZmN+qADW3dAq2Xxah55NVneUiVsftYYKaSc3MFyhsuJovk9opkETBsYFc3/inQxPG1gKlsyF257BVRSywZi9vXDQU8c7nB4VfSQwQ6zG81FC+Z4a1QWfDGA54vcmsY3JoTmMObQqkBszw3qvoh0uvVPZ8ktzneyFHQU7P0XlBjG5BquafhT6eF42sCnsxucRu/4p7HxuLXjBR+YZ3T913ZScR/fSExhe7Va28lQ2bGGjxNpU1NRwNJcE64uJbsCzXfmUyz6ctadXkqyJkU2q31KyOE/urT8q9dFQTeLA08wrVhDmB4x2TFeXSqsmEMDnI33FWd5SJWxnFgpKV1Q/8A4BRxsibc0XBVNosi9lntOUlbPJm9F789dyjq548nqmtMOubLsPVOayRlx2gqspDTvvG6V202VxXdlabS6luGeuqOnZBGNntHNVNeyD2W+05OtGqJ3gE20aoHaRcpH+I8vOZOiz6MXeK8dlI9kbC55uap7TkJuh2NT55pN55Qe8ZPco66oi53hUtYyoHR3RVVM2eM7Nqc0tcWuzGmj8wzun7ruyk4j++gKGF8z7mhUtKyBn1VVVsgHV3IKWV8ziXu0HkuncKPcZ9oVo+a/j1KyeE/urT8q9dFZc2pKWHmpYw+NzeoUjDG97D+k4br8s1SxCKBrforVm9tkY0Wd5SJWx+1o+qa0uIbzJVNCIYms581aNXqDwmnaVzJOAnkrNqzf4TiqiITROaU9hY9zDy02VxXdk5gcLirQqREzVB2lHbnghYXysb9U0BoAVo1BkmMfJqywRvMbmuByKik8SNj+oVpxBkwd8emj8wzunbrlKbpJO+impX1B6N6qGBkDQ1oVXXNiva3a5OeXuLnHbg/2FHuM+1Wh5k9vUrJ4T+6tPyr1yTHljmvHIqF/iRMcOYVqQ6koeMjhoYvFqG/8U8hjHO6BTSeLK9/VdVZ3lIlbH7WmzIhJUaxyAUjtVjndApJDK8vPM4muLSHDkVBIJYmP6hWnFqTa3J2myeI5E3C9VUnizvdy5I4IpXRPD2o2pVfC1PeXv1nZnPFZ7r6doVrDZGdNH5lndP3XdlJxJO6paIzEOfsamsZG25twCrK/OOL+Sibz1w/7Cj3GfaFaHmj29SsnhP7q0/KvXTRZU17DEVXQiaBw5jbhsqHUiMhG1ytKXw4dUHadB5qzvKRK2P2tF6shl0Lj9VabyylcR7iy3h0Gr8KtVl8TXdNNk8RynOrE8/8T7rZ1QBOW1CKU5RuTaCofkLlRwvhh1Xq1d1mmj8yzunbWu7KCg15XPlyv2BEsjZtuDQqyvdIdSPdx/7Cj3GfaFaPmvUrI4T1aflXrpopZTDOx1+wnatjh9CFWReDUPHInYuaCjYZHtaOajYGMa3oFaM3iVGzJuzQeas7ykStj9pHRZrbqcKop21DNVxX5VD8RX5VD8RX5VD8RX5VD8RX5VD8RX5VD8RX5XD8RVNTNpw4NOatAX0r100WTxndlWeXf7iKmnm3WqOyeb5CEyz6ZubNZNp4GZRgLXjb+poT62nZm9QzMmZewq1t1mmj8yzvoCtKKZzb2k6gzCGP/YUe4z7QrR8z/cD+6sjhPVqeVeummgmEsA6t2K1Yb2CQcl9FzVlwh8xeRkqmTwonuv5bE4l5cTmTo6qzvKRK2P2l1XJWef8Apwq2qdTMvDV+byfKX5vL8tfm8ny1+byfLX5vJ8tfm0vy1+bSfLQtaT5antF00TmammyOM5Vnl34s8lR0A2SS/wDZexG3kAprSjYbmDWUlpzv3PZTqupdsdIiS7MnRZvAVq7jNNH5lndO3XdlT1pimex5vbegWubfmCq6hLP6kY2cxj/2FHuM+0K0fNepWRwnq1PKvXTTZk3hzahOxyljEkbmnopGGN7mnMHRQQ+FTt6lWtNsbEF20dVZ3lIlbH7WmyXXwOH1VqMLqY/Qq+/H2wWTxXdlWeXfh+is+ETTXnIIkNbf0VXVvmkIDrmhdkdJVm+XCtbdZpo/MM7p+47speK/uqSudDc121qa5r23g3hVtBq3yRDuF9Dh/wBhR7jPtCtHzPqVkcJ/dWn5V66aMk12o5rhyN6gk8WJj+oVqwhkrZANjs1TReNOxnJbGt+gCqpTLO93Q3DT1VneUiVsZxabKm1ZTH1U0fiROb1Cewse5rswccdBPK1r281PTSQauvz02TxXdlWeXfisnccVXOLaZ5C5YPovoqNhjp2A53bVa26zTR+YZ3T913ZS8V/fRRVjoCGuN7Cmua9oLdoKrqDN8WH/AGFHuM+1Wj5n1KyOE/urT8q9dMFkz3tdE7Pkq6EzU7wMwrJh35HDsrQmEdO4c3bBg6qzvKRK2M4tMb/Dka8cioZRLG145hWlSbfFYO674aWB08oAGxNaGNDRkFaU4lm1OTNNk8V3ZVnl34eislwuexVcfiQPaFlfevpgoaUzPDiPYCGWxWtux6aPzLO6fuu7KXiv76L1RVhgOq43sQc14vBvvVdRZyRjuF9Ffy0dO4Ue4z7VaPmfUrI4T+6tPyr100fTRSzeDUMcgQ5vcKONsTdVqtOfxJdTk3B17KzvJxK2P2sFBV+A/UefYK2SN5FpVVZmb4k6KVmxzCF3QBOTSVBQTzHaNVqp6dkDNVqrqwQsLWm9xRJO3TZPFcqzy78VHOIZw4800hwvVZZ5LnSR/wDZGN7djmOCvQY926xxVNZr33GXY1OdHTR8gAqGcziVx6q1t1mmj8xH3T913ZS8R/fBSVj4DcdrEx7JGXjaCq2g1gXx5q4gm/PQeXcJm4z7QrR8z/HqVlysZE/WeArRmjfTuDXg4qGqY6Boc8AhPqoWtJ1wVI8vke7qdNyP6lQTRspYml4Vqva/w9VwR0gclTV0tPc0+01QV0E2Trj9UQx423ORpac5whNghbuxgJ0sbRteAqm1BtbCnOc46ztpwWY9rJXaxA2KrmiMDgHg4u6pK90NzX7WqOoilF7XhOYx+bQV+Fp/ktQbHHkA1T10UPO8qoqZJ3Xu3eisuRkbJA5wF5VpyMe1mq4HTSODZ2EnmnVEVx9tql4jz9Vy057FR1boHXHaxCpgc2/XCroIX/1GPF62roPqmTxajfbbkq54dU3ggi71m4e/ZUTs3ZCF+Nq/nFGsqiOMU57n7XEk+/BLdoJQq6obBMV+NqvnFPqJ37HSEhfzjuGE/wDhZf/EAC8RAAEDAwMDBAEEAgMBAAAAAAEAAgMEEBESMTIzQFEgISJBExRQYXEwUiNCkID/2gAIAQIBAT8A/wDBPHaH9lhp24BKmgaG5HYgZKipmBuSqiFrPcfsg3Cj4NU3TKPYMPzam7BVXSP7I3dRcGqbplHsGc2/2m7Kq6R/YIojIU+kwM5RsN1FwCm6ZR3sGlxwhSfHdSxFh/wQwGT3UlLoGQbs5tQ2VV0jdjC84Qo/bdPYWHHd0vC0vUNhuouDVN0yjvaHqNtV8R/gpukE7iU7kbM5tTdgqrpG9KPnasHzHbYX4pMcURi9L07S8zYbqLgFN0yjvaDqD+7VfEXAJX4n4zj0U/SCfxKdyNmc2puwVT0jel52rOQuGudxRikAyW9lTtDnjKwqpoD70vC0vUNhuouDVNwKO9oOoLVfEXpWhxKwFO3TJen6QT+JTuRszm1N2Cqekb0vO1ZyF6RoxlOGQQpBh57Gm52q+Tb0vC0vUNhuouDVN03I2g6g/u1XxF6Pd1qnqXp+kE7iU7kbM5tTdgqnpG9LztWchek4IqXm7saYgPtVEFwvSkaETgKQgvNhuouDVN0yjaE4kFqsjAF6QgE2nIMhvTEGMJ5AaU7kbM5tTdgqnpG9MQH2qyC69IRpwiVKcvPYgkHIX6h+MIkk3Y9zDkJ1Q9wR82G6i4BTdMo73FQ9ownuc85N2ktOQjUyEYRObxyuZsnTveMXZzam7BVPSNwSChUvAxlOcXHJux5YctT6h7hhDuvtQvBaBlTyNDCFuewYcOCje1zd1Uvboxn9lBI2KznstRGxRJP7Jn92wStDj/1K0OG7SiMX0nwiCNx6A1x+l+N/+pWh3j0gZQY//UrQ4f8AVEEejGUI3H6K0PH0iMd5FAX77JsTG/SwFgFVIAIwLQgawg1vhVQAaLwwZ93IMaNm2IapBhxvFAX/ANJsLG/SwEWhVTQMXigc/wDpMhY0bIAIgFPgY8bYUsToz3UMesoDAwsgBGojahUMKqXNdjFoeoLVfFtmDLwmjGAnu0NyjVHwhVeQnuy4m0Met38JoDRgWdOxv2hUsKqXBwGLRM1vwmtDRgWM8bTglNnY44BtIwPbgqRpa7Hc0wwy1RJ74BW/oh6gtV8W2jOHhA5wU9ocMFPpSNk5jmb3pW/HNqmU50j00rfYm1TKc6RbOFTS6/ibVbcEHuYemLS51n0w9QWq+Lbwz49ig4O2s5gcMFTRljrU/TtP1Hemm4Wnz+Q3pR87Vew7mmdluLTxHORfFoeoLVXFvoa9zT7FQzFxwbVQ+ItSuyMWqIifkF72x7WpXfEi1RET8gtigCTgKni0DJtVPycdzFJocgQRmxiYfpCFgVSAMYtDzFqri2zBl4CdTMX6QeVHC1lqp+SG2ik0OTXBws6Jh+kIIwqpoAGAsqJ5Y7Ka4PGRYxMP0mxMb9WkeGNJTnanE91HMWf0mzMcFqb5WpvlVLgT7WhOHha2f7BVTgWjBtHzC1s8rU3yi9o+1JUBuycdRzeOZzCmTsctTfKL2+VUvafa8croz/CZOxy1t8rW3ynzsbspJHPPe6itR/wZK1O8rJ9eo+VqPq1FFzj/APHMTNbsJ9OGtJHqZThzclSN0Ox2LRk4U0QjA9MMIkCe3Q4juafmiQSWqRulxHojblwCGBgKfqHsY+QVVs30skLB7IkuOT3NPzTnaZQqhmzvRTt3cmO1SFT9Q2a0uOAm0zvs4X6Xw5Phey4jJZqTInPRpsDknDBTWOdshTeSjTeHJ8TmWj5hVWzbAElGBwGTZkZfsiCDjuafqKf2em/8kScMG2PddOJU/IqbqFAEnCa0RMyd0+ZzkHuUU2fi5Tx6TnzaEaocKSTR8Wr8kmd1ycsthZ/KdK932g9w+1E8SjBUjdLiFHyCqdmprS44CYxsQy7dSyl5/i1LsVLnWe5p+aqOSp3YOFO3S60LdT1Uu2aqbcqfqFQDL1Uu98XG6f8AOLKwoTiLKccuNtk55dvYNcfpU7HB2yqOaj5hTMLy1fCEfynyF5sFS/al5nuafmqjkmnBypBrjzaEYYXKQ6nEqm5KfqFU3JSGIO+S1QLVCtUPhOlZowLR9Ao73jgyMuWYWL9QwbNUUxe7CqOaZyanSBmMqeIu+Q9FLs5S8z3NPzVRytA7LC0osw/ClOiPFqbkp+ZUBw9VDffPo0OAyRaPolHe0LcvCqHkYaL0w+RVRzUfIKq2aoZsfF2ymhz8m3pftS8z3NP1FUc7RP0vCMYLg5Tu1OtTcip+oUDhAtmjx9p8Tm/SwfCihJOSp3jiLR9Ao7m0LsPU0ZeNQWHeE2Nzjsog2P2+1UH5pnIKp2FoZsfFylhz8mrGFS7FS8z3Mb9DsqR+s5v+chuFnJtHIWFOcXkk2a4tPshUeQvzR+E+cnb2R97NmIZpuFHO5vsV+dnhOqPpoTZXB2pSP1nKBxgqSXWLsnLRjdOIcc4wopTGnu1HP/kB/8QAJxEAAQUAAgICAwACAwAAAAAAAQACEBExIEASITJBAyJQMJBRYID/2gAIAQMBAT8A/wBJgARHSoIj+IEEc6Z/ihHOiIOfwALXjIg5wpEf4AERIg5NLxRHbbkHYCGI5I2Hf4AjIgy2HdejwbkHZGI5Ldh3CuAzgIMt2HcK6Tdh0tyDsBDEcluw6WwdkZwEGW7DpGQei3YfH2m5B2AhiOL7huw6Ww7ZGQYEGW7DpbkHot2HbLcg7AQxOxfcN2HS2DsjEZEGW7DpGQel5Hha8uAxOzgHFWZBXlwBRMiDnC+Fq+4CE4+ukCif41/9t9qiqPCiq4UqKo8qVcqVHugICXQ3YdIHA7Iaql0gKpIRHaaJsBeQTobsPyBsFea8kYA9yXBeQRMAIRauSOwE3IceLdEPyPuS1EES3IceLYcZBh3ZbkO4t2H4JDuBFGG5Dt4tyHbLIdnZZkOHFuw/OAJTTDshmQ4cWwRGoCHIdhppCKCoBPhmw/IC8AvBBsOgFCKCoJ+QChFBUIKJ7QcQg4RaeYbqsJ59QNViS5GQ5XL5BQIi0Sr/APOAFosocgywnCj0QnCuIFoiuyzYIo8Boh29EJ/EFHss1OPtPHrgwfaBtxT9gC0GLwRaRNekGkrwX2gCUGFeCIIganz4wBfaZqfqHsL7jSsamaU/UFXiEXFWU130U4UYb8UXUvIrSviEXEoEhA+QRFFDU9AIABF1wxHeyzU/Uwp4ow0WU8r8f2nfJMHtPkI+2w34o7PkTLAnahqcLXoBEkyxHeyzU/VhT/YhgoWibK/HpTvkvx6jVr9F+itq8hUD48A1W0LyCabKfqGolObwYjvZZqfsMP0iP2T/AEI/HpTvkmGin8KMD4yyrTzUsT9Q1PTXJzZYnb2Wan7DT7VCwU82UV+PSn/KB+wRaRDWm0931A+MjQnC4AJTQAn6m6nwHJzfsQwI72QaKJufP1LXUrswCQg//leYReZDqHAPIXmEXoONomzBNyHELU00jv8AqA//2Q=="
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('LogicAppsCustomConnector-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "LogicAppsCustomConnector",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoMeraki",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "title": "Logic Apps Custom Connector - Cisco Meraki",
            "description": "This custom connector connects to Cisco Meraki Dashboard API service endpoint and programmatically manages and monitors Meraki networks at scale.",
            "prerequisites": [
              "Cisco Meraki Dashboard API service endpoint should be known."
            ],
            "tags": [
              "CustomConnector"
            ],
            "lastUpdateTime": "2021-07-28T00:00:00Z",
            "comments": "This custom connector connects to Cisco Meraki Dashboard API service endpoint and programmatically manages and monitors Meraki networks at scale.",
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId1')]",
        "contentKind": "LogicAppsCustomConnector",
        "displayName": "MerakiConnector",
        "contentProductId": "[variables('_playbookcontentProductId1')]",
        "id": "[variables('_playbookcontentProductId1')]",
        "version": "[variables('playbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Block-Device-Client-Meraki Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "type": "string",
              "defaultValue": "Block-Device-Client-Meraki",
              "metadata": {
                "description": "Enter name for Block Device Client playbook without spaces"
              },
              "minLength": 3
            },
            "CiscoMerakiConnectorName": {
              "type": "string",
              "defaultValue": "MerakiConnector",
              "metadata": {
                "description": "Enter name of Cisco Meraki custom connector without spaces"
              },
              "minLength": 3
            },
            "OrganizationName": {
              "type": "string",
              "metadata": {
                "description": "Enter organization name"
              },
              "minLength": 3
            },
            "NetworkName": {
              "type": "string",
              "metadata": {
                "description": "Enter network name"
              },
              "minLength": 3
            },
            "GroupPolicy": {
              "type": "string",
              "metadata": {
                "description": "Enter group policy name"
              },
              "minLength": 3
            }
          },
          "variables": {
            "Meraki_Connection": "[[concat('Meraki-', parameters('PlaybookName'))]",
            "AzureSentinel_Connection": "[[concat('Azuresentinel-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/customApis/',parameters('CiscoMerakiConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('Meraki_Connection'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]"
              ],
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "GroupPolicy": {
                      "defaultValue": "[[parameters('GroupPolicy')]",
                      "type": "String"
                    },
                    "NetworkName": {
                      "defaultValue": "[[parameters('NetworkName')]",
                      "type": "String"
                    },
                    "OrganizationName": {
                      "defaultValue": "[[parameters('OrganizationName')]",
                      "type": "String"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Check_if_body_present_in_Azure_Sentinel_incident": {
                      "actions": {
                        "Check_if_Organization_exists": {
                          "actions": {
                            "Check_if_Network_exists": {
                              "actions": {
                                "Check_if_Group_Policy_exists": {
                                  "actions": {
                                    "Add_comment_to_incident": {
                                      "runAfter": {
                                        "Create_incident_HTML_table": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "ApiConnection",
                                      "inputs": {
                                        "body": {
                                          "incidentArmId": "@triggerBody()?['object']?['id']",
                                          "message": "<p>@{outputs('Cisco_Meraki_Logo')} <strong>Cisco Meraki Block Device Client Playbook</strong><br>\n<br>\nBelow Incident Device Client(s) are found in Microsoft Sentinel have the following status in Network - <strong></strong><strong>@{parameters('NetworkName')}</strong><strong></strong> for Organization - <strong></strong><strong>@{parameters('OrganizationName')}</strong><strong></strong><br>\n@{body('Create_incident_HTML_table')}</p>"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "post",
                                        "path": "/Incidents/Comment"
                                      }
                                    },
                                    "Compose_Group_Policy": {
                                      "type": "Compose",
                                      "inputs": "@body('Filter_Group_Policy')?[0]"
                                    },
                                    "Create_incident_HTML_table": {
                                      "runAfter": {
                                        "For_each_Host": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Table",
                                      "inputs": {
                                        "columns": [
                                          {
                                            "header": "Incident Device Client",
                                            "value": "@item()?['Host']"
                                          },
                                          {
                                            "header": "Client Id",
                                            "value": "@item()?['ClientId']"
                                          },
                                          {
                                            "header": "MAC",
                                            "value": "@item()?['MAC']"
                                          },
                                          {
                                            "header": "Manufacturer",
                                            "value": "@item()?['Manufacturer']"
                                          },
                                          {
                                            "header": "Client Status",
                                            "value": "@item()?['ClientStatus']"
                                          },
                                          {
                                            "header": "Previous Policy",
                                            "value": "@item()?['PreviousPolicy']"
                                          },
                                          {
                                            "header": "Current Policy",
                                            "value": "@item()?['CurrentPolicy']"
                                          },
                                          {
                                            "header": "Group Policy",
                                            "value": "@item()?['GroupPolicy']"
                                          },
                                          {
                                            "header": "Action",
                                            "value": "@item()?['Action']"
                                          }
                                        ],
                                        "format": "HTML",
                                        "from": "@variables('ConsolidatedAction')"
                                      },
                                      "description": "To create incident HTML table from consolidated action array"
                                    },
                                    "For_each_Host": {
                                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                                      "actions": {
                                        "Check_if_host_exists_in_network_clients": {
                                          "actions": {
                                            "Check_if_client_policy_exists": {
                                              "actions": {
                                                "Condition_for_client_policy": {
                                                  "cases": {
                                                    "Case_Blocked": {
                                                      "case": "Blocked",
                                                      "actions": {
                                                        "Append_to_consolidated_action_variable_for_blocked_client_policy": {
                                                          "runAfter": {
                                                            "Set_action_variable_for_blocked_client_policy": [
                                                              "Succeeded"
                                                            ]
                                                          },
                                                          "type": "AppendToArrayVariable",
                                                          "inputs": {
                                                            "name": "ConsolidatedAction",
                                                            "value": "@variables('Action')"
                                                          },
                                                          "description": " To append action json object"
                                                        },
                                                        "Set_action_variable_for_blocked_client_policy": {
                                                          "type": "SetVariable",
                                                          "inputs": {
                                                            "name": "Action",
                                                            "value": {
                                                              "Action": "Blocked using client policy",
                                                              "ClientId": "@{outputs('Compose_network_client')?['id']}",
                                                              "ClientStatus": "@{outputs('Compose_network_client')?['status']}",
                                                              "CurrentPolicy": "@{body('Get_Network_Client_Policy')?['devicePolicy']}",
                                                              "GroupPolicy": "NA",
                                                              "Host": "@{items('For_each_Host')?['HostName']}",
                                                              "MAC": "@{outputs('Compose_network_client')?['mac']}",
                                                              "Manufacturer": "@{outputs('Compose_network_client')?['manufacturer']}",
                                                              "PreviousPolicy": "@{body('Get_Network_Client_Policy')?['devicePolicy']}"
                                                            }
                                                          },
                                                          "description": " To create action JSON object"
                                                        },
                                                        "Set_classification_reason_variable_for_blocked_client_policy": {
                                                          "runAfter": {
                                                            "Append_to_consolidated_action_variable_for_blocked_client_policy": [
                                                              "Succeeded"
                                                            ]
                                                          },
                                                          "type": "SetVariable",
                                                          "inputs": {
                                                            "name": "ClassificationReason",
                                                            "value": "TruePositive - SuspiciousActivity"
                                                          },
                                                          "description": "To store incident closing reason"
                                                        }
                                                      }
                                                    },
                                                    "Case_Group_Policy": {
                                                      "case": "Group policy",
                                                      "actions": {
                                                        "Append_to_consolidated_action_variable_for_group_policy": {
                                                          "runAfter": {
                                                            "Set_action_variable_for_group_policy": [
                                                              "Succeeded"
                                                            ]
                                                          },
                                                          "type": "AppendToArrayVariable",
                                                          "inputs": {
                                                            "name": "ConsolidatedAction",
                                                            "value": "@variables('Action')"
                                                          },
                                                          "description": "To append action json object"
                                                        },
                                                        "Get_Network_Group_Policy": {
                                                          "type": "ApiConnection",
                                                          "inputs": {
                                                            "host": {
                                                              "connection": {
                                                                "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                                              }
                                                            },
                                                            "method": "get",
                                                            "path": "/networks/@{encodeURIComponent(outputs('Compose_Network_Id'))}/groupPolicies/@{encodeURIComponent(body('Get_Network_Client_Policy')?['groupPolicyId'])}"
                                                          }
                                                        },
                                                        "Set_action_variable_for_group_policy": {
                                                          "runAfter": {
                                                            "Get_Network_Group_Policy": [
                                                              "Succeeded"
                                                            ]
                                                          },
                                                          "type": "SetVariable",
                                                          "inputs": {
                                                            "name": "Action",
                                                            "value": {
                                                              "Action": "Blocked using group policy ",
                                                              "ClientId": "@{outputs('Compose_network_client')?['id']}",
                                                              "ClientStatus": "@{outputs('Compose_network_client')?['status']}",
                                                              "CurrentPolicy": "@{body('Get_Network_Client_Policy')?['devicePolicy']}",
                                                              "GroupPolicy": "@{body('Get_Network_Group_Policy')?['name']}",
                                                              "Host": "@{items('For_each_Host')?['HostName']}",
                                                              "MAC": "@{outputs('Compose_network_client')?['mac']}",
                                                              "Manufacturer": "@{outputs('Compose_network_client')?['manufacturer']}",
                                                              "PreviousPolicy": "@{body('Get_Network_Client_Policy')?['devicePolicy']}"
                                                            }
                                                          },
                                                          "description": "To store action json object"
                                                        }
                                                      }
                                                    },
                                                    "Case_Whitelisted": {
                                                      "case": "Whitelisted",
                                                      "actions": {
                                                        "Append_to_consolidated_action_variable_for_allowed_client_policy": {
                                                          "runAfter": {
                                                            "Set_action_variable_for_allowed_client_policy": [
                                                              "Succeeded"
                                                            ]
                                                          },
                                                          "type": "AppendToArrayVariable",
                                                          "inputs": {
                                                            "name": "ConsolidatedAction",
                                                            "value": "@variables('Action')"
                                                          },
                                                          "description": " To append action json object"
                                                        },
                                                        "Set_action_variable_for_allowed_client_policy": {
                                                          "type": "SetVariable",
                                                          "inputs": {
                                                            "name": "Action",
                                                            "value": {
                                                              "Action": "Allowed using client policy",
                                                              "ClientId": "@{outputs('Compose_network_client')?['id']}",
                                                              "ClientStatus": "@{outputs('Compose_network_client')?['status']}",
                                                              "CurrentPolicy": "@{body('Get_Network_Client_Policy')?['devicePolicy']}",
                                                              "GroupPolicy": "NA",
                                                              "Host": "@{items('For_each_Host')?['HostName']}",
                                                              "MAC": "@{outputs('Compose_network_client')?['mac']}",
                                                              "Manufacturer": "@{outputs('Compose_network_client')?['manufacturer']}",
                                                              "PreviousPolicy": "@{body('Get_Network_Client_Policy')?['devicePolicy']}"
                                                            }
                                                          },
                                                          "description": "To create action JSON object"
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "default": {
                                                    "actions": {
                                                      "Append_to_consolidated_action_variable_for_normal_client_policy": {
                                                        "runAfter": {
                                                          "Set_action_variable_for_normal_client_policy": [
                                                            "Succeeded"
                                                          ]
                                                        },
                                                        "type": "AppendToArrayVariable",
                                                        "inputs": {
                                                          "name": "ConsolidatedAction",
                                                          "value": "@variables('Action')"
                                                        },
                                                        "description": " To append action json object"
                                                      },
                                                      "Set_action_variable_for_normal_client_policy": {
                                                        "runAfter": {
                                                          "Update_Network_Client_Policy": [
                                                            "Succeeded"
                                                          ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                          "name": "Action",
                                                          "value": {
                                                            "Action": "Blocked using group policy by playbook",
                                                            "ClientId": "@{outputs('Compose_network_client')?['id']}",
                                                            "ClientStatus": "@{outputs('Compose_network_client')?['status']}",
                                                            "CurrentPolicy": "@{body('Update_Network_Client_Policy')?['devicePolicy']}",
                                                            "GroupPolicy": "@{parameters('GroupPolicy')}",
                                                            "Host": "@{items('For_each_Host')?['HostName']}",
                                                            "MAC": "@{outputs('Compose_network_client')?['mac']}",
                                                            "Manufacturer": "@{outputs('Compose_network_client')?['manufacturer']}",
                                                            "PreviousPolicy": "@{body('Get_Network_Client_Policy')?['devicePolicy']}"
                                                          }
                                                        },
                                                        "description": " To create action JSON object"
                                                      },
                                                      "Set_classification_reason_variable_for_normal_policy": {
                                                        "runAfter": {
                                                          "Append_to_consolidated_action_variable_for_normal_client_policy": [
                                                            "Succeeded"
                                                          ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                          "name": "ClassificationReason",
                                                          "value": "TruePositive - SuspiciousActivity"
                                                        },
                                                        "description": "To store incident closing reason"
                                                      },
                                                      "Update_Network_Client_Policy": {
                                                        "type": "ApiConnection",
                                                        "inputs": {
                                                          "body": {
                                                            "devicePolicy": "Group policy",
                                                            "groupPolicyId": "@{outputs('Compose_Group_Policy')?['groupPolicyId']}"
                                                          },
                                                          "headers": {
                                                            "Content-Type": "application/json"
                                                          },
                                                          "host": {
                                                            "connection": {
                                                              "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                                            }
                                                          },
                                                          "method": "put",
                                                          "path": "/networks/@{encodeURIComponent(outputs('Compose_Network_Id'))}/clients/@{encodeURIComponent(outputs('Compose_network_client')?['id'])}/policy"
                                                        }
                                                      }
                                                    }
                                                  },
                                                  "expression": "@body('Get_Network_Client_Policy')?['devicePolicy']",
                                                  "type": "Switch"
                                                }
                                              },
                                              "runAfter": {
                                                "Get_Network_Client_Policy": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "else": {
                                                "actions": {
                                                  "Append_to_consolidated_action_variable_for_unknown_client_policy": {
                                                    "runAfter": {
                                                      "Set_action_variable_for_unknown_client_policy": [
                                                        "Succeeded"
                                                      ]
                                                    },
                                                    "type": "AppendToArrayVariable",
                                                    "inputs": {
                                                      "name": "ConsolidatedAction",
                                                      "value": "@variables('Action')"
                                                    },
                                                    "description": "To append action json object"
                                                  },
                                                  "Set_action_variable_for_unknown_client_policy": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                      "name": "Action",
                                                      "value": {
                                                        "Action": "@{outputs('Get_Network_Client_Policy')?['errors']}",
                                                        "ClientId": "@{outputs('Compose_network_client')?['id']}",
                                                        "ClientStatus": "@{outputs('Compose_network_client')?['status']}",
                                                        "CurrentPolicy": "NA",
                                                        "GroupPolicy": "NA",
                                                        "Host": "@{items('For_each_Host')?['HostName']}",
                                                        "MAC": "@{outputs('Compose_network_client')?['mac']}",
                                                        "Manufacturer": "@{outputs('Compose_network_client')?['manufacturer']}",
                                                        "PreviousPolicy": "NA"
                                                      }
                                                    },
                                                    "description": "To create action JSON object for host"
                                                  }
                                                }
                                              },
                                              "expression": {
                                                "and": [
                                                  {
                                                    "equals": [
                                                      "@outputs('Get_Network_Client_Policy')?['statusCode']",
                                                      200
                                                    ]
                                                  }
                                                ]
                                              },
                                              "type": "If",
                                              "description": "Condition to check if network client returns policy details"
                                            },
                                            "Compose_network_client": {
                                              "type": "Compose",
                                              "inputs": "@body('Filter_network_client')?[0]",
                                              "description": "To create network client item"
                                            },
                                            "Get_Network_Client_Policy": {
                                              "runAfter": {
                                                "Compose_network_client": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "ApiConnection",
                                              "inputs": {
                                                "host": {
                                                  "connection": {
                                                    "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                                  }
                                                },
                                                "method": "get",
                                                "path": "/networks/@{encodeURIComponent(outputs('Compose_Network_Id'))}/clients/@{encodeURIComponent(outputs('Compose_network_client')?['id'])}/policy"
                                              }
                                            }
                                          },
                                          "runAfter": {
                                            "Filter_network_client": [
                                              "Succeeded"
                                            ]
                                          },
                                          "else": {
                                            "actions": {
                                              "Append_to_consolidated_action_variable_for_unknow_client": {
                                                "runAfter": {
                                                  "Set_action_variable_for_unknow_client": [
                                                    "Succeeded"
                                                  ]
                                                },
                                                "type": "AppendToArrayVariable",
                                                "inputs": {
                                                  "name": "ConsolidatedAction",
                                                  "value": "@variables('Action')"
                                                },
                                                "description": "To append action object"
                                              },
                                              "Set_action_variable_for_unknow_client": {
                                                "type": "SetVariable",
                                                "inputs": {
                                                  "name": "Action",
                                                  "value": {
                                                    "Action": "Client Not Found",
                                                    "ClientId": "NA",
                                                    "ClientStatus": "NA",
                                                    "CurrentPolicy": "NA",
                                                    "GroupPolicy": "NA",
                                                    "Host": "@{items('For_each_Host')?['HostName']}",
                                                    "MAC": "NA",
                                                    "Manufacturer": "NA",
                                                    "PreviousPolicy": "NA"
                                                  }
                                                },
                                                "description": "To create action JSON object"
                                              }
                                            }
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "greater": [
                                                  "@length(body('Filter_network_client'))",
                                                  0
                                                ]
                                              }
                                            ]
                                          },
                                          "type": "If",
                                          "description": "Condition to check if filter network client returns client object"
                                        },
                                        "Filter_network_client": {
                                          "type": "Query",
                                          "inputs": {
                                            "from": "@body('Get_Network_Clients')",
                                            "where": "@contains(item()?['mac'], items('For_each_Host')?['HostName'])"
                                          },
                                          "description": "To filter client detail from get network clients action based on host"
                                        }
                                      },
                                      "runAfter": {
                                        "Get_Network_Clients": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Foreach",
                                      "description": "For each loop for host from Microsoft Sentinel",
                                      "runtimeConfiguration": {
                                        "concurrency": {
                                          "repetitions": 1
                                        }
                                      }
                                    },
                                    "Get_Network_Clients": {
                                      "runAfter": {
                                        "Compose_Group_Policy": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "ApiConnection",
                                      "inputs": {
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                          }
                                        },
                                        "method": "get",
                                        "path": "/networks/@{encodeURIComponent(outputs('Compose_Network_Id'))}/clients",
                                        "queries": {
                                          "perPage": 100
                                        }
                                      }
                                    },
                                    "Update_incident": {
                                      "runAfter": {
                                        "Add_comment_to_incident": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "ApiConnection",
                                      "inputs": {
                                        "body": {
                                          "classification": {
                                            "ClassificationAndReason": "@variables('ClassificationReason')"
                                          },
                                          "incidentArmId": "@triggerBody()?['object']?['id']",
                                          "status": "Closed"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "put",
                                        "path": "/Incidents"
                                      }
                                    }
                                  },
                                  "runAfter": {
                                    "Filter_Group_Policy": [
                                      "Succeeded"
                                    ]
                                  },
                                  "else": {
                                    "actions": {
                                      "Terminate_if_group_policy_not_found": {
                                        "type": "Terminate",
                                        "inputs": {
                                          "runError": {
                                            "code": "404",
                                            "message": "Group Policy Not Found in Network"
                                          },
                                          "runStatus": "Failed"
                                        }
                                      }
                                    }
                                  },
                                  "expression": {
                                    "and": [
                                      {
                                        "greater": [
                                          "@length(body('Filter_Group_Policy'))",
                                          0
                                        ]
                                      }
                                    ]
                                  },
                                  "type": "If",
                                  "description": "Condition to check if filter group policy returns policy object"
                                },
                                "Compose_Network_Id": {
                                  "type": "Compose",
                                  "inputs": "@body('Filter_Network')?[0]?['id']",
                                  "description": "To store network id from filter network result"
                                },
                                "Filter_Group_Policy": {
                                  "runAfter": {
                                    "Get_Network_Group_Policies": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@body('Get_Network_Group_Policies')",
                                    "where": "@equals(item()?['name'], parameters('GroupPolicy'))"
                                  }
                                },
                                "Get_Network_Group_Policies": {
                                  "runAfter": {
                                    "Compose_Network_Id": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                      }
                                    },
                                    "method": "get",
                                    "path": "/networks/@{encodeURIComponent(outputs('Compose_Network_Id'))}/groupPolicies"
                                  }
                                }
                              },
                              "runAfter": {
                                "Filter_Network": [
                                  "Succeeded"
                                ]
                              },
                              "else": {
                                "actions": {
                                  "Terminate_if_network_not_found": {
                                    "type": "Terminate",
                                    "inputs": {
                                      "runError": {
                                        "code": "404",
                                        "message": "Network Not Found"
                                      },
                                      "runStatus": "Failed"
                                    }
                                  }
                                }
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Filter_Network'))",
                                      0
                                    ]
                                  }
                                ]
                              },
                              "type": "If",
                              "description": "Condition to check if filter network returns network object"
                            },
                            "Filter_Network": {
                              "runAfter": {
                                "Get_Networks": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Get_Networks')",
                                "where": "@equals(item()?['name'], parameters('NetworkName'))"
                              },
                              "description": "To filter network detail from get networks action based on network name"
                            },
                            "Get_Networks": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                  }
                                },
                                "method": "get",
                                "path": "/organizations/@{encodeURIComponent(body('Filter_Organization')?[0]?['id'])}/networks",
                                "queries": {
                                  "perPage": 1000
                                }
                              }
                            }
                          },
                          "runAfter": {
                            "Filter_Organization": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "Terminate_if_organization_not_found": {
                                "type": "Terminate",
                                "inputs": {
                                  "runError": {
                                    "code": "404",
                                    "message": "Organization Not Found"
                                  },
                                  "runStatus": "Failed"
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@length(body('Filter_Organization'))",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If",
                          "description": "Condition to check if filter organization returns organization object"
                        },
                        "Filter_Organization": {
                          "runAfter": {
                            "Get_Organizations": [
                              "Succeeded"
                            ]
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@body('Get_Organizations')",
                            "where": "@equals(item()?['name'], parameters('OrganizationName'))"
                          },
                          "description": "To filter organization detail from get organizations action based on organization name"
                        },
                        "Get_Organizations": {
                          "type": "ApiConnection",
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/organizations"
                          }
                        }
                      },
                      "runAfter": {
                        "Cisco_Meraki_Logo": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Terminate_if_host_not_found": {
                            "type": "Terminate",
                            "inputs": {
                              "runError": {
                                "code": "404",
                                "message": "Host Not Found in Microsoft Sentinel Incident"
                              },
                              "runStatus": "Failed"
                            }
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "contains": [
                              "@outputs('Entities_-_Get_Hosts')",
                              "body"
                            ]
                          },
                          {
                            "greater": [
                              "@length(body('Entities_-_Get_Hosts')?['Hosts'])",
                              0
                            ]
                          }
                        ]
                      },
                      "type": "If",
                      "description": "Condition to check if body present in the sentinel incident"
                    },
                    "Cisco_Meraki_Logo": {
                      "runAfter": {
                        "Initialize_classification_reason_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "<img src=\"https://www.kellerschroeder.com/wp-content/uploads/2017/05/Cisco-Meraki.jpg\" alt=\"CiscoMerakiLogo\" width=\"32\" height=\"32\">",
                      "description": "To add logo for incident "
                    },
                    "Entities_-_Get_Hosts": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      }
                    },
                    "Initialize_action_object_variable": {
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Action",
                            "type": "object"
                          }
                        ]
                      },
                      "description": "To create JSON action object"
                    },
                    "Initialize_classification_reason_variable": {
                      "runAfter": {
                        "Initialize_consolidated_action_array_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "ClassificationReason",
                            "type": "string",
                            "value": "BenignPositive - SuspiciousButExpected"
                          }
                        ]
                      },
                      "description": "To store incident closing reason"
                    },
                    "Initialize_consolidated_action_array_variable": {
                      "runAfter": {
                        "Initialize_action_object_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "ConsolidatedAction",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "To create consolidated array variable for HTML incident table"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "MerakiConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Meraki_Connection'))]",
                        "connectionName": "[[variables('Meraki_Connection')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/customApis/',parameters('CiscoMerakiConnectorName'))]"
                      },
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]",
                        "connectionName": "[[variables('AzureSentinel_Connection')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "MICROSOFT.WEB/CONNECTIONS",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Meraki_Connection')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "parameterValues": {
                  "api_key": "[variables('blanks')]"
                }
              }
            },
            {
              "type": "MICROSOFT.WEB/CONNECTIONS",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinel_Connection')]",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('AzureSentinel_Connection')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoMeraki",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_MerakiConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Block Device Client - Cisco Meraki",
            "description": "This playbook checks if malicious device client is blocked by Cisco Meraki network.",
            "mainSteps": [
              "1. Fetches a list of potentially device clients",
              "2. If malicious device client is not blocked by Cisco meraki network then blocks it."
            ],
            "prerequisites": [
              "1. Deploy the Cisco Meraki Custom Connector before the deployment of this playbook under the same subscription and same resource group. Capture the name of the connector during deployment.",
              "2. Cisco Meraki API Key should be known to establish a connection with Cisco Meraki Custom Connector.",
              "3. Organization name should be known.",
              "4. Network name should be known.",
              "5. Network Group Policy name should be known."
            ],
            "postDeployment": [
              "**a. Authorize API connection**",
              "Once deployment is complete, go under deployment details and authorize Cisco Meraki connection.",
              "1.  Click the Cisco Meraki connection",
              "2.  Click **Edit API connection**",
              "3.  Enter API Key",
              "4.  Click Save",
              "**b. Configurations in Sentinel**",
              "- In Microsoft Sentinel analytical rules should be configured to trigger an incident with hosts.",
              "- Device Client MAC needs to be mapped with hostname in Host entity.",
              "- Configure the automation rules to trigger the playbook."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "entities": [
              "Host"
            ],
            "tags": [
              "Remediation"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Block Device Client - Cisco Meraki",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId2')]",
        "contentKind": "Playbook",
        "displayName": "Block-Device-Client-Meraki",
        "contentProductId": "[variables('_playbookcontentProductId2')]",
        "id": "[variables('_playbookcontentProductId2')]",
        "version": "[variables('playbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Block-IP-Address-Meraki Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "type": "string",
              "defaultValue": "Block-IP-Address-Meraki",
              "metadata": {
                "description": "Enter name for Block IP Address playbook without spaces"
              },
              "minLength": 3
            },
            "CiscoMerakiConnectorName": {
              "type": "string",
              "defaultValue": "MerakiConnector",
              "metadata": {
                "description": "Enter name of Cisco Meraki custom connector without spaces"
              },
              "minLength": 3
            },
            "OrganizationName": {
              "type": "string",
              "metadata": {
                "description": "Enter organization name"
              },
              "minLength": 3
            },
            "NetworkName": {
              "type": "string",
              "metadata": {
                "description": "Enter network name"
              },
              "minLength": 3
            }
          },
          "variables": {
            "Meraki_Connection": "[[concat('Meraki-', parameters('PlaybookName'))]",
            "AzureSentinel_Connection": "[[concat('Azuresentinel-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/customApis/',parameters('CiscoMerakiConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('Meraki_Connection'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]"
              ],
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "NetworkName": {
                      "defaultValue": "[[parameters('NetworkName')]",
                      "type": "String"
                    },
                    "OrganizationName": {
                      "defaultValue": "[[parameters('OrganizationName')]",
                      "type": "String"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Check_if_body_present_in_Azure_Sentinel_incident": {
                      "actions": {
                        "Check_if_Organization_exists": {
                          "actions": {
                            "Check_if_Network_exists": {
                              "actions": {
                                "Add_comment_to_incident": {
                                  "runAfter": {
                                    "Create_incident_HTML_table": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p>@{outputs('Cisco_Meraki_Logo')} <strong>Cisco Meraki Block IP Address Playbook</strong><br>\n<br>\nBelow incident IP address(s) are found in Microsoft Sentinel have the following status in network - <strong>@{parameters('NetworkName')}</strong> for organization - <strong>@{parameters('OrganizationName')}</strong><br>\n@{body('Create_incident_HTML_table')}</p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  }
                                },
                                "Compose_Network_Id": {
                                  "type": "Compose",
                                  "inputs": "@body('Filter_Network')?[0]?['id']",
                                  "description": "To store network id from filter network result"
                                },
                                "Create_incident_HTML_table": {
                                  "runAfter": {
                                    "Update_Network_Appliance_L3_Firewall_Rules": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "Table",
                                  "inputs": {
                                    "columns": [
                                      {
                                        "header": "Incident IP Address",
                                        "value": "@item()?['IP']"
                                      },
                                      {
                                        "header": "Source",
                                        "value": "@item()?['SourceCidr']"
                                      },
                                      {
                                        "header": "Source Port",
                                        "value": "@item()?['SourcePort']"
                                      },
                                      {
                                        "header": "Destination",
                                        "value": "@item()?['DestinationCidr']"
                                      },
                                      {
                                        "header": "Destination Port",
                                        "value": "@item()?['DestinationPort']"
                                      },
                                      {
                                        "header": "Policy",
                                        "value": "@toUpper(item()?['Policy'])"
                                      },
                                      {
                                        "header": "Protocol",
                                        "value": "@toUpper(item()?['Protocol'])"
                                      },
                                      {
                                        "header": "Previous Status",
                                        "value": "@item()?['PreviousStatus']"
                                      },
                                      {
                                        "header": "Current Status",
                                        "value": "@item()?['CurrentStatus']"
                                      },
                                      {
                                        "header": "Action",
                                        "value": "@item()?['Action']"
                                      }
                                    ],
                                    "format": "HTML",
                                    "from": "@variables('ConsolidatedAction')"
                                  },
                                  "description": "To create incident HTML table from consolidated action array"
                                },
                                "Filter_L3_firewall_default_rule": {
                                  "runAfter": {
                                    "Get_Network_Appliance_Firewall_L3_Firewall_Rules": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "Query",
                                  "inputs": {
                                    "from": "@body('Get_Network_Appliance_Firewall_L3_Firewall_Rules')?['rules']",
                                    "where": "@not(equals(item()?['comment'], string('Default rule')))"
                                  },
                                  "description": "To filter out L3 firewall default rule"
                                },
                                "For_each_IP_Address": {
                                  "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                                  "actions": {
                                    "Check_if_IP_Address_exists_in_L3_Firewall_Rules": {
                                      "actions": {
                                        "Check_if_IP_address_is_blocked_by_L3_firewall_rule": {
                                          "actions": {
                                            "Append_to_consolidated_action_variable_for_blocked_IP_address_in_L3_firewall": {
                                              "runAfter": {
                                                "Set_action_variable_for_blocked_IP_address_in_L3_firewall": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "AppendToArrayVariable",
                                              "inputs": {
                                                "name": "ConsolidatedAction",
                                                "value": "@variables('Action')"
                                              },
                                              "description": "To append action JSON object"
                                            },
                                            "Set_action_variable_for_blocked_IP_address_in_L3_firewall": {
                                              "type": "SetVariable",
                                              "inputs": {
                                                "name": "Action",
                                                "value": {
                                                  "Action": "Blocked using L3 firewall rule",
                                                  "CurrentStatus": "Blocked",
                                                  "DestinationCidr": "@{outputs('Compose_L3_firewall_rule')?['destCidr']}",
                                                  "DestinationPort": "@{outputs('Compose_L3_firewall_rule')?['destPort']}",
                                                  "IP": "@{items('For_each_IP_Address')?['Address']}",
                                                  "Policy": "@{outputs('Compose_L3_firewall_rule')?['policy']}",
                                                  "PreviousStatus": "Blocked",
                                                  "Protocol": "@{outputs('Compose_L3_firewall_rule')?['protocol']}",
                                                  "SourceCidr": "@{outputs('Compose_L3_firewall_rule')?['srcCidr']}",
                                                  "SourcePort": "@{outputs('Compose_L3_firewall_rule')?['srcPort']}"
                                                }
                                              },
                                              "description": "To create action JSON object"
                                            },
                                            "Set_classification_reason_variable_for_blocked_IP_address_in_L3_firewall": {
                                              "runAfter": {
                                                "Append_to_consolidated_action_variable_for_blocked_IP_address_in_L3_firewall": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "SetVariable",
                                              "inputs": {
                                                "name": "ClassificationReason",
                                                "value": "TruePositive - SuspiciousActivity"
                                              },
                                              "description": " To store incident closing reason"
                                            }
                                          },
                                          "runAfter": {
                                            "Compose_L3_firewall_rule": [
                                              "Succeeded"
                                            ]
                                          },
                                          "else": {
                                            "actions": {
                                              "Condition_if_IP_address_exists_in_L7_firewall_rules": {
                                                "actions": {
                                                  "Append_to_consolidated_action_variable_for_IP_address_blocked_in_L7_firewall": {
                                                    "runAfter": {
                                                      "Set_action_variable_for_IP_address_blocked_in_L7_firewall": [
                                                        "Succeeded"
                                                      ]
                                                    },
                                                    "type": "AppendToArrayVariable",
                                                    "inputs": {
                                                      "name": "ConsolidatedAction",
                                                      "value": "@variables('Action')"
                                                    },
                                                    "description": "To append action JSON object"
                                                  },
                                                  "Compose_L7_firewall_rule": {
                                                    "type": "Compose",
                                                    "inputs": "@body('Filter_L7_firewall_rule')?[0]",
                                                    "description": "To create firewall rule item"
                                                  },
                                                  "Set_action_variable_for_IP_address_blocked_in_L7_firewall": {
                                                    "runAfter": {
                                                      "Compose_L7_firewall_rule": [
                                                        "Succeeded"
                                                      ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                      "name": "Action",
                                                      "value": {
                                                        "Action": "Blocked using L7 firewall rule",
                                                        "CurrentStatus": "Blocked",
                                                        "DestinationCidr": "@{outputs('Compose_L7_firewall_rule')?['value']}",
                                                        "DestinationPort": "NA",
                                                        "IP": "@{items('For_each_IP_Address')?['Address']}",
                                                        "Policy": "@{outputs('Compose_L7_firewall_rule')?['policy']}",
                                                        "PreviousStatus": "Blocked",
                                                        "Protocol": "NA",
                                                        "SourceCidr": "NA",
                                                        "SourcePort": "NA"
                                                      }
                                                    },
                                                    "description": "To create action JSON object"
                                                  },
                                                  "Set_classification_reason_variable_for_IP_address_blocked_in_L7_firewall": {
                                                    "runAfter": {
                                                      "Append_to_consolidated_action_variable_for_IP_address_blocked_in_L7_firewall": [
                                                        "Succeeded"
                                                      ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                      "name": "ClassificationReason",
                                                      "value": "TruePositive - SuspiciousActivity"
                                                    },
                                                    "description": " To store incident closing reason"
                                                  }
                                                },
                                                "else": {
                                                  "actions": {
                                                    "Append_to_consolidated_action_variable_for_IP_address_allowed_in_firewall": {
                                                      "runAfter": {
                                                        "Set_action_variable_for_IP_address_allowed_in_firewall": [
                                                          "Succeeded"
                                                        ]
                                                      },
                                                      "type": "AppendToArrayVariable",
                                                      "inputs": {
                                                        "name": "ConsolidatedAction",
                                                        "value": "@variables('Action')"
                                                      },
                                                      "description": "To append action JSON object"
                                                    },
                                                    "Set_action_variable_for_IP_address_allowed_in_firewall": {
                                                      "type": "SetVariable",
                                                      "inputs": {
                                                        "name": "Action",
                                                        "value": {
                                                          "Action": "Allowed using L3 & L7 firewall rules",
                                                          "CurrentStatus": "Allowed",
                                                          "DestinationCidr": "@{outputs('Compose_L3_firewall_rule')?['destCidr']}",
                                                          "DestinationPort": "@{outputs('Compose_L3_firewall_rule')?['destPort']}",
                                                          "IP": "@{items('For_each_IP_Address')?['Address']}",
                                                          "Policy": "@{outputs('Compose_L3_firewall_rule')?['policy']}",
                                                          "PreviousStatus": "Allowed",
                                                          "Protocol": "@{outputs('Compose_L3_firewall_rule')?['protocol']}",
                                                          "SourceCidr": "@{outputs('Compose_L3_firewall_rule')?['srcCidr']}",
                                                          "SourcePort": "@{outputs('Compose_L3_firewall_rule')?['srcPort']}"
                                                        }
                                                      },
                                                      "description": "To create action json object"
                                                    }
                                                  }
                                                },
                                                "expression": {
                                                  "and": [
                                                    {
                                                      "greater": [
                                                        "@length(body('Filter_L7_firewall_rule'))",
                                                        0
                                                      ]
                                                    }
                                                  ]
                                                },
                                                "type": "If",
                                                "description": "Condition to check if filter L7 firewall rule"
                                              }
                                            }
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "equals": [
                                                  "@outputs('Compose_L3_firewall_rule')?['Policy']",
                                                  "deny"
                                                ]
                                              }
                                            ]
                                          },
                                          "type": "If",
                                          "description": " Condition to check if IP address is blocked by L3 firewall"
                                        },
                                        "Compose_L3_firewall_rule": {
                                          "type": "Compose",
                                          "inputs": "@body('Filter_L3_firewall_rule')?[0]",
                                          "description": "To store L3 firewall rule"
                                        }
                                      },
                                      "runAfter": {
                                        "Filter_L7_firewall_rule": [
                                          "Succeeded"
                                        ]
                                      },
                                      "else": {
                                        "actions": {
                                          "Check_if_IP_address_exists_in_L7_firewall_rule": {
                                            "actions": {
                                              "Append_to_consolidated_action_variable_for_blocked_IP_address_in_L7_firewall": {
                                                "runAfter": {
                                                  "Set_action_variable_for_blocked_IP_address_in_L7_firewall": [
                                                    "Succeeded"
                                                  ]
                                                },
                                                "type": "AppendToArrayVariable",
                                                "inputs": {
                                                  "name": "ConsolidatedAction",
                                                  "value": "@variables('Action')"
                                                },
                                                "description": "To append action JSON object"
                                              },
                                              "Compose_L7_firewall_rule_item": {
                                                "type": "Compose",
                                                "inputs": "@body('Filter_L7_firewall_rule')?[0]",
                                                "description": "To create firewall rule item"
                                              },
                                              "Set_action_variable_for_blocked_IP_address_in_L7_firewall": {
                                                "runAfter": {
                                                  "Compose_L7_firewall_rule_item": [
                                                    "Succeeded"
                                                  ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                  "name": "Action",
                                                  "value": {
                                                    "Action": "Blocked using L7 firewall rule",
                                                    "CurrentStatus": "Blocked",
                                                    "DestinationCidr": "@{outputs('Compose_L7_firewall_rule_item')?['value']}",
                                                    "DestinationPort": "NA",
                                                    "IP": "@{items('For_each_IP_Address')?['Address']}",
                                                    "Policy": "@{outputs('Compose_L7_firewall_rule_item')?['policy']}",
                                                    "PreviousStatus": "Blocked",
                                                    "Protocol": "NA",
                                                    "SourceCidr": "NA",
                                                    "SourcePort": "NA"
                                                  }
                                                },
                                                "description": "To create action JSON object"
                                              }
                                            },
                                            "else": {
                                              "actions": {
                                                "Append_to_L3_firewall_rules_variable": {
                                                  "type": "AppendToArrayVariable",
                                                  "inputs": {
                                                    "name": "L3FirewallRules",
                                                    "value": {
                                                      "comment": "Blocked by playbook",
                                                      "destCidr": "@items('For_each_IP_Address')?['Address']",
                                                      "destPort": "any",
                                                      "policy": "deny",
                                                      "protocol": "any",
                                                      "srcCidr": "any",
                                                      "srcPort": "any",
                                                      "syslogEnabled": false
                                                    }
                                                  }
                                                },
                                                "Append_to_consolidated_action_variable_for_new_IP_address": {
                                                  "runAfter": {
                                                    "Set_action_variable_for_new_IP_address": [
                                                      "Succeeded"
                                                    ]
                                                  },
                                                  "type": "AppendToArrayVariable",
                                                  "inputs": {
                                                    "name": "ConsolidatedAction",
                                                    "value": "@variables('Action')"
                                                  },
                                                  "description": " To append action JSON object"
                                                },
                                                "Set_action_variable_for_new_IP_address": {
                                                  "runAfter": {
                                                    "Append_to_L3_firewall_rules_variable": [
                                                      "Succeeded"
                                                    ]
                                                  },
                                                  "type": "SetVariable",
                                                  "inputs": {
                                                    "name": "Action",
                                                    "value": {
                                                      "Action": "Blocked using L3 firewall rule by playbook",
                                                      "CurrentStatus": "Blocked",
                                                      "DestinationCidr": "@{items('For_each_IP_Address')?['Address']}",
                                                      "DestinationPort": "Any",
                                                      "IP": "@{items('For_each_IP_Address')?['Address']}",
                                                      "Policy": "deny",
                                                      "PreviousStatus": "Not Found",
                                                      "Protocol": "any",
                                                      "SourceCidr": "Any",
                                                      "SourcePort": "Any"
                                                    }
                                                  },
                                                  "description": "To create action JSON object for IP address"
                                                }
                                              }
                                            },
                                            "expression": {
                                              "and": [
                                                {
                                                  "greater": [
                                                    "@length(body('Filter_L7_firewall_rule'))",
                                                    0
                                                  ]
                                                }
                                              ]
                                            },
                                            "type": "If",
                                            "description": "Condition to check if IP address exists in L7 firewall rule"
                                          },
                                          "Set_classification_reason_variable": {
                                            "runAfter": {
                                              "Check_if_IP_address_exists_in_L7_firewall_rule": [
                                                "Succeeded"
                                              ]
                                            },
                                            "type": "SetVariable",
                                            "inputs": {
                                              "name": "ClassificationReason",
                                              "value": "TruePositive - SuspiciousActivity"
                                            },
                                            "description": "To store incident closing reason"
                                          }
                                        }
                                      },
                                      "expression": {
                                        "and": [
                                          {
                                            "greater": [
                                              "@length(body('Filter_L3_firewall_rule'))",
                                              0
                                            ]
                                          }
                                        ]
                                      },
                                      "type": "If",
                                      "description": "Condition to check if filter IP address returns network object"
                                    },
                                    "Filter_L3_firewall_rule": {
                                      "type": "Query",
                                      "inputs": {
                                        "from": "@body('Get_Network_Appliance_Firewall_L3_Firewall_Rules')?['rules']",
                                        "where": "@contains(item()?['destCidr'], items('For_each_IP_Address')?['Address'])"
                                      },
                                      "description": "To filter rule detail from get network appliance L3 firewall rule action based on IP address"
                                    },
                                    "Filter_L7_firewall_rule": {
                                      "runAfter": {
                                        "Filter_L3_firewall_rule": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Query",
                                      "inputs": {
                                        "from": "@body('Get_Network_Appliance_Firewall_L7_Firewall_Rules')?['rules']",
                                        "where": "@contains(item()?['value'], items('For_each_IP_Address')?['Address'])"
                                      },
                                      "description": "To filter rule detail from get network appliance L7 firewall rule action based on IP address"
                                    }
                                  },
                                  "runAfter": {
                                    "Get_Network_Appliance_Firewall_L7_Firewall_Rules": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "Foreach",
                                  "description": "For each loop for IP addresses from Microsoft Sentinel",
                                  "runtimeConfiguration": {
                                    "concurrency": {
                                      "repetitions": 1
                                    }
                                  }
                                },
                                "Get_Network_Appliance_Firewall_L3_Firewall_Rules": {
                                  "runAfter": {
                                    "Compose_Network_Id": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                      }
                                    },
                                    "method": "get",
                                    "path": "/networks/@{encodeURIComponent(outputs('Compose_Network_Id'))}/appliance/firewall/l3FirewallRules"
                                  }
                                },
                                "Get_Network_Appliance_Firewall_L7_Firewall_Rules": {
                                  "runAfter": {
                                    "Set_L3_firewall_rules_variable": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                      }
                                    },
                                    "method": "get",
                                    "path": "/networks/@{encodeURIComponent(outputs('Compose_Network_Id'))}/appliance/firewall/l7FirewallRules"
                                  }
                                },
                                "Set_L3_firewall_rules_variable": {
                                  "runAfter": {
                                    "Filter_L3_firewall_default_rule": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "L3FirewallRules",
                                    "value": "@body('Filter_L3_firewall_default_rule')"
                                  },
                                  "description": " To create L3 firewall rules array"
                                },
                                "Update_Network_Appliance_L3_Firewall_Rules": {
                                  "runAfter": {
                                    "For_each_IP_Address": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "rules": "@variables('L3FirewallRules')"
                                    },
                                    "headers": {
                                      "Content-Type": "application/json"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                      }
                                    },
                                    "method": "put",
                                    "path": "/networks/@{encodeURIComponent(outputs('Compose_Network_Id'))}/appliance/firewall/l3FirewallRules"
                                  }
                                },
                                "Update_incident": {
                                  "runAfter": {
                                    "Add_comment_to_incident": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "classification": {
                                        "ClassificationAndReason": "@variables('ClassificationReason')"
                                      },
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "status": "Closed"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "put",
                                    "path": "/Incidents"
                                  }
                                }
                              },
                              "runAfter": {
                                "Filter_Network": [
                                  "Succeeded"
                                ]
                              },
                              "else": {
                                "actions": {
                                  "Terminate_if_network_not_found": {
                                    "type": "Terminate",
                                    "inputs": {
                                      "runError": {
                                        "code": "404",
                                        "message": "Network Not Found"
                                      },
                                      "runStatus": "Failed"
                                    }
                                  }
                                }
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Filter_Network'))",
                                      0
                                    ]
                                  }
                                ]
                              },
                              "type": "If",
                              "description": "Condition to check if filter network returns network object"
                            },
                            "Filter_Network": {
                              "runAfter": {
                                "Get_Networks": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Get_Networks')",
                                "where": "@equals(item()?['name'], parameters('NetworkName'))"
                              },
                              "description": "To filter network detail from get networks action based on network name"
                            },
                            "Get_Networks": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                  }
                                },
                                "method": "get",
                                "path": "/organizations/@{encodeURIComponent(body('Filter_Organization')?[0]?['id'])}/networks",
                                "queries": {
                                  "perPage": 1000
                                }
                              }
                            }
                          },
                          "runAfter": {
                            "Filter_Organization": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "Terminate_if_organization_not_found": {
                                "type": "Terminate",
                                "inputs": {
                                  "runError": {
                                    "code": "404",
                                    "message": "Organization Not Found"
                                  },
                                  "runStatus": "Failed"
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@length(body('Filter_Organization'))",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If",
                          "description": "Condition to check if filter organization returns organization object"
                        },
                        "Filter_Organization": {
                          "runAfter": {
                            "Get_Organizations": [
                              "Succeeded"
                            ]
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@body('Get_Organizations')",
                            "where": "@equals(item()?['name'], parameters('OrganizationName'))"
                          },
                          "description": "To filter organization detail from get organizations action based on organization name"
                        },
                        "Get_Organizations": {
                          "type": "ApiConnection",
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/organizations"
                          }
                        }
                      },
                      "runAfter": {
                        "Cisco_Meraki_Logo": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Terminate_if_IP_address_not_found": {
                            "type": "Terminate",
                            "inputs": {
                              "runError": {
                                "code": "404",
                                "message": "IP Address Not Found in Microsoft Sentinel Incident"
                              },
                              "runStatus": "Failed"
                            }
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "contains": [
                              "@outputs('Entities_-_Get_IPs')",
                              "body"
                            ]
                          },
                          {
                            "greater": [
                              "@length(body('Entities_-_Get_IPs')?['IPs'])",
                              0
                            ]
                          }
                        ]
                      },
                      "type": "If",
                      "description": "Condition to check if body present in the sentinel incident"
                    },
                    "Cisco_Meraki_Logo": {
                      "runAfter": {
                        "Initialize_classification_reason_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "<img src=\"https://www.kellerschroeder.com/wp-content/uploads/2017/05/Cisco-Meraki.jpg\" alt=\"CiscoMerakiLogo\" width=\"32\" height=\"32\">",
                      "description": "To add logo for incident "
                    },
                    "Entities_-_Get_IPs": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "Initialize_L3_firewall_rules_variable": {
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "L3FirewallRules",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "To store L3 firewall rule object"
                    },
                    "Initialize_action_object_variable": {
                      "runAfter": {
                        "Initialize_L3_firewall_rules_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Action",
                            "type": "object"
                          }
                        ]
                      },
                      "description": "To create JSON action object"
                    },
                    "Initialize_classification_reason_variable": {
                      "runAfter": {
                        "Initialize_consolidated_action_array_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "ClassificationReason",
                            "type": "string",
                            "value": "BenignPositive - SuspiciousButExpected"
                          }
                        ]
                      },
                      "description": "To store incident closing reason"
                    },
                    "Initialize_consolidated_action_array_variable": {
                      "runAfter": {
                        "Initialize_action_object_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "ConsolidatedAction",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "To create consolidated array variable for HTML incident table"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "MerakiConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Meraki_Connection'))]",
                        "connectionName": "[[variables('Meraki_Connection')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/customApis/',parameters('CiscoMerakiConnectorName'))]"
                      },
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]",
                        "connectionName": "[[variables('AzureSentinel_Connection')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "MICROSOFT.WEB/CONNECTIONS",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Meraki_Connection')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "parameterValues": {
                  "api_key": "[variables('blanks')]"
                }
              }
            },
            {
              "type": "MICROSOFT.WEB/CONNECTIONS",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinel_Connection')]",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('AzureSentinel_Connection')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoMeraki",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_MerakiConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Block IP Address - Cisco Meraki",
            "description": "This playbook checks if malicious IP address is blocked or unblocked by Cisco Meraki MX network.",
            "mainSteps": [
              "1. Fetches a list of potentially malicious IP addresses",
              "2.  If malicious IP address is not blocked by Cisco meraki network then blocks it."
            ],
            "prerequisites": [
              "1. Deploy the Cisco Meraki Custom Connector before the deployment of this playbook under the same subscription and same resource group. Capture the name of the connector during deployment.",
              "2. Cisco Meraki API Key should be known to establish a connection with Cisco Meraki Custom Connector.",
              "3. Organization name should be known.",
              "4. Network name should be known."
            ],
            "postDeployment": [
              "**a. Authorize API connection**",
              "Once deployment is complete, go under deployment details and authorize Cisco Meraki connection.",
              "1.  Click the Cisco Meraki connection",
              "2.  Click **Edit API connection**",
              "3.  Enter API Key",
              "4.  Click Save",
              "**b. Configurations in Sentinel**",
              "- In Microsoft Sentinel analytical rules should be configured to trigger an incident with IP addresses.",
              "- Configure the automation rules to trigger the playbook."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "entities": [
              "IP"
            ],
            "tags": [
              "Remediation"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Block IP Address - Cisco Meraki",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId3')]",
        "contentKind": "Playbook",
        "displayName": "Block-IP-Address-Meraki",
        "contentProductId": "[variables('_playbookcontentProductId3')]",
        "id": "[variables('_playbookcontentProductId3')]",
        "version": "[variables('playbookVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Block-URL-Meraki Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "type": "string",
              "defaultValue": "Block-URL-Meraki",
              "metadata": {
                "description": "Enter name for Block URL playbook without spaces"
              },
              "minLength": 3
            },
            "CiscoMerakiConnectorName": {
              "type": "string",
              "defaultValue": "MerakiConnector",
              "metadata": {
                "description": "Enter name of Cisco Meraki custom connector without spaces"
              },
              "minLength": 3
            },
            "OrganizationName": {
              "type": "string",
              "metadata": {
                "description": "Enter organization name"
              },
              "minLength": 3
            },
            "NetworkName": {
              "type": "string",
              "metadata": {
                "description": "Enter network name"
              },
              "minLength": 3
            }
          },
          "variables": {
            "Meraki_Connection": "[[concat('Meraki-', parameters('PlaybookName'))]",
            "AzureSentinel_Connection": "[[concat('Azuresentinel-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/customApis/',parameters('CiscoMerakiConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('Meraki_Connection'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]"
              ],
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "NetworkName": {
                      "defaultValue": "[[parameters('NetworkName')]",
                      "type": "String"
                    },
                    "OrganizationName": {
                      "defaultValue": "[[parameters('OrganizationName')]",
                      "type": "String"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Check_if_body_present_in_Azure_Sentinel_incident": {
                      "actions": {
                        "Check_if_Organization_exists": {
                          "actions": {
                            "Check_if_Network_exists": {
                              "actions": {
                                "Add_comment_to_incident": {
                                  "runAfter": {
                                    "Create_Incident_HTML_table": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p>@{outputs('Cisco_Meraki_Logo')} <strong>Cisco Meraki Block URL Playbook</strong><br>\n<br>\nBelow incident URL(s) are found in Microsoft Sentinel have the following status in network - <strong></strong><strong>@{parameters('NetworkName')}</strong><strong></strong> for organization - <strong></strong><strong>@{parameters('OrganizationName')}</strong><strong></strong><br>\n@{body('Create_Incident_HTML_table')}</p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  }
                                },
                                "Compose_Network_Id": {
                                  "type": "Compose",
                                  "inputs": "@body('Filter_Network')?[0]?['id']",
                                  "description": "To store network id from filter network result"
                                },
                                "Create_Incident_HTML_table": {
                                  "runAfter": {
                                    "Update_Network_Appliance_Content_Filtering": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "Table",
                                  "inputs": {
                                    "columns": [
                                      {
                                        "header": "Incident URL",
                                        "value": "@item()?['URL']"
                                      },
                                      {
                                        "header": "Previous Status",
                                        "value": "@item()?['PreviousStatus']"
                                      },
                                      {
                                        "header": "Current Status",
                                        "value": "@item()?['CurrentStatus']"
                                      },
                                      {
                                        "header": "Action",
                                        "value": "@item()?['Action']"
                                      }
                                    ],
                                    "format": "HTML",
                                    "from": "@variables('ConsolidatedAction')"
                                  },
                                  "description": "To create incident HTML table from consolidated action array"
                                },
                                "For_each_URL": {
                                  "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                                  "actions": {
                                    "Check_if_URL_is_allowed": {
                                      "actions": {
                                        "Append_to_consolidated_action_variable_for_allowed_URL": {
                                          "runAfter": {
                                            "Set_action_variable_for_allowed_URL": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "AppendToArrayVariable",
                                          "inputs": {
                                            "name": "ConsolidatedAction",
                                            "value": "@variables('Action')"
                                          },
                                          "description": "To append action JSON object"
                                        },
                                        "Set_action_variable_for_allowed_URL": {
                                          "type": "SetVariable",
                                          "inputs": {
                                            "name": "Action",
                                            "value": {
                                              "Action": "Allowed using content filtering",
                                              "CurrentStatus": "Allowed",
                                              "PreviousStatus": "Allowed",
                                              "URL": "@{items('For_each_URL')?['Url']}"
                                            }
                                          },
                                          "description": " To create action JSON object"
                                        }
                                      },
                                      "runAfter": {
                                        "Filter_Allowed_URL_Pattern": [
                                          "Succeeded"
                                        ]
                                      },
                                      "else": {
                                        "actions": {
                                          "Check_if_URL_is_blocked": {
                                            "actions": {
                                              "Append_to_consolidated_action_variable_for_blocked_URL": {
                                                "runAfter": {
                                                  "Set_action_variable_for_blocked_URL": [
                                                    "Succeeded"
                                                  ]
                                                },
                                                "type": "AppendToArrayVariable",
                                                "inputs": {
                                                  "name": "ConsolidatedAction",
                                                  "value": "@variables('Action')"
                                                },
                                                "description": "To append action JSON object"
                                              },
                                              "Set_action_variable_for_blocked_URL": {
                                                "type": "SetVariable",
                                                "inputs": {
                                                  "name": "Action",
                                                  "value": {
                                                    "Action": "Blocked using content filtering",
                                                    "CurrentStatus": "Blocked",
                                                    "PreviousStatus": "Blocked",
                                                    "URL": "@{items('For_each_URL')?['Url']}"
                                                  }
                                                },
                                                "description": " To create action JSON object"
                                              }
                                            },
                                            "else": {
                                              "actions": {
                                                "Append_to_blocked_URL_pattern_variable": {
                                                  "type": "AppendToArrayVariable",
                                                  "inputs": {
                                                    "name": "BlockedURLPatterns",
                                                    "value": "@items('For_each_URL')?['Url']"
                                                  },
                                                  "description": " To append blocked URL"
                                                },
                                                "Append_to_consolidated_action_variable_for_new_URL": {
                                                  "runAfter": {
                                                    "Set_action_variable_for_new_URL": [
                                                      "Succeeded"
                                                    ]
                                                  },
                                                  "type": "AppendToArrayVariable",
                                                  "inputs": {
                                                    "name": "ConsolidatedAction",
                                                    "value": "@variables('Action')"
                                                  },
                                                  "description": "To append action JSON object"
                                                },
                                                "Set_action_variable_for_new_URL": {
                                                  "runAfter": {
                                                    "Append_to_blocked_URL_pattern_variable": [
                                                      "Succeeded"
                                                    ]
                                                  },
                                                  "type": "SetVariable",
                                                  "inputs": {
                                                    "name": "Action",
                                                    "value": {
                                                      "Action": "Blocked using content filtering by playbook",
                                                      "CurrentStatus": "Blocked",
                                                      "PreviousStatus": "Not Found",
                                                      "URL": "@{items('For_each_URL')?['Url']}"
                                                    }
                                                  },
                                                  "description": "To create action JSON object"
                                                }
                                              }
                                            },
                                            "expression": {
                                              "and": [
                                                {
                                                  "greater": [
                                                    "@length(body('Filter_Blocked_URL_Pattern'))",
                                                    0
                                                  ]
                                                }
                                              ]
                                            },
                                            "type": "If",
                                            "description": " Condition to check if URL is belongs to blocked URL patterns"
                                          },
                                          "Set_classification_reason_variable": {
                                            "runAfter": {
                                              "Check_if_URL_is_blocked": [
                                                "Succeeded"
                                              ]
                                            },
                                            "type": "SetVariable",
                                            "inputs": {
                                              "name": "ClassificationReason",
                                              "value": "TruePositive - SuspiciousActivity"
                                            },
                                            "description": "To store incident closing reason"
                                          }
                                        }
                                      },
                                      "expression": {
                                        "and": [
                                          {
                                            "greater": [
                                              "@length(body('Filter_Allowed_URL_Pattern'))",
                                              0
                                            ]
                                          }
                                        ]
                                      },
                                      "type": "If",
                                      "description": "Condition to check if URL belongs to allowed URL patterns"
                                    },
                                    "Filter_Allowed_URL_Pattern": {
                                      "runAfter": {
                                        "Filter_Blocked_URL_Pattern": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Query",
                                      "inputs": {
                                        "from": "@body('Get_Network_Appliance_Content_Filtering')?['allowedUrlPatterns']",
                                        "where": "@contains(item(), items('For_each_URL')?['Url'])"
                                      },
                                      "description": "To filter allowed URL pattern from get network appliance content filtering action based on URL"
                                    },
                                    "Filter_Blocked_URL_Pattern": {
                                      "type": "Query",
                                      "inputs": {
                                        "from": "@body('Get_Network_Appliance_Content_Filtering')?['blockedUrlPatterns']",
                                        "where": "@contains(item(), items('For_each_URL')?['Url'])"
                                      },
                                      "description": " To filter blocked URL pattern from get network appliance content filtering action based on URL"
                                    }
                                  },
                                  "runAfter": {
                                    "Set_blocked_URL_patterns_variable": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "Foreach",
                                  "description": "For each loop for URLs from Microsoft Sentinel",
                                  "runtimeConfiguration": {
                                    "concurrency": {
                                      "repetitions": 1
                                    }
                                  }
                                },
                                "Get_Network_Appliance_Content_Filtering": {
                                  "runAfter": {
                                    "Compose_Network_Id": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                      }
                                    },
                                    "method": "get",
                                    "path": "/networks/@{encodeURIComponent(outputs('Compose_Network_Id'))}/appliance/contentFiltering"
                                  }
                                },
                                "Set_blocked_URL_patterns_variable": {
                                  "runAfter": {
                                    "Get_Network_Appliance_Content_Filtering": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "BlockedURLPatterns",
                                    "value": "@body('Get_Network_Appliance_Content_Filtering')?['blockedUrlPatterns']"
                                  },
                                  "description": " To create blocked URL pattern array"
                                },
                                "Update_Network_Appliance_Content_Filtering": {
                                  "runAfter": {
                                    "For_each_URL": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "blockedUrlPatterns": "@variables('BlockedURLPatterns')"
                                    },
                                    "headers": {
                                      "Content-Type": "application/json"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                      }
                                    },
                                    "method": "put",
                                    "path": "/networks/@{encodeURIComponent(outputs('Compose_Network_Id'))}/appliance/contentFiltering"
                                  }
                                },
                                "Update_incident": {
                                  "runAfter": {
                                    "Add_comment_to_incident": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "classification": {
                                        "ClassificationAndReason": "@variables('ClassificationReason')"
                                      },
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "status": "Closed"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "put",
                                    "path": "/Incidents"
                                  }
                                }
                              },
                              "runAfter": {
                                "Filter_Network": [
                                  "Succeeded"
                                ]
                              },
                              "else": {
                                "actions": {
                                  "Terminate_if_network_not_found": {
                                    "type": "Terminate",
                                    "inputs": {
                                      "runError": {
                                        "code": "404",
                                        "message": "Network Not Found"
                                      },
                                      "runStatus": "Failed"
                                    }
                                  }
                                }
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Filter_Network'))",
                                      0
                                    ]
                                  }
                                ]
                              },
                              "type": "If",
                              "description": "Condition to check if filter network returns network object"
                            },
                            "Filter_Network": {
                              "runAfter": {
                                "Get_Networks": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@body('Get_Networks')",
                                "where": "@equals(item()?['name'], parameters('NetworkName'))"
                              },
                              "description": " To filter network detail from get networks action based on network name"
                            },
                            "Get_Networks": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                  }
                                },
                                "method": "get",
                                "path": "/organizations/@{encodeURIComponent(body('Filter_Organization')?[0]?['id'])}/networks",
                                "queries": {
                                  "perPage": 1000
                                }
                              }
                            }
                          },
                          "runAfter": {
                            "Filter_Organization": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "Terminate_if_organization_not_found": {
                                "type": "Terminate",
                                "inputs": {
                                  "runError": {
                                    "code": "404",
                                    "message": "Organization Not Found"
                                  },
                                  "runStatus": "Failed"
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@length(body('Filter_Organization'))",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If",
                          "description": " Condition to check if filter organization returns organization object"
                        },
                        "Filter_Organization": {
                          "runAfter": {
                            "Get_Organizations": [
                              "Succeeded"
                            ]
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@body('Get_Organizations')",
                            "where": "@equals(item()?['name'], parameters('OrganizationName'))"
                          },
                          "description": " To filter organization detail from get organizations action based on organization name"
                        },
                        "Get_Organizations": {
                          "type": "ApiConnection",
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/organizations"
                          }
                        }
                      },
                      "runAfter": {
                        "Cisco_Meraki_Logo": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Terminate_if_URL_not_found": {
                            "type": "Terminate",
                            "inputs": {
                              "runError": {
                                "code": "404",
                                "message": "URL Not Found in Microsoft Sentinel Incident"
                              },
                              "runStatus": "Failed"
                            }
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "contains": [
                              "@outputs('Entities_-_Get_URLs')",
                              "body"
                            ]
                          },
                          {
                            "greater": [
                              "@length(body('Entities_-_Get_URLs')?['URLs'])",
                              0
                            ]
                          }
                        ]
                      },
                      "type": "If",
                      "description": " Condition to check if body present in the sentinel incident"
                    },
                    "Cisco_Meraki_Logo": {
                      "runAfter": {
                        "Initialize_classification_reason_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "<img src=\"https://www.kellerschroeder.com/wp-content/uploads/2017/05/Cisco-Meraki.jpg\" alt=\"CiscoMerakiLogo\" width=\"32\" height=\"32\">",
                      "description": "To add cisco meraki logo"
                    },
                    "Entities_-_Get_URLs": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/url"
                      }
                    },
                    "Initialize_action_object_variable": {
                      "runAfter": {
                        "Initialize_blocked_URL_patterns_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Action",
                            "type": "object"
                          }
                        ]
                      },
                      "description": "To create JSON action object"
                    },
                    "Initialize_blocked_URL_patterns_variable": {
                      "runAfter": {
                        "Entities_-_Get_URLs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "BlockedURLPatterns",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "To store blocked URL pattern"
                    },
                    "Initialize_classification_reason_variable": {
                      "runAfter": {
                        "Initialize_consolidated_action_array_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "ClassificationReason",
                            "type": "string",
                            "value": "BenignPositive - SuspiciousButExpected"
                          }
                        ]
                      },
                      "description": "To store incident closing reason"
                    },
                    "Initialize_consolidated_action_array_variable": {
                      "runAfter": {
                        "Initialize_action_object_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "ConsolidatedAction",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "To create consolidated array variable for HTML incident table"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "MerakiConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Meraki_Connection'))]",
                        "connectionName": "[[variables('Meraki_Connection')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/customApis/',parameters('CiscoMerakiConnectorName'))]"
                      },
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]",
                        "connectionName": "[[variables('AzureSentinel_Connection')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "MICROSOFT.WEB/CONNECTIONS",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Meraki_Connection')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "parameterValues": {
                  "api_key": "[variables('blanks')]"
                }
              }
            },
            {
              "type": "MICROSOFT.WEB/CONNECTIONS",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinel_Connection')]",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('AzureSentinel_Connection')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoMeraki",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_MerakiConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Block URL - Cisco Meraki",
            "description": "This playbook checks if malicious URL is blocked in Cisco Meraki network.",
            "mainSteps": [
              "1. Fetches a list of potentially malicious URLs",
              "2.  If malicious URL is not blocked by Cisco meraki network then blocks it."
            ],
            "prerequisites": [
              "1. Deploy the Cisco Meraki Custom Connector before the deployment of this playbook under the same subscription and same resource group. Capture the name of the connector during deployment.",
              "2. Cisco Meraki API Key should be known to establish a connection with Cisco Meraki Custom Connector.",
              "3. Organization name should be known.",
              "4. Network name should be known."
            ],
            "postDeployment": [
              "**a. Authorize API connection**",
              "Once deployment is complete, go under deployment details and authorize Cisco Meraki connection.",
              "1.  Click the Cisco Meraki connection",
              "2.  Click **Edit API connection**",
              "3.  Enter API Key",
              "4.  Click Save",
              "5. Similarly authorize teams api connection as well.",
              "**b. Configurations in Sentinel**",
              "-  In Microsoft Sentinel analytical rules should be configured to trigger an incident with URLs.",
              "- Configure the automation rules to trigger the playbook."
            ],
            "lastUpdateTime": "2021-07-28T00:00:00Z",
            "entities": [
              "URL"
            ],
            "tags": [
              "Remediation"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Block URL - Cisco Meraki",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId4')]",
        "contentKind": "Playbook",
        "displayName": "Block-URL-Meraki",
        "contentProductId": "[variables('_playbookcontentProductId4')]",
        "id": "[variables('_playbookcontentProductId4')]",
        "version": "[variables('playbookVersion4')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "IP-Enrichment-Meraki Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion5')]",
          "parameters": {
            "PlaybookName": {
              "type": "string",
              "defaultValue": "IP-Enrichment-Meraki",
              "metadata": {
                "description": "Enter name for IP Address Enrichment playbook without spaces"
              },
              "minLength": 3
            },
            "CiscoMerakiConnectorName": {
              "type": "string",
              "defaultValue": "MerakiConnector",
              "metadata": {
                "description": "Enter name of Cisco Meraki custom connector without spaces"
              },
              "minLength": 3
            },
            "OrganizationName": {
              "type": "string",
              "metadata": {
                "description": "Enter organization name"
              },
              "minLength": 3
            }
          },
          "variables": {
            "Meraki_Connection": "[[concat('Meraki-', parameters('PlaybookName'))]",
            "AzureSentinel_Connection": "[[concat('Azuresentinel-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/customApis/',parameters('CiscoMerakiConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('Meraki_Connection'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]"
              ],
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "OrganizationName": {
                      "defaultValue": "[[parameters('OrganizationName')]",
                      "type": "String"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Check_if_body_present_in_Azure_Sentinel_incident": {
                      "actions": {
                        "Check_if_Organization_exists": {
                          "actions": {
                            "Add_comment_to_incident": {
                              "runAfter": {
                                "Create_incident_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "message": "<p>@{outputs('Cisco_Meraki_Logo')} <strong>Cisco Meraki IP Address Enrichment Playbook</strong><br>\n<br>\nBelow incident IP address(s) are found in Microsoft Sentinel have the following status in networks for organization - <strong></strong><strong>@{parameters('OrganizationName')}</strong><strong></strong><br>\n@{body('Create_Incident_HTML_table')}</p>"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/Comment"
                              }
                            },
                            "Create_incident_HTML_table": {
                              "runAfter": {
                                "For_each_Network": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "columns": [
                                  {
                                    "header": "Incident IP Address",
                                    "value": "@item()?['IP']"
                                  },
                                  {
                                    "header": "Network Name",
                                    "value": "@item()?['NetworkName']"
                                  },
                                  {
                                    "header": "Source",
                                    "value": "@item()?['SourceCidr']"
                                  },
                                  {
                                    "header": "Source Port",
                                    "value": "@item()?['SourcePort']"
                                  },
                                  {
                                    "header": "Destination",
                                    "value": "@item()?['DestinationCidr']"
                                  },
                                  {
                                    "header": "Destination Port",
                                    "value": "@item()?['DestinationPort']"
                                  },
                                  {
                                    "header": "Policy",
                                    "value": "@item()?['Policy']"
                                  },
                                  {
                                    "header": "Protocol",
                                    "value": "@item()?['Protocol']"
                                  },
                                  {
                                    "header": "Status",
                                    "value": "@item()?['Status']"
                                  },
                                  {
                                    "header": "Comment",
                                    "value": "@item()?['Comment']"
                                  }
                                ],
                                "format": "HTML",
                                "from": "@variables('ConsolidatedAction')"
                              },
                              "description": "To create incident HTML table from consolidated action array"
                            },
                            "For_each_Network": {
                              "foreach": "@body('Get_Networks')",
                              "actions": {
                                "For_each_IP_Address": {
                                  "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                                  "actions": {
                                    "Check_if_IP_Address_exists_in_L3_firewall_rules": {
                                      "actions": {
                                        "Check_if_IP_Address_is_blocked_by_L3_firewall_rule": {
                                          "actions": {
                                            "Append_to_consolidated_action_variable_for_blocked_IP_address_in_L3_firewall": {
                                              "runAfter": {
                                                "Set_action_variable_for_IP_address_blocked_in_L3_firewall": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "AppendToArrayVariable",
                                              "inputs": {
                                                "name": "ConsolidatedAction",
                                                "value": "@variables('Action')"
                                              },
                                              "description": " To append action JSON object"
                                            },
                                            "Set_action_variable_for_IP_address_blocked_in_L3_firewall": {
                                              "type": "SetVariable",
                                              "inputs": {
                                                "name": "Action",
                                                "value": {
                                                  "Comment": "Blocked using L3 firewall rule",
                                                  "DestinationCidr": "@{outputs('Compose_L3_firewall_rule')?['destCidr']}",
                                                  "DestinationPort": "@{outputs('Compose_L3_firewall_rule')?['destPort']}",
                                                  "IP": "@{items('For_each_IP_Address')?['Address']}",
                                                  "NetworkName": "@{items('For_each_Network')?['name']}",
                                                  "Policy": "@{outputs('Compose_L3_firewall_rule')?['policy']}",
                                                  "Protocol": "@{outputs('Compose_L3_firewall_rule')?['protocol']}",
                                                  "SourceCidr": "@{outputs('Compose_L3_firewall_rule')?['srcCidr']}",
                                                  "SourcePort": "@{outputs('Compose_L3_firewall_rule')?['srcPort']}",
                                                  "Status": "Blocked"
                                                }
                                              },
                                              "description": "To create action JSON object"
                                            }
                                          },
                                          "runAfter": {
                                            "Compose_L3_firewall_rule": [
                                              "Succeeded"
                                            ]
                                          },
                                          "else": {
                                            "actions": {
                                              "Check_if_IP_Address_exists_in_L7_firewall_rules": {
                                                "actions": {
                                                  "Append_to_consolidated_action_variable_for_IP_address_blocked_in_L7_firewall": {
                                                    "runAfter": {
                                                      "Set_action_variable_for_IP_address_blocked_in_L7_firewall": [
                                                        "Succeeded"
                                                      ]
                                                    },
                                                    "type": "AppendToArrayVariable",
                                                    "inputs": {
                                                      "name": "ConsolidatedAction",
                                                      "value": "@variables('Action')"
                                                    },
                                                    "description": " To append action JSON object"
                                                  },
                                                  "Compose_L7_firewall_rule": {
                                                    "type": "Compose",
                                                    "inputs": "@body('Filter_L7_firewall_rule')?[0]",
                                                    "description": "To create firewall rule item"
                                                  },
                                                  "Set_action_variable_for_IP_address_blocked_in_L7_firewall": {
                                                    "runAfter": {
                                                      "Compose_L7_firewall_rule": [
                                                        "Succeeded"
                                                      ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                      "name": "Action",
                                                      "value": {
                                                        "Comment": "Blocked using L7 firewall rule",
                                                        "DestinationCidr": "@{outputs('Compose_L7_firewall_rule')?['value']}",
                                                        "DestinationPort": "NA",
                                                        "IP": "@{items('For_each_IP_Address')?['Address']}",
                                                        "NetworkName": "@{items('For_each_Network')?['name']}",
                                                        "Policy": "@{outputs('Compose_L7_firewall_rule')?['policy']}",
                                                        "Protocol": "NA",
                                                        "SourceCidr": "NA",
                                                        "SourcePort": "NA",
                                                        "Status": "Blocked"
                                                      }
                                                    },
                                                    "description": "To create action JSON object"
                                                  }
                                                },
                                                "else": {
                                                  "actions": {
                                                    "Append_to_consolidated_action_variable_for_IP_address_allowed_in_firewall": {
                                                      "runAfter": {
                                                        "Set_action_variable_for_IP_address_allowed_in_firewall": [
                                                          "Succeeded"
                                                        ]
                                                      },
                                                      "type": "AppendToArrayVariable",
                                                      "inputs": {
                                                        "name": "ConsolidatedAction",
                                                        "value": "@variables('Action')"
                                                      },
                                                      "description": " To append action JSON object"
                                                    },
                                                    "Set_action_variable_for_IP_address_allowed_in_firewall": {
                                                      "type": "SetVariable",
                                                      "inputs": {
                                                        "name": "Action",
                                                        "value": {
                                                          "Comment": "Allowed using L3 & L7 firewall rules",
                                                          "DestinationCidr": "@{outputs('Compose_L3_firewall_rule')?['destCidr']}",
                                                          "DestinationPort": "@{outputs('Compose_L3_firewall_rule')?['destPort']}",
                                                          "IP": "@{items('For_each_IP_Address')?['Address']}",
                                                          "NetworkName": "@{items('For_each_Network')?['name']}",
                                                          "Policy": "@{outputs('Compose_L3_firewall_rule')?['policy']}",
                                                          "Protocol": "@{outputs('Compose_L3_firewall_rule')?['protocol']}",
                                                          "SourceCidr": "@{outputs('Compose_L3_firewall_rule')?['srcCidr']}",
                                                          "SourcePort": "@{outputs('Compose_L3_firewall_rule')?['srcPort']}",
                                                          "Status": "Allowed"
                                                        }
                                                      },
                                                      "description": "To create action json object"
                                                    }
                                                  }
                                                },
                                                "expression": {
                                                  "and": [
                                                    {
                                                      "greater": [
                                                        "@length(body('Filter_L7_firewall_rule'))",
                                                        0
                                                      ]
                                                    }
                                                  ]
                                                },
                                                "type": "If",
                                                "description": " Condition to check if IP address exists in L7 firewall rule"
                                              }
                                            }
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "equals": [
                                                  "@outputs('Compose_L3_firewall_rule')?['Policy']",
                                                  "deny"
                                                ]
                                              }
                                            ]
                                          },
                                          "type": "If",
                                          "description": "Condition to check if IP address is blocked by L3 firewall"
                                        },
                                        "Compose_L3_firewall_rule": {
                                          "type": "Compose",
                                          "inputs": "@body('Filter_L3_firewall_rule')?[0]",
                                          "description": "To create firewall rule item"
                                        }
                                      },
                                      "runAfter": {
                                        "Filter_L7_firewall_rule": [
                                          "Succeeded"
                                        ]
                                      },
                                      "else": {
                                        "actions": {
                                          "Check_if_IP_Address_exists_in_L7_firewall_rule": {
                                            "actions": {
                                              "Append_to_consolidated_action_variable_for_blocked_IP_address_in_L7_firewall": {
                                                "runAfter": {
                                                  "Set_action_variable_for_blocked_IP_address_in_L7_firewall": [
                                                    "Succeeded"
                                                  ]
                                                },
                                                "type": "AppendToArrayVariable",
                                                "inputs": {
                                                  "name": "ConsolidatedAction",
                                                  "value": "@variables('Action')"
                                                },
                                                "description": "To append action JSON object"
                                              },
                                              "Compose_L7_Firewall_rule_item": {
                                                "type": "Compose",
                                                "inputs": "@body('Filter_L7_firewall_rule')?[0]",
                                                "description": "To create firewall rule item"
                                              },
                                              "Set_action_variable_for_blocked_IP_address_in_L7_firewall": {
                                                "runAfter": {
                                                  "Compose_L7_Firewall_rule_item": [
                                                    "Succeeded"
                                                  ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                  "name": "Action",
                                                  "value": {
                                                    "Comment": "Blocked using L7 firewall rule",
                                                    "DestinationCidr": "@{outputs('Compose_L7_firewall_rule_item')?['value']}",
                                                    "DestinationPort": "NA",
                                                    "IP": "@{items('For_each_IP_Address')?['Address']}",
                                                    "NetworkName": "@{items('For_each_Network')?['name']}",
                                                    "Policy": "@{outputs('Compose_L7_firewall_rule_item')?['policy']}",
                                                    "Protocol": "NA",
                                                    "SourceCidr": "NA",
                                                    "SourcePort": "NA",
                                                    "Status": "Blocked"
                                                  }
                                                },
                                                "description": "To create action JSON object"
                                              }
                                            },
                                            "else": {
                                              "actions": {
                                                "Append_to_consolidated_action_variable_for_new_IP_address": {
                                                  "runAfter": {
                                                    "Set_action_variable_for_new_IP_address": [
                                                      "Succeeded"
                                                    ]
                                                  },
                                                  "type": "AppendToArrayVariable",
                                                  "inputs": {
                                                    "name": "ConsolidatedAction",
                                                    "value": "@variables('Action')"
                                                  },
                                                  "description": " To append action JSON object"
                                                },
                                                "Set_action_variable_for_new_IP_address": {
                                                  "type": "SetVariable",
                                                  "inputs": {
                                                    "name": "Action",
                                                    "value": {
                                                      "Comment": "Not Found using L3 & L7 firewall rules",
                                                      "DestinationCidr": "@{items('For_each_IP_Address')?['Address']}",
                                                      "DestinationPort": "NA",
                                                      "IP": "@{items('For_each_IP_Address')?['Address']}",
                                                      "NetworkName": "@{items('For_each_Network')?['name']}",
                                                      "Policy": "NA",
                                                      "Protocol": "NA",
                                                      "SourceCidr": "NA",
                                                      "SourcePort": "NA",
                                                      "Status": "Not Found"
                                                    }
                                                  },
                                                  "description": "To create JSON action object"
                                                }
                                              }
                                            },
                                            "expression": {
                                              "and": [
                                                {
                                                  "greater": [
                                                    "@length(body('Filter_L7_firewall_rule'))",
                                                    0
                                                  ]
                                                }
                                              ]
                                            },
                                            "type": "If",
                                            "description": "Condition to check if IP address exists in L7 firewall rule"
                                          }
                                        }
                                      },
                                      "expression": {
                                        "and": [
                                          {
                                            "greater": [
                                              "@length(body('Filter_L3_firewall_rule'))",
                                              0
                                            ]
                                          }
                                        ]
                                      },
                                      "type": "If",
                                      "description": "Condition to check if IP address exists in L3 firewall rule"
                                    },
                                    "Filter_L3_firewall_rule": {
                                      "type": "Query",
                                      "inputs": {
                                        "from": "@body('Get_Network_Appliance_Firewall_L3_Firewall_Rules')?['rules']",
                                        "where": "@contains(item()?['destCidr'], items('For_each_IP_Address')?['Address'])"
                                      },
                                      "description": "To filter rule detail from get network appliance L3 firewall rule action based on IP address"
                                    },
                                    "Filter_L7_firewall_rule": {
                                      "runAfter": {
                                        "Filter_L3_firewall_rule": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Query",
                                      "inputs": {
                                        "from": "@body('Get_Network_Appliance_Firewall_L7_Firewall_Rules')?['rules']",
                                        "where": "@contains(item()?['value'], items('For_each_IP_Address')?['Address'])"
                                      },
                                      "description": " To filter rule detail from get network appliance L7 firewall rule action based on IP address"
                                    }
                                  },
                                  "runAfter": {
                                    "Get_Network_Appliance_Firewall_L7_Firewall_Rules": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "Foreach",
                                  "description": "For each loop for IP address from Microsoft Sentinel",
                                  "runtimeConfiguration": {
                                    "concurrency": {
                                      "repetitions": 1
                                    }
                                  }
                                },
                                "Get_Network_Appliance_Firewall_L3_Firewall_Rules": {
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                      }
                                    },
                                    "method": "get",
                                    "path": "/networks/@{encodeURIComponent(items('For_each_Network')?['id'])}/appliance/firewall/l3FirewallRules"
                                  }
                                },
                                "Get_Network_Appliance_Firewall_L7_Firewall_Rules": {
                                  "runAfter": {
                                    "Get_Network_Appliance_Firewall_L3_Firewall_Rules": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                      }
                                    },
                                    "method": "get",
                                    "path": "/networks/@{encodeURIComponent(items('For_each_Network')?['id'])}/appliance/firewall/l7FirewallRules"
                                  }
                                }
                              },
                              "runAfter": {
                                "Get_Networks": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Foreach",
                              "description": "For each loop for network",
                              "runtimeConfiguration": {
                                "concurrency": {
                                  "repetitions": 1
                                }
                              }
                            },
                            "Get_Networks": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                  }
                                },
                                "method": "get",
                                "path": "/organizations/@{encodeURIComponent(body('Filter_Organization')?[0]?['id'])}/networks",
                                "queries": {
                                  "perPage": 1000
                                }
                              }
                            }
                          },
                          "runAfter": {
                            "Filter_Organization": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "Terminate_if_organization_not_found": {
                                "type": "Terminate",
                                "inputs": {
                                  "runError": {
                                    "code": "404",
                                    "message": "Organization Not Found"
                                  },
                                  "runStatus": "Failed"
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@length(body('Filter_Organization'))",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If",
                          "description": "Condition to check if filtered organization is same as organization"
                        },
                        "Filter_Organization": {
                          "runAfter": {
                            "Get_Organizations": [
                              "Succeeded"
                            ]
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@body('Get_Organizations')",
                            "where": "@equals(item()?['name'], parameters('OrganizationName'))"
                          },
                          "description": "To filter organization detail from get organizations action based on organization name"
                        },
                        "Get_Organizations": {
                          "type": "ApiConnection",
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/organizations"
                          }
                        }
                      },
                      "runAfter": {
                        "Cisco_Meraki_Logo": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Terminate_if_IP_Address_not_found": {
                            "type": "Terminate",
                            "inputs": {
                              "runError": {
                                "code": "404",
                                "message": "IP Address Not Found in Microsoft Sentinel Incident"
                              },
                              "runStatus": "Failed"
                            }
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "contains": [
                              "@outputs('Entities_-_Get_IPs')",
                              "body"
                            ]
                          },
                          {
                            "greater": [
                              "@length(body('Entities_-_Get_IPs')?['IPs'])",
                              0
                            ]
                          }
                        ]
                      },
                      "type": "If",
                      "description": "Condition to check if body present in the sentinel incident"
                    },
                    "Cisco_Meraki_Logo": {
                      "runAfter": {
                        "Initialize_consolidated_action_array_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "<img src=\"https://www.kellerschroeder.com/wp-content/uploads/2017/05/Cisco-Meraki.jpg\" alt=\"CiscoMerakiLogo\" width=\"32\" height=\"32\">",
                      "description": "To store meraki logo"
                    },
                    "Entities_-_Get_IPs": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "Initialize_action_object_variable": {
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Action",
                            "type": "object"
                          }
                        ]
                      },
                      "description": "To create JSON action object"
                    },
                    "Initialize_consolidated_action_array_variable": {
                      "runAfter": {
                        "Initialize_action_object_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "ConsolidatedAction",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "To create consolidated action array variable for incident comment"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "MerakiConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Meraki_Connection'))]",
                        "connectionName": "[[variables('Meraki_Connection')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/customApis/',parameters('CiscoMerakiConnectorName'))]"
                      },
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]",
                        "connectionName": "[[variables('AzureSentinel_Connection')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "MICROSOFT.WEB/CONNECTIONS",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Meraki_Connection')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "parameterValues": {
                  "api_key": "[variables('blanks')]"
                }
              }
            },
            {
              "type": "MICROSOFT.WEB/CONNECTIONS",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinel_Connection')]",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('AzureSentinel_Connection')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId5'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId5')]",
                "contentId": "[variables('_playbookContentId5')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoMeraki",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_MerakiConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "IP Address Enrichment - Cisco Meraki",
            "description": "This playbook checks if malicious IP address is blocked or unblocked by Cisco Meraki MX network.",
            "mainSteps": [
              "1. Fetches a list of potentially malicious IP addresses",
              "2. Enrich the incident with IP status information."
            ],
            "prerequisites": [
              "1. Deploy the Cisco Meraki Custom Connector before the deployment of this playbook under the same subscription and same resource group. Capture the name of the connector during deployment.",
              "2. Cisco Meraki API Key should be known to establish a connection with Cisco Meraki Custom Connector.",
              "3. Organization name should be known."
            ],
            "postDeployment": [
              "**a. Authorize API connection**",
              "Once deployment is complete, go under deployment details and authorize Cisco Meraki connection.",
              "1.  Click the Cisco Meraki connection",
              "2.  Click **Edit API connection**",
              "3.  Enter API Key",
              "4.  Click Save",
              "**b. Configurations in Sentinel**",
              "- In Microsoft Sentinel analytical rules should be configured to trigger an incident with IP addresses.",
              "- Configure the automation rules to trigger the playbook."
            ],
            "lastUpdateTime": "2021-07-28T00:00:00Z",
            "entities": [
              "IP"
            ],
            "tags": [
              "Enrichment"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "IP Address Enrichment - Cisco Meraki",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId5')]",
        "contentKind": "Playbook",
        "displayName": "IP-Enrichment-Meraki",
        "contentProductId": "[variables('_playbookcontentProductId5')]",
        "id": "[variables('_playbookcontentProductId5')]",
        "version": "[variables('playbookVersion5')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "URL-Enrichment-Meraki Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion6')]",
          "parameters": {
            "PlaybookName": {
              "type": "string",
              "defaultValue": "URL-Enrichment-Meraki",
              "metadata": {
                "description": "Enter name for URL Enrichment playbook without spaces"
              },
              "minLength": 3
            },
            "CiscoMerakiConnectorName": {
              "type": "string",
              "defaultValue": "MerakiConnector",
              "metadata": {
                "description": "Enter name of Cisco Meraki custom connector without spaces"
              },
              "minLength": 3
            },
            "OrganizationName": {
              "type": "string",
              "metadata": {
                "description": "Enter organization name"
              },
              "minLength": 3
            }
          },
          "variables": {
            "Meraki_Connection": "[[concat('Meraki-', parameters('PlaybookName'))]",
            "AzureSentinel_Connection": "[[concat('Azuresentinel-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/customApis/',parameters('CiscoMerakiConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('Meraki_Connection'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]"
              ],
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "OrganizationName": {
                      "defaultValue": "[[parameters('OrganizationName')]",
                      "type": "String"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Check_if_body_present_in_Azure_Sentinel_incident": {
                      "actions": {
                        "Check_if_Organization_exists": {
                          "actions": {
                            "Add_comment_to_incident": {
                              "runAfter": {
                                "Create_Incident_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "message": "<p>@{outputs('Cisco_Meraki_Logo')} <strong>Cisco Meraki URL Enrichment Playbook<br>\n<br>\n</strong>Below incident URL(s) are found in Microsoft Sentinel have the following status in networks for organization - <strong></strong><strong>@{parameters('OrganizationName')}</strong><strong></strong><br>\n@{body('Create_Incident_HTML_table')}</p>"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/Comment"
                              }
                            },
                            "Create_Incident_HTML_table": {
                              "runAfter": {
                                "For_each_Network": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "columns": [
                                  {
                                    "header": "Incident URL",
                                    "value": "@item()?['URL']"
                                  },
                                  {
                                    "header": "Network Name",
                                    "value": "@item()?['NetworkName']"
                                  },
                                  {
                                    "header": "Status",
                                    "value": "@item()?['Status']"
                                  },
                                  {
                                    "header": "Comment",
                                    "value": "@item()?['Comment']"
                                  }
                                ],
                                "format": "HTML",
                                "from": "@variables('ConsolidatedAction')"
                              },
                              "description": "To create incident HTML table from consolidated action array"
                            },
                            "For_each_Network": {
                              "foreach": "@body('Get_Networks')",
                              "actions": {
                                "For_each_URL": {
                                  "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                                  "actions": {
                                    "Check_if_URL_is_allowed": {
                                      "actions": {
                                        "Append_to_consolidated_action_variable_for_allowed_URL": {
                                          "runAfter": {
                                            "Set_action_variable_for_allowed_URL": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "AppendToArrayVariable",
                                          "inputs": {
                                            "name": "ConsolidatedAction",
                                            "value": "@variables('Action')"
                                          },
                                          "description": "To append action JSON object"
                                        },
                                        "Set_action_variable_for_allowed_URL": {
                                          "type": "SetVariable",
                                          "inputs": {
                                            "name": "Action",
                                            "value": {
                                              "Comment": "Allowed using content filtering",
                                              "NetworkName": "@{items('For_each_Network')?['name']}",
                                              "Status": "Allowed",
                                              "URL": "@{items('For_each_URL')?['Url']}"
                                            }
                                          },
                                          "description": "To create action JSON object for allowed URL"
                                        }
                                      },
                                      "runAfter": {
                                        "Filter_Blocked_URL_Pattern": [
                                          "Succeeded"
                                        ]
                                      },
                                      "else": {
                                        "actions": {
                                          "Check_if_URL_is_blocked": {
                                            "actions": {
                                              "Append_to_consolidated_action_variable_for_blocked_URL": {
                                                "runAfter": {
                                                  "Set_action_variable_for_blocked_URL": [
                                                    "Succeeded"
                                                  ]
                                                },
                                                "type": "AppendToArrayVariable",
                                                "inputs": {
                                                  "name": "ConsolidatedAction",
                                                  "value": "@variables('Action')"
                                                },
                                                "description": "To append action JSON object"
                                              },
                                              "Set_action_variable_for_blocked_URL": {
                                                "type": "SetVariable",
                                                "inputs": {
                                                  "name": "Action",
                                                  "value": {
                                                    "Comment": "Blocked using content filtering",
                                                    "NetworkName": "@{items('For_each_Network')?['name']}",
                                                    "Status": "Blocked",
                                                    "URL": "@{items('For_each_URL')?['Url']}"
                                                  }
                                                },
                                                "description": "To create action JSON object for blocked URL"
                                              }
                                            },
                                            "else": {
                                              "actions": {
                                                "Append_to_consolidated_action_variable": {
                                                  "runAfter": {
                                                    "Set_action_variable": [
                                                      "Succeeded"
                                                    ]
                                                  },
                                                  "type": "AppendToArrayVariable",
                                                  "inputs": {
                                                    "name": "ConsolidatedAction",
                                                    "value": "@variables('Action')"
                                                  },
                                                  "description": "To append action JSON object"
                                                },
                                                "Set_action_variable": {
                                                  "type": "SetVariable",
                                                  "inputs": {
                                                    "name": "Action",
                                                    "value": {
                                                      "Comment": "Not Found using content filtering",
                                                      "NetworkName": "@{items('For_each_Network')?['name']}",
                                                      "Status": "Not Found",
                                                      "URL": "@{items('For_each_URL')?['Url']}"
                                                    }
                                                  },
                                                  "description": "To create action JSON object"
                                                }
                                              }
                                            },
                                            "expression": {
                                              "and": [
                                                {
                                                  "greater": [
                                                    "@length(body('Filter_Blocked_URL_Pattern'))",
                                                    0
                                                  ]
                                                }
                                              ]
                                            },
                                            "type": "If",
                                            "description": "Condition to check if URL belongs to blocked URL patterns"
                                          }
                                        }
                                      },
                                      "expression": {
                                        "and": [
                                          {
                                            "greater": [
                                              "@length(body('Filter_Allowed_URL_Pattern'))",
                                              0
                                            ]
                                          }
                                        ]
                                      },
                                      "type": "If",
                                      "description": "Condition to check if URL belongs to allowed URL patterns"
                                    },
                                    "Filter_Allowed_URL_Pattern": {
                                      "type": "Query",
                                      "inputs": {
                                        "from": "@body('Get_Network_Appliance_Content_Filtering')?['allowedUrlPatterns']",
                                        "where": "@contains(item(), items('For_each_URL')?['Url'])"
                                      },
                                      "description": "To filter allowed URL pattern from get network appliance content filtering action based on URL"
                                    },
                                    "Filter_Blocked_URL_Pattern": {
                                      "runAfter": {
                                        "Filter_Allowed_URL_Pattern": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Query",
                                      "inputs": {
                                        "from": "@body('Get_Network_Appliance_Content_Filtering')?['blockedUrlPatterns']",
                                        "where": "@contains(item(), items('For_each_URL')?['Url'])"
                                      },
                                      "description": "To filter blocked URL pattern from get network appliance content filtering action based on URL"
                                    }
                                  },
                                  "runAfter": {
                                    "Get_Network_Appliance_Content_Filtering": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "Foreach",
                                  "description": "For each loop for URLs from Microsoft Sentinel",
                                  "runtimeConfiguration": {
                                    "concurrency": {
                                      "repetitions": 1
                                    }
                                  }
                                },
                                "Get_Network_Appliance_Content_Filtering": {
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                      }
                                    },
                                    "method": "get",
                                    "path": "/networks/@{encodeURIComponent(items('For_each_Network')?['id'])}/appliance/contentFiltering"
                                  }
                                }
                              },
                              "runAfter": {
                                "Get_Networks": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Foreach",
                              "description": " For each loop for network",
                              "runtimeConfiguration": {
                                "concurrency": {
                                  "repetitions": 1
                                }
                              }
                            },
                            "Get_Networks": {
                              "type": "ApiConnection",
                              "inputs": {
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                                  }
                                },
                                "method": "get",
                                "path": "/organizations/@{encodeURIComponent(body('Filter_Organization')?[0]?['id'])}/networks",
                                "queries": {
                                  "perPage": 1000
                                }
                              }
                            }
                          },
                          "runAfter": {
                            "Filter_Organization": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "Terminate_if_organization_not_found": {
                                "type": "Terminate",
                                "inputs": {
                                  "runError": {
                                    "code": "404",
                                    "message": "Organization Not Found"
                                  },
                                  "runStatus": "Failed"
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@length(body('Filter_Organization'))",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If",
                          "description": "Condition to check if filtered organization is same as organization"
                        },
                        "Filter_Organization": {
                          "runAfter": {
                            "Get_Organizations": [
                              "Succeeded"
                            ]
                          },
                          "type": "Query",
                          "inputs": {
                            "from": "@body('Get_Organizations')",
                            "where": "@equals(item()?['name'], parameters('OrganizationName'))"
                          },
                          "description": "To filter organization detail from get organizations action based on organization name"
                        },
                        "Get_Organizations": {
                          "type": "ApiConnection",
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['MerakiConnector']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/organizations"
                          }
                        }
                      },
                      "runAfter": {
                        "Cisco_Meraki_Logo": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Terminate_if_URL_not_found": {
                            "type": "Terminate",
                            "inputs": {
                              "runError": {
                                "code": "404",
                                "message": "URL Not Found in Microsoft Sentinel Incident"
                              },
                              "runStatus": "Failed"
                            }
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "contains": [
                              "@outputs('Entities_-_Get_URLs')",
                              "body"
                            ]
                          },
                          {
                            "greater": [
                              "@length(body('Entities_-_Get_URLs')?['URLs'])",
                              0
                            ]
                          }
                        ]
                      },
                      "type": "If",
                      "description": "Condition to check if body present in the sentinel incident"
                    },
                    "Cisco_Meraki_Logo": {
                      "runAfter": {
                        "Initialize_consolidated_action_array_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "<img src=\"https://www.kellerschroeder.com/wp-content/uploads/2017/05/Cisco-Meraki.jpg\" alt=\"CiscoMerakiLogo\" width=\"32\" height=\"32\">",
                      "description": "To store meraki logo"
                    },
                    "Entities_-_Get_URLs": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/url"
                      }
                    },
                    "Initialize_action_object_variable": {
                      "runAfter": {
                        "Entities_-_Get_URLs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Action",
                            "type": "object"
                          }
                        ]
                      },
                      "description": "To create JSON action object"
                    },
                    "Initialize_consolidated_action_array_variable": {
                      "runAfter": {
                        "Initialize_action_object_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "ConsolidatedAction",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "To create consolidated action array variable for incident comment"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "MerakiConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Meraki_Connection'))]",
                        "connectionName": "[[variables('Meraki_Connection')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/customApis/',parameters('CiscoMerakiConnectorName'))]"
                      },
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]",
                        "connectionName": "[[variables('AzureSentinel_Connection')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "MICROSOFT.WEB/CONNECTIONS",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Meraki_Connection')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "parameterValues": {
                  "api_key": "[variables('blanks')]"
                }
              }
            },
            {
              "type": "MICROSOFT.WEB/CONNECTIONS",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinel_Connection')]",
              "kind": "V1",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('AzureSentinel_Connection')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId6'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId6')]",
                "contentId": "[variables('_playbookContentId6')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "CiscoMeraki",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_MerakiConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "URL Enrichment - Cisco Meraki",
            "description": "This playbook checks if malicious URL is blocked or unblocked by Cisco Meraki network.",
            "mainSteps": [
              "1. Fetches a list of potentially malicious URLs",
              "2. Enrich the incident with URL status information."
            ],
            "prerequisites": [
              "1. Deploy the Cisco Meraki Custom Connector before the deployment of this playbook under the same subscription and same resource group. Capture the name of the connector during deployment.",
              "2. Cisco Meraki API Key should be known to establish a connection with Cisco Meraki Custom Connector.",
              "3. Organization name should be known."
            ],
            "postDeployment": [
              "**a. Authorize API connection**",
              "Once deployment is complete, go under deployment details and authorize Cisco Meraki connection.",
              "1.  Click the Cisco Meraki connection",
              "2.  Click **Edit API connection**",
              "3.  Enter API Key",
              "4.  Click Save",
              "**b. Configurations in Sentinel**",
              "- In Microsoft Sentinel analytical rules should be configured to trigger an incident with URLs.",
              "- Configure the automation rules to trigger the playbook."
            ],
            "lastUpdateTime": "2021-07-28T00:00:00Z",
            "entities": [
              "URL"
            ],
            "tags": [
              "Enrichment"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "URL Enrichment - Cisco Meraki",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId6')]",
        "contentKind": "Playbook",
        "displayName": "URL-Enrichment-Meraki",
        "contentProductId": "[variables('_playbookcontentProductId6')]",
        "id": "[variables('_playbookcontentProductId6')]",
        "version": "[variables('playbookVersion6')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.1",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "CiscoMeraki",
        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
        "descriptionHtml": "<p><strong>Note:</strong> <em>There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</em></p>\n<p>TheCisco Merakisolution allows you to easily connect your Cisco Meraki (MX/MR/MS) logs with Microsoft Sentinel. This gives you more insight into your organization's network and improves your security operation capabilities.</p>\n<p><strong>Underlying Microsoft Technologies used:</strong></p>\n<p>This solution takes a dependency on the following technologies, and some of these dependencies either may be in <a href=\"https://azure.microsoft.com/support/legal/preview-supplemental-terms/\">Preview</a> state or might result in additional ingestion or operational costs:</p>\n<ol type=\"a\">\n<li><a href=\"https://learn.microsoft.com/en-us/azure/sentinel/connect-common-event-format?WT.mc_id=Portal-fx\">Agent-based log collection (CEF over Syslog)</a></li>\n</ol>\n<p><strong>Data Connectors:</strong> 1, <strong>Parsers:</strong> 1, <strong>Workbooks:</strong> 1, <strong>Custom Azure Logic Apps Connectors:</strong> 1, <strong>Playbooks:</strong> 5</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/CiscoMeraki/Connector/MerakiConnector/logo.jpg\"width=\"75px\"height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "CiscoMeraki",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_parserContentId1')]",
              "version": "[variables('parserVersion1')]"
            },
            {
              "kind": "LogicAppsCustomConnector",
              "contentId": "[variables('_MerakiConnector')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Block-Device-Client')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Block-IP-Address')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Block-URL')]",
              "version": "[variables('playbookVersion4')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_IP-Address-Enrichment')]",
              "version": "[variables('playbookVersion5')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_URL-Enrichment')]",
              "version": "[variables('playbookVersion6')]"
            }
          ]
        },
        "firstPublishDate": "2021-09-08",
        "providers": [
          "Cisco"
        ],
        "categories": {
          "domains": [
            "Security - Network",
            "Security - Automation (SOAR)"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
