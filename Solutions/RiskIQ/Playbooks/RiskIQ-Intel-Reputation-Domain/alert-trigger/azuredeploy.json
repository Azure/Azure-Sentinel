{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Reputation data.",
        "title": "RiskIQ-Intel-Reputation-Domain-Alert", 
        "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. Reputation information provides analyst with a decision as to whether an indicator is considered benign, suspicious or malicious. Analysts can leverage this playbook in order to enrich indicators found within an incident. Each reputation result is contained within a comment and will include detailed scoring information noting why a given indicator is considered suspicious or malicious with links back to the RiskIQ platform for more information.",
        "prerequisites": ["This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."],
        "lastUpdateTime": "2022-08-05T00:00:00.000Z", 
        "entities": [], 
        "tags": [], 
        "postDeployment": [
            "After deploying the playbook, you must authorize the connections leveraged.", 
            "1. Visit the playbook resource.", 
            "2. Under 'Development Tools' (located on the left), click 'API Connections'.", 
            "3. Ensure each connection has been authorized.", 
            "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"],
        "support": {
            "tier": "microsoft" 
        },
        "author": {
            "name": "Brandon Dixon, RiskIQ"
        },
        "releaseNotes": [
        {
            "version": "1.0.0",
            "title": "RiskIQ Intel Reputation Domain Alert",
            "notes": [
                "Initial version"
            ]
        }
        ]
    },
    "parameters": {
        "PlaybookName": {
            "defaultValue": "RiskIQ-Intel-Reputation-Domain",
            "type": "string"
        }
    },
    "variables": {
        "AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('PlaybookName'))]",
        "RiskIQConnectionName": "riskiq-shared"
    },
    "resources": [{
        "type": "Microsoft.Web/connections",
        "apiVersion": "2016-06-01",
        "name": "[variables('RiskIQConnectionName')]",
        "location": "[resourceGroup().location]",
        "properties": {
            "api": {
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/riskiqpassivetotal')]"
            }
        }
    }, {
        "type": "Microsoft.Web/connections",
        "apiVersion": "2016-06-01",
        "name": "[variables('AzureSentinelConnectionName')]",
        "location": "[resourceGroup().location]",
        "properties": {
            "api": {
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azuresentinel')]"
            }
        }
    }, {
        "type": "Microsoft.Logic/workflows",
        "apiVersion": "2017-07-01",
        "name": "[parameters('PlaybookName')]",
        "location": "[resourceGroup().location]",
        "tags": {
            "LogicAppsCategory": "security"
        },
        "dependsOn": [
            "[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
            "[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
        ],
        "properties": {
            "state": "Enabled",
            "definition": {
                "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                "actions": {
                    "Alert_-_Get_incident": {
                        "inputs": {
                            "host": {
                                "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                }
                            },
                            "method": "get",
                            "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                        },
                        "runAfter": {},
                        "type": "ApiConnection"
                    },
                    "Entities_-_Get_Hosts": {
                        "inputs": {
                            "body": "@triggerBody()?['Entities']",
                            "host": {
                                "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                }
                            },
                            "method": "post",
                            "path": "/entities/host"
                        },
                        "runAfter": {
                            "Alert_-_Get_incident": [
                                "Succeeded"
                            ]
                        },
                        "type": "ApiConnection"
                    },
                    "For_each_Host": {
                        "actions": {
                            "Add_comment_to_incident_(V3)": {
                                "inputs": {
                                    "body": {
                                        "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                        "message": "<p>RiskIQ Reputation: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br>\nClassification: @{body('Get_reputation_for_host')?['classification']} (@{body('Get_reputation_for_host')?['score']})<br>\n@{body('Create_Host_HTML_table')}</p>"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                },
                                "runAfter": {
                                    "Create_Host_HTML_table": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            },
                            "Create_Host_HTML_table": {
                                "inputs": {
                                    "format": "HTML",
                                    "from": "@variables('result_output_host')"
                                },
                                "runAfter": {
                                    "Set_host_variable": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Table"
                            },
                            "Get_reputation_for_host": {
                                "inputs": {
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                                        }
                                    },
                                    "method": "get",
                                    "path": "/reputation",
                                    "queries": {
                                        "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                                    }
                                },
                                "runAfter": {},
                                "type": "ApiConnection"
                            },
                            "Set_host_variable": {
                                "inputs": {
                                    "name": "result_output_host",
                                    "value": "@body('Get_reputation_for_host')?['rules']"
                                },
                                "runAfter": {
                                    "Get_reputation_for_host": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "SetVariable"
                            }
                        },
                        "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                        "runAfter": {
                            "Init_Result_Host": [
                                "Succeeded"
                            ]
                        },
                        "type": "Foreach"
                    },
                    "Init_Result_Host": {
                        "inputs": {
                            "variables": [
                                {
                                    "name": "result_output_host",
                                    "type": "array"
                                }
                            ]
                        },
                        "runAfter": {
                            "Entities_-_Get_Hosts": [
                                "Succeeded"
                            ]
                        },
                        "type": "InitializeVariable"
                    }
                },
                "contentVersion": "1.0.0.0",
                "outputs": {},
                "parameters": {
                    "$connections": {
                        "defaultValue": {},
                        "type": "Object"
                    }
                },
                "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                        "inputs": {
                            "body": {
                                "callback_url": "@{listCallbackUrl()}"
                            },
                            "host": {
                                "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                }
                            },
                            "path": "/subscribe"
                        },
                        "type": "ApiConnectionWebhook"
                    }
                }
            },
            "parameters": {
                "$connections": {
                    "value": {
                        "azuresentinel": {
                            "connectionId": "[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                            "connectionName": "[variables('AzureSentinelConnectionName')]",
                            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azuresentinel')]"
                        },
                        "riskiqpassivetotal": {
                            "connectionId": "[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                            "connectionName": "[variables('RiskIQConnectionName')]",
                            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/riskiqpassivetotal')]"
                        }
                    }
                }
            }
        }
    }]
}