{
    "version": "Notebook/1.0",
    "items": [
      {
        "type": 1,
        "content": {
          "json": "<div style=\"font-size: 200%;\">Azure CloudNGFW By Palo Alto Networks - Overview</div>"
        },
        "name": "text - 0"
      },
      {
        "type": 9,
        "content": {
          "version": "KqlParameterItem/1.0",
          "query": "",
          "crossComponentResources": [],
          "parameters": [
            {
              "id": "a5c18655-3e2d-4d12-8ba4-82e57b296581",
              "version": "KqlParameterItem/1.0",
              "name": "TimeRange",
              "type": 4,
              "isRequired": true,
              "value": {
                "durationMs": 2592000000
              },
              "typeSettings": {
                "selectableValues": [
                  {
                    "durationMs": 300000
                  },
                  {
                    "durationMs": 900000
                  },
                  {
                    "durationMs": 1800000
                  },
                  {
                    "durationMs": 3600000
                  },
                  {
                    "durationMs": 14400000
                  },
                  {
                    "durationMs": 43200000
                  },
                  {
                    "durationMs": 86400000
                  },
                  {
                    "durationMs": 172800000
                  },
                  {
                    "durationMs": 259200000
                  },
                  {
                    "durationMs": 604800000
                  },
                  {
                    "durationMs": 1209600000
                  },
                  {
                    "durationMs": 2419200000
                  },
                  {
                    "durationMs": 2592000000
                  },
                  {
                    "durationMs": 5184000000
                  },
                  {
                    "durationMs": 7776000000
                  }
                ],
                "allowCustom": true
              }
            },
            {
                "id": "32f5a8aa-9c54-4fd1-a2b9-8461b2c57f55",
                "version": "KqlParameterItem/1.0",
                "name": "Source_IP",
                "label": "Source IP",
                "type": 2,
                "isRequired": true,
                "multiSelect": true,
                "quote": "'",
                "delimiter": ",",
                "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where ident_s in ('TRAFFIC', 'DECRYPTION', 'THREAT')\n| extend SourceIP = tostring(parse_json(Message).src_ip)\n| summarize Count = count()/1000 by SourceIP\n| where SourceIP != \"\"\n| order by Count desc, SourceIP asc\n| project Value = SourceIP, Label = strcat(SourceIP, \" - \", Count, \"k\"), Selected = false\n",
                "value": [
                  "value::all"
                ],
                "typeSettings": {
                  "additionalResourceOptions": [
                    "value::all"
                  ],
                  "selectAllValue": "All"
                },
                "timeContext": {
                  "durationMs": 1800000
                },
                "queryType": 0,
                "resourceType": "microsoft.operationalinsights/workspaces"
            },     
            {
                "id": "b937ca33-bc62-4183-bc0f-9ad8306dc36a",
                "version": "KqlParameterItem/1.0",
                "name": "Destination_IP",
                "label": "Destination IP",
                "type": 2,
                "isRequired": true,
                "multiSelect": true,
                "quote": "'",
                "delimiter": ",",
                "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where ident_s in ('TRAFFIC', 'DECRYPTION', 'THREAT')\n| extend DestinationIP = case(ident_s == 'DECRYPTION', tostring(parse_json(Message).dst), tostring(parse_json(Message).dst_ip))\n| summarize Count = count()/1000 by DestinationIP\n| where DestinationIP != \"\"\n| order by Count desc, DestinationIP asc\n| project Value = DestinationIP, Label = strcat(DestinationIP, \" - \", Count, \"k\"), Selected = false",
                "value": [
                  "value::all"
                ],
                "typeSettings": {
                  "limitSelectTo": 10,
                  "additionalResourceOptions": [
                    "value::all"
                  ],
                  "selectAllValue": "All"
                },
                "timeContext": {
                  "durationMs": 0
                },
                "timeContextFromParameter": "TimeRange",
                "queryType": 0,
                "resourceType": "microsoft.operationalinsights/workspaces"
              }
          ],
          "style": "pills",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces"
        },
        "name": "parameters - 5"
      },
      {
        "type": 9,
        "content": {
          "version": "KqlParameterItem/1.0",
          "query": "",
          "crossComponentResources": [],
          "parameters": [
            {
              "id": "7f28bae3-a11f-408a-832f-77a0f3e633d7",
              "version": "KqlParameterItem/1.0",
              "name": "EventClass",
              "type": 2,
              "isRequired": true,
              "multiSelect": true,
              "quote": "'",
              "delimiter": ",",
              "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where ident_s == 'THREAT'\n| distinct threat_content_type",
              "value": [
                "value::all"
              ],
              "typeSettings": {
                "additionalResourceOptions": [
                  "value::all"
                ],
                "selectAllValue": "All"
              },
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            }
          ],
          "style": "pills",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces"
        },
        "name": "parameters - 35"
      },
      {
        "type": 3,
        "content": {
            "version": "KqlItem/1.0",
            "query": "let data = fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP})\n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where \"{EventClass:lable}\" == \"All\" or \"{EventClass:lable}\" == \"All\" or ident_s in ({EventClass});\ndata\n| summarize Count = count() by ident_s\n| join kind = inner (data\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by ident_s)\non ident_s\n| project-away ident_s1, TimeGenerated\n| extend Activities = ident_s\n| union (\ndata \n | summarize Count = count() \n | extend jkey = 1\n | join kind=inner (data\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\n | extend jkey = 1) on jkey\n | extend ident_s = 'All', Activities = '*' \n)\n| order by Count desc\n| take 10",
            "size": 4,
            "exportFieldName": "Activities",
            "exportParameterName": "activities",
            "exportDefaultValue": "All",
            "exportToExcelOptions": "visible",
            "title": "Activities, by volume",
            "timeContext": {
                "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "visualization": "tiles",
            "gridSettings": {
                "formatters": [
                    {
                        "columnMatch": "Activities",
                        "formatter": 0,
                        "formatOptions": {
                            "showIcon": true
                        }
                    },
                    {
                        "columnMatch": "Count",
                        "formatter": 8,
                        "formatOptions": {
                            "palette": "blueDark",
                            "showIcon": true
                        }
                    },
                    {
                        "columnMatch": "Trend",
                        "formatter": 9,
                        "formatOptions": {
                            "palette": "lightBlue",
                            "showIcon": true
                        }
                    },
                    {
                        "columnMatch": "Activities",
                        "formatter": 5,
                        "formatOptions": {
                            "showIcon": true
                        }
                    },
                    {
                        "columnMatch": "jkey",
                        "formatter": 5,
                        "formatOptions": {
                            "showIcon": true
                        }
                    },
                    {
                        "columnMatch": "TimeGenerated",
                        "formatter": 5,
                        "formatOptions": {
                            "showIcon": true
                        }
                    },
                    {
                        "columnMatch": "jkey1",
                        "formatter": 5,
                        "formatOptions": {
                            "showIcon": true
                        }
                    }
                ],
                "labelSettings": []
            },
            "tileSettings": {
                "titleContent": {
                    "columnMatch": "Activities",
                    "formatter": 1,
                    "formatOptions": {
                        "showIcon": true
                    }
                },
                "leftContent": {
                    "columnMatch": "Count",
                    "formatter": 12,
                    "formatOptions": {
                        "palette": "auto",
                        "showIcon": true
                    },
                    "numberFormat": {
                        "unit": 17,
                        "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                        }
                    }
                },
                "secondaryContent": {
                    "columnMatch": "Trend",
                    "formatter": 9,
                    "formatOptions": {
                        "showIcon": true
                    }
                },
                "showBorder": false
            }
        },
        "name": "all activities"
      },
      {
        "type": 3,
        "content": {
            "version": "KqlItem/1.0",
            "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP})\n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where \"{EventClass:lable}\" == \"All\" or ident_s == '{EventClass}'\n| where '{activities}' == \"All\" or ident_s == '{activities}'\n| summarize LogVolume=count() by threat_content_type, bin_at(TimeGenerated, {TimeRange:grain}, {TimeRange:start})",
            "size": 0,
            "aggregation": 3,
            "exportToExcelOptions": "visible",
            "title": "Event trend, by time",
            "timeContext": {
                "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "visualization": "barchart",
            "tileSettings": {
                "showBorder": false,
                "titleContent": {
                    "columnMatch": "threat_content_type",
                    "formatter": 1
                },
                "leftContent": {
                    "columnMatch": "LogVolume",
                    "formatter": 12,
                    "formatOptions": {
                        "palette": "auto"
                    },
                    "numberFormat": {
                        "unit": 17,
                        "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                        }
                    }
                }
            }
        },
        "customWidth": "50",
        "name": "Event trend by time"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "//trend by severity\r\nfluentbit_CL\r\n| where isnotempty(FirewallName_s)\r\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \r\n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\r\n| where \"{EventClass:lable}\" == \"All\" or ident_s == 'THREAT' and Message.threat_content_type in ({EventClass})\r\n| where '{activities}' == \"All\" or ident_s == '{activities}'\r\n| summarize count() by bin_at(TimeGenerated, {TimeRange:grain},{TimeRange:start}), Message.severity\r\n",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Events severity, by time",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "barchart",
          "tileSettings": {
            "showBorder": false,
            "titleContent": {
              "columnMatch": "Message.severity",
              "formatter": 1
            },
            "leftContent": {
              "columnMatch": "count_",
              "formatter": 12,
              "formatOptions": {
                "palette": "auto"
              },
              "numberFormat": {
                "unit": 17,
                "options": {
                  "maximumSignificantDigits": 3,
                  "maximumFractionDigits": 2
                }
              }
            }
          },
          "graphSettings": {
            "type": 0,
            "topContent": {
              "columnMatch": "Message.severity",
              "formatter": 1
            },
            "centerContent": {
              "columnMatch": "count_",
              "formatter": 1,
              "numberFormat": {
                "unit": 17,
                "options": {
                  "maximumSignificantDigits": 3,
                  "maximumFractionDigits": 2
                }
              }
            }
          }
        },
        "customWidth": "50",
        "name": "Events severity over time"
      },
      {
        "type": 1,
        "content": {
          "json": "---\r\n### Traffic events summary"
        },
        "name": "text - 11"
      },
      
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "let data = fluentbit_CL\r\n| where isnotempty(FirewallName_s)\r\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \r\n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\r\n| where ident_s =~ \"THREAT\";\r\ndata\r\n| summarize Count = count() by threat_content_type\r\n| join kind = inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by threat_content_type)\r\n on threat_content_type\r\n| project-away threat_content_type1, TimeGenerated\r\n| extend threat_content_types = threat_content_type\r\n| union (\r\n data \r\n | summarize Count = count() \r\n | extend jkey = 1\r\n | join kind=inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n | extend jkey = 1) on jkey\r\n | extend threat_content_type = 'All', threat_content_types = '*' \r\n)\r\n| order by Count desc\r\n| take 10",
          "size": 4,
          "exportFieldName": "threat_content_type",
          "exportParameterName": "EventClass",
          "exportDefaultValue": "All",
          "exportToExcelOptions": "visible",
          "title": "Threat event type summary - click to filter the graph below",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "tiles",
          "tileSettings": {
            "titleContent": {
              "columnMatch": "threat_content_type",
              "formatter": 1,
              "formatOptions": {
                "showIcon": true
              }
            },
            "leftContent": {
              "columnMatch": "Count",
              "formatter": 12,
              "formatOptions": {
                "palette": "auto",
                "showIcon": true
              },
              "numberFormat": {
                "unit": 17,
                "options": {
                  "style": "decimal",
                  "maximumFractionDigits": 2,
                  "maximumSignificantDigits": 3
                }
              }
            },
            "secondaryContent": {
              "columnMatch": "Trend",
              "formatter": 9,
              "formatOptions": {
                "showIcon": true
              }
            },
            "showBorder": false
          }
        },
        "customWidth": "50",
        "name": "Threat event summary"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "let data = fluentbit_CL\r\n| where isnotempty(FirewallName_s)\r\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \r\n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\r\n| where ident_s =~ \"TRAFFIC\";\r\ndata\r\n| summarize Count = count() by Message.action\r\n| join kind = inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by Message.action)\r\n on Message.action\r\n| project-away Message.action1, TimeGenerated\r\n| extend Message.action = Message.action\r\n| union (\r\n data \r\n | summarize Count = count() \r\n | extend jkey = 1\r\n | join kind=inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n | extend jkey = 1) on jkey\r\n | extend Message.action = 'All', Message.actions = '*' \r\n)\r\n| order by Count desc\r\n| take 10",
          "size": 4,
          "exportFieldName": "Message.action",
          "exportParameterName": "Message.action",
          "exportDefaultValue": "All",
          "exportToExcelOptions": "visible",
          "title": "Traffic action summary - click to filter the graph below",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "tiles",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "Message.action",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "Count",
                "formatter": 3,
                "formatOptions": {
                  "palette": "blueDark",
                  "showIcon": true
                }
              },
              {
                "columnMatch": "Trend",
                "formatter": 9,
                "formatOptions": {
                  "palette": "blueDark",
                  "showIcon": true
                }
              },
              {
                "columnMatch": "jkey",
                "formatter": 5,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "TimeGenerated",
                "formatter": 5,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "jkey1",
                "formatter": 5,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "Message.actions",
                "formatter": 5,
                "formatOptions": {
                  "showIcon": true
                }
              }
            ],
            "labelSettings": []
          },
          "tileSettings": {
            "titleContent": {
              "columnMatch": "Message.action",
              "formatter": 1,
              "formatOptions": {
                "showIcon": true
              }
            },
            "leftContent": {
              "columnMatch": "Count",
              "formatter": 12,
              "formatOptions": {
                "palette": "auto",
                "showIcon": true
              },
              "numberFormat": {
                "unit": 17,
                "options": {
                  "maximumSignificantDigits": 3,
                  "maximumFractionDigits": 2
                }
              }
            },
            "secondaryContent": {
              "columnMatch": "Trend",
              "formatter": 9,
              "formatOptions": {
                "showIcon": true
              }
            },
            "showBorder": false
          }
        },
        "customWidth": "33",
        "name": "Traffic activity summary"
      },

      {
        "type": 3,
        "content": {
            "version": "KqlItem/1.0",
            "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where '{DeviceAction}' == \"All\" or Message.action=='{DeviceAction}'\n| where ident_s =~ \"TRAFFIC\"\n| summarize EventCount= count() by Message.threat_content_type, bin_at(TimeGenerated, {TimeRange:grain}, {TimeRange:start})",
            "size": 0,
            "exportToExcelOptions": "visible",
            "title": "Traffic class ID by time",
            "timeContext": {
                "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "visualization": "barchart"
        },
        "customWidth": "50",
        "name": "Traffic class ID by time"
      },
      {
        "type": 3,
        "content": {
            "version": "KqlItem/1.0",
            "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where ident_s == 'TRAFFIC' \n| extend Reason = coalesce(\r\n                        column_ifexists(\"session_end_reason\", \"\"),\r\n                        extract(';reason=(.*?);',1,Message),\r\n                        \"\"\r\n                    )\n| summarize ReasonCount= count() by  Reason, TimeGenerated  \n",
            "size": 0,
            "exportToExcelOptions": "visible",
            "title": "Reasons for session ending, by time",
            "timeContext": {
                "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "visualization": "timechart"
        },
        "customWidth": "50",
        "name": "Reasons for session ending"
      },
    
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "// Data sent outbound vs inbound\r\nfluentbit_CL\r\n| where isnotempty(FirewallName_s)\r\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \r\n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\r\n| where ident_s =~ 'TRAFFIC'\r\n| extend Direction=iff(Message.rule=~'Trust','Outbound' ,'Inbound' )\r\n| summarize DataSentOutBoundMB=sumif(todouble(Message.bytes_sent), Direction=~'Outbound')/1048576,   DataRecievedInboundMB=sumif(todouble(Message.bytes_recv), Direction=~'Inbound')/1048576 by TimeGenerated\r\n",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Sent and received data, by volume",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "timechart"
        },
        "customWidth": "50",
        "name": "Sent and received data by volume"
      },
      {
        "type": 1,
        "content": {
          "json": "---\r\n## Web filter"
        },
        "name": "text - 12"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "fluentbit_CL\r\n| where isnotempty(FirewallName_s)\r\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \r\n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\r\n| where ident_s == 'THREAT'\r\n| where Message.threat_content_type  =~ 'url'\r\n| where Message.action contains 'block'\r\n| summarize ProtocolCount=count()  by Message.proto\r\n| top 5 by ProtocolCount desc\r\n",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Top 5 blocked URLs, by application protocol",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "Message.proto",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "ProtocolCount",
                "formatter": 4,
                "formatOptions": {
                  "min": 0,
                  "palette": "purple",
                  "showIcon": true
                }
              }
            ],
            "labelSettings": []
          }
        },
        "customWidth": "25",
        "name": "Top 5 blocked URLs by application protocol"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where ident_s == 'THREAT'\n| where Message.threat_content_type  =~ 'url'\n| where Message.action in ('block-url', 'block-continue')\n| summarize CategoryCount=count() by Message.category\n| project-rename CategoryName= Message.category\n| top 5 by CategoryCount\n",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Top 5 URL blocked, by category",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "CategoryName",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "CategoryCount",
                "formatter": 4,
                "formatOptions": {
                  "palette": "coldHot",
                  "showIcon": true
                }
              }
            ],
            "labelSettings": []
          }
        },
        "customWidth": "25",
        "name": "Top 5 URL blocked by category"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where ident_s == 'THREAT'\n| where Message.threat_content_type == 'url'\n| where Message.action in ('block-url', 'block-continue')\n| summarize URLCount=count() by tostring(Message.RequestURL)\n| top 5 by URLCount desc\n",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Top 5 blocked URLs",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces"
        },
        "customWidth": "25",
        "name": "Top 5 blocked URLs"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where ident_s == 'THREAT'\n| where Message.threat_content_type  =~ 'url'\n| summarize ProtocolCount=count() by tostring(Message.proto)\n| top 5 by ProtocolCount desc",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Top 5 URLs, by application protocols",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "Message.proto",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "ProtocolCount",
                "formatter": 4,
                "formatOptions": {
                  "palette": "coldHot",
                  "showIcon": true
                }
              }
            ],
            "labelSettings": []
          }
        },
        "customWidth": "25",
        "name": "Top 5 URLs by application protocols"
      },
      {
        "type": 3,
        "content": {
            "version": "KqlItem/1.0",
            "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where \"{Destination_IP:lable}\" == \"All\" or Message.dst_ip in ({Destination_IP})\n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where ident_s == 'THREAT'\n| where Message.threat_content_type == 'url'\n| where Message.action in ('alert', 'continue')\n| summarize URLCount=count() by tostring(Message.RequestURL)\n| top 5 by URLCount desc\n",
            "size": 0,
            "exportToExcelOptions": "visible",
            "title": "Top 5 allowed URLs",
            "timeContext": {
                "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "gridSettings": {
                "formatters": [
                    {
                        "columnMatch": "RequestURL",
                        "formatter": 0,
                        "formatOptions": {
                            "showIcon": true
                        }
                    },
                    {
                        "columnMatch": "URLCount",
                        "formatter": 4,
                        "formatOptions": {
                            "palette": "coldHot",
                            "showIcon": true
                        }
                    }
                ],
                "labelSettings": []
            }
        },
        "customWidth": "25",
        "name": "Top 5 allowed URLs"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where ident_s == 'THREAT'\n| where Message.threat_content_type == 'url'\n| summarize ActionCount=count() by Message.action\r\n",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "URL threat event summary",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "Message.action",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "ActionCount",
                "formatter": 4,
                "formatOptions": {
                  "palette": "coldHot",
                  "showIcon": true
                }
              }
            ],
            "labelSettings": []
          }
        },
        "customWidth": "25",
        "name": "URL threat event summary"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where ident_s == 'THREAT'\n| where Message.threat_content_type  =~ 'url'\n| where Message.action in ('alert', 'continue')\n| summarize CategoryCount=count() by Message.category\n| project-rename CategoryName= Message.category\n| top 5 by CategoryCount desc\n",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Top 5 allowed URLs, by category",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "CategoryName",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "CategoryCount",
                "formatter": 4,
                "formatOptions": {
                  "palette": "coldHot",
                  "showIcon": true
                }
              }
            ],
            "labelSettings": []
          }
        },
        "customWidth": "25",
        "name": "Top 5 allowed URLs, by category"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where ident_s == 'THREAT'\n| where Message.threat_content_type  =~ 'url'\n| where Message.action !contains 'block'\n| summarize ProtocolCount=count()  by Message.proto\n| top 5 by ProtocolCount desc",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Top 5 allowed URLs, by application protocol",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "table",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "Message.proto",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "ProtocolCount",
                "formatter": 4,
                "formatOptions": {
                  "palette": "coldHot",
                  "showIcon": true
                }
              }
            ],
            "labelSettings": []
          }
        },
        "customWidth": "33",
        "name": "Top 5 allowed URLs by application protocol"
    },
    {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where ident_s == 'THREAT'\n| where Message.threat_content_type  =~ 'url'\n| where Message.action !contains 'block'\n| summarize ProtocolCount=count()  by Message.proto\n| top 5 by ProtocolCount desc",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Top 5 allowed URLs, by application protocol",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "table",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "Message.proto",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "ProtocolCount",
                "formatter": 4,
                "formatOptions": {
                  "palette": "coldHot",
                  "showIcon": true
                }
              }
            ],
            "labelSettings": []
          }
        },
        "customWidth": "33",
        "name": "Top 5 allowed URLs by application protocol"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst_ip in ({Destination_IP}) \n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where ident_s == 'THREAT'\n| where Message.threat_content_type == 'url'\n| summarize ActionCount=count() by Message.action, TimeGenerated\n",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Web filter activity, by time",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "Message.action",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "TimeGenerated",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "ActionCount",
                "formatter": 4,
                "formatOptions": {
                  "palette": "coldHot",
                  "showIcon": true
                }
              }
            ],
            "labelSettings": []
          }
        },
        "customWidth": "33",
        "name": "Web filter activity by time"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where ident_s == 'THREAT'\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst in ({Destination_IP}) \n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where threat_content_type =~ 'url'\n| where Message.action in ('alert', 'continue')\n| summarize IPCount=count() by Message.src_ip\n| top 5 by IPCount  desc\n",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Top 5 allowed web traffic source IP addresses",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "Message.src_ip",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "IPCount",
                "formatter": 4,
                "formatOptions": {
                  "palette": "coldHot",
                  "showIcon": true
                }
              }
            ],
            "labelSettings": []
          }
        },
        "customWidth": "33",
        "name": "Top 5 allowed web traffic source IP addresses"
      },
      {
        "type": 1,
        "content": {
          "json": "---\r\n## Wildfire"
        },
        "name": "text - 24"
      },
      {
        "type": 3,
        "content": {
            "version": "KqlItem/1.0",
            "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where ident_s == 'THREAT'\n| where Message.threat_content_type == 'wildfire'\n| summarize ActionCount=count() by Message.action, TimeGenerated\n",
            "size": 0,
            "exportToExcelOptions": "visible",
            "title": "Wildfire events, by time",
            "timeContext": {
                "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "visualization": "timechart"
        },
        "customWidth": "50",
        "name": "Wildfire events, by time"
      },
      {
        "type": 3,
        "content": {
            "version": "KqlItem/1.0",
            "query": "let data = fluentbit_CL\r\n| where isnotempty(FirewallName_s)\r\n| where ident_s == 'THREAT'\r\n| where Message.threat_content_type =~ 'wildfire'\r\n| where \"{Destination_IP:lable}\" == \"All\" or Message.dst in ({Destination_IP})\r\n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP});\r\ndata\r\n| summarize Count = count() by Message.action\r\n| join kind = inner (data\r\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by Message.action)\r\non Message.action\r\n| project-away Message.action1, TimeGenerated\r\n| extend DeviceActions = Message.action\r\n| union (\r\ndata\r\n| summarize Count = count()\r\n| extend jkey = 1\r\n| join kind=inner (data\r\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n| extend jkey = 1) on jkey\r\n| extend Message.action = 'All', DeviceActions = '*'\r\n)\r\n| project Message.action, Count, Trend\r\n| order by Count desc\r\n| take 10",
            "size": 4,
            "exportFieldName": "Message.action",
            "exportParameterName": "Message.action",
            "exportDefaultValue": "All",
            "exportToExcelOptions": "visible",
            "title": "Top 5 Wildfire activities",
            "timeContext": {
                "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "visualization": "tiles",
            "gridSettings": {
                "formatters": [
                    {
                        "columnMatch": "Message.action",
                        "formatter": 0,
                        "formatOptions": {
                            "showIcon": true
                        }
                    },
                    {
                        "columnMatch": "Count",
                        "formatter": 3,
                        "formatOptions": {
                            "showIcon": true
                        }
                    },
                    {
                        "columnMatch": "Trend",
                        "formatter": 9,
                        "formatOptions": {
                            "palette": "grayBlue",
                            "showIcon": true
                        }
                    },
                    {
                        "columnMatch": "DeviceActions",
                        "formatter": 0,
                        "formatOptions": {
                            "showIcon": true
                        }
                    }
                ],
                "sortBy": [
                    {
                        "itemKey": "Message.action",
                        "sortOrder": 1
                    }
                ],
                "labelSettings": []
            },
            "tileSettings": {
                "titleContent": {
                    "columnMatch": "Message.action",
                    "formatter": 1,
                    "formatOptions": {
                        "showIcon": true
                    }
                },
                "leftContent": {
                    "columnMatch": "Count",
                    "formatter": 12,
                    "formatOptions": {
                        "palette": "auto",
                        "showIcon": true
                    },
                    "numberFormat": {
                        "unit": 17,
                        "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                        }
                    }
                },
                "secondaryContent": {
                    "columnMatch": "Trend",
                    "formatter": 9,
                    "formatOptions": {
                        "showIcon": true
                    }
                },
                "showBorder": false
            }
        },
        "customWidth": "25",
        "name": "Top 5 Wildfire activities"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "let data = fluentbit_CL\r\n| where isnotempty(FirewallName_s)\r\n| where ident_s == 'THREAT'\r\n| where threat_content_type =~ 'wildfire'\r\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst in ({Destination_IP}) \r\n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP});\r\ndata\r\n| summarize Count = count() by Message.rule\r\n| join kind = inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by Message.rule)\r\n on Message.rule\r\n| project-away Message.rule1, TimeGenerated\r\n| extend Message.rules = Message.rule\r\n| union (\r\n data \r\n | summarize Count = count() \r\n | extend jkey = 1\r\n | join kind=inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n | extend jkey = 1) on jkey\r\n | extend Message.rule = 'All', Message.rules = '*' \r\n)\r\n| project Message.rule, Count, Trend\r\n| order by Count desc\r\n| take 10",
          "size": 4,
          "exportFieldName": "Message.rule",
          "exportParameterName": "RuleString",
          "exportDefaultValue": "All",
          "exportToExcelOptions": "visible",
          "title": "Top 5 Wildfire verdicts",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "visualization": "tiles",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "Message.action",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "Count",
                "formatter": 3,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "Trend",
                "formatter": 9,
                "formatOptions": {
                  "palette": "grayBlue",
                  "showIcon": true
                }
              },
              {
                "columnMatch": "Message.actions",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "TimeGenerated",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "jkey1",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              }
            ],
            "sortBy": [
              {
                "itemKey": "Message.action",
                "sortOrder": 1
              }
            ],
            "labelSettings": []
          },
          "tileSettings": {
            "titleContent": {
              "columnMatch": "Message.rule",
              "formatter": 1,
              "formatOptions": {
                "showIcon": true
              }
            },
            "leftContent": {
              "columnMatch": "Count",
              "formatter": 12,
              "formatOptions": {
                "palette": "auto",
                "showIcon": true
              },
              "numberFormat": {
                "unit": 17,
                "options": {
                  "maximumSignificantDigits": 3,
                  "maximumFractionDigits": 2
                }
              }
            },
            "secondaryContent": {
              "columnMatch": "Trend",
              "formatter": 9,
              "formatOptions": {
                "showIcon": true
              }
            },
            "showBorder": false
          }
        },
        "customWidth": "25",
        "name": "Top 5 Wildfire verdicts"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where ident_s == 'THREAT'\n| where threat_content_type in ('wildfire', 'wildfire-virus')\n| where '{DeviceAction}' == \"All\" or action=='{DeviceAction}'\n| where '{DeviceString}' == \"All\" or category=='{DeviceString}'\n| project TimeGenerated, LogSeverity=pri_s, DeviceAction=action, ['URL Category'] =category, DestinationPort=dport, DestinationIP=dst, Message, SourcePort=sport, SourceIP=src_ip, DestinationUserID, RequestURL",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Wildfire events",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "filter": true,
            "labelSettings": []
          }
        },
        "name": "Wildfire events"
      },
      {
        "type": 1,
        "content": {
          "json": "---\r\n## General statistics"
        },
        "name": "text - 30"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "fluentbit_CL\n| where isnotempty(FirewallName_s)\n| where ident_s == 'THREAT'\n| where \"{Destination_IP:lable}\"==\"All\" or Message.dst in ({Destination_IP}) \n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\n| where Message.threat_content_type  =~ 'file'\n| where Message.action contains 'deny'\n| summarize ProtocolCount=count()  by Message.proto\n| top 5 by ProtocolCount desc\n",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Top 5 denied files, by application protocol",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "Message.proto",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "ProtocolCount",
                "formatter": 4,
                "formatOptions": {
                  "palette": "coldHot",
                  "showIcon": true
                }
              }
            ],
            "labelSettings": []
          }
        },
        "customWidth": "33",
        "name": "Top 5 denied files by application protocol"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "fluentbit_CL\r\n| where isnotempty(FirewallName_s)\r\n| where ident_s == 'THREAT'\r\n| where \"{Destination_IP:lable}\" == \"All\" or Message.dst in ({Destination_IP})\r\n| where \"{Source_IP:lable}\" == \"All\" or Message.src_ip in ({Source_IP})\r\n| where threat_content_type =~ 'file'\r\n| where Message.action !contains 'deny'\r\n| summarize ProtocolCount=count() by Message.proto\r\n| top 5 by ProtocolCount desc\r\n",
          "size": 0,
          "exportToExcelOptions": "visible",
          "title": "Top 5 allowed files, by application protocol",
          "timeContext": {
            "durationMs": 0
          },
          "timeContextFromParameter": "TimeRange",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "Message.proto",
                "formatter": 0,
                "formatOptions": {
                  "showIcon": true
                }
              },
              {
                "columnMatch": "ProtocolCount",
                "formatter": 4,
                "formatOptions": {
                  "palette": "coldHot",
                  "showIcon": true
                }
              }
            ],
            "labelSettings": []
          }
        },
        "customWidth": "33",
        "name": "Top 5 allowed files by application protocol"
      }
    ],
    "styleSettings": {},
    "fromTemplateId": "sentinel-PaloAltoOverview",
    "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
  }