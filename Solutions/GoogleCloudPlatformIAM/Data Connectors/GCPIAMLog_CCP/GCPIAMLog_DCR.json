[
    {
        "name": "GCPIAMDCR",
        "apiVersion": "2022-06-01-preview",
        "type": "Microsoft.Insights/dataCollectionRules",
        "location": "{{location}}",
        "properties": {
            "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
            "streamDeclarations": {
                "Custom-GCPIAMStream": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "protoPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "operation",
                            "type": "dynamic"
                        },
                        {
                            "name": "receiveTimestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                        {
                            "name": "SourceSystem",
                            "type": "string"
                        },
                        {
                            "name": "TimeGenerated",
                            "type": "datetime"
                        },
                        
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        },
                        
                        {
                            "name": "severity",
                            "type": "string"
                        },
                        {
                            "name": "jsonPayload",
                            "type": "dynamic"
                        }
                    ]
                }
            },
            "destinations": {
                "logAnalytics": [
                    {
                        "workspaceResourceId": "{{workspaceResourceId}}",
                        "name": "clv2ws1"
                    }
                ]
            },
            "dataFlows": [
                {
                    "streams": [
                        "Custom-GCPIAMStream"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql":"source | extend ProtoPayload = parse_json(protoPayload) | extend Resource = parse_json(resource) | extend Operation = parse_json(operation) | extend InsertId = insertId | extend LogName = logName | extend ReceiveTimestamp = receiveTimestamp | extend Timestamp = timestamp | extend Severity = severity | extend StatusCode = tostring(ProtoPayload['status']['code']) | extend StatusMessage = tostring(ProtoPayload['status']['message']) | extend TimeGenerated = receiveTimestamp | extend AuthInfoPrincipalEmail = tostring(ProtoPayload['authenticationInfo']['principalEmail']) | extend AuthInfoPrincipalSubject = tostring(ProtoPayload['authenticationInfo']['principalSubject']) | extend AuthInfoServiceAccountDelegationInfo = tostring(ProtoPayload['authenticationInfo']['serviceAccountDelegationInfo']) | extend MethodName = tostring(ProtoPayload['methodName']) | extend PayloadType = tostring(ProtoPayload['@type']) | extend ServiceName = tostring(ProtoPayload['serviceName']) | extend RequestMetadataCallerIp = tostring(ProtoPayload['requestMetadata']['callerIp']) | extend RequestMetadataCallerSuppliedUserAgent = tostring(ProtoPayload['requestMetadata']['callerSuppliedUserAgent']) | extend RequestMetadataRequestAttributesTime = tostring(ProtoPayload['requestMetadata']['requestAttributes']['time']) | extend MetadataIdentityDelegationChain = tostring(ProtoPayload['metadata']['identityDelegationChain']) | extend AuthorizationInfo = tostring(ProtoPayload['authorizationInfo']) | extend GCPResourceName = tostring(ProtoPayload['resourceName']) | extend ResourceLabelsMethod = tostring(Resource['labels']['method']) | extend ResourceLabelsVersion = tostring(Resource['labels']['version']) | extend ResourceLabelsService = tostring(Resource['labels']['service']) | extend ResourceLabelsLocation = tostring(Resource['labels']['location']) | extend ResourceLabelsTopicId = tostring(Resource['labels']['topic_id']) | extend ResourceLabelsRoleName = tostring(Resource['labels']['role_name']) | extend ResourceLabelsProjectId = tostring(Resource['labels']['project_id']) | extend ResourceLabelsUniqueId = tostring(Resource['labels']['unique_id']) | extend ResourceLabelsEmailId = tostring(Resource['labels']['email_id']) | extend RequestFullResourceName = tostring(ProtoPayload['request']['full_resource_name']) | extend RequestPageSize = tostring(ProtoPayload['request']['page_size']) | extend RequestType = tostring(ProtoPayload['request']['@type']) | extend RequestName = tostring(ProtoPayload['request']['name']) | extend RequestSkipVisibilityCheck = tobool(ProtoPayload['request']['skip_visibility_check']) | extend OperationId = tostring(Operation['id']) | extend OperationProducer = tostring(Operation['producer']) | extend OperationFirst = tobool(Operation['first']) | extend OperationLast = tobool(Operation['last']) | extend RequestPolicyEtag = tostring(ProtoPayload['request']['policy']['etag']) | extend RequestPolicyAuditConfigs = tostring(ProtoPayload['request']['policy']['auditConfigs']) | extend RequestPolicyBindings = tostring(ProtoPayload['request']['policy']['bindings']) | extend RequestResource = tostring(ProtoPayload['request']['resource']) | extend ResponseAuditConfigs = tostring(ProtoPayload['response']['auditConfigs']) | extend ResponseBindings = tostring(ProtoPayload['response']['bindings']) | extend ResponseEtag = tostring(ProtoPayload['response']['etag']) | extend ServiceDataType = tostring(ProtoPayload['serviceData']['@type']) | extend ServiceDataPolicyDeltaBindingDeltas = tostring(ProtoPayload['serviceData']['policyDelta']['bindingDeltas']) | extend ServiceDataPermissionDeltaRemovedPermissions = tostring(ProtoPayload['serviceData']['permissionDelta']['removedPermissions']) | extend ServiceDataPermissionDeltaAddedPermissions = tostring(ProtoPayload['serviceData']['permissionDelta']['addedPermissions']) | extend NumResponseItems = tostring(ProtoPayload['numResponseItems']) | extend RequestParent = tostring(ProtoPayload['request']['parent']) | extend RequestShowDeleted = tobool(ProtoPayload['request']['showDeleted']) | extend RequestRemoveDeletedServiceAccounts = tobool(ProtoPayload['request']['remove_deleted_service_accounts']) | extend RequestIncludeInactiveApiRoles = tobool(ProtoPayload['request']['include_inactive_api_roles']) | extend RequestRoleIncludedPermissions = tostring(ProtoPayload['request']['role']['included_permissions']) | extend AuthenticationInfoPrincipalSubject = tostring(ProtoPayload['authenticationInfo']['principalSubject']) | extend ResponseType = tostring(ProtoPayload['response']['@type']) | extend RequestGrantType = tostring(ProtoPayload['request']['grantType']) | extend RequestUpdateMaskPaths = tostring(ProtoPayload['request']['update_mask']['paths']) | extend RequestAudience = tostring(ProtoPayload['request']['audience']) | extend RequestRoleTitle = tostring(ProtoPayload['request']['role']['title']) | extend RequestRoleDescription = tostring(ProtoPayload['request']['role']['description']) | extend RequestRoleId = tostring(ProtoPayload['request']['role_id']) | extend RequestSubjectTokenType = tostring(ProtoPayload['request']['subjectTokenType']) | extend MetadataMappedPrincipal = tostring(ProtoPayload['metadata']['mapped']['principal']) | extend MetadataType = tostring(ProtoPayload['metadata']['type']) | extend GCPResourceType = tostring(Resource['type']) | extend RequestKeyTypes = tostring(ProtoPayload['request']['key_types']) | extend RequestView = tostring(ProtoPayload['request']['view']) | extend RequestRequestedTokenType = tostring(ProtoPayload['request']['requestedTokenType']) | extend ResponseGroupName = tostring(ProtoPayload['response']['group_name']) | extend ResponseIncludedPermissions = tostring(ProtoPayload['response']['included_permissions']) | extend ResponseTitle = tostring(ProtoPayload['response']['title']) | extend ResponseGroupTitle = tostring(ProtoPayload['response']['group_title']) | extend RequestAccountId = tostring(ProtoPayload['request']['account_id']) | extend RequestServiceAccountDescription = tostring(ProtoPayload['request']['service_account']['description']) | extend RequestServiceAccountDisplayName = tostring(ProtoPayload['request']['service_account']['display_name']) | extend ResponseOauth2ClientId = tostring(ProtoPayload['response']['oauth2_client_id']) | extend ResponseName = tostring(ProtoPayload['response']['name']) | extend ResponseUniqueId = tostring(ProtoPayload['response']['unique_id']) | extend ResponseDescription = tostring(ProtoPayload['response']['description']) | extend ResponseProjectId = tostring(ProtoPayload['response']['project_id']) | extend ResponseDisplayName = tostring(ProtoPayload['response']['display_name']) | extend ResponseEmail = tostring(ProtoPayload['response']['email']) | extend RequestPrivateKeyType = tostring(ProtoPayload['request']['private_key_type']) | extend ResponseValidBeforeTimeSeconds = tostring(ProtoPayload['response']['valid_before_time']['seconds']) | extend ResponseValidAfterTimeSeconds = tostring(ProtoPayload['response']['valid_after_time']['seconds']) | extend ResponseKeyType = tostring(ProtoPayload['response']['key_type']) | extend ResponseKeyOrigin = tostring(ProtoPayload['response']['key_origin']) | extend ResponsePrivateKeyType = tostring(ProtoPayload['response']['private_key_type']) | extend ResponseKeyAlgorithm = tostring(ProtoPayload['response']['key_algorithm']) | extend RequestOptionsRequestedPolicyVersion = tostring(ProtoPayload['request']['options']['requested_policy_version']) | extend RequestPageToken = tostring(ProtoPayload['request']['page_token']) | project TimeGenerated, ReceiveTimestamp, Timestamp, InsertId, LogName, AuthInfoPrincipalEmail, AuthInfoPrincipalSubject, MethodName, ResourceLabelsProjectId, PayloadType, RequestMetadataCallerIp, ServiceName, RequestMetadataCallerSuppliedUserAgent, AuthorizationInfo, GCPResourceName, ResourceLabelsMethod, ResourceLabelsVersion, ResourceLabelsService, ResourceLabelsLocation, RequestFullResourceName, RequestPageSize, RequestSkipVisibilityCheck, AuthInfoServiceAccountDelegationInfo, OperationId, OperationProducer, OperationFirst, OperationLast, ResourceLabelsUniqueId, ResourceLabelsEmailId, MetadataIdentityDelegationChain, RequestType, RequestName, RequestMetadataRequestAttributesTime, RequestPolicyEtag, RequestPolicyAuditConfigs, RequestPolicyBindings, RequestResource, ResponseAuditConfigs, ResponseBindings, ResponseEtag, ServiceDataPolicyDeltaBindingDeltas, NumResponseItems, RequestParent, RequestShowDeleted, RequestRemoveDeletedServiceAccounts, RequestIncludeInactiveApiRoles, AuthenticationInfoPrincipalSubject, ResponseType, ServiceDataType, RequestGrantType, RequestSubjectTokenType, MetadataMappedPrincipal, MetadataType, GCPResourceType, RequestKeyTypes, RequestView, RequestRequestedTokenType, Severity, StatusCode, ServiceDataPermissionDeltaRemovedPermissions, RequestUpdateMaskPaths, ResourceLabelsTopicId, ResourceLabelsRoleName, ServiceDataPermissionDeltaAddedPermissions, RequestRoleTitle, RequestRoleDescription, RequestRoleId, RequestPageToken, ResponseIncludedPermissions, ResponseTitle, ResponseGroupTitle, RequestAccountId, RequestRoleIncludedPermissions, RequestServiceAccountDescription, RequestServiceAccountDisplayName, ResponseOauth2ClientId, ResponseName, ResponseUniqueId, ResponseDescription, ResponseProjectId, ResponseDisplayName, ResponseEmail, ResponseGroupName, RequestPrivateKeyType, ResponseValidBeforeTimeSeconds, ResponseKeyOrigin, ResponsePrivateKeyType, ResponseValidAfterTimeSeconds, ResponseKeyType, ResponseKeyAlgorithm, RequestOptionsRequestedPolicyVersion, StatusMessage",
                    "outputStream": "Microsoft-GCPIAM"
                }
            ]
        }
    }
]
