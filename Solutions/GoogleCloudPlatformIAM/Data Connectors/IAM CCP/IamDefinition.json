{
    "name": "GCPIAMCCPDefinition",
    "apiVersion": "2022-09-01-preview",
    "type": "Microsoft.SecurityInsights/dataConnectorDefinitions",
    "location": "{{location}}",
    "kind": "Customizable",
    "properties": {
        "connectorUiConfig": {
            "id": "GCPIAMCCPDefinition",
            "title": "Google IAM",
            "publisher": "Microsoft", 
            "descriptionMarkdown": "This data connector allows ingesting logs from  [**GCP_IAM**](https://aka.ms/sentinel-GCPIAMDataConnector-parser) into Microsoft Sentinel. The data connector is built on Microsoft Sentinel Codeless Connector Platform. It supports DCR-based ingestion time transformations that parses the received security data in destination tables so that queries don't need to parse it again, thus resulting in better performance.Logs Ingestion API in Azure Monitor - Azure Monitor | Microsoft Learn Send data to a Log Analytics workspace using REST API or client libraries.",
            "graphQueriesTableName": "GCP_IAMV2_CL", 
            "graphQueries": [
                {
                    "metricName": "Total incident logs received",
                    "legend": "GCP_IAM_CL",
                    "baseQuery": "{{graphQueriesTableName}}"
                }
            ],
            "sampleQueries": [
                {
                    "description" : "All GCP IAM logs",
                    "query": "{{graphQueriesTableName}}\n| take 10"
                }
            ],
            "dataTypes": [
                {
                    "name": "{{graphQueriesTableName}}",
                    "lastDataReceivedQuery": "GCP_IAMV2_CL\n  | where TimeGenerated > ago(12h) | where name_s == \"no data test\"         | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                }
            ],
            "connectivityCriteria": [
                {
                    "type": "HasDataConnectors"
                    
                }
            ],
            "availability": {
                "status": 1,
                "isPreview": false
            },
            "permissions": {
                "resourceProvider": [
                    {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                            "read": true,
                            "write": true,
                            "delete": true,
                            "action": false
                        }
                    }
                ]
            },
            "instructionSteps": [
                {
                    "instructions": [
                        {
                            "type": "MarkdownControlEnvBased",
                            "parameters": {
                                "prodScript": "#### 1. Set up your GCP environment \n You must have the following GCP resources defined and configured: topic, subscription for the topic, workload identity pool, workload identity provider and service account with permissions to get and consume from subscription. \n Terraform provides API for the IAM that creates the resources. [Link to Terraform scripts](https://github.com/Azure/Azure-Sentinel/tree/master/DataConnectors/GCP/Terraform/sentinel_resources_creation)\n Connector tutorial: [Link to tutorial](https://learn.microsoft.com/en-us/azure/sentinel/connect-google-cloud-platform?tabs=terraform%2Cauditlogs#gcp-authentication-setup) .",
                                "govScript": "#### 1. Set up your GCP environment \n You must have the following GCP resources defined and configured: topic, subscription for the topic, workload identity pool, workload identity provider and service account with permissions to get and consume from subscription. \n Terraform provides API for the IAM that creates the resources. [Link to Gov Terraform scripts](https://github.com/Azure/Azure-Sentinel/tree/master/DataConnectors/GCP/Terraform/sentinel_resources_creation_gov)\n Connector tutorial: [Link to tutorial](https://learn.microsoft.com/en-us/azure/sentinel/connect-google-cloud-platform?tabs=terraform%2Cauditlogs#gcp-authentication-setup)."
                            }
                        },
                        {
                            "type": "CopyableLabel",
                            "parameters": {
                                "label": "Tenant ID: A unique identifier that is used as an input in the Terraform configuration within a GCP environment.",
                                "fillWith": [
                                    "TenantId"
                                ],
                                "name": "TenantId",
                                "disabled": true
                            }
                        },
                        {
                            "type": "Markdown",
                            "parameters": {
                                "content": "#### 2. To enable IAM logs \n In your GCP account, navigate to the IAM section. From there, you can either create a new user or modify an existing user's role that you want to monitor. Be sure to save your changes..\n\nFor more information: [Link to documentation](https://cloud.google.com/assured-workloads/docs/iam-roles?hl=en)"
                            }
                        },
                        {
                            "type": "Markdown",
                            "parameters": {
                                "content": "#### 3. Connect new collectors \n To enable GCP Iam Logs for Microsoft Sentinel, click the Add new collector button, fill the required information in the context pane and click on Connect."
                            }
                        },
                        {
                            "type": "GCPGrid",
                            "parameters": {}
                        },
                        {
                            "type": "GCPContextPane",
                            "parameters": {}
                        }  
                    ],
                    "title": "Connect GCP IAM to Microsoft Sentinel"
                }
            ]
            
        }
    }
}
