[
    {
        "name": "GCPIAMDCR",
        "apiVersion": "2022-06-01-preview",
        "type": "Microsoft.Insights/dataCollectionRules",
        "location": "{{location}}",
        "properties": {
            "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
            "streamDeclarations": {
                "Custom-GCPIAM": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "protoPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "operation",
                            "type": "dynamic"
                        },
                        {
                            "name": "receiveTimestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                    
                        {
                            "name": "SourceSystem",
                            "type": "string"
                        },
                        {
                            "name": "TimeGenerated",
                            "type": "datetime"
                        },
                        
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        },
                        
                        {
                            "name": "severity",
                            "type": "string"
                        }
                    ]
                }
            },
            "destinations": {
                "logAnalytics": [
                    {
                        "workspaceResourceId": "{{workspaceResourceId}}",
                        "name": "clv2ws1"
                    }
                ]
            },
            "dataFlows": [
                {
                    "streams": [
                        "Custom-GCPIAM"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "name": "RequestName",
                    "transformKql":"source | extend protoPayload = parse_json(protoPayload)
                    | extend resource = parse_json(resource)
                    | extend operation = parse_json(operation)
                    | extend TimeGenerated = receiveTimestamp
                    | extend AuthInfoPrincipalEmail = tostring(protoPayload.authenticationInfo.principalEmail)
                    | extend AuthInfoPrincipalSubject = toguid(protoPayload.authenticationInfo.principalSubject)
                    | extend AuthInfo_serviceAccountDelegationInfo = tostring(protoPayload.authenticationInfo.serviceAccountDelegationInfo)
                    | extend plmethodname = tostring(protoPayload.methodName)
                    | extend pl_type = tostring(protoPayload['@type'])
                    | extend pl_ServiceName = tostring(protoPayload.serviceName)
                    | extend pl_requestMetadata_callerIp = tostring(protoPayload.requestMetadata.callerIp)
                    | extend pl_requestMetadata_callerSuppliedUserAgent = tostring(protoPayload.requestMetadata.callerSuppliedUserAgent)
                    | extend pl_requestMetadata_requestAttributes_time = tostring(protoPayload['requestMetadata']['requestAttributes']['time'])
                    | extend pl_Metadata_identityDelegationChain = tostring(protoPayload.metadata.identityDelegationChain)
                    | extend pl_authorizationInfo = tostring(protoPayload.authorizationInfo)
                    | extend pl_resourceName = tostring(protoPayload.resourceName)
                    | extend resource_labels_method = tostring(resource.labels.method)
                    | extend resource_labels_version = tostring(resource.labels.version)
                    | extend resource_labels_service = tostring(resource.labels.service)
                    | extend resource_labels_location = tostring(resource.labels.location)
                    | extend resource_label_project_id = tostring(resource.labels.project_id)
                    | extend resource_label_unique_id = tostring(resource.labels.unique_id)
                    | extend resource_label_email_id = tostring(resource.labels.email_id)
                    | extend pl_request_full_resource_name = tostring(protoPayload.request.full_resource_name)
                    | extend pl_request_pagesize = todouble(protoPayload.request.page_size)
                    | extend pl_request_type = tostring(protoPayload.request['@type'])
                    | extend pl_request_name = tostring(protoPayload.request.name)
                    | extend pl_request_skip_visibility_check = tobool(protoPayload.request.skip_visibility_check)
                    | extend operation_id = tostring(operation.id)
                    | extend operation_producer = tostring(operation.producer)
                    | extend operation_first = tobool(operation['first'])
                    | extend operation_last = tobool(operation['last'])
                    | extend protoPayload_request_policy_etag = tostring(protoPayload.request.policy.etag)
                    | extend pl_request_policy_auditConfigs = tostring(protoPayload.request.policy.auditConfigs)
                    | extend pl_request_policy_bindings = tostring(protoPayload.request.policy.bindings)
                    | extend pl_request_resource = tostring(protoPayload.request.resource)
                    | extend pl_response_auditConfigs = tostring(protoPayload.response.auditConfigs)
                    | extend pl_response_bindings = tostring(protoPayload.response.bindings)
                    | extend pl_response_etag = tostring(protoPayload.response.etag)
                    | extend pl_serviceData_type = tostring(['protoPayload']['serviceData']['@type'])
                    | extend pl_serviceData_policyDelta_bindingDeltas = tostring(protoPayload.serviceData.policyDelta.bindingDeltas)
                    | extend pl_numResponseItems = tostring(protoPayload.numResponseItems)
                    | extend pl_request_parent = tostring(protoPayload.request.parent)
                    | extend pl_request_showDeleted = tobool(protoPayload.request.showDeleted)
                    | extend pl_request_remove_deleted_service_accounts = tobool(protoPayload.request.remove_deleted_service_accounts)
                    | extend pl_request_include_inactive_api_roles = tobool(protoPayload.request.include_inactive_api_roles)
                    | extend pl_authenticationInfo_principalSubject = tostring(protoPayload.authenticationInfo.principalSubject)
                    | extend pl_response_type = tostring(['protoPayload']['response']['@type'])
                    | extend pl_request_grantType = tostring(protoPayload['request']['grantType'])
                    | extend pl_request_audience = tostring(protoPayload['request']['audience'])
                    | extend pl_request_subjectTokenType = tostring(protoPayload['request']['subjectTokenType'])
                    | extend pl_metadata_mapped_principal = tostring(protoPayload['metadata']['mapped']['principal'])
                    | extend plMetadataType = tostring(protoPayload['metadata']['type']) 
                    | extend resource_type = tostring(resource['type'])
                    | extend pl_request_key_types = tostring(['protoPayload']['request']['key_types'])
                    | extend pl_request_view = todouble(protoPayload.request.view)
                    | extend pl_request_requestedTokenType = tostring(protoPayload.request.requestedTokenType)
                    | project TimeGenerated, receiveTimestamp, insertId,logName, AuthInfoPrincipalEmail, AuthInfoPrincipalSubject, plmethodname, resource_label_project_id, pl_type, pl_requestMetadata_callerIp, pl_ServiceName,pl_requestMetadata_callerSuppliedUserAgent, pl_authorizationInfo, pl_resourceName,resource_labels_method, resource_labels_version, resource_labels_service, resource_labels_location, pl_request_full_resource_name, pl_request_pagesize, pl_request_skip_visibility_check,AuthInfo_serviceAccountDelegationInfo, operation_id, operation_producer, operation_first, operation_last, resource_label_unique_id, resource_label_email_id, pl_Metadata_identityDelegationChain,pl_request_type, pl_request_name, pl_requestMetadata_requestAttributes_time,protoPayload_request_policy_etag,pl_request_policy_auditConfigs,pl_request_policy_bindings,pl_request_resource,pl_response_auditConfigs,pl_response_bindings,pl_response_etag,pl_serviceData_policyDelta_bindingDeltas,pl_numResponseItems,pl_request_parent,pl_request_showDeleted,pl_request_remove_deleted_service_accounts,pl_request_include_inactive_api_roles,pl_authenticationInfo_principalSubject,pl_response_type,pl_serviceData_type,pl_request_grantType,pl_request_subjectTokenType,pl_metadata_mapped_principal,plMetadataType,resource_type,pl_request_key_types,pl_request_view,pl_request_requestedTokenType,severity",
                    "outputStream": "Custom-GCP_IAMV2_CL"
                }
            ]
        }
    }
]
