{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for Google Cloud Platform Security Command Center"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
	"subscription": {
		"defaultValue": "[last(split(subscription().id, '/'))]",
		"type": "string",
		"metadata": {
			"description": "subscription id where Microsoft Sentinel is setup"
		}
	},
	"resourceGroupName": {
		"defaultValue": "[resourceGroup().name]",
		"type": "string",
		"metadata": {
			"description": "resource group name where Microsoft Sentinel is setup"
		}
	}
  },
  "variables": {
	"workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "_solutionName": "Google Cloud Platform Security Command Center",
    "_solutionVersion": "3.0.7",
    "solutionId": "azuresentinel.azure-sentinel-solution-gcpscclogs-api",
    "_solutionId": "[variables('solutionId')]",
    "uiConfigId1": "GoogleSCCDefinition",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorVersionConnectorDefinition": "3.0.0",
	"dataConnectorVersionConnections": "3.0.0",
	"_dataConnectorContentIdConnectorDefinition": "[variables('uiConfigId1')]",
	"dataConnectorTemplateNameConnectorDefinition": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition')))]",
	"_dataConnectorContentIdConnections": "GoogleSCCTemplateConnections",
	"dataConnectorTemplateNameConnections": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections')))]",
	"dataType": "GoogleCloudSCC",
	"streamName": "SENTINEL_GOOGLE_CLOUD_SCC",
	"dataCollectionRuleId": "GoogleCloudSCC",
	"FindingId": "FindingName",
    "_FindingId": "[variables('FindingId')]",
	"ProjectId": "ProjectId",
    "_ProjectId": "[variables('ProjectId')]",
	
    "analyticRuleObject1": {
      "analyticRuleVersion1": "1.0.0",
      "_analyticRulecontentId1": "d8e30113-373a-4f49-a0ad-1a5d8b95b729",
      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'd8e30113-373a-4f49-a0ad-1a5d8b95b729')]",
      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('d8e30113-373a-4f49-a0ad-1a5d8b95b729')))]",
      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','d8e30113-373a-4f49-a0ad-1a5d8b95b729','-', '1.0.0')))]"
    },
    "analyticRuleObject2": {
      "analyticRuleVersion2": "1.0.0",
      "_analyticRulecontentId2": "395f3ced-3923-4b83-b05d-8d077fd48c1e",
      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '395f3ced-3923-4b83-b05d-8d077fd48c1e')]",
      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('395f3ced-3923-4b83-b05d-8d077fd48c1e')))]",
      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','395f3ced-3923-4b83-b05d-8d077fd48c1e','-', '1.0.0')))]"
    },
    "analyticRuleObject3": {
      "analyticRuleVersion3": "1.0.0",
      "_analyticRulecontentId3": "a9c7a4be-b7e7-4045-8028-0d1ffaa049af",
      "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'a9c7a4be-b7e7-4045-8028-0d1ffaa049af')]",
      "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('a9c7a4be-b7e7-4045-8028-0d1ffaa049af')))]",
      "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','a9c7a4be-b7e7-4045-8028-0d1ffaa049af','-', '1.0.0')))]"
    },
    "analyticRuleObject4": {
      "analyticRuleVersion4": "1.0.0",
      "_analyticRulecontentId4": "f4f92ca4-6ebe-4f2a-90e5-b0d04b709651",
      "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'f4f92ca4-6ebe-4f2a-90e5-b0d04b709651')]",
      "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('f4f92ca4-6ebe-4f2a-90e5-b0d04b709651')))]",
      "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','f4f92ca4-6ebe-4f2a-90e5-b0d04b709651','-', '1.0.0')))]"
    },
    "analyticRuleObject5": {
      "analyticRuleVersion5": "1.0.0",
      "_analyticRulecontentId5": "d1fe8d30-4852-463a-b6ee-3b459788b75d",
      "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'd1fe8d30-4852-463a-b6ee-3b459788b75d')]",
      "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('d1fe8d30-4852-463a-b6ee-3b459788b75d')))]",
      "_analyticRulecontentProductId5": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','d1fe8d30-4852-463a-b6ee-3b459788b75d','-', '1.0.0')))]"
    },
    "huntingQueryObject1": {
      "huntingQueryVersion1": "1.0.0",
      "_huntingQuerycontentId1": "f26cff6f-1a57-4462-a956-162639d14c3f",
      "huntingQueryTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('f26cff6f-1a57-4462-a956-162639d14c3f')))]"
    },
    "huntingQueryObject2": {
      "huntingQueryVersion2": "1.0.0",
      "_huntingQuerycontentId2": "d87bb737-2f4e-4261-b863-23c8a8999693",
      "huntingQueryTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('d87bb737-2f4e-4261-b863-23c8a8999693')))]"
    },
    "huntingQueryObject3": {
      "huntingQueryVersion3": "1.0.0",
      "_huntingQuerycontentId3": "0cbdd537-b31b-41b7-a3f2-8a421ea89a43",
      "huntingQueryTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0cbdd537-b31b-41b7-a3f2-8a421ea89a43')))]"
    },
    "huntingQueryObject4": {
      "huntingQueryVersion4": "1.0.0",
      "_huntingQuerycontentId4": "86b3c2e5-9f44-4f7a-9d2d-2f1a3b4c5d6e",
      "huntingQueryTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('86b3c2e5-9f44-4f7a-9d2d-2f1a3b4c5d6e')))]"
    },
    "huntingQueryObject5": {
      "huntingQueryVersion5": "1.0.0",
      "_huntingQuerycontentId5": "47375801-ba85-4296-a548-7d748e3c7601",
      "huntingQueryTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('47375801-ba85-4296-a548-7d748e3c7601')))]"
    },
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
	{
		"type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
		"apiVersion": "2023-04-01-preview",
		"name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition'), variables('dataConnectorVersionConnectorDefinition'))]",
		"location": "[parameters('workspace-location')]",
		"dependsOn": [
			"[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
		],
		"properties": {
			"contentId": "[variables('_dataConnectorContentIdConnectorDefinition')]",
			"displayName": "[variables('_solutionName')]",
			"contentKind": "DataConnector",
			"contentProductId": "[concat(substring(variables('_solutionId'), 0, 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('dataConnectorTemplateNameConnectorDefinition'),'-', variables('dataConnectorVersionConnectorDefinition'))))]",
			"id": "[concat(substring(variables('_solutionId'), 0, 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('dataConnectorTemplateNameConnectorDefinition'),'-', variables('dataConnectorVersionConnectorDefinition'))))]",
			"mainTemplate": {
				"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
				"contentVersion": "[variables('dataConnectorVersionConnectorDefinition')]",
				"parameters": {

				},
				"variables": {

				},
				"resources": [
					{
						"name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition'))]",
						"apiVersion": "2022-09-01-preview",
						"type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
						"location": "[parameters('workspace-location')]",
						"kind": "Customizable",
						"properties": {
							"connectorUiConfig": {
								"id": "[variables('_uiConfigId1')]",
								"title": "Google Security Command Center",
								"publisher": "Microsoft",
								"descriptionMarkdown": "The Google Cloud Platform (GCP) Security Command Center is a comprehensive security and risk management platform for Google Cloud, ingested from Sentinel's connector. It offers features such as asset inventory and discovery, vulnerability and threat detection, and risk mitigation and remediation to help you gain insight into your organization's security and data attack surface. This integration enables you to perform tasks related to findings and assets more effectively.",
								"graphQueriesTableName": "GoogleCloudSCC",
								"graphQueries": [
									{
										"metricName": "Total events received",
										"legend": "Google Security Command Center",
										"baseQuery": "{{graphQueriesTableName}}"
									}
								],
								"sampleQueries": [
									{
										"description": "Get Sample of Google SCC",
										"query": "{{graphQueriesTableName}}\n | take 10"
									}
								],
								"dataTypes": [
									{
										"name": "{{graphQueriesTableName}}",
										"lastDataReceivedQuery": "{{graphQueriesTableName}}\n            | where TimeGenerated > ago(12h)         | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
									}
								],
								"connectivityCriteria": [
									{
										"type": "HasDataConnectors",
										"value": null
									}
								],
								"availability": {
									"status": 1,
									"isPreview": false
								},
								"permissions": {
									"resourceProvider": [
										{
											"provider": "Microsoft.OperationalInsights/workspaces",
											"permissionsDisplayText": "Read and Write permissions are required.",
											"providerDisplayName": "Workspace",
											"scope": "Workspace",
											"requiredPermissions": {
												"read": true,
												"write": true,
												"delete": true,
												"action": false
											}
										},
										{
											"provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
											"permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
											"providerDisplayName": "Keys",
											"scope": "Workspace",
											"requiredPermissions": {
												"read": false,
												"write": false,
												"delete": false,
												"action": true
											}
										}
									]
								},
								"instructionSteps": [
									{
										"instructions": [
											{
												"type": "Markdown",
												"parameters": {
													"content": "#### 1. Set up your GCP environment \n You must have the following GCP resources defined and configured: topic, subscription for the topic, workload identity pool, workload identity provider and service account with permissions to get and consume from subscription. \n Terraform provides API for the IAM that creates the resources. [Link to Terraform scripts](https://github.com/Azure/Azure-Sentinel/tree/master/DataConnectors/GCP/Terraform/sentinel_resources_creation)."
												}
											},
											{
												"type": "CopyableLabel",
												"parameters": {
													"label": "Tenant ID: A unique identifier that is used as an input in the Terraform configuration within a GCP environment.",
													"fillWith": [
														"TenantId"
													],
													"name": "PoolId",
													"disabled": true
												}
											},
											{
												"type": "Markdown",
												"parameters": {
													"content": "#### 2. Connect new collectors \n To enable GCP SCC for Microsoft Sentinel, click the Add new collector button, fill the required information in the context pane and click on Connect."
												}
											},
											{
												"type": "GCPGrid",
												"parameters": {}
											},
											{
												"type": "GCPContextPane",
												"parameters": {}
											}
										]
									}
								],
								"isConnectivityCriteriasMatchSome": false
							}
						}
					},
					{
						"name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition')))]",
						"apiVersion": "2022-01-01-preview",
						"type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
						"properties": {
							"parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition'))]",
							"contentId": "[variables('_dataConnectorContentIdConnectorDefinition')]",
							"kind": "DataConnector",
							"version": "[variables('dataConnectorVersionConnectorDefinition')]",
							"source": {
								"sourceId": "[variables('_solutionId')]",
								"name": "[variables('_solutionName')]",
								"kind": "Solution"
							},
							"author": {
								"name": "Microsoft"
							},
							"support": {
								"name": "Microsoft Corporation",
								"email": "support@microsoft.com",
								"tier": "Microsoft",
								"link": "https://support.microsoft.com"
							},
							"dependencies": {
								"criteria": [
									{
										"version": "[variables('dataConnectorVersionConnections')]",
										"contentId": "[variables('_dataConnectorContentIdConnections')]",
										"kind": "ResourcesDataConnector"
									}
								]
							}
						}
					},
					{
						"name": "[variables('dataCollectionRuleId')]",
						"apiVersion": "2021-09-01-preview",
						"type": "Microsoft.Insights/dataCollectionRules",
						"location": "[parameters('workspace-location')]",
						"kind": null,
						"properties": {
							"destinations": {
								"logAnalytics": [
									{
										"workspaceResourceId": "[variables('workspaceResourceId')]",
										"name": "clv2ws1"
									}
								]
							},
							"dataFlows": [
								{
									"streams": [
										"Microsoft-GoogleCloudSCC"
									],
									"destinations": [
										"clv2ws1"
									]
								}
							],
							"dataCollectionEndpointId": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]"
						}
					}
				]
			},
			"packageKind": "Solution",
			"packageVersion": "[variables('_solutionVersion')]",
			"packageName": "[variables('_solutionName')]",
			"contentProductId": "[concat(substring(variables('_solutionId'), 0, 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition'),'-', variables('dataConnectorVersionConnectorDefinition'))))]",
			"packageId": "[variables('_solutionId')]",
			"contentSchemaVersion": "3.0.0",
			"version": "[variables('dataConnectorVersionConnectorDefinition')]"
		}
	},
	{
		"name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition'))]",
		"apiVersion": "2022-09-01-preview",
		"type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
		"location": "[parameters('workspace-location')]",
		"kind": "Customizable",
		"properties": {
			"connectorUiConfig": {
				"id": "[variables('_uiConfigId1')]",
				"title": "Google Security Command Center",
				"publisher": "Microsoft",
				"descriptionMarkdown": "The Google Cloud Platform (GCP) Security Command Center is a comprehensive security and risk management platform for Google Cloud, ingested from Sentinel's connector. It offers features such as asset inventory and discovery, vulnerability and threat detection, and risk mitigation and remediation to help you gain insight into your organization's security and data attack surface. This integration enables you to perform tasks related to findings and assets more effectively.",
				"graphQueriesTableName": "GoogleCloudSCC",
				"graphQueries": [
					{
						"metricName": "Total events received",
						"legend": "Google Security Command Center",
						"baseQuery": "{{graphQueriesTableName}}"
					}
				],
				"sampleQueries": [
					{
						"description": "Get Sample of Google SCC",
						"query": "{{graphQueriesTableName}}\n | take 10"
					}
				],
				"dataTypes": [
					{
						"name": "{{graphQueriesTableName}}",
						"lastDataReceivedQuery": "{{graphQueriesTableName}}\n            | where TimeGenerated > ago(12h)  | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
					}
				],
				"connectivityCriteria": [
					{
						"type": "HasDataConnectors",
						"value": null
					}
				],
				"availability": {
					"status": 1,
					"isPreview": false
				},
				"permissions": {
					"resourceProvider": [
						{
							"provider": "Microsoft.OperationalInsights/workspaces",
							"permissionsDisplayText": "Read and Write permissions are required.",
							"providerDisplayName": "Workspace",
							"scope": "Workspace",
							"requiredPermissions": {
								"read": true,
								"write": true,
								"delete": true,
								"action": false
							}
						},
						{
							"provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
							"permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
							"providerDisplayName": "Keys",
							"scope": "Workspace",
							"requiredPermissions": {
								"read": false,
								"write": false,
								"delete": false,
								"action": true
							}
						}
					]
				},
				"instructionSteps": [
					{
						"instructions": [
							{
								"type": "Markdown",
								"parameters": {
									"content": "#### 1. Set up your GCP environment \n You must have the following GCP resources defined and configured: topic, subscription for the topic, workload identity pool, workload identity provider and service account with permissions to get and consume from subscription. \n Terraform provides API for the IAM that creates the resources. [Link to Terraform scripts](https://github.com/Azure/Azure-Sentinel/tree/master/DataConnectors/GCP/Terraform/sentinel_resources_creation)."
								}
							},
							{
								"type": "CopyableLabel",
								"parameters": {
									"label": "Tenant ID: A unique identifier that is used as an input in the Terraform configuration within a GCP environment.",
									"fillWith": [
										"TenantId"
									],
									"name": "PoolId",
									"disabled": true
								}
							},
							{
								"type": "Markdown",
								"parameters": {
									"content": "#### 2. Connect new collectors \n To enable GCP SCC for Microsoft Sentinel, click the Add new collector button, fill the required information in the context pane and click on Connect."
								}
							},
							{
								"type": "GCPGrid",
								"parameters": {}
							},
							{
								"type": "GCPContextPane",
								"parameters": {}
							}
						]
					}
				],
				"isConnectivityCriteriasMatchSome": false
			}
		}
	},
	{
		"name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition')))]",
		"apiVersion": "2022-01-01-preview",
		"type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
		"properties": {
			"parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition'))]",
			"contentId": "[variables('_dataConnectorContentIdConnectorDefinition')]",
			"kind": "DataConnector",
			"version": "[variables('dataConnectorVersionConnectorDefinition')]",
			"source": {
				"sourceId": "[variables('_solutionId')]",
				"name": "[variables('_solutionName')]",
				"kind": "Solution"
			},
			"author": {
				"name": "Microsoft"
			},
			"support": {
				"name": "Microsoft Corporation",
				"email": "support@microsoft.com",
				"tier": "Microsoft",
				"link": "https://support.microsoft.com"
			},
			"dependencies": {
				"criteria": [
					{
						"version": "[variables('dataConnectorVersionConnections')]",
						"contentId": "[variables('_dataConnectorContentIdConnections')]",
						"kind": "ResourcesDataConnector"
					}
				]
			}
		}
	},
	{
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections'), variables('dataConnectorVersionConnections'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnections')]",
                "displayName": "[variables('_solutionName')]",
                "contentKind": "ResourcesDataConnector",
                "id": "[concat(substring(variables('_solutionId'), 0, 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections'),'-', variables('dataConnectorVersionConnections'))))]",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('dataConnectorVersionConnections')]",
                    "parameters": {
                        "GCPProjectId": {
                            "type": "securestring",
                            "minLength": 4
                        },
                        "GCPProjectNumber": {
                            "type": "securestring",
                            "minLength": 1
                        },
                        "GCPWorkloadIdentityProviderId": {
                            "type": "securestring"
                        },
                        "GCPServiceAccountEmail": {
                            "type": "securestring",
                            "minLength": 1
                        },
                        "GCPSubscriptionName": {
                            "type": "securestring",
                            "minLength": 3
                        },
                        "connectorDefinitionName": {
                            "defaultValue": "connectorDefinitionName",
                            "type": "securestring",
                            "minLength": 1,
                            "metadata": {
                                "description": "connectorDefinitionName"
                            }
                        },
                        "workspace": {
                            "defaultValue": "[parameters('workspace')]",
                            "type": "securestring"
                        },
                        "dcrConfig": {
                            "type": "object",
                            "defaultValue": {
                                "dataCollectionEndpoint": "data collection Endpoint",
                                "dataCollectionRuleImmutableId": "data collection rule immutableId"
                            }
                        },
                        "guidValue": {
                            "type": "securestring",
                            "defaultValue": "[[newGuid()]"
                        }
                    },
                    "variables": {
                        "_dataConnectorContentIdConnections": "[variables('_dataConnectorContentIdConnections')]",
                        "connectorName": "[[concat('GoogleSCC', parameters('guidValue'))]",
                        "workspace_variable": "[parameters('workspace')]"
                    },
                    "resources": [
                        {
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections')))]",
                            "apiVersion": "2022-01-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections'))]",
                                "contentId": "[variables('_dataConnectorContentIdConnections')]",
                                "kind": "ResourcesDataConnector",
                                "version": "[variables('dataConnectorVersionConnections')]",
                                "source": {
                                    "sourceId": "[variables('_solutionId')]",
                                    "name": "[variables('_solutionName')]",
                                    "kind": "Solution"
                                },
                                "author": {
                                    "name": "Microsoft"
                                },
                                "support": {
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "tier": "Microsoft",
                                    "link": "https://support.microsoft.com"
                                }
                            }
                        },
                        {
                            "name": "[[concat(variables('workspace_variable'),'/Microsoft.SecurityInsights/',variables('connectorName'))]",
                            "apiVersion": "2022-12-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
                            "location": "[parameters('workspace-location')]",
                            "kind": "GCP",
                            "properties": {
                                "connectorDefinitionName": "[[parameters('connectorDefinitionName')]",
                                "dcrConfig": {
                                    "streamName": "[variables('streamName')]",
                                    "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                                    "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                                },
                                "dataType": "[variables('dataType')]",
                                "auth": {
                                    "serviceAccountEmail": "[[parameters('GCPServiceAccountEmail')]",
                                    "projectNumber": "[[parameters('GCPProjectNumber')]",
                                    "workloadIdentityProviderId": "[[parameters('GCPWorkloadIdentityProviderId')]"
                                },
                                "request": {
                                    "projectId": "[[parameters('GCPProjectId')]",
                                    "subscriptionNames": [
                                        "[[parameters('GCPSubscriptionName')]"
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(substring(variables('_solutionId'), 0, 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections'),'-', variables('dataConnectorVersionConnections'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('dataConnectorVersionConnections')]"
            }
        },
	{
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "GCPAPIKeyApisUnrestricted_AnalyticalRules Analytics Rule with template version 3.0.7",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects Google Cloud projects that have API keys with unrestricted API access using Security Command Center API_KEY_APIS_UNRESTRICTED findings.\nThese findings indicate API keys that are not restricted to specific APIs and may allow broader access than intended.",
                "displayName": "GCP Security Command Center - Detect Open/Unrestricted API Keys",
                "enabled": false,
                "query": "GoogleCloudSCC\n | where tostring(Findings.state) == \"ACTIVE\"\n | extend FindingCategory = tostring(Findings.category)\n | where FindingCategory == \"API_KEY_APIS_UNRESTRICTED\"\n | extend FindingsJson = parse_json(Findings), FindingsResourceJson = parse_json(FindingsResource)\n | extend ResourceName = tostring(FindingsJson.resourceName)\n | extend ProjectId = extract(@\"projects/([^/]+)\", 1, ResourceName)\n | extend ProjectName = tostring(FindingsResourceJson.displayName)\n | extend Severity = tostring(FindingsJson.severity),\n          FindingName = tostring(FindingsJson.name),\n          ExternalUri = tostring(FindingsJson.externalUri),\n          Description = tostring(FindingsJson.description)\n // produce one row per project that has unrestricted API key findings\n | summarize TimeGenerated = max(TimeGenerated),\n             FindingsCount = count(),\n             ExternalUri = any(ExternalUri),\n             Description = any(Description)\n   by ProjectId, ProjectName, Severity, ResourceName\n | project TimeGenerated, ProjectId, ProjectName, ResourceName, Severity, ExternalUri, Description\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "GoogleSCCDefinition",
                    "dataTypes": [
                      "GoogleCloudSCC"
                    ]
                  }
                ],
                "tactics": [
                  "InitialAccess",
                  "CredentialAccess"
                ],
                "techniques": [
                  "T1190",
                  "T1552"
                ],
                "entityMappings": [
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "columnName": "ProjectName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "ProjectId",
                        "identifier": "AppId"
                      }
                    ]
                  }
                ],
                "customDetails": {
                  "Description": "Description",
                  "ExternalUri": "ExternalUri",
                  "ResourceName": "ResourceName"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "GCP project {{ProjectName}} has unrestricted API key(s)",
                  "alertDescriptionFormat": "Project {{ProjectName}} ({{ProjectId}}) has {{ResourceName}} with unrestricted API keys (API_KEY_APIS_UNRESTRICTED). Review API key restrictions, rotate or remove keys as appropriate, and apply API restrictions to keys."
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
              "properties": {
                "description": "Google Cloud Platform Security Command Center Analytics Rule 1",
                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "Google Cloud Platform Security Command Center",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
        "contentKind": "AnalyticsRule",
        "displayName": "GCP Security Command Center - Detect Open/Unrestricted API Keys",
        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "GCPAPIKeyExists_AnalyticalRules Analytics Rule with template version 3.0.7",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects Google Cloud projects that have API Keys present using Security Command Center API_KEY_EXISTS findings.\nProjects with API Keys may expose credentials that enable unauthorized access if keys are leaked.",
                "displayName": "GCP Security Command Center - Detect projects with API Keys present",
                "enabled": false,
                "query": "GoogleCloudSCC\n | where tostring(Findings.state) == \"ACTIVE\"\n | extend FindingCategory = tostring(Findings.category)\n | where FindingCategory == \"API_KEY_EXISTS\"\n | extend FindingsJson = parse_json(Findings), FindingsResourceJson = parse_json(FindingsResource)\n | extend ResourceName = tostring(FindingsJson.resourceName)\n | extend ProjectId = extract(@\"projects/([^/]+)\", 1, ResourceName)\n | extend ProjectName = tostring(FindingsResourceJson.displayName)\n | extend Severity = tostring(FindingsJson.severity),\n          FindingName = tostring(FindingsJson.name),\n          ExternalUri = tostring(FindingsJson.externalUri),\n          Description = tostring(FindingsJson.description)\n // Produce one row per project with an API key finding\n | summarize TimeGenerated = max(TimeGenerated),\n             FindingsCount = count(),\n             ExternalUri = any(ExternalUri),\n             Description = any(Description)\n   by ProjectId, ProjectName, Severity, ResourceName\n | project TimeGenerated, ProjectId, ProjectName, ResourceName, FindingsCount, Severity, ExternalUri, Description\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "GoogleSCCDefinition",
                    "dataTypes": [
                      "GoogleCloudSCC"
                    ]
                  }
                ],
                "tactics": [
                  "CredentialAccess"
                ],
                "techniques": [
                  "T1552"
                ],
                "entityMappings": [
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "columnName": "ProjectName",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "ProjectId",
                        "identifier": "AppId"
                      }
                    ]
                  }
                ],
                "customDetails": {
                  "ProjectId": "[variables('_ProjectId')]",
                  "SampleExternalUri": "ExternalUri",
                  "SampleDescription": "Description",
                  "FindingsCount": "FindingsCount",
                  "ProjectName": "ProjectName"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "GCP project {{ProjectName}} has API key(s) present",
                  "alertDescriptionFormat": "Project {{ProjectName}} ({{ProjectId}}) has {{FindingsCount}} API key finding(s). Review API keys and consider rotating or removing keys and using IAM-based authentication."
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
              "properties": {
                "description": "Google Cloud Platform Security Command Center Analytics Rule 2",
                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "Google Cloud Platform Security Command Center",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
        "contentKind": "AnalyticsRule",
        "displayName": "GCP Security Command Center - Detect projects with API Keys present",
        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject3').analyticRuleTemplateSpecName3]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "GCPDNSSECDisabled_AnalyticalRules Analytics Rule with template version 3.0.7",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject3').analyticRuleVersion3]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects Google Cloud DNS zones where DNSSEC is disabled using Security Command Center findings (DNSSEC_DISABLED).\nDisabling DNSSEC increases risk of DNS hijacking and man-in-the-middle attacks. This analytic rule alerts on findings where DNSSEC is reported as disabled for a managed zone.",
                "displayName": "GCP Security Command Center - Detect DNSSEC disabled for DNS zones",
                "enabled": false,
                "query": "GoogleCloudSCC\n| where tostring(Findings.state) == \"ACTIVE\"\n| extend FindingsJson = parse_json(Findings)\n| extend FindingCategory = tostring(FindingsJson.category)\n| where FindingCategory == \"DNSSEC_DISABLED\"\n| extend ResourceName = tostring(FindingsJson.resourceName)\n| extend\n  ResourceType = tostring(FindingsResource.type),\n  ExternalUri = tostring(FindingsJson.externalUri),\n  SourceProps = parse_json(tostring(FindingsJson.sourceProperties)),\n  GcpResource = parse_json(tostring(FindingsJson.resource))\n// Extract project and managed zone from resourceName like //dns.googleapis.com/projects/PROJECT/managedZones/ZONE\n| extend ProjectName = extract(@\"projects/([^/]+)\", 1, ResourceName)\n| extend ManagedZone = extract(@\"managedZones/([^/]+)\", 1, ResourceName)\n| extend Severity = tostring(FindingsJson.severity)\n| summarize\n  TimeGenerated = max(TimeGenerated)\n  by ProjectName, ManagedZone, ResourceType, ResourceName, Severity, ExternalUri\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "GoogleSCCDefinition",
                    "dataTypes": [
                      "GoogleCloudSCC"
                    ]
                  }
                ],
                "tactics": [
                  "Collection",
                  "CommandAndControl",
                  "DefenseEvasion"
                ],
                "subTechniques": [
                  "T1071.004",
                  "T1562.001"
                ],
                "techniques": [
                  "T1557",
                  "T1071",
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "columnName": "ResourceName",
                        "identifier": "Name"
                      }
                    ]
                  }
                ],
                "customDetails": {
                  "ExternalUri": "ExternalUri",
                  "ManagedZone": "ManagedZone",
                  "ProjectName": "ProjectName"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "GCP DNS zone {{ManagedZone}} has DNSSEC disabled",
                  "alertDescriptionFormat": "DNSSEC is disabled for managed zone {{ManagedZone}} in project {{ProjectName}}. Review the zone configuration and enable DNSSEC where appropriate."
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject3').analyticRuleId3,'/'))))]",
              "properties": {
                "description": "Google Cloud Platform Security Command Center Analytics Rule 3",
                "parentId": "[variables('analyticRuleObject3').analyticRuleId3]",
                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                "source": {
                  "kind": "Solution",
                  "name": "Google Cloud Platform Security Command Center",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
        "contentKind": "AnalyticsRule",
        "displayName": "GCP Security Command Center - Detect DNSSEC disabled for DNS zones",
        "contentProductId": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "id": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject4').analyticRuleTemplateSpecName4]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "GCPFirewallHighRiskOpenPorts_AnalyticalRules Analytics Rule with template version 3.0.7",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject4').analyticRuleVersion4]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query detects GCP Firewall rules that allow unrestricted (0.0.0.0/0) ingress to high-risk ports using Google Cloud Security Command Center OPEN_FIREWALL findings.\nPublicly exposed management, database, and service ports (e.g., RDP 3389, SSH 22, SQL 1433/3306) significantly increase the risk of brute-force attacks, exploitation, and lateral movement.",
                "displayName": "GCP Security Command Center - Detect Firewall rules allowing unrestricted high-risk ports",
                "enabled": false,
                "query": "let HighRiskPorts = dynamic([3389,20,23,110,143,3306,8080,1433,9200,9300,25,445,135,21,1434,4333,5432,5500,5601,22,3000,5000,8088,8888]);\nGoogleCloudSCC\n| where tostring(Findings.state) == \"ACTIVE\"\n| extend FindingCategory = tostring(Findings.category)\n| where FindingCategory == \"OPEN_FIREWALL\"\n| extend FindingsJson = parse_json(Findings)\n| extend SourcePropertiesJson = parse_json(tostring(FindingsJson.sourceProperties))\n| extend IpRulesJson = parse_json(tostring(FindingsJson.ipRules))\n| where tostring(FindingsJson.state) == \"ACTIVE\"\n| where tostring(SourcePropertiesJson.ExternalSourceRanges) contains \"0.0.0.0/0\"\n| extend AllowedIpRules = parse_json(tostring(IpRulesJson.allowed.ipRules))\n| mv-expand IpRule = AllowedIpRules\n| extend PortRanges = parse_json(tostring(IpRule.portRanges))\n| mv-expand PortRange = PortRanges\n| extend MinPort = toint(PortRange.min), MaxPort = toint(PortRange.max)\n| where MinPort in (HighRiskPorts) or MaxPort in (HighRiskPorts)\n| extend \n    ResourceName = tostring(FindingsJson.resourceName),\n    FindingName = tostring(FindingsJson.name),\n    Protocol = tostring(IpRule.protocol),\n    Severity = tostring(FindingsJson.severity),\n    Description = tostring(FindingsJson.description),\n    ExternalUri = tostring(FindingsJson.externalUri),\n    AttackExposureScore = todouble(FindingsJson.attackExposure.score),\n    ProjectName = extract(@\"projects/([^/]+)\", 1, tostring(FindingsJson.resourceName)),\n    FirewallName = extract(@\"firewalls/([^/]+)\", 1, tostring(FindingsJson.resourceName))\n| extend PortInfo = case(\n    MinPort == MaxPort, tostring(MinPort),\n    strcat(tostring(MinPort), \"-\", tostring(MaxPort))\n)\n| summarize \n    TimeGenerated = max(TimeGenerated), \n    OpenHighRiskPorts = make_set(PortInfo),\n    Protocols = make_set(Protocol),\n    AttackExposureScore = max(AttackExposureScore)\n    by ProjectName, FirewallName, ResourceName, FindingName, Severity, Description, ExternalUri\n| extend OpenHighRiskPorts = strcat_array(OpenHighRiskPorts, \", \")\n| extend Protocols = strcat_array(Protocols, \", \")\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "GoogleSCCDefinition",
                    "dataTypes": [
                      "GoogleCloudSCC"
                    ]
                  }
                ],
                "tactics": [
                  "InitialAccess",
                  "LateralMovement",
                  "Discovery"
                ],
                "techniques": [
                  "T1133",
                  "T1021",
                  "T1046"
                ],
                "entityMappings": [
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "columnName": "ResourceName",
                        "identifier": "Name"
                      }
                    ]
                  }
                ],
                "customDetails": {
                  "Protocols": "Protocols",
                  "ExternalUri": "ExternalUri",
                  "FirewallName": "FirewallName",
                  "FindingId": "[variables('_FindingId')]",
                  "OpenHighRiskPorts": "OpenHighRiskPorts",
                  "AttackExposureScore": "AttackExposureScore",
                  "ProjectName": "ProjectName"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "GCP Firewall {{FirewallName}} allows unrestricted high-risk ports",
                  "alertDescriptionFormat": "GCP Firewall {{FirewallName}} in project {{ProjectName}} allows unrestricted (0.0.0.0/0) ingress to high-risk ports: {{OpenHighRiskPorts}}."
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject4').analyticRuleId4,'/'))))]",
              "properties": {
                "description": "Google Cloud Platform Security Command Center Analytics Rule 4",
                "parentId": "[variables('analyticRuleObject4').analyticRuleId4]",
                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                "source": {
                  "kind": "Solution",
                  "name": "Google Cloud Platform Security Command Center",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
        "contentKind": "AnalyticsRule",
        "displayName": "GCP Security Command Center - Detect Firewall rules allowing unrestricted high-risk ports",
        "contentProductId": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "id": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject5').analyticRuleTemplateSpecName5]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "GCPLoggingDisabled_AnalyticalRules Analytics Rule with template version 3.0.7",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject5').analyticRuleVersion5]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects Google Cloud resources where logging is disabled for services like (Cloud Storage buckets, Firewall rules, Cloud DNS networks) based on Google Cloud Security Command Center findings.",
                "displayName": "GCP Security Command Center - Detect Resources with Logging Disabled",
                "enabled": false,
                "query": "GoogleCloudSCC\n| where tostring(Findings.state) == \"ACTIVE\"\n| extend FindingCategory = tostring(Findings.category)\n| where FindingCategory in (\"BUCKET_LOGGING_DISABLED\", \"FIREWALL_RULE_LOGGING_DISABLED\", \"DNS_LOGGING_DISABLED\")\n| extend FindingsJson = parse_json(Findings)\n| extend Resource = tostring(FindingsJson.resourceName),\n         ExternalUri = tostring(FindingsJson.externalUri),\n         Description = tostring(FindingsJson.description),\n         Severity = tostring(FindingsJson.severity),\n         ProjectName = extract(@\"projects/([^/]+)\", 1, tostring(FindingsJson.resourceName)),\n         ResourceType = extract(@\"//([a-z0-9_.-]+)/\", 1, tostring(FindingsJson.resourceName)),\n         SourceProps = parse_json(tostring(FindingsJson.sourceProperties))\n// Normalize display-friendly resource id\n| extend ResourceName = case(\n    Resource contains \"firewalls/\", extract(@\"firewalls/([^/]+)\", 1, Resource),\n    Resource contains \"storage.googleapis.com/\", extract(@'storage.googleapis.com/([^/\\\"]+)', 1, Resource),\n    Resource contains \"networks/\", extract(@\"networks/([^/]+)\", 1, Resource),\n    Resource\n  )\n| project TimeGenerated, ProjectName, ResourceType, ResourceName, Resource, FindingCategory, Severity, ExternalUri, Description\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "GoogleSCCDefinition",
                    "dataTypes": [
                      "GoogleCloudSCC"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "columnName": "ResourceName",
                        "identifier": "Name"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "AlertPerResult"
                },
                "customDetails": {
                  "ResourceType": "ResourceType",
                  "FindingCategory": "FindingCategory",
                  "ExternalUri": "ExternalUri",
                  "Severity": "Severity",
                  "ProjectName": "ProjectName",
                  "Description": "Description"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "GCP resources with logging disabled: {{ProjectName}} ({{ResourceType}})",
                  "alertDescriptionFormat": "Resource {{ResourceName}} in project {{ProjectName}} (type: {{ResourceType}}) has logging disabled."
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject5').analyticRuleId5,'/'))))]",
              "properties": {
                "description": "Google Cloud Platform Security Command Center Analytics Rule 5",
                "parentId": "[variables('analyticRuleObject5').analyticRuleId5]",
                "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                "source": {
                  "kind": "Solution",
                  "name": "Google Cloud Platform Security Command Center",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
        "contentKind": "AnalyticsRule",
        "displayName": "GCP Security Command Center - Detect Resources with Logging Disabled",
        "contentProductId": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
        "id": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
        "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject1').huntingQueryTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "GCPAdminServiceAccountDetection_HuntingQueries Hunting Query with template version 3.0.7",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject1').huntingQueryVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Google_Cloud_Platform_Security_Command_Center_Hunting_Query_1",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Identify GCP Service Account with Overly Permissive Roles",
                "category": "Hunting Queries",
                "query": "GoogleCloudSCC\n| where tostring(Findings.state) == \"ACTIVE\"\n| extend FindingCategory = tostring(Findings.category)\n| where FindingCategory == \"ADMIN_SERVICE_ACCOUNT\"\n| extend OffendingRoles = todynamic(Findings.iamBindings)\n| mv-expand OffendingRoles\n| extend ServiceAccount = tostring(split(OffendingRoles.member, \"serviceAccount:\")[1]), Role = tostring(split(OffendingRoles.role, \"roles/\")[1])\n| extend\n  Severity = tostring(Findings.severity),\n  ResourceType = tostring(FindingsResource.type),\n  ResourceName = tostring(FindingsResource.displayName),\n  CloudResource = coalesce(tostring(FindingsResource.name), tostring(FindingsResource.displayName))\n| summarize TimeGenerated = max(TimeGenerated) by ServiceAccount, Role, Severity, ResourceType, ResourceName, CloudResource\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "This query identifies Google Cloud Platform (GCP) service accounts with admin privileges using findings from the Security Command Center."
                  },
                  {
                    "name": "tactics",
                    "value": "PrivilegeEscalation,Persistence"
                  },
                  {
                    "name": "techniques",
                    "value": "T1078.004,T1098,T1136.003"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject1')._huntingQuerycontentId1),'/'))))]",
              "properties": {
                "description": "Google Cloud Platform Security Command Center Hunting Query 1",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject1')._huntingQuerycontentId1)]",
                "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject1').huntingQueryVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "Google Cloud Platform Security Command Center",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
        "contentKind": "HuntingQuery",
        "displayName": "Identify GCP Service Account with Overly Permissive Roles",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject1')._huntingQuerycontentId1,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject1')._huntingQuerycontentId1,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject2').huntingQueryTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "GCPComputeSecureBootDisabledDetection_HuntingQueries Hunting Query with template version 3.0.7",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject2').huntingQueryVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Google_Cloud_Platform_Security_Command_Center_Hunting_Query_2",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Identify Compute VMs with Secure Boot Disabled",
                "category": "Hunting Queries",
                "query": "GoogleCloudSCC\n| where tostring(Findings.state) == \"ACTIVE\"\n| extend FindingCategory = tostring(Findings.category)\n| where FindingCategory == \"COMPUTE_SECURE_BOOT_DISABLED\"\n// parse resourceName to extract project and instance\n| extend\n  ResourceName = tostring(Findings.resourceName),\n  ResourceDisplayName = tostring(FindingsResource.displayName)\n| extend\n  Project = extract(@\"projects/([^/]+)\", 1, ResourceName),\n  Instance = extract(@\"instances/([^/]+)$\", 1, ResourceName)\n| extend\n  Severity = tostring(Findings.severity),\n  ResourceType = tostring(FindingsResource.type),\n  CloudResource = coalesce(tostring(FindingsResource.name), ResourceDisplayName)\n| summarize TimeGenerated = max(TimeGenerated) by Project, Instance, FindingCategory, Severity, ResourceType, CloudResource\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Identifies Google Compute Engine VM instances reported by Security Command Center with Secure Boot disabled (COMPUTE_SECURE_BOOT_DISABLED findings)."
                  },
                  {
                    "name": "tactics",
                    "value": "ResourceDevelopment,DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1608,T1562.001"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject2')._huntingQuerycontentId2),'/'))))]",
              "properties": {
                "description": "Google Cloud Platform Security Command Center Hunting Query 2",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject2')._huntingQuerycontentId2)]",
                "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject2').huntingQueryVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "Google Cloud Platform Security Command Center",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
        "contentKind": "HuntingQuery",
        "displayName": "Identify Compute VMs with Secure Boot Disabled",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject2')._huntingQuerycontentId2,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject2')._huntingQuerycontentId2,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject3').huntingQueryTemplateSpecName3]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "GCPFullAPIAccessDetection_HuntingQueries Hunting Query with template version 3.0.7",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject3').huntingQueryVersion3]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Google_Cloud_Platform_Security_Command_Center_Hunting_Query_3",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Identify GCP Instances with Full API Access",
                "category": "Hunting Queries",
                "query": "GoogleCloudSCC\n| where tostring(Findings.state) == \"ACTIVE\"\n| extend FindingCategory = tostring(Findings.category)\n| where FindingCategory == \"FULL_API_ACCESS\"\n// parse resource name to extract project and instance\n| extend ResourceName = tostring(Findings.resourceName)\n| extend Project = extract(@\"projects/([^/]+)\", 1, ResourceName),\n         Instance = extract(@\"instances/([^/]+)$\", 1, ResourceName)\n| extend SourcePropertiesJson = todynamic(Findings.sourceProperties)\n| extend ResourceDisplayName = tostring(FindingsResource.displayName)\n| extend Severity = tostring(Findings.severity),\n         ResourceType = tostring(FindingsResource.type),\n         CloudResource = coalesce(tostring(FindingsResource.name), ResourceDisplayName)\n| summarize TimeGenerated = max(TimeGenerated) by Project, Instance, Severity, ResourceType, ResourceDisplayName, CloudResource\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Identifies Google Cloud Platform Compute Engine instances that are configured with the \"Allow full access to all Cloud APIs\" scope using Security Command Center FULL_API_ACCESS findings."
                  },
                  {
                    "name": "tactics",
                    "value": "PrivilegeEscalation"
                  },
                  {
                    "name": "techniques",
                    "value": "T1068,T1098"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject3')._huntingQuerycontentId3),'/'))))]",
              "properties": {
                "description": "Google Cloud Platform Security Command Center Hunting Query 3",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject3')._huntingQuerycontentId3)]",
                "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject3').huntingQueryVersion3]",
                "source": {
                  "kind": "Solution",
                  "name": "Google Cloud Platform Security Command Center",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
        "contentKind": "HuntingQuery",
        "displayName": "Identify GCP Instances with Full API Access",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject3')._huntingQuerycontentId3,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject3')._huntingQuerycontentId3,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject4').huntingQueryTemplateSpecName4]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "GCPPublicBuckets_HuntingQueries Hunting Query with template version 3.0.7",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject4').huntingQueryVersion4]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Google_Cloud_Platform_Security_Command_Center_Hunting_Query_4",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Identify Public GCP Storage Buckets",
                "category": "Hunting Queries",
                "query": "GoogleCloudSCC\n| where tostring(Findings.state) == \"ACTIVE\"\n| extend FindingCategory = tostring(Findings.category)\n| where FindingCategory == \"PUBLIC_BUCKET_ACL\"\n// Parse embedded finding JSON if the connector serialized it\n| extend FindingsJson = todynamic(Findings)\n| extend ResourceName = coalesce(tostring(FindingsJson.resource.name), tostring(Findings.resourceName))\n// Extract bucket name from resource path like //storage.googleapis.com/<bucket>\n| extend\n  BucketName = extract(@'//storage.googleapis.com/([^/\\\"]+)', 1, ResourceName),\n  ResourceType = tostring(FindingsResource.type)\n| summarize TimeGenerated = max(TimeGenerated) by BucketName, ResourceType, ResourceName\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Identifies Google Cloud Storage buckets that are publicly accessible using Security Command Center findings (PUBLIC_BUCKET_ACL)."
                  },
                  {
                    "name": "tactics",
                    "value": "Exfiltration,Discovery"
                  },
                  {
                    "name": "techniques",
                    "value": "T1537,T1083"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject4')._huntingQuerycontentId4),'/'))))]",
              "properties": {
                "description": "Google Cloud Platform Security Command Center Hunting Query 4",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject4')._huntingQuerycontentId4)]",
                "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject4').huntingQueryVersion4]",
                "source": {
                  "kind": "Solution",
                  "name": "Google Cloud Platform Security Command Center",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
        "contentKind": "HuntingQuery",
        "displayName": "Identify Public GCP Storage Buckets",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject4')._huntingQuerycontentId4,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject4')._huntingQuerycontentId4,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject5').huntingQueryTemplateSpecName5]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "GCPUserManagedServiceAccountKeyDetection_HuntingQueries Hunting Query with template version 3.0.7",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject5').huntingQueryVersion5]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Google_Cloud_Platform_Security_Command_Center_Hunting_Query_5",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Identify GCP User-Managed Service Account Keys",
                "category": "Hunting Queries",
                "query": "GoogleCloudSCC\n| where tostring(Findings.state) == \"ACTIVE\"\n| extend FindingCategory = tostring(Findings.category)\n| where FindingCategory == \"USER_MANAGED_SERVICE_ACCOUNT_KEY\"\n// resourceName format: //iam.googleapis.com/projects/{project}/serviceAccounts/{sa}/keys/{key}\n| extend ResourceName = tostring(Findings.resourceName)\n| extend Project = extract(@\"projects/([^/]+)/\", 1, ResourceName),\n         ServiceAccountSegment = extract(@\"serviceAccounts/([^/]+)/\", 1, ResourceName),\n         KeyId = extract(@\"keys/([^/]+)$\", 1, ResourceName)\n| extend ServiceAccountEmail = iff(ServiceAccountSegment contains \"@\", ServiceAccountSegment, strcat(ServiceAccountSegment, \"@\", Project, \".iam.gserviceaccount.com\"))\n| extend Severity = tostring(Findings.severity),\n         CloudResource = coalesce(tostring(FindingsResource.name), tostring(FindingsResource.displayName))\n| summarize TimeGenerated = max(TimeGenerated) by Project, ServiceAccountEmail, ServiceAccountId = ServiceAccountSegment, KeyId, Severity, CloudResource\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Identifies user-managed service account keys reported by Security Command Center findings (USER_MANAGED_SERVICE_ACCOUNT_KEY)."
                  },
                  {
                    "name": "tactics",
                    "value": "CredentialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1552"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject5')._huntingQuerycontentId5),'/'))))]",
              "properties": {
                "description": "Google Cloud Platform Security Command Center Hunting Query 5",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject5')._huntingQuerycontentId5)]",
                "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject5').huntingQueryVersion5]",
                "source": {
                  "kind": "Solution",
                  "name": "Google Cloud Platform Security Command Center",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
        "contentKind": "HuntingQuery",
        "displayName": "Identify GCP User-Managed Service Account Keys",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject5')._huntingQuerycontentId5,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject5')._huntingQuerycontentId5,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.7",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Google Cloud Platform Security Command Center",
        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p> Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Google%20Cloud%20Platform%20Security%20Command%20Center/ReleaseNotes.md\">Release Notes</a></p>\n<p> There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The Google Cloud Platform (GCP) Security Command Center is a comprehensive security and risk management platform for Google Cloud, ingested from Sentinel's connector. It offers features such as asset inventory and discovery, vulnerability and threat detection, and risk mitigation and remediation to help you gain insight into your organization's security and data attack surface. This integration enables you to perform tasks related to findings and assets more effectively.</p>\n<p><strong>Data Connectors:</strong> 1, <strong>Analytic Rules:</strong> 5, <strong>Hunting Queries:</strong> 5</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src ='https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/google_logo.svg' width='75px' height='75px'>",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Google Cloud Platform Security Command Center",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections')]",
              "version": "[variables('dataConnectorVersionConnections')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
              "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
              "version": "[variables('huntingQueryObject1').huntingQueryVersion1]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
              "version": "[variables('huntingQueryObject2').huntingQueryVersion2]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
              "version": "[variables('huntingQueryObject3').huntingQueryVersion3]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
              "version": "[variables('huntingQueryObject4').huntingQueryVersion4]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
              "version": "[variables('huntingQueryObject5').huntingQueryVersion5]"
            }
          ]
        },
        "firstPublishDate": "2023-09-11",
        "providers": [
          "Microsoft"
        ],
        "categories": {
          "domains": [
            "Security - Cloud Security"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
