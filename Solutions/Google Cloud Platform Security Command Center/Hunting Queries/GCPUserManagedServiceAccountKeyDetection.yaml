id: 47375801-ba85-4296-a548-7d748e3c7601
name: Identify GCP User-Managed Service Account Keys
description: |
  Identifies user-managed service account keys reported by Security Command Center findings (USER_MANAGED_SERVICE_ACCOUNT_KEY).
description-detailed: |
  User-managed service account keys can be long-lived credentials that increase the risk of key leakage and misuse. This hunting query finds active findings of type USER_MANAGED_SERVICE_ACCOUNT_KEY, extracts project, service account identifier (numeric or email form), and key id for triage and remediation.
requiredDataConnectors:
  - connectorId: GoogleSCCDefinition
    dataTypes:
      - GoogleCloudSCC
tactics:
  - CredentialAccess
relevantTechniques:
  - T1552
tags:
  - CIS GCP Foundations Benchmark v3.0 1.4
query: |
  GoogleCloudSCC
  | where tostring(Findings.state) == "ACTIVE"
  | extend FindingCategory = tostring(Findings.category)
  | where FindingCategory == "USER_MANAGED_SERVICE_ACCOUNT_KEY"
  // resourceName format: //iam.googleapis.com/projects/{project}/serviceAccounts/{sa}/keys/{key}
  | extend ResourceName = tostring(Findings.resourceName)
  | extend Project = extract(@"projects/([^/]+)/", 1, ResourceName),
           ServiceAccountSegment = extract(@"serviceAccounts/([^/]+)/", 1, ResourceName),
           KeyId = extract(@"keys/([^/]+)$", 1, ResourceName)
  | extend ServiceAccountEmail = iff(ServiceAccountSegment contains "@", ServiceAccountSegment, strcat(ServiceAccountSegment, "@", Project, ".iam.gserviceaccount.com"))
  | extend Severity = tostring(Findings.severity),
           CloudResource = coalesce(tostring(FindingsResource.name), tostring(FindingsResource.displayName))
  | summarize TimeGenerated = max(TimeGenerated) by Project, ServiceAccountEmail, ServiceAccountId = ServiceAccountSegment, KeyId, Severity, CloudResource
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: ServiceAccountEmail
  - entityType: CloudApplication
    fieldMappings:
      - identifier: Name
        columnName: CloudResource
version: 1.0.0
