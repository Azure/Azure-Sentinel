id: b2197d7f-4731-483c-89de-d48606b872da
name: Box - User logged in as admin
description: |
  'Detects when user logged in as admin.'
severity: Medium
status: Available
requiredDataConnectors:
  - connectorId: BoxDataConnector
    dataTypes:
      - BoxEvents_CL
queryFrequency: 1h
queryPeriod: 14d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - PrivilegeEscalation
relevantTechniques:
  - T1078
query: |
  let lbperiod_start = 14d;
  let lbperiod_end = 1d;
  let admins = BoxEvents
  | where TimeGenerated between (ago(lbperiod_start) .. ago(lbperiod_end))
  | where EventType =~ 'ADMIN_LOGIN'
  | summarize make_set(SourceLogin);
  BoxEvents
  | where EventType =~ 'ADMIN_LOGIN'
  | where SourceLogin !in (admins)
  | extend UpnDomain = tostring(split(SourceLogin, "@")[1])
  | summarize EventCount = count(), DistinctLogins = dcount(SourceLogin) by UpnDomain
  | project UpnDomain, EventCount, DistinctLogins
  | order by EventCount desc

entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: SourceLogin
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SrcIpAddr
version: 1.0.1
kind: Scheduled