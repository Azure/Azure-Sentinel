{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Eli Forbes - v-eliforbes@microsoft.com",
    "comments": "Solution template for Cisco Umbrella"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic3-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic4-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic5-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic6-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic7-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic8-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic9-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic10-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "playbook5-PlaybookName": {
      "defaultValue": "CiscoUmbrella-AssignPolicyToIdentity",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook5-PolicyId": {
      "defaultValue": "",
      "type": "string"
    },
    "playbook6-PlaybookName": {
      "defaultValue": "CiscoUmbrella-BlockDomain",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook7-PlaybookName": {
      "defaultValue": "CiscoUmbrella-GetDomainInfo",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    }
  },
  "variables": {
    "CiscoUmbrella": "CiscoUmbrella",
    "_CiscoUmbrella": "[variables('CiscoUmbrella')]",
    "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
    "_workbook-source": "[variables('workbook-source')]",
    "CiscoUmbrellaConnectionNon-CorporatePrivateNetwork": "CiscoUmbrellaConnectionNon-CorporatePrivateNetwork",
    "_CiscoUmbrellaConnectionNon-CorporatePrivateNetwork": "[variables('CiscoUmbrellaConnectionNon-CorporatePrivateNetwork')]",
    "CiscoUmbrellaConnectionToUnpopularWebsiteDetected": "CiscoUmbrellaConnectionToUnpopularWebsiteDetected",
    "_CiscoUmbrellaConnectionToUnpopularWebsiteDetected": "[variables('CiscoUmbrellaConnectionToUnpopularWebsiteDetected')]",
    "CiscoUmbrellaCryptoMinerUserAgentDetected": "CiscoUmbrellaCryptoMinerUserAgentDetected",
    "_CiscoUmbrellaCryptoMinerUserAgentDetected": "[variables('CiscoUmbrellaCryptoMinerUserAgentDetected')]",
    "CiscoUmbrellaEmptyUserAgentDetected": "CiscoUmbrellaEmptyUserAgentDetected",
    "_CiscoUmbrellaEmptyUserAgentDetected": "[variables('CiscoUmbrellaEmptyUserAgentDetected')]",
    "CiscoUmbrellaHackToolUserAgentDetected": "CiscoUmbrellaHackToolUserAgentDetected",
    "_CiscoUmbrellaHackToolUserAgentDetected": "[variables('CiscoUmbrellaHackToolUserAgentDetected')]",
    "CiscoUmbrellaPowershellUserAgentDetected": "CiscoUmbrellaPowershellUserAgentDetected",
    "_CiscoUmbrellaPowershellUserAgentDetected": "[variables('CiscoUmbrellaPowershellUserAgentDetected')]",
    "CiscoUmbrellaRareUserAgentDetected": "CiscoUmbrellaRareUserAgentDetected",
    "_CiscoUmbrellaRareUserAgentDetected": "[variables('CiscoUmbrellaRareUserAgentDetected')]",
    "CiscoUmbrellaRequestAllowedHarmfulMaliciousURICategory": "CiscoUmbrellaRequestAllowedHarmfulMaliciousURICategory",
    "_CiscoUmbrellaRequestAllowedHarmfulMaliciousURICategory": "[variables('CiscoUmbrellaRequestAllowedHarmfulMaliciousURICategory')]",
    "CiscoUmbrellaRequestBlocklistedFileType": "CiscoUmbrellaRequestBlocklistedFileType",
    "_CiscoUmbrellaRequestBlocklistedFileType": "[variables('CiscoUmbrellaRequestBlocklistedFileType')]",
    "CiscoUmbrellaURIContainsIPAddress": "CiscoUmbrellaURIContainsIPAddress",
    "_CiscoUmbrellaURIContainsIPAddress": "[variables('CiscoUmbrellaURIContainsIPAddress')]",
    "CiscoUmbrellaAnomalousFQDNsforDomain": "CiscoUmbrellaAnomalousFQDNsforDomain",
    "_CiscoUmbrellaAnomalousFQDNsforDomain": "[variables('CiscoUmbrellaAnomalousFQDNsforDomain')]",
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "CiscoUmbrellaBlockedUserAgents": "CiscoUmbrellaBlockedUserAgents",
    "_CiscoUmbrellaBlockedUserAgents": "[variables('CiscoUmbrellaBlockedUserAgents')]",
    "CiscoUmbrellaDNSErrors": "CiscoUmbrellaDNSErrors",
    "_CiscoUmbrellaDNSErrors": "[variables('CiscoUmbrellaDNSErrors')]",
    "CiscoUmbrellaDNSRequestsUunreliableCategory": "CiscoUmbrellaDNSRequestsUunreliableCategory",
    "_CiscoUmbrellaDNSRequestsUunreliableCategory": "[variables('CiscoUmbrellaDNSRequestsUunreliableCategory')]",
    "CiscoUmbrellaHighCountsOfTheSameBytesInSize": "CiscoUmbrellaHighCountsOfTheSameBytesInSize",
    "_CiscoUmbrellaHighCountsOfTheSameBytesInSize": "[variables('CiscoUmbrellaHighCountsOfTheSameBytesInSize')]",
    "CiscoUmbrellaHighValuesOfUploadedData": "CiscoUmbrellaHighValuesOfUploadedData",
    "_CiscoUmbrellaHighValuesOfUploadedData": "[variables('CiscoUmbrellaHighValuesOfUploadedData')]",
    "CiscoUmbrellaPossibleConnectionC2": "CiscoUmbrellaPossibleConnectionC2",
    "_CiscoUmbrellaPossibleConnectionC2": "[variables('CiscoUmbrellaPossibleConnectionC2')]",
    "CiscoUmbrellaPossibleDataExfiltration": "CiscoUmbrellaPossibleDataExfiltration",
    "_CiscoUmbrellaPossibleDataExfiltration": "[variables('CiscoUmbrellaPossibleDataExfiltration')]",
    "CiscoUmbrellaProxyAllowedUnreliableCategory": "CiscoUmbrellaProxyAllowedUnreliableCategory",
    "_CiscoUmbrellaProxyAllowedUnreliableCategory": "[variables('CiscoUmbrellaProxyAllowedUnreliableCategory')]",
    "CiscoUmbrellaRequestsUncategorizedURI": "CiscoUmbrellaRequestsUncategorizedURI",
    "_CiscoUmbrellaRequestsUncategorizedURI": "[variables('CiscoUmbrellaRequestsUncategorizedURI')]",
    "Cisco_Umbrella": "Cisco_Umbrella",
    "_Cisco_Umbrella": "[variables('Cisco_Umbrella')]",
    "CiscoUmbrellaEnforcementAPIConnector": "CiscoUmbrellaEnforcementAPIConnector",
    "_CiscoUmbrellaEnforcementAPIConnector": "[variables('CiscoUmbrellaEnforcementAPIConnector')]",
    "playbook1-customApis_CiscoUmbrellaEnforcementAPI_name": "CiscoUmbrellaEnforcementAPI",
    "operationId-BlockDomains": "BlockDomains",
    "_operationId-BlockDomains": "[variables('operationId-BlockDomains')]",
    "operationId-GetDomains": "GetDomains",
    "_operationId-GetDomains": "[variables('operationId-GetDomains')]",
    "operationId-DeleteDomainByName": "DeleteDomainByName",
    "_operationId-DeleteDomainByName": "[variables('operationId-DeleteDomainByName')]",
    "operationId-DeleteDomainById": "DeleteDomainById",
    "_operationId-DeleteDomainById": "[variables('operationId-DeleteDomainById')]",
    "CiscoUmbrellaInvestigateAPIConnector": "CiscoUmbrellaInvestigateAPIConnector",
    "_CiscoUmbrellaInvestigateAPIConnector": "[variables('CiscoUmbrellaInvestigateAPIConnector')]",
    "playbook2-customApis_CiscoUmbrellaInvestigateAPIConnector_name": "CiscoUmbrellaInvestigateAPI",
    "operationId-GetDomainSecurityData": "GetDomainSecurityData",
    "_operationId-GetDomainSecurityData": "[variables('operationId-GetDomainSecurityData')]",
    "operationId-GetDomainRiskScore": "GetDomainRiskScore",
    "_operationId-GetDomainRiskScore": "[variables('operationId-GetDomainRiskScore')]",
    "operationId-GetDomainStatusAndCategorization": "GetDomainStatusAndCategorization",
    "_operationId-GetDomainStatusAndCategorization": "[variables('operationId-GetDomainStatusAndCategorization')]",
    "operationId-GetCoOccurrencesForDomain": "GetCoOccurrencesForDomain",
    "_operationId-GetCoOccurrencesForDomain": "[variables('operationId-GetCoOccurrencesForDomain')]",
    "operationId-GetRelatedDomains": "GetRelatedDomains",
    "_operationId-GetRelatedDomains": "[variables('operationId-GetRelatedDomains')]",
    "CiscoUmbrellaManagementAPIConnector": "CiscoUmbrellaManagementAPIConnector",
    "_CiscoUmbrellaManagementAPIConnector": "[variables('CiscoUmbrellaManagementAPIConnector')]",
    "playbook3-customApis_CiscoUmbrellaManagementAPI_name": "CiscoUmbrellaManagementAPI",
    "operationId-RetrieveAllDestinationLists": "RetrieveAllDestinationLists",
    "_operationId-RetrieveAllDestinationLists": "[variables('operationId-RetrieveAllDestinationLists')]",
    "operationId-CreateDestinationList": "CreateDestinationList",
    "_operationId-CreateDestinationList": "[variables('operationId-CreateDestinationList')]",
    "operationId-GetDestinationList": "GetDestinationList",
    "_operationId-GetDestinationList": "[variables('operationId-GetDestinationList')]",
    "operationId-GetDestinationsList": "GetDestinationsList",
    "_operationId-GetDestinationsList": "[variables('operationId-GetDestinationsList')]",
    "operationId-AddDestinations": "AddDestinations",
    "_operationId-AddDestinations": "[variables('operationId-AddDestinations')]",
    "operationId-DeleteDestinations": "DeleteDestinations",
    "_operationId-DeleteDestinations": "[variables('operationId-DeleteDestinations')]",
    "CiscoUmbrellaNetworkDeviceManagementAPIConnector": "CiscoUmbrellaNetworkDeviceManagementAPIConnector",
    "_CiscoUmbrellaNetworkDeviceManagementAPIConnector": "[variables('CiscoUmbrellaNetworkDeviceManagementAPIConnector')]",
    "playbook4-customApis_CiscoUmbrellaNetworkDeviceManagementAPI_name": "CiscoUmbrellaNetworkDeviceManagementAPI",
    "operationId-GetOrganizationId": "GetOrganizationId",
    "_operationId-GetOrganizationId": "[variables('operationId-GetOrganizationId')]",
    "operationId-ListAllPoliciesOnDevice": "ListAllPoliciesOnDevice",
    "_operationId-ListAllPoliciesOnDevice": "[variables('operationId-ListAllPoliciesOnDevice')]",
    "operationId-DeleteIdentityFromPolicy": "DeleteIdentityFromPolicy",
    "_operationId-DeleteIdentityFromPolicy": "[variables('operationId-DeleteIdentityFromPolicy')]",
    "operationId-AssignPolicyToIdentity": "AssignPolicyToIdentity",
    "_operationId-AssignPolicyToIdentity": "[variables('operationId-AssignPolicyToIdentity')]",
    "CiscoUmbrella-AssignPolicyToIdentity": "CiscoUmbrella-AssignPolicyToIdentity",
    "_CiscoUmbrella-AssignPolicyToIdentity": "[variables('CiscoUmbrella-AssignPolicyToIdentity')]",
    "playbook5-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook5-PlaybookName'))]",
    "playbook5-CiscoUmbrellaNetworkDeviceManagementAPIConnectionName": "[concat('ciscoumbrellanetworkdevice-connection-', parameters('playbook5-PlaybookName'))]",
    "playbook5-customApis_ciscoumbrellanetworkdevicemanagement_name": "CiscoUmbrellaNetworkDeviceManagementAPI",
    "playbook-5-connection-1": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]",
    "_playbook-5-connection-1": "[variables('playbook-5-connection-1')]",
    "playbook-5-connection-2": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('playbook5-customApis_ciscoumbrellanetworkdevicemanagement_name'))]",
    "_playbook-5-connection-2": "[variables('playbook-5-connection-2')]",
    "CiscoUmbrella-BlockDomain": "CiscoUmbrella-BlockDomain",
    "_CiscoUmbrella-BlockDomain": "[variables('CiscoUmbrella-BlockDomain')]",
    "playbook6-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook6-PlaybookName'))]",
    "playbook6-CiscoUmbrellaEnforcementAPIConnectionName": "[concat('ciscoumbrellaenforcement-connection-', parameters('playbook6-PlaybookName'))]",
    "playbook6-customApis_ciscoumbrellaenforcement_name": "CiscoUmbrellaEnforcementAPI",
    "playbook-6-connection-2": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('playbook6-customApis_ciscoumbrellaenforcement_name'))]",
    "_playbook-6-connection-2": "[variables('playbook-6-connection-2')]",
    "CiscoUmbrella-GetDomainInfo": "CiscoUmbrella-GetDomainInfo",
    "_CiscoUmbrella-GetDomainInfo": "[variables('CiscoUmbrella-GetDomainInfo')]",
    "playbook7-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook7-PlaybookName'))]",
    "playbook7-CiscoUmbrellaInvestigateAPIConnectionName": "[concat('ciscoumbrellainvestigate-connection-', parameters('playbook7-PlaybookName'))]",
    "playbook7-customApis_ciscoumbrellainvestigate_name": "CiscoUmbrellaInvestigateAPI",
    "playbook-7-connection-2": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('playbook7-customApis_ciscoumbrellainvestigate_name'))]",
    "_playbook-7-connection-2": "[variables('playbook-7-connection-2')]",
    "sourceId": "azuresentinel.azure-sentinel-solution-ciscoumbrella",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "2020-02-12",
      "properties": {
        "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\">**NOTE:** This workbook uses a parser based on a Kusto Function to normalize fields. [Follow these steps](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Parsers/CiscoUmbrella/Cisco_Umbrella) to create the Kusto function alias **Cisco_Umbrella**.\"},\"name\":\"Text\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"464b6899-a8de-4f01-84a6-d4e3ecc7f282\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cisco Umbrella Main Dashboard\",\"subTarget\":\"cisco_umbrella_main_dashboard\",\"preText\":\"Cisco Umbrella Main Dashboard\",\"style\":\"link\"},{\"id\":\"a3798d8a-a610-475c-9cbf-7252301dab7e\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cisco Umbrella Dns Dashboard\",\"subTarget\":\"cisco_umbrella_dns_dashboard\",\"style\":\"link\"},{\"id\":\"80bcf252-bcf6-4736-993d-59da0a8e4c76\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cisco Umbrella Proxy Dashboard\",\"subTarget\":\"cisco_umbrella_proxy_dashboard\",\"style\":\"link\"},{\"id\":\"f536a1e9-362e-4d98-bdd1-0f7dfb23901a\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cisco Umbrella Firewall Dashboard\",\"subTarget\":\"cisco_umbrella_firewall_dashboard\",\"style\":\"link\"}]},\"name\":\"Links\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"37b91baf-6272-4709-a028-1370823249d4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":5184000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Parameters1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| summarize Count=count() by EventType\\n| render barchart\",\"size\":3,\"title\":\"Events Count by EventType\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"EventType\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"EventType\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Count\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_main_dashboard\"},\"customWidth\":\"30\",\"name\":\"EventsCountByEventType\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n|make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by EventType;\",\"size\":0,\"title\":\"Events over time\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_main_dashboard\"},\"customWidth\":\"70\",\"name\":\"EventsOverTime\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where DvcAction contains \\\"block\\\"\\n| where TimeGenerated {TimeRange} \\n|make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Blocks over time\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_main_dashboard\"},\"customWidth\":\"70\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let CU_Total_Requests =\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| summarize count()\\n| extend evttype=\\\"Total Requests\\\";\\n\\nlet CU_Total_Blocked =\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where DvcAction contains \\\"block\\\"\\n| summarize count()\\n| extend evttype=\\\"Total Blocked\\\";\\n\\nlet CU_Security_Blocked =\\nCisco_Umbrella \\n| where TimeGenerated {TimeRange} \\n| where DvcAction contains \\\"block\\\"\\n| where isnotempty(ThreatCategory)\\n| summarize count()\\n| extend evttype=\\\"Security Blocked\\\";\\n\\nunion CU_Security_Blocked,CU_Total_Blocked,CU_Total_Requests\",\"size\":3,\"title\":\"Network Breakdown Statistic\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"evttype\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_main_dashboard\"},\"customWidth\":\"30\",\"name\":\"NetworkBreakdownStatistic\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| summarize count() by DvcAction\",\"size\":3,\"title\":\"DNS - Events count by Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"DvcAction\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"30\",\"name\":\"DNSEventsCountByAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| summarize Count=count() by DnsQueryTypeName | sort by Count\",\"size\":0,\"title\":\"DNS - Events count by QueryType\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"categoricalbar\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"70\",\"name\":\"DNSEventsCountByQueryType\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where EventType == \\\"dnslogs\\\"\\n| where TimeGenerated {TimeRange} \\n| where isnotempty(ThreatCategory)\\n| extend Threat_Category=parsejson(tostring(ThreatCategory))\\n| mv-expand Threat_Category\\n| summarize Count=count() by tostring(Threat_Category)\\n| sort by Count \\n| join kind = inner (\\nCisco_Umbrella\\n| where EventType == \\\"dnslogs\\\"\\n| where isnotempty(ThreatCategory)\\n| where TimeGenerated {TimeRange} \\n| extend Threat_Category=parsejson(tostring(ThreatCategory))\\n| mv-expand Threat_Category\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by tostring(Threat_Category))\\n on Threat_Category\\n | project-away Threat_Category1, TimeGenerated\\n | project Threat_Category, Count, Trend\\n | order by Count\\n| take 10\",\"size\":0,\"title\":\"DNS - Events by Threat Category\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"30\",\"name\":\"DNSEventsByThreatCategory\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where isnotempty(UrlCategory)\\n| extend Url_Category=parsejson(tostring(UrlCategory))\\n| mv-expand Url_Category\\n| summarize Count=count() by tostring(Url_Category)\\n| sort by Count\\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where isnotempty(UrlCategory)\\n| extend Url_Category=parsejson(tostring(UrlCategory))\\n| mv-expand Url_Category\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by tostring(Url_Category))\\n on Url_Category\\n | project-away Url_Category1, TimeGenerated\\n | project Url_Category, Count, Trend\\n | order by Count\\n| take 10\",\"size\":0,\"title\":\"DNS - Events by Url Category\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"35\",\"name\":\"DNSEventsByUrlCategory\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let list_IP = Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where DvcAction == \\\"Blocked\\\"\\n|summarize Count=count() by SrcIpAddr | top 10 by Count\\n| summarize makelist(SrcIpAddr);\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where DvcAction == \\\"Blocked\\\"\\n|summarize Count=count() by SrcIpAddr \\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"dnslogs\\\"\\n| where DvcAction == \\\"Blocked\\\"\\n| where SrcIpAddr in (list_IP)\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SrcIpAddr)\\n on SrcIpAddr\\n |  project-away SrcIpAddr1, TimeGenerated\\n | project SrcIpAddr, Count, Trend\\n | order by Count\\n| take 10\\n\\n\",\"size\":0,\"title\":\"DNS - Top 10 SrcIp with Blocked Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"customWidth\":\"35\",\"name\":\"DNSTop10SrcIpBlockedAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange}\\n| where EventType == \\\"dnslogs\\\"\\n| where DvcAction == \\\"Blocked\\\"\\n| summarize Count=count() by DnsQueryName, UrlCategory \\n| top 10 by Count\\n\",\"size\":0,\"title\":\"DNS - Top 10 Blocked Url \",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_dns_dashboard\"},\"name\":\"DNSTop10BlockedUrl \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| summarize count() by DvcAction\",\"size\":3,\"title\":\"Proxy - Events count by Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"30\",\"name\":\"ProxyEventsCountByAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let CU_proxy_outcoming_traffic =\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| extend TrafficType = \\\"Outcoming\\\", Bytes = SrcBytes\\n| project TrafficType, Bytes, TimeGenerated;\\n\\nlet CU_proxy_incoming_traffic =\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| extend TrafficType = \\\"Incoming\\\", Bytes = DstBytes\\n| project TrafficType, Bytes, TimeGenerated;\\n\\n\\nunion CU_proxy_outcoming_traffic, CU_proxy_incoming_traffic\\n| make-series TotalGbytes = round(sum(Bytes/(1024*1024*1024)),2) on TimeGenerated  from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by TrafficType\\n\",\"size\":0,\"title\":\"Proxy - Traffic timechart, GB\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"70\",\"name\":\"ProxyTrafficTimechart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where isnotempty(UrlCategory)\\n| extend Url_Category=parsejson(tostring(UrlCategory))\\n| mv-expand Url_Category\\n| summarize Count=count() by tostring(Url_Category)\\n| sort by Count\\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where isnotempty(UrlCategory)\\n| extend Url_Category=parsejson(tostring(UrlCategory))\\n| mv-expand Url_Category\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by tostring(Url_Category))\\n on Url_Category\\n | project-away Url_Category1, TimeGenerated\\n | project Url_Category, Count, Trend\\n | order by Count\\n| take 10\",\"size\":0,\"title\":\"Proxy - Events by Url Category\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"30\",\"name\":\"ProxyEventsByUrlCategory\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let list_IP = Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where DvcAction == \\\"BLOCKED\\\"\\n|summarize Count=count() by SrcIpAddr | top 10 by Count\\n| summarize makelist(SrcIpAddr);\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where DvcAction == \\\"BLOCKED\\\"\\n|summarize Count=count() by SrcIpAddr \\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where DvcAction == \\\"BLOCKED\\\"\\n| where SrcIpAddr in (list_IP)\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SrcIpAddr)\\n on SrcIpAddr\\n |  project-away SrcIpAddr1, TimeGenerated\\n | project SrcIpAddr, Count, Trend\\n | order by Count\\n| take 10\\n\\n\",\"size\":0,\"title\":\"Proxy - Top 10 Source IP with Blocked Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"35\",\"name\":\"ProxyTop10SourceIPBlockedAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where isnotempty(ThreatCategory)\\n| extend Threat_Category=parsejson(tostring(ThreatCategory))\\n| mv-expand Threat_Category\\n| summarize Count=count() by tostring(Threat_Category)\\n| sort by Count \\n| join kind = inner (\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"proxylogs\\\"\\n| where isnotempty(ThreatCategory)\\n| extend Threat_Category=parsejson(tostring(ThreatCategory))\\n| mv-expand Threat_Category\\n| make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by tostring(Threat_Category))\\n on Threat_Category\\n | project-away Threat_Category1, TimeGenerated\\n | project Threat_Category, Count, Trend\\n | order by Count\\n| take 10\",\"size\":0,\"title\":\"Proxy - Events by Threat Category\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"customWidth\":\"35\",\"name\":\"ProxyEventsByThreatCategory\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange}\\n| where EventType == \\\"proxylogs\\\"\\n| where DvcAction == \\\"BLOCKED\\\"\\n| summarize Count=count() by UrlOriginal, UrlCategory \\n| top 10 by Count\\n\",\"size\":0,\"title\":\"Proxy - Top 10 Blocked Url \",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_proxy_dashboard\"},\"name\":\"ProxyTop10BlockedUrl \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"cloudfirewalllogs\\\"\\n| summarize count() by DvcAction\",\"size\":3,\"title\":\"Firewall - Events count by Action\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"DvcAction\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_firewall_dashboard\"},\"customWidth\":\"30\",\"name\":\"FirewallEventsCountByAction\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\nCisco_Umbrella\\n| where TimeGenerated {TimeRange} \\n| where EventType == \\\"cloudfirewalllogs\\\"\\n| make-series Packets = sum(toint(NetworkPackets)) on TimeGenerated  from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by NetworkDirection\",\"size\":0,\"title\":\"Firewall - Traffic over time, Packets\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_firewall_dashboard\"},\"customWidth\":\"70\",\"name\":\"FirewallTrafficOverTime\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cisco_Umbrella\\n|where EventType == \\\"cloudfirewalllogs\\\"\\n| where DvcAction contains \\\"BLOCK\\\"\\n| where TimeGenerated {TimeRange} \\n|make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Firewall - Block Events over time\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"cisco_umbrella_firewall_dashboard\"},\"customWidth\":\"50\",\"name\":\"query - 19\"}],\"fromTemplateId\":\"sentinel-CiscoUmbrella\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
        "version": "1.0",
        "sourceId": "[variables('_workbook-source')]",
        "category": "sentinel"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "IP addresses of broadband links that usually indicates users attempting to access their home network, for example for a remote session to a home computer.",
        "displayName": "Cisco Umbrella - Connection to non-corporate private network",
        "enabled": false,
        "query": "let lbtime = 10m;\nCisco_Umbrella\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| where UrlCategory contains 'Adult Themes' or\n      UrlCategory contains 'Adware' or\n      UrlCategory contains 'Alcohol' or\n      UrlCategory contains 'Illegal Downloads' or\n      UrlCategory contains 'Drugs' or\n      UrlCategory contains 'Child Abuse Content' or\n      UrlCategory contains 'Hate/Discrimination' or\n      UrlCategory contains 'Nudity' or\n      UrlCategory contains 'Pornography' or\n      UrlCategory contains 'Proxy/Anonymizer' or\n      UrlCategory contains 'Sexuality' or\n      UrlCategory contains 'Tasteless' or\n      UrlCategory contains 'Terrorism' or\n      UrlCategory contains 'Web Spam' or\n      UrlCategory contains 'German Youth Protection' or\n      UrlCategory contains 'Illegal Activities' or\n      UrlCategory contains 'Lingerie/Bikini' or\n      UrlCategory contains 'Weapons'\n| project TimeGenerated, SrcIpAddr, Identities\n| extend IPCustomEntity = SrcIpAddr\n| extend AccountCustomEntity = Identities\n",
        "queryFrequency": "PT10M",
        "queryPeriod": "PT10M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl",
          "Exfiltration"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects first connection to an unpopular website (possible malicious payload delivery).",
        "displayName": "Cisco Umbrella - Connection to Unpopular Website Detected",
        "enabled": false,
        "query": "let domain_lookBack= 14d;\nlet timeframe = 1d;\nlet top_million_list = Cisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(domain_lookBack) and TimeGenerated < ago(timeframe)\n| extend Hostname = parse_url(UrlOriginal)[\"Host\"]\n| summarize count() by tostring(Hostname)\n| top 1000000 by count_\n| summarize make_list(Hostname);\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| extend Hostname = parse_url(UrlOriginal)[\"Host\"]\n| where Hostname !in (top_million_list)\n| extend Message = \"Connect to unpopular website (possible malicious payload delivery)\"\n| project Message, SrcIpAddr, DstIpAddr,UrlOriginal, TimeGenerated\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "P1D",
        "queryPeriod": "P14D",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic3-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects suspicious user agent strings used by crypto miners in proxy logs.",
        "displayName": "Cisco Umbrella - Crypto Miner User-Agent Detected",
        "enabled": false,
        "query": "let timeframe = 15m;\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal contains \"XMRig\" or HttpUserAgentOriginal contains \"ccminer\"\n| extend Message = \"Crypto Miner User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated,HttpUserAgentOriginal\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "PT15M",
        "queryPeriod": "PT15M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic4-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Rule helps to detect empty and unusual user agent indicating web browsing activity by an unusual process other than a web browser.",
        "displayName": "Cisco Umbrella - Empty User Agent Detected",
        "enabled": false,
        "query": "let timeframe = 15m;\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal == ''\n| extend Message = \"Empty User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "PT15M",
        "queryPeriod": "PT15M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic5-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects suspicious user agent strings used by known hack tools",
        "displayName": "Cisco Umbrella - Hack Tool User-Agent Detected",
        "enabled": false,
        "query": "let timeframe = 15m;\nlet user_agents=dynamic([\n                          '(hydra)',\n                          ' arachni/',\n                          ' BFAC ',\n                          ' brutus ',\n                          ' cgichk ',\n                          'core-project/1.0',\n                          ' crimscanner/',\n                          'datacha0s',\n                          'dirbuster',\n                          'domino hunter',\n                          'dotdotpwn',\n                          'FHScan Core',\n                          'floodgate',\n                          'get-minimal',\n                          'gootkit auto-rooter scanner',\n                          'grendel-scan',\n                          ' inspath ',\n                          'internet ninja',\n                          'jaascois',\n                          ' zmeu ',\n                          'masscan',\n                          ' metis ',\n                          'morfeus fucking scanner',\n                          'n-stealth',\n                          'nsauditor',\n                          'pmafind',\n                          'security scan',\n                          'springenwerk',\n                          'teh forest lobster',\n                          'toata dragostea',\n                          ' vega/',\n                          'voideye',\n                          'webshag',\n                          'webvulnscan',\n                          ' whcc/',\n                          ' Havij',\n                          'absinthe',\n                          'bsqlbf',\n                          'mysqloit',\n                          'pangolin',\n                          'sql power injector',\n                          'sqlmap',\n                          'sqlninja',\n                          'uil2pn',\n                          'ruler',\n                          'Mozilla/5.0 (Windows; U; Windows NT 5.1; pt-PT; rv:1.9.1.2) Gecko/20090729 Firefox/3.5.2 (.NET CLR 3.5.30729)'\n                          ]);\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal has_any (user_agents)\n| extend Message = \"Hack Tool User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated, HttpUserAgentOriginal\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "PT15M",
        "queryPeriod": "PT15M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic6-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Rule helps to detect Powershell user-agent activity by an unusual process other than a web browser.",
        "displayName": "Cisco Umbrella - Windows PowerShell User-Agent Detected",
        "enabled": false,
        "query": "let timeframe = 15m;\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal contains \"WindowsPowerShell\"\n| extend Message = \"Windows PowerShell User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated,HttpUserAgentOriginal\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "PT15M",
        "queryPeriod": "PT15M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl",
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic7-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Rule helps to detect a rare user-agents indicating web browsing activity by an unusual process other than a web browser.",
        "displayName": "Cisco Umbrella - Rare User Agent Detected",
        "enabled": false,
        "query": "let lookBack = 14d;\nlet timeframe = 1d;\nlet user_agents_list = Cisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(lookBack) and TimeGenerated < ago(timeframe)\n| summarize count() by HttpUserAgentOriginal\n| summarize make_list(HttpUserAgentOriginal);\nCisco_Umbrella\n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| where HttpUserAgentOriginal !in (user_agents_list)\n| extend Message = \"Rare User Agent\"\n| project Message, SrcIpAddr, DstIpAddr, UrlOriginal, TimeGenerated, HttpUserAgentOriginal\n| extend IpCustomEntity = SrcIpAddr, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "P1D",
        "queryPeriod": "P14D",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic8-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "It is reccomended that these Categories shoud be blocked by policies because they provide harmful/malicious content..",
        "displayName": "Cisco Umbrella - Request Allowed to harmful/malicious URI category",
        "enabled": false,
        "query": "let lbtime = 10m;\nCisco_Umbrella\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| where UrlCategory contains 'Adult Themes' or\n      UrlCategory contains 'Adware' or\n      UrlCategory contains 'Alcohol' or\n      UrlCategory contains 'Illegal Downloads' or\n      UrlCategory contains 'Drugs' or\n      UrlCategory contains 'Child Abuse Content' or\n      UrlCategory contains 'Hate/Discrimination' or\n      UrlCategory contains 'Nudity' or\n      UrlCategory contains 'Pornography' or\n      UrlCategory contains 'Proxy/Anonymizer' or\n      UrlCategory contains 'Sexuality' or\n      UrlCategory contains 'Tasteless' or\n      UrlCategory contains 'Terrorism' or\n      UrlCategory contains 'Web Spam' or\n      UrlCategory contains 'German Youth Protection' or\n      UrlCategory contains 'Illegal Activities' or\n      UrlCategory contains 'Lingerie/Bikini' or\n      UrlCategory contains 'Weapons'\n| project TimeGenerated, SrcIpAddr, Identities\n| extend IPCustomEntity = SrcIpAddr\n| extend AccountCustomEntity = Identities\n",
        "queryFrequency": "PT10M",
        "queryPeriod": "PT10M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl",
          "InitialAccess"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic9-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects request to potentially harmful file types (.ps1, .bat, .vbs, etc.).",
        "displayName": "Cisco Umbrella - Request to blocklisted file type",
        "enabled": false,
        "query": "let file_ext_blocklist = dynamic(['.ps1', '.vbs', '.bat', '.scr']);\nlet lbtime = 10m;\nCisco_Umbrella\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| extend file_ext = extract(@'.*(\\.\\w+)$', 1, UrlOriginal)\n| extend Filename = extract(@'.*\\/*\\/(.*\\.\\w+)$', 1, UrlOriginal)\n| where file_ext in (file_ext_blocklist)\n| project TimeGenerated, SrcIpAddr, Identities, Filename\n| extend IPCustomEntity = SrcIpAddr\n| extend AccountCustomEntity = Identities\n",
        "queryFrequency": "PT10M",
        "queryPeriod": "PT10M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic10-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Malware can use IP address to communicate with C2.",
        "displayName": "Cisco Umbrella - URI contains IP address",
        "enabled": false,
        "query": "let lbtime = 10m;\nCisco_Umbrella\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'proxylogs'\n| where DvcAction =~ 'Allowed'\n| where UrlOriginal matches regex @'\\Ahttp:\\/\\/\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}.*'\n| project TimeGenerated, SrcIpAddr, Identities\n| extend IPCustomEntity = SrcIpAddr\n| extend AccountCustomEntity = Identities\n",
        "queryFrequency": "PT10M",
        "queryPeriod": "PT10M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CommandandControl"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco Umbrella Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco Umbrella Data Parser",
            "category": "Samples",
            "functionAlias": "Cisco_Umbrella",
            "query": "\n\n\nlet Cisco_Umbrella_dns_view = view () { \n    Cisco_Umbrella_dns_CL\n    | extend \n        EventEndTime=column_ifexists('Timestamp_t', ''),\n        SrcIpAddr=column_ifexists('InternalIp_s', ''),\n        SrcNatIpAddr=column_ifexists('ExternalIp_s', ''),\n        DvcAction=column_ifexists('Action_s', ''),\n        DnsQueryName=column_ifexists('Domain_s', ''),\n        UrlCategory=column_ifexists('Categories_s', ''),\n        ThreatCategory=column_ifexists('Blocked_Categories_s', ''),\n        Identities=column_ifexists('Identities_s', ''),\n        DnsQueryTypeName=column_ifexists('QueryType_s', ''),\n        DnsResponseCodeName=column_ifexists('ResponseCode_s', ''),\n        IdentityTypes=column_ifexists('Identity_Types_s', ''),\n        EventType=column_ifexists('EventType_s', ''),\n        PolicyIdentity=column_ifexists('Policy_Identity_s', ''),\n        PolicyIdentityType=column_ifexists('Policy_Identity_Type_s', '')\n    | project \n        TimeGenerated,\n        EventEndTime,\n        SrcIpAddr,\n        SrcNatIpAddr,\n        DvcAction,\n        DnsQueryName,\n        UrlCategory,\n        ThreatCategory,\n        Identities,\n        DnsQueryTypeName,\n        DnsResponseCodeName,\n        IdentityTypes,\n        EventType,\n        PolicyIdentity,\n        PolicyIdentityType\n};\nlet Cisco_Umbrella_proxy_view = view () { \n    Cisco_Umbrella_proxy_CL\n    | extend \n        EventType=column_ifexists('EventType_s', ''),\n        EventEndTime=column_ifexists('Timestamp_t', ''),\n        Identities=column_ifexists('Identities_s', ''),\n        SrcIpAddr=column_ifexists('Internal_IP_s', ''),\n        SrcNatIpAddr=column_ifexists('External_IP_s', ''),\n        DstIpAddr=column_ifexists('Destination_IP_s', ''),\n        HttpContentType=column_ifexists('Content_Type_s', ''),\n        DvcAction=column_ifexists('Verdict_s', ''),\n        UrlOriginal=column_ifexists('URL_s', ''),\n        HttpReferrerOriginal=column_ifexists('Referer_s', ''),\n        HttpUserAgentOriginal=column_ifexists('userAgent_s', ''),\n        HttpStatusCode=column_ifexists('statusCode_s', ''),\n        SrcBytes=column_ifexists('requestSize_d', ''),\n        DstBytes=column_ifexists('responseSize_d', ''),\n        HttpResponseBodyBytes=column_ifexists('responseBodySize_d', ''),\n        HashSha256=column_ifexists('SHA-SHA256_s', ''),\n        UrlCategory=column_ifexists('Categories_s', ''),\n        AvDetections=column_ifexists('AVDetections_s', ''),\n        Puas=column_ifexists('PUAs_s', ''),\n        AmpDisposition=column_ifexists('AMP_Disposition_s', ''), \n        ThreatName=column_ifexists('AMP_Malware_Name_s', ''),\n        AmpScore=column_ifexists('AMP_Score_s', ''),\n        IdentityType=column_ifexists('Identity_Type_s', ''),\n        ThreatCategory=column_ifexists('Blocked_Categories_s', '')\n    | project\n        TimeGenerated,\n        EventType,\n        EventEndTime,\n        Identities,\n        SrcIpAddr,\n        SrcNatIpAddr,\n        DstIpAddr,\n        HttpContentType,\n        DvcAction,\n        UrlOriginal,\n        HttpReferrerOriginal,\n        HttpUserAgentOriginal,\n        HttpStatusCode,\n        SrcBytes,\n        DstBytes,\n        HttpResponseBodyBytes,\n        HashSha256,\n        UrlCategory,\n        AvDetections,\n        Puas,\n        AmpDisposition,\n        ThreatName,\n        AmpScore,\n        IdentityType,\n        ThreatCategory\n};\nlet Cisco_Umbrella_ip_view = view () { \n    Cisco_Umbrella_ip_CL\n    | extend \n        EventType=column_ifexists('EventType_s', ''),\n        EventEndTime=column_ifexists('Timestamp_t', ''),\n        Identities=column_ifexists('Identity_s', ''),\n        SrcIpAddr=column_ifexists('Source_IP_s', ''),\n        SrcPortNumber=column_ifexists('Source_Port_s', ''),\n        DstIpAddr=column_ifexists('Destination_IP_s', ''),\n        DstPortNumber=column_ifexists('Destination_Port_s', ''),\n        UrlCategory=column_ifexists('Categories_s', '')\n    | project\n        TimeGenerated,\n        EventType,\n        EventEndTime,\n        Identities,\n        SrcIpAddr,\n        SrcPortNumber,\n        DstIpAddr,\n        DstPortNumber,\n        UrlCategory\n};\nlet Cisco_Umbrella_cloudfirewall_view = view () { \n    Cisco_Umbrella_cloudfirewall_CL\n    | extend \n        EventType=column_ifexists('EventType_s', ''),\n        EventEndTime=column_ifexists('Timestamp_t', ''),\n        NetworkSessionId=column_ifexists('originId_s', ''),\n        NetworkRuleName=column_ifexists('Identity_s', ''),\n        IdentityType=column_ifexists('Identity_Type_s', ''),\n        NetworkDirection=column_ifexists('Direction_s', ''),\n        NetworkProtocol=column_ifexists('ipProtocol_s', ''),\n        NetworkPackets=column_ifexists('packetSize_s', ''),\n        SrcIpAddr=column_ifexists('SourceIP', ''),\n        SrcPortNumber=column_ifexists('sourcePort_s', ''),\n        DstIpAddr=column_ifexists('destinationIp_s', ''),\n        DstPortNumber=column_ifexists('destinationPort_s', ''),\n        DvcHostname=column_ifexists('dataCenter_s', ''),\n        NetworkRuleNumber=column_ifexists('ruleId_s', ''),\n        DvcAction=column_ifexists('verdict_s', '')\n    | project\n        TimeGenerated,\n        EventType,\n        EventEndTime,\n        NetworkSessionId,\n        NetworkRuleName,\n        IdentityType,\n        NetworkDirection,\n        NetworkProtocol,\n        NetworkPackets,\n        SrcIpAddr,\n        SrcPortNumber,\n        DstIpAddr,\n        DstPortNumber,\n        DvcHostname,\n        NetworkRuleNumber,\n        DvcAction\n};\nunion isfuzzy=true Cisco_Umbrella_dns_view, Cisco_Umbrella_proxy_view, Cisco_Umbrella_ip_view, Cisco_Umbrella_cloudfirewall_view",
            "version": 1
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco Umbrella Hunting Query 1",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco Umbrella - Anomalous FQDNs for domain",
            "category": "Hunting Queries",
            "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'dnslogs'\n| extend replaced = replace(@'\\.$', @'', DnsQueryName)\n| extend Domain = extract(@'.*\\.(.*\\.[a-z]+)', 1, replaced)\n| extend fqdn = extract(@'(.*)\\..*\\.[a-z]+', 1, replaced)\n| summarize FQDNs = dcount(fqdn) by Domain\n| sort by FQDNs\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Large number of FQDNs for domain may be indicator of suspicious domain."
              },
              {
                "name": "tactics",
                "value": "CommandandControl"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco Umbrella Hunting Query 2",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco Umbrella - 'Blocked' User-Agents.",
            "category": "Hunting Queries",
            "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where DvcAction =~ 'Blocked'\n| summarize count() by HttpUserAgentOriginal\n| sort by count_\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Shows User-Agent values which requests were blocked"
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco Umbrella Hunting Query 3",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco Umbrella - DNS Errors.",
            "category": "Hunting Queries",
            "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'dnslogs'\n| where DnsResponseCodeName != 'NOERROR'\n| extend URLCustomEntity = UrlOriginal\n| extend AccountCustomEntity = Identities\n| extend IPCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Shows error DNS requests."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco Umbrella Hunting Query 4",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco Umbrella - DNS requests to unreliable categories.",
            "category": "Hunting Queries",
            "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'dnslogs'\n| where UrlCategory contains 'Dating' or UrlCategory contains 'Digital Postcards' or UrlCategory contains 'Freeware and Shareware' or UrlCategory contains 'Gambling' or UrlCategory contains  'Hacking' or UrlCategory contains 'Hunting' or UrlCategory contains 'Mobile Phones' or UrlCategory contains 'Software Updates' or UrlCategory contains 'URL Shortener' or UrlCategory contains  'Web Hosting'\n| where DvcAction == 'Allowed'\n| summarize TotalEvents = count() by DnsQueryName, SrcIpAddr\n| sort by TotalEvents\n| summarize listOfIps = make_set(SrcIpAddr) by DnsQueryName\n| extend URLCustomEntity = DnsQueryName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Shows requests to URI categories which heavily are used in Initial Access stage by threat actiors and may contain malicious content."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco Umbrella Hunting Query 5",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco Umbrella - Higher values of count of the Same BytesIn size",
            "category": "Hunting Queries",
            "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize count() by SrcIpAddr,DstIpAddr, SrcBytes\n| sort by count_ desc\n| extend Message = \"Possible communication with C2\"\n| project Message, SrcIpAddr, DstIpAddr\n| extend IpCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Calculate the count of BytesIn per Source-Destination pair over 24 hours. Higher values may indicate beaconing."
              },
              {
                "name": "tactics",
                "value": "CommandandControl"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco Umbrella Hunting Query 6",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco Umbrella - High values of Uploaded Data",
            "category": "Hunting Queries",
            "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize sum(DstBytes) by SrcIpAddr,DstIpAddr\n| sort by sum_DstBytes desc\n| project SrcIpAddr, DstIpAddr\n| extend IpCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "A normal user activity consists mostly of downloading data. Uploaded data is usually small unless there is a file/data upload to a website. Calculate the sum of BytesOut per Source-Destination pair over 12/24 hours."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco Umbrella Hunting Query 7",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco Umbrella - Possible connection to C2.",
            "category": "Hunting Queries",
            "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize count() by SrcIpAddr, DstIpAddr, SrcBytes\n| sort by count_ desc\n| extend Message = \"Possible communication with C2\"\n| extend IPCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Calculate the count of BytesIn per Source-Destination pair over 12/24 hours. Higher values may indicate beaconing. C2 servers reply with the same data, making BytesIn value the same."
              },
              {
                "name": "tactics",
                "value": "CommandandControl"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco Umbrella Hunting Query 8",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco Umbrella - Possible data exfiltration",
            "category": "Hunting Queries",
            "query": "let timeframe = 1d;\nCisco_Umbrella \n| where EventType == \"proxylogs\"\n| where TimeGenerated > ago(timeframe)\n| summarize sum(DstBytes) by SrcIpAddr,DstIpAddr\n| sort by sum_DstBytes desc\n| extend Message = \"Possible data exfiltration\"\n| extend IPCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "A normal user activity consists mostly of downloading data. Uploaded data is usually small unless there is a file/data upload to a website. Calculate the sum of BytesOut per Source-Destination pair over 12/24 hours."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco Umbrella Hunting Query 9",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco Umbrella - Proxy 'Allowed' to unreliable categories.",
            "category": "Hunting Queries",
            "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where EventType == 'proxylogs'\n| where UrlCategory contains 'Dating' or UrlCategory contains 'Digital Postcards' or UrlCategory contains 'Freeware and Shareware' or UrlCategory contains 'Gambling' or UrlCategory contains  'Hacking' or UrlCategory contains 'Hunting' or UrlCategory contains 'Mobile Phones' or UrlCategory contains 'Software Updates' or UrlCategory contains 'URL Shortener' or UrlCategory contains  'Web Hosting'\n| where DvcAction == 'ALLOWED'\n| summarize TotalEvents = count() by UrlOriginal, SrcIpAddr\n| sort by TotalEvents\n| summarize listOfIps = make_set(SrcIpAddr) by UrlOriginal\n| extend URLCustomEntity = UrlOriginal\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Shows allowed requests to URI categories which heavily are used in Initial Access stage by threat actiors and may contain malicious content."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco Umbrella Hunting Query 10",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco Umbrella - Requests to uncategorized resources",
            "category": "Hunting Queries",
            "query": "Cisco_Umbrella\n| where TimeGenerated > ago(24h)\n| where DvcAction =~ 'Allowed'\n| where UrlCategory == ''\n| project UrlOriginal, Identities\n| extend URLCustomEntity = UrlOriginal\n| extend AccountCustomEntity = Identities\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Shows requests to URL where UrlCategory is not set."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        }
      ]
    },
    {
      "type": "Microsoft.Web/customApis",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook1-customApis_CiscoUmbrellaEnforcementAPI_name')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "connectionParameters": {
          "api_key": {
            "type": "securestring",
            "uiDefinition": {
              "displayName": "Cisco Umbrella Enforcement API customerKey",
              "description": "Cisco Umbrella Enforcement API customerKey",
              "tooltip": "Provide your Cisco Umbrella Enforcement API customerKey",
              "constraints": {
                "tabIndex": 2,
                "clearText": false,
                "required": "true"
              }
            }
          }
        },
        "brandColor": "#FFFFFF",
        "description": "Connector for Cisco Umbrella Enforcment API",
        "displayName": "[variables('playbook1-customApis_CiscoUmbrellaEnforcementAPI_name')]",
        "iconUri": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAABICAMAAABiM0N1AAABdFBMVEUAAAAA//8AgP8Aqv8AgL8AmcwAmeYAotEAldUAn98AntsAodkAnNYAn9cIotgIntoHoNsHnNwHodcHndgGotoGoNsGnNYGn9cFn9sEoNgEndkEoNoEntsEntgEoNsEn9gDn9kDoNoDn9gDoNgDn9kFn9gFntgFn9kFn9oFoNoFn9gEn9kEoNkEn9oEoNgEn9kEntkEoNoEoNkEn9kEn9kEntkEoNgEntgEn9kEn9oEntoEn9gEoNgEntkEn9kEoNkEn9oEn9oEntgDn9kDn9gDoNkDn9kFn9oFn9gFn9kFntkFn9oEn9kEntoEn9gEoNkEn9kEoNkEn9oEn9gEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEntkEn9kEn9kEn9kEn9oDn9kFn9kEoNkEn9kEn9kEn9kEn9kEn9oEn9kEn9kEn9kEn9kEoNkEn9kEn9gEn9kEn9kEn9kEn9kEn9kEoNkEn9kEn9kEn9kEn9n///940Z2XAAAAenRSTlMAAQIDBAUKCwwQFRsfICEiIyQmJykrLC04Ozw+P0JGSEpTVVtdaGlqbW5wcnN1dnh5e35/gIGDhIeIiYqLjI2Oj5CRkpibnKSlp6mqsLGys7q7v8DCxMfKz9DS1NXW19jZ2t7g4+To6u3u7/Dx8vP09fb3+Pn6+/z9/h6/P2sAAAABYktHRHtP0rX8AAACB0lEQVRYw+2WaVPTYBRGb9SK4oI7dd+tAiqCra1FqKIoKu4bUFQQtJY2SUna2vPr/VCSafKmpONkHMfJ86m5OXOmN3Pfm4jEiRMnTtQZKadCkfWRHkTrlMKRcg8iIALkvxRlKsM+yq10RTLVW6qohuETuZWuSA1zi7+r/uiKBLb4z4jyxt0wUd5Ih4jyRlps7DCRjRUisrG26khpoOsdIDqR5bRmUvPhTsVFan7EKdjYMq5n2zdHK/5H6lRcJF31IU4hZ2TjNfJHolL4Qi71tLMv/xyOAInzV3LgftE0vjz1zMnRZz/qa28GAgg5PrtmrTw8onqG6oBvPQzqAJxQCe1eC4C68jExBKroOWA2NkUe4rZzwVWvZ78NzGeuZJc6RWW4qCUG+xXicBMac4X3gLXXI5oCHu0QkW2dogpcCCSmYeOkiKSACY+oCN93KofyHbReJgOIJWi/e17DgkdkwJx6uk83AWa2K4QJZ9rLE99rXQ8UyblvADcUwoCzIiJyB6pKa30B+yZx/iMsK0QR8iIi2gdY9IgKwEzC/7BFRPp+saEQD8A6JSLXgYJ3rG1g/mZq4mun6NKx/j2jsKIQh5rQfJF/CzQO9jCQm6VJlRh3B3LMP9rX7G6ihd0qoeXaR6SV05TDtm9y0dQ/z3aKXi1X9U9ju4IIST5ZtVYfJ+NlFydOnKjyG0KNPhWovN8UAAAAAElFTkSuQmCC",
        "backendService": {
          "serviceUrl": "https://s-platform.api.opendns.com"
        },
        "apiType": "Rest",
        "swagger": {
          "swagger": "2.0",
          "info": {
            "title": "CiscoUmbrellaEnforcementAPIConnector",
            "version": "1.0",
            "description": "Connector for Cisco Umbrella Enforcment API"
          },
          "host": "s-platform.api.opendns.com",
          "basePath": "/",
          "schemes": [
            "https"
          ],
          "paths": {
            "/1.0/events": {
              "post": {
                "summary": "Block domains",
                "parameters": [
                  {
                    "name": "Accept",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "body",
                    "in": "body",
                    "schema": {
                      "$ref": "#/definitions/events_array"
                    }
                  }
                ],
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string",
                          "description": "id"
                        }
                      }
                    }
                  }
                },
                "operationId": "[variables('_operationId-BlockDomains')]",
                "description": "Posts a Malware event to the API for processing and optionally adding to a customer's domain lists"
              }
            },
            "/1.0/domains": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "meta": {
                          "type": "object",
                          "properties": {
                            "page": {
                              "type": "integer",
                              "format": "int32",
                              "description": "page"
                            },
                            "limit": {
                              "type": "integer",
                              "format": "int32",
                              "description": "limit"
                            },
                            "prev": {
                              "type": "string",
                              "description": "prev"
                            },
                            "next": {
                              "type": "string",
                              "description": "next"
                            }
                          },
                          "description": "meta"
                        },
                        "data": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "id": {
                                "type": "integer",
                                "format": "int32",
                                "description": "domain id",
                                "title": "id"
                              },
                              "name": {
                                "type": "string",
                                "description": "domain name",
                                "title": "name"
                              }
                            }
                          },
                          "description": "data"
                        }
                      }
                    }
                  }
                },
                "summary": "Get domains",
                "operationId": "[variables('_operationId-GetDomains')]",
                "description": "Get the list of domains added to the shared customer's domain list.",
                "parameters": [
                  {
                    "name": "page",
                    "in": "query",
                    "required": false,
                    "type": "integer",
                    "default": 1
                  },
                  {
                    "name": "limit",
                    "in": "query",
                    "required": false,
                    "type": "integer",
                    "default": 200,
                    "description": "1"
                  }
                ]
              },
              "delete": {
                "responses": {
                  "default": {
                    "description": "default"
                  }
                },
                "summary": "Delete domain by name",
                "description": "Delete a domain from the shared customer's domain list by domain name.",
                "operationId": "[variables('_operationId-DeleteDomainByName')]",
                "parameters": [
                  {
                    "name": "where[name]",
                    "in": "query",
                    "required": true,
                    "type": "string",
                    "x-ms-summary": "Domain name"
                  },
                  {
                    "name": "Content-Type",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  }
                ]
              }
            },
            "/1.0/domains/{DomainId}": {
              "delete": {
                "responses": {
                  "default": {
                    "description": "default"
                  }
                },
                "summary": "Delete domain by id",
                "operationId": "[variables('_operationId-DeleteDomainById')]",
                "parameters": [
                  {
                    "name": "DomainId",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  },
                  {
                    "name": "Content-Type",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  }
                ],
                "description": "Delete a domain from the shared customer's domain list by Id."
              }
            }
          },
          "definitions": {
            "events_array": {
              "type": "array",
              "items": {
                "type": "object",
                "required": [
                  "alertTime",
                  "deviceId",
                  "deviceVersion",
                  "dstDomain",
                  "dstUrl",
                  "eventTime",
                  "protocolVersion",
                  "providerName"
                ],
                "properties": {
                  "alertTime": {
                    "type": "string"
                  },
                  "deviceId": {
                    "type": "string",
                    "title": "deviceId",
                    "x-ms-visibility": "internal",
                    "default": "azuresentinel"
                  },
                  "deviceVersion": {
                    "type": "string",
                    "title": "deviceVersion",
                    "x-ms-visibility": "internal",
                    "default": "13.7a"
                  },
                  "dstDomain": {
                    "type": "string"
                  },
                  "dstUrl": {
                    "type": "string"
                  },
                  "eventTime": {
                    "type": "string"
                  },
                  "protocolVersion": {
                    "type": "string",
                    "default": "1.0a",
                    "title": "protocolVersion",
                    "x-ms-visibility": "internal"
                  },
                  "providerName": {
                    "type": "string",
                    "default": "Security Platform",
                    "title": "providerName",
                    "x-ms-visibility": "internal"
                  }
                }
              }
            }
          },
          "securityDefinitions": {
            "API Key": {
              "type": "apiKey",
              "in": "query",
              "name": "customerKey"
            }
          },
          "security": [
            {}
          ]
        }
      }
    },
    {
      "type": "Microsoft.Web/customApis",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook2-customApis_CiscoUmbrellaInvestigateAPIConnector_name')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "connectionParameters": {
          "api_key": {
            "type": "securestring",
            "uiDefinition": {
              "displayName": "API Key",
              "description": "The API Key for this api",
              "tooltip": "Provide your API Key in format: Bearer YOUR_API_KEY",
              "constraints": {
                "tabIndex": 2,
                "clearText": false,
                "required": "true"
              }
            }
          }
        },
        "brandColor": "#FFFFFF",
        "description": "Connector for Cisco Umbrella Investigate API",
        "displayName": "[variables('playbook2-customApis_CiscoUmbrellaInvestigateAPIConnector_name')]",
        "iconUri": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAABICAMAAABiM0N1AAABdFBMVEUAAAAA//8AgP8Aqv8AgL8AmcwAmeYAotEAldUAn98AntsAodkAnNYAn9cIotgIntoHoNsHnNwHodcHndgGotoGoNsGnNYGn9cFn9sEoNgEndkEoNoEntsEntgEoNsEn9gDn9kDoNoDn9gDoNgDn9kFn9gFntgFn9kFn9oFoNoFn9gEn9kEoNkEn9oEoNgEn9kEntkEoNoEoNkEn9kEn9kEntkEoNgEntgEn9kEn9oEntoEn9gEoNgEntkEn9kEoNkEn9oEn9oEntgDn9kDn9gDoNkDn9kFn9oFn9gFn9kFntkFn9oEn9kEntoEn9gEoNkEn9kEoNkEn9oEn9gEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEntkEn9kEn9kEn9kEn9oDn9kFn9kEoNkEn9kEn9kEn9kEn9kEn9oEn9kEn9kEn9kEn9kEoNkEn9kEn9gEn9kEn9kEn9kEn9kEn9kEoNkEn9kEn9kEn9kEn9n///940Z2XAAAAenRSTlMAAQIDBAUKCwwQFRsfICEiIyQmJykrLC04Ozw+P0JGSEpTVVtdaGlqbW5wcnN1dnh5e35/gIGDhIeIiYqLjI2Oj5CRkpibnKSlp6mqsLGys7q7v8DCxMfKz9DS1NXW19jZ2t7g4+To6u3u7/Dx8vP09fb3+Pn6+/z9/h6/P2sAAAABYktHRHtP0rX8AAACB0lEQVRYw+2WaVPTYBRGb9SK4oI7dd+tAiqCra1FqKIoKu4bUFQQtJY2SUna2vPr/VCSafKmpONkHMfJ86m5OXOmN3Pfm4jEiRMnTtQZKadCkfWRHkTrlMKRcg8iIALkvxRlKsM+yq10RTLVW6qohuETuZWuSA1zi7+r/uiKBLb4z4jyxt0wUd5Ih4jyRlps7DCRjRUisrG26khpoOsdIDqR5bRmUvPhTsVFan7EKdjYMq5n2zdHK/5H6lRcJF31IU4hZ2TjNfJHolL4Qi71tLMv/xyOAInzV3LgftE0vjz1zMnRZz/qa28GAgg5PrtmrTw8onqG6oBvPQzqAJxQCe1eC4C68jExBKroOWA2NkUe4rZzwVWvZ78NzGeuZJc6RWW4qCUG+xXicBMac4X3gLXXI5oCHu0QkW2dogpcCCSmYeOkiKSACY+oCN93KofyHbReJgOIJWi/e17DgkdkwJx6uk83AWa2K4QJZ9rLE99rXQ8UyblvADcUwoCzIiJyB6pKa30B+yZx/iMsK0QR8iIi2gdY9IgKwEzC/7BFRPp+saEQD8A6JSLXgYJ3rG1g/mZq4mun6NKx/j2jsKIQh5rQfJF/CzQO9jCQm6VJlRh3B3LMP9rX7G6ihd0qoeXaR6SV05TDtm9y0dQ/z3aKXi1X9U9ju4IIST5ZtVYfJ+NlFydOnKjyG0KNPhWovN8UAAAAAElFTkSuQmCC",
        "backendService": {
          "serviceUrl": "https://investigate.api.umbrella.com"
        },
        "apiType": "Rest",
        "swagger": {
          "swagger": "2.0",
          "info": {
            "title": "Default title",
            "description": "Connector for Cisco Umbrella Investigate API",
            "version": "1.0"
          },
          "host": "investigate.api.umbrella.com",
          "basePath": "/",
          "schemes": [
            "https"
          ],
          "paths": {
            "/security/name/{Domain}": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "dga_score": {
                          "type": "integer",
                          "format": "int32",
                          "description": "Domain Generation Algorithm. This score is generated based on the likeliness of the domain name being generated by an algorithm rather than a human. This algorithm is designed to identify domains which have been created using an automated randomization strategy, which is a common evasion technique in malware kits or botnets. This score ranges from -100 (suspicious) to 0 (benign)."
                        },
                        "perplexity": {
                          "type": "number",
                          "format": "float",
                          "description": "A second score on the likeliness of the name to be algorithmically generated, on a scale from 0 to 100. This score is to be used in conjunction with DGA."
                        },
                        "entropy": {
                          "type": "number",
                          "format": "float",
                          "description": "The number of bits required to encode the domain name, as a score. This score is to be used in conjunction with DGA and Perplexity."
                        },
                        "securerank2": {
                          "type": "number",
                          "format": "float",
                          "description": "Suspicious rank for a domain that reviews based on the lookup behavior of client IP for the domain. Securerank is designed to identify hostnames requested by known infected clients but never requested by clean clients, assuming these domains are more likely to be bad. Scores returned range from -100 (suspicious) to 100 (benign)."
                        },
                        "pagerank": {
                          "type": "number",
                          "format": "float",
                          "description": "Popularity according to Google's pagerank algorithm"
                        },
                        "asn_score": {
                          "type": "number",
                          "format": "float",
                          "description": "ASN reputation score, ranges from -100 to 0 with -100 being very suspicious."
                        },
                        "prefix_score": {
                          "type": "number",
                          "format": "float",
                          "description": "Prefix ranks domains given their IP prefixes (an IP prefix is the first three octets in an IP address) and the reputation score of these prefixes. Ranges from -100 to 0, -100 being very suspicious."
                        },
                        "rip_score": {
                          "type": "number",
                          "format": "float",
                          "description": "RIP ranks domains given their IP addresses and the reputation score of these IP addresses. Ranges from -100 to 0, -100 being very suspicious."
                        },
                        "popularity": {
                          "type": "integer",
                          "format": "int32",
                          "description": "The number of unique client IPs visiting this site, relative to the all requests to all sites. A score of how many different client/unique IPs go to this domain compared to others."
                        },
                        "fastflux": {
                          "type": "boolean",
                          "description": "fastflux",
                          "x-ms-visibility": "internal"
                        },
                        "geodiversity": {
                          "type": "array",
                          "description": "array of geodiversity tuples",
                          "x-ms-summary": "geodiversity array",
                          "items": {
                            "x-ms-summary": "geodiversity tuple",
                            "description": "Tuple [\"country code\", \"score\"]. A score representing the number of queries from clients visiting the domain, broken down by country. Score is a non-normalized ratio between 0 and 1.",
                            "type": "array"
                          }
                        },
                        "geodiversity_normalized": {
                          "type": "array",
                          "description": "array of geodiversity_normalized tuples",
                          "x-ms-summary": "geodiversity_normalized array",
                          "items": {
                            "x-ms-summary": "geodiversity_normalized tuple",
                            "description": "Tuple [\"country code\", \"score\"]. A score representing the amount of queries for clients visiting the domain, broken down by country. Score is a normalized ratio between 0 and 1.",
                            "type": "array"
                          }
                        },
                        "tld_geodiversity": {
                          "type": "array",
                          "description": "array of tld_geodiversity tuples",
                          "x-ms-summary": "tld_geodiversity array",
                          "items": {
                            "x-ms-summary": "tld_geodiversity tuple",
                            "description": "Tuple [\"country code\", \"score\"]. A score that represents the TLD country code geodiversity as a percentage of clients visiting the domain. Occurs most often with domains that have a ccTLD. Score is normalized ratio between 0 and 1.",
                            "type": "array"
                          }
                        },
                        "geoscore": {
                          "type": "integer",
                          "format": "int32",
                          "description": "A score that represents how far the different physical locations serving this name are from each other."
                        },
                        "ks_test": {
                          "type": "integer",
                          "format": "int32",
                          "description": "Kolmogorov-Smirnov test on geodiversity. 0 means that the client traffic matches what is expected for this TLD."
                        },
                        "attack": {
                          "type": "string",
                          "description": "The name of any known attacks associated with this domain. Returns blank if no known threat associated with domain."
                        },
                        "threat_type": {
                          "type": "string",
                          "description": "The type of the known attack, such as botnet or APT. Returns blank if no known threat associated with domain."
                        },
                        "found": {
                          "type": "boolean",
                          "description": "Returns true if results available. Returns blank if no known threat associated with domain."
                        }
                      }
                    }
                  }
                },
                "summary": "Get domain security data",
                "description": "Security Information for a Domain",
                "operationId": "[variables('_operationId-GetDomainSecurityData')]",
                "parameters": [
                  {
                    "name": "Domain",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  }
                ]
              }
            },
            "/domains/risk-score/{DomainName}": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "indicators": {
                          "type": "array",
                          "x-ms-summary": "indicators",
                          "description": "array of indicator objects",
                          "items": {
                            "x-ms-summary": "indicator",
                            "description": "indicator object",
                            "type": "object",
                            "properties": {
                              "indicator": {
                                "type": "string",
                                "description": "indicator name",
                                "title": "name"
                              },
                              "normalized_score": {
                                "type": "integer",
                                "format": "int32",
                                "description": "indicator normalized score"
                              },
                              "score": {
                                "type": "boolean",
                                "description": "indicator score"
                              }
                            }
                          }
                        },
                        "risk_score": {
                          "type": "integer",
                          "format": "int32",
                          "description": "risk score"
                        }
                      }
                    }
                  }
                },
                "summary": "Get Risk score for a domain",
                "description": "Get Risk score for a domain",
                "operationId": "[variables('_operationId-GetDomainRiskScore')]",
                "parameters": [
                  {
                    "name": "DomainName",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  }
                ]
              }
            },
            "/domains/categorization/{Domain}": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "additionalProperties": {
                        "type": "object",
                        "description": "Domain object",
                        "title": "Domain object",
                        "x-ms-summary": "Domain object",
                        "properties": {
                          "status": {
                            "type": "integer",
                            "format": "int32",
                            "description": "The status will be \"-1\" if the domain is believed to be malicious, \"1\" if the domain is believed to be benign, \"0\" if it hasn't been classified yet."
                          },
                          "security_categories": {
                            "type": "array",
                            "items": {
                              "type": "string"
                            },
                            "description": "The Umbrella security category, or categories, that match this domain or that this domain is associated with. If none match, the return will be blank."
                          },
                          "content_categories": {
                            "type": "array",
                            "items": {
                              "type": "string"
                            },
                            "description": "The Umbrella content category or categories that match this domain. If none match, the return will be blank."
                          }
                        }
                      }
                    }
                  }
                },
                "summary": "Get Domain Status and Categorization",
                "description": "Get Domain Status and Categorization",
                "operationId": "[variables('_operationId-GetDomainStatusAndCategorization')]",
                "parameters": [
                  {
                    "name": "Domain",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  },
                  {
                    "name": "showLabels",
                    "in": "query",
                    "required": true,
                    "type": "string",
                    "default": 1,
                    "x-ms-visibility": "internal"
                  }
                ]
              }
            },
            "/recommendations/name/{Domain}": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "pfs2": {
                          "type": "array",
                          "x-ms-summary": "pfs2 array",
                          "description": "Array of [domain name, scores] tuples. The values range between 0 and 1 and should not exceed 1. All co-occurences of requests from client IPs are returned for the previous seven days whether the co-occurence is suspicious or not.",
                          "items": {
                            "x-ms-summary": "pfs2 tuple",
                            "description": "[domain name, scores] tuple. The values range between 0 and 1 and should not exceed 1. All co-occurences of requests from client IPs are returned for the previous seven days whether the co-occurence is suspicious or not.",
                            "type": "array"
                          }
                        },
                        "found": {
                          "type": "boolean",
                          "description": "Returns true if results available. Nothing is returned if no results available."
                        }
                      }
                    }
                  }
                },
                "summary": "Get Co-Occurrences for a Domain",
                "description": "Get Co-Occurrences for a Domain",
                "operationId": "[variables('_operationId-GetCoOccurrencesForDomain')]",
                "parameters": [
                  {
                    "name": "Domain",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  }
                ]
              }
            },
            "/links/name/{Domain}": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "tb1": {
                          "type": "array",
                          "x-ms-summary": "tb1 array",
                          "description": "Array of [domain name, scores] tuples where score is the number of client IP requests to the site around the same time as the site being looked up. This is a score reflecting the number of client IPs looking up related sites within 60 seconds of the original request.",
                          "items": {
                            "x-ms-summary": "tb1 tuple",
                            "description": "[domain name, scores] tuples where score is the number of client IP requests to the site around the same time as the site being looked up. This is a score reflecting the number of client IPs looking up related sites within 60 seconds of the original request.",
                            "type": "array"
                          }
                        },
                        "found": {
                          "type": "boolean",
                          "description": "Returns true if results available. Nothing is returned if no results available."
                        }
                      }
                    }
                  }
                },
                "summary": "Get a list of domain names requested the same time as a specified domain",
                "description": "Get a list of domain names requested the same time as a specified domain",
                "operationId": "[variables('_operationId-GetRelatedDomains')]",
                "parameters": [
                  {
                    "name": "Domain",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  }
                ]
              }
            }
          },
          "securityDefinitions": {
            "API Key": {
              "type": "apiKey",
              "in": "header",
              "name": "Authorization"
            }
          },
          "security": [
            {}
          ]
        }
      }
    },
    {
      "type": "Microsoft.Web/customApis",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook3-customApis_CiscoUmbrellaManagementAPI_name')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "connectionParameters": {
          "username": {
            "type": "securestring",
            "uiDefinition": {
              "displayName": "Key",
              "description": "The Key for this api",
              "tooltip": "Provide the Key",
              "constraints": {
                "tabIndex": 2,
                "clearText": true,
                "required": "true"
              }
            }
          },
          "password": {
            "type": "securestring",
            "uiDefinition": {
              "displayName": "Secret",
              "description": "The Secret for this api",
              "tooltip": "Provide the Secret",
              "constraints": {
                "tabIndex": 3,
                "clearText": false,
                "required": "true"
              }
            }
          }
        },
        "brandColor": "#FFFFFF",
        "description": "Connector for Cisco Umbrella Management API",
        "displayName": "[variables('playbook3-customApis_CiscoUmbrellaManagementAPI_name')]",
        "iconUri": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAABICAMAAABiM0N1AAABdFBMVEUAAAAA//8AgP8Aqv8AgL8AmcwAmeYAotEAldUAn98AntsAodkAnNYAn9cIotgIntoHoNsHnNwHodcHndgGotoGoNsGnNYGn9cFn9sEoNgEndkEoNoEntsEntgEoNsEn9gDn9kDoNoDn9gDoNgDn9kFn9gFntgFn9kFn9oFoNoFn9gEn9kEoNkEn9oEoNgEn9kEntkEoNoEoNkEn9kEn9kEntkEoNgEntgEn9kEn9oEntoEn9gEoNgEntkEn9kEoNkEn9oEn9oEntgDn9kDn9gDoNkDn9kFn9oFn9gFn9kFntkFn9oEn9kEntoEn9gEoNkEn9kEoNkEn9oEn9gEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEntkEn9kEn9kEn9kEn9oDn9kFn9kEoNkEn9kEn9kEn9kEn9kEn9oEn9kEn9kEn9kEn9kEoNkEn9kEn9gEn9kEn9kEn9kEn9kEn9kEoNkEn9kEn9kEn9kEn9n///940Z2XAAAAenRSTlMAAQIDBAUKCwwQFRsfICEiIyQmJykrLC04Ozw+P0JGSEpTVVtdaGlqbW5wcnN1dnh5e35/gIGDhIeIiYqLjI2Oj5CRkpibnKSlp6mqsLGys7q7v8DCxMfKz9DS1NXW19jZ2t7g4+To6u3u7/Dx8vP09fb3+Pn6+/z9/h6/P2sAAAABYktHRHtP0rX8AAACB0lEQVRYw+2WaVPTYBRGb9SK4oI7dd+tAiqCra1FqKIoKu4bUFQQtJY2SUna2vPr/VCSafKmpONkHMfJ86m5OXOmN3Pfm4jEiRMnTtQZKadCkfWRHkTrlMKRcg8iIALkvxRlKsM+yq10RTLVW6qohuETuZWuSA1zi7+r/uiKBLb4z4jyxt0wUd5Ih4jyRlps7DCRjRUisrG26khpoOsdIDqR5bRmUvPhTsVFan7EKdjYMq5n2zdHK/5H6lRcJF31IU4hZ2TjNfJHolL4Qi71tLMv/xyOAInzV3LgftE0vjz1zMnRZz/qa28GAgg5PrtmrTw8onqG6oBvPQzqAJxQCe1eC4C68jExBKroOWA2NkUe4rZzwVWvZ78NzGeuZJc6RWW4qCUG+xXicBMac4X3gLXXI5oCHu0QkW2dogpcCCSmYeOkiKSACY+oCN93KofyHbReJgOIJWi/e17DgkdkwJx6uk83AWa2K4QJZ9rLE99rXQ8UyblvADcUwoCzIiJyB6pKa30B+yZx/iMsK0QR8iIi2gdY9IgKwEzC/7BFRPp+saEQD8A6JSLXgYJ3rG1g/mZq4mun6NKx/j2jsKIQh5rQfJF/CzQO9jCQm6VJlRh3B3LMP9rX7G6ihd0qoeXaR6SV05TDtm9y0dQ/z3aKXi1X9U9ju4IIST5ZtVYfJ+NlFydOnKjyG0KNPhWovN8UAAAAAElFTkSuQmCC",
        "backendService": {
          "serviceUrl": "https://management.api.umbrella.com"
        },
        "apiType": "Rest",
        "swagger": {
          "swagger": "2.0",
          "info": {
            "title": "Default title",
            "description": "Connector for Cisco Umbrella Management API",
            "version": "1.0"
          },
          "host": "management.api.umbrella.com",
          "basePath": "/",
          "schemes": [
            "https"
          ],
          "paths": {
            "/v1/organizations/{organizationId}/destinationlists": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "status": {
                          "type": "object",
                          "x-ms-summary": "Response status",
                          "x-ms-visibility": "internal",
                          "description": "Response status object",
                          "properties": {
                            "code": {
                              "type": "integer",
                              "format": "int32",
                              "description": "code"
                            },
                            "text": {
                              "type": "string",
                              "description": "text"
                            }
                          }
                        },
                        "meta": {
                          "type": "object",
                          "x-ms-visibility": "internal",
                          "properties": {
                            "page": {
                              "type": "integer",
                              "format": "int32",
                              "description": "page"
                            },
                            "limit": {
                              "type": "integer",
                              "format": "int32",
                              "description": "limit"
                            },
                            "total": {
                              "type": "integer",
                              "format": "int32",
                              "description": "total"
                            }
                          },
                          "description": "meta"
                        },
                        "data": {
                          "x-ms-summary": "Array of Destionation list objects",
                          "description": "Array of Destionation list objects",
                          "type": "array",
                          "items": {
                            "type": "object",
                            "x-ms-summary": "Destionation list",
                            "description": "Destionation list object",
                            "properties": {
                              "id": {
                                "type": "integer",
                                "format": "int32",
                                "description": "Unique id of the destination list."
                              },
                              "organizationId": {
                                "type": "integer",
                                "format": "int32",
                                "description": "organizationId"
                              },
                              "access": {
                                "type": "string",
                                "description": "Access can be allow or block. It defines destinationlist type."
                              },
                              "isGlobal": {
                                "type": "boolean",
                                "description": "isGlobal can be true or false. There will be only one default destination list of type allow or block for an organization."
                              },
                              "name": {
                                "type": "string",
                                "description": "Name of the destination list."
                              },
                              "thirdpartyCategoryId": {
                                "type": "string",
                                "description": "Destionation list thirdpartyCategoryId"
                              },
                              "createdAt": {
                                "type": "string",
                                "description": "Creation date."
                              },
                              "modifiedAt": {
                                "type": "string",
                                "description": "Last modified date."
                              },
                              "isMspDefault": {
                                "type": "boolean",
                                "description": "Destionation list isMspDefault"
                              },
                              "markedForDeletion": {
                                "type": "boolean",
                                "description": "Destionation list markedForDeletion"
                              },
                              "bundleTypeId": {
                                "type": "integer",
                                "format": "int32",
                                "description": "Destionation list bundleTypeId"
                              },
                              "meta": {
                                "type": "object",
                                "description": "Destionation list meta info object",
                                "properties": {
                                  "destinationCount": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "Total number of destinations in a destination list."
                                  },
                                  "domainCount": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "Total number of domains in a destination list. Domains are part of total destinations in a destination lists."
                                  },
                                  "urlCount": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "Total number of Urls in a destination list. Urls are part of total destinations in a destination lists."
                                  },
                                  "ipv4Count": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "Total number of Ip's in a destination list. Ip's are part of total destinations in a destination lists."
                                  },
                                  "applicationCount": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "Total number of applications in a destination list."
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "summary": "Retrieve all destination lists",
                "operationId": "[variables('_operationId-RetrieveAllDestinationLists')]",
                "description": "Retrieve all destination lists of organization",
                "parameters": [
                  {
                    "name": "organizationId",
                    "in": "path",
                    "required": true,
                    "type": "integer",
                    "description": "3",
                    "format": "int32"
                  }
                ]
              },
              "post": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "integer",
                          "format": "int32",
                          "description": "Unique id of the destination list."
                        },
                        "organizationId": {
                          "type": "integer",
                          "format": "int32",
                          "description": "organizationId"
                        },
                        "access": {
                          "type": "string",
                          "description": "Access can be allow or block. It defines destinationlist type."
                        },
                        "isGlobal": {
                          "type": "boolean",
                          "description": "isGlobal can be true or false. There will be only one default destination list of type allow or block for an organization."
                        },
                        "name": {
                          "type": "string",
                          "description": "Name of the destination list."
                        },
                        "thirdpartyCategoryId": {
                          "type": "string",
                          "description": "Destionation list thirdpartyCategoryId"
                        },
                        "createdAt": {
                          "type": "string",
                          "description": "Creation date."
                        },
                        "modifiedAt": {
                          "type": "string",
                          "description": "Last modified date."
                        },
                        "isMspDefault": {
                          "type": "boolean",
                          "description": "Destionation list isMspDefault"
                        },
                        "markedForDeletion": {
                          "type": "boolean",
                          "description": "Destionation list markedForDeletion"
                        },
                        "bundleTypeId": {
                          "type": "integer",
                          "format": "int32",
                          "description": "Destionation list bundleTypeId"
                        },
                        "meta": {
                          "type": "object",
                          "description": "Destionation list meta info object",
                          "properties": {
                            "destinationCount": {
                              "type": "integer",
                              "format": "int32",
                              "description": "Total number of destinations in a destination list."
                            },
                            "domainCount": {
                              "type": "integer",
                              "format": "int32",
                              "description": "Total number of domains in a destination list. Domains are part of total destinations in a destination lists."
                            },
                            "urlCount": {
                              "type": "integer",
                              "format": "int32",
                              "description": "Total number of Urls in a destination list. Urls are part of total destinations in a destination lists."
                            },
                            "ipv4Count": {
                              "type": "integer",
                              "format": "int32",
                              "description": "Total number of Ip's in a destination list. Ip's are part of total destinations in a destination lists."
                            },
                            "applicationCount": {
                              "type": "integer",
                              "format": "int32",
                              "description": "Total number of applications in a destination list."
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "summary": "Create destination list",
                "operationId": "[variables('_operationId-CreateDestinationList')]",
                "description": "Create destination list",
                "parameters": [
                  {
                    "name": "organizationId",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  },
                  {
                    "name": "body",
                    "in": "body",
                    "required": true,
                    "schema": {
                      "type": "object",
                      "properties": {
                        "destinations": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "type": {
                                "type": "string",
                                "description": "Type can be DOMAIN, URL, IPV4",
                                "title": "type",
                                "enum": [
                                  "DOMAIN",
                                  "URL",
                                  "IPV4"
                                ]
                              },
                              "destination": {
                                "type": "string",
                                "description": "Destination can be domain, url, ip",
                                "title": "destination"
                              },
                              "comment": {
                                "type": "string",
                                "description": "3",
                                "title": "comment"
                              }
                            },
                            "required": [
                              "destination",
                              "type"
                            ]
                          },
                          "description": "destinations"
                        },
                        "access": {
                          "type": "string",
                          "description": "Access can be allow or block. It defines destinationlist type.",
                          "title": "access",
                          "enum": [
                            "allow",
                            "block"
                          ]
                        },
                        "isGlobal": {
                          "type": "boolean",
                          "description": "isGlobal can be true or false. There will be only one default destination list of type allow or block for an organization.",
                          "title": "isGlobal",
                          "enum": [
                            "3",
                            true,
                            false
                          ]
                        },
                        "name": {
                          "type": "string",
                          "description": "3",
                          "title": "name"
                        }
                      },
                      "required": [
                        "access",
                        "destinations",
                        "isGlobal",
                        "name"
                      ]
                    }
                  }
                ]
              }
            },
            "/v1/organizations/{organizationId}/destinationlists/{destinationListId}": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "status": {
                          "type": "object",
                          "x-ms-summary": "Response status",
                          "x-ms-visibility": "internal",
                          "description": "Response status object",
                          "properties": {
                            "code": {
                              "type": "integer",
                              "format": "int32",
                              "description": "code"
                            },
                            "text": {
                              "type": "string",
                              "description": "text"
                            }
                          }
                        },
                        "data": {
                          "type": "object",
                          "x-ms-summary": "Destionation list",
                          "description": "Destionation list object",
                          "properties": {
                            "id": {
                              "type": "integer",
                              "format": "int32",
                              "description": "Unique id of the destination list."
                            },
                            "organizationId": {
                              "type": "integer",
                              "format": "int32",
                              "description": "organizationId"
                            },
                            "access": {
                              "type": "string",
                              "description": "Access can be allow or block. It defines destinationlist type."
                            },
                            "isGlobal": {
                              "type": "boolean",
                              "description": "isGlobal can be true or false. There will be only one default destination list of type allow or block for an organization."
                            },
                            "name": {
                              "type": "string",
                              "description": "Name of the destination list."
                            },
                            "thirdpartyCategoryId": {
                              "type": "string",
                              "description": "Destionation list thirdpartyCategoryId"
                            },
                            "createdAt": {
                              "type": "string",
                              "description": "Creation date."
                            },
                            "modifiedAt": {
                              "type": "string",
                              "description": "Last modified date."
                            },
                            "isMspDefault": {
                              "type": "boolean",
                              "description": "Destionation list isMspDefault"
                            },
                            "markedForDeletion": {
                              "type": "boolean",
                              "description": "Destionation list markedForDeletion"
                            },
                            "bundleTypeId": {
                              "type": "integer",
                              "format": "int32",
                              "description": "Destionation list bundleTypeId"
                            },
                            "meta": {
                              "type": "object",
                              "description": "Destionation list meta info object",
                              "properties": {
                                "destinationCount": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "Total number of destinations in a destination list."
                                },
                                "domainCount": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "Total number of domains in a destination list. Domains are part of total destinations in a destination lists."
                                },
                                "urlCount": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "Total number of Urls in a destination list. Urls are part of total destinations in a destination lists."
                                },
                                "ipv4Count": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "Total number of Ip's in a destination list. Ip's are part of total destinations in a destination lists."
                                },
                                "applicationCount": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "Total number of applications in a destination list."
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "summary": "Get a destination list",
                "operationId": "[variables('_operationId-GetDestinationList')]",
                "description": "Get a destination list by id",
                "parameters": [
                  {
                    "name": "organizationId",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  },
                  {
                    "name": "destinationListId",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  }
                ]
              }
            },
            "/v1/organizations/{organizationId}/destinationlists/{destinationListId}/destinations": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "status": {
                          "x-ms-visibility": "internal",
                          "type": "object",
                          "properties": {
                            "code": {
                              "type": "integer",
                              "format": "int32",
                              "description": "code"
                            },
                            "text": {
                              "type": "string",
                              "description": "text"
                            }
                          },
                          "description": "status"
                        },
                        "meta": {
                          "type": "object",
                          "x-ms-visibility": "internal",
                          "properties": {
                            "page": {
                              "type": "integer",
                              "format": "int32",
                              "description": "page"
                            },
                            "limit": {
                              "type": "integer",
                              "format": "int32",
                              "description": "limit"
                            },
                            "total": {
                              "type": "integer",
                              "format": "int32",
                              "description": "total"
                            }
                          },
                          "description": "meta"
                        },
                        "data": {
                          "type": "array",
                          "x-ms-summary": "Destinations",
                          "description": "array of Destination objects",
                          "items": {
                            "type": "object",
                            "x-ms-summary": "Destination",
                            "description": "Destination object",
                            "properties": {
                              "id": {
                                "type": "string",
                                "description": "Unique id of the destination"
                              },
                              "destination": {
                                "type": "string",
                                "x-ms-summary": "value",
                                "description": "Destination value"
                              },
                              "type": {
                                "type": "string",
                                "description": "Type can be DOMAIN, URL, IPV4"
                              },
                              "comment": {
                                "type": "string",
                                "description": "Destination comment"
                              },
                              "createdAt": {
                                "type": "string",
                                "description": "Creation date of destination"
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "summary": "Get list of destinations related to destination list",
                "operationId": "[variables('_operationId-GetDestinationsList')]",
                "parameters": [
                  {
                    "name": "organizationId",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  },
                  {
                    "name": "destinationListId",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  }
                ],
                "description": "Get list of destinations related to destination list"
              },
              "post": {
                "responses": {
                  "default": {
                    "description": "default"
                  }
                },
                "summary": "Add list of destinations to destination list",
                "description": "Add list of destinations to destination list",
                "operationId": "[variables('_operationId-AddDestinations')]",
                "parameters": [
                  {
                    "name": "organizationId",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  },
                  {
                    "name": "destinationListId",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  },
                  {
                    "name": "body",
                    "in": "body",
                    "required": true,
                    "schema": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "destination": {
                            "type": "string",
                            "description": "name of the destination",
                            "title": "destination"
                          },
                          "comment": {
                            "type": "string",
                            "description": "comment for destination",
                            "title": "comment"
                          }
                        },
                        "required": [
                          "destination"
                        ]
                      },
                      "required": [
                        "items"
                      ]
                    }
                  }
                ]
              }
            },
            "/v1/organizations/{organizationId}/destinationlists/{destinationListId}/destinations/remove": {
              "delete": {
                "responses": {
                  "default": {
                    "description": "default"
                  }
                },
                "summary": "Delete list of destinations from destination list",
                "operationId": "[variables('_operationId-DeleteDestinations')]",
                "parameters": [
                  {
                    "name": "organizationId",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  },
                  {
                    "name": "destinationListId",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  },
                  {
                    "name": "body",
                    "in": "body",
                    "required": true,
                    "schema": {
                      "type": "array",
                      "items": {
                        "type": "integer",
                        "format": "int32",
                        "description": "Destination id"
                      }
                    }
                  }
                ],
                "description": "Delete list of destinations from destination list"
              }
            }
          },
          "securityDefinitions": {
            "basic_auth": {
              "type": "basic"
            }
          },
          "security": [
            {}
          ]
        }
      }
    },
    {
      "type": "Microsoft.Web/customApis",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook4-customApis_CiscoUmbrellaNetworkDeviceManagementAPI_name')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "connectionParameters": {
          "username": {
            "type": "securestring",
            "uiDefinition": {
              "displayName": "Key",
              "description": "The Key for this api",
              "tooltip": "Provide the Key",
              "constraints": {
                "tabIndex": 2,
                "clearText": true,
                "required": "true"
              }
            }
          },
          "password": {
            "type": "securestring",
            "uiDefinition": {
              "displayName": "Secret",
              "description": "The Secret for this api",
              "tooltip": "Provide the Secret",
              "constraints": {
                "tabIndex": 3,
                "clearText": false,
                "required": "true"
              }
            }
          }
        },
        "brandColor": "#FFFFFF",
        "description": "Connector for Cisco Umbrella Network Device Management API",
        "displayName": "[variables('playbook4-customApis_CiscoUmbrellaNetworkDeviceManagementAPI_name')]",
        "iconUri": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAABICAMAAABiM0N1AAABdFBMVEUAAAAA//8AgP8Aqv8AgL8AmcwAmeYAotEAldUAn98AntsAodkAnNYAn9cIotgIntoHoNsHnNwHodcHndgGotoGoNsGnNYGn9cFn9sEoNgEndkEoNoEntsEntgEoNsEn9gDn9kDoNoDn9gDoNgDn9kFn9gFntgFn9kFn9oFoNoFn9gEn9kEoNkEn9oEoNgEn9kEntkEoNoEoNkEn9kEn9kEntkEoNgEntgEn9kEn9oEntoEn9gEoNgEntkEn9kEoNkEn9oEn9oEntgDn9kDn9gDoNkDn9kFn9oFn9gFn9kFntkFn9oEn9kEntoEn9gEoNkEn9kEoNkEn9oEn9gEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEntkEn9kEn9kEn9kEn9oDn9kFn9kEoNkEn9kEn9kEn9kEn9kEn9oEn9kEn9kEn9kEn9kEoNkEn9kEn9gEn9kEn9kEn9kEn9kEn9kEoNkEn9kEn9kEn9kEn9n///940Z2XAAAAenRSTlMAAQIDBAUKCwwQFRsfICEiIyQmJykrLC04Ozw+P0JGSEpTVVtdaGlqbW5wcnN1dnh5e35/gIGDhIeIiYqLjI2Oj5CRkpibnKSlp6mqsLGys7q7v8DCxMfKz9DS1NXW19jZ2t7g4+To6u3u7/Dx8vP09fb3+Pn6+/z9/h6/P2sAAAABYktHRHtP0rX8AAACB0lEQVRYw+2WaVPTYBRGb9SK4oI7dd+tAiqCra1FqKIoKu4bUFQQtJY2SUna2vPr/VCSafKmpONkHMfJ86m5OXOmN3Pfm4jEiRMnTtQZKadCkfWRHkTrlMKRcg8iIALkvxRlKsM+yq10RTLVW6qohuETuZWuSA1zi7+r/uiKBLb4z4jyxt0wUd5Ih4jyRlps7DCRjRUisrG26khpoOsdIDqR5bRmUvPhTsVFan7EKdjYMq5n2zdHK/5H6lRcJF31IU4hZ2TjNfJHolL4Qi71tLMv/xyOAInzV3LgftE0vjz1zMnRZz/qa28GAgg5PrtmrTw8onqG6oBvPQzqAJxQCe1eC4C68jExBKroOWA2NkUe4rZzwVWvZ78NzGeuZJc6RWW4qCUG+xXicBMac4X3gLXXI5oCHu0QkW2dogpcCCSmYeOkiKSACY+oCN93KofyHbReJgOIJWi/e17DgkdkwJx6uk83AWa2K4QJZ9rLE99rXQ8UyblvADcUwoCzIiJyB6pKa30B+yZx/iMsK0QR8iIi2gdY9IgKwEzC/7BFRPp+saEQD8A6JSLXgYJ3rG1g/mZq4mun6NKx/j2jsKIQh5rQfJF/CzQO9jCQm6VJlRh3B3LMP9rX7G6ihd0qoeXaR6SV05TDtm9y0dQ/z3aKXi1X9U9ju4IIST5ZtVYfJ+NlFydOnKjyG0KNPhWovN8UAAAAAElFTkSuQmCC",
        "backendService": {
          "serviceUrl": "https://management.api.umbrella.com"
        },
        "apiType": "Rest",
        "swagger": {
          "swagger": "2.0",
          "info": {
            "title": "CiscoUmbrellaNetworkDeviceManagementAPIConnector",
            "version": "1.0",
            "description": "Connector for Cisco Umbrella Network Device Management API"
          },
          "host": "management.api.umbrella.com",
          "basePath": "/",
          "schemes": [
            "https"
          ],
          "paths": {
            "/v1/organizations": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "x-ms-summary": "Organization",
                        "description": "Organization object",
                        "properties": {
                          "organizationId": {
                            "type": "integer",
                            "format": "int32",
                            "description": "Organization Id",
                            "title": "Id"
                          },
                          "name": {
                            "type": "string",
                            "description": "Organization name",
                            "title": "name"
                          }
                        }
                      }
                    }
                  }
                },
                "summary": "Get organization id",
                "description": "Get organization id",
                "operationId": "[variables('_operationId-GetOrganizationId')]",
				"parameters": []								
              }
            },
            "/v1/organizations/{organizationId}/networkdevices/{originId}/policies": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "x-ms-summary": "Policy",
                        "description": "Policy object",
                        "properties": {
                          "policyId": {
                            "type": "integer",
                            "format": "int32",
                            "description": "Policy Id",
                            "title": "Id"
                          },
                          "name": {
                            "type": "string",
                            "description": "Policy name",
                            "title": "name"
                          },
                          "priority": {
                            "type": "integer",
                            "format": "int32",
                            "description": "Policy priority"
                          },
                          "isAppliedDirectly": {
                            "type": "boolean",
                            "description": "Policy is Applied Directly"
                          },
                          "isDefault": {
                            "type": "boolean",
                            "description": "Policy is Default"
                          },
                          "createdAt": {
                            "type": "string",
                            "description": "Policy creation date"
                          }
                        }
                      }
                    }
                  }
                },
                "summary": "List all policies of a network device",
                "description": "List all policies of a network device",
                "operationId": "[variables('_operationId-ListAllPoliciesOnDevice')]",
                "parameters": [
                  {
                    "name": "organizationId",
                    "in": "path",
                    "required": true,
                    "type": "string",
                    "description": "Organization Id"
                  },
                  {
                    "name": "originId",
                    "in": "path",
                    "required": true,
                    "type": "string",
                    "description": "Device Id"
                  }
                ]
              }
            },
            "/v1/organizations/{organizationId}/policies/{policyId}/identities/{originId}": {
              "delete": {
                "responses": {
                  "default": {
                    "description": "default"
                  }
                },
                "summary": "Delete an identity from a policy",
                "description": "Delete an identity from a policy",
                "operationId": "[variables('_operationId-DeleteIdentityFromPolicy')]",
                "parameters": [
                  {
                    "name": "organizationId",
                    "in": "path",
                    "required": true,
                    "type": "string",
                    "description": "Organization Id"
                  },
                  {
                    "name": "policyId",
                    "in": "path",
                    "required": true,
                    "type": "string",
                    "description": "Policy Id"
                  },
                  {
                    "name": "originId",
                    "in": "path",
                    "required": true,
                    "type": "string",
                    "description": "Identity Id"
                  }
                ]
              },
              "put": {
                "responses": {
                  "default": {
                    "description": "default"
                  }
                },
                "summary": "Assign a policy to an identity",
                "description": "Assign a policy to an identity",
                "operationId": "[variables('_operationId-AssignPolicyToIdentity')]",
                "parameters": [
                  {
                    "name": "organizationId",
                    "in": "path",
                    "required": true,
                    "type": "string",
                    "description": "Organization Id"
                  },
                  {
                    "name": "policyId",
                    "in": "path",
                    "required": true,
                    "type": "string",
                    "description": "Policy Id"
                  },
                  {
                    "name": "originId",
                    "in": "path",
                    "required": true,
                    "type": "string",
                    "description": "Identity Id"
                  }
                ]
              }
            }
          },
		  "parameters": {},
          "securityDefinitions": {
            "basic_auth": {
              "type": "basic"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook5-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[variables('playbook5-AzureSentinelConnectionName')]",
        "api": {
          "id": "[variables('_playbook-5-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook5-CiscoUmbrellaNetworkDeviceManagementAPIConnectionName')]",
      "location": "[parameters('workspace-location')]",
	  "dependsOn": [
        "[resourceId('Microsoft.Web/customApis', variables('playbook5-customApis_ciscoumbrellanetworkdevicemanagement_name'))]"
      ],
      "kind": "V1",
      "properties": {
        "displayName": "[variables('playbook5-CiscoUmbrellaNetworkDeviceManagementAPIConnectionName')]",
        "api": {
          "id": "[variables('_playbook-5-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook5-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook5-AzureSentinelConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook5-CiscoUmbrellaNetworkDeviceManagementAPIConnectionName'))]",
		"[resourceId('Microsoft.Web/customApis', variables('playbook5-customApis_ciscoumbrellanetworkdevicemanagement_name'))]"

      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Add_comment_to_incident_(V3)": {
              "inputs": {
                "body": {
                  "incidentArmId": "@triggerBody()?['object']?['id']",
                  "message": "<p><strong></strong><strong>@{outputs('Create_logo')}</strong><strong> CiscoUmbrella-AssignPolicyToIdentity</strong><br> The following origin ids were assigned to policy @{variables('policyId')} for organization @{variables('organizationId')}:<br> @{body('Create_HTML_table_with_updated_origin_IDs')}<br> The following origin ids were not assigned because of errors:<br> @{body('Create_HTML_table_with_not_updated_origin_IDs')}</p>"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/Incidents/Comment"
              },
              "runAfter": {
                "Create_logo": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "Create_HTML_table_with_not_updated_origin_IDs": {
              "inputs": {
                "columns": [
                  {
                    "header": "originId",
                    "value": "@item()"
                  }
                ],
                "format": "HTML",
                "from": "@variables('not_updated_oridinIds_array')"
              },
              "runAfter": {
                "Create_HTML_table_with_updated_origin_IDs": [
                  "Succeeded"
                ]
              },
              "type": "Table"
            },
            "Create_HTML_table_with_updated_origin_IDs": {
              "inputs": {
                "columns": [
                  {
                    "header": "originId",
                    "value": "@item()"
                  }
                ],
                "format": "HTML",
                "from": "@variables('updated_oridinIds_array')"
              },
              "runAfter": {
                "For_each_originId_assign_policy_to_originId": [
                  "Succeeded",
                  "Failed",
                  "Skipped",
                  "TimedOut"
                ]
              },
              "type": "Table"
            },
            "Create_logo": {
              "inputs": "<img src=\"https://github.com/Azure/Azure-Sentinel/raw/master/Solutions/CiscoUmbrella/Playbooks/cisco-logo.png\"  width=\"32\" height=\"32\">",
              "runAfter": {
                "Create_HTML_table_with_not_updated_origin_IDs": [
                  "Succeeded"
                ]
              },
              "type": "Compose"
            },
            "For_each_alert_in_incident": {
              "actions": {
                "For_each_originId": {
                  "actions": {
                    "Add_unique_originId_to_OriginId_array": {
                      "actions": {
                        "Append_to_array_variable": {
                          "inputs": {
                            "name": "originId_array",
                            "value": "@items('For_each_originId')"
                          },
                          "type": "AppendToArrayVariable"
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "not": {
                              "contains": [
                                "@variables('originId_array')",
                                "@items('For_each_originId')"
                              ]
                            }
                          }
                        ]
                      },
                      "type": "If"
                    }
                  },
                  "foreach": "@body('Parse_alert_custom_details')?['originId']",
                  "runAfter": {
                    "Parse_alert_custom_details": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Parse_alert_custom_details": {
                  "inputs": {
                    "content": "@items('For_each_alert_in_incident')?['properties']?['additionalData']?['Custom Details']",
                    "schema": {
                      "properties": {
                        "originId": {
                          "items": {
                            "type": "string"
                          },
                          "type": "array"
                        }
                      },
                      "type": "object"
                    }
                  },
                  "type": "ParseJson"
                }
              },
              "foreach": "@triggerBody()?['object']?['properties']?['Alerts']",
              "runAfter": {
                "Set_value_for_organizationId_variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "For_each_originId_assign_policy_to_originId": {
              "actions": {
                "Append_originId_to_not_updated_originIds_array_variable_in_case_of_error": {
                  "inputs": {
                    "name": "not_updated_oridinIds_array",
                    "value": "@items('For_each_originId_assign_policy_to_originId')"
                  },
                  "runAfter": {
                    "Assign_a_policy_to_an_identity": [
                      "Failed",
                      "TimedOut"
                    ]
                  },
                  "type": "AppendToArrayVariable"
                },
                "Append_originId_to_updated_originIds_array_variable": {
                  "inputs": {
                    "name": "updated_oridinIds_array",
                    "value": "@items('For_each_originId_assign_policy_to_originId')"
                  },
                  "runAfter": {
                    "Append_originId_to_not_updated_originIds_array_variable_in_case_of_error": [
                      "Skipped"
                    ]
                  },
                  "type": "AppendToArrayVariable"
                },
                "Assign_a_policy_to_an_identity": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['ciscoumbrellanetworkdevicemanagement']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/v1/organizations/@{encodeURIComponent(variables('organizationId'))}/policies/@{encodeURIComponent(variables('policyId'))}/identities/@{encodeURIComponent(items('For_each_originId_assign_policy_to_originId'))}"
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@variables('originId_array')",
              "runAfter": {
                "For_each_alert_in_incident": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Get_organization_id": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['ciscoumbrellanetworkdevicemanagement']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/v1/organizations"
              },
              "runAfter": {
                "Initialize_variable_not_updated_oridinIds_array": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "Initialize_variable_not_updated_oridinIds_array": {
              "inputs": {
                "variables": [
                  {
                    "name": "not_updated_oridinIds_array",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_updated_oridinIds_array": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_organizationId": {
              "inputs": {
                "variables": [
                  {
                    "name": "organizationId",
                    "type": "string"
                  }
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_originId_array": {
              "inputs": {
                "variables": [
                  {
                    "name": "originId_array",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_policyId": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_policyId": {
              "inputs": {
                "variables": [
                  {
                    "name": "policyId",
                    "type": "string",
                    "value": "[parameters('playbook5-PolicyId')]"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_organizationId": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_updated_oridinIds_array": {
              "inputs": {
                "variables": [
                  {
                    "name": "updated_oridinIds_array",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_originId_array": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Set_value_for_organizationId_variable": {
              "inputs": {
                "name": "organizationId",
                "value": "@{body('Get_organization_id')[0]['organizationId']}"
              },
              "runAfter": {
                "Get_organization_id": [
                  "Succeeded"
                ]
              },
              "type": "SetVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionName": "[variables('playbook5-AzureSentinelConnectionName')]",
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook5-AzureSentinelConnectionName'))]",
                "id": "[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',parameters('workspace-location'),'/managedApis/azuresentinel')]"
              },
              "ciscoumbrellanetworkdevicemanagement": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook5-CiscoUmbrellaNetworkDeviceManagementAPIConnectionName'))]",
                "connectionName": "[variables('playbook5-CiscoUmbrellaNetworkDeviceManagementAPIConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('playbook5-customApis_ciscoumbrellanetworkdevicemanagement_name'))]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook6-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[variables('playbook6-AzureSentinelConnectionName')]",
        "api": {
          "id": "[variables('_playbook-5-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook6-CiscoUmbrellaEnforcementAPIConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "kind": "V1",
      "properties": {
        "displayName": "[variables('playbook6-CiscoUmbrellaEnforcementAPIConnectionName')]",
        "api": {
          "id": "[variables('_playbook-6-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook6-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook6-AzureSentinelConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook6-CiscoUmbrellaEnforcementAPIConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Add_comment_to_incident_(V3)": {
              "inputs": {
                "body": {
                  "incidentArmId": "@triggerBody()?['object']?['id']",
                  "message": "<p>@{outputs('Create_logo')}CiscoUmbrella-BlockDomain<br> The following domains have been added to Cisco Umbrella block destination list:<br> @{body('Create_HTML_table')}</p>"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/Incidents/Comment"
              },
              "runAfter": {
                "Create_logo": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "Create_HTML_table": {
              "inputs": {
                "columns": [
                  {
                    "header": "Domain",
                    "value": "@item()"
                  }
                ],
                "format": "HTML",
                "from": "@variables('blocked_domains')"
              },
              "runAfter": {
                "For_each_URL": [
                  "Succeeded"
                ]
              },
              "type": "Table"
            },
            "Create_logo": {
              "inputs": "<img src=\"https://github.com/Azure/Azure-Sentinel/raw/master/Solutions/CiscoUmbrella/Playbooks/cisco-logo.png\"  width=\"32\" height=\"32\">",
              "runAfter": {
                "Create_HTML_table": [
                  "Succeeded"
                ]
              },
              "type": "Compose"
            },
            "Entities_-_Get_URLs": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/url"
              },
              "runAfter": {
                "Initialize_variable_blocked_domains": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_URL": {
              "actions": {
                "Append_domain_to_blocked_domains_variable": {
                  "inputs": {
                    "name": "blocked_domains",
                    "value": "@outputs('Get_Domain_from_URL')"
                  },
                  "runAfter": {
                    "Block_domain": [
                      "Succeeded"
                    ]
                  },
                  "type": "AppendToArrayVariable"
                },
                "Block_domain": {
                  "inputs": {
                    "body": [
                      {
                        "alertTime": "@{utcNow()}",
                        "deviceId": "azuresentinel",
                        "deviceVersion": "13.7a",
                        "dstDomain": "@{outputs('Get_Domain_from_URL')}",
                        "dstUrl": "@{outputs('Get_Domain_from_URL')}",
                        "eventTime": "@{utcNow()}",
                        "protocolVersion": "1.0a",
                        "providerName": "Security Platform"
                      }
                    ],
                    "headers": {
                      "Accept": "application/json"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['ciscoumbrellaenforcement']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/1.0/events"
                  },
                  "runAfter": {
                    "Get_Domain_from_URL": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Get_Domain_from_URL": {
                  "inputs": "@split(replace(replace(items('For_each_URL')?['Url'],'http://',''), 'https://', ''), '/')[0]",
                  "type": "Compose"
                }
              },
              "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
              "runAfter": {
                "Entities_-_Get_URLs": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Initialize_variable_blocked_domains": {
              "inputs": {
                "variables": [
                  {
                    "name": "blocked_domains",
                    "type": "array"
                  }
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionName": "[variables('playbook6-AzureSentinelConnectionName')]",
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook6-AzureSentinelConnectionName'))]",
                "id": "[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',parameters('workspace-location'),'/managedApis/azuresentinel')]"
              },
              "ciscoumbrellaenforcement": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook6-CiscoUmbrellaEnforcementAPIConnectionName'))]",
                "connectionName": "[variables('playbook6-CiscoUmbrellaEnforcementAPIConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('playbook6-customApis_ciscoumbrellaenforcement_name'))]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook7-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[variables('playbook7-AzureSentinelConnectionName')]",
        "api": {
          "id": "[variables('_playbook-5-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook7-CiscoUmbrellaInvestigateAPIConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "kind": "V1",
      "properties": {
        "displayName": "[variables('playbook7-CiscoUmbrellaInvestigateAPIConnectionName')]",
        "api": {
          "id": "[variables('_playbook-7-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook7-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook7-AzureSentinelConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook7-CiscoUmbrellaInvestigateAPIConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Entities_-_Get_URLs": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/url"
              },
              "type": "ApiConnection"
            },
            "For_each_URL": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p><strong></strong><strong>@{outputs('Get_logo')}</strong><strong> </strong><span style=\"font-size: 14px\"><strong>CiscoUmbrella-GetDomainInfo</strong></span><br> Risk score for domain @{outputs('Get_domain_from_URL')} is &nbsp;@{body('Get_Risk_score_for_a_domain')?['risk_score']}.<br> <span style=\"font-size: 12px\"><strong>Risk score indicators:</strong></span><br> @{body('Create_HTML_table_with_security_indicators')}<br> <br> </p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_HTML_table_with_security_indicators": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>@{outputs('Get_logo')}<span style=\"font-size: 14px\"><strong> CiscoUmbrella-GetDomainInfo<br> </strong></span><span style=\"font-size: 12px\">Security data for </span><span style=\"font-size: 12px\">@{outputs('Get_domain_from_URL')}</span><span style=\"font-size: 12px\"> (part 1) :<br> </span><span style=\"font-size: 12px\"><strong>dga_score:</strong></span><span style=\"font-size: 12px\"> </span><span style=\"font-size: 12px\">@{body('Get_domain_security_data')?['dga_score']}</span><span style=\"font-size: 12px\"><br> Domain Generation Algorithm. This score is generated based on the likeliness of the domain name being generated by an algorithm rather than a human. This algorithm is designed to identify domains which have been created using an automated randomization strategy, which is a common evasion technique in malware kits or botnets. This score ranges from -100 (suspicious) to 0 (benign).<br> </span><span style=\"font-size: 12px\"><strong>perplexity:</strong></span><span style=\"font-size: 12px\"> </span><span style=\"font-size: 12px\">@{body('Get_domain_security_data')?['perplexity']}</span><span style=\"font-size: 12px\"><br> A second score on the likeliness of the name to be algorithmically generated, on a scale from 0 to 100. This score is to be used in conjunction with DGA.<br> </span><span style=\"font-size: 12px\"><strong>entropy:</strong></span><span style=\"font-size: 12px\"> </span><span style=\"font-size: 12px\">@{body('Get_domain_security_data')?['entropy']}</span><span style=\"font-size: 12px\"><br> The number of bits required to encode the domain name, as a score. This score is to be used in conjunction with DGA and Perplexity.<br> </span><span style=\"font-size: 12px\"><strong>securerank2:</strong></span><span style=\"font-size: 12px\"> </span><span style=\"font-size: 12px\">@{body('Get_domain_security_data')?['securerank2']}</span><span style=\"font-size: 12px\"><br> Suspicious rank for a domain that reviews based on the lookup behavior of client IP for the domain. Securerank is designed to identify hostnames requested by known infected clients but never requested by clean clients, assuming these domains are more likely to be bad. Scores returned range from -100 (suspicious) to 100 (benign).<br> </span></p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Add_comment_to_incident_(V3)": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Add_comment_to_incident_(V3)_3": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>@{outputs('Get_logo')} CiscoUmbrella-GetDomainInfo<br> Security data for @{outputs('Get_domain_from_URL')} (part 2):<br> <strong>pagerank: </strong>@{body('Get_domain_security_data')?['pagerank']}<br> Popularity according to Google's pagerank algorithm.<br> <strong>asn_score: </strong>@{body('Get_domain_security_data')?['asn_score']}<br> ASN reputation score, ranges from -100 to 0 with -100 being very suspicious.<br> <strong>prefix_score:</strong> @{body('Get_domain_security_data')?['prefix_score']}<br> Prefix ranks domains given their IP prefixes (first three octets in IP) and the reputation score of these prefixes. Ranges from -100 to 0, -100 being very suspicious.<br> <strong>rip_score: </strong>@{body('Get_domain_security_data')?['rip_score']}<br> RIP ranks domains given their IP addresses and the reputation score of these IP addresses. Ranges from -100 to 0, -100 being very suspicious.<br> <strong>popularity:</strong> @{body('Get_domain_security_data')?['popularity']}<br> The number of unique client IPs visiting this site, relative to the all requests to all sites.<br> <strong>geoscore:</strong> @{body('Get_domain_security_data')?['geoscore']}<br> A score that represents how far the different physical locations serving this name are from each other.<br> <strong>ks_test:</strong> @{body('Get_domain_security_data')?['ks_test']}<br> Kolmogorov-Smirnov test on geodiversity. 0 means that the client traffic matches what is expected for this TLD.<br> <strong>attack:</strong> @{body('Get_domain_security_data')?['attack']}<br> The name of any known attacks associated with this domain.<br> <strong>threat_type: </strong>@{body('Get_domain_security_data')?['threat_type']}<br> The type of the known attack.</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Add_comment_to_incident_(V3)_2": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_HTML_table_with_security_indicators": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@body('Get_Risk_score_for_a_domain')?['indicators']"
                  },
                  "runAfter": {
                    "Get_logo": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Get_Risk_score_for_a_domain": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['ciscoumbrellainvestigate']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/domains/risk-score/@{encodeURIComponent(outputs('Get_domain_from_URL'))}"
                  },
                  "runAfter": {
                    "Get_domain_security_data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Get_domain_from_URL": {
                  "inputs": "@split(replace(replace(item()?['Url'],'http://',''), 'https://', ''), '/')[0]",
                  "type": "Compose"
                },
                "Get_domain_security_data": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['ciscoumbrellainvestigate']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/security/name/@{encodeURIComponent(outputs('Get_domain_from_URL'))}"
                  },
                  "runAfter": {
                    "Get_domain_from_URL": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Get_logo": {
                  "inputs": "<img src=\"https://github.com/Azure/Azure-Sentinel/raw/master/Solutions/CiscoUmbrella/Playbooks/cisco-logo.png\"  width=\"32\" height=\"32\">",
                  "runAfter": {
                    "Get_Risk_score_for_a_domain": [
                      "Succeeded"
                    ]
                  },
                  "type": "Compose"
                }
              },
              "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
              "runAfter": {
                "Entities_-_Get_URLs": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionName": "[variables('playbook7-AzureSentinelConnectionName')]",
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook7-AzureSentinelConnectionName'))]",
                "id": "[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',parameters('workspace-location'),'/managedApis/azuresentinel')]"
              },
              "ciscoumbrellainvestigate": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook7-CiscoUmbrellaInvestigateAPIConnectionName'))]",
                "connectionName": "[variables('playbook7-CiscoUmbrellaInvestigateAPIConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('playbook7-customApis_ciscoumbrellainvestigate_name'))]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "contentId": "[variables('_sourceId')]",
        "version": "1.0.5",
        "kind": "Solution",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "Cisco Umbrella",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Eli Forbes",
          "email": "v-eliforbes@microsoft.com"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_CiscoUmbrella')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaConnectionNon-CorporatePrivateNetwork')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaConnectionToUnpopularWebsiteDetected')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaCryptoMinerUserAgentDetected')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaEmptyUserAgentDetected')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaHackToolUserAgentDetected')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaPowershellUserAgentDetected')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaRareUserAgentDetected')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaRequestAllowedHarmfulMaliciousURICategory')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaRequestBlocklistedFileType')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoUmbrellaURIContainsIPAddress')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaAnomalousFQDNsforDomain')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaBlockedUserAgents')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaDNSErrors')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaDNSRequestsUunreliableCategory')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaHighCountsOfTheSameBytesInSize')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaHighValuesOfUploadedData')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaPossibleConnectionC2')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaPossibleDataExfiltration')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaProxyAllowedUnreliableCategory')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoUmbrellaRequestsUncategorizedURI')]",
              "version": "1.0.5"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_Cisco_Umbrella')]",
              "version": "1.0.5"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CiscoUmbrellaEnforcementAPIConnector')]",
              "version": "1.0.5"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CiscoUmbrellaInvestigateAPIConnector')]",
              "version": "1.0.5"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CiscoUmbrellaManagementAPIConnector')]",
              "version": "1.0.5"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CiscoUmbrellaNetworkDeviceManagementAPIConnector')]",
              "version": "1.0.5"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CiscoUmbrella-AssignPolicyToIdentity')]",
              "version": "1.0.5"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CiscoUmbrella-BlockDomain')]",
              "version": "1.0.5"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CiscoUmbrella-GetDomainInfo')]",
              "version": "1.0.5"
            }
          ]
        },
        "categories": {
          "domains": [
            "Security  Cloud Security"
          ]
        },
        "firstPublishDate": "2021-03-26",
        "lastPublishDate": "2021-08-16",
        "providers": [
          "Cisco"
        ]
      }
    }
  ],
  "outputs": {}
}
