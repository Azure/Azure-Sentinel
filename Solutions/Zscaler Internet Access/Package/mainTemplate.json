{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Paul Lopez - paul.lopez@zscaler.com",
    "comments": "Solution template for Zscaler Internet Access"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is setup"
      }
    },
    "subscription": {
      "type": "string",
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS Web Logs - Overview",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook2-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS Web Logs - Threats",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook3-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS Web Logs - Office 365",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook4-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS Firewall Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook5-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS DNS Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook6-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS Tunnel Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook7-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS Endpoint DLP Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook8-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS Email DLP Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook9-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS CASB Activity Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook10-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS CASB Cloud Storage Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook11-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS CASB Collaboration Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook12-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS CASB CRM Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook13-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS CASB Email Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook14-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS CASB File Sharing Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook15-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS CASB ITSM Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook16-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS CASB Repo Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook17-name": {
      "type": "string",
      "defaultValue": "Zscaler NSS Audit Logs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "email": "paul.lopez@zscaler.com",
    "_email": "[variables('email')]",
    "_solutionName": "Zscaler Internet Access",
    "_solutionVersion": "3.0.0",
    "solutionId": "zscaler.zscaler_zia",
    "_solutionId": "[variables('solutionId')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "dataConnectorCCPVersion": "1.0.0",
    "_dataConnectorContentIdConnectorDefinition1": "CloudNSSWebLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
    "_dataConnectorContentIdConnections1": "CloudNSSWebLogs_ccpConnections",
    "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
    "blanks": "[replace('b', 'b', '')]",
    "_dataConnectorContentIdConnectorDefinition2": "CloudNSSFWLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition2": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition2')))]",
    "_dataConnectorContentIdConnections2": "CloudNSSFWLogs_ccpConnections",
    "dataConnectorTemplateNameConnections2": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections2')))]",
    "_dataConnectorContentIdConnectorDefinition3": "CloudNSSDNSLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition3": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition3')))]",
    "_dataConnectorContentIdConnections3": "CloudNSSDNSLogs_ccpConnections",
    "dataConnectorTemplateNameConnections3": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections3')))]",
    "_dataConnectorContentIdConnectorDefinition4": "CloudNSSTunnelLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition4": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition4')))]",
    "_dataConnectorContentIdConnections4": "CloudNSSTunnelLogs_ccpConnections",
    "dataConnectorTemplateNameConnections4": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections4')))]",
    "_dataConnectorContentIdConnectorDefinition5": "CloudNSSEndpointDLPLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition5": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition5')))]",
    "_dataConnectorContentIdConnections5": "CloudNSSEndpointDLPLogs_ccpConnections",
    "dataConnectorTemplateNameConnections5": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections5')))]",
    "_dataConnectorContentIdConnectorDefinition6": "CloudNSSEmailDLPLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition6": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition6')))]",
    "_dataConnectorContentIdConnections6": "CloudNSSEmailDLPLogs_ccpConnections",
    "dataConnectorTemplateNameConnections6": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections6')))]",
    "_dataConnectorContentIdConnectorDefinition7": "CloudNSSCASBRepoLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition7": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition7')))]",
    "_dataConnectorContentIdConnections7": "CloudNSSCASBRepoLogs_ccpConnections",
    "dataConnectorTemplateNameConnections7": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections7')))]",
    "_dataConnectorContentIdConnectorDefinition8": "CloudNSSCASBITSMLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition8": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition8')))]",
    "_dataConnectorContentIdConnections8": "CloudNSSCASBITSMLogs_ccpConnections",
    "dataConnectorTemplateNameConnections8": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections8')))]",
    "_dataConnectorContentIdConnectorDefinition9": "CloudNSSCASBFileSharingLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition9": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition9')))]",
    "_dataConnectorContentIdConnections9": "CloudNSSCASBFileSharingLogs_ccpConnections",
    "dataConnectorTemplateNameConnections9": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections9')))]",
    "_dataConnectorContentIdConnectorDefinition10": "CloudNSSCASBEmailLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition10": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition10')))]",
    "_dataConnectorContentIdConnections10": "CloudNSSCASBEmailLogs_ccpConnections",
    "dataConnectorTemplateNameConnections10": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections10')))]",
    "_dataConnectorContentIdConnectorDefinition11": "CloudNSSCASBCRMLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition11": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition11')))]",
    "_dataConnectorContentIdConnections11": "CloudNSSCASBCRMLogs_ccpConnections",
    "dataConnectorTemplateNameConnections11": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections11')))]",
    "_dataConnectorContentIdConnectorDefinition12": "CloudNSSCASBCollabLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition12": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition12')))]",
    "_dataConnectorContentIdConnections12": "CloudNSSCASBCollabLogs_ccpConnections",
    "dataConnectorTemplateNameConnections12": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections12')))]",
    "_dataConnectorContentIdConnectorDefinition13": "CloudNSSCASBCloudStorageLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition13": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition13')))]",
    "_dataConnectorContentIdConnections13": "CloudNSSCASBCloudStorageLogs_ccpConnections",
    "dataConnectorTemplateNameConnections13": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections13')))]",
    "_dataConnectorContentIdConnectorDefinition14": "CloudNSSCASBActivityLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition14": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition14')))]",
    "_dataConnectorContentIdConnections14": "CloudNSSCASBActivityLogs_ccpConnections",
    "dataConnectorTemplateNameConnections14": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections14')))]",
    "_dataConnectorContentIdConnectorDefinition15": "CloudNSSAuditLogs_ccp",
    "dataConnectorTemplateNameConnectorDefinition15": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition15')))]",
    "_dataConnectorContentIdConnections15": "CloudNSSAuditLogs_ccpConnections",
    "dataConnectorTemplateNameConnections15": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections15')))]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "Zscaler NSS Web Logs - Overview",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "workbookVersion2": "1.0.0",
    "workbookContentId2": "Zscaler NSS Web Logs - Threats",
    "workbookId2": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId2'))]",
    "workbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId2'))))]",
    "_workbookContentId2": "[variables('workbookContentId2')]",
    "_workbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId2'),'-', variables('workbookVersion2'))))]",
    "workbookVersion3": "1.0.0",
    "workbookContentId3": "Zscaler NSS Web Logs - Office 365",
    "workbookId3": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId3'))]",
    "workbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId3'))))]",
    "_workbookContentId3": "[variables('workbookContentId3')]",
    "_workbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId3'),'-', variables('workbookVersion3'))))]",
    "workbookVersion4": "1.0.0",
    "workbookContentId4": "Zscaler NSS Firewall Logs",
    "workbookId4": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId4'))]",
    "workbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId4'))))]",
    "_workbookContentId4": "[variables('workbookContentId4')]",
    "_workbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId4'),'-', variables('workbookVersion4'))))]",
    "workbookVersion5": "1.0.0",
    "workbookContentId5": "Zscaler NSS DNS Logs",
    "workbookId5": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId5'))]",
    "workbookTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId5'))))]",
    "_workbookContentId5": "[variables('workbookContentId5')]",
    "_workbookcontentProductId5": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId5'),'-', variables('workbookVersion5'))))]",
    "workbookVersion6": "1.0.0",
    "workbookContentId6": "Zscaler NSS Tunnel Logs",
    "workbookId6": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId6'))]",
    "workbookTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId6'))))]",
    "_workbookContentId6": "[variables('workbookContentId6')]",
    "_workbookcontentProductId6": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId6'),'-', variables('workbookVersion6'))))]",
    "workbookVersion7": "1.0.0",
    "workbookContentId7": "Zscaler NSS Endpoint DLP Logs",
    "workbookId7": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId7'))]",
    "workbookTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId7'))))]",
    "_workbookContentId7": "[variables('workbookContentId7')]",
    "_workbookcontentProductId7": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId7'),'-', variables('workbookVersion7'))))]",
    "workbookVersion8": "1.0.0",
    "workbookContentId8": "Zscaler NSS Email DLP Logs",
    "workbookId8": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId8'))]",
    "workbookTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId8'))))]",
    "_workbookContentId8": "[variables('workbookContentId8')]",
    "_workbookcontentProductId8": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId8'),'-', variables('workbookVersion8'))))]",
    "workbookVersion9": "1.0.0",
    "workbookContentId9": "Zscaler NSS CASB Activity Logs",
    "workbookId9": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId9'))]",
    "workbookTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId9'))))]",
    "_workbookContentId9": "[variables('workbookContentId9')]",
    "_workbookcontentProductId9": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId9'),'-', variables('workbookVersion9'))))]",
    "workbookVersion10": "1.0.0",
    "workbookContentId10": "Zscaler NSS CASB Cloud Storage Logs",
    "workbookId10": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId10'))]",
    "workbookTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId10'))))]",
    "_workbookContentId10": "[variables('workbookContentId10')]",
    "_workbookcontentProductId10": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId10'),'-', variables('workbookVersion10'))))]",
    "workbookVersion11": "1.0.0",
    "workbookContentId11": "Zscaler NSS CASB Collaboration Logs",
    "workbookId11": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId11'))]",
    "workbookTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId11'))))]",
    "_workbookContentId11": "[variables('workbookContentId11')]",
    "_workbookcontentProductId11": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId11'),'-', variables('workbookVersion11'))))]",
    "workbookVersion12": "1.0.0",
    "workbookContentId12": "Zscaler NSS CASB CRM Logs",
    "workbookId12": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId12'))]",
    "workbookTemplateSpecName12": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId12'))))]",
    "_workbookContentId12": "[variables('workbookContentId12')]",
    "_workbookcontentProductId12": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId12'),'-', variables('workbookVersion12'))))]",
    "workbookVersion13": "1.0.0",
    "workbookContentId13": "Zscaler NSS CASB Email Logs",
    "workbookId13": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId13'))]",
    "workbookTemplateSpecName13": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId13'))))]",
    "_workbookContentId13": "[variables('workbookContentId13')]",
    "_workbookcontentProductId13": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId13'),'-', variables('workbookVersion13'))))]",
    "workbookVersion14": "1.0.0",
    "workbookContentId14": "Zscaler NSS CASB File Sharing Logs",
    "workbookId14": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId14'))]",
    "workbookTemplateSpecName14": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId14'))))]",
    "_workbookContentId14": "[variables('workbookContentId14')]",
    "_workbookcontentProductId14": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId14'),'-', variables('workbookVersion14'))))]",
    "workbookVersion15": "1.0.0",
    "workbookContentId15": "Zscaler NSS CASB ITSM Logs",
    "workbookId15": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId15'))]",
    "workbookTemplateSpecName15": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId15'))))]",
    "_workbookContentId15": "[variables('workbookContentId15')]",
    "_workbookcontentProductId15": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId15'),'-', variables('workbookVersion15'))))]",
    "workbookVersion16": "1.0.0",
    "workbookContentId16": "Zscaler NSS CASB Repo Logs",
    "workbookId16": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId16'))]",
    "workbookTemplateSpecName16": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId16'))))]",
    "_workbookContentId16": "[variables('workbookContentId16')]",
    "_workbookcontentProductId16": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId16'),'-', variables('workbookVersion16'))))]",
    "workbookVersion17": "1.0.0",
    "workbookContentId17": "Zscaler NSS Audit Logs",
    "workbookId17": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId17'))]",
    "workbookTemplateSpecName17": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId17'))))]",
    "_workbookContentId17": "[variables('workbookContentId17')]",
    "_workbookcontentProductId17": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId17'),'-', variables('workbookVersion17'))))]",
    "Zscaler-Oauth2-Authentication": "Zscaler-Oauth2-Authentication",
    "_Zscaler-Oauth2-Authentication": "[variables('Zscaler-Oauth2-Authentication')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "Zscaler-Oauth2-Authentication",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookId1": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId1'))))]",
    "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
    "Zscaler-Oauth2-BlacklistURL": "Zscaler-Oauth2-BlacklistURL",
    "_Zscaler-Oauth2-BlacklistURL": "[variables('Zscaler-Oauth2-BlacklistURL')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "Zscaler-Oauth2-BlacklistURL",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))))]",
    "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
    "Zscaler-Oauth2-BlockIP": "Zscaler-Oauth2-BlockIP",
    "_Zscaler-Oauth2-BlockIP": "[variables('Zscaler-Oauth2-BlockIP')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "Zscaler-Oauth2-BlockIP",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3'))))]",
    "_playbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId3'),'-', variables('playbookVersion3'))))]",
    "Zscaler-Oauth2-BlockURL": "Zscaler-Oauth2-BlockURL",
    "_Zscaler-Oauth2-BlockURL": "[variables('Zscaler-Oauth2-BlockURL')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "Zscaler-Oauth2-BlockURL",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4'))))]",
    "_playbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId4'),'-', variables('playbookVersion4'))))]",
    "Zscaler-Oauth2-LookupIP": "Zscaler-Oauth2-LookupIP",
    "_Zscaler-Oauth2-LookupIP": "[variables('Zscaler-Oauth2-LookupIP')]",
    "playbookVersion5": "1.0",
    "playbookContentId5": "Zscaler-Oauth2-LookupIP",
    "_playbookContentId5": "[variables('playbookContentId5')]",
    "playbookId5": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId5'))]",
    "playbookTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId5'))))]",
    "_playbookcontentProductId5": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId5'),'-', variables('playbookVersion5'))))]",
    "Zscaler-Oauth2-LookupSandboxReport": "Zscaler-Oauth2-LookupSandboxReport",
    "_Zscaler-Oauth2-LookupSandboxReport": "[variables('Zscaler-Oauth2-LookupSandboxReport')]",
    "playbookVersion6": "1.0",
    "playbookContentId6": "Zscaler-Oauth2-LookupSandboxReport",
    "_playbookContentId6": "[variables('playbookContentId6')]",
    "playbookId6": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId6'))]",
    "playbookTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId6'))))]",
    "_playbookcontentProductId6": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId6'),'-', variables('playbookVersion6'))))]",
    "Zscaler-Oauth2-LookupURL": "Zscaler-Oauth2-LookupURL",
    "_Zscaler-Oauth2-LookupURL": "[variables('Zscaler-Oauth2-LookupURL')]",
    "playbookVersion7": "1.0",
    "playbookContentId7": "Zscaler-Oauth2-LookupURL",
    "_playbookContentId7": "[variables('playbookContentId7')]",
    "playbookId7": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId7'))]",
    "playbookTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId7'))))]",
    "_playbookcontentProductId7": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId7'),'-', variables('playbookVersion7'))))]",
    "Zscaler-Oauth2-UnblacklistURL": "Zscaler-Oauth2-UnblacklistURL",
    "_Zscaler-Oauth2-UnblacklistURL": "[variables('Zscaler-Oauth2-UnblacklistURL')]",
    "playbookVersion8": "1.0",
    "playbookContentId8": "Zscaler-Oauth2-UnblacklistURL",
    "_playbookContentId8": "[variables('playbookContentId8')]",
    "playbookId8": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId8'))]",
    "playbookTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId8'))))]",
    "_playbookcontentProductId8": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId8'),'-', variables('playbookVersion8'))))]",
    "Zscaler-Oauth2-UnblockIP": "Zscaler-Oauth2-UnblockIP",
    "_Zscaler-Oauth2-UnblockIP": "[variables('Zscaler-Oauth2-UnblockIP')]",
    "playbookVersion9": "1.0",
    "playbookContentId9": "Zscaler-Oauth2-UnblockIP",
    "_playbookContentId9": "[variables('playbookContentId9')]",
    "playbookId9": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId9'))]",
    "playbookTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId9'))))]",
    "_playbookcontentProductId9": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId9'),'-', variables('playbookVersion9'))))]",
    "Zscaler-Oauth2-UnblockURL": "Zscaler-Oauth2-UnblockURL",
    "_Zscaler-Oauth2-UnblockURL": "[variables('Zscaler-Oauth2-UnblockURL')]",
    "playbookVersion10": "1.0",
    "playbookContentId10": "Zscaler-Oauth2-UnblockURL",
    "_playbookContentId10": "[variables('playbookContentId10')]",
    "playbookId10": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId10'))]",
    "playbookTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId10'))))]",
    "_playbookcontentProductId10": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId10'),'-', variables('playbookVersion10'))))]",
    "Zscaler-Oauth2-WhitelistURL": "Zscaler-Oauth2-WhitelistURL",
    "_Zscaler-Oauth2-WhitelistURL": "[variables('Zscaler-Oauth2-WhitelistURL')]",
    "playbookVersion11": "1.0",
    "playbookContentId11": "Zscaler-Oauth2-WhitelistURL",
    "_playbookContentId11": "[variables('playbookContentId11')]",
    "playbookId11": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId11'))]",
    "playbookTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId11'))))]",
    "_playbookcontentProductId11": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId11'),'-', variables('playbookVersion11'))))]",
    "analyticRuleObject1": {
      "analyticRuleVersion1": "1.0.4",
      "_analyticRulecontentId1": "010bd98c-a6be-498c-bdcd-502308c0fdae",
      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '010bd98c-a6be-498c-bdcd-502308c0fdae')]",
      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('010bd98c-a6be-498c-bdcd-502308c0fdae')))]",
      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','010bd98c-a6be-498c-bdcd-502308c0fdae','-', '1.0.4')))]"
    },
    "analyticRuleObject2": {
      "analyticRuleVersion2": "1.0.5",
      "_analyticRulecontentId2": "4d500e6d-c984-43a3-9f39-7edec8dcc04d",
      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4d500e6d-c984-43a3-9f39-7edec8dcc04d')]",
      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('4d500e6d-c984-43a3-9f39-7edec8dcc04d')))]",
      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','4d500e6d-c984-43a3-9f39-7edec8dcc04d','-', '1.0.5')))]"
    },
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "displayName": "Zscaler Internet Access Cloud NSS Web Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSWebLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS Web Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA web log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIAWebLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSWeblog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSWeblog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - All Blocked Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSWeblog'\n | where DeviceEventClassID == 'Blocked'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSWeblog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSWeblog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Jamf Protect uses in a Microsoft Analytics Workspace, if the [data forwarding](https://docs.jamf.com/jamf-protect/documentation/Data_Forwarding_to_a_Third_Party_Storage_Solution.html?hl=sentinel#task-4227) option is enabled in Jamf Protect then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS Web Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS Web Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSWebLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_web_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "app",
                        "type": "string"
                      },
                      {
                        "name": "cat",
                        "type": "string"
                      },
                      {
                        "name": "dhost",
                        "type": "string"
                      },
                      {
                        "name": "dst",
                        "type": "string"
                      },
                      {
                        "name": "src",
                        "type": "string"
                      },
                      {
                        "name": "in_bytes",
                        "type": "string"
                      },
                      {
                        "name": "outcome",
                        "type": "string"
                      },
                      {
                        "name": "out",
                        "type": "string"
                      },
                      {
                        "name": "request",
                        "type": "string"
                      },
                      {
                        "name": "rt",
                        "type": "string"
                      },
                      {
                        "name": "sourceTranslatedAddress",
                        "type": "string"
                      },
                      {
                        "name": "requestClientApplication",
                        "type": "string"
                      },
                      {
                        "name": "requestMethod",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      },
                      {
                        "name": "spriv",
                        "type": "string"
                      },
                      {
                        "name": "externalId",
                        "type": "string"
                      },
                      {
                        "name": "fileType",
                        "type": "string"
                      },
                      {
                        "name": "reason",
                        "type": "string"
                      },
                      {
                        "name": "destinationServiceName",
                        "type": "string"
                      },
                      {
                        "name": "cn1",
                        "type": "string"
                      },
                      {
                        "name": "cn1Label",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "cs6",
                        "type": "string"
                      },
                      {
                        "name": "cs6Label",
                        "type": "string"
                      },
                      {
                        "name": "ZscalerNSSWeblogURLClass",
                        "type": "string"
                      },
                      {
                        "name": "ZscalerNSSWeblogDLPDictionaries",
                        "type": "string"
                      },
                      {
                        "name": "requestContext",
                        "type": "string"
                      },
                      {
                        "name": "contenttype",
                        "type": "string"
                      },
                      {
                        "name": "unscannabletype",
                        "type": "string"
                      },
                      {
                        "name": "deviceowner",
                        "type": "string"
                      },
                      {
                        "name": "devicehostname",
                        "type": "string"
                      },
                      {
                        "name": "keyprotectiontype",
                        "type": "string"
                      },
                      {
                        "name": "cloudname",
                        "type": "string"
                      },
                      {
                        "name": "company",
                        "type": "string"
                      },
                      {
                        "name": "throttlereqsize",
                        "type": "string"
                      },
                      {
                        "name": "throttlerespsize",
                        "type": "string"
                      },
                      {
                        "name": "bwthrottle",
                        "type": "string"
                      },
                      {
                        "name": "bwclassname",
                        "type": "string"
                      },
                      {
                        "name": "bwrulename",
                        "type": "string"
                      },
                      {
                        "name": "module",
                        "type": "string"
                      },
                      {
                        "name": "app_risk_score",
                        "type": "string"
                      },
                      {
                        "name": "datacenter",
                        "type": "string"
                      },
                      {
                        "name": "datacentercity",
                        "type": "string"
                      },
                      {
                        "name": "datacentercountry",
                        "type": "string"
                      },
                      {
                        "name": "dlpdicthitcount",
                        "type": "string"
                      },
                      {
                        "name": "dlpidentifier",
                        "type": "string"
                      },
                      {
                        "name": "dlpmd5",
                        "type": "string"
                      },
                      {
                        "name": "dlprulename",
                        "type": "string"
                      },
                      {
                        "name": "fileclass",
                        "type": "string"
                      },
                      {
                        "name": "fname",
                        "type": "string"
                      },
                      {
                        "name": "filesubtype",
                        "type": "string"
                      },
                      {
                        "name": "upload_fileclass",
                        "type": "string"
                      },
                      {
                        "name": "upload_filetype",
                        "type": "string"
                      },
                      {
                        "name": "upload_filename",
                        "type": "string"
                      },
                      {
                        "name": "upload_filesubtype",
                        "type": "string"
                      },
                      {
                        "name": "upload_doctypename",
                        "type": "string"
                      },
                      {
                        "name": "rdr_rulename",
                        "type": "string"
                      },
                      {
                        "name": "fwd_type",
                        "type": "string"
                      },
                      {
                        "name": "fwd_gw_name",
                        "type": "string"
                      },
                      {
                        "name": "fwd_gw_ip",
                        "type": "string"
                      },
                      {
                        "name": "zpa_app_seg_name",
                        "type": "string"
                      },
                      {
                        "name": "reqdatasize",
                        "type": "string"
                      },
                      {
                        "name": "reqhdrsize",
                        "type": "string"
                      },
                      {
                        "name": "respdatasize",
                        "type": "string"
                      },
                      {
                        "name": "resphdrsize",
                        "type": "string"
                      },
                      {
                        "name": "totalsize",
                        "type": "string"
                      },
                      {
                        "name": "df_hosthead",
                        "type": "string"
                      },
                      {
                        "name": "df_hostname",
                        "type": "string"
                      },
                      {
                        "name": "erefererhost",
                        "type": "string"
                      },
                      {
                        "name": "refererpath",
                        "type": "string"
                      },
                      {
                        "name": "eurlpath",
                        "type": "string"
                      },
                      {
                        "name": "reqversion",
                        "type": "string"
                      },
                      {
                        "name": "respversion",
                        "type": "string"
                      },
                      {
                        "name": "ua_token",
                        "type": "string"
                      },
                      {
                        "name": "uaclass",
                        "type": "string"
                      },
                      {
                        "name": "mobappname",
                        "type": "string"
                      },
                      {
                        "name": "mobappcat",
                        "type": "string"
                      },
                      {
                        "name": "mobdevtype",
                        "type": "string"
                      },
                      {
                        "name": "clt_sport",
                        "type": "string"
                      },
                      {
                        "name": "cpubip",
                        "type": "string"
                      },
                      {
                        "name": "alpnprotocol",
                        "type": "string"
                      },
                      {
                        "name": "trafficredirectmethod",
                        "type": "string"
                      },
                      {
                        "name": "euserlocationname",
                        "type": "string"
                      },
                      {
                        "name": "erulelabel",
                        "type": "string"
                      },
                      {
                        "name": "ruletype",
                        "type": "string"
                      },
                      {
                        "name": "eurlfilterrulelabel",
                        "type": "string"
                      },
                      {
                        "name": "ourlfilterrulelabel",
                        "type": "string"
                      },
                      {
                        "name": "eapprulelabel",
                        "type": "string"
                      },
                      {
                        "name": "fileHash",
                        "type": "string"
                      },
                      {
                        "name": "sha256",
                        "type": "string"
                      },
                      {
                        "name": "ssldecrypted",
                        "type": "string"
                      },
                      {
                        "name": "externalspr",
                        "type": "string"
                      },
                      {
                        "name": "clientsslcipher",
                        "type": "string"
                      },
                      {
                        "name": "clienttlsversion",
                        "type": "string"
                      },
                      {
                        "name": "clientsslsessreuse",
                        "type": "string"
                      },
                      {
                        "name": "cltsslfailreason",
                        "type": "string"
                      },
                      {
                        "name": "cltsslfailcount",
                        "type": "string"
                      },
                      {
                        "name": "srvsslcipher",
                        "type": "string"
                      },
                      {
                        "name": "srvtlsversion",
                        "type": "string"
                      },
                      {
                        "name": "srvocspresult",
                        "type": "string"
                      },
                      {
                        "name": "srvcertchainvalpass",
                        "type": "string"
                      },
                      {
                        "name": "srvwildcardcert",
                        "type": "string"
                      },
                      {
                        "name": "serversslsessreuse",
                        "type": "string"
                      },
                      {
                        "name": "srvcertvalidationtype",
                        "type": "string"
                      },
                      {
                        "name": "srvcertvalidityperiod",
                        "type": "string"
                      },
                      {
                        "name": "is_ssluntrustedca",
                        "type": "string"
                      },
                      {
                        "name": "is_sslselfsigned",
                        "type": "string"
                      },
                      {
                        "name": "is_sslexpiredca",
                        "type": "string"
                      },
                      {
                        "name": "threatseverity",
                        "type": "string"
                      },
                      {
                        "name": "malwareclass",
                        "type": "string"
                      },
                      {
                        "name": "urlcatmethod",
                        "type": "string"
                      },
                      {
                        "name": "bypassed_traffic",
                        "type": "string"
                      },
                      {
                        "name": "bypassed_etime",
                        "type": "string"
                      },
                      {
                        "name": "deviceappversion",
                        "type": "string"
                      },
                      {
                        "name": "devicemodel",
                        "type": "string"
                      },
                      {
                        "name": "devicename",
                        "type": "string"
                      },
                      {
                        "name": "deviceostype",
                        "type": "string"
                      },
                      {
                        "name": "devicetype",
                        "type": "string"
                      },
                      {
                        "name": "external_devid",
                        "type": "string"
                      },
                      {
                        "name": "flow_type",
                        "type": "string"
                      },
                      {
                        "name": "ztunnelversion",
                        "type": "string"
                      },
                      {
                        "name": "productversion",
                        "type": "string"
                      },
                      {
                        "name": "nsssvcip",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_web_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), DeviceAction=tostring(act), LogSeverity=tostring(Severity), Activity=tostring(name), DeviceEventClassID=tostring(deviceEventClassId), ApplicationProtocol=tostring(app), DeviceEventCategory=tostring(cat), DestinationHostName=tostring(dhost), DestinationIP=tostring(dst), SourceIP=tostring(src), ReceivedBytes=tolong(in_bytes), EventOutcome=tostring(outcome), SentBytes=tolong(out), RequestURL=tostring(request), ReceiptTime=tostring(rt), SourceTranslatedAddress=tostring(sourceTranslatedAddress), RequestClientApplication=tostring(requestClientApplication), RequestMethod=tostring(requestMethod), SourceUserName=tostring(suser), SourceUserPrivileges=tostring(spriv), ExtID=tostring(externalId), FileType=tostring(fileType), Reason=tostring(reason), DestinationServiceName=tostring(destinationServiceName), DeviceCustomNumber1=toint(cn1), DeviceCustomNumber1Label=tostring(cn1Label), DeviceCustomString1=tostring(cs1), DeviceCustomString1Label=tostring(cs1Label), DeviceCustomString2=tostring(cs2), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString3=tostring(cs3), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString4=tostring(cs4), DeviceCustomString4Label=tostring(cs4Label), DeviceCustomString5=tostring(cs5), DeviceCustomString5Label=tostring(cs5Label), DeviceCustomString6=tostring(cs6), DeviceCustomString6Label=tostring(cs6Label), RequestContext=tostring(requestContext), FileName=tostring(fname), FileHash=tostring(fileHash), AdditionalExtensions = strcat(\"ZscalerNSSWeblogURLClass=\",ZscalerNSSWeblogURLClass,\";ZscalerNSSWeblogDLPDictionaries=\",ZscalerNSSWeblogDLPDictionaries,\";contenttype=\",contenttype,\";unscannabletype=\",unscannabletype,\";deviceowner=\",deviceowner,\";devicehostname=\",devicehostname,\";keyprotectiontype=\",keyprotectiontype,\";cloudname=\",cloudname,\";company=\",company,\";throttlereqsize=\",throttlereqsize,\";throttlerespsize=\",throttlerespsize,\";bwthrottle=\",bwthrottle,\";bwclassname=\",bwclassname,\";bwrulename=\",bwrulename,\";module=\",module,\";app_risk_score=\",app_risk_score,\";datacenter=\",datacenter,\";datacentercity=\",datacentercity,\";datacentercountry=\",datacentercountry,\";dlpdicthitcount=\",dlpdicthitcount,\";dlpidentifier=\",dlpidentifier,\";dlpmd5=\",dlpmd5,\";dlprulename=\",dlprulename,\";fileclass=\",fileclass,\";filesubtype=\",filesubtype,\";upload_fileclass=\",upload_fileclass,\";upload_filetype=\",upload_filetype,\";upload_filename=\",upload_filename,\";upload_filesubtype=\",upload_filesubtype,\";upload_doctypename=\",upload_doctypename,\";rdr_rulename=\",rdr_rulename,\";fwd_type=\",fwd_type,\";fwd_gw_name=\",fwd_gw_name,\";fwd_gw_ip=\",fwd_gw_ip,\";zpa_app_seg_name=\",zpa_app_seg_name,\";reqdatasize=\",reqdatasize,\";reqhdrsize=\",reqhdrsize,\";respdatasize=\",respdatasize,\";resphdrsize=\",resphdrsize,\";totalsize=\",totalsize,\";df_hosthead=\",df_hosthead,\";df_hostname=\",df_hostname,\";erefererhost=\",erefererhost,\";refererpath=\",refererpath,\";eurlpath=\",eurlpath,\";reqversion=\",reqversion,\";respversion=\",respversion,\";ua_token=\",ua_token,\";uaclass=\",uaclass,\";mobappname=\",mobappname,\";mobappcat=\",mobappcat,\";mobdevtype=\",mobdevtype,\";clt_sport=\",clt_sport,\";cpubip=\",cpubip,\";alpnprotocol=\",alpnprotocol,\";trafficredirectmethod=\",trafficredirectmethod,\";euserlocationname=\",euserlocationname,\";erulelabel=\",erulelabel,\";ruletype=\",ruletype,\";eurlfilterrulelabel=\",eurlfilterrulelabel,\";ourlfilterrulelabel=\",ourlfilterrulelabel,\";eapprulelabel=\",eapprulelabel,\";sha256=\",sha256,\";ssldecrypted=\",ssldecrypted,\";externalspr=\",externalspr,\";clientsslcipher=\",clientsslcipher,\";clienttlsversion=\",clienttlsversion,\";clientsslsessreuse=\",clientsslsessreuse,\";cltsslfailreason=\",cltsslfailreason,\";cltsslfailcount=\",cltsslfailcount,\";srvsslcipher=\",srvsslcipher,\";srvtlsversion=\",srvtlsversion,\";srvocspresult=\",srvocspresult,\";srvcertchainvalpass=\",srvcertchainvalpass,\";srvwildcardcert=\",srvwildcardcert,\";serversslsessreuse=\",serversslsessreuse,\";srvcertvalidationtype=\",srvcertvalidationtype,\";srvcertvalidityperiod=\",srvcertvalidityperiod,\";is_ssluntrustedca=\",is_ssluntrustedca,\";is_sslselfsigned=\",is_sslselfsigned,\";is_sslexpiredca=\",is_sslexpiredca,\";threatseverity=\",threatseverity,\";malwareclass=\",malwareclass,\";urlcatmethod=\",urlcatmethod,\";bypassed_traffic=\",bypassed_traffic,\";bypassed_etime=\",bypassed_etime,\";deviceappversion=\",deviceappversion,\";devicemodel=\",devicemodel,\";devicename=\",devicename,\";deviceostype=\",deviceostype,\";devicetype=\",devicetype,\";external_devid=\",external_devid,\";flow_type=\",flow_type,\";ztunnelversion=\",ztunnelversion,\";productversion=\",productversion,\";nsssvcip=\",nsssvcip)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSWebLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS Web Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA web log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIAWebLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSWeblog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSWeblog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - All Blocked Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSWeblog'\n | where DeviceEventClassID == 'Blocked'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSWeblog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSWeblog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Jamf Protect uses in a Microsoft Analytics Workspace, if the [data forwarding](https://docs.jamf.com/jamf-protect/documentation/Data_Forwarding_to_a_Third_Party_Storage_Solution.html?hl=sentinel#task-4227) option is enabled in Jamf Protect then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS Web Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS Web Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections1')]",
        "displayName": "Zscaler Internet Access Cloud NSS Web Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS Web Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSWebLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSWebLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_web_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition2'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition2')]",
        "displayName": "Zscaler Internet Access Cloud NSS Firewall Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition2'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSFWLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS Firewall Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA firewall log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIAFWLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSFWlog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSFWlog'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSFWlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSFWlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Jamf Protect uses in a Microsoft Analytics Workspace, if the [data forwarding](https://docs.jamf.com/jamf-protect/documentation/Data_Forwarding_to_a_Third_Party_Storage_Solution.html?hl=sentinel#task-4227) option is enabled in Jamf Protect then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS Firewall Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS Firewall Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition2')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition2'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition2')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections2')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSFWLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_fw_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      },
                      {
                        "name": "src",
                        "type": "string"
                      },
                      {
                        "name": "spt",
                        "type": "string"
                      },
                      {
                        "name": "dst",
                        "type": "string"
                      },
                      {
                        "name": "dpt",
                        "type": "string"
                      },
                      {
                        "name": "deviceTranslatedAddress",
                        "type": "string"
                      },
                      {
                        "name": "deviceTranslatedPort",
                        "type": "string"
                      },
                      {
                        "name": "destinationTranslatedAddress",
                        "type": "string"
                      },
                      {
                        "name": "destinationTranslatedPort",
                        "type": "string"
                      },
                      {
                        "name": "sourceTranslatedAddress",
                        "type": "string"
                      },
                      {
                        "name": "sourceTranslatedPort",
                        "type": "string"
                      },
                      {
                        "name": "proto",
                        "type": "string"
                      },
                      {
                        "name": "tunnelType",
                        "type": "string"
                      },
                      {
                        "name": "dnat",
                        "type": "string"
                      },
                      {
                        "name": "stateful",
                        "type": "string"
                      },
                      {
                        "name": "spriv",
                        "type": "string"
                      },
                      {
                        "name": "reason",
                        "type": "string"
                      },
                      {
                        "name": "in_bytes",
                        "type": "string"
                      },
                      {
                        "name": "out_bytes",
                        "type": "string"
                      },
                      {
                        "name": "deviceDirection",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "cs6",
                        "type": "string"
                      },
                      {
                        "name": "cs6label",
                        "type": "string"
                      },
                      {
                        "name": "cn1",
                        "type": "string"
                      },
                      {
                        "name": "cn1Label",
                        "type": "string"
                      },
                      {
                        "name": "cn2",
                        "type": "string"
                      },
                      {
                        "name": "cn2Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString1Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString1",
                        "type": "string"
                      },
                      {
                        "name": "destCountry",
                        "type": "string"
                      },
                      {
                        "name": "avgduration",
                        "type": "string"
                      },
                      {
                        "name": "epochtime",
                        "type": "string"
                      },
                      {
                        "name": "cdfqdn",
                        "type": "string"
                      },
                      {
                        "name": "srcip_country",
                        "type": "string"
                      },
                      {
                        "name": "cn3Label",
                        "type": "string"
                      },
                      {
                        "name": "cn3",
                        "type": "string"
                      },
                      {
                        "name": "flexString2Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString2",
                        "type": "string"
                      },
                      {
                        "name": "ipsrulelabel",
                        "type": "string"
                      },
                      {
                        "name": "ips_custom_signature",
                        "type": "string"
                      },
                      {
                        "name": "duration",
                        "type": "string"
                      },
                      {
                        "name": "dnatrulelabel",
                        "type": "string"
                      },
                      {
                        "name": "recordid",
                        "type": "string"
                      },
                      {
                        "name": "pcapid",
                        "type": "string"
                      },
                      {
                        "name": "eedone",
                        "type": "string"
                      },
                      {
                        "name": "shost",
                        "type": "string"
                      },
                      {
                        "name": "devicemodel",
                        "type": "string"
                      },
                      {
                        "name": "devicename",
                        "type": "string"
                      },
                      {
                        "name": "deviceostype",
                        "type": "string"
                      },
                      {
                        "name": "deviceosversion",
                        "type": "string"
                      },
                      {
                        "name": "deviceowner",
                        "type": "string"
                      },
                      {
                        "name": "deviceappversion",
                        "type": "string"
                      },
                      {
                        "name": "deviceExternalId",
                        "type": "string"
                      },
                      {
                        "name": "ztunnelversion",
                        "type": "string"
                      },
                      {
                        "name": "bypassed_session",
                        "type": "string"
                      },
                      {
                        "name": "bypass_etime",
                        "type": "string"
                      },
                      {
                        "name": "flow_type",
                        "type": "string"
                      },
                      {
                        "name": "datacenter",
                        "type": "string"
                      },
                      {
                        "name": "datacentercity",
                        "type": "string"
                      },
                      {
                        "name": "datacentercountry",
                        "type": "string"
                      },
                      {
                        "name": "rdr_rulename",
                        "type": "string"
                      },
                      {
                        "name": "zpa_app_seg_name",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_fw_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(Severity), Activity=tostring(name), DeviceEventClassID=tostring(deviceEventClassId), DeviceAction=tostring(act), SourceUserName=tostring(suser), SourceIP=tostring(src), SourcePort=toint(spt), DestinationIP=tostring(dst), DestinationPort=toint(dpt), DeviceTranslatedAddress=tostring(deviceTranslatedAddress), DestinationTranslatedAddress=tostring(destinationTranslatedAddress), DestinationTranslatedPort=toint(destinationTranslatedPort), SourceTranslatedAddress=tostring(sourceTranslatedAddress), SourceTranslatedPort=toint(sourceTranslatedPort), Protocol=tostring(proto), SourceUserPrivileges=tostring(spriv), Reason=tostring(reason), ReceivedBytes=tolong(in_bytes), SentBytes=tolong(out_bytes), CommunicationDirection=tostring(deviceDirection), DeviceCustomString1=tostring(cs1), DeviceCustomString1Label=tostring(cs1Label), DeviceCustomString2=tostring(cs2), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString3=tostring(cs3), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString4=tostring(cs4), DeviceCustomString4Label=tostring(cs4Label), DeviceCustomString5=tostring(cs5), DeviceCustomString5Label=tostring(cs5Label), DeviceCustomString6=tostring(cs6), DeviceCustomNumber1=toint(cn1), DeviceCustomNumber1Label=tostring(cn1Label), DeviceCustomNumber2=toint(cn2), DeviceCustomNumber2Label=tostring(cn2Label), FlexString1Label=tostring(flexString1Label), FlexString1=tostring(flexString1), DeviceCustomNumber3Label=tostring(cn3Label), DeviceCustomNumber3=toint(cn3), FlexString2Label=tostring(flexString2Label), FlexString2=tostring(flexString2), SourceHostName=tostring(shost), deviceExternalId=tostring(deviceExternalId), AdditionalExtensions = strcat(\"deviceTranslatedPort=\",deviceTranslatedPort,\";tunnelType=\",tunnelType,\";dnat=\",dnat,\";stateful=\",stateful,\";cs6label=\",cs6label,\";destCountry=\",destCountry,\";avgduration=\",avgduration,\";epochtime=\",epochtime,\";cdfqdn=\",cdfqdn,\";srcip_country=\",srcip_country,\";ipsrulelabel=\",ipsrulelabel,\";ips_custom_signature=\",ips_custom_signature,\";duration=\",duration,\";dnatrulelabel=\",dnatrulelabel,\";recordid=\",recordid,\";pcapid=\",pcapid,\";eedone=\",eedone,\";devicemodel=\",devicemodel,\";devicename=\",devicename,\";deviceostype=\",deviceostype,\";deviceosversion=\",deviceosversion,\";deviceowner=\",deviceowner,\";deviceappversion=\",deviceappversion,\";ztunnelversion=\",ztunnelversion,\";bypassed_session=\",bypassed_session,\";bypass_etime=\",bypass_etime,\";flow_type=\",flow_type,\";datacenter=\",datacenter,\";datacentercity=\",datacentercity,\";datacentercountry=\",datacentercountry,\";rdr_rulename=\",rdr_rulename,\";zpa_app_seg_name=\",zpa_app_seg_name)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition2'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition2'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSFWLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS Firewall Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA firewall log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIAFWLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSFWlog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSFWlog'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSFWlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSFWlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Jamf Protect uses in a Microsoft Analytics Workspace, if the [data forwarding](https://docs.jamf.com/jamf-protect/documentation/Data_Forwarding_to_a_Third_Party_Storage_Solution.html?hl=sentinel#task-4227) option is enabled in Jamf Protect then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS Firewall Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS Firewall Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition2')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition2'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition2')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections2')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections2'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections2')]",
        "displayName": "Zscaler Internet Access Cloud NSS Firewall Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS Firewall Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections2": "[variables('_dataConnectorContentIdConnections2')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections2')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections2'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections2')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSFWLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSFWLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_fw_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections2'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition3'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition3')]",
        "displayName": "Zscaler Internet Access Cloud NSS DNS Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition3'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSDNSLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS DNS Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA DNS log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIADNSLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSDNSlog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All DNS Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSDNSlog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - All Blocked DNS Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSDNSlog'\n | where DeviceEventClassID == 'Blocked'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSDNSlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSDNSlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS DNS Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS DNS Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition3')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition3'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition3')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections3')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSDNSLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_dns_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "cs6",
                        "type": "string"
                      },
                      {
                        "name": "cs6Label",
                        "type": "string"
                      },
                      {
                        "name": "cn1",
                        "type": "string"
                      },
                      {
                        "name": "cn1Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString1",
                        "type": "string"
                      },
                      {
                        "name": "flexString1Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString2",
                        "type": "string"
                      },
                      {
                        "name": "flexString2Label",
                        "type": "string"
                      },
                      {
                        "name": "cat",
                        "type": "string"
                      },
                      {
                        "name": "src",
                        "type": "string"
                      },
                      {
                        "name": "dst",
                        "type": "string"
                      },
                      {
                        "name": "dpt",
                        "type": "string"
                      },
                      {
                        "name": "spriv",
                        "type": "string"
                      },
                      {
                        "name": "suid",
                        "type": "string"
                      },
                      {
                        "name": "dvchost",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_dns_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), DeviceAction=tostring(act), LogSeverity=tostring(Severity), Activity=tostring(name), DeviceEventClassID=tostring(deviceEventClassId), SourceUserName=tostring(suser), DeviceCustomString1=tostring(cs1), DeviceCustomString1Label=tostring(cs1Label), DeviceCustomString2=tostring(cs2), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString3=tostring(cs3), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString4=tostring(cs4), DeviceCustomString4Label=tostring(cs4Label), DeviceCustomString5=tostring(cs5), DeviceCustomString5Label=tostring(cs5Label), DeviceCustomString6=tostring(cs6), DeviceCustomString6Label=tostring(cs6Label), DeviceCustomNumber1=toint(cn1), DeviceCustomNumber1Label=tostring(cn1Label), FlexString1=tostring(flexString1), FlexString1Label=tostring(flexString1Label), FlexString2=tostring(flexString2), FlexString2Label=tostring(flexString2Label), DeviceEventCategory=tostring(cat), SourceIP=tostring(src), DestinationIP=tostring(dst), DestinationPort=toint(dpt), SourceUserPrivileges=tostring(spriv), SourceUserID=tostring(suid), DeviceName=tostring(dvchost)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition3'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition3'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSDNSLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS DNS Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA DNS log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIADNSLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSDNSlog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All DNS Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSDNSlog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - All Blocked DNS Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSDNSlog'\n | where DeviceEventClassID == 'Blocked'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSDNSlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSDNSlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS DNS Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS DNS Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition3')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition3'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition3')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections3')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections3'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections3')]",
        "displayName": "Zscaler Internet Access Cloud NSS DNS Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS DNS Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections3": "[variables('_dataConnectorContentIdConnections3')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections3')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections3'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections3')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSDNSLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSDNSLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_dns_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections3'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition4'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition4')]",
        "displayName": "Zscaler Internet Access Cloud NSS Tunnel Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition4'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSTunnelLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS Tunnel Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA tunnel log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIATunnelLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSTunnellog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All Tunnel Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSTunnellog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - Tunnel Events",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSTunnellog'\n | where DeviceEventClassID == 'Tunnel Event'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - IPSec Phase1 Events",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSTunnellog'\n | where DeviceEventClassID == 'IPSec Phase1'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - IPSec Phase2 Events",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSTunnellog'\n | where DeviceEventClassID == 'IPSec Phase2'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSTunnellog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSTunnellog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS Tunnel Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS Tunnel Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition4')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition4'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition4')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections4')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSTunnelLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_tunnel_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "cfp1Label",
                        "type": "string"
                      },
                      {
                        "name": "severity",
                        "type": "string"
                      },
                      {
                        "name": "cfp1",
                        "type": "string"
                      },
                      {
                        "name": "cn1",
                        "type": "string"
                      },
                      {
                        "name": "cn1Label",
                        "type": "string"
                      },
                      {
                        "name": "cn2",
                        "type": "string"
                      },
                      {
                        "name": "cn2Label",
                        "type": "string"
                      },
                      {
                        "name": "cn3",
                        "type": "string"
                      },
                      {
                        "name": "cn3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "destipend",
                        "type": "string"
                      },
                      {
                        "name": "destipstart",
                        "type": "string"
                      },
                      {
                        "name": "destportstart",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "deviceExternalId",
                        "type": "string"
                      },
                      {
                        "name": "dpdrec",
                        "type": "string"
                      },
                      {
                        "name": "dpt",
                        "type": "string"
                      },
                      {
                        "name": "dst",
                        "type": "string"
                      },
                      {
                        "name": "dtz",
                        "type": "string"
                      },
                      {
                        "name": "inbytes",
                        "type": "string"
                      },
                      {
                        "name": "lifebytes",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "olocationname",
                        "type": "string"
                      },
                      {
                        "name": "out",
                        "type": "string"
                      },
                      {
                        "name": "ovpncredentialname",
                        "type": "string"
                      },
                      {
                        "name": "proto",
                        "type": "string"
                      },
                      {
                        "name": "reason",
                        "type": "string"
                      },
                      {
                        "name": "spi",
                        "type": "string"
                      },
                      {
                        "name": "spi_in",
                        "type": "string"
                      },
                      {
                        "name": "spi_out",
                        "type": "string"
                      },
                      {
                        "name": "spt",
                        "type": "string"
                      },
                      {
                        "name": "src",
                        "type": "string"
                      },
                      {
                        "name": "srcipend",
                        "type": "string"
                      },
                      {
                        "name": "srcipstart",
                        "type": "string"
                      },
                      {
                        "name": "srcportstart",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      },
                      {
                        "name": "vendorname",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_tunnel_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(severity), Activity=tostring(name),DeviceEventClassID=tostring(deviceEventClassId), DeviceExternalID=tostring(deviceExternalId), DestinationPort=toint(dpt), DestinationIP=tostring(dst), DeviceTimeZone=tostring(dtz), ReceivedBytes=tolong(inbytes), SentBytes=tolong(out), Protocol=tostring(proto), Reason=tostring(reason), SourcePort=toint(spt), SourceIP=tostring(src), SourceUserName=tostring(suser), DeviceCustomFloatingPoint1=toreal(cfp1), DeviceCustomFloatingPoint1Label=tostring(cfp1Label), DeviceCustomNumber1=toint(cn1), DeviceCustomNumber1Label=tostring(cn1Label), DeviceCustomNumber2=toint(cn2), DeviceCustomNumber2Label=tostring(cn2Label), DeviceCustomNumber3=toint(cn3), DeviceCustomNumber3Label=tostring(cn3Label), DeviceCustomString1=tostring(cs1), DeviceCustomString1Label=tostring(cs1Label), DeviceCustomString2=tostring(cs2), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString3=tostring(cs3), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString4=tostring(cs4), DeviceCustomString4Label=tostring(cs4Label), DeviceCustomString5=tostring(cs5), DeviceCustomString5Label=tostring(cs5Label), AdditionalExtensions = case(deviceEventClassId == \"Tunnel Samples\", strcat(\"dpdrec=\",dpdrec,\";olocationname=\", olocationname, \";ovpncredentialname=\", ovpncredentialname), deviceEventClassId == \"Tunnel Event\", strcat(\"olocationname=\",olocationname,\";ovpncredentialname=\",ovpncredentialname), deviceEventClassId == \"IPSec Phase2\", strcat(\"destipstart=\",destipstart,\";srcipend=\",srcipend,\";srcipstart=\",srcipstart,\";destportstart=\",destportstart,\";lifebytes=\",lifebytes,\";spi=\",spi,\";srcportstart=\",srcportstart,\";destipend=\",destipend), strcat(\"spi_in=\",spi_in,\";spi_out=\",spi_out,\";vendorname=\",vendorname,\";olocationname=\",olocationname,\";ovpncredentialname=\",ovpncredentialname))",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition4'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition4'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSTunnelLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS Tunnel Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA tunnel log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIATunnelLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSTunnellog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All Tunnel Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSTunnellog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - Tunnel Events",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSTunnellog'\n | where DeviceEventClassID == 'Tunnel Event'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - IPSec Phase1 Events",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSTunnellog'\n | where DeviceEventClassID == 'IPSec Phase1'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - IPSec Phase2 Events",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSTunnellog'\n | where DeviceEventClassID == 'IPSec Phase2'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSTunnellog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSTunnellog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS Tunnel Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS Tunnel Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition4')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition4'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition4')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections4')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections4'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections4')]",
        "displayName": "Zscaler Internet Access Cloud NSS Tunnel Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS Tunnel Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections4": "[variables('_dataConnectorContentIdConnections4')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections4')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections4'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections4')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSTunnelLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSTunnelLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_tunnel_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections4'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition5'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition5')]",
        "displayName": "Zscaler Internet Access Cloud NSS Endpoint DLP Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition5'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSEndpointDLPLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS Endpoint DLP Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA Endpoint DLP log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIAEndpointDLPLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSEndpointDLPlog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All Endpoint DLP Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSEndpointDLPlog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - Endpoint DLP Blocked Actions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSEndpointDLPlog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSEndpointDLPlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSEndpointDLPlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS Endpoint DLP Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS Endpoint DLP Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition5')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition5'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition5')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections5')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSEndpointDLPLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_endpointdlp_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "rt",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1Label",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate2Label",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate2",
                        "type": "string"
                      },
                      {
                        "name": "dtz",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomNumber1Label",
                        "type": "string"
                      },
                      {
                        "name": "cn1",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomNumber2Label",
                        "type": "string"
                      },
                      {
                        "name": "cn2",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomNumber3Label",
                        "type": "string"
                      },
                      {
                        "name": "cn3",
                        "type": "string"
                      },
                      {
                        "name": "externalId",
                        "type": "string"
                      },
                      {
                        "name": "scanned_bytes",
                        "type": "string"
                      },
                      {
                        "name": "dlpidentifier",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      },
                      {
                        "name": "ouser",
                        "type": "string"
                      },
                      {
                        "name": "department",
                        "type": "string"
                      },
                      {
                        "name": "odepartment",
                        "type": "string"
                      },
                      {
                        "name": "devicename",
                        "type": "string"
                      },
                      {
                        "name": "odevicename",
                        "type": "string"
                      },
                      {
                        "name": "devicetype",
                        "type": "string"
                      },
                      {
                        "name": "deviceostype",
                        "type": "string"
                      },
                      {
                        "name": "deviceplatform",
                        "type": "string"
                      },
                      {
                        "name": "deviceosversion",
                        "type": "string"
                      },
                      {
                        "name": "devicemodel",
                        "type": "string"
                      },
                      {
                        "name": "deviceappversion",
                        "type": "string"
                      },
                      {
                        "name": "deviceowner",
                        "type": "string"
                      },
                      {
                        "name": "odeviceowner",
                        "type": "string"
                      },
                      {
                        "name": "dvchost",
                        "type": "string"
                      },
                      {
                        "name": "odevicehostname",
                        "type": "string"
                      },
                      {
                        "name": "datacenter",
                        "type": "string"
                      },
                      {
                        "name": "datacentercity",
                        "type": "string"
                      },
                      {
                        "name": "datacentercountry",
                        "type": "string"
                      },
                      {
                        "name": "dsttype",
                        "type": "string"
                      },
                      {
                        "name": "filedoctype",
                        "type": "string"
                      },
                      {
                        "name": "filedstpath",
                        "type": "string"
                      },
                      {
                        "name": "fileHash",
                        "type": "string"
                      },
                      {
                        "name": "filesha",
                        "type": "string"
                      },
                      {
                        "name": "filePath",
                        "type": "string"
                      },
                      {
                        "name": "filetypecategory",
                        "type": "string"
                      },
                      {
                        "name": "fileType",
                        "type": "string"
                      },
                      {
                        "name": "itemdstname",
                        "type": "string"
                      },
                      {
                        "name": "itemname",
                        "type": "string"
                      },
                      {
                        "name": "itemsrcname",
                        "type": "string"
                      },
                      {
                        "name": "itemtype",
                        "type": "string"
                      },
                      {
                        "name": "ofiledstpath",
                        "type": "string"
                      },
                      {
                        "name": "ofilesrcpath",
                        "type": "string"
                      },
                      {
                        "name": "oitemdstname",
                        "type": "string"
                      },
                      {
                        "name": "oitemname",
                        "type": "string"
                      },
                      {
                        "name": "oitemsrcname",
                        "type": "string"
                      },
                      {
                        "name": "sourceServiceName",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "cs6Label",
                        "type": "string"
                      },
                      {
                        "name": "cs6",
                        "type": "string"
                      },
                      {
                        "name": "dlpdictnames",
                        "type": "string"
                      },
                      {
                        "name": "dlpengnames",
                        "type": "string"
                      },
                      {
                        "name": "expectedaction",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "odlpdictnames",
                        "type": "string"
                      },
                      {
                        "name": "odlpengnames",
                        "type": "string"
                      },
                      {
                        "name": "ootherrulelabels",
                        "type": "string"
                      },
                      {
                        "name": "otherrulelabels",
                        "type": "string"
                      },
                      {
                        "name": "otriggeredrulelabel",
                        "type": "string"
                      },
                      {
                        "name": "agentSeverity",
                        "type": "string"
                      },
                      {
                        "name": "triggeredrulelabel",
                        "type": "string"
                      },
                      {
                        "name": "zdpmode",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_endpointdlp_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(Severity), Activity=tostring(name), ReceiptTime=tostring(rt), DeviceCustomDate1Label=tostring(deviceCustomDate1Label), DeviceCustomDate1=tostring(deviceCustomDate1), DeviceCustomDate2Label=tostring(deviceCustomDate2Label), DeviceCustomDate2=tostring(deviceCustomDate2), DeviceTimeZone=tostring(dtz), DeviceCustomNumber1=toint(cn1), DeviceCustomNumber2=toint(cn2), DeviceCustomNumber3=toint(cn3), ExternalID=toint(externalId), SourceUserName=tostring(suser), DeviceName=tostring(dvchost), FileHash=tostring(fileHash), FilePath=tostring(filePath), FileType=tostring(fileType), SourceServiceName=tostring(sourceServiceName), DeviceAction=tostring(act), DeviceCustomString1Label=tostring(cs1Label), DeviceCustomString1=tostring(cs1), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString2=tostring(cs2), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString3=tostring(cs3), DeviceCustomString4Label=tostring(cs4Label), DeviceCustomString4=tostring(cs4), DeviceCustomString5Label=tostring(cs5Label), DeviceCustomString5=tostring(cs5), DeviceCustomString6Label=tostring(cs6Label), DeviceCustomString6=tostring(cs6), DeviceEventClassID=tostring(deviceEventClassId), AdditionalExtensions = strcat(\"deviceCustomNumber1Label=\",deviceCustomNumber1Label,\";deviceCustomNumber2Label=\",deviceCustomNumber2Label,\";deviceCustomNumber3Label=\",deviceCustomNumber3Label,\";scanned_bytes=\",scanned_bytes,\";dlpidentifier=\",dlpidentifier,\";ouser=\",ouser,\";department=\",department,\";odepartment=\",odepartment,\";devicename=\",devicename,\";odevicename=\",odevicename,\";devicetype=\",devicetype,\";deviceostype=\",deviceostype,\";deviceplatform=\",deviceplatform,\";deviceosversion=\",deviceosversion,\";devicemodel=\",devicemodel,\";deviceappversion=\",deviceappversion,\";deviceowner=\",deviceowner,\";odeviceowner=\",odeviceowner,\";odevicehostname=\",odevicehostname,\";datacenter=\",datacenter,\";datacentercity=\",datacentercity,\";datacentercountry=\",datacentercountry,\";dsttype=\",dsttype,\";filedoctype=\",filedoctype,\";filedstpath=\",filedstpath,\";filesha=\",filesha,\";filetypecategory=\",filetypecategory,\";itemdstname=\",itemdstname,\";itemname=\",itemname,\";itemsrcname=\",itemsrcname,\";itemtype=\",itemtype,\";ofiledstpath=\",ofiledstpath,\";ofilesrcpath=\",ofilesrcpath,\";oitemdstname=\",oitemdstname,\";oitemname=\",oitemname,\";oitemsrcname=\",oitemsrcname,\";dlpdictnames=\",dlpdictnames,\";dlpengnames=\",dlpengnames,\";expectedaction=\",expectedaction,\";odlpdictnames=\",odlpdictnames,\";odlpengnames=\",odlpengnames,\";ootherrulelabels=\",ootherrulelabels,\";otherrulelabels=\",otherrulelabels,\";otriggeredrulelabel=\",otriggeredrulelabel,\";agentSeverity=\",agentSeverity,\";triggeredrulelabel=\",triggeredrulelabel,\";zdpmode=\",zdpmode)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition5'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition5'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSEndpointDLPLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS Endpoint DLP Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA Endpoint DLP log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIAEndpointDLPLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSEndpointDLPlog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All Endpoint DLP Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSEndpointDLPlog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - Endpoint DLP Blocked Actions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSEndpointDLPlog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSEndpointDLPlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSEndpointDLPlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS Endpoint DLP Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS Endpoint DLP Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition5')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition5'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition5')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections5')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections5'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections5')]",
        "displayName": "Zscaler Internet Access Cloud NSS Endpoint DLP Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS Endpoint DLP Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections5": "[variables('_dataConnectorContentIdConnections5')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections5')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections5'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections5')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSEndpointDLPLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSEndpointDLPLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_endpointdlp_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections5'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition6'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition6')]",
        "displayName": "Zscaler Internet Access Cloud NSS Email DLP Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition6'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSEmailDLPLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS Email DLP Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA Email DLP log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIAEmailDLPLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSEmailDLPlog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All Email DLP Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSEmailDLPlog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - Email DLP Blocked Actions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSEmailDLPlog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSEmailDLPlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSEmailDLPlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS Email DLP Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS Email DLP Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition6')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition6'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition6')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections6')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSEmailDLPLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_emaildlp_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "agentSeverity",
                        "type": "string"
                      },
                      {
                        "name": "app",
                        "type": "string"
                      },
                      {
                        "name": "cn1",
                        "type": "string"
                      },
                      {
                        "name": "cn1Label",
                        "type": "string"
                      },
                      {
                        "name": "cn2",
                        "type": "string"
                      },
                      {
                        "name": "cn2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "cs6",
                        "type": "string"
                      },
                      {
                        "name": "cs6Label",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      },
                      {
                        "name": "username",
                        "type": "string"
                      },
                      {
                        "name": "extusername",
                        "type": "string"
                      },
                      {
                        "name": "sender",
                        "type": "string"
                      },
                      {
                        "name": "flexString1",
                        "type": "string"
                      },
                      {
                        "name": "flexString1Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString2",
                        "type": "string"
                      },
                      {
                        "name": "flexString2Label",
                        "type": "string"
                      },
                      {
                        "name": "datacenter",
                        "type": "string"
                      },
                      {
                        "name": "datacentercity",
                        "type": "string"
                      },
                      {
                        "name": "datacentercountry",
                        "type": "string"
                      },
                      {
                        "name": "company",
                        "type": "string"
                      },
                      {
                        "name": "departmentname",
                        "type": "string"
                      },
                      {
                        "name": "tenant",
                        "type": "string"
                      },
                      {
                        "name": "msgid",
                        "type": "string"
                      },
                      {
                        "name": "ac_md5s",
                        "type": "string"
                      },
                      {
                        "name": "ac_sizes",
                        "type": "string"
                      },
                      {
                        "name": "ac_filetypes",
                        "type": "string"
                      },
                      {
                        "name": "ac_doctypes",
                        "type": "string"
                      },
                      {
                        "name": "ac_names",
                        "type": "string"
                      },
                      {
                        "name": "trigg_rcpts",
                        "type": "string"
                      },
                      {
                        "name": "other_rcpts",
                        "type": "string"
                      },
                      {
                        "name": "deviceExternalId",
                        "type": "string"
                      },
                      {
                        "name": "Name",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_emaildlp_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(Severity), DeviceAction=tostring(act), DeviceEventClassID=tostring(deviceEventClassId), ApplicationProtocol=tostring(app), FieldDeviceCustomNumber1=tolong(cn1), DeviceCustomNumber1Label=tostring(cn1Label), FieldDeviceCustomNumber2=tolong(cn2), DeviceCustomNumber2Label=tostring(cn2Label), DeviceCustomString1=tostring(cs1), DeviceCustomString1Label=tostring(cs1Label), DeviceCustomString2=tostring(cs2), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString3=tostring(cs3), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString4=tostring(cs4), DeviceCustomString4Label=tostring(cs4Label), DeviceCustomString5=tostring(cs5), DeviceCustomString5Label=tostring(cs5Label), DeviceCustomString6=tostring(cs6), DeviceCustomString6Label=tostring(cs6Label), SourceUserName=tostring(suser), FlexString1=tostring(flexString1), FlexString1Label=tostring(flexString1Label), FlexString2=tostring(flexString2), FlexString2Label=tostring(flexString2Label), DeviceExternalID=tostring(deviceExternalId), Activity=tostring(Name), AdditionalExtensions = strcat(\"agentSeverity=\",agentSeverity,\";username=\",username,\";extusername=\",extusername,\";sender=\",sender,\";datacenter=\",datacenter,\";datacentercity=\",datacentercity,\";datacentercountry=\",datacentercountry,\";company=\",company,\";departmentname=\",departmentname,\";tenant=\",tenant,\";msgid=\",msgid,\";ac_md5s=\",ac_md5s,\";ac_sizes=\",ac_sizes,\";ac_filetypes=\",ac_filetypes,\";ac_doctypes=\",ac_doctypes,\";ac_names=\",ac_names,\";trigg_rcpts=\",trigg_rcpts,\";other_rcpts=\",other_rcpts)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition6'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition6'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSEmailDLPLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS Email DLP Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA Email DLP log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIAEmailDLPLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSEmailDLPlog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All Email DLP Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSEmailDLPlog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - Email DLP Blocked Actions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSEmailDLPlog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSEmailDLPlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSEmailDLPlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS Email DLP Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS Email DLP Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition6')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition6'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition6')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections6')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections6'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections6')]",
        "displayName": "Zscaler Internet Access Cloud NSS Email DLP Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS Email DLP Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections6": "[variables('_dataConnectorContentIdConnections6')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections6')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections6'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections6')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSEmailDLPLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSEmailDLPLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_emaildlp_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections6'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition7'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition7')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB Repo Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition7'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSCASBRepoLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS CASB Repo Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB Repository log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIACASBRepoLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBRepolog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All CASB Repo Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBRepolog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - CASB Repo Blocked Actions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBRepolog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBRepolog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBRepolog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS CASB Repo Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB Repo Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition7')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition7'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition7')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections7')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSCASBRepoLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_casbrepo_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "start",
                        "type": "string"
                      },
                      {
                        "name": "fsize",
                        "type": "string"
                      },
                      {
                        "name": "cn1",
                        "type": "string"
                      },
                      {
                        "name": "cn1Label",
                        "type": "string"
                      },
                      {
                        "name": "deviceExternalId",
                        "type": "string"
                      },
                      {
                        "name": "company",
                        "type": "string"
                      },
                      {
                        "name": "datacenter",
                        "type": "string"
                      },
                      {
                        "name": "datacentercity",
                        "type": "string"
                      },
                      {
                        "name": "datacentercountry",
                        "type": "string"
                      },
                      {
                        "name": "department",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "external_collabnames",
                        "type": "string"
                      },
                      {
                        "name": "extownername",
                        "type": "string"
                      },
                      {
                        "name": "fileId",
                        "type": "string"
                      },
                      {
                        "name": "fileHash",
                        "type": "string"
                      },
                      {
                        "name": "fname",
                        "type": "string"
                      },
                      {
                        "name": "filePath",
                        "type": "string"
                      },
                      {
                        "name": "fileType",
                        "type": "string"
                      },
                      {
                        "name": "flexString1Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString1",
                        "type": "string"
                      },
                      {
                        "name": "flexString2Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString2",
                        "type": "string"
                      },
                      {
                        "name": "odlpdictnames",
                        "type": "string"
                      },
                      {
                        "name": "odlpenginenames",
                        "type": "string"
                      },
                      {
                        "name": "oexternal_collabnames",
                        "type": "string"
                      },
                      {
                        "name": "oextownername",
                        "type": "string"
                      },
                      {
                        "name": "ofileid",
                        "type": "string"
                      },
                      {
                        "name": "oowner",
                        "type": "string"
                      },
                      {
                        "name": "orulelabel",
                        "type": "string"
                      },
                      {
                        "name": "otenant",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      },
                      {
                        "name": "projectname",
                        "type": "string"
                      },
                      {
                        "name": "reponame",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "cs6",
                        "type": "string"
                      },
                      {
                        "name": "cs6Label",
                        "type": "string"
                      },
                      {
                        "name": "agentSeverity",
                        "type": "string"
                      },
                      {
                        "name": "tenant",
                        "type": "string"
                      },
                      {
                        "name": "threatname",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1Label",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1",
                        "type": "string"
                      },
                      {
                        "name": "dtz",
                        "type": "string"
                      },
                      {
                        "name": "upload_doctypename",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_casbrepo_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(Severity), Activity=tostring(name), DeviceEventClassID=tostring(deviceEventClassId), DeviceAction=tostring(act), DeviceCustomString1=tostring(cs1), DeviceCustomString1Label=tostring(cs1Label), FileSize=toint(fsize), DeviceCustomNumber1=toint(cn1), DeviceCustomNumber1Label=tostring(cn1Label), deviceExternalId=tostring(deviceExternalId), DeviceCustomString2=tostring(cs2), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString3=tostring(cs3), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString4=tostring(cs4), DeviceCustomString4Label=tostring(cs4Label), FileID=tostring(fileId), FileHash=tostring(fileHash), FileName=tostring(fname), FilePath=tostring(filePath), FileType=tostring(fileType), FlexString1Label=tostring(flexString1Label), FlexString1=tostring(flexString1), FlexString2Label=tostring(flexString2Label), FlexString2=tostring(flexString2), SourceUserName=tostring(suser), DeviceCustomString5=tostring(cs5), DeviceCustomString5Label=tostring(cs5Label), DeviceCustomString6=tostring(cs6), DeviceCustomString6Label=tostring(cs6Label), DeviceCustomDate1Label=tostring(deviceCustomDate1Label), DeviceCustomDate1=tostring(deviceCustomDate1), DeviceTimeZone=tostring(dtz), AdditionalExtensions = strcat(\"start=\",start,\";company=\",company,\";datacenter=\",datacenter,\";datacentercity=\",datacentercity,\";datacentercountry=\",datacentercountry,\";department=\",department,\";external_collabnames=\",external_collabnames,\";extownername=\",extownername,\";odlpdictnames=\",odlpdictnames,\";odlpenginenames=\",odlpenginenames,\";oexternal_collabnames=\",oexternal_collabnames,\";oextownername=\",oextownername,\";ofileid=\",ofileid,\";oowner=\",oowner,\";orulelabel=\",orulelabel,\";otenant=\",otenant,\";projectname=\",projectname,\";reponame=\",reponame,\";agentSeverity=\",agentSeverity,\";tenant=\",tenant,\";threatname=\",threatname,\";upload_doctypename=\",upload_doctypename)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition7'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition7'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSCASBRepoLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS CASB Repo Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB Repository log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIACASBRepoLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBRepolog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All CASB Repo Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBRepolog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - CASB Repo Blocked Actions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBRepolog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBRepolog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBRepolog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS CASB Repo Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB Repo Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition7')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition7'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition7')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections7')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections7'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections7')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB Repo Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS CASB Repo Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections7": "[variables('_dataConnectorContentIdConnections7')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections7')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections7'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections7')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSCASBRepoLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSCASBRepoLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_casbrepo_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections7'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition8'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition8')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB ITSM Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition8'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSCASBITSMLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS CASB ITSM Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB ITSM log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIACASBITSMLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBITSMlog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All CASB ITSM Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBITSMlog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - CASB ITSM Blocked Actions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBITSMlog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBITSMlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBITSMlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS CASB ITSM Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB ITSM Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition8')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition8'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition8')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections8')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSCASBITSMLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_casbitsm_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "start",
                        "type": "string"
                      },
                      {
                        "name": "fsize",
                        "type": "string"
                      },
                      {
                        "name": "cn1",
                        "type": "string"
                      },
                      {
                        "name": "cn1Label",
                        "type": "string"
                      },
                      {
                        "name": "cn2",
                        "type": "string"
                      },
                      {
                        "name": "cn2Label",
                        "type": "string"
                      },
                      {
                        "name": "deviceExternalId",
                        "type": "string"
                      },
                      {
                        "name": "company",
                        "type": "string"
                      },
                      {
                        "name": "component",
                        "type": "string"
                      },
                      {
                        "name": "datacenter",
                        "type": "string"
                      },
                      {
                        "name": "datacentercity",
                        "type": "string"
                      },
                      {
                        "name": "datacentercountry",
                        "type": "string"
                      },
                      {
                        "name": "department",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "external_collabnames",
                        "type": "string"
                      },
                      {
                        "name": "extownername",
                        "type": "string"
                      },
                      {
                        "name": "fileId",
                        "type": "string"
                      },
                      {
                        "name": "fileModificationTime",
                        "type": "string"
                      },
                      {
                        "name": "fileHash",
                        "type": "string"
                      },
                      {
                        "name": "fname",
                        "type": "string"
                      },
                      {
                        "name": "filePath",
                        "type": "string"
                      },
                      {
                        "name": "fileType",
                        "type": "string"
                      },
                      {
                        "name": "request",
                        "type": "string"
                      },
                      {
                        "name": "dhost",
                        "type": "string"
                      },
                      {
                        "name": "internal_collabnames",
                        "type": "string"
                      },
                      {
                        "name": "flexString1Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString1",
                        "type": "string"
                      },
                      {
                        "name": "flexString2Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString2",
                        "type": "string"
                      },
                      {
                        "name": "objectname",
                        "type": "string"
                      },
                      {
                        "name": "objecttype",
                        "type": "string"
                      },
                      {
                        "name": "odlpdictnames",
                        "type": "string"
                      },
                      {
                        "name": "odlpenginenames",
                        "type": "string"
                      },
                      {
                        "name": "oexternal_collabnames",
                        "type": "string"
                      },
                      {
                        "name": "oextownername",
                        "type": "string"
                      },
                      {
                        "name": "ofile_msg_id",
                        "type": "string"
                      },
                      {
                        "name": "ofullurl",
                        "type": "string"
                      },
                      {
                        "name": "ohostname",
                        "type": "string"
                      },
                      {
                        "name": "ointernal_collabnames",
                        "type": "string"
                      },
                      {
                        "name": "oowner",
                        "type": "string"
                      },
                      {
                        "name": "orulelabel",
                        "type": "string"
                      },
                      {
                        "name": "otenant",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "cs6",
                        "type": "string"
                      },
                      {
                        "name": "cs6Label",
                        "type": "string"
                      },
                      {
                        "name": "agentSeverity",
                        "type": "string"
                      },
                      {
                        "name": "tenant",
                        "type": "string"
                      },
                      {
                        "name": "threatname",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1Label",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1",
                        "type": "string"
                      },
                      {
                        "name": "dtz",
                        "type": "string"
                      },
                      {
                        "name": "upload_doctypename",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_casbitsm_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(Severity), Activity=tostring(name), DeviceEventClassID=tostring(deviceEventClassId), DeviceAction=tostring(act), DeviceCustomString1=tostring(cs1), DeviceCustomString1Label=tostring(cs1Label), FileSize=toint(fsize), DeviceCustomNumber1=toint(cn1), DeviceCustomNumber1Label=tostring(cn1Label), DeviceCustomNumber2=toint(cn2), DeviceCustomNumber2Label=tostring(cn2Label), deviceExternalId=tostring(deviceExternalId), DeviceCustomString2=tostring(cs2), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString3=tostring(cs3), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString4=tostring(cs4), DeviceCustomString4Label=tostring(cs4Label), FileID=tostring(fileId), FileModificationTime=tostring(fileModificationTime), FileHash=tostring(fileHash), FileName=tostring(fname), FilePath=tostring(filePath), FileType=tostring(fileType), DestinationHostName=tostring(dhost), FlexString1Label=tostring(flexString1Label), FlexString1=tostring(flexString1), FlexString2Label=tostring(flexString2Label), FlexString2=tostring(flexString2), SourceUserName=tostring(suser), DeviceCustomString5=tostring(cs5), DeviceCustomString5Label=tostring(cs5Label), DeviceCustomString6=tostring(cs6), DeviceCustomString6Label=tostring(cs6Label), DeviceCustomDate1Label=tostring(deviceCustomDate1Label), DeviceCustomDate1=tostring(deviceCustomDate1), DeviceTimeZone=tostring(dtz), AdditionalExtensions = strcat(\"start=\",start,\";company=\",company,\";component=\",component,\";datacenter=\",datacenter,\";datacentercity=\",datacentercity,\";datacentercountry=\",datacentercountry,\";department=\",department,\";external_collabnames=\",external_collabnames,\";extownername=\",extownername,\";request=\",request,\";internal_collabnames=\",internal_collabnames,\";objectname=\",objectname,\";objecttype=\",objecttype,\";odlpdictnames=\",odlpdictnames,\";odlpenginenames=\",odlpenginenames,\";oexternal_collabnames=\",oexternal_collabnames,\";oextownername=\",oextownername,\";ofile_msg_id=\",ofile_msg_id,\";ofullurl=\",ofullurl,\";ohostname=\",ohostname,\";ointernal_collabnames=\",ointernal_collabnames,\";oowner=\",oowner,\";orulelabel=\",orulelabel,\";otenant=\",otenant,\";agentSeverity=\",agentSeverity,\";tenant=\",tenant,\";threatname=\",threatname,\";upload_doctypename=\",upload_doctypename)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition8'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition8'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSCASBITSMLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS CASB ITSM Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB ITSM log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIACASBITSMLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBITSMlog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All CASB ITSM Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBITSMlog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - CASB ITSM Blocked Actions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBITSMlog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBITSMlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBITSMlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS CASB ITSM Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB ITSM Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition8')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition8'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition8')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections8')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections8'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections8')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB ITSM Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS CASB ITSM Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections8": "[variables('_dataConnectorContentIdConnections8')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections8')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections8'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections8')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSCASBITSMLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSCASBITSMLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_casbitsm_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections8'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition9'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition9')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB File Sharing Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition9'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSCASBFileSharingLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS CASB File Sharing Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB File Sharing log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIACASBFileSharingLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBFileSharinglog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All CASB File Sharing Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBFileSharinglog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - CASB File Sharing Blocked Actions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBFileSharinglog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBFileSharinglog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBFileSharinglog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS CASB File Sharing Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB File Sharing Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition9')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition9'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition9')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections9')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSCASBFileSharingLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_casbfilesharing_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "fileModificationTime",
                        "type": "string"
                      },
                      {
                        "name": "start",
                        "type": "string"
                      },
                      {
                        "name": "filedownloadtimems",
                        "type": "string"
                      },
                      {
                        "name": "filescantimems",
                        "type": "string"
                      },
                      {
                        "name": "fsize",
                        "type": "string"
                      },
                      {
                        "name": "deviceExternalId",
                        "type": "string"
                      },
                      {
                        "name": "collabscope",
                        "type": "string"
                      },
                      {
                        "name": "company",
                        "type": "string"
                      },
                      {
                        "name": "datacenter",
                        "type": "string"
                      },
                      {
                        "name": "datacentercity",
                        "type": "string"
                      },
                      {
                        "name": "datacentercountry",
                        "type": "string"
                      },
                      {
                        "name": "department",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "extcollabnames",
                        "type": "string"
                      },
                      {
                        "name": "extownername",
                        "type": "string"
                      },
                      {
                        "name": "fileId",
                        "type": "string"
                      },
                      {
                        "name": "fileHash",
                        "type": "string"
                      },
                      {
                        "name": "fname",
                        "type": "string"
                      },
                      {
                        "name": "filePath",
                        "type": "string"
                      },
                      {
                        "name": "fileType",
                        "type": "string"
                      },
                      {
                        "name": "request",
                        "type": "string"
                      },
                      {
                        "name": "dhost",
                        "type": "string"
                      },
                      {
                        "name": "intcollabnames",
                        "type": "string"
                      },
                      {
                        "name": "flexString1Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString1",
                        "type": "string"
                      },
                      {
                        "name": "flexString2Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString2",
                        "type": "string"
                      },
                      {
                        "name": "odlpdictnames",
                        "type": "string"
                      },
                      {
                        "name": "odlpenginenames",
                        "type": "string"
                      },
                      {
                        "name": "oextcollabnames",
                        "type": "string"
                      },
                      {
                        "name": "oextownername",
                        "type": "string"
                      },
                      {
                        "name": "ofileid",
                        "type": "string"
                      },
                      {
                        "name": "efullurl",
                        "type": "string"
                      },
                      {
                        "name": "ehostname",
                        "type": "string"
                      },
                      {
                        "name": "ointcollabnames",
                        "type": "string"
                      },
                      {
                        "name": "orulelabel",
                        "type": "string"
                      },
                      {
                        "name": "otenant",
                        "type": "string"
                      },
                      {
                        "name": "ouser",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "cs6",
                        "type": "string"
                      },
                      {
                        "name": "cs6Label",
                        "type": "string"
                      },
                      {
                        "name": "agentSeverity",
                        "type": "string"
                      },
                      {
                        "name": "tenant",
                        "type": "string"
                      },
                      {
                        "name": "threatname",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1Label",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1",
                        "type": "string"
                      },
                      {
                        "name": "dtz",
                        "type": "string"
                      },
                      {
                        "name": "upload_doctypename",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_casbfilesharing_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(Severity), Activity=tostring(name), DeviceEventClassID=tostring(deviceEventClassId), DeviceAction=tostring(act), DeviceCustomString1=tostring(cs1), DeviceCustomString1Label=tostring(cs1Label), FileModificationTime=tostring(fileModificationTime), FileSize=toint(fsize), deviceExternalId=tostring(deviceExternalId), DeviceCustomString2=tostring(cs2), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString3=tostring(cs3), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString4=tostring(cs4), DeviceCustomString4Label=tostring(cs4Label), FileID=tostring(fileId), FileHash=tostring(fileHash), FileName=tostring(fname), FilePath=tostring(filePath), FileType=tostring(fileType), DestinationHostName=tostring(dhost), FlexString1Label=tostring(flexString1Label), FlexString1=tostring(flexString1), FlexString2Label=tostring(flexString2Label), FlexString2=tostring(flexString2), DeviceCustomString5=tostring(cs5), DeviceCustomString5Label=tostring(cs5Label), DeviceCustomString6=tostring(cs6), DeviceCustomString6Label=tostring(cs6Label), DeviceCustomDate1Label=tostring(deviceCustomDate1Label), DeviceCustomDate1=tostring(deviceCustomDate1), DeviceTimeZone=tostring(dtz), SourceUserName=tostring(suser), AdditionalExtensions = strcat(\"start=\",start,\";filedownloadtimems=\",filedownloadtimems,\";filescantimems=\",filescantimems,\";collabscope=\",collabscope,\";company=\",company,\";datacenter=\",datacenter,\";datacentercity=\",datacentercity,\";datacentercountry=\",datacentercountry,\";department=\",department,\";extcollabnames=\",extcollabnames,\";extownername=\",extownername,\";request=\",request,\";intcollabnames=\",intcollabnames,\";odlpdictnames=\",odlpdictnames,\";odlpenginenames=\",odlpenginenames,\";oextcollabnames=\",oextcollabnames,\";oextownername=\",oextownername,\";ofileid=\",ofileid,\";efullurl=\",efullurl,\";ehostname=\",ehostname,\";ointcollabnames=\",ointcollabnames,\";orulelabel=\",orulelabel,\";otenant=\",otenant,\";ouser=\",ouser,\";agentSeverity=\",agentSeverity,\";tenant=\",tenant,\";threatname=\",threatname,\";upload_doctypename=\",upload_doctypename)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition9'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition9'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSCASBFileSharingLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS CASB File Sharing Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB File Sharing log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIACASBFileSharingLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBFileSharinglog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All CASB File Sharing Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBFileSharinglog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - CASB File Sharing Blocked Actions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBFileSharinglog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBFileSharinglog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBFileSharinglog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS CASB File Sharing Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB File Sharing Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition9')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition9'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition9')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections9')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections9'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections9')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB File Sharing Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS CASB File Sharing Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections9": "[variables('_dataConnectorContentIdConnections9')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections9')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections9'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections9')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSCASBFileSharingLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSCASBFileSharingLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_casbfilesharing_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections9'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition10'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition10')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB Email Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition10'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSCASBEmailLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS CASB Email Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB Email log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIACASBEmailLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBEmaillog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All CASB Email Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBEmaillog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - CASB Email Blocked Actions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBEmaillog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBEmaillog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBEmaillog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS CASB Email Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB Email Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition10')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition10'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition10')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections10')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSCASBEmailLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_casbemail_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "oexternalownername",
                        "type": "string"
                      },
                      {
                        "name": "companyid",
                        "type": "string"
                      },
                      {
                        "name": "dlpidentifier",
                        "type": "string"
                      },
                      {
                        "name": "epochtime",
                        "type": "string"
                      },
                      {
                        "name": "filedownloadtimems",
                        "type": "string"
                      },
                      {
                        "name": "filescantimems",
                        "type": "string"
                      },
                      {
                        "name": "msgsize",
                        "type": "string"
                      },
                      {
                        "name": "num_ext_recpts",
                        "type": "string"
                      },
                      {
                        "name": "num_int_recpts",
                        "type": "string"
                      },
                      {
                        "name": "deviceExternalId",
                        "type": "string"
                      },
                      {
                        "name": "repochtime",
                        "type": "string"
                      },
                      {
                        "name": "outcome",
                        "type": "string"
                      },
                      {
                        "name": "fname",
                        "type": "string"
                      },
                      {
                        "name": "fsize",
                        "type": "string"
                      },
                      {
                        "name": "fileType",
                        "type": "string"
                      },
                      {
                        "name": "fileHash",
                        "type": "string"
                      },
                      {
                        "name": "company",
                        "type": "string"
                      },
                      {
                        "name": "datacenter",
                        "type": "string"
                      },
                      {
                        "name": "datacentercity",
                        "type": "string"
                      },
                      {
                        "name": "datacentercountry",
                        "type": "string"
                      },
                      {
                        "name": "department",
                        "type": "string"
                      },
                      {
                        "name": "dlpdictcount",
                        "type": "string"
                      },
                      {
                        "name": "dlpdictnames",
                        "type": "string"
                      },
                      {
                        "name": "dlpenginenames",
                        "type": "string"
                      },
                      {
                        "name": "externalownername",
                        "type": "string"
                      },
                      {
                        "name": "extrecptnames",
                        "type": "string"
                      },
                      {
                        "name": "intrecptnames",
                        "type": "string"
                      },
                      {
                        "name": "is_inbound",
                        "type": "string"
                      },
                      {
                        "name": "malware",
                        "type": "string"
                      },
                      {
                        "name": "malwareclass",
                        "type": "string"
                      },
                      {
                        "name": "messageid",
                        "type": "string"
                      },
                      {
                        "name": "oattchcomponentfilenames",
                        "type": "string"
                      },
                      {
                        "name": "odlpdictnames",
                        "type": "string"
                      },
                      {
                        "name": "odlpenginenames",
                        "type": "string"
                      },
                      {
                        "name": "oextrecptnames",
                        "type": "string"
                      },
                      {
                        "name": "ointrecptnames",
                        "type": "string"
                      },
                      {
                        "name": "omessageid",
                        "type": "string"
                      },
                      {
                        "name": "oowner",
                        "type": "string"
                      },
                      {
                        "name": "orulelabel",
                        "type": "string"
                      },
                      {
                        "name": "otenant",
                        "type": "string"
                      },
                      {
                        "name": "owner",
                        "type": "string"
                      },
                      {
                        "name": "rtime",
                        "type": "string"
                      },
                      {
                        "name": "rulelabel",
                        "type": "string"
                      },
                      {
                        "name": "ruletype",
                        "type": "string"
                      },
                      {
                        "name": "severity",
                        "type": "string"
                      },
                      {
                        "name": "tenant",
                        "type": "string"
                      },
                      {
                        "name": "threatname",
                        "type": "string"
                      },
                      {
                        "name": "tz",
                        "type": "string"
                      },
                      {
                        "name": "upload_doctypename",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_casbemail_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(Severity), Activity=tostring(name), DeviceEventClassID=tostring(deviceEventClassId), DeviceAction=tostring(act), deviceExternalId=tostring(deviceExternalId), EventOutcome=tostring(outcome), FileName=tostring(fname), FileSize=toint(fsize), FileType=tostring(fileType), FileHash=tostring(fileHash), AdditionalExtensions = strcat(\"oexternalownername=\",oexternalownername,\";companyid=\",companyid,\";dlpidentifier=\",dlpidentifier,\";epochtime=\",epochtime,\";filedownloadtimems=\",filedownloadtimems,\";filescantimems=\",filescantimems,\";msgsize=\",msgsize,\";num_ext_recpts=\",num_ext_recpts,\";num_int_recpts=\",num_int_recpts,\";repochtime=\",repochtime,\";company=\",company,\";datacenter=\",datacenter,\";datacentercity=\",datacentercity,\";datacentercountry=\",datacentercountry,\";department=\",department,\";dlpdictcount=\",dlpdictcount,\";dlpdictnames=\",dlpdictnames,\";dlpenginenames=\",dlpenginenames,\";externalownername=\",externalownername,\";extrecptnames=\",extrecptnames,\";intrecptnames=\",intrecptnames,\";is_inbound=\",is_inbound,\";malware=\",malware,\";malwareclass=\",malwareclass,\";messageid=\",messageid,\";oattchcomponentfilenames=\",oattchcomponentfilenames,\";odlpdictnames=\",odlpdictnames,\";odlpenginenames=\",odlpenginenames,\";oextrecptnames=\",oextrecptnames,\";ointrecptnames=\",ointrecptnames,\";omessageid=\",omessageid,\";oowner=\",oowner,\";orulelabel=\",orulelabel,\";otenant=\",otenant,\";owner=\",owner,\";rtime=\",rtime,\";rulelabel=\",rulelabel,\";ruletype=\",ruletype,\";severity=\",severity,\";tenant=\",tenant,\";threatname=\",threatname,\";tz=\",tz,\";upload_doctypename=\",upload_doctypename)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition10'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition10'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSCASBEmailLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS CASB Email Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB Email log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIACASBEmailLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBEmaillog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All CASB Email Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBEmaillog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - CASB Email Blocked Actions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBEmaillog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBEmaillog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBEmaillog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS CASB Email Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB Email Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition10')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition10'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition10')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections10')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections10'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections10')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB Email Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS CASB Email Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections10": "[variables('_dataConnectorContentIdConnections10')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections10')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections10'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections10')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSCASBEmailLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSCASBEmailLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_casbemail_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections10'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition11'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition11')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB CRM Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition11'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSCASBCRMLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS CASB CRM Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB CRM log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIACASBCRMLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBCRMlog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All CASB CRM Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBCRMlog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - CASB CRM Blocked Actions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBCRMlog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBCRMlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBCRMlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS CASB CRM Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB CRM Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition11')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition11'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition11')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections11')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSCASBCRMLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_casbcrm_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "start",
                        "type": "string"
                      },
                      {
                        "name": "fsize",
                        "type": "string"
                      },
                      {
                        "name": "cn1",
                        "type": "string"
                      },
                      {
                        "name": "cn1Label",
                        "type": "string"
                      },
                      {
                        "name": "cn2",
                        "type": "string"
                      },
                      {
                        "name": "cn2Label",
                        "type": "string"
                      },
                      {
                        "name": "deviceExternalId",
                        "type": "string"
                      },
                      {
                        "name": "collabscope",
                        "type": "string"
                      },
                      {
                        "name": "company",
                        "type": "string"
                      },
                      {
                        "name": "component",
                        "type": "string"
                      },
                      {
                        "name": "datacenter",
                        "type": "string"
                      },
                      {
                        "name": "datacentercity",
                        "type": "string"
                      },
                      {
                        "name": "datacentercountry",
                        "type": "string"
                      },
                      {
                        "name": "department",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "external_collabnames",
                        "type": "string"
                      },
                      {
                        "name": "extownername",
                        "type": "string"
                      },
                      {
                        "name": "fileId",
                        "type": "string"
                      },
                      {
                        "name": "fileModificationTime",
                        "type": "string"
                      },
                      {
                        "name": "fileHash",
                        "type": "string"
                      },
                      {
                        "name": "fname",
                        "type": "string"
                      },
                      {
                        "name": "filePath",
                        "type": "string"
                      },
                      {
                        "name": "fileType",
                        "type": "string"
                      },
                      {
                        "name": "request",
                        "type": "string"
                      },
                      {
                        "name": "dhost",
                        "type": "string"
                      },
                      {
                        "name": "internal_collabnames",
                        "type": "string"
                      },
                      {
                        "name": "flexString1Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString1",
                        "type": "string"
                      },
                      {
                        "name": "flexString2Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString2",
                        "type": "string"
                      },
                      {
                        "name": "objectname",
                        "type": "string"
                      },
                      {
                        "name": "objecttype",
                        "type": "string"
                      },
                      {
                        "name": "odlpdictnames",
                        "type": "string"
                      },
                      {
                        "name": "odlpenginenames",
                        "type": "string"
                      },
                      {
                        "name": "oexternal_collabnames",
                        "type": "string"
                      },
                      {
                        "name": "oextownername",
                        "type": "string"
                      },
                      {
                        "name": "ofile_msg_id",
                        "type": "string"
                      },
                      {
                        "name": "ofullurl",
                        "type": "string"
                      },
                      {
                        "name": "ohostname",
                        "type": "string"
                      },
                      {
                        "name": "ointernal_collabnames",
                        "type": "string"
                      },
                      {
                        "name": "oowner",
                        "type": "string"
                      },
                      {
                        "name": "orulelabel",
                        "type": "string"
                      },
                      {
                        "name": "otenant",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "cs6",
                        "type": "string"
                      },
                      {
                        "name": "cs6Label",
                        "type": "string"
                      },
                      {
                        "name": "agentSeverity",
                        "type": "string"
                      },
                      {
                        "name": "tenant",
                        "type": "string"
                      },
                      {
                        "name": "threatname",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1Label",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1",
                        "type": "string"
                      },
                      {
                        "name": "dtz",
                        "type": "string"
                      },
                      {
                        "name": "upload_doctypename",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_casbcrm_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(Severity), Activity=tostring(name), DeviceEventClassID=tostring(deviceEventClassId), DeviceAction=tostring(act), DeviceCustomString1=tostring(cs1), DeviceCustomString1Label=tostring(cs1Label), FileSize=toint(fsize), DeviceCustomNumber1=toint(cn1), DeviceCustomNumber1Label=tostring(cn1Label), DeviceCustomNumber2=toint(cn2), DeviceCustomNumber2Label=tostring(cn2Label), deviceExternalId=tostring(deviceExternalId), DeviceCustomString2=tostring(cs2), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString3=tostring(cs3), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString4=tostring(cs4), DeviceCustomString4Label=tostring(cs4Label), FileID=tostring(fileId), FileModificationTime=tostring(fileModificationTime), FileHash=tostring(fileHash), FileName=tostring(fname), FilePath=tostring(filePath), FileType=tostring(fileType), DestinationHostName=tostring(dhost), FlexString1Label=tostring(flexString1Label), FlexString1=tostring(flexString1), FlexString2Label=tostring(flexString2Label), FlexString2=tostring(flexString2), SourceUserName=tostring(suser), DeviceCustomString5=tostring(cs5), DeviceCustomString5Label=tostring(cs5Label), DeviceCustomString6=tostring(cs6), DeviceCustomString6Label=tostring(cs6Label), DeviceCustomDate1Label=tostring(deviceCustomDate1Label), DeviceCustomDate1=tostring(deviceCustomDate1), DeviceTimeZone=tostring(dtz), AdditionalExtensions = strcat(\"start=\",start,\";collabscope=\",collabscope,\";company=\",company,\";component=\",component,\";datacenter=\",datacenter,\";datacentercity=\",datacentercity,\";datacentercountry=\",datacentercountry,\";department=\",department,\";external_collabnames=\",external_collabnames,\";extownername=\",extownername,\";request=\",request,\";internal_collabnames=\",internal_collabnames,\";objectname=\",objectname,\";objecttype=\",objecttype,\";odlpdictnames=\",odlpdictnames,\";odlpenginenames=\",odlpenginenames,\";oexternal_collabnames=\",oexternal_collabnames,\";oextownername=\",oextownername,\";ofile_msg_id=\",ofile_msg_id,\";ofullurl=\",ofullurl,\";ohostname=\",ohostname,\";ointernal_collabnames=\",ointernal_collabnames,\";oowner=\",oowner,\";orulelabel=\",orulelabel,\";otenant=\",otenant,\";agentSeverity=\",agentSeverity,\";tenant=\",tenant,\";threatname=\",threatname,\";upload_doctypename=\",upload_doctypename)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition11'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition11'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSCASBCRMLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS CASB CRM Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB CRM log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIACASBCRMLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBCRMlog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All CASB CRM Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBCRMlog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - CASB CRM Blocked Actions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBCRMlog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBCRMlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBCRMlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS CASB CRM Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB CRM Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition11')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition11'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition11')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections11')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections11'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections11')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB CRM Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS CASB CRM Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections11": "[variables('_dataConnectorContentIdConnections11')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections11')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections11'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections11')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSCASBCRMLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSCASBCRMLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_casbcrm_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections11'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition12'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition12')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB Collaboration Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition12'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSCASBCollabLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS CASB Collaboration Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB Collaboration log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIACASBCollabLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBCollablog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All CASB Collaboration Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBCollablog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - CASB Collaboration Blocked Actions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBCollablog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBCollablog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBCollablog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS CASB Collaboration Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB Collaboration Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition12')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition12'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition12')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections12')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSCASBCollabLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_casbcollab_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "start",
                        "type": "string"
                      },
                      {
                        "name": "deviceExternalId",
                        "type": "string"
                      },
                      {
                        "name": "outcome",
                        "type": "string"
                      },
                      {
                        "name": "channel_name",
                        "type": "string"
                      },
                      {
                        "name": "company",
                        "type": "string"
                      },
                      {
                        "name": "datacenter",
                        "type": "string"
                      },
                      {
                        "name": "datacentercity",
                        "type": "string"
                      },
                      {
                        "name": "datacentercountry",
                        "type": "string"
                      },
                      {
                        "name": "department",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "external_recptnames",
                        "type": "string"
                      },
                      {
                        "name": "extownername",
                        "type": "string"
                      },
                      {
                        "name": "internal_recptnames",
                        "type": "string"
                      },
                      {
                        "name": "flexString1Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString1",
                        "type": "string"
                      },
                      {
                        "name": "flexString2Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString2",
                        "type": "string"
                      },
                      {
                        "name": "msgid",
                        "type": "string"
                      },
                      {
                        "name": "ochannel_name",
                        "type": "string"
                      },
                      {
                        "name": "odlpdictnames",
                        "type": "string"
                      },
                      {
                        "name": "odlpenginenames",
                        "type": "string"
                      },
                      {
                        "name": "oexternal_recptnames",
                        "type": "string"
                      },
                      {
                        "name": "oextownername",
                        "type": "string"
                      },
                      {
                        "name": "ointernal_recptnames",
                        "type": "string"
                      },
                      {
                        "name": "omsgid",
                        "type": "string"
                      },
                      {
                        "name": "oowner",
                        "type": "string"
                      },
                      {
                        "name": "orulelabel",
                        "type": "string"
                      },
                      {
                        "name": "osender",
                        "type": "string"
                      },
                      {
                        "name": "osharedchannel_hostname",
                        "type": "string"
                      },
                      {
                        "name": "otenant",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "cs6",
                        "type": "string"
                      },
                      {
                        "name": "cs6Label",
                        "type": "string"
                      },
                      {
                        "name": "sender",
                        "type": "string"
                      },
                      {
                        "name": "agentSeverity",
                        "type": "string"
                      },
                      {
                        "name": "sharedchannel_hostname",
                        "type": "string"
                      },
                      {
                        "name": "tenant",
                        "type": "string"
                      },
                      {
                        "name": "threatname",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1Label",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1",
                        "type": "string"
                      },
                      {
                        "name": "dtz",
                        "type": "string"
                      },
                      {
                        "name": "upload_doctypename",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_casbcollab_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(Severity), Activity=tostring(name), DeviceEventClassID=tostring(deviceEventClassId), DeviceAction=tostring(act), DeviceCustomString1=tostring(cs1), DeviceCustomString1Label=tostring(cs1Label), deviceExternalId=tostring(deviceExternalId), EventOutcome=tostring(outcome), DeviceCustomString2=tostring(cs2), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString3=tostring(cs3), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString4=tostring(cs4), DeviceCustomString4Label=tostring(cs4Label), FlexString1Label=tostring(flexString1Label), FlexString1=tostring(flexString1), FlexString2Label=tostring(flexString2Label), FlexString2=tostring(flexString2), SourceUserName=tostring(suser), DeviceCustomString5=tostring(cs5), DeviceCustomString5Label=tostring(cs5Label), DeviceCustomString6=tostring(cs6), DeviceCustomString6Label=tostring(cs6Label), DeviceCustomDate1Label=tostring(deviceCustomDate1Label), DeviceCustomDate1=tostring(deviceCustomDate1), DeviceTimeZone=tostring(dtz), AdditionalExtensions = strcat(\"start=\",start,\";channel_name=\",channel_name,\";company=\",company,\";datacenter=\",datacenter,\";datacentercity=\",datacentercity,\";datacentercountry=\",datacentercountry,\";department=\",department,\";external_recptnames=\",external_recptnames,\";extownername=\",extownername,\";internal_recptnames=\",internal_recptnames,\";msgid=\",msgid,\";ochannel_name=\",ochannel_name,\";odlpdictnames=\",odlpdictnames,\";odlpenginenames=\",odlpenginenames,\";oexternal_recptnames=\",oexternal_recptnames,\";oextownername=\",oextownername,\";ointernal_recptnames=\",ointernal_recptnames,\";omsgid=\",omsgid,\";oowner=\",oowner,\";orulelabel=\",orulelabel,\";osender=\",osender,\";osharedchannel_hostname=\",osharedchannel_hostname,\";otenant=\",otenant,\";sender=\",sender,\";agentSeverity=\",agentSeverity,\";sharedchannel_hostname=\",sharedchannel_hostname,\";tenant=\",tenant,\";threatname=\",threatname,\";upload_doctypename=\",upload_doctypename)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition12'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition12'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSCASBCollabLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS CASB Collaboration Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB Collaboration log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIACASBCollabLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBCollablog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All CASB Collaboration Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBCollablog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - CASB Collaboration Blocked Actions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBCollablog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBCollablog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBCollablog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS CASB Collaboration Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB Collaboration Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition12')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition12'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition12')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections12')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections12'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections12')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB Collaboration Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS CASB Collaboration Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections12": "[variables('_dataConnectorContentIdConnections12')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections12')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections12'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections12')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSCASBCollabLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSCASBCollabLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_casbcollab_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections12'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition13'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition13')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB Cloud Storage Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition13'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSCASBCloudStorageLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS CASB Cloud Storage Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB Cloud Storage log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIACASBCloudStorageLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBCloudStoragelog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All CASB Cloud Storage Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBCloudStoragelog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - CASB Cloud Storage Blocked Actions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBCloudStoragelog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBCloudStoragelog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBCloudStoragelog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS CASB Cloud Storage Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB Cloud Storage Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition13')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition13'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition13')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections13')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSCASBCloudStorageLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_casbcloudstorage_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "bucketid",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "start",
                        "type": "string"
                      },
                      {
                        "name": "numcollab",
                        "type": "string"
                      },
                      {
                        "name": "deviceExternalId",
                        "type": "string"
                      },
                      {
                        "name": "bucketname",
                        "type": "string"
                      },
                      {
                        "name": "bucketowner",
                        "type": "string"
                      },
                      {
                        "name": "collabnames",
                        "type": "string"
                      },
                      {
                        "name": "company",
                        "type": "string"
                      },
                      {
                        "name": "datacenter",
                        "type": "string"
                      },
                      {
                        "name": "datacentercity",
                        "type": "string"
                      },
                      {
                        "name": "datacentercountry",
                        "type": "string"
                      },
                      {
                        "name": "department",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "extownername",
                        "type": "string"
                      },
                      {
                        "name": "fileId",
                        "type": "string"
                      },
                      {
                        "name": "request",
                        "type": "string"
                      },
                      {
                        "name": "dhost",
                        "type": "string"
                      },
                      {
                        "name": "flexString1Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString1",
                        "type": "string"
                      },
                      {
                        "name": "flexString2Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString2",
                        "type": "string"
                      },
                      {
                        "name": "obucketname",
                        "type": "string"
                      },
                      {
                        "name": "obucketowner",
                        "type": "string"
                      },
                      {
                        "name": "ocollabnames",
                        "type": "string"
                      },
                      {
                        "name": "odlpdictnames",
                        "type": "string"
                      },
                      {
                        "name": "odlpenginenames",
                        "type": "string"
                      },
                      {
                        "name": "oextownername",
                        "type": "string"
                      },
                      {
                        "name": "ofileid",
                        "type": "string"
                      },
                      {
                        "name": "ofullurl",
                        "type": "string"
                      },
                      {
                        "name": "ohostname",
                        "type": "string"
                      },
                      {
                        "name": "oowner",
                        "type": "string"
                      },
                      {
                        "name": "orulelabel",
                        "type": "string"
                      },
                      {
                        "name": "otenant",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "cs6",
                        "type": "string"
                      },
                      {
                        "name": "cs6Label",
                        "type": "string"
                      },
                      {
                        "name": "agentSeverity",
                        "type": "string"
                      },
                      {
                        "name": "tenant",
                        "type": "string"
                      },
                      {
                        "name": "threatname",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1Label",
                        "type": "string"
                      },
                      {
                        "name": "deviceCustomDate1",
                        "type": "string"
                      },
                      {
                        "name": "dtz",
                        "type": "string"
                      },
                      {
                        "name": "upload_doctypename",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_casbcloudstorage_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(Severity), Activity=tostring(name), DeviceEventClassID=tostring(deviceEventClassId), DeviceAction=tostring(act), DeviceCustomString1=tostring(cs1), DeviceCustomString1Label=tostring(cs1Label), deviceExternalId=tostring(deviceExternalId), DeviceCustomString2=tostring(cs2), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString3=tostring(cs3), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString4=tostring(cs4), DeviceCustomString4Label=tostring(cs4Label), FileID=tostring(fileId), DestinationHostName=tostring(dhost), FlexString1Label=tostring(flexString1Label), FlexString1=tostring(flexString1), FlexString2Label=tostring(flexString2Label), FlexString2=tostring(flexString2), SourceUserName=tostring(suser), DeviceCustomString5=tostring(cs5), DeviceCustomString5Label=tostring(cs5Label), DeviceCustomString6=tostring(cs6), DeviceCustomString6Label=tostring(cs6Label), DeviceCustomDate1Label=tostring(deviceCustomDate1Label), DeviceCustomDate1=tostring(deviceCustomDate1), DeviceTimeZone=tostring(dtz), AdditionalExtensions = strcat(\"bucketid=\",bucketid,\";start=\",start,\";numcollab=\",numcollab,\";bucketname=\",bucketname,\";bucketowner=\",bucketowner,\";collabnames=\",collabnames,\";company=\",company,\";datacenter=\",datacenter,\";datacentercity=\",datacentercity,\";datacentercountry=\",datacentercountry,\";department=\",department,\";extownername=\",extownername,\";request=\",request,\";obucketname=\",obucketname,\";obucketowner=\",obucketowner,\";ocollabnames=\",ocollabnames,\";odlpdictnames=\",odlpdictnames,\";odlpenginenames=\",odlpenginenames,\";oextownername=\",oextownername,\";ofileid=\",ofileid,\";ofullurl=\",ofullurl,\";ohostname=\",ohostname,\";oowner=\",oowner,\";orulelabel=\",orulelabel,\";otenant=\",otenant,\";agentSeverity=\",agentSeverity,\";tenant=\",tenant,\";threatname=\",threatname,\";upload_doctypename=\",upload_doctypename)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition13'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition13'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSCASBCloudStorageLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS CASB Cloud Storage Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB Cloud Storage log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIACASBCloudStorageLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBCloudStoragelog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All CASB Cloud Storage Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBCloudStoragelog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - CASB Cloud Storage Blocked Actions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBCloudStoragelog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBCloudStoragelog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBCloudStoragelog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS CASB Cloud Storage Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB Cloud Storage Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition13')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition13'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition13')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections13')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections13'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections13')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB Cloud Storage Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS CASB Cloud Storage Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections13": "[variables('_dataConnectorContentIdConnections13')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections13')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections13'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections13')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSCASBCloudStorageLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSCASBCloudStorageLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_casbcloudstorage_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections13'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition14'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition14')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB Activity Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition14'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSCASBActivityLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS CASB Activity Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB Activity log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIACASBActivityLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBActivitylog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All CASB Activity Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBActivitylog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - CASB Activity Blocked Actions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBActivitylog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBActivitylog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBActivitylog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS CASB Activity Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB Activity Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition14')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition14'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition14')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections14')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSCASBActivityLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_casbactivity_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "eventCount",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "cs6Label",
                        "type": "string"
                      },
                      {
                        "name": "cs6",
                        "type": "string"
                      },
                      {
                        "name": "src",
                        "type": "string"
                      },
                      {
                        "name": "flexString1Label",
                        "type": "string"
                      },
                      {
                        "name": "flexString1",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_casbactivity_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(Severity), Activity=tostring(name), SourceUserName=tostring(suser), DeviceCustomString1Label=tostring(cs1Label), DeviceCustomString1=tostring(cs1), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString2=tostring(cs2), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString3=tostring(cs3), DeviceEventClassID=tostring(deviceEventClassId), DeviceCustomString4Label=tostring(cs4Label), DeviceCustomString4=tostring(cs4), DeviceCustomString5Label=tostring(cs5Label), DeviceCustomString5=tostring(cs5), DeviceAction=tostring(act), DeviceCustomString6Label=tostring(cs6Label), DeviceCustomString6=tostring(cs6), SourceIP=tostring(src), FlexString1Label=tostring(flexString1Label), FlexString1=tostring(flexString1), AdditionalExtensions = strcat(\"eventCount=\",eventCount)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition14'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition14'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSCASBActivityLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS CASB Activity Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA CASB Activity log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIACASBActivityLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSCASBActivitylog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All CASB Activity Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBActivitylog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - CASB Activity Blocked Actions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSCASBActivitylog'\n | where DeviceAction == 'Blocked'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBActivitylog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSCASBActivitylog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS CASB Activity Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS CASB Activity Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition14')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition14'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition14')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections14')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections14'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections14')]",
        "displayName": "Zscaler Internet Access Cloud NSS CASB Activity Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS CASB Activity Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections14": "[variables('_dataConnectorContentIdConnections14')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections14')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections14'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections14')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSCASBActivityLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSCASBActivityLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_casbactivity_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections14'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition15'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition15')]",
        "displayName": "Zscaler Internet Access Cloud NSS Audit Log Push Connector",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition15'))]",
              "apiVersion": "2025-09-01",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CloudNSSAuditLogs_ccp",
                  "title": "Zscaler Internet Access Cloud NSS Audit Log Push Connector",
                  "publisher": "Zscaler",
                  "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA Audit log data in Microsoft Sentinel.",
                  "graphQueries": [
                    {
                      "metricName": "ZIAAuditLogs",
                      "legend": "CommonSecurityLog",
                      "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSAuditlog'"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "ZIA - All Audit Transactions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSAuditlog'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "ZIA - Audit Failed Actions",
                      "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSAuditlog'\n | where EventOutcome == 'Failure'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CommonSecurityLog",
                      "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSAuditlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CommonSecurityLog\n            | where DeviceProduct == 'NSSAuditlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy Zscaler Internet Access Cloud NSS Audit Log connector resources",
                            "applicationDisplayName": "Zscaler Internet Access Cloud NSS Audit Log connector Application"
                          },
                          "type": "DeployPushConnectorButton"
                        }
                      ]
                    },
                    {
                      "title": "2. Push your logs into the workspace",
                      "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Tenant ID (Directory ID)",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra App Registration Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the App Registration Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Endpoint Uri",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Data Collection Rule Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition15')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition15'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition15')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections15')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CloudNSSAuditLogs_ccp",
              "apiVersion": "2024-03-11",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-nss_audit_CL": {
                    "columns": [
                      {
                        "name": "sourcetype",
                        "type": "string"
                      },
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "vendor",
                        "type": "string"
                      },
                      {
                        "name": "product",
                        "type": "string"
                      },
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "deviceEventClassId",
                        "type": "string"
                      },
                      {
                        "name": "act",
                        "type": "string"
                      },
                      {
                        "name": "cs1Label",
                        "type": "string"
                      },
                      {
                        "name": "cs1",
                        "type": "string"
                      },
                      {
                        "name": "cs2Label",
                        "type": "string"
                      },
                      {
                        "name": "cs2",
                        "type": "string"
                      },
                      {
                        "name": "cs3Label",
                        "type": "string"
                      },
                      {
                        "name": "cs3",
                        "type": "string"
                      },
                      {
                        "name": "cat",
                        "type": "string"
                      },
                      {
                        "name": "suser",
                        "type": "string"
                      },
                      {
                        "name": "src",
                        "type": "string"
                      },
                      {
                        "name": "outcome",
                        "type": "string"
                      },
                      {
                        "name": "reason",
                        "type": "string"
                      },
                      {
                        "name": "sourceServiceName",
                        "type": "string"
                      },
                      {
                        "name": "cs4Label",
                        "type": "string"
                      },
                      {
                        "name": "cs4",
                        "type": "string"
                      },
                      {
                        "name": "cs5Label",
                        "type": "string"
                      },
                      {
                        "name": "cs5",
                        "type": "string"
                      },
                      {
                        "name": "deviceExternalId",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-nss_audit_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(Severity), Activity=tostring(name), DeviceEventClassID=tostring(deviceEventClassId), DeviceAction=tostring(act), DeviceCustomString1Label=tostring(cs1Label), DeviceCustomString1=tostring(cs1), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString2=tostring(cs2), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString3=tostring(cs3), DeviceEventCategory=tostring(cat), SourceUserName=tostring(suser), SourceIP=tostring(src), EventOutcome=tostring(outcome), Reason=tostring(reason), SourceServiceName=tostring(sourceServiceName), DeviceCustomString4Label=tostring(cs4Label), DeviceCustomString4=tostring(cs4), DeviceCustomString5Label=tostring(cs5Label), DeviceCustomString5=tostring(cs5), deviceExternalId=tostring(deviceExternalId)",
                    "outputStream": "Microsoft-CommonSecurityLog"
                  }
                ],
                "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition15'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition15'))]",
      "apiVersion": "2025-09-01",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CloudNSSAuditLogs_ccp",
          "title": "Zscaler Internet Access Cloud NSS Audit Log Push Connector",
          "publisher": "Zscaler",
          "descriptionMarkdown": "The [Zscaler](https://www.zscaler.com/) connector provides the capability to read ZIA Audit log data in Microsoft Sentinel.",
          "graphQueries": [
            {
              "metricName": "ZIAAuditLogs",
              "legend": "CommonSecurityLog",
              "baseQuery": "CommonSecurityLog | where DeviceProduct == 'NSSAuditlog'"
            }
          ],
          "sampleQueries": [
            {
              "description": "ZIA - All Audit Transactions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSAuditlog'\n | sort by TimeGenerated desc"
            },
            {
              "description": "ZIA - Audit Failed Actions",
              "query": "CommonSecurityLog\n | where DeviceProduct == 'NSSAuditlog'\n | where EventOutcome == 'Failure'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog",
              "lastDataReceivedQuery": "CommonSecurityLog\n            | where DeviceProduct == 'NSSAuditlog'\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CommonSecurityLog\n            | where DeviceProduct == 'NSSAuditlog'\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
              ]
            }
          ],
          "availability": {
            "status": 1
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rule (DCR). Typically requires Azure RBAC Owner or User Access Administrator role"
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "This connector reads data from the tables that Zscaler uses in a Microsoft Analytics Workspace, if the Cloud NSS option is enabled in Zscaler then raw event data is sent to the Microsoft Sentinel Ingestion API.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated Configuration and Secure Data Ingestion with Entra Application \nClicking on \"Deploy\" will trigger the creation of Log Analytics tables and a Data Collection Rule (DCR). \nIt will then create an Entra application, link the DCR to it, and set the entered secret in the application. This setup enables data to be sent securely to the DCR using an Entra token."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy Zscaler Internet Access Cloud NSS Audit Log connector resources",
                    "applicationDisplayName": "Zscaler Internet Access Cloud NSS Audit Log connector Application"
                  },
                  "type": "DeployPushConnectorButton"
                }
              ]
            },
            {
              "title": "2. Push your logs into the workspace",
              "description": "Use the following parameters to configure the your machine to send the logs to the workspace.",
              "instructions": [
                {
                  "parameters": {
                    "label": "Tenant ID (Directory ID)",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra App Registration Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the App Registration Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Endpoint Uri",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Endpoint Uri"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Data Collection Rule Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the Data Collection Rule Immutable ID"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition15')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition15'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition15')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections15')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections15'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections15')]",
        "displayName": "Zscaler Internet Access Cloud NSS Audit Log Push Connector",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Zscaler Internet Access Cloud NSS Audit Log Push Connector",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections15": "[variables('_dataConnectorContentIdConnections15')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections15')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections15'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections15')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CloudNSSAuditLogs_ccp', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "CloudNSSAuditLogs_ccp",
                "dcrConfig": {
                  "streamName": "Custom-nss_audit_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "auth": {
                  "type": "Push",
                  "AppId": "[[parameters('auth').appId]",
                  "ServicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections15'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Overview of Zscaler web log activity, top apps, traffic trends, and blocked activity summary.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Overview of Zscaler web log activity, top apps, traffic trends, and blocked activity summary."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler web overview\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"e246fdd8-f37f-4290-a205-7ffa192ea860\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":86400000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}},{\"id\":\"fe452f11-ddc9-4b85-b441-b8f6be3b33a8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SourceIP\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where SourceTranslatedAddress  != \\\"\\\" \\r\\n| summarize Count = count() by SourceTranslatedAddress\\r\\n| project Value = SourceTranslatedAddress, Label = strcat(SourceTranslatedAddress, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"2f749931-c232-471f-b91f-f91514fd7fa7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DestinationIP\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID  !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where DestinationIP  != \\\"\\\" \\r\\n| summarize Count = count() by DestinationIP\\r\\n| project Value = DestinationIP, Label = strcat(DestinationIP, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DestinationServiceName !=\\\"\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| summarize Count = count() by DestinationServiceName\\r\\n| order by Count desc\",\"size\":0,\"title\":\"Apps being accessed\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"DestinationServiceName\",\"exportParameterName\":\"DestinationServiceNameFilter\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"palette\":\"purple\",\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"40\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DestinationServiceName !=\\\"\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where DestinationServiceName == '{DestinationServiceNameFilter}' or '{DestinationServiceNameFilter}' == \\\"All\\\"\\r\\n| summarize Count = count() by DestinationServiceName, bin(TimeGenerated, {TimeRange:grain})\\r\\n\",\"size\":0,\"title\":\"Apps being accessed over time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"60\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceEventClassID contains \\\"Allow\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where DestinationServiceName has_any (\\\"Microsoft\\\", \\\"Skype\\\", \\\"SharePoint\\\", \\\"OneDrive\\\", \\\"Outlook\\\", \\\"office.com\\\", \\\"Sharepoint Online\\\", \\\"Microsoft Forms\\\", \\\"Microsoft Azure\\\")\\r\\n| summarize Count = count()  by DestinationServiceName\",\"size\":0,\"title\":\"Microsoft services\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"greenBlue\",\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| parse AdditionalExtensions with * \\\"devicemodel=\\\" devicemodel\\r\\n| where devicemodel != \\\"\\\"  and    devicemodel !startswith \\\"NA\\\"\\r\\n| summarize count() by devicemodel \",\"size\":0,\"title\":\"Devices\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceEventClassID == \\\"Allowed\\\" or DeviceEventClassID == \\\"Allow\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| summarize Downloads = sum( ReceivedBytes)/1024.0/1024.0 , Uploads = sum( SentBytes)/1024.0/1024.0 by Location = SourceUserPrivileges\",\"size\":0,\"title\":\"Upload and download data in MB, by location - click to filter\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Location\",\"exportParameterName\":\"LocationFilter\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Downloads\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}},{\"columnMatch\":\"Uploads\",\"formatter\":4,\"formatOptions\":{\"palette\":\"green\",\"showIcon\":true}}]}},\"customWidth\":\"50\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceEventClassID == \\\"Allowed\\\" or DeviceEventClassID == \\\"Allow\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where SourceUserPrivileges == '{LocationFilter}' or '{LocationFilter}' == \\\"All\\\"\\r\\n| summarize Downloads = sum( ReceivedBytes)/1024.0/1024.0 , Uploads = sum( SentBytes)/1024.0/1024.0 by bin(TimeGenerated, {TimeRange:grain}) \",\"size\":0,\"title\":\"Upload and download data in MB over time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where ApplicationProtocol !=\\\"\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\";\\r\\nlet appData = data\\r\\n| summarize TotalCount = count() by ApplicationProtocol\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by ApplicationProtocol\\r\\n    | project-away TimeGenerated) on ApplicationProtocol\\r\\n| order by TotalCount desc, ApplicationProtocol asc\\r\\n| project ApplicationProtocol, TotalCount, Trend\\r\\n| serialize Id = row_number();\\r\\ndata\\r\\n| summarize TotalCount = count() by RequestMethod , ApplicationProtocol\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by ApplicationProtocol, RequestMethod \\r\\n    | project-away TimeGenerated) on ApplicationProtocol, RequestMethod \\r\\n| order by TotalCount desc, ApplicationProtocol asc\\r\\n| project ApplicationProtocol, RequestMethod , TotalCount, Trend\\r\\n| serialize Id = row_number(1000000)\\r\\n| join kind=inner (appData) on ApplicationProtocol\\r\\n| project Id, Name = RequestMethod , Type = 'RequestMethod', ['ApplicationProtocol Count'] = TotalCount, Trend,  ParentId = Id1\\r\\n| union (appData \\r\\n    | project Id, Name = ApplicationProtocol, Type = 'ApplicationProtocol', ['ApplicationProtocol Count'] = TotalCount,  Trend)\\r\\n| order by ['ApplicationProtocol Count'] desc, Name asc\",\"size\":0,\"title\":\"Protocols and methods\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"ApplicationProtocol Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"gray\",\"showIcon\":true}},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blueDark\",\"showIcon\":true}},{\"columnMatch\":\"ParentId\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true,\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Name\"}}},\"customWidth\":\"70\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID == \\\"Allowed\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where RequestMethod != \\\"\\\" \\r\\n| where RequestMethod != \\\"None\\\" \\r\\n| summarize count() by RequestMethod \\r\\n\",\"size\":0,\"title\":\"Allowed HTTP methods\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where SourceUserPrivileges == \\\"Road Warrior\\\" \\r\\n| summarize URLS_BLOCKED = count() by bin(TimeGenerated, {TimeRange:grain}), Activity\",\"size\":0,\"title\":\"Block reasons for road warriors\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"name\":\"query - 15\"},{\"type\":1,\"content\":{\"json\":\"---\\r\\n### Block actvities\"},\"name\":\"text - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where SourceUserPrivileges != \\\"\\\" \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| summarize Count = count() by DestinationHostName\\r\\n| top 10 by Count\\r\\n| order by Count desc\",\"size\":0,\"title\":\"Top blocked domains for HTTP/S requests\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"DestinationHostName\",\"exportParameterName\":\"DestinationHostName\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\",\"showIcon\":true}}],\"labelSettings\":[{\"columnId\":\"DestinationHostName\",\"label\":\"Destination Host Name\"}]}},\"customWidth\":\"33\",\"name\":\"query - 16\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where SourceUserPrivileges != SourceUserName\\r\\n| summarize Count = count() by SourceUserName\\r\\n| top 10 by Count\\r\\n| order by Count desc\",\"size\":0,\"title\":\"Top blocked users for HTTP/S requests\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"SourceUserName\",\"exportParameterName\":\"SourceUserName\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\",\"showIcon\":true}}],\"rowLimit\":1000}},\"customWidth\":\"33\",\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| summarize Count = count() by Activity\\r\\n| sort by Count \\r\\n| top 10 by Count\\r\\n\",\"size\":0,\"title\":\"Top Block Reasons for HTTP/S Requests\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Activity\",\"exportParameterName\":\"Activity\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\",\"showIcon\":true}}]}},\"customWidth\":\"33\",\"name\":\"query - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where SourceUserPrivileges != \\\"\\\" \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where (DestinationHostName == '{DestinationHostName}' or '{DestinationHostName}' == \\\"All\\\") and (SourceUserName == '{SourceUserName}' or '{SourceUserName}' == \\\"All\\\") and (Activity == '{Activity}' or '{Activity}' == \\\"All\\\")\\r\\n| summarize Count = count() by DestinationHostName, SourceUserName, Activity, DestinationIP, Location = SourceUserPrivileges\\r\\n| order by Count desc\",\"size\":0,\"title\":\"Block activities summary\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true}},\"name\":\"query - 14\"}],\"fallbackResourceIds\":[\"/subscriptions/e679ff63-15e0-465d-a25b-5598ef08d05e/resourcegroups/rg-ccf/providers/microsoft.operationalinsights/workspaces/log-ccf\"],\"fromTemplateId\":\"sentinel-ZscalerNSSWebLogsOverview\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Threat-focused view of Zscaler web logs, highlighting blocked transactions and indicators.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId2')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Threat-focused view of Zscaler web logs, highlighting blocked transactions and indicators."
              },
              "properties": {
                "displayName": "[parameters('workbook2-name')]",
                "serializedData": "null\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId2'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId2')]",
                "contentId": "[variables('_workbookContentId2')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId2')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook2-name')]",
        "contentProductId": "[variables('_workbookcontentProductId2')]",
        "id": "[variables('_workbookcontentProductId2')]",
        "version": "[variables('workbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Office 365 usage and bandwidth trends in Zscaler web logs, with phishing signals.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId3')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Office 365 usage and bandwidth trends in Zscaler web logs, with phishing signals."
              },
              "properties": {
                "displayName": "[parameters('workbook3-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler Office 365 overview\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"ff5a2a6c-cf01-432a-ab49-e59918ead8ab\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":259200000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DestinationServiceName contains \\\"Microsoft\\\" or DestinationServiceName contains  \\\"Skype\\\"  or DestinationServiceName contains \\\"Sharepoint\\\" or DestinationServiceName contains \\\"Onedrive\\\"  or DestinationServiceName contains \\\"Outlook\\\" or DestinationServiceName contains \\\"office.com\\\"\\r\\n| where DeviceEventClassID contains \\\"Allow\\\" \\r\\n| summarize count()  by bin(TimeGenerated, {TimeRange:grain}), DestinationServiceName\",\"size\":0,\"title\":\"Microsoft services activity over time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DestinationServiceName contains \\\"Microsoft\\\" or DestinationServiceName contains  \\\"Skype\\\"  or DestinationServiceName contains \\\"Sharepoint\\\" or DestinationServiceName contains \\\"Onedrive\\\"  or DestinationServiceName contains \\\"Outlook\\\" or DestinationServiceName contains \\\"office.com\\\"\\r\\n| where DeviceEventClassID contains \\\"Allow\\\" \\r\\n| summarize BW_usage_MB = sum((ReceivedBytes+SentBytes)/1024.0/1024.0)  by bin(TimeGenerated, {TimeRange:grain}),  SourceUserPrivileges\",\"size\":0,\"title\":\"BW consumption, by Microsoft apps (based on Location)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DestinationServiceName contains \\\"Microsoft\\\" or DestinationServiceName contains  \\\"Skype\\\"  or DestinationServiceName contains \\\"Sharepoint\\\" or DestinationServiceName contains \\\"Onedrive\\\"  or DestinationServiceName contains \\\"Outlook\\\" or DestinationServiceName contains \\\"office.com\\\"\\r\\n| where DeviceEventClassID contains \\\"Allow\\\" \\r\\n| summarize sum((ReceivedBytes+SentBytes)/1024.0/1024.0)  by bin(TimeGenerated, {TimeRange:grain}),  DestinationServiceName\",\"size\":0,\"title\":\"BW consumption, by Microsoft Apps (based on App)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DestinationServiceName contains \\\"Microsoft\\\" or DestinationServiceName contains  \\\"Skype\\\"  or DestinationServiceName contains \\\"Sharepoint\\\" or DestinationServiceName contains \\\"Onedrive\\\"  or DestinationServiceName contains \\\"Outlook\\\" or DestinationServiceName contains \\\"office.com\\\"\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where DeviceCustomString2 == \\\"Phishing\\\"\\r\\n| summarize count()  by bin(TimeGenerated, {TimeRange:grain}), DestinationServiceName\",\"size\":0,\"title\":\"Phishing attempts disguised as Microsoft services\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"DestinationServiceName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 5\"}],\"fromTemplateId\":\"sentinel-ZscalerOffice365Apps\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId3'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId3')]",
                "contentId": "[variables('_workbookContentId3')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId3')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook3-name')]",
        "contentProductId": "[variables('_workbookcontentProductId3')]",
        "id": "[variables('_workbookcontentProductId3')]",
        "version": "[variables('workbookVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Firewall log overview with blocked traffic, top ports, and bandwidth trends.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion4')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId4')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Firewall log overview with blocked traffic, top ports, and bandwidth trends."
              },
              "properties": {
                "displayName": "[parameters('workbook4-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler Firewall Overview\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"ff5a2a6c-cf01-432a-ab49-e59918ead8ab\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":86400000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}},{\"id\":\"fe452f11-ddc9-4b85-b441-b8f6be3b33a8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SourceIP\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where SourceTranslatedAddress  != \\\"\\\" \\r\\n| summarize Count = count() by SourceTranslatedAddress\\r\\n| project Value = SourceTranslatedAddress, Label = strcat(SourceTranslatedAddress, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"d5fa439b-b1d7-491e-8953-5e4f7bf74f81\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SourcePort\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\")\\r\\n| where SourcePort  != \\\"\\\" \\r\\n| summarize Count = count() by SourcePort\\r\\n| project Value = SourcePort, Label = strcat(\\\"Port: \\\",SourcePort, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"2f749931-c232-471f-b91f-f91514fd7fa7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DestinationIP\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where DestinationIP  != \\\"\\\" \\r\\n| summarize Count = count() by DestinationIP\\r\\n| project Value = DestinationIP, Label = strcat(DestinationIP, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"5ecf989b-46cc-4cde-80fb-720d1ad2a5e2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DestinationPort\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\"\\r\\n| where DestinationPort  != \\\"\\\" \\r\\n| summarize Count = count() by DestinationPort\\r\\n| project Value = DestinationPort, Label = strcat(DestinationPort, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":1,\"content\":{\"json\":\"### Block actions\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| summarize Count = count() by Protocol\\r\\n| sort by Count desc\\r\\n| top 10 by Count\",\"size\":0,\"title\":\"Top blocked protocols\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where SourceUserPrivileges == SourceUserName\\r\\n| summarize Count = count() by SourceUserName\\r\\n| sort by Count desc\\r\\n| top 10 by Count\",\"size\":0,\"title\":\"Top blocked locations\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where DestinationPort   != \\\"0\\\" \\r\\n| extend dst_port = tostring(DestinationPort) \\r\\n| summarize Count = count() by  dst_port\\r\\n| top 10 by Count desc nulls last \",\"size\":0,\"title\":\"Top blocked destination ports\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where DestinationIP != \\\"\\\" \\r\\n| summarize Count = count() by DestinationIP\\r\\n| sort by Count desc\\r\\n| top 10 by Count\",\"size\":0,\"title\":\"Top blocked destination IP addresses\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where SourceTranslatedAddress  != \\\"\\\" \\r\\n| summarize Count = count() by SourceTranslatedAddress\\r\\n| sort by Count desc\\r\\n| top 10 by Count\",\"size\":0,\"title\":\"Top blocked source IP addresses\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where SourcePort   != \\\"0\\\" \\r\\n| extend src_port = tostring(SourcePort) \\r\\n| summarize Count = count() by  src_port\\r\\n| order by Count\\r\\n| take 10\",\"size\":0,\"title\":\"Top blocked source ports\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 12\"},{\"type\":1,\"content\":{\"json\":\"---\"},\"name\":\"text - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| summarize ['Recived MB'] = sum(ReceivedBytes/1024.0/1024.0), ['Sent MB'] = sum(SentBytes/1024.0/1024.0) by bin(TimeGenerated, {TimeRange:grain}), SourceUserPrivileges\\r\\n| project-rename Location = SourceUserPrivileges \\r\\n| order by ['Recived MB'] desc, ['Sent MB'] desc\",\"size\":0,\"title\":\"Non-http downloads and uploads in MB\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"\",\"exportParameterName\":\"LocationFilter\",\"exportDefaultValue\":\"{\\\"Location\\\":\\\"*\\\"}\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"formatOptions\":{\"min\":0,\"palette\":\"turquoise\",\"showIcon\":true}},{\"columnMatch\":\"Location\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Recived MB\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"purple\",\"showIcon\":true,\"aggregation\":\"Sum\"}},{\"columnMatch\":\"Sent MB\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"magenta\",\"showIcon\":true,\"aggregation\":\"Sum\"}}],\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Location\"],\"expandTopLevel\":false,\"finalBy\":\"Location\"}}},\"customWidth\":\"50\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| summarize ['Recived MB'] = sum(ReceivedBytes/1024.0/1024.0), ['Sent MB'] = sum(SentBytes/1024.0/1024.0) by bin(TimeGenerated, {TimeRange:grain}), SourceUserPrivileges\\r\\n| project-rename Location = SourceUserPrivileges \\r\\n| where Location == dynamic({LocationFilter}).childRows[0].Location or dynamic({LocationFilter}).Location == Location or dynamic({LocationFilter}).Location == \\\"*\\\"\",\"size\":0,\"title\":\"Non-http downloads and uploads in MB\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where Activity !contains \\\"Default\\\"  and Activity !contains \\\"Recommended\\\" \\r\\n| summarize count()  by bin(TimeGenerated, {TimeRange:grain}), Activity \",\"size\":0,\"title\":\"Non-default firewall rules getting triggered\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"name\":\"query - 11\"}],\"fromTemplateId\":\"sentinel-ZscalerFirewallOverview\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId4'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId4')]",
                "contentId": "[variables('_workbookContentId4')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId4')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook4-name')]",
        "contentProductId": "[variables('_workbookcontentProductId4')]",
        "id": "[variables('_workbookcontentProductId4')]",
        "version": "[variables('workbookVersion4')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DNS log trends and detailed event views for Zscaler DNS activity.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion5')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId5')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "DNS log trends and detailed event views for Zscaler DNS activity."
              },
              "properties": {
                "displayName": "[parameters('workbook5-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler DNS Overview\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSDNSlog\\\"\\n| extend EventTimestamp = todatetime(TimeGenerated)\\n| summarize CountByTime = count() by bin(EventTimestamp, 1h), DeviceEventClassID\\n| render timechart \",\"size\":0,\"title\":\"DNS Events Over Time\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSDNSlog\\\"\\n| project EventTimestamp = todatetime(TimeGenerated), SourceIP, DestinationIP, DestinationPort, Action = DeviceAction, Severity = LogSeverity, UserName = SourceUserName, EventType = DeviceEventClassID\\n| sort by EventTimestamp desc \\n| render table\",\"size\":0,\"title\":\"DNS Event Details by Source and Destination\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSDNSlog\\\"\\n| summarize EventCount = count() by DeviceName\\n| render barchart\",\"size\":0,\"title\":\"Distribution of DNS Events by Device\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 2\"}],\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId5'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId5')]",
                "contentId": "[variables('_workbookContentId5')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId5')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook5-name')]",
        "contentProductId": "[variables('_workbookcontentProductId5')]",
        "id": "[variables('_workbookcontentProductId5')]",
        "version": "[variables('workbookVersion5')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Tunnel health and traffic metrics for Zscaler tunnels.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion6')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId6')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Tunnel health and traffic metrics for Zscaler tunnels."
              },
              "properties": {
                "displayName": "[parameters('workbook6-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler Tunnel Overview\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSTunnellog\\\"\\n| where DeviceEventClassID == \\\"Tunnel Samples\\\"\\n| summarize ReceivedBytesSum=sum(ReceivedBytes), SentBytesSum=sum(SentBytes) by bin(TimeGenerated, 30m)\\n| order by TimeGenerated asc\",\"size\":0,\"title\":\"The bytes received and transmitted in a 60-second sample window by Zscaler from the customer\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSTunnellog\\\"\\n| where DeviceEventClassID == \\\"Tunnel Samples\\\"\\n| where DeviceCustomString4 !=\\\"\\\"\\n| distinct DeviceCustomString4 \\n| distinct DeviceCustomString4\\n| project-rename LocationName = DeviceCustomString4\\n| order by LocationName asc // Optional: Orders the distinct names alphabetically\",\"size\":0,\"title\":\"List of locations\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSTunnellog\\\"\\n| where DeviceEventClassID == \\\"Tunnel Event\\\"\\n| summarize Count = count() by Activity, Reason\\n| order by Count desc\",\"size\":0,\"title\":\"Tunnel status events\",\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"name\":\"query - 2\"}],\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId6'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId6')]",
                "contentId": "[variables('_workbookContentId6')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId6')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook6-name')]",
        "contentProductId": "[variables('_workbookcontentProductId6')]",
        "id": "[variables('_workbookcontentProductId6')]",
        "version": "[variables('workbookVersion6')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName7')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Endpoint DLP events, trends, and user activity details.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion7')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId7')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Endpoint DLP events, trends, and user activity details."
              },
              "properties": {
                "displayName": "[parameters('workbook7-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler Endpoint DLP Overview\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSEndpointdlplog\\\"\\n| summarize Count= count() by DeviceEventClassID\\n| render columnchart\",\"size\":0,\"title\":\"Count of Security Events by Event Type\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSEndpointdlplog\\\"\\n| summarize EventCount= count() by bin(TimeGenerated, 1h), DeviceEventClassID\\n| render timechart\",\"size\":0,\"title\":\"Timeline of All Security Events\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSEndpointdlplog\\\"\\n| project User=SourceUserName, EventType=DeviceEventClassID, Description=DeviceCustomString1, FilePath=FilePath, TimeGenerated\\n| sort by TimeGenerated desc \\n| render table\",\"size\":0,\"title\":\"Detailed Event Table with User and Activity Information\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 2\"}],\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId7'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId7')]",
                "contentId": "[variables('_workbookContentId7')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion7')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId7')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook7-name')]",
        "contentProductId": "[variables('_workbookcontentProductId7')]",
        "id": "[variables('_workbookcontentProductId7')]",
        "version": "[variables('workbookVersion7')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName8')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Email DLP incidents, top senders, and rule or file-type breakdowns.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion8')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId8')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Email DLP incidents, top senders, and rule or file-type breakdowns."
              },
              "properties": {
                "displayName": "[parameters('workbook8-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler EMAIL DLP overview\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSEmaildlplog\\\"\\n| where DeviceEventClassID == \\\"DLP Incident\\\"\\n| summarize Incidents = count() \\n    by bin(TimeGenerated, 1h), RuleLabel = coalesce(DeviceCustomString4, \\\"Unknown rule\\\")  // DeviceCustomString4Label == \\\"rulelabels\\\"\\n| order by TimeGenerated asc\",\"size\":1,\"title\":\"DLP incidents over time by DLP rule (trend chart)\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"Incidents\"]}},\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSEmaildlplog\\\"\\n| where DeviceEventClassID == \\\"DLP Incident\\\"\\n| summarize TotalIncidents = count() by SourceUserName\\n| top 10 by TotalIncidents;\",\"size\":0,\"title\":\"Top senders generating DLP incidents\",\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSEmaildlplog\\\"\\n| where DeviceEventClassID == \\\"DLP Incident\\\"\\n| extend FileType = extract(@\\\"ac_filetypes=([^;]+)\\\", 1, AdditionalExtensions)\\n| extend FileType = iff(isempty(FileType), \\\"Unknown\\\", FileType)\\n| extend DlpDictionary = coalesce(DeviceCustomString1, \\\"Unknown dictionary\\\")\\n| summarize Incidents = count() by DlpDictionary, FileType\\n| order by Incidents desc\",\"size\":0,\"title\":\"DLP incidents by dictionary/policy and attachment file type\",\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 3\"}],\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId8'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId8')]",
                "contentId": "[variables('_workbookContentId8')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion8')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId8')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook8-name')]",
        "contentProductId": "[variables('_workbookcontentProductId8')]",
        "id": "[variables('_workbookcontentProductId8')]",
        "version": "[variables('workbookVersion8')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName9')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CASB activity events over time and key actor details.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion9')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId9')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "CASB activity events over time and key actor details."
              },
              "properties": {
                "displayName": "[parameters('workbook9-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler CASB Activity Overview\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbactivitylog\\\"\\n| extend EventTimestamp = todatetime(TimeGenerated)\\n| summarize EventCount = count() by bin(EventTimestamp, 1h), DeviceEventClassID\\n| render timechart\",\"size\":0,\"title\":\"CASB Event Trend Analysis by Type Over Time\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbactivitylog\\\"\\n| summarize EventCount = count() by SourceIP\\n| order by EventCount desc \\n| render piechart\",\"size\":0,\"title\":\"CASB Distribution of Events by Source IP\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbactivitylog\\\"\\n| project EventTimestamp = todatetime(TimeGenerated), User = SourceUserName, Action = DeviceAction, SourceIP\\n| sort by EventTimestamp desc \\n| render table\",\"size\":0,\"title\":\"CASB Detailed Log Entries for Security Events\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 2\"}],\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId9'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId9')]",
                "contentId": "[variables('_workbookContentId9')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion9')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId9')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook9-name')]",
        "contentProductId": "[variables('_workbookcontentProductId9')]",
        "id": "[variables('_workbookcontentProductId9')]",
        "version": "[variables('workbookVersion9')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName10')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CASB cloud storage events and activity details.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion10')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId10')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "CASB cloud storage events and activity details."
              },
              "properties": {
                "displayName": "[parameters('workbook10-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler CASB Cloud Storage Overview\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbcloudstoragelog\\\"\\n| summarize EventCount = count() by DeviceEventClassID\\n| render columnchart\",\"size\":0,\"title\":\"Count of CASB Cloud Storage Events by Application\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbcloudstoragelog\\\"\\n| extend EventTimestamp = todatetime(TimeGenerated)\\n| summarize EventCount = count() by bin(EventTimestamp, 1h)\\n| render timechart\",\"size\":0,\"title\":\"CASB Cloud Storage Events Over Time\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbcloudstoragelog\\\"\\n| project EventTimestamp = todatetime(TimeGenerated), User = SourceUserName, Action = DeviceAction, Identifier = DeviceCustomString1\\n| sort by EventTimestamp desc \\n| render table\",\"size\":0,\"title\":\"CASB Cloud Storage Detailed Security Event Information\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 2\"}],\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId10'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId10')]",
                "contentId": "[variables('_workbookContentId10')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion10')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId10')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook10-name')]",
        "contentProductId": "[variables('_workbookcontentProductId10')]",
        "id": "[variables('_workbookcontentProductId10')]",
        "version": "[variables('workbookVersion10')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName11')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CASB collaboration events and activity details.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion11')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId11')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "CASB collaboration events and activity details."
              },
              "properties": {
                "displayName": "[parameters('workbook11-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler CASB Collab Overview\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbcollablog\\\"\\n| summarize EventCount = count() by DeviceEventClassID\\n| render columnchart\",\"size\":0,\"title\":\"Count of CASB Collab Events by Application\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbcollablog\\\"\\n| extend EventTimestamp = todatetime(TimeGenerated)\\n| summarize EventCount = count() by bin(EventTimestamp, 1h)\\n| render timechart\",\"size\":0,\"title\":\"CASB Collab Events Over Time\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbcollablog\\\"\\n| project EventTimestamp = todatetime(TimeGenerated), User = SourceUserName, Action = DeviceAction, Identifier = DeviceCustomString1\\n| sort by EventTimestamp desc \\n| render table\",\"size\":0,\"title\":\"CASB Collab Detailed Security Event Information\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 2\"}],\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId11'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId11')]",
                "contentId": "[variables('_workbookContentId11')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion11')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId11')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook11-name')]",
        "contentProductId": "[variables('_workbookcontentProductId11')]",
        "id": "[variables('_workbookcontentProductId11')]",
        "version": "[variables('workbookVersion11')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName12')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CASB CRM events and activity details.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion12')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId12')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "CASB CRM events and activity details."
              },
              "properties": {
                "displayName": "[parameters('workbook12-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler CASB CRM Overview\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbcrmlog\\\"\\n| summarize EventCount = count() by DeviceEventClassID\\n| render columnchart\",\"size\":0,\"title\":\"Count of CASB CRM Events by Application\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbcrmlog\\\"\\n| extend EventTimestamp = todatetime(TimeGenerated)\\n| summarize EventCount = count() by bin(EventTimestamp, 1h)\\n| render timechart\",\"size\":0,\"title\":\"CASB CRM Events Over Time\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbcrmlog\\\"\\n| project EventTimestamp = todatetime(TimeGenerated), User = SourceUserName, Action = DeviceAction, Identifier = DeviceCustomString1\\n| sort by EventTimestamp desc \\n| render table\",\"size\":0,\"title\":\"CASB CRM Detailed Security Event Information\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 2\"}],\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId12'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId12')]",
                "contentId": "[variables('_workbookContentId12')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion12')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId12')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook12-name')]",
        "contentProductId": "[variables('_workbookcontentProductId12')]",
        "id": "[variables('_workbookcontentProductId12')]",
        "version": "[variables('workbookVersion12')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName13')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CASB email events with sender or owner details.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion13')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId13')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "CASB email events with sender or owner details."
              },
              "properties": {
                "displayName": "[parameters('workbook13-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler CASB Email Overview\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbemaillog\\\"\\n| summarize EventCount = count() by DeviceEventClassID\\n| render columnchart\",\"size\":0,\"title\":\"Count of CASB Email Events by Application\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbemaillog\\\"\\n| extend EventTimestamp = todatetime(TimeGenerated)\\n| summarize EventCount = count() by bin(EventTimestamp, 1h)\\n| render timechart\",\"size\":0,\"title\":\"CASB Email Events Over Time\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbemaillog\\\"\\n| extend KeyValuePairs = split(AdditionalExtensions, \\\";\\\")\\n| mv-expand KeyValuePairs to typeof(string)\\n| where KeyValuePairs contains \\\"owner=\\\"\\n| extend OwnerValue = tostring(split(KeyValuePairs, \\\"=\\\")[1])\\n| project EventTimestamp = todatetime(TimeGenerated), User = OwnerValue, Action = DeviceAction, Identifier = DeviceCustomString1\\n| sort by EventTimestamp desc \\n| render table\",\"size\":0,\"title\":\"CASB Email Detailed Security Event Information\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 2\"}],\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId13'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId13')]",
                "contentId": "[variables('_workbookContentId13')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion13')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId13')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook13-name')]",
        "contentProductId": "[variables('_workbookcontentProductId13')]",
        "id": "[variables('_workbookcontentProductId13')]",
        "version": "[variables('workbookVersion13')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName14')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CASB file sharing events and activity details.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion14')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId14')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "CASB file sharing events and activity details."
              },
              "properties": {
                "displayName": "[parameters('workbook14-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler CASB File Sharing Overview\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbfilesharinglog\\\"\\n| summarize EventCount = count() by DeviceEventClassID\\n| render columnchart\",\"size\":0,\"title\":\"Count of CASB File Sharing Events by Application\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbfilesharinglog\\\"\\n| extend EventTimestamp = todatetime(TimeGenerated)\\n| summarize EventCount = count() by bin(EventTimestamp, 1h)\\n| render timechart\",\"size\":0,\"title\":\"CASB File Sharing Events Over Time\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbfilesharinglog\\\"\\n| project EventTimestamp = todatetime(TimeGenerated), User = SourceUserName, Action = DeviceAction, Identifier = DeviceCustomString1\\n| sort by EventTimestamp desc \\n| render table\",\"size\":0,\"title\":\"CASB File Sharing Detailed Security Event Information\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 2\"}],\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId14'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId14')]",
                "contentId": "[variables('_workbookContentId14')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion14')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId14')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook14-name')]",
        "contentProductId": "[variables('_workbookcontentProductId14')]",
        "id": "[variables('_workbookcontentProductId14')]",
        "version": "[variables('workbookVersion14')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName15')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CASB ITSM events and activity details.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion15')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId15')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "CASB ITSM events and activity details."
              },
              "properties": {
                "displayName": "[parameters('workbook15-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler CASB ITSM Overview\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbitsmlog\\\"\\n| summarize EventCount = count() by DeviceEventClassID\\n| render columnchart\",\"size\":0,\"title\":\"Count of CASB ITSM Events by Application\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbitsmlog\\\"\\n| extend EventTimestamp = todatetime(TimeGenerated)\\n| summarize EventCount = count() by bin(EventTimestamp, 1h)\\n| render timechart\",\"size\":0,\"title\":\"CASB ITSM Events Over Time\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbitsmlog\\\"\\n| project EventTimestamp = todatetime(TimeGenerated), User = SourceUserName, Action = DeviceAction, Identifier = DeviceCustomString1\\n| sort by EventTimestamp desc \\n| render table\",\"size\":0,\"title\":\"CASB ITSM Detailed Security Event Information\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 2\"}],\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId15'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId15')]",
                "contentId": "[variables('_workbookContentId15')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion15')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId15')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook15-name')]",
        "contentProductId": "[variables('_workbookcontentProductId15')]",
        "id": "[variables('_workbookcontentProductId15')]",
        "version": "[variables('workbookVersion15')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName16')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CASB repository events and activity details.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion16')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId16')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "CASB repository events and activity details."
              },
              "properties": {
                "displayName": "[parameters('workbook16-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler CASB Repo Overview\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbrepolog\\\"\\n| summarize EventCount = count() by DeviceEventClassID\\n| render columnchart\",\"size\":0,\"title\":\"Count of CASB Repo Events by Application\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbrepolog\\\"\\n| extend EventTimestamp = todatetime(TimeGenerated)\\n| summarize EventCount = count() by bin(EventTimestamp, 1h)\\n| render timechart\",\"size\":0,\"title\":\"CASB Repo Events Over Time\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSCasbrepolog\\\"\\n| project EventTimestamp = todatetime(TimeGenerated), User = SourceUserName, Action = DeviceAction, Identifier = DeviceCustomString1\\n| sort by EventTimestamp desc \\n| render table\",\"size\":0,\"title\":\"CASB Repo Detailed Security Event Information\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 2\"}],\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId16'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId16')]",
                "contentId": "[variables('_workbookContentId16')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion16')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId16')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook16-name')]",
        "contentProductId": "[variables('_workbookcontentProductId16')]",
        "id": "[variables('_workbookcontentProductId16')]",
        "version": "[variables('workbookVersion16')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName17')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Admin audit events, login outcomes, and actions performed in Zscaler.",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion17')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId17')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Admin audit events, login outcomes, and actions performed in Zscaler."
              },
              "properties": {
                "displayName": "[parameters('workbook17-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler Admin Audit Overview\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSAuditlog\\\"\\n| where SourceUserName !=\\\"\\\"\\n| summarize Count = count() by SourceUserName, SourceIP\\n| order by Count desc\",\"size\":0,\"title\":\"Access attempts by account name and IP address\",\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSAuditlog\\\"\\n| where EventOutcome !=\\\"\\\"\\n| summarize Count = count() by EventOutcome\\n| order by Count desc\",\"size\":0,\"title\":\"Login success and failures\",\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"EventOutcome\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Count\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"Count\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"Count\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"Count\",\"heatmapPalette\":\"greenRed\"}}},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"Zscaler\\\"\\n| where DeviceProduct == \\\"NSSAuditlog\\\"\\n| where DeviceEventClassID !=\\\"\\\"\\n| summarize Count = count() by DeviceEventClassID\\n| order by Count desc\",\"size\":0,\"title\":\"Action carried out by user\",\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"unstackedbar\"},\"name\":\"query - 2\"}],\"fallbackResourceIds\":[\"/subscriptions/<your subscription id>/resourcegroups/<your log analytics resource group>/providers/microsoft.operationalinsights/workspaces/<your log analytics workspace name>\"],\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId17'),'/'))))]",
              "properties": {
                "description": ".description",
                "parentId": "[variables('workbookId17')]",
                "contentId": "[variables('_workbookContentId17')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion17')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId17')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook17-name')]",
        "contentProductId": "[variables('_workbookcontentProductId17')]",
        "id": "[variables('_workbookcontentProductId17')]",
        "version": "[variables('workbookVersion17')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zscaler-Oauth2-Authentication Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Oauth2-Authentication",
              "type": "string",
              "minLength": 1,
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "OAuthClientId": {
              "type": "string",
              "minLength": 1,
              "metadata": {
                "description": "OAuth2 client ID for Zscaler API access"
              }
            },
            "OAuthClientSecret": {
              "type": "securestring",
              "minLength": 1,
              "metadata": {
                "description": "OAuth2 client secret for Zscaler API access"
              }
            },
            "OAuthTokenUrl": {
              "type": "string",
              "minLength": 1,
              "metadata": {
                "description": "Zscaler OAuth2 token endpoint URL (e.g., https://admin.zscaler.net/api/v1/oauth/token or contact your Zscaler admin for the correct endpoint)"
              }
            }
          },
          "variables": {
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "auth": "Oauth2",
                "hidden-SentinelTemplateName": "Zscaler-Oauth2-Authentication",
                "hidden-SentinelTemplateVersion": "2.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "clientId": {
                      "defaultValue": "[[parameters('OAuthClientId')]",
                      "type": "String"
                    },
                    "clientSecret": {
                      "defaultValue": "[[parameters('OAuthClientSecret')]",
                      "type": "SecureString"
                    },
                    "oauthUrl": {
                      "defaultValue": "[[parameters('OAuthTokenUrl')]",
                      "type": "String"
                    }
                  },
                  "triggers": {
                    "manual": {
                      "type": "Request",
                      "kind": "Http",
                      "inputs": {}
                    }
                  },
                  "actions": {
                    "HTTP_Get_OAuth_Token": {
                      "runAfter": {},
                      "type": "Http",
                      "inputs": {
                        "body": "grant_type=client_credentials&client_id=@{encodeUriComponent(parameters('clientId'))}&client_secret=@{encodeUriComponent(parameters('clientSecret'))}",
                        "headers": {
                          "Content-Type": "application/x-www-form-urlencoded"
                        },
                        "method": "POST",
                        "uri": "@parameters('oauthUrl')"
                      },
                      "runtimeConfiguration": {
                        "secureData": {
                          "properties": [
                            "inputs",
                            "outputs"
                          ]
                        }
                      }
                    },
                    "Parse_Token_Response": {
                      "runAfter": {
                        "HTTP_Get_OAuth_Token": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('HTTP_Get_OAuth_Token')",
                        "schema": {
                          "properties": {
                            "access_token": {
                              "type": "string"
                            },
                            "expires_in": {
                              "type": "integer"
                            },
                            "ext_expires_in": {
                              "type": "integer"
                            },
                            "token_type": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "Response": {
                      "runAfter": {
                        "Parse_Token_Response": [
                          "Succeeded"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": "@body('HTTP_Get_OAuth_Token')",
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "statusCode": 200
                      }
                    }
                  },
                  "outputs": {}
                },
                "parameters": {
                  "clientId": {
                    "value": "[[parameters('OAuthClientId')]"
                  },
                  "clientSecret": {
                    "value": "[[parameters('OAuthClientSecret')]"
                  },
                  "oauthUrl": {
                    "value": "[[parameters('OAuthTokenUrl')]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Zscaler OAuth2 Authentication",
            "description": "This playbook obtains OAuth2 access tokens for Zscaler Internet Access (ZIA) integrations using Zscaler ZIdentity OAuth and returns the token response.",
            "prerequisites": [
              "1. Zscaler Internet Access (ZIA) subscription with API access enabled",
              "2. OAuth2 client credentials (Client ID and Client Secret) from the Zscaler admin portal"
            ],
            "lastUpdateTime": "2025-09-02T00:00:00Z",
            "tags": [
              "Utilities"
            ],
            "source": {
              "type": "solution",
              "name": "Zscaler Internet Access"
            },
            "postDeployment": [
              "**a. Validate**",
              "Trigger the playbook and confirm a token is returned."
            ],
            "releaseNotes": [
              {
                "version": "2.0.0",
                "title": "Zscaler OAuth2 Authentication - ZIdentity",
                "notes": [
                  "Updated to use Zscaler native OAuth (ZIdentity)",
                  "Removed Azure Key Vault dependency",
                  "Simplified authentication flow"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId1')]",
        "contentKind": "Playbook",
        "displayName": "Zscaler-Oauth2-Authentication",
        "contentProductId": "[variables('_playbookcontentProductId1')]",
        "id": "[variables('_playbookcontentProductId1')]",
        "version": "[variables('playbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zscaler-Oauth2-BlacklistURL Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Oauth2-BlacklistURL",
              "type": "String",
              "minLength": 1,
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "Zscaler OAuth2 Authentication Playbook": {
              "defaultValue": "Zscaler-Oauth2-Authentication",
              "type": "String",
              "metadata": {
                "description": "Name of the Zscaler OAuth2 Authentication Playbook"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
            "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler OAuth2 Authentication Playbook'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "auth": "Oauth2",
                "hidden-SentinelTemplateName": "Zscaler-Oauth2-BlacklistURL",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "defaultValue": {},
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel_1']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Initialize_URLs_to_Add": {
                      "runAfter": {},
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "URLsToAdd",
                            "type": "array",
                            "value": []
                          }
                        ]
                      }
                    },
                    "Initialize_Security_Config": {
                      "runAfter": {
                        "Initialize_URLs_to_Add": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "SecurityConfig",
                            "type": "object",
                            "value": {}
                          }
                        ]
                      }
                    },
                    "Initialize_Current_Blacklist": {
                      "runAfter": {
                        "Initialize_Security_Config": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "CurrentBlacklist",
                            "type": "array",
                            "value": []
                          }
                        ]
                      }
                    },
                    "Entities_-_Get_URLs": {
                      "runAfter": {
                        "Initialize_Current_Blacklist": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel_1']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/url"
                      }
                    },
                    "For_each_URL_Entity": {
                      "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                      "actions": {
                        "Append_URL_to_list": {
                          "runAfter": {},
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "URLsToAdd",
                            "value": "@items('For_each_URL_Entity')?['Url']"
                          }
                        }
                      },
                      "runAfter": {
                        "Entities_-_Get_URLs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Zscaler-Oauth2-Authentication": {
                      "runAfter": {
                        "For_each_URL_Entity": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "triggerName": "manual",
                          "workflow": {
                            "id": "[[variables('ZscalerAuthenticationFlow')]"
                          }
                        }
                      }
                    },
                    "Parse_Auth_Response": {
                      "runAfter": {
                        "Zscaler-Oauth2-Authentication": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Zscaler-Oauth2-Authentication')",
                        "schema": {
                          "properties": {
                            "access_token": {
                              "type": "string"
                            },
                            "expires_in": {
                              "type": "integer"
                            },
                            "token_type": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "Get_Security_Config": {
                      "runAfter": {
                        "Parse_Auth_Response": [
                          "Succeeded"
                        ]
                      },
                      "type": "Http",
                      "inputs": {
                        "headers": {
                          "Authorization": "Bearer @{body('Parse_Auth_Response')?['access_token']}",
                          "Content-Type": "application/json",
                          "Accept": "application/json"
                        },
                        "method": "GET",
                        "uri": "https://api.zsapi.net/zia/api/v1/security/advanced"
                      }
                    },
                    "Set_Security_Config": {
                      "runAfter": {
                        "Get_Security_Config": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "SecurityConfig",
                        "value": "@body('Get_Security_Config')"
                      }
                    },
                    "Set_Current_Blacklist": {
                      "runAfter": {
                        "Set_Security_Config": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "CurrentBlacklist",
                        "value": "@if(equals(variables('SecurityConfig')?['blacklistUrls'], null), createArray(), variables('SecurityConfig')?['blacklistUrls'])"
                      }
                    },
                    "Compose_Merged_URLs": {
                      "runAfter": {
                        "Set_Current_Blacklist": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "@union(variables('CurrentBlacklist'), variables('URLsToAdd'))"
                    },
                    "Compose_Updated_Config": {
                      "runAfter": {
                        "Compose_Merged_URLs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "@setProperty(variables('SecurityConfig'), 'blacklistUrls', outputs('Compose_Merged_URLs'))"
                    },
                    "Update_Security_Config": {
                      "runAfter": {
                        "Compose_Updated_Config": [
                          "Succeeded"
                        ]
                      },
                      "type": "Http",
                      "inputs": {
                        "body": "@outputs('Compose_Updated_Config')",
                        "headers": {
                          "Authorization": "Bearer @{body('Parse_Auth_Response')?['access_token']}",
                          "Content-Type": "application/json",
                          "Accept": "application/json"
                        },
                        "method": "PUT",
                        "uri": "https://api.zsapi.net/zia/api/v1/security/advanced"
                      }
                    },
                    "Add_comment_to_incident": {
                      "runAfter": {
                        "Update_Security_Config": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "message": "<p><strong>Zscaler Blacklist URL</strong><br>The following URLs have been added to the Zscaler blacklist:<br>@{join(variables('URLsToAdd'), '<br>')}</p>"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel_1']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/Incidents/Comment"
                      }
                    }
                  },
                  "outputs": {}
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel_1": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Zscaler OAuth2 Blacklist URL",
            "description": "This playbook adds URLs to the Zscaler security blacklist using OAuth2 authentication.",
            "mainSteps": [
              "1. Gets URL entities from the incident",
              "2. Uses the OAuth2 authentication playbook to acquire an access token",
              "3. Gets current security config from /zia/api/v1/security/advanced",
              "4. Adds new URLs to the blacklistUrls array (skipping duplicates)",
              "5. Updates the security configuration with PUT request preserving all fields"
            ],
            "prerequisites": [
              "1. Deploy the Zscaler-Oauth2-Authentication playbook in the same resource group",
              "2. Ensure the Logic App managed identity has Microsoft Sentinel Responder permissions"
            ],
            "lastUpdateTime": "2025-01-07T00:00:00Z",
            "entities": [
              "Url"
            ],
            "tags": [
              "Remediation"
            ],
            "source": {
              "type": "solution",
              "name": "Zscaler Internet Access"
            },
            "postDeployment": [
              "**a. Authorize API connections**",
              "Authorize the Microsoft Sentinel connection."
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Zscaler OAuth2 Blacklist URL",
                "notes": [
                  "Initial version - uses security/advanced blacklistUrls API"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId2')]",
        "contentKind": "Playbook",
        "displayName": "Zscaler-Oauth2-BlacklistURL",
        "contentProductId": "[variables('_playbookcontentProductId2')]",
        "id": "[variables('_playbookcontentProductId2')]",
        "version": "[variables('playbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zscaler-Oauth2-BlockIP Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Oauth2-BlockIP",
              "type": "String",
              "minLength": 1,
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "Zscaler OAuth2 Authentication Playbook": {
              "defaultValue": "Zscaler-Oauth2-Authentication",
              "type": "String",
              "metadata": {
                "description": "Name of the Zscaler OAuth2 Authentication Playbook"
              }
            },
            "Zscaler Admin Url": {
              "defaultValue": "https://admin.zscaler.net",
              "type": "String",
              "metadata": {
                "description": "Update to a valid Zscaler admin url."
              }
            },
            "Block Category": {
              "defaultValue": "OTHER_MISCELLANEOUS",
              "type": "String",
              "metadata": {
                "description": "Zscaler block category"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler OAuth2 Authentication Playbook'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "auth": "Oauth2",
                "hidden-SentinelTemplateName": "Zscaler-Oauth2-BlockIP",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "defaultValue": {},
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Set_Zscaler_Block_Category": {
                      "runAfter": {},
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Category",
                            "type": "string",
                            "value": "[[parameters('Block Category')]"
                          }
                        ]
                      }
                    },
                    "Entities_-_Get_IPs": {
                      "runAfter": {
                        "Set_Zscaler_Block_Category": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "zscaler": {
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "triggerName": "manual",
                          "workflow": {
                            "id": "[[variables('ZscalerAuthenticationFlow')]"
                          }
                        }
                      }
                    },
                    "Parse_Authentication_Response": {
                      "runAfter": {
                        "zscaler": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('zscaler')",
                        "schema": {
                          "properties": {
                            "access_token": {
                              "type": "string"
                            },
                            "expires_in": {
                              "type": "integer"
                            },
                            "ext_expires_in": {
                              "type": "integer"
                            },
                            "token_type": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "For_each": {
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "actions": {
                        "HTTP_Add_IP": {
                          "runAfter": {},
                          "type": "Http",
                          "inputs": {
                            "body": {
                              "urls": [
                                "@{items('For_each')?['Address']}"
                              ]
                            },
                            "headers": {
                              "Authorization": "@{concat(body('Parse_Authentication_Response')?['token_type'], ' ', body('Parse_Authentication_Response')?['access_token'])}",
                              "Cache-Control": "no-cache",
                              "Content-Type": "application/json"
                            },
                            "method": "PUT",
                            "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), '/zia/api/v1/urlCategories/@{variables(''Category'')}?action=ADD_TO_LIST'))]"
                          }
                        },
                        "HTTP_Activate_Changes": {
                          "runAfter": {
                            "HTTP_Add_IP": [
                              "Succeeded"
                            ]
                          },
                          "type": "Http",
                          "inputs": {
                            "headers": {
                              "Authorization": "@{concat(body('Parse_Authentication_Response')?['token_type'], ' ', body('Parse_Authentication_Response')?['access_token'])}",
                              "Cache-Control": "no-cache"
                            },
                            "method": "POST",
                            "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), '/zia/api/v1/status/activate'))]"
                          }
                        },
                        "Compose": {
                          "runAfter": {
                            "HTTP_Activate_Changes": [
                              "Succeeded"
                            ]
                          },
                          "type": "Compose",
                          "inputs": "<img src=\"https://www.zscaler.com//themes/custom/zscaler/logo.svg\" alt=\"Zscaler\">"
                        },
                        "Add_comment_to_incident_(V3)": {
                          "runAfter": {
                            "Compose": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "[concat('<p>@{outputs(''Compose'')}<br>IP @{items(''For_each'')?[''Address'']} has been added to category @{variables(''Category'')}</p>')]"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          }
                        }
                      },
                      "runAfter": {
                        "Parse_Authentication_Response": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    }
                  },
                  "outputs": {}
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Zscaler OAuth2 Block IP",
            "description": "This playbook blocks IP addresses in Zscaler by adding them to a category using OAuth2 authentication.",
            "mainSteps": [
              "1. Gets IP entities from the incident",
              "2. Uses the OAuth2 authentication playbook to acquire an access token",
              "3. Adds IP addresses to the configured Zscaler block category and activates changes"
            ],
            "prerequisites": [
              "1. Deploy the Zscaler-Oauth2-Authentication playbook in the same resource group",
              "2. Create a block category in Zscaler to add IP addresses",
              "3. Ensure the Logic App managed identity has Microsoft Sentinel Responder permissions"
            ],
            "lastUpdateTime": "2025-09-02T00:00:00Z",
            "entities": [
              "IP"
            ],
            "tags": [
              "Remediation"
            ],
            "source": {
              "type": "solution",
              "name": "Zscaler Internet Access"
            },
            "postDeployment": [
              "**a. Authorize API connections**",
              "Authorize the Microsoft Sentinel connection.",
              "**b. Configure category**",
              "Confirm the block category exists in Zscaler."
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Zscaler OAuth2 Block IP",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId3')]",
        "contentKind": "Playbook",
        "displayName": "Zscaler-Oauth2-BlockIP",
        "contentProductId": "[variables('_playbookcontentProductId3')]",
        "id": "[variables('_playbookcontentProductId3')]",
        "version": "[variables('playbookVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zscaler-Oauth2-BlockURL Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Oauth2-BlockURL",
              "type": "String",
              "minLength": 1,
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "Zscaler OAuth2 Authentication Playbook": {
              "defaultValue": "Zscaler-Oauth2-Authentication",
              "type": "String",
              "metadata": {
                "description": "Name of the Zscaler OAuth2 Authentication Playbook"
              }
            },
            "Zscaler Admin Url": {
              "defaultValue": "https://admin.zscaler.net",
              "type": "String",
              "metadata": {
                "description": "Update to a valid Zscaler admin url."
              }
            },
            "Block Category": {
              "defaultValue": "OTHER_MISCELLANEOUS",
              "type": "String",
              "metadata": {
                "description": "Zscaler block category"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler OAuth2 Authentication Playbook'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "auth": "Oauth2",
                "hidden-SentinelTemplateName": "Zscaler-Oauth2-BlockURL",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "defaultValue": {},
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Set_Zscaler_Block_Category": {
                      "runAfter": {},
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Category",
                            "type": "string",
                            "value": "[[parameters('Block Category')]"
                          }
                        ]
                      }
                    },
                    "Entities_-_Get_URLs": {
                      "runAfter": {
                        "Set_Zscaler_Block_Category": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/url"
                      }
                    },
                    "zscaler": {
                      "runAfter": {
                        "Entities_-_Get_URLs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "triggerName": "manual",
                          "workflow": {
                            "id": "[[variables('ZscalerAuthenticationFlow')]"
                          }
                        }
                      }
                    },
                    "Parse_Authentication_Response": {
                      "runAfter": {
                        "zscaler": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('zscaler')",
                        "schema": {
                          "properties": {
                            "access_token": {
                              "type": "string"
                            },
                            "expires_in": {
                              "type": "integer"
                            },
                            "ext_expires_in": {
                              "type": "integer"
                            },
                            "token_type": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "For_each": {
                      "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                      "actions": {
                        "HTTP_Add_URL": {
                          "runAfter": {},
                          "type": "Http",
                          "inputs": {
                            "body": {
                              "configuredName": "@{variables('Category')}",
                              "urls": [
                                "@{items('For_each')?['Url']}"
                              ]
                            },
                            "headers": {
                              "Authorization": "@{concat(body('Parse_Authentication_Response')?['token_type'], ' ', body('Parse_Authentication_Response')?['access_token'])}",
                              "Cache-Control": "no-cache",
                              "Content-Type": "application/json"
                            },
                            "method": "PUT",
                            "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), '/zia/api/v1/urlCategories/@{variables(''Category'')}?action=ADD_TO_LIST'))]"
                          }
                        },
                        "HTTP_Activate_Changes": {
                          "runAfter": {
                            "HTTP_Add_URL": [
                              "Succeeded"
                            ]
                          },
                          "type": "Http",
                          "inputs": {
                            "headers": {
                              "Authorization": "@{concat(body('Parse_Authentication_Response')?['token_type'], ' ', body('Parse_Authentication_Response')?['access_token'])}",
                              "Cache-Control": "no-cache"
                            },
                            "method": "POST",
                            "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), '/zia/api/v1/status/activate'))]"
                          }
                        },
                        "Compose": {
                          "runAfter": {
                            "HTTP_Activate_Changes": [
                              "Succeeded"
                            ]
                          },
                          "type": "Compose",
                          "inputs": "<img src=\"https://www.zscaler.com//themes/custom/zscaler/logo.svg\" alt=\"Zscaler\">"
                        },
                        "Add_comment_to_incident_(V3)": {
                          "runAfter": {
                            "Compose": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "[concat('<p>@{outputs(''Compose'')}<br>Url @{items(''For_each'')?[''Url'']} has been added to category @{variables(''Category'')}</p>')]"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          }
                        }
                      },
                      "runAfter": {
                        "Parse_Authentication_Response": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    }
                  },
                  "outputs": {}
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Zscaler OAuth2 Block URL",
            "description": "This playbook blocks URLs in Zscaler by adding them to a category using OAuth2 authentication.",
            "mainSteps": [
              "1. Gets URL entities from the incident",
              "2. Uses the OAuth2 authentication playbook to acquire an access token",
              "3. Adds URLs to the configured Zscaler block category and activates changes"
            ],
            "prerequisites": [
              "1. Deploy the Zscaler-Oauth2-Authentication playbook in the same resource group",
              "2. Create a block category in Zscaler to add URLs",
              "3. Ensure the Logic App managed identity has Microsoft Sentinel Responder permissions"
            ],
            "lastUpdateTime": "2025-09-02T00:00:00Z",
            "entities": [
              "Url"
            ],
            "tags": [
              "Remediation"
            ],
            "source": {
              "type": "solution",
              "name": "Zscaler Internet Access"
            },
            "postDeployment": [
              "**a. Authorize API connections**",
              "Authorize the Microsoft Sentinel connection.",
              "**b. Configure category**",
              "Confirm the block category exists in Zscaler."
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Zscaler OAuth2 Block URL",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId4')]",
        "contentKind": "Playbook",
        "displayName": "Zscaler-Oauth2-BlockURL",
        "contentProductId": "[variables('_playbookcontentProductId4')]",
        "id": "[variables('_playbookcontentProductId4')]",
        "version": "[variables('playbookVersion4')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zscaler-Oauth2-LookupIP Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion5')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Oauth2-LookupIP",
              "type": "String",
              "minLength": 1,
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "Zscaler OAuth2 Authentication Playbook": {
              "defaultValue": "Zscaler-Oauth2-Authentication",
              "type": "String",
              "metadata": {
                "description": "Name of the Zscaler OAuth2 Authentication Playbook"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler OAuth2 Authentication Playbook'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "auth": "Oauth2",
                "hidden-SentinelTemplateName": "Zscaler-Oauth2-LookupIP",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "defaultValue": {},
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_IPs": {
                      "runAfter": {},
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "Initialize_variable": {
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "BaseURL",
                            "type": "string",
                            "value": "api.zsapi.net"
                          }
                        ]
                      }
                    },
                    "Zscaler-Oauth2-Authentication": {
                      "runAfter": {
                        "Initialize_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "triggerName": "manual",
                          "workflow": {
                            "id": "[[variables('ZscalerAuthenticationFlow')]"
                          }
                        }
                      }
                    },
                    "Parse_Zscaler-Oauth2-Authentication_JSON_Response": {
                      "runAfter": {
                        "Zscaler-Oauth2-Authentication": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Zscaler-Oauth2-Authentication')",
                        "schema": {
                          "properties": {
                            "access_token": {
                              "type": "string"
                            },
                            "expires_in": {
                              "type": "integer"
                            },
                            "ext_expires_in": {
                              "type": "integer"
                            },
                            "token_type": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "For_each": {
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "actions": {
                        "HTTP": {
                          "runAfter": {},
                          "type": "Http",
                          "inputs": {
                            "body": [
                              "@{items('For_each')?['Address']}"
                            ],
                            "headers": {
                              "Authorization": "Bearer @{body('Parse_Zscaler-Oauth2-Authentication_JSON_Response')?['access_token']}"
                            },
                            "method": "POST",
                            "uri": "https://api.zsapi.net/zia/api/v1/urlLookup"
                          }
                        },
                        "Parse_JSON": {
                          "runAfter": {
                            "HTTP": [
                              "Succeeded"
                            ]
                          },
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@body('HTTP')",
                            "schema": {
                              "items": {
                                "properties": {
                                  "url": {
                                    "type": "string"
                                  },
                                  "urlClassifications": {
                                    "items": {
                                      "type": "string"
                                    },
                                    "type": "array"
                                  },
                                  "urlClassificationsWithSecurityAlert": {
                                    "type": "array"
                                  }
                                },
                                "required": [
                                  "url",
                                  "urlClassifications",
                                  "urlClassificationsWithSecurityAlert"
                                ],
                                "type": "object"
                              },
                              "type": "array"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Parse_Zscaler-Oauth2-Authentication_JSON_Response": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    }
                  },
                  "outputs": {}
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId5'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId5')]",
                "contentId": "[variables('_playbookContentId5')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Zscaler OAuth2 Lookup IP",
            "description": "This playbook looks up IP address classifications in Zscaler Internet Access using OAuth2 authentication.",
            "mainSteps": [
              "1. Extracts IP entities from the incident",
              "2. Uses the OAuth2 authentication playbook to obtain an access token",
              "3. Queries the Zscaler URL lookup API for each IP address"
            ],
            "prerequisites": [
              "1. Zscaler Internet Access subscription with API access enabled",
              "2. Deploy the Zscaler-Oauth2-Authentication playbook in the same resource group",
              "3. Store OAuth2 client credentials in Azure Key Vault",
              "4. Assign Microsoft Sentinel Responder permissions to the Logic App managed identity"
            ],
            "lastUpdateTime": "2025-09-02T00:00:00Z",
            "entities": [
              "IP"
            ],
            "tags": [
              "Enrichment"
            ],
            "source": {
              "type": "solution",
              "name": "Zscaler Internet Access"
            },
            "postDeployment": [
              "**a. Authorize API connections**",
              "Authorize the Microsoft Sentinel connection.",
              "**b. Configure permissions**",
              "Assign the Microsoft Sentinel Responder role to the Logic App managed identity.",
              "**c. Optional configuration**",
              "Update the BaseURL variable if you need a different Zscaler API endpoint."
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Zscaler OAuth2 Lookup IP",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId5')]",
        "contentKind": "Playbook",
        "displayName": "Zscaler-Oauth2-LookupIP",
        "contentProductId": "[variables('_playbookcontentProductId5')]",
        "id": "[variables('_playbookcontentProductId5')]",
        "version": "[variables('playbookVersion5')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zscaler-Oauth2-LookupSandboxReport Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion6')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Oauth2-LookupSandboxReport",
              "type": "String",
              "minLength": 1,
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "Zscaler OAuth2 Authentication Playbook": {
              "defaultValue": "Zscaler-Oauth2-Authentication",
              "type": "String",
              "metadata": {
                "description": "Name of the Zscaler OAuth2 Authentication Playbook"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler OAuth2 Authentication Playbook'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "auth": "Oauth2",
                "hidden-SentinelTemplateName": "Zscaler-Oauth2-LookupSandboxReport",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "integrationAccount": {
                  "name": "Zscaler-Logicapp",
                  "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/integrationAccounts/Zscaler-Logicapp')]",
                  "type": "Microsoft.Logic/integrationAccounts"
                },
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "defaultValue": {},
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Get_Base_URL": {
                      "runAfter": {},
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "BaseURL",
                            "type": "string",
                            "value": "api.zsapi.net"
                          }
                        ]
                      }
                    },
                    "Entities_-_Get_FileHashes": {
                      "runAfter": {
                        "Get_Base_URL": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/filehash"
                      }
                    },
                    "Get_MD5_Hash": {
                      "foreach": "@body('Entities_-_Get_FileHashes')?['Filehashes']",
                      "actions": {
                        "Parse_JSON": {
                          "runAfter": {},
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('Get_MD5_Hash')",
                            "schema": {
                              "properties": {
                                "Type": {
                                  "type": "string"
                                },
                                "Value": {
                                  "type": "string"
                                },
                                "algorithm": {
                                  "type": "string"
                                },
                                "friendlyName": {
                                  "type": "string"
                                },
                                "hashValue": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "Extract_MD5_Hash": {
                          "runAfter": {
                            "Parse_JSON": [
                              "Succeeded"
                            ]
                          },
                          "type": "Compose",
                          "inputs": "@if(contains(body('Parse_JSON')?['hashValue'], 'md5hashcs6Label='), first(split(last(split(body('Parse_JSON')?['hashValue'], 'md5hashcs6Label=')), ';')), body('Parse_JSON')?['hashValue'])"
                        },
                        "Zscaler-Oauth2-Authentication_2": {
                          "runAfter": {
                            "Extract_MD5_Hash": [
                              "Succeeded"
                            ]
                          },
                          "type": "Workflow",
                          "inputs": {
                            "host": {
                              "triggerName": "manual",
                              "workflow": {
                                "id": "[[variables('ZscalerAuthenticationFlow')]"
                              }
                            }
                          }
                        },
                        "Parse_JSON_2": {
                          "runAfter": {
                            "Zscaler-Oauth2-Authentication_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@body('Zscaler-Oauth2-Authentication_2')",
                            "schema": {
                              "properties": {
                                "access_token": {
                                  "type": "string"
                                },
                                "expires_in": {
                                  "type": "integer"
                                },
                                "ext_expires_in": {
                                  "type": "integer"
                                },
                                "token_type": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "HTTP": {
                          "runAfter": {
                            "Parse_JSON_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "Http",
                          "inputs": {
                            "headers": {
                              "Authorization": "Bearer @{body('Parse_JSON_2')?['access_token']}"
                            },
                            "method": "GET",
                            "uri": "https://api.zsapi.net/zia/api/v1/sandbox/report/@{outputs('Extract_MD5_Hash')}?details=full"
                          }
                        }
                      },
                      "runAfter": {
                        "Entities_-_Get_FileHashes": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    }
                  },
                  "outputs": {}
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId6'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId6')]",
                "contentId": "[variables('_playbookContentId6')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Zscaler OAuth2 Lookup Sandbox Report",
            "description": "This playbook retrieves sandbox report details for file hashes in Zscaler Internet Access using OAuth2 authentication.",
            "mainSteps": [
              "1. Extracts file hash entities from the incident",
              "2. Parses MD5 hashes from file hash data",
              "3. Uses the OAuth2 authentication playbook to obtain an access token",
              "4. Queries the Zscaler Sandbox Report API for each MD5 hash"
            ],
            "prerequisites": [
              "1. Zscaler Internet Access subscription with API access and Cloud Sandbox enabled",
              "2. Deploy the Zscaler-Oauth2-Authentication playbook in the same resource group",
              "3. Create an Integration Account named \"Zscaler-Logicapp\" in the same resource group",
              "4. Store OAuth2 client credentials in Azure Key Vault",
              "5. Assign Microsoft Sentinel Responder permissions to the Logic App managed identity"
            ],
            "lastUpdateTime": "2025-09-02T00:00:00Z",
            "entities": [
              "FileHash"
            ],
            "tags": [
              "Enrichment"
            ],
            "source": {
              "type": "solution",
              "name": "Zscaler Internet Access"
            },
            "postDeployment": [
              "**a. Create integration account**",
              "Create an Integration Account named \"Zscaler-Logicapp\" if it does not already exist.",
              "**b. Authorize API connections**",
              "Authorize the Microsoft Sentinel connection.",
              "**c. Configure permissions**",
              "Assign the Microsoft Sentinel Responder role to the Logic App managed identity.",
              "**d. Optional configuration**",
              "Update the BaseURL variable if you need a different Zscaler API endpoint."
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Zscaler OAuth2 Lookup Sandbox Report",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId6')]",
        "contentKind": "Playbook",
        "displayName": "Zscaler-Oauth2-LookupSandboxReport",
        "contentProductId": "[variables('_playbookcontentProductId6')]",
        "id": "[variables('_playbookcontentProductId6')]",
        "version": "[variables('playbookVersion6')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName7')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zscaler-Oauth2-LookupURL Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion7')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Oauth2-LookupURL",
              "type": "String",
              "minLength": 1,
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "Zscaler OAuth2 Authentication Playbook": {
              "defaultValue": "Zscaler-Oauth2-Authentication",
              "type": "String",
              "metadata": {
                "description": "Name of the Zscaler OAuth2 Authentication Playbook"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler OAuth2 Authentication Playbook'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "auth": "Oauth2",
                "hidden-SentinelTemplateName": "Zscaler-Oauth2-LookupURL",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "defaultValue": {},
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_URLs": {
                      "runAfter": {},
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/url"
                      }
                    },
                    "Initialize_variable": {
                      "runAfter": {
                        "Entities_-_Get_URLs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "BaseURL",
                            "type": "string",
                            "value": "api.zsapi.net"
                          }
                        ]
                      }
                    },
                    "Zscaler-Oauth2-Authentication": {
                      "runAfter": {
                        "Initialize_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "triggerName": "manual",
                          "workflow": {
                            "id": "[[variables('ZscalerAuthenticationFlow')]"
                          }
                        }
                      }
                    },
                    "Parse_Zscaler-Oauth2-Authentication_JSON_Response": {
                      "runAfter": {
                        "Zscaler-Oauth2-Authentication": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Zscaler-Oauth2-Authentication')",
                        "schema": {
                          "properties": {
                            "access_token": {
                              "type": "string"
                            },
                            "expires_in": {
                              "type": "integer"
                            },
                            "ext_expires_in": {
                              "type": "integer"
                            },
                            "token_type": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "For_each": {
                      "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                      "actions": {
                        "HTTP": {
                          "runAfter": {},
                          "type": "Http",
                          "inputs": {
                            "body": [
                              "@{items('For_each')?['Url']}"
                            ],
                            "headers": {
                              "Authorization": "Bearer @{body('Parse_Zscaler-Oauth2-Authentication_JSON_Response')?['access_token']}"
                            },
                            "method": "POST",
                            "uri": "https://api.zsapi.net/zia/api/v1/urlLookup"
                          }
                        },
                        "Parse_JSON": {
                          "runAfter": {
                            "HTTP": [
                              "Succeeded"
                            ]
                          },
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@body('HTTP')",
                            "schema": {
                              "items": {
                                "properties": {
                                  "url": {
                                    "type": "string"
                                  },
                                  "urlClassifications": {
                                    "items": {
                                      "type": "string"
                                    },
                                    "type": "array"
                                  },
                                  "urlClassificationsWithSecurityAlert": {
                                    "type": "array"
                                  }
                                },
                                "required": [
                                  "url",
                                  "urlClassifications",
                                  "urlClassificationsWithSecurityAlert"
                                ],
                                "type": "object"
                              },
                              "type": "array"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Parse_Zscaler-Oauth2-Authentication_JSON_Response": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    }
                  },
                  "outputs": {}
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId7'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId7')]",
                "contentId": "[variables('_playbookContentId7')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion7')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Zscaler OAuth2 Lookup URL",
            "description": "This playbook enables automated URL classification lookup in Zscaler Internet Access using OAuth2 authentication.",
            "mainSteps": [
              "1. Extracts URL entities from the incident",
              "2. Uses the OAuth2 authentication playbook to obtain an access token",
              "3. Queries the Zscaler URL lookup API for each URL",
              "4. Parses URL classification and security alert categories"
            ],
            "prerequisites": [
              "1. Zscaler Internet Access (ZIA) subscription with API access enabled",
              "2. Deploy the Zscaler-Oauth2-Authentication playbook in the same resource group",
              "3. Store OAuth2 client credentials in Azure Key Vault",
              "4. Appropriate permissions to deploy Azure Logic Apps"
            ],
            "lastUpdateTime": "2025-09-02T00:00:00Z",
            "entities": [
              "Url"
            ],
            "tags": [
              "Enrichment"
            ],
            "source": {
              "type": "solution",
              "name": "Zscaler Internet Access"
            },
            "postDeployment": [
              "**a. Authorize API connections**",
              "Authorize the Microsoft Sentinel connection.",
              "**b. Configure permissions**",
              "Assign the Microsoft Sentinel Responder role to the Logic App managed identity.",
              "**c. Optional configuration**",
              "Update the BaseURL variable if you need a different Zscaler API endpoint.",
              "**d. Automation rules**",
              "Create Microsoft Sentinel automation rules to run this playbook on incidents with URL entities."
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Zscaler OAuth2 Lookup URL",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId7')]",
        "contentKind": "Playbook",
        "displayName": "Zscaler-Oauth2-LookupURL",
        "contentProductId": "[variables('_playbookcontentProductId7')]",
        "id": "[variables('_playbookcontentProductId7')]",
        "version": "[variables('playbookVersion7')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName8')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zscaler-Oauth2-UnblacklistURL Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion8')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Oauth2-UnblacklistURL",
              "type": "String",
              "minLength": 1,
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "Zscaler OAuth2 Authentication Playbook": {
              "defaultValue": "Zscaler-Oauth2-Authentication",
              "type": "String",
              "metadata": {
                "description": "Name of the Zscaler OAuth2 Authentication Playbook"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler OAuth2 Authentication Playbook'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "auth": "Oauth2",
                "hidden-SentinelTemplateName": "Zscaler-Oauth2-UnblacklistURL",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "defaultValue": {},
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "New_URL_List": {
                      "runAfter": {},
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "NewURLlist",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Entities_-_Get_URLs": {
                      "runAfter": {
                        "New_URL_List": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/url"
                      }
                    },
                    "For_each_2": {
                      "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                      "actions": {
                        "Parse_JSON_2": {
                          "runAfter": {},
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('For_each_2')",
                            "schema": {
                              "properties": {
                                "Type": {
                                  "type": "string"
                                },
                                "additionalData": {
                                  "properties": {
                                    "DetonationFinalUrl": {
                                      "type": "string"
                                    },
                                    "DetonationVerdict": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "friendlyName": {
                                  "type": "string"
                                },
                                "url": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "Append_to_array_variable": {
                          "runAfter": {
                            "Parse_JSON_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "NewURLlist",
                            "value": "@body('Parse_JSON_2')?['url']"
                          }
                        }
                      },
                      "runAfter": {
                        "Entities_-_Get_URLs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Define_Base_URL": {
                      "runAfter": {
                        "For_each_2": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "BaseURL",
                            "type": "string",
                            "value": "api.zsapi.net"
                          }
                        ]
                      }
                    },
                    "Zscaler-Oauth2-Authentication": {
                      "runAfter": {
                        "Define_Base_URL": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "triggerName": "manual",
                          "workflow": {
                            "id": "[[variables('ZscalerAuthenticationFlow')]"
                          }
                        }
                      }
                    },
                    "Parse_Zscaler-Oauth2-Authentication_JSON_Response": {
                      "runAfter": {
                        "Zscaler-Oauth2-Authentication": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Zscaler-Oauth2-Authentication')",
                        "schema": {
                          "properties": {
                            "access_token": {
                              "type": "string"
                            },
                            "expires_in": {
                              "type": "integer"
                            },
                            "ext_expires_in": {
                              "type": "integer"
                            },
                            "token_type": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "Initialize_variable": {
                      "runAfter": {
                        "Parse_Zscaler-Oauth2-Authentication_JSON_Response": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "FinalListURLs",
                            "type": "array",
                            "value": "@union(variables('NewURLlist'),variables('NewURLlist'))"
                          }
                        ]
                      }
                    },
                    "Join": {
                      "runAfter": {
                        "Initialize_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Join",
                      "inputs": {
                        "from": "@variables('FinalListURLs')",
                        "joinWith": ","
                      }
                    },
                    "JSON_Body": {
                      "runAfter": {
                        "Join": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "JSON Body",
                            "type": "string",
                            "value": "{\"blacklistUrls\":[\"@{body('Join')}\"]}\n"
                          }
                        ]
                      }
                    },
                    "HTTP": {
                      "runAfter": {
                        "JSON_Body": [
                          "Succeeded"
                        ]
                      },
                      "type": "Http",
                      "inputs": {
                        "body": "@replace(variables('JSON Body'),',','\",\"')",
                        "headers": {
                          "Authorization": "Bearer @{body('Parse_Zscaler-Oauth2-Authentication_JSON_Response')?['access_token']}",
                          "Content-Type": "application/json"
                        },
                        "method": "POST",
                        "uri": "https://api.zsapi.net/zia/api/v1/security/advanced/blacklistUrls?action=REMOVE_FROM_LIST"
                      }
                    }
                  },
                  "outputs": {}
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId8'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId8')]",
                "contentId": "[variables('_playbookContentId8')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion8')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Zscaler OAuth2 Unblacklist URL",
            "description": "This playbook enables automated removal of URLs from the Zscaler Internet Access blacklist using OAuth2 authentication.",
            "mainSteps": [
              "1. Extracts URL entities from the incident",
              "2. Collects and deduplicates URLs",
              "3. Uses the OAuth2 authentication playbook to obtain an access token",
              "4. Removes URLs from the blacklist in a single API call"
            ],
            "prerequisites": [
              "1. Zscaler Internet Access (ZIA) subscription with API access enabled",
              "2. Deploy the Zscaler-Oauth2-Authentication playbook in the same resource group",
              "3. Store OAuth2 client credentials in Azure Key Vault",
              "4. Appropriate permissions to deploy Azure Logic Apps"
            ],
            "lastUpdateTime": "2025-09-02T00:00:00Z",
            "entities": [
              "Url"
            ],
            "tags": [
              "Remediation"
            ],
            "source": {
              "type": "solution",
              "name": "Zscaler Internet Access"
            },
            "postDeployment": [
              "**a. Authorize API connections**",
              "Authorize the Microsoft Sentinel connection.",
              "**b. Configure permissions**",
              "Assign the Microsoft Sentinel Responder role to the Logic App managed identity.",
              "**c. Optional configuration**",
              "Update the BaseURL variable if you need a different Zscaler API endpoint.",
              "**d. Automation rules**",
              "Create Microsoft Sentinel automation rules to run this playbook on incidents with URL entities that need to be unblocked."
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Zscaler OAuth2 Unblacklist URL",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId8')]",
        "contentKind": "Playbook",
        "displayName": "Zscaler-Oauth2-UnblacklistURL",
        "contentProductId": "[variables('_playbookcontentProductId8')]",
        "id": "[variables('_playbookcontentProductId8')]",
        "version": "[variables('playbookVersion8')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName9')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zscaler-Oauth2-UnblockIP Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion9')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Oauth2-UnblockIP",
              "type": "String",
              "minLength": 1,
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "Zscaler OAuth2 Authentication Playbook": {
              "defaultValue": "Zscaler-Oauth2-Authentication",
              "type": "String",
              "metadata": {
                "description": "Name of the Zscaler OAuth2 Authentication Playbook"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler OAuth2 Authentication Playbook'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "auth": "Oauth2",
                "hidden-SentinelTemplateName": "Zscaler-Oauth2-UnblockIP",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "defaultValue": {},
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_IPs": {
                      "runAfter": {},
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "Define_URL_Category": {
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Category",
                            "type": "string",
                            "value": "OTHER_MISCELLANEOUS"
                          }
                        ]
                      }
                    },
                    "Define_Base_URL": {
                      "runAfter": {
                        "Define_URL_Category": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "BaseURL",
                            "type": "string",
                            "value": "api.zsapi.net"
                          }
                        ]
                      }
                    },
                    "Zscaler-Oauth2-Authentication": {
                      "runAfter": {
                        "Define_Base_URL": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "triggerName": "manual",
                          "workflow": {
                            "id": "[[variables('ZscalerAuthenticationFlow')]"
                          }
                        }
                      }
                    },
                    "Parse_Zscaler-Oauth2-Authentication_JSON_Response": {
                      "runAfter": {
                        "Zscaler-Oauth2-Authentication": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Zscaler-Oauth2-Authentication')",
                        "schema": {
                          "properties": {
                            "access_token": {
                              "type": "string"
                            },
                            "expires_in": {
                              "type": "integer"
                            },
                            "ext_expires_in": {
                              "type": "integer"
                            },
                            "token_type": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "For_each": {
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "actions": {
                        "HTTP": {
                          "runAfter": {},
                          "type": "Http",
                          "inputs": {
                            "body": {
                              "urls": [
                                "@{items('For_each')?['Address']}"
                              ]
                            },
                            "headers": {
                              "Authorization": "Bearer @{body('Parse_Zscaler-Oauth2-Authentication_JSON_Response')?['access_token']}"
                            },
                            "method": "PUT",
                            "uri": "https://api.zsapi.net/zia/api/v1/urlCategories/@{variables('Category')}?action=REMOVE_FROM_LIST"
                          }
                        }
                      },
                      "runAfter": {
                        "Parse_Zscaler-Oauth2-Authentication_JSON_Response": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    }
                  },
                  "outputs": {}
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId9'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId9')]",
                "contentId": "[variables('_playbookContentId9')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion9')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Zscaler OAuth2 Unblock IP",
            "description": "This playbook enables automated removal of IPs from a Zscaler URL category using OAuth2 authentication.",
            "mainSteps": [
              "1. Extracts IP entities from the incident",
              "2. Uses the OAuth2 authentication playbook to obtain an access token",
              "3. Removes IPs from the configured Zscaler URL category",
              "4. Processes IPs sequentially for reliable execution"
            ],
            "prerequisites": [
              "1. Zscaler Internet Access (ZIA) subscription with API access enabled",
              "2. Deploy the Zscaler-Oauth2-Authentication playbook in the same resource group",
              "3. Store OAuth2 client credentials in Azure Key Vault",
              "4. A Zscaler URL category containing the IPs to be removed (default: OTHER_MISCELLANEOUS)",
              "5. Appropriate permissions to deploy Azure Logic Apps"
            ],
            "lastUpdateTime": "2025-09-02T00:00:00Z",
            "entities": [
              "IP"
            ],
            "tags": [
              "Remediation"
            ],
            "source": {
              "type": "solution",
              "name": "Zscaler Internet Access"
            },
            "postDeployment": [
              "**a. Authorize API connections**",
              "Authorize the Microsoft Sentinel connection.",
              "**b. Configure permissions**",
              "Assign the Microsoft Sentinel Responder role to the Logic App managed identity.",
              "**c. Optional configuration**",
              "Update the URL category in the Define_URL_Category action if needed.",
              "**d. Optional configuration**",
              "Update the BaseURL variable if you need a different Zscaler API endpoint.",
              "**e. Automation rules**",
              "Create Microsoft Sentinel automation rules to run this playbook on incidents with IP entities that need to be unblocked."
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Zscaler OAuth2 Unblock IP",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId9')]",
        "contentKind": "Playbook",
        "displayName": "Zscaler-Oauth2-UnblockIP",
        "contentProductId": "[variables('_playbookcontentProductId9')]",
        "id": "[variables('_playbookcontentProductId9')]",
        "version": "[variables('playbookVersion9')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName10')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zscaler-Oauth2-UnblockURL Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion10')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Oauth2-UnblockURL",
              "type": "String",
              "minLength": 1,
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "Zscaler OAuth2 Authentication Playbook": {
              "defaultValue": "Zscaler-Oauth2-Authentication",
              "type": "String",
              "metadata": {
                "description": "Name of the Zscaler OAuth2 Authentication Playbook"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler OAuth2 Authentication Playbook'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "auth": "Oauth2",
                "hidden-SentinelTemplateName": "Zscaler-Oauth2-UnblockURL",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "defaultValue": {},
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_URLs": {
                      "runAfter": {},
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/url"
                      }
                    },
                    "Define_URL_Category": {
                      "runAfter": {
                        "Entities_-_Get_URLs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Category",
                            "type": "string",
                            "value": "OTHER_MISCELLANEOUS"
                          }
                        ]
                      }
                    },
                    "Define_Base_URL": {
                      "runAfter": {
                        "Define_URL_Category": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "BaseURL",
                            "type": "string",
                            "value": "api.zsapi.net"
                          }
                        ]
                      }
                    },
                    "Zscaler-Oauth2-Authentication": {
                      "runAfter": {
                        "Define_Base_URL": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "triggerName": "manual",
                          "workflow": {
                            "id": "[[variables('ZscalerAuthenticationFlow')]"
                          }
                        }
                      }
                    },
                    "Parse_Zscaler-Oauth2-Authentication_JSON_Response": {
                      "runAfter": {
                        "Zscaler-Oauth2-Authentication": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Zscaler-Oauth2-Authentication')",
                        "schema": {
                          "properties": {
                            "access_token": {
                              "type": "string"
                            },
                            "expires_in": {
                              "type": "integer"
                            },
                            "ext_expires_in": {
                              "type": "integer"
                            },
                            "token_type": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "For_each": {
                      "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                      "actions": {
                        "HTTP": {
                          "runAfter": {},
                          "type": "Http",
                          "inputs": {
                            "body": {
                              "urls": [
                                "@{items('For_each')?['Url']}"
                              ]
                            },
                            "headers": {
                              "Authorization": "Bearer @{body('Parse_Zscaler-Oauth2-Authentication_JSON_Response')?['access_token']}"
                            },
                            "method": "PUT",
                            "uri": "https://api.zsapi.net/zia/api/v1/urlCategories/@{variables('Category')}?action=REMOVE_FROM_LIST"
                          }
                        }
                      },
                      "runAfter": {
                        "Parse_Zscaler-Oauth2-Authentication_JSON_Response": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    }
                  },
                  "outputs": {}
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId10'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId10')]",
                "contentId": "[variables('_playbookContentId10')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion10')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Zscaler OAuth2 Unblock URL",
            "description": "This playbook enables automated removal of URLs from a Zscaler URL category using OAuth2 authentication.",
            "mainSteps": [
              "1. Extracts URL entities from the incident",
              "2. Uses the OAuth2 authentication playbook to obtain an access token",
              "3. Removes URLs from the configured Zscaler URL category",
              "4. Processes URLs sequentially for reliable execution"
            ],
            "prerequisites": [
              "1. Zscaler Internet Access (ZIA) subscription with API access enabled",
              "2. Deploy the Zscaler-Oauth2-Authentication playbook in the same resource group",
              "3. Store OAuth2 client credentials in Azure Key Vault",
              "4. A Zscaler URL category containing the URLs to be removed (default: OTHER_MISCELLANEOUS)",
              "5. Appropriate permissions to deploy Azure Logic Apps"
            ],
            "lastUpdateTime": "2025-09-02T00:00:00Z",
            "entities": [
              "Url"
            ],
            "tags": [
              "Remediation"
            ],
            "source": {
              "type": "solution",
              "name": "Zscaler Internet Access"
            },
            "postDeployment": [
              "**a. Authorize API connections**",
              "Authorize the Microsoft Sentinel connection.",
              "**b. Configure permissions**",
              "Assign the Microsoft Sentinel Responder role to the Logic App managed identity.",
              "**c. Optional configuration**",
              "Update the URL category in the Define_URL_Category action if needed.",
              "**d. Optional configuration**",
              "Update the BaseURL variable if you need a different Zscaler API endpoint.",
              "**e. Automation rules**",
              "Create Microsoft Sentinel automation rules to run this playbook on incidents with URL entities that need to be unblocked."
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Zscaler OAuth2 Unblock URL",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId10')]",
        "contentKind": "Playbook",
        "displayName": "Zscaler-Oauth2-UnblockURL",
        "contentProductId": "[variables('_playbookcontentProductId10')]",
        "id": "[variables('_playbookcontentProductId10')]",
        "version": "[variables('playbookVersion10')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName11')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zscaler-Oauth2-WhitelistURL Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion11')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Zscaler-Oauth2-WhitelistURL",
              "type": "String",
              "minLength": 1,
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "Zscaler OAuth2 Authentication Playbook": {
              "defaultValue": "Zscaler-Oauth2-Authentication",
              "type": "String",
              "metadata": {
                "description": "Name of the Zscaler OAuth2 Authentication Playbook"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler OAuth2 Authentication Playbook'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "auth": "Oauth2",
                "hidden-SentinelTemplateName": "Zscaler-Oauth2-WhitelistURL",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "defaultValue": {},
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Temp_URL": {
                      "runAfter": {},
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "TempURL",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "NullTest": {
                      "runAfter": {
                        "Temp_URL": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "NullTest",
                            "type": "object",
                            "value": {}
                          }
                        ]
                      }
                    },
                    "New_URL_List": {
                      "runAfter": {
                        "NullTest": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "NewURLlist",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Entities_-_Get_URLs": {
                      "runAfter": {
                        "New_URL_List": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/url"
                      }
                    },
                    "For_each_2": {
                      "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                      "actions": {
                        "Parse_JSON_2": {
                          "runAfter": {},
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('For_each_2')",
                            "schema": {
                              "properties": {
                                "Type": {
                                  "type": "string"
                                },
                                "additionalData": {
                                  "properties": {
                                    "DetonationFinalUrl": {
                                      "type": "string"
                                    },
                                    "DetonationVerdict": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "friendlyName": {
                                  "type": "string"
                                },
                                "url": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "Append_to_array_variable": {
                          "runAfter": {
                            "Parse_JSON_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "NewURLlist",
                            "value": "@body('Parse_JSON_2')?['url']"
                          }
                        }
                      },
                      "runAfter": {
                        "Entities_-_Get_URLs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Define_Base_URL": {
                      "runAfter": {
                        "For_each_2": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "BaseURL",
                            "type": "string",
                            "value": "api.zsapi.net"
                          }
                        ]
                      }
                    },
                    "Zscaler-Oauth2-Authentication": {
                      "runAfter": {
                        "Define_Base_URL": [
                          "Succeeded"
                        ]
                      },
                      "type": "Workflow",
                      "inputs": {
                        "host": {
                          "triggerName": "manual",
                          "workflow": {
                            "id": "[[variables('ZscalerAuthenticationFlow')]"
                          }
                        }
                      }
                    },
                    "Parse_Zscaler-Oauth2-Authentication_JSON_Response": {
                      "runAfter": {
                        "Zscaler-Oauth2-Authentication": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Zscaler-Oauth2-Authentication')",
                        "schema": {
                          "properties": {
                            "access_token": {
                              "type": "string"
                            },
                            "expires_in": {
                              "type": "integer"
                            },
                            "ext_expires_in": {
                              "type": "integer"
                            },
                            "token_type": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "Get_Existing_Whitelist": {
                      "runAfter": {
                        "Parse_Zscaler-Oauth2-Authentication_JSON_Response": [
                          "Succeeded"
                        ]
                      },
                      "type": "Http",
                      "inputs": {
                        "headers": {
                          "Authorization": "Bearer @{body('Parse_Zscaler-Oauth2-Authentication_JSON_Response')?['access_token']}"
                        },
                        "method": "GET",
                        "uri": "https://api.zsapi.net/zia/api/v1/security"
                      }
                    },
                    "Parse_JSON": {
                      "runAfter": {
                        "Get_Existing_Whitelist": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Get_Existing_Whitelist')",
                        "schema": {
                          "properties": {
                            "whitelistUrls": {
                              "items": {
                                "type": "string"
                              },
                              "type": "array"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "Condition": {
                      "actions": {
                        "For_each": {
                          "foreach": "@body('Parse_JSON')?['whitelistUrls']",
                          "actions": {
                            "Temp_Variable": {
                              "runAfter": {},
                              "type": "SetVariable",
                              "inputs": {
                                "name": "TempURL",
                                "value": "@items('For_each')"
                              }
                            },
                            "Append_to_array_variable_2": {
                              "runAfter": {
                                "Temp_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "NewURLlist",
                                "value": "@items('For_each')"
                              }
                            }
                          },
                          "runAfter": {},
                          "type": "Foreach"
                        }
                      },
                      "runAfter": {
                        "Parse_JSON": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "not": {
                              "equals": [
                                "@body('Parse_JSON')",
                                "@variables('NullTest')"
                              ]
                            }
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Initialize_variable": {
                      "runAfter": {
                        "Condition": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "FinalListURLs",
                            "type": "array",
                            "value": "@union(variables('NewURLlist'),variables('NewURLlist'))"
                          }
                        ]
                      }
                    },
                    "Join": {
                      "runAfter": {
                        "Initialize_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Join",
                      "inputs": {
                        "from": "@variables('FinalListURLs')",
                        "joinWith": ","
                      }
                    },
                    "JSON_Body": {
                      "runAfter": {
                        "Join": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "JSON Body",
                            "type": "string",
                            "value": "{\"whitelistUrls\":[\"@{body('Join')}\"]}\n"
                          }
                        ]
                      }
                    },
                    "HTTP": {
                      "runAfter": {
                        "JSON_Body": [
                          "Succeeded"
                        ]
                      },
                      "type": "Http",
                      "inputs": {
                        "body": "@replace(variables('JSON Body'),',','\",\"')",
                        "headers": {
                          "Authorization": "Bearer @{body('Parse_Zscaler-Oauth2-Authentication_JSON_Response')?['access_token']}",
                          "Content-Type": "application/json"
                        },
                        "method": "PUT",
                        "uri": "https://api.zsapi.net/zia/api/v1/security"
                      }
                    }
                  },
                  "outputs": {}
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                },
                "accessControl": {}
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId11'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId11')]",
                "contentId": "[variables('_playbookContentId11')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion11')]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Zscaler OAuth2 Whitelist URL",
            "description": "This playbook enables automated addition of URLs to the Zscaler Internet Access whitelist using OAuth2 authentication.",
            "mainSteps": [
              "1. Extracts URL entities from the incident",
              "2. Retrieves the existing whitelist and preserves entries",
              "3. Uses the OAuth2 authentication playbook to obtain an access token",
              "4. Merges and updates the whitelist in Zscaler"
            ],
            "prerequisites": [
              "1. Zscaler Internet Access (ZIA) subscription with API access enabled",
              "2. Deploy the Zscaler-Oauth2-Authentication playbook in the same resource group",
              "3. Store OAuth2 client credentials in Azure Key Vault",
              "4. Appropriate permissions to deploy Azure Logic Apps"
            ],
            "lastUpdateTime": "2025-09-02T00:00:00Z",
            "entities": [
              "Url"
            ],
            "tags": [
              "Remediation"
            ],
            "source": {
              "type": "solution",
              "name": "Zscaler Internet Access"
            },
            "postDeployment": [
              "**a. Authorize API connections**",
              "Authorize the Microsoft Sentinel connection.",
              "**b. Configure permissions**",
              "Assign the Microsoft Sentinel Responder role to the Logic App managed identity.",
              "**c. Optional configuration**",
              "Update the BaseURL variable for your Zscaler cloud instance if needed.",
              "**d. Automation rules**",
              "Create Microsoft Sentinel automation rules to run this playbook on incidents with URL entities that should be whitelisted."
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Zscaler OAuth2 Whitelist URL",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId11')]",
        "contentKind": "Playbook",
        "displayName": "Zscaler-Oauth2-WhitelistURL",
        "contentProductId": "[variables('_playbookcontentProductId11')]",
        "id": "[variables('_playbookcontentProductId11')]",
        "version": "[variables('playbookVersion11')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "DiscordCDNRiskyDownload_AnalyticalRules Analytics Rule with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies callouts to Discord CDN addresses for risky file extensions. This detection will trigger when a callout for a risky file is made to a discord server that has only been seen once in your environment. Unique discord servers are identified using the server ID that is included in the request URL (DiscordServerId in query). Discord CDN has been used in multiple campaigns to download additional payloads",
                "displayName": "Discord CDN Risky File Download",
                "enabled": false,
                "query": "let connectionThreshold = 1;\nlet riskyExtensions = dynamic([\".bin\",\".exe\",\".dll\",\".bin\",\".msi\"]);\nCommonSecurityLog\n| where DeviceVendor =~ \"ZScaler\"\n| where RequestURL has_any(\"media.discordapp.net\", \"cdn.discordapp.com\")\n| where RequestURL has \"attachments\"\n| where DeviceAction !~ \"blocked\"\n| extend DiscordServerId = extract(@\"\\/attachments\\/([0-9]+)\\/\", 1, RequestURL)\n| summarize dcount(RequestURL), make_set(SourceUserName), make_set(SourceIP), make_set(RequestURL), min(TimeGenerated), max(TimeGenerated), make_set(DeviceAction) by DiscordServerId, DeviceProduct\n| where dcount_RequestURL <= connectionThreshold\n| mv-expand set_SourceUserName to typeof(string), set_RequestURL to typeof(string), set_DeviceAction to typeof(string), set_SourceIP to typeof(string)\n| summarize by DiscordServerId, DeviceProduct, dcount_RequestURL, set_SourceUserName, min_TimeGenerated, max_TimeGenerated, set_DeviceAction, set_SourceIP, set_RequestURL\n| project StartTime=min_TimeGenerated, EndTime=max_TimeGenerated, DeviceActionTaken=set_DeviceAction, DeviceProduct, SourceUser=set_SourceUserName, SourceIP=set_SourceIP, RequestURL=set_RequestURL\n| where RequestURL has_any (riskyExtensions)\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "CommonSecurityLog"
                    ],
                    "connectorId": "CefAma"
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "subTechniques": [
                  "T1071.001"
                ],
                "techniques": [
                  "T1071"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "columnName": "SourceUser",
                        "identifier": "FullName"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "SourceIP",
                        "identifier": "Address"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "RequestURL",
                        "identifier": "Url"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
              "properties": {
                "description": "Zscaler Internet Access Analytics Rule 1",
                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
        "contentKind": "AnalyticsRule",
        "displayName": "Discord CDN Risky File Download",
        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Zscaler-LowVolumeDomainRequests_AnalyticalRules Analytics Rule with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This will look for connections to a domain where only a single file is requested, this is unusual as most modern web applications require additional recources. This type of activity is often assocaited with malware beaconing or tracking URL's delivered in emails. Developed for Zscaler but applicable to any outbound web logging.",
                "displayName": "Request for single resource on domain",
                "enabled": false,
                "query": "let scriptExtensions = dynamic([\".php\", \".aspx\", \".asp\", \".cfml\"]);\n//The number of URI's seen to be suspicious, higher = less likely to be suspicious\nlet uriThreshold = 1;\nCommonSecurityLog\n// Only look at connections that were allowed through the web proxy\n| where DeviceVendor =~ \"Zscaler\" and DeviceAction =~ \"Allowed\"\n// Only look where some data was exchanged.\n| where SentBytes > 0 and ReceivedBytes > 0\n// Extract the Domain\n| extend Domain = iff(countof(DestinationHostName,'.') >= 2, strcat(split(DestinationHostName,'.')[-2], '.',split(DestinationHostName,'.')[-1]), DestinationHostName)\n| extend GetData=iff(RequestURL == \"?\", 1, 0)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), makelist(RequestURL), makelist(DestinationIP), makelist(SourceIP), numOfConnections = count(), make_set(RequestMethod), max(GetData), max(RequestContext) by Domain\n// Determine the number of URIs that have been visited for the domain\n| extend destinationURI = arraylength(list_RequestURL)\n| where destinationURI <= uriThreshold\n| where tostring(list_RequestURL) has_any(scriptExtensions)\n//Remove matches with referer\n| where max_RequestContext == \"\"\n//Keep requests where data was trasferred either in a GET with parameters or a POST\n| where set_RequestMethod in~ (\"POST\") or max_GetData == 1\n//Defeat email click tracking, may increase FN's while decreasing FP's\n| where list_RequestURL !has \"click\" and set_RequestMethod !has \"GET\"\n| mvexpand list_RequestURL, list_DestinationIP\n| extend RequestURL = tostring(list_RequestURL), DestinationIP = tostring(list_DestinationIP), ClientIP = tostring(list_SourceIP)\n//Extend custom entitites for incidents\n| project-away list_RequestURL, list_DestinationIP, list_SourceIP, destinationURI, Domain, StartTimeUtc, EndTimeUtc, max_GetData, max_RequestContext\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "severity": "Low",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "CommonSecurityLog"
                    ],
                    "connectorId": "CefAma"
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "subTechniques": [
                  "T1102",
                  "T1071"
                ],
                "techniques": [
                  "T1102",
                  "T1071"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "DestinationIP",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
              "properties": {
                "description": "Zscaler Internet Access Analytics Rule 2",
                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "Zscaler Internet Access",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Paul Lopez",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zscaler",
                  "email": "support@zscaler.com",
                  "tier": "Partner",
                  "link": "https://www.zscaler.com/support/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
        "contentKind": "AnalyticsRule",
        "displayName": "Request for single resource on domain",
        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Zscaler Internet Access",
        "publisherDisplayName": "Zscaler",
        "description": "The Zscaler Internet Access solution for Microsoft Sentinel enables you to ingest Zscaler Internet Access Logs into Microsoft Sentinel using the Microsoft Sentinel Analytics Workspace.<br><br><strong>Supported log types include:</strong><br> Web, Firewall, DNS, Tunnel<br> Endpoint DLP, Email DLP<br> CASB: Activity, Cloud Storage, Collaboration, CRM, Email, File Sharing, ITSM, Repo<br> Audit<br><br>This enables you to monitor web access, security events, and data protection activity, and respond using the included workbooks and playbooks.<br><br><strong>Underlying Microsoft Technologies used:</strong><br>This solution takes a dependency on the following technologies, and some of these dependencies either may be in Preview state or might result in additional ingestion or operational costs:<br> Azure Monitor Logs: DCR-based Custom Logs<br> Codeless Connector Platform (CCP)<br> Azure Logic Apps",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>\u2022 Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Zscaler%20Internet%20Access/ReleaseNotes.md\">Release Notes</a></p>\n<p>\u2022 There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href=\"https://www.zscaler.com/products-and-solutions/zscaler-internet-access\">Zscaler Internet Access</a> solution for Microsoft Sentinel enables you to ingest <a href=\"https://help.zscaler.com/zia/nanolog-streaming-service\">Zscaler Internet Access Logs</a> into Microsoft Sentinel using the Microsoft Sentinel Analytics Workspace.</p>\n<p>Supported log types include:</p></p>\n<p>\u2022 Web, Firewall, DNS, Tunnel</p>\n<p>\u2022 Endpoint DLP, Email DLP</p>\n<p>\u2022 CASB: Activity, Cloud Storage, Collaboration, CRM, Email, File Sharing, ITSM, Repo</p>\n<p>\u2022 Audit</p>\n<p>This enables you to monitor web access, security events, and data protection activity, and respond using the included workbooks and playbooks.</p>\n<p><strong>Underlying Microsoft Technologies used:</strong></p></p>\n<p>This solution takes a dependency on the following technologies, and some of these dependencies either may be in <a href=\"https://azure.microsoft.com/support/legal/preview-supplemental-terms/\">Preview</a> state or might result in additional ingestion or operational costs:</p>\n<p>\u2022 <a href=\"https://docs.microsoft.com/azure/azure-monitor/logs/custom-logs-overview\">Azure Monitor Logs: DCR-based Custom Logs</a></p>\n<p>\u2022 <a href=\"https://docs.microsoft.com/azure/sentinel/create-codeless-connector?tabs=deploy-via-arm-template%2Cconnect-via-the-azure-portal\">Codeless Connector Platform (CCP)</a></p>\n<p>\u2022 <a href=\"https://learn.microsoft.com/azure/logic-apps/logic-apps-overview\">Azure Logic Apps</a></p>\n<p><strong>Data Connectors:</strong> 15, <strong>Workbooks:</strong> 17, <strong>Analytic Rules:</strong> 2, <strong>Playbooks:</strong> 11</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/ZscalerLogo.svg\" width=\"358px\" height=\"221px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Zscaler Internet Access",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Paul Lopez",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zscaler",
          "email": "support@zscaler.com",
          "tier": "Partner",
          "link": "https://www.zscaler.com/support/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections2')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections3')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections4')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections5')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections6')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections7')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections8')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections9')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections10')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections11')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections12')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections13')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections14')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections15')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId2')]",
              "version": "[variables('workbookVersion2')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId3')]",
              "version": "[variables('workbookVersion3')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId4')]",
              "version": "[variables('workbookVersion4')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId5')]",
              "version": "[variables('workbookVersion5')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId6')]",
              "version": "[variables('workbookVersion6')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId7')]",
              "version": "[variables('workbookVersion7')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId8')]",
              "version": "[variables('workbookVersion8')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId9')]",
              "version": "[variables('workbookVersion9')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId10')]",
              "version": "[variables('workbookVersion10')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId11')]",
              "version": "[variables('workbookVersion11')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId12')]",
              "version": "[variables('workbookVersion12')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId13')]",
              "version": "[variables('workbookVersion13')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId14')]",
              "version": "[variables('workbookVersion14')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId15')]",
              "version": "[variables('workbookVersion15')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId16')]",
              "version": "[variables('workbookVersion16')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId17')]",
              "version": "[variables('workbookVersion17')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Zscaler-Oauth2-Authentication')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Zscaler-Oauth2-BlacklistURL')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Zscaler-Oauth2-BlockIP')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Zscaler-Oauth2-BlockURL')]",
              "version": "[variables('playbookVersion4')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Zscaler-Oauth2-LookupIP')]",
              "version": "[variables('playbookVersion5')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Zscaler-Oauth2-LookupSandboxReport')]",
              "version": "[variables('playbookVersion6')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Zscaler-Oauth2-LookupURL')]",
              "version": "[variables('playbookVersion7')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Zscaler-Oauth2-UnblacklistURL')]",
              "version": "[variables('playbookVersion8')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Zscaler-Oauth2-UnblockIP')]",
              "version": "[variables('playbookVersion9')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Zscaler-Oauth2-UnblockURL')]",
              "version": "[variables('playbookVersion10')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Zscaler-Oauth2-WhitelistURL')]",
              "version": "[variables('playbookVersion11')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            }
          ]
        },
        "firstPublishDate": "2022-10-10",
        "lastPublishDate": "2025-09-02",
        "providers": [
          "Zscaler"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection",
            "Security - Automation (SOAR)"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
