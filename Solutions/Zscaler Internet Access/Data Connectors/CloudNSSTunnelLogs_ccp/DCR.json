{
    "name": "CloudNSSTunnelLogs_ccp",
    "apiVersion": "2021-09-01-preview",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "[parameters('workspace-location')]",
    "properties": {
        "streamDeclarations": {
            "Custom-nss_tunnel_CL": {
                "columns": [
                    {
                        "name": "sourcetype",
                        "type": "string"
                    },
                    {
                        "name": "TimeGenerated",
                        "type": "datetime"
                    },
                    {
                        "name": "vendor",
                        "type": "string"
                    },
                    {
                        "name": "product",
                        "type": "string"
                    },
                    {
                        "name": "version",
                        "type": "string"
                    },
                    {
                        "name": "cfp1Label",
                        "type": "string"
                    },
                    {
                        "name": "severity",
                        "type": "string"
                    },
                    {
                        "name": "cfp1",
                        "type": "string"
                    },
                    {
                        "name": "cn1",
                        "type": "string"
                    },
                    {
                        "name": "cn1Label",
                        "type": "string"
                    },
                    {
                        "name": "cn2",
                        "type": "string"
                    },
                    {
                        "name": "cn2Label",
                        "type": "string"
                    },
                    {
                        "name": "cn3",
                        "type": "string"
                    },
                    {
                        "name": "cn3Label",
                        "type": "string"
                    },
                    {
                        "name": "cs1",
                        "type": "string"
                    },
                    {
                        "name": "cs1Label",
                        "type": "string"
                    },
                    {
                        "name": "cs2",
                        "type": "string"
                    },
                    {
                        "name": "cs2Label",
                        "type": "string"
                    },
                    {
                        "name": "cs3",
                        "type": "string"
                    },
                    {
                        "name": "cs3Label",
                        "type": "string"
                    },
                    {
                        "name": "cs4",
                        "type": "string"
                    },
                    {
                        "name": "cs4Label",
                        "type": "string"
                    },
                    {
                        "name": "cs5",
                        "type": "string"
                    },
                    {
                        "name": "cs5Label",
                        "type": "string"
                    },
                    {
                        "name": "destipend",
                        "type": "string"
                    },
                    {
                        "name": "destipstart",
                        "type": "string"
                    },
                    {
                        "name": "destportstart",
                        "type": "string"
                    },
                    {
                        "name": "deviceEventClassId",
                        "type": "string"
                    },
                    {
                        "name": "deviceExternalId",
                        "type": "string"
                    },
                    {
                        "name": "dpdrec",
                        "type": "string"
                    },
                    {
                        "name": "dpt",
                        "type": "string"
                    },
                    {
                        "name": "dst",
                        "type": "string"
                    },
                    {
                        "name": "dtz",
                        "type": "string"
                    },
                    {
                        "name": "inbytes",
                        "type": "string"
                    },
                    {
                        "name": "lifebytes",
                        "type": "string"
                    },
                    {
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "name": "olocationname",
                        "type": "string"
                    },
                    {
                        "name": "out",
                        "type": "string"
                    },
                    {
                        "name": "ovpncredentialname",
                        "type": "string"
                    },
                    {
                        "name": "proto",
                        "type": "string"
                    },
                    {
                        "name": "reason",
                        "type": "string"
                    },
                    {
                        "name": "spi",
                        "type": "string"
                    },
                    {
                        "name": "spi_in",
                        "type": "string"
                    },
                    {
                        "name": "spi_out",
                        "type": "string"
                    },
                    {
                        "name": "spt",
                        "type": "string"
                    },
                    {
                        "name": "src",
                        "type": "string"
                    },
                    {
                        "name": "srcipend",
                        "type": "string"
                    },
                    {
                        "name": "srcipstart",
                        "type": "string"
                    },
                    {
                        "name": "srcportstart",
                        "type": "string"
                    },
                    {
                        "name": "suser",
                        "type": "string"
                    },
                    {
                        "name": "vendorname",
                        "type": "string"
                    }
                ]
            }
        },
        "destinations": {
            "logAnalytics": [
                {
                    "workspaceResourceId": "[variables('workspaceResourceId')]",
                    "name": "clv2ws1"
                }
            ]
        },
        "dataFlows": [
            {
                "streams": [
                    "Custom-nss_tunnel_CL"
                ],
                "destinations": [
                    "clv2ws1"
                ],
                "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(severity), Activity=tostring(name),DeviceEventClassID=tostring(deviceEventClassId), DeviceExternalID=tostring(deviceExternalId), DestinationPort=toint(dpt), DestinationIP=tostring(dst), DeviceTimeZone=tostring(dtz), ReceivedBytes=tolong(inbytes), SentBytes=tolong(out), Protocol=tostring(proto), Reason=tostring(reason), SourcePort=toint(spt), SourceIP=tostring(src), SourceUserName=tostring(suser), DeviceCustomFloatingPoint1=toreal(cfp1), DeviceCustomFloatingPoint1Label=tostring(cfp1Label), DeviceCustomNumber1=toint(cn1), DeviceCustomNumber1Label=tostring(cn1Label), DeviceCustomNumber2=toint(cn2), DeviceCustomNumber2Label=tostring(cn2Label), DeviceCustomNumber3=toint(cn3), DeviceCustomNumber3Label=tostring(cn3Label), DeviceCustomString1=tostring(cs1), DeviceCustomString1Label=tostring(cs1Label), DeviceCustomString2=tostring(cs2), DeviceCustomString2Label=tostring(cs2Label), DeviceCustomString3=tostring(cs3), DeviceCustomString3Label=tostring(cs3Label), DeviceCustomString4=tostring(cs4), DeviceCustomString4Label=tostring(cs4Label), DeviceCustomString5=tostring(cs5), DeviceCustomString5Label=tostring(cs5Label), AdditionalExtensions = case(deviceEventClassId == \"Tunnel Samples\", strcat(\"dpdrec=\",dpdrec,\";olocationname=\", olocationname, \";ovpncredentialname=\", ovpncredentialname), deviceEventClassId == \"Tunnel Event\", strcat(\"olocationname=\",olocationname,\";ovpncredentialname=\",ovpncredentialname), deviceEventClassId == \"IPSec Phase2\", strcat(\"destipstart=\",destipstart,\";srcipend=\",srcipend,\";srcipstart=\",srcipstart,\";destportstart=\",destportstart,\";lifebytes=\",lifebytes,\";spi=\",spi,\";srcportstart=\",srcportstart,\";destipend=\",destipend), strcat(\"spi_in=\",spi_in,\";spi_out=\",spi_out,\";vendorname=\",vendorname,\";olocationname=\",olocationname,\";ovpncredentialname=\",ovpncredentialname))",
                "outputStream": "Microsoft-CommonSecurityLog"
            }
        ],
        "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
    }
}
