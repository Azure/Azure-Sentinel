{
    "name": "CloudNSSCASBEmailLogs_ccp",
    "apiVersion": "2021-09-01-preview",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "[parameters('workspace-location')]",
    "properties": {
        "streamDeclarations": {
            "Custom-nss_casbemail_CL": {
                "columns": [
                    {
                        "name": "sourcetype",
                        "type": "string"
                    },
                    {
                        "name": "TimeGenerated",
                        "type": "datetime"
                    },
                    {
                        "name": "vendor",
                        "type": "string"
                    },
                    {
                        "name": "product",
                        "type": "string"
                    },
                    {
                        "name": "version",
                        "type": "string"
                    },
                    {
                        "name": "Severity",
                        "type": "string"
                    },
                    {
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "name": "deviceEventClassId",
                        "type": "string"
                    },
                    {
                        "name": "act",
                        "type": "string"
                    },
                    {
                        "name": "oexternalownername",
                        "type": "string"
                    },
                    {
                        "name": "companyid",
                        "type": "string"
                    },
                    {
                        "name": "dlpidentifier",
                        "type": "string"
                    },
                    {
                        "name": "epochtime",
                        "type": "string"
                    },
                    {
                        "name": "filedownloadtimems",
                        "type": "string"
                    },
                    {
                        "name": "filescantimems",
                        "type": "string"
                    },
                    {
                        "name": "msgsize",
                        "type": "string"
                    },
                    {
                        "name": "num_ext_recpts",
                        "type": "string"
                    },
                    {
                        "name": "num_int_recpts",
                        "type": "string"
                    },
                    {
                        "name": "deviceExternalId",
                        "type": "string"
                    },
                    {
                        "name": "repochtime",
                        "type": "string"
                    },
                    {
                        "name": "outcome",
                        "type": "string"
                    },
                    {
                        "name": "fname",
                        "type": "string"
                    },
                    {
                        "name": "fsize",
                        "type": "string"
                    },
                    {
                        "name": "fileType",
                        "type": "string"
                    },
                    {
                        "name": "fileHash",
                        "type": "string"
                    },
                    {
                        "name": "company",
                        "type": "string"
                    },
                    {
                        "name": "datacenter",
                        "type": "string"
                    },
                    {
                        "name": "datacentercity",
                        "type": "string"
                    },
                    {
                        "name": "datacentercountry",
                        "type": "string"
                    },
                    {
                        "name": "department",
                        "type": "string"
                    },
                    {
                        "name": "dlpdictcount",
                        "type": "string"
                    },
                    {
                        "name": "dlpdictnames",
                        "type": "string"
                    },
                    {
                        "name": "dlpenginenames",
                        "type": "string"
                    },
                    {
                        "name": "externalownername",
                        "type": "string"
                    },
                    {
                        "name": "extrecptnames",
                        "type": "string"
                    },
                    {
                        "name": "intrecptnames",
                        "type": "string"
                    },
                    {
                        "name": "is_inbound",
                        "type": "string"
                    },
                    {
                        "name": "malware",
                        "type": "string"
                    },
                    {
                        "name": "malwareclass",
                        "type": "string"
                    },
                    {
                        "name": "messageid",
                        "type": "string"
                    },
                    {
                        "name": "oattchcomponentfilenames",
                        "type": "string"
                    },
                    {
                        "name": "odlpdictnames",
                        "type": "string"
                    },
                    {
                        "name": "odlpenginenames",
                        "type": "string"
                    },
                    {
                        "name": "oextrecptnames",
                        "type": "string"
                    },
                    {
                        "name": "ointrecptnames",
                        "type": "string"
                    },
                    {
                        "name": "omessageid",
                        "type": "string"
                    },
                    {
                        "name": "oowner",
                        "type": "string"
                    },
                    {
                        "name": "orulelabel",
                        "type": "string"
                    },
                    {
                        "name": "otenant",
                        "type": "string"
                    },
                    {
                        "name": "owner",
                        "type": "string"
                    },
                    {
                        "name": "rtime",
                        "type": "string"
                    },
                    {
                        "name": "rulelabel",
                        "type": "string"
                    },
                    {
                        "name": "ruletype",
                        "type": "string"
                    },
                    {
                        "name": "severity",
                        "type": "string"
                    },
                    {
                        "name": "tenant",
                        "type": "string"
                    },
                    {
                        "name": "threatname",
                        "type": "string"
                    },
                    {
                        "name": "tz",
                        "type": "string"
                    },
                    {
                        "name": "upload_doctypename",
                        "type": "string"
                    }
                ]
            }
        },
        "destinations": {
            "logAnalytics": [
                {
                    "workspaceResourceId": "[variables('workspaceResourceId')]",
                    "name": "clv2ws1"
                }
            ]
        },
        "dataFlows": [
            {
                "streams": [
                    "Custom-nss_casbemail_CL"
                ],
                "destinations": [
                    "clv2ws1"
                ],
                "transformKql": "source | project TimeGenerated, DeviceVendor=tostring(vendor), DeviceProduct=tostring(product), DeviceVersion=tostring(version), LogSeverity=tostring(Severity), Activity=tostring(name), DeviceEventClassID=tostring(deviceEventClassId), DeviceAction=tostring(act), deviceExternalId=tostring(deviceExternalId), EventOutcome=tostring(outcome), FileName=tostring(fname), FileSize=toint(fsize), FileType=tostring(fileType), FileHash=tostring(fileHash), AdditionalExtensions = strcat(\"oexternalownername=\",oexternalownername,\";companyid=\",companyid,\";dlpidentifier=\",dlpidentifier,\";epochtime=\",epochtime,\";filedownloadtimems=\",filedownloadtimems,\";filescantimems=\",filescantimems,\";msgsize=\",msgsize,\";num_ext_recpts=\",num_ext_recpts,\";num_int_recpts=\",num_int_recpts,\";repochtime=\",repochtime,\";company=\",company,\";datacenter=\",datacenter,\";datacentercity=\",datacentercity,\";datacentercountry=\",datacentercountry,\";department=\",department,\";dlpdictcount=\",dlpdictcount,\";dlpdictnames=\",dlpdictnames,\";dlpenginenames=\",dlpenginenames,\";externalownername=\",externalownername,\";extrecptnames=\",extrecptnames,\";intrecptnames=\",intrecptnames,\";is_inbound=\",is_inbound,\";malware=\",malware,\";malwareclass=\",malwareclass,\";messageid=\",messageid,\";oattchcomponentfilenames=\",oattchcomponentfilenames,\";odlpdictnames=\",odlpdictnames,\";odlpenginenames=\",odlpenginenames,\";oextrecptnames=\",oextrecptnames,\";ointrecptnames=\",ointrecptnames,\";omessageid=\",omessageid,\";oowner=\",oowner,\";orulelabel=\",orulelabel,\";otenant=\",otenant,\";owner=\",owner,\";rtime=\",rtime,\";rulelabel=\",rulelabel,\";ruletype=\",ruletype,\";severity=\",severity,\";tenant=\",tenant,\";threatname=\",threatname,\";tz=\",tz,\";upload_doctypename=\",upload_doctypename)",
                "outputStream": "Microsoft-CommonSecurityLog"
            }
        ],
        "dataCollectionEndpointId": "[resourceId(parameters('subscription'), parameters('resourceGroupName'), 'Microsoft.Insights/dataCollectionEndpoints', parameters('workspace'))]"
    }
}
