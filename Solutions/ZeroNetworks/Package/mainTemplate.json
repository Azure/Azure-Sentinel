{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Nicholas DiCola - nicholas@zeronetworks.com",
    "comments": "Solution template for ZeroNetworks"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Zero NetWork",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
	 "uri": {
      "type": "string",
      "defaultValue": "https://portal.zeronetworks.com/api/v1/audit"
  }
  },
  "variables": {
    "solutionId": "zeronetworksltd1629013803351.azure-sentinel-solution-znsegmentaudit",
    "_solutionId": "[variables('solutionId')]",
    "email": "nicholas@zeronetworks.com",
    "_email": "[variables('email')]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "ZNAccessOchestratorAudit",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1')))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "analyticRuleVersion1": "1.0.1",
    "analyticRulecontentId1": "a4ce12ca-d01d-460a-b15e-6c74ef328b82",
    "_analyticRulecontentId1": "[variables('analyticRulecontentId1')]",
    "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId1'))]",
    "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId1')))]",
    "analyticRuleVersion2": "1.0.1",
    "analyticRulecontentId2": "603a6b18-b54a-43b7-bb61-d2b0b47d224a",
    "_analyticRulecontentId2": "[variables('analyticRulecontentId2')]",
    "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId2'))]",
    "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId2')))]",
    "analyticRuleVersion3": "1.0.2",
    "analyticRulecontentId3": "58688058-68b2-4b39-8009-ac6dc4d81ea1",
    "_analyticRulecontentId3": "[variables('analyticRulecontentId3')]",
    "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId3'))]",
    "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId3')))]",
    "parserVersion1": "1.0.0",
    "parserContentId1": "ZNSegmentAudit-Parser",
    "_parserContentId1": "[variables('parserContentId1')]",
    "parserName1": "ZNSegmentAudit",
    "_parserName1": "[concat(parameters('workspace'),'/',variables('parserName1'))]",
    "parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
    "_parserId1": "[variables('parserId1')]",
    "parserTemplateSpecName1": "[concat(parameters('workspace'),'-pr-',uniquestring(variables('_parserContentId1')))]",
    "huntingQueryVersion1": "1.0.0",
    "huntingQuerycontentId1": "3dd14edf-788d-4f42-868f-28f3208b92a9",
    "_huntingQuerycontentId1": "[variables('huntingQuerycontentId1')]",
    "huntingQueryId1": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId1'))]",
    "huntingQueryTemplateSpecName1": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId1')))]",
    "huntingQueryVersion2": "1.0.0",
    "huntingQuerycontentId2": "0e68d210-a8ec-4e13-9f46-61011c020b87",
    "_huntingQuerycontentId2": "[variables('huntingQuerycontentId2')]",
    "huntingQueryId2": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId2'))]",
    "huntingQueryTemplateSpecName2": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId2')))]",
    "huntingQueryVersion3": "1.0.0",
    "huntingQuerycontentId3": "fcbbd670-d4e6-4f3a-9008-d8905e84cf79",
    "_huntingQuerycontentId3": "[variables('huntingQuerycontentId3')]",
    "huntingQueryId3": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId3'))]",
    "huntingQueryTemplateSpecName3": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId3')))]",
    "huntingQueryVersion4": "1.0.0",
    "huntingQuerycontentId4": "d8945c8f-bba4-4e02-ad09-228b067ebcf2",
    "_huntingQuerycontentId4": "[variables('huntingQuerycontentId4')]",
    "huntingQueryId4": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId4'))]",
    "huntingQueryTemplateSpecName4": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId4')))]",
    "uiConfigId1": "ZeroNetworksSegmentAuditNativePoller",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "ZeroNetworksSegmentAuditNativePoller",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1')))]",
    "dataConnectorVersion1": "1.0.0",
    "uiConfigId2": "ZeroNetworksSegmentAuditFunction",
    "_uiConfigId2": "[variables('uiConfigId2')]",
    "dataConnectorContentId2": "ZeroNetworksSegmentAuditFunction",
    "_dataConnectorContentId2": "[variables('dataConnectorContentId2')]",
    "dataConnectorId2": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId2'))]",
    "_dataConnectorId2": "[variables('dataConnectorId2')]",
    "dataConnectorTemplateSpecName2": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId2')))]",
    "dataConnectorVersion2": "1.0.0",
    "ZeroNetworksConnector": "ZeroNetworksConnector",
    "_ZeroNetworksConnector": "[variables('ZeroNetworksConnector')]",
    "blanks": "[replace('b', 'b', '')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "ZeroNetworksConnector",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'-lc-',uniquestring(variables('_playbookContentId1')))]",
    "ZeroNetworksSegment-AddAssettoProtection": "ZeroNetworksSegment-AddAssettoProtection",
    "_ZeroNetworksSegment-AddAssettoProtection": "[variables('ZeroNetworksSegment-AddAssettoProtection')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "ZeroNetworksSegment-AddAssettoProtection",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2')))]",
    "ZeroNetworksSegment-AddBlockOutboundRule": "ZeroNetworksSegment-AddBlockOutboundRule",
    "_ZeroNetworksSegment-AddBlockOutboundRule": "[variables('ZeroNetworksSegment-AddBlockOutboundRule')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "ZeroNetworksSegment-AddBlockOutboundRule",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3')))]",
    "ZeroNetworksSegment-EnrichIncident": "ZeroNetworksSegment-EnrichIncident",
    "_ZeroNetworksSegment-EnrichIncident": "[variables('ZeroNetworksSegment-EnrichIncident')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "ZeroNetworksSegment-EnrichIncident",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4')))]",
	"operationId-Encode IP Address to AssetId": "Encode IP Address to AssetId",
    "_operationId-Encode IP Address to AssetId": "[variables('operationId-Encode IP Address to AssetId')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "properties": {
        "description": "ZeroNetworks Workbook with template",
        "displayName": "ZeroNetworks workbook template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('workbookTemplateSpecName1'),'/',variables('workbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('workbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "ZNSegmentAuditWorkbook with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "This workbook provides a summary of ZeroNetworks data."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**NOTE**: This workbook depends on a parser based on Kusto Function **ZNSegmentAudit** to work as expected. [Follow steps to get this Kusto Function](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/ZeroNetworks/Parsers/ZNSegmentAuditAudit.txt)\"},\"name\":\"text - 8\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"cd8447d9-b096-4673-92d8-2a1e8291a125\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"description\":\"Sets the time name for analysis\",\"value\":{\"durationMs\":604800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":900000},{\"durationMs\":3600000},{\"durationMs\":86400000},{\"durationMs\":604800000},{\"durationMs\":2592000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\r\\n| make-series TotalEvents = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Audit Events Over Time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"graphSettings\":{\"type\":0}},\"customWidth\":\"55\",\"name\":\"query - 12\",\"styleSettings\":{\"maxWidth\":\"55\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\r\\n| where isnotempty(EnforcementSource) \\r\\n| summarize count() by EnforcementSource\\r\\n| join kind = inner (ZNSegmentAudit \\r\\n                    | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by EnforcementSource) on EnforcementSource\\r\\n| project-away EnforcementSource1, TimeGenerated\\r\\n| project count_, EnforcementSource, Trend\\r\\n\",\"size\":3,\"title\":\"Enforcement Source\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"EnforcementSource\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":21,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":false}},\"customWidth\":\"30\",\"name\":\"query - 0\",\"styleSettings\":{\"maxWidth\":\"30\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\r\\n| summarize dcount(EnforcementSource)\",\"size\":3,\"title\":\"Enforcement Sources\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"DstPortNumber\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"DstPortNumber\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"DstPortNumber\",\"heatmapPalette\":\"greenRed\"}},\"textSettings\":{\"style\":\"bignumber\"}},\"name\":\"query - 14\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\r\\n| summarize dcount(tostring(DestinationEntityName))\\r\\n\",\"size\":3,\"title\":\"Destination Entities\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"bignumber\"}},\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\n| where isnotempty(PerformedByName)\\n| summarize dcount(PerformedByName)\",\"size\":3,\"title\":\"Users\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"bignumber\"}},\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\n| count\",\"size\":3,\"title\":\"Operations\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"bignumber\"}},\"name\":\"query - 3\"}]},\"customWidth\":\"15\",\"name\":\"group - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\r\\n| where isnotempty(AuditType) \\r\\n| summarize count() by AuditType\\r\\n| top 3 by count_\",\"size\":3,\"title\":\"Top 3 Audit Types\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"EventMessage\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"27\",\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10\",\"padding\":\"10\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"  ZNSegmentAudit\\r\\n  | where isnotempty(PerformedByName) and PerformedByName != \\\"Zero Networks\\\"\\r\\n  | summarize count() by PerformedByName\\r\\n  | top 3 by count_\\r\\n\",\"size\":3,\"title\":\"Top 3 Users\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"27\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\r\\n| where isnotempty(PerformedByName) and PerformedByName != \\\"Zero Networks\\\"\\r\\n| summarize count() by PerformedByName, AuditType\\r\\n| project PerformedByName, AuditType, EventCount=count_\\r\\n| sort by EventCount desc \\r\\n\",\"size\":0,\"title\":\"User activity\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"customWidth\":\"46\",\"name\":\"query - 15\",\"styleSettings\":{\"maxWidth\":\"30\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\r\\n| where isnotempty(PerformedByName) and PerformedByName != \\\"Zero Networks\\\"\\r\\n| where isnotempty(tostring(DestinationEntityName)) \\r\\n| summarize DestinationEntities = makeset(DestinationEntityName) by PerformedByName\\r\\n\",\"size\":0,\"title\":\"Destination Entities by User\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"customWidth\":\"35\",\"name\":\"query - 10\",\"styleSettings\":{\"maxWidth\":\"30\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\r\\n| summarize count() by EnforcementSource\",\"size\":0,\"title\":\"Enforcement Sources\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"55\",\"name\":\"query - 13\",\"styleSettings\":{\"maxWidth\":\"50\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\r\\n| summarize count() by AuditType\\r\\n\",\"size\":3,\"title\":\"Audit Types\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"rowLimit\":100,\"filter\":true}},\"customWidth\":\"30\",\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\n| where isnotempty(PerformedByName) and PerformedByName != \\\"Zero Networks\\\"\\n| summarize count() by PerformedByName\",\"size\":3,\"title\":\"Users' Activity\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\n| where isnotempty(PerformedByName) and PerformedByName != \\\"Zero Networks\\\"\\n| summarize count() by PerformedByName\\n| order by count_\\n| project PerformedByName, EventCount=count_\",\"size\":0,\"title\":\"Events by user\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"customWidth\":\"40\",\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\r\\n| make-series Rule=countif(isnotnull(Rule)),  ReactivePolicy=countif(isnotnull(ReactivePolicy))default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\\r\\n\",\"size\":0,\"title\":\"Rules vs Reactive Policies over Time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\"},\"customWidth\":\"50\",\"name\":\"query - 13\",\"styleSettings\":{\"maxWidth\":\"60\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ZNSegmentAudit\\r\\n| extend  Type=iif(isnotnull(Rule), \\\"Rule\\\", iff(isnotnull(ReactivePolicy), \\\"ReactivePolicy\\\", \\\"Other\\\"))\\r\\n| summarize count() by Type\",\"size\":3,\"title\":\"Cont of Rules vs Reactive Policies\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 14\",\"styleSettings\":{\"maxWidth\":\"40\"}}],\"fromTemplateId\":\"sentinel-ZNAccessOchestratorAudit\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=ZNAccessOchestratorAudit; logoFileName=; description=This workbook provides a summary of ZeroNetworks data.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Zero NetWork; templateRelativePath=ZNSegmentAudit.json; subtitle=; provider=Zero Networks}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "ZNAccessOrchestratorAudit_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "ZNAccessOrchestratorAuditNativePoller_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "ZeroNetworksAccessOrchestratorAuditFunction",
                      "kind": "DataConnector"
                    },
                    {
                      "contentId": "ZeroNetworksAccessOrchestratorAuditNativePoller",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "ZeroNetworks Analytics Rule 1 with template",
        "displayName": "ZeroNetworks Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName1'),'/',variables('analyticRuleVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "ZNSegmentMachineRemovedfromProtection_AnalyticalRules Analytics Rule with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId1')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when a machine is removed from protection.",
                "displayName": "Zero Networks Segement - Machine Removed from protection",
                "enabled": false,
                "query": "ZNSegmentAudit\n| where AuditTypeId == 4\n",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ZNSegmentAudit_CL"
                    ],
                    "connectorId": "ZeroNetworksSegmentAuditFunction"
                  },
                  {
                    "dataTypes": [
                      "ZNSegmentAuditNativePoller_CL"
                    ],
                    "connectorId": "ZeroNetworksSegmentAuditNativePoller"
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "PerformedByName",
                        "identifier": "Name"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "DestinationEntityName",
                        "identifier": "HostName"
                      }
                    ],
                    "entityType": "Host"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId1'),'/'))))]",
              "properties": {
                "description": "ZeroNetworks Analytics Rule 1",
                "parentId": "[variables('analyticRuleId1')]",
                "contentId": "[variables('_analyticRulecontentId1')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "ZeroNetworks Analytics Rule 2 with template",
        "displayName": "ZeroNetworks Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName2'),'/',variables('analyticRuleVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "ZNSegmentNewAPIToken_AnalyticalRules Analytics Rule with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId2')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when a api token has been created.",
                "displayName": "Zero Networks Segment - New API Token created",
                "enabled": false,
                "query": "ZNSegmentAudit\n| where AuditTypeId == 25\n",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "Low",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ZNSegmentAudit_CL"
                    ],
                    "connectorId": "ZeroNetworksSegmentAuditFunction"
                  },
                  {
                    "dataTypes": [
                      "ZNSegmentAuditNativePoller_CL"
                    ],
                    "connectorId": "ZeroNetworksSegmentAuditNativePoller"
                  }
                ],
                "tactics": [
                  "CredentialAccess"
                ],
                "techniques": [
                  "T1528"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "PerformedByName",
                        "identifier": "Name"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId2'),'/'))))]",
              "properties": {
                "description": "ZeroNetworks Analytics Rule 2",
                "parentId": "[variables('analyticRuleId2')]",
                "contentId": "[variables('_analyticRulecontentId2')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "ZeroNetworks Analytics Rule 3 with template",
        "displayName": "ZeroNetworks Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName3'),'/',variables('analyticRuleVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "ZNSegmentRareJITRuleCreation_AnalyticalRules Analytics Rule with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId3')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies when a JIT Rule connection is new or rare by a given account today based on comparison with the previous 14 days.\nJIT Rule creations are indicated by the Activity Type Id 20",
                "displayName": "Zero Networks Segment - Rare JIT Rule Creation",
                "enabled": false,
                "query": "let starttime = 14d;\nlet endtime = 1d;\nZNSegmentAudit\n| where TimeGenerated >= ago(endtime)\n| where AuditTypeId == 20\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), ConnectionCount = count()\nby PerformedByName, tostring(DestinationEntityName)\n  // use left anti to exclude anything from the previous 14 days that is not rare\n| join kind=leftanti (\nZNSegmentAudit\n| where TimeGenerated between (ago(starttime) .. ago(endtime))\n| where AuditTypeId == 20\n| summarize by tostring(DestinationEntityName)\n) on DestinationEntityName\n| summarize StartTime = min(StartTime), EndTime = max(EndTime), ConnectionCount = sum(ConnectionCount)\nby PerformedByName, DestinationEntityName\n| extend TimeGenerated = StartTime\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P14D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ZNSegmentAudit_CL"
                    ],
                    "connectorId": "ZeroNetworksSegmentAuditFunction"
                  },
                  {
                    "dataTypes": [
                      "ZNSegmentAuditNativePoller_CL"
                    ],
                    "connectorId": "ZeroNetworksSegmentAuditNativePoller"
                  }
                ],
                "tactics": [
                  "LateralMovement"
                ],
                "techniques": [
                  "T1021"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "PerformedByName",
                        "identifier": "Name"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "DestinationEntityName",
                        "identifier": "HostName"
                      }
                    ],
                    "entityType": "Host"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId3'),'/'))))]",
              "properties": {
                "description": "ZeroNetworks Analytics Rule 3",
                "parentId": "[variables('analyticRuleId3')]",
                "contentId": "[variables('_analyticRulecontentId3')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('parserTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "properties": {
        "description": "ZNSegmentAudit Data Parser with template",
        "displayName": "ZNSegmentAudit Data Parser template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('parserTemplateSpecName1'),'/',variables('parserVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('parserTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "ZNSegmentAudit Data Parser with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName1')]",
              "apiVersion": "2020-08-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ZNSegmentAudit",
                "category": "Samples",
                "functionAlias": "ZNSegmentAudit",
                "query": "\nlet AuditTypesTable = datatable(auditType_d: double, AuditType: string) [\r\n    0, \"Unspecified\",\r\n    1, \"Asset is being added to protection\",\r\n    2, \"Asset added to protection\",\r\n    3, \"Asset failed adding to protection\",\r\n    4, \"Asset is being removed from protection\",\r\n    5, \"Removed asset from protection\",\r\n    6, \"Failed removing asset from protection\",\r\n    7, \"Asset added to learning\",\r\n    8, \"Asset removed from learning\",\r\n    9, \"Access rule created\",\r\n    10, \"Access rule deleted\",\r\n    11, \"Access rule expired\",\r\n    12, \"Access rule edited\",\r\n    17, \"MFA access policy created\",\r\n    18, \"MFA access policy deleted\",\r\n    19, \"MFA access policy edited\",\r\n    20, \"JIT rule created\",\r\n    21, \"JIT rule deleted\",\r\n    22, \"JIT rule expired\",\r\n    23, \"JIT rule revived\",\r\n    24, \"JIT rule edited\",\r\n    25, \"API Token created\",\r\n    26, \"API Token deleted\",\r\n    27, \"API Token regenerated\",\r\n    28, \"Asset learning is extended\",\r\n    29, \"Outbound block rule created\",\r\n    30, \"Outbound block rule deleted\",\r\n    31, \"Outbound block rule expired\",\r\n    32, \"Outbound block rule edited\",\r\n    33, \"Inbound block rule created\",\r\n    34, \"Inbound block rule deleted\",\r\n    35, \"Inbound block rule expired\",\r\n    36, \"Inbound block rule edited\",\r\n    37, \"Inbound rule pseudo edited\",\r\n    38, \"Outbound rule pseudo edited\"\r\n];\r\nlet EnforcementSourceTypeTable = datatable (enforcementSource_d: double, EnforcementSource: string) [\r\n    1, \"Reactive Policy\",\r\n    2, \"Automated\",\r\n    3, \"Access Portal\",\r\n    4, \"Admin Portal\",\r\n    5, \"AI\",\r\n    6, \"API\"\r\n];\r\nlet UserRoleTypeTable = datatable (userRole_d: double, UserRole: string) [\r\n    1, \"Admin\",\r\n    2, \"Viewer\",\r\n    3, \"Regular\",\r\n    4, \"API - Full Access\",\r\n    5, \"API - Read Only\",\r\n    6, \"Self Service\"\r\n];\r\nunion isfuzzy=true ZNSegmentAuditNativePoller_CL, ZNSegmentAudit_CL\r\n| project-away TimeGenerated\r\n| lookup kind=leftouter AuditTypesTable on auditType_d\r\n| lookup kind=leftouter EnforcementSourceTypeTable on enforcementSource_d\r\n| lookup kind=leftouter UserRoleTypeTable on userRole_d\r\n| extend entity=parse_json(destinationEntitiesList_s)\r\n| extend EventVendor=\"Zero Networks\",\r\n    EventProduct=\"Segment Audit\",\r\n    AuditTypeId=column_ifexists('auditType_d', ''),\r\n    TimeGenerated=unixtime_milliseconds_todatetime(timestamp_d),\r\n    EnforcementSourceId=column_ifexists('enforcementSource_d', ''),\r\n    UserRoleId=column_ifexists('userRole_d', ''),\r\n    DestinationEntityName = ['entity'][0].name,\r\n    DestinationEntityId = ['entity'][0].id,\r\n    Details=column_ifexists('details_s', ''),\r\n    PerformedById=column_ifexists('performedBy_id_s', ''),\r\n    PerformedByName=column_ifexists('performedBy_name_s', ''),\r\n    PerformedByGuid=column_ifexists('performedBy_id_g', ''),\r\n    ReportedObjectGuid=column_ifexists('reportedObjectId_g', ''),\r\n    ReportedObjectId=column_ifexists('reportedObjectId_s', '')\r\n| extend Rule=parse_json(Details).rule,\r\n    ReactivePolicy=parse_json(Details).rp\r\n| project\r\n    TimeGenerated,\r\n    EventVendor,\r\n    EventProduct,\r\n    AuditTypeId,\r\n    AuditType,\r\n    DestinationEntityId,\r\n    DestinationEntityName,\r\n    EnforcementSourceId,\r\n    EnforcementSource,\r\n    PerformedByGuid,\r\n    PerformedById,\r\n    PerformedByName,\r\n    ReportedObjectGuid,\r\n    ReportedObjectId,\r\n    UserRoleId,\r\n    UserRole,\r\n    Rule,\r\n    ReactivePolicy\r\n",
                "version": 1,
                "tags": [
                  {
                    "name": "description",
                    "value": "ZNSegmentAudit"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
              "dependsOn": [
                "[variables('_parserName1')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
                "contentId": "[variables('_parserContentId1')]",
                "kind": "Parser",
                "version": "[variables('parserVersion1')]",
                "source": {
                  "name": "ZeroNetworks",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2021-06-01",
      "name": "[variables('_parserName1')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "ZNSegmentAudit",
        "category": "Samples",
        "functionAlias": "ZNSegmentAudit",
        "query": "\nlet AuditTypesTable = datatable(auditType_d: double, AuditType: string) [\r\n    0, \"Unspecified\",\r\n    1, \"Asset is being added to protection\",\r\n    2, \"Asset added to protection\",\r\n    3, \"Asset failed adding to protection\",\r\n    4, \"Asset is being removed from protection\",\r\n    5, \"Removed asset from protection\",\r\n    6, \"Failed removing asset from protection\",\r\n    7, \"Asset added to learning\",\r\n    8, \"Asset removed from learning\",\r\n    9, \"Access rule created\",\r\n    10, \"Access rule deleted\",\r\n    11, \"Access rule expired\",\r\n    12, \"Access rule edited\",\r\n    17, \"MFA access policy created\",\r\n    18, \"MFA access policy deleted\",\r\n    19, \"MFA access policy edited\",\r\n    20, \"JIT rule created\",\r\n    21, \"JIT rule deleted\",\r\n    22, \"JIT rule expired\",\r\n    23, \"JIT rule revived\",\r\n    24, \"JIT rule edited\",\r\n    25, \"API Token created\",\r\n    26, \"API Token deleted\",\r\n    27, \"API Token regenerated\",\r\n    28, \"Asset learning is extended\",\r\n    29, \"Outbound block rule created\",\r\n    30, \"Outbound block rule deleted\",\r\n    31, \"Outbound block rule expired\",\r\n    32, \"Outbound block rule edited\",\r\n    33, \"Inbound block rule created\",\r\n    34, \"Inbound block rule deleted\",\r\n    35, \"Inbound block rule expired\",\r\n    36, \"Inbound block rule edited\",\r\n    37, \"Inbound rule pseudo edited\",\r\n    38, \"Outbound rule pseudo edited\"\r\n];\r\nlet EnforcementSourceTypeTable = datatable (enforcementSource_d: double, EnforcementSource: string) [\r\n    1, \"Reactive Policy\",\r\n    2, \"Automated\",\r\n    3, \"Access Portal\",\r\n    4, \"Admin Portal\",\r\n    5, \"AI\",\r\n    6, \"API\"\r\n];\r\nlet UserRoleTypeTable = datatable (userRole_d: double, UserRole: string) [\r\n    1, \"Admin\",\r\n    2, \"Viewer\",\r\n    3, \"Regular\",\r\n    4, \"API - Full Access\",\r\n    5, \"API - Read Only\",\r\n    6, \"Self Service\"\r\n];\r\nunion isfuzzy=true ZNSegmentAuditNativePoller_CL, ZNSegmentAudit_CL\r\n| project-away TimeGenerated\r\n| lookup kind=leftouter AuditTypesTable on auditType_d\r\n| lookup kind=leftouter EnforcementSourceTypeTable on enforcementSource_d\r\n| lookup kind=leftouter UserRoleTypeTable on userRole_d\r\n| extend entity=parse_json(destinationEntitiesList_s)\r\n| extend EventVendor=\"Zero Networks\",\r\n    EventProduct=\"Segment Audit\",\r\n    AuditTypeId=column_ifexists('auditType_d', ''),\r\n    TimeGenerated=unixtime_milliseconds_todatetime(timestamp_d),\r\n    EnforcementSourceId=column_ifexists('enforcementSource_d', ''),\r\n    UserRoleId=column_ifexists('userRole_d', ''),\r\n    DestinationEntityName = ['entity'][0].name,\r\n    DestinationEntityId = ['entity'][0].id,\r\n    Details=column_ifexists('details_s', ''),\r\n    PerformedById=column_ifexists('performedBy_id_s', ''),\r\n    PerformedByName=column_ifexists('performedBy_name_s', ''),\r\n    PerformedByGuid=column_ifexists('performedBy_id_g', ''),\r\n    ReportedObjectGuid=column_ifexists('reportedObjectId_g', ''),\r\n    ReportedObjectId=column_ifexists('reportedObjectId_s', '')\r\n| extend Rule=parse_json(Details).rule,\r\n    ReactivePolicy=parse_json(Details).rp\r\n| project\r\n    TimeGenerated,\r\n    EventVendor,\r\n    EventProduct,\r\n    AuditTypeId,\r\n    AuditType,\r\n    DestinationEntityId,\r\n    DestinationEntityName,\r\n    EnforcementSourceId,\r\n    EnforcementSource,\r\n    PerformedByGuid,\r\n    PerformedById,\r\n    PerformedByName,\r\n    ReportedObjectGuid,\r\n    ReportedObjectId,\r\n    UserRoleId,\r\n    UserRole,\r\n    Rule,\r\n    ReactivePolicy\r\n",
        "version": 1
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId1')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
        "contentId": "[variables('_parserContentId1')]",
        "kind": "Parser",
        "version": "[variables('parserVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "ZeroNetworks",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Nicholas DiCola",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zero Networks",
          "email": "support@zeronetworks.zendesk.com",
          "tier": "Partner",
          "link": "https://zeronetworks.com"
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "ZeroNetworks Hunting Query 1 with template",
        "displayName": "ZeroNetworks Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName1'),'/',variables('huntingQueryVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "ZNSegmentExcessiveAccessbyUser_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "ZeroNetworks_Hunting_Query_1",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Zero Networks Segment - Excessive access by user",
                "category": "Hunting Queries",
                "query": "let starttime = todatetime('{{StartTimeISO}}');\nlet endtime = todatetime('{{EndTimeISO}}');\nZNSegmentAudit\n| where TimeGenerated > ago(endtime-starttime)\n| where AuditTypeId in (9,12,20,22,23,24)\n| where DestinationEntityId !startswith \"b:\"\n| summarize AffectedEntities=make_set(DestinationEntityName) by PerformedByName\n| extend numOfTargetEntities=array_length(AffectedEntities)\n| order by numOfTargetEntities desc\n| extend Account_0_FullName = PerformedByName\n| extend Host_0_NetBiosName = AffectedEntities\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Find users who gained access to the largest number of target assets in the selected time range"
                  },
                  {
                    "name": "tactics",
                    "value": "LateralMovement"
                  },
                  {
                    "name": "techniques",
                    "value": "T1210,T1570,T0866"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId1'),'/'))))]",
              "properties": {
                "description": "ZeroNetworks Hunting Query 1",
                "parentId": "[variables('huntingQueryId1')]",
                "contentId": "[variables('_huntingQuerycontentId1')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "ZeroNetworks Hunting Query 2 with template",
        "displayName": "ZeroNetworks Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName2'),'/',variables('huntingQueryVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "ZNSegmentExcessiveAccesstoBuiltinGroupbyUser_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "ZeroNetworks_Hunting_Query_2",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Zero Networks Segment - Excessive access to a built-in group by user",
                "category": "Hunting Queries",
                "query": "let starttime = todatetime('{{StartTimeISO}}');\nlet endtime = todatetime('{{EndTimeISO}}');\nZNSegmentAudit\n| where TimeGenerated > ago(endtime-starttime)\n| where AuditTypeId  in (9,12,20,22,23,24)\n| where DestinationEntityId startswith \"b:\"\n| summarize affectedEntities=make_set(DestinationEntityId) by PerformedByName\n| extend numOfTargetEntities=array_length(affectedEntities)\n| order by numOfTargetEntities desc\n| extend Account_0_Name = PerformedByName\n| extend Host_0_NetBiosName = affectedEntities\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "A rule was created which granted a user access to a large, built-in, group of assets."
                  },
                  {
                    "name": "tactics",
                    "value": "LateralMovement"
                  },
                  {
                    "name": "techniques",
                    "value": "T1210,T1570,T0866"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId2'),'/'))))]",
              "properties": {
                "description": "ZeroNetworks Hunting Query 2",
                "parentId": "[variables('huntingQueryId2')]",
                "contentId": "[variables('_huntingQuerycontentId2')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "ZeroNetworks Hunting Query 3 with template",
        "displayName": "ZeroNetworks Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName3'),'/',variables('huntingQueryVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "ZNSegmentInboundBlockRulesDeleted_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "ZeroNetworks_Hunting_Query_3",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Zero Networks Segment - Inbound Block Rules Deleted",
                "category": "Hunting Queries",
                "query": "let starttime = todatetime('{{StartTimeISO}}');\nlet endtime = todatetime('{{EndTimeISO}}');\nZNSegmentAudit\n| where TimeGenerated > ago(endtime-starttime)\n| where AuditTypeId == 34\n| where EnforcementSource != \"AI\"\n| extend Account_0_FullName = PerformedByName\n| extend Host_0_NetBiosName = DestinationEntityName\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query searches for inbound block rules deleted by non AI."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId3'),'/'))))]",
              "properties": {
                "description": "ZeroNetworks Hunting Query 3",
                "parentId": "[variables('huntingQueryId3')]",
                "contentId": "[variables('_huntingQuerycontentId3')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "ZeroNetworks Hunting Query 4 with template",
        "displayName": "ZeroNetworks Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName4'),'/',variables('huntingQueryVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "ZNSegmentOutboundBlockRulesDeleted_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion4')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "ZeroNetworks_Hunting_Query_4",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Zero Networks Segment - Outbound Block Rules Deleted",
                "category": "Hunting Queries",
                "query": "let starttime = todatetime('{{StartTimeISO}}');\nlet endtime = todatetime('{{EndTimeISO}}');\nZNSegmentAudit\n| where TimeGenerated > ago(endtime-starttime)\n| where AuditTypeId == 30\n| where EnforcementSource != \"AI\"\n| extend Account_0_FullName = PerformedByName\n| extend Host_0_NetBiosName = DestinationEntityName\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query searches for outbound block rules deleted by non AI."
                  },
                  {
                    "name": "tactics",
                    "value": "DefenseEvasion"
                  },
                  {
                    "name": "techniques",
                    "value": "T1562"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId4'),'/'))))]",
              "properties": {
                "description": "ZeroNetworks Hunting Query 4",
                "parentId": "[variables('huntingQueryId4')]",
                "contentId": "[variables('_huntingQuerycontentId4')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "properties": {
        "description": "ZeroNetworks data connector with template",
        "displayName": "ZeroNetworks template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('dataConnectorTemplateSpecName1'),'/',variables('dataConnectorVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('dataConnectorTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "ZeroNetworks data connector with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "APIPolling",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "Zero Networks Segment Audit",
                  "publisher": "Zero Networks",
                  "descriptionMarkdown": "The [Zero Networks Segment](https://zeronetworks.com/) Audit data connector provides the capability to ingest Zero Networks Audit events into Microsoft Sentinel through the REST API. This data connector uses Microsoft Sentinel native polling capability.",
                  "graphQueriesTableName": "ZNSegmentAuditNativePoller_CL",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "Zero Networks Segment Audit",
                      "baseQuery": "{{graphQueriesTableName}}"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "All Zero Networks Segment Audit events",
                      "query": "{{graphQueriesTableName}}\n| sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "{{graphQueriesTableName}}",
                      "lastDataReceivedQuery": "{{graphQueriesTableName}}\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "SentinelKindsV2",
                      "value": []
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Zero Networks API Token",
                        "description": "**ZeroNetworksAPIToken** is required for REST API. See the API Guide and follow the instructions for obtaining credentials."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": "Enable Zero Networks audit Logs.",
                      "instructions": [
                        {
                          "parameters": {
                            "enable": "true"
                          },
                          "type": "APIKey"
                        }
                      ],
                      "title": "Connect Zero Networks to Microsoft Sentinel"
                    }
                  ]
                },
                "pollingConfig": {
                  "auth": {
                    "authType": "APIKey",
                    "APIKeyName": "Authorization"
                  },
                  "request": {
                    "apiEndpoint": "[parameters('uri')]",
                    "httpMethod": "GET",
                    "queryTimeFormat": "UnixTimestampInMills",
                    "queryWindowInMin": 5,
                    "startTimeAttributeName": "from",
                    "endTimeAttributeName": "to",
                    "queryParameters": {
                      "order": "desc"
                    }
                  },
                  "paging": {
                    "pagingType": "PageToken",
                    "nextPageParaName": "_cursor",
                    "nextPageTokenJsonPath": "..scrollCursor",
                    "pageSize": 400,
                    "pageSizeParaName": "_limit"
                  },
                  "response": {
                    "eventsJsonPaths": [
                      "$..items"
                    ]
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "ZeroNetworks",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Nicholas DiCola",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zero Networks",
          "email": "support@zeronetworks.zendesk.com",
          "tier": "Partner",
          "link": "https://zeronetworks.com"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "APIPolling",
      "properties": {
        "connectorUiConfig": {
          "id": "[variables('_uiConfigId1')]",
          "title": "Zero Networks Segment Audit",
          "publisher": "Zero Networks",
          "descriptionMarkdown": "The [Zero Networks Segment](https://zeronetworks.com/) Audit data connector provides the capability to ingest Zero Networks Audit events into Microsoft Sentinel through the REST API. This data connector uses Microsoft Sentinel native polling capability.",
          "graphQueriesTableName": "ZNSegmentAuditNativePoller_CL",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "Zero Networks Segment Audit",
              "baseQuery": "{{graphQueriesTableName}}"
            }
          ],
          "sampleQueries": [
            {
              "description": "All Zero Networks Segment Audit events",
              "query": "{{graphQueriesTableName}}\n| sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "{{graphQueriesTableName}}",
              "lastDataReceivedQuery": "{{graphQueriesTableName}}\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "SentinelKindsV2",
              "value": []
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Zero Networks API Token",
                "description": "**ZeroNetworksAPIToken** is required for REST API. See the API Guide and follow the instructions for obtaining credentials."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": "Enable Zero Networks audit Logs.",
              "instructions": [
                {
                  "parameters": {
                    "enable": "true"
                  },
                  "type": "APIKey"
                }
              ],
              "title": "Connect Zero Networks to Microsoft Sentinel"
            }
          ]
        },
        "pollingConfig": {
          "auth": {
            "authType": "APIKey",
            "APIKeyName": "Authorization"
          },
          "request": {
            "apiEndpoint": "[parameters('uri')]",
            "httpMethod": "GET",
            "queryTimeFormat": "UnixTimestampInMills",
            "queryWindowInMin": 5,
            "startTimeAttributeName": "from",
            "endTimeAttributeName": "to",
            "queryParameters": {
              "order": "desc"
            }
          },
          "paging": {
            "pagingType": "PageToken",
            "nextPageParaName": "_cursor",
            "nextPageTokenJsonPath": "..scrollCursor",
            "pageSize": 400,
            "pageSizeParaName": "_limit"
          },
          "response": {
            "eventsJsonPaths": [
              "$..items"
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('dataConnectorTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "properties": {
        "description": "ZeroNetworks data connector with template",
        "displayName": "ZeroNetworks template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('dataConnectorTemplateSpecName2'),'/',variables('dataConnectorVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('dataConnectorTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "ZeroNetworks data connector with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId2'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId2')]",
                  "title": "Zero Networks Segment Audit (Function) (using Azure Functions)",
                  "publisher": "Zero Networks",
                  "descriptionMarkdown": "The [Zero Networks Segment](https://zeronetworks.com/product/) Audit data connector provides the capability to ingest Audit events into Microsoft Sentinel through the REST API. Refer to API guide for more information. The connector provides ability to get events which helps to examine potential security risks, analyze your team's use of collaboration, diagnose configuration problems and more.",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "ZNSegmentAudit_CL",
                      "baseQuery": "ZNSegmentAudit_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Zero Networks Segment Audit - All Activities",
                      "query": "ZNSegmentAudit_CL\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "ZNSegmentAudit_CL",
                      "lastDataReceivedQuery": "ZNSegmentAudit_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "ZNSegmentAudit_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft.Web/sites permissions",
                        "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
                      },
                      {
                        "name": "REST API Credentials",
                        "description": "**Zero Networks Segment** **API Token** is required for REST API. See the API Guide."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": ">**NOTE:** This connector uses Azure Functions to connect to the Zero Networks REST API to pull its logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
                    },
                    {
                      "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
                    },
                    {
                      "description": "**STEP 1 - Configuration steps for the Zero Networks API**\n\n See the API Guide to obtain the credentials. \n"
                    },
                    {
                      "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the Workspace data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following).",
                      "instructions": [
                        {
                          "parameters": {
                            "fillWith": [
                              "WorkspaceId"
                            ],
                            "label": "Workspace ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "fillWith": [
                              "PrimaryKey"
                            ],
                            "label": "Primary Key"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    },
                    {
                      "description": "Use this method for automated deployment of the Zero Networks Segment Audit data connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-ZeroNetworks-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n> **NOTE:** Within the same resource group, you can't mix Windows and Linux apps in the same region. Select existing resource group without Windows apps in it or create new resource group.\n3. Enter the **APIToken** and deploy. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy.",
                      "title": "Option 1 - Azure Resource Manager (ARM) Template"
                    },
                    {
                      "description": "Use the following step-by-step instructions to deploy the Zero Networks Segment Audit data connector manually with Azure Functions (Deployment via Visual Studio Code).",
                      "title": "Option 2 - Manual Deployment of Azure Functions"
                    },
                    {
                      "description": "**1. Deploy a Function App**\n\n> **NOTE:** You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/functions-create-first-function-powershell#prerequisites) for Azure function development.\n\n1. Download the [Azure Function App](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/DataConnectors/ZeroNetworks/SegmentFunctionConnector/AzureFunction_ZeroNetworks_Segment_Audit.zip) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. ZNSegmentAuditXXXXX).\n\n\te. **Select a runtime:** Choose PowerShell.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Microsoft Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
                    },
                    {
                      "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select ** New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tAPIToken\n\t\tWorkspaceID\n\t\tWorkspaceKey\n\t\tlogAnalyticsUri (optional)\n\t\turi\n\t\ttableName\n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`.\n3. Once all application settings have been entered, click **Save**."
                    }
                  ],
                  "metadata": {
                    "id": "254aeaae-6001-49d6-ae43-17898ce6f0e4",
                    "version": "1.0.0",
                    "kind": "dataConnector",
                    "source": {
                      "kind": "community",
                      "name": "Microsoft Sentinel"
                    },
                    "author": {
                      "name": "Zero Networks"
                    },
                    "support": {
                      "tier": "community",
                      "name": "Zero Networks",
                      "email": "support@zeronetworks.com"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId2'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId2'))]",
                "contentId": "[variables('_dataConnectorContentId2')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId2'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId2')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId2'))]",
        "contentId": "[variables('_dataConnectorContentId2')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion2')]",
        "source": {
          "kind": "Solution",
          "name": "ZeroNetworks",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Nicholas DiCola",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zero Networks",
          "email": "support@zeronetworks.zendesk.com",
          "tier": "Partner",
          "link": "https://zeronetworks.com"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId2'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Zero Networks Segment Audit (Function) (using Azure Functions)",
          "publisher": "Zero Networks",
          "descriptionMarkdown": "The [Zero Networks Segment](https://zeronetworks.com/product/) Audit data connector provides the capability to ingest Audit events into Microsoft Sentinel through the REST API. Refer to API guide for more information. The connector provides ability to get events which helps to examine potential security risks, analyze your team's use of collaboration, diagnose configuration problems and more.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "ZNSegmentAudit_CL",
              "baseQuery": "ZNSegmentAudit_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "ZNSegmentAudit_CL",
              "lastDataReceivedQuery": "ZNSegmentAudit_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "ZNSegmentAudit_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "Zero Networks Segment Audit - All Activities",
              "query": "ZNSegmentAudit_CL\n | sort by TimeGenerated desc"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "REST API Credentials",
                "description": "**Zero Networks Segment** **API Token** is required for REST API. See the API Guide."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to the Zero Networks REST API to pull its logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
            },
            {
              "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
            },
            {
              "description": "**STEP 1 - Configuration steps for the Zero Networks API**\n\n See the API Guide to obtain the credentials. \n"
            },
            {
              "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the Workspace data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following).",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "fillWith": [
                      "PrimaryKey"
                    ],
                    "label": "Primary Key"
                  },
                  "type": "CopyableLabel"
                }
              ]
            },
            {
              "description": "Use this method for automated deployment of the Zero Networks Segment Audit data connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-ZeroNetworks-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n> **NOTE:** Within the same resource group, you can't mix Windows and Linux apps in the same region. Select existing resource group without Windows apps in it or create new resource group.\n3. Enter the **APIToken** and deploy. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy.",
              "title": "Option 1 - Azure Resource Manager (ARM) Template"
            },
            {
              "description": "Use the following step-by-step instructions to deploy the Zero Networks Segment Audit data connector manually with Azure Functions (Deployment via Visual Studio Code).",
              "title": "Option 2 - Manual Deployment of Azure Functions"
            },
            {
              "description": "**1. Deploy a Function App**\n\n> **NOTE:** You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/functions-create-first-function-powershell#prerequisites) for Azure function development.\n\n1. Download the [Azure Function App](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/DataConnectors/ZeroNetworks/SegmentFunctionConnector/AzureFunction_ZeroNetworks_Segment_Audit.zip) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. ZNSegmentAuditXXXXX).\n\n\te. **Select a runtime:** Choose PowerShell.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Microsoft Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
            },
            {
              "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select ** New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tAPIToken\n\t\tWorkspaceID\n\t\tWorkspaceKey\n\t\tlogAnalyticsUri (optional)\n\t\turi\n\t\ttableName\n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`.\n3. Once all application settings have been entered, click **Save**."
            }
          ],
          "id": "[variables('_uiConfigId2')]"
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "LogicAppsCustomConnector"
      },
      "properties": {
        "description": "ZeroNetworksConnector",
        "displayName": "ZeroNetworksConnector"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName1'),'/',variables('playbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "LogicAppsCustomConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "ZeroNetworksConnector Playbook with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "Custom Connector Name": {
              "defaultValue": "ZeroNetworksConnector",
              "type": "string",
              "metadata": {
                "description": "Name of the Connector"
              }
            },
            "Service Endpoint": {
              "defaultValue": "https://portal.zeronetworks.com/api/v1",
              "type": "string",
              "metadata": {
                "description": "URL of the Rest API"
              }
            }
          },
          "variables": {
            "urlHost": "[[split(parameters('Service Endpoint'), '/')[2]]",
            "apiPath": "[[split(parameters('Service Endpoint'), '.com')[1]]",
            "operationId-Search for an Asset": "Search for an Asset",
            "_operationId-Search for an Asset": "[[variables('operationId-Search for an Asset')]",
            "operationId-Get AssetId by FQDN": "Get AssetId by FQDN",
            "_operationId-Get AssetId by FQDN": "[[variables('operationId-Get AssetId by FQDN')]",
            "operationId-Add asset to protection": "Add asset to protection",
            "_operationId-Add asset to protection": "[[variables('operationId-Add asset to protection')]",
            "operationId-Remove asset from protection": "Remove asset from protection",
            "_operationId-Remove asset from protection": "[[variables('operationId-Remove asset from protection')]",
            "operationId-Create Inbound Block rule": "Create Inbound Block rule",
            "_operationId-Create Inbound Block rule": "[[variables('operationId-Create Inbound Block rule')]",
            "operationId-Create Outbound Block rule": "Create Outbound Block rule",
            "_operationId-Create Outbound Block rule": "[[variables('operationId-Create Outbound Block rule')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId1": "ZeroNetworksConnector",
            "playbookId1": "[[resourceId('Microsoft.Web/customApis', parameters('Custom Connector Name'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('Custom Connector Name')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "connectionParameters": {
                  "api_key": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "API Key",
                      "description": "The API Key for this api",
                      "tooltip": "Provide your API Key",
                      "constraints": {
                        "tabIndex": 2,
                        "clearText": false,
                        "required": "true"
                      }
                    }
                  }
                },
                "backendService": {
                  "serviceUrl": "[[parameters('Service Endpoint')]"
                },
                "brandColor": "#ffffff",
                "displayName": "[[parameters('Custom Connector Name')]",
                "description": "Zero Networks Rest API",
                "iconUri": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOYAAADmCAYAAADBavm7AAAACXBIWXMAAB7CAAAewgFu0HU+AAAAB3RJTUUH5gMQFSsuqzvuTQAAIABJREFUeJzt3XuYZVdZ5/Hvu9ba+5xTVelOOiSd0J0OiIoJBnAwA4PC43gfiY+KuZOL+OjD3cszMwQISSeRa8KoyIiPlxkUEumAo5J0EsJFHwUTUBAheAFRJJAQAmnSlzrn7Mta7/yx9qmqDrl0QlfVrvB+8tTT1anTVfuc2r+z9l6Xd8locJpijOkVt94HYIz5RhZMY3rIgmlMD1kwjekhC6YxPWTBNKaHLJjG9JAF05gesmAa00MWTGN6yIJpTA9ZMI3pIQumMT1kwTSmhyyYxvSQBdOYHrJgGtNDFkxjesiCaUwPWTCN6SELpjE9ZME0pocsmMb0kAXTmB6yYBrTQxZMY3rIgmlMD1kwjekhC6YxPWTBNKaHLJjG9JAF05gesmAa00MWTGN6yIJpTA9ZMI3pIQumMT1kwTSmhyyYxvSQBdOYHrJgGtNDFkxjesiCaUwPWTCN6SELpjE9ZME0pocsmMb0kAXTmB6yYBrTQxZMY3rIgmlMD1kwjekhC6YxPWTBNKaHLJjG9JAF05gesmAa00MWTGN6yIJpTA9ZMI3pIQumMT1kwTSmhyyYxvSQBdOYHgrrfQC9pUBSVABVBHnQhwJLj/jGvyviHA/yLQBISVHVh3xcHwnd81YQEUTyn+aRsWB2kkss1A7RyIFhySgWLA6/wvyBzSz6ApX4gP/WMwWExnkUxyCCS4lpoaCesoVClNY7UvK4BK1LJBcp1CPiaJuWpq0pfYFEBzii6AP+zL5RoMSRGJMkEvyRxFSgrkLdIuBwqWT5bcs8GAtmR5JnHBxOaqrpHkZPOYGnXf0StB4xdomgFQ/UlKm0JIEkDlQQFEfKf6aGudE2qj//FJ+45M8o9Wiig1Gq0FgQiyOZTO5lYdOEt//Bqzj5ux5P0hxo3WA3GhIVaHFeuPKN7+Tqaz7AYLAZxSHqsFAeOgtmZ9gKBwaOJAWDNEVKhzt5O5GWTUB6gItZRXAU3WcRIaGk5e9LSfH5r/HPf/rXLNRzRO+oipZKlJBgWt3DcO4e/vDq1/PTP/kDa/RsV5MCwrFbRyhjYBN2mj189ootaSlbR5SSigUKFhD1DNtIJBID3N+VpSJMXEmRIk4akrSEBCSHD5tZ/NxePvXc30Vuq6hHR5O0QkjUbo5qGplfGHPNriv5yec8i1ZbPD6/BUgi3+BuHCkBknDOE6MABbl/cXYbsLGez3qyYHamRXefFJWWhEpDK2OmxYQIlJSk+0mmIAQV1DU4KpTIXuc51h3H4HN38OHn/hbcVkHxGBoaNqdE44XFuuaIUcM1uy7jtOc8i0n9dQbFQhdKgBoksJFOZucjSgRGONcALflVtcvYh8uC2RGU2ie8KkMiRRvxdB0aydG64n4j4lQYRUcVHCF5gnrm/Db8Z7/OR878bdJtE9JgCwmYqz3joaeZ3sN8OeGad72R057zLJImgjsCwS23lDrcSJnsaD5+QFVY7qtNbMAns64smB1RRTQBCaWl8UpFwUADLkW8LN83Lg0NdH+rneBUmThlM0dR/vOXufXcN1N/MuHDDmo3Ya6pGGjkQB0ZlpG3v/PXOO20ZzOpK0o/wDuHkIAI4nM4N9q5nAIQuhfIA57lS9l872kOjQWz0zqHU3AkIhCSEmipJeFDpNCEU6ERoRWHU8ErJIFWEsMoHBEeC/9yNx8+801Un64YDrYzlTG4MdOhY3LgAJuHLVe/6w2c9pxn0rQthS8Q0XwDKwBhY4YSVjwH4eBWUtiYT2j9bLAO+dXjNLd6rQgtA1waLLWMQcFpSyspv+8nwSeH4GhJpFQRw5H4f9rL3/7Mm5l8uiaOjmIs+xG3SCFD2sWSct6z6/+9ntOe80yq6gBeIHiHc4KTPHbJ7B5zI57HsqJVlO7eUhRQNtzYzzqzV+t+dSdT97lPDnTIROZQRgglSXJsVRLel+hXJ/z9Oa+Df7kXP1oAV+GpUIZUYwjlPq7ZdTE//uPfR1IoiiHiHnjSgvnWZsF8CAI0TkjiGWqglYLKCckpUSIQOIqj2PP667n3U4u0g600AoMmEZ2jqhKj4SK7rt3JT532A0zqMSlNyJd6xfo+OdNbdo95CGpRnLR49SSUzXVNpOZAWXIMW/jSK67jX3/zr5gvd1BpYhSF1nl84zhyruVtuy7jOT/xLOpUMSiGCBEQROx90dw/OzMOgaA4TQiRUhuiVjTlPMdxLHe+fBeffuMHGYTjibFlgOJ8QB1Mmzt53VUv4jk/8SyaWEOqcAJC0YWyWe+nZnrKWsxDEBAcHp+E6BL7ByVb2cRdF72bz1/1N5RhC9FViFOqMERUacZ3ccbzfoQzzv9BYmzwUpAbyAQy67VMD/6DzbcsC+YKgiJo/q+b5SMA6okqucNHSo5hji++8o/4tyv/Bopvo/AHgCm4gpiUZnIP557xE/zR2y4nFJ62GeO8oFoikvJjcUC5bs/V9JsFs+M1kluziJJQaSlIeeQiCi42jAeJzfoYvvTK6/jMGz9OGbYjfkwMiwglWo9o6q9y7tnfxzuuvhznPaoQihEwG0hwwJCNOR5i1ordY3aKNlC5AVM3IFBStIE8F0eIHKAaTNmiR/L1V7yTf3rjDYTiGKKLTEOFuAEaF5jWd3PWWd/P295+BYlEU8/uIe87MGmhNA/OgtmJ4vFxgI9DGkqq4Gi7pVxNGLCFLdzz8l189soPMiyOB9dSSoWERJoOmU7u5PQzn8U7rr6CshjQNgmkwTp4zCNhwexMBgmRlOePoyy0LaoNUzzH6Xa+cNEHue1NHyKV28ArQ61BEoMqUNVf4+yzn8UfX/NrFCEQNVGWA5xfOVHBmENn95idJInoWhSloKbUlihDjtVN3H7Rn/DZqz6MDo9HXWJTjKh3jLWkmezjeed8P2+/5jU4yWsSvROQvPzJLlvNI2EtZie0EBKMYl7hce98yTEcw55XvYfPXXUzLswx0IZRXVF5z6ITmundnHnGD/GHf/Ra0MR02nZzQruOJO3mvhrzMFkwO66bbpfwJCnYXBfc8eq3cdsb/gJfPA6KRBsSWg6IbUm9uIfnnv1fufqPX0UoHLEVvIfEGBDQsDyB25iHyS5llyhCSxSlKAv23PZF7vrEvbjwGOpiL94fIOoCVQNN/R+cc/aP8rarX0vhPaqJELpqA+KWW0pdpTWIulx1JMW8ZMw5yeUi71s7cxV+dn7DieT3dbf0BY0OlQZxBSm1QERVUPzBx2YekgWzI+TqBbMzukmCk6PBRVyKKEfg4xx1s4fzzjuNd7zjMmYnpcisZuxscfDyd12lg0VogZaoimjAubD8I1frDWH2/YksB3P5C03bIL7BuQJxA/K4cGJpOZs5ZBbMgyyfPCIslcmA3Co29R2c8tQd/N7vX0rV1EwnU8pyDufdKjUGs+NpydP3ZhUBci/T4oFFyoEwGs3nh2l3zJJYnV+tkod/ZmG7z9G6lpjympmm7h4vDUKZV5SbQ2bBPCQB0YKiLPji7WP+86kX0jYVokOEIVGlS/JhpgIuksMgoAX5V+ZY3H833/UdC/zfd7yGue0LyFK9E2H1uw4c+U1i9pxzCyoBhjLH7t238u53v5+ymCeH2O61Hy4ZDU6zV+xBCSot6hJoQGOkrqfdVwZAQKlZnRNvtgIl1+mDOXI56a9z3LFH8d7r38RTTv126nY/ZbHQlSSZhWD1+/VSakmpQRw4EUSG3HDzLZx9+isYL5aUw7KbeeyR5Fit64pHI2sxD5nmPUxcYDhcYOnkV0HdKi141q4zCSANCH7E4vgOHveEI7nh+jdz8kknEmOFc91keOmO8wEuNQ87UVKKpEYYjua54X23cubpL2eyOGIwHKKaF4OLRESilRd5GCyYDylvV0DyLE9yz+tQUEGFXHrkEVtZc+/gThvRApUWRBHxLI7vYcfjF/jT667k5JNOoGn24f0QJ8WKf+fWqJhXnkXsXEFZDnjfjR/i9DMuZjrZxNzcJhJjtPXdVcUYpAUdYJe0h8aCeUjyBWSerJe6/UlmHTEg0j7C7ztbk9l9r9kYSNfyJSrERUQL6mrC9m1Ddu/+LU45+UTqOMbLEYCgqrnSHrLiPvNwWn7j0DSrhNcCQggD3nvTLZx1+qtoqnkG5RGkmFfoOHzuIRY2XFX59WbBPASCduemR3TlcMgskI+kxey2QZDYtcZ++R5RNbedxRiRIXHqiXo3F738v3PKyY+jqWuKMI/4Fd/rfj49fGaV7pTURlRaXPA4GXLDjR/mZ0+/iGqyidFgACzmzthZCUuZdKEssNby0Fkw143m2UHMOmxqlrtWZ0EYEqshdfMVLt15IS/9pTNpY26pRA6+7F1dctCfTVsxKua56cZbOffsi6mn88zNFaTY3s/WS9ZSPhJ2N76uHKRZx9Fsfq2AeoRAmg6omzu4ZOf5XH7Zi4naAA7nm64neK10QzAiiIfRaBM33vSXnHXm/2Rx/ybmBkd3K06tRTxcrMVcd8udNqoBxxBVRbWljndz2RU/x85LXojSgnqcuG6Wz9q0RCklRISU8vaCwXvG04ZfftlV7F90zA8KUpp0t5L2Pn+42Cu5rrqtEQDU4RjifEnUyLS+iysuO5+dl7yImGpS8ngneRctDaxeTdoVl9KAiKAKqooTz4HpmDNO/2X+/d+mzA+2kDgAfoIsbSJkDgcL5rpbnnWuqrRxkbq5nVdf9nwu2flCmqamqbWb/zrbD2Q1f22zn5OPKyVdmqRfNy3nnHUJN97wEeZGx5DUgYQ8PinL/8Z88yyY66yryZcvF7VhWn2Zi3f+Ir+284VAwkkgBLrdmemWk61yCHS5xcxDMcJ4MuZ557yE3df9A6PR47utlxykOUjDbqcyC+bhYveYq0pAKnIPa8nSTl55PIEkNRKmkIbEuqBq7+KKy3+eSy594dK/9z6XzFzanVlgdd5Puy0Io0PwJCJtqghFwf4DE8573iXsvu6zDMsjITUoetD8YLX3+MPKgrmqVuymLImlcc9uPqtIi5MhsR1RtXew87Lnc8mlL6BpKoRAKDzL29qtxf1b7nXVlHuGfUiMF6ecc9YruOnGjzCaOwbiyiLV1kKuFnubW21LK0IS0OSpaV3rJCnQTgdU9ZfZefnPcdnOFxBTS4y63NKuGQE8KSlNW+G8EBt43vNeyU03foz5ua0gazlE863NWszVNpsp1LV8qnkJGZLQ5Kibu7n0svO47NI8JCIEysKj7GetdmFWnfUMK4rgg2MynXD2ma/iuuv/loXRFhIttHNYK7k2rMVcdSs7UgJO5nB+RErCtPkyl+88n8t3vphEk8cpXcL5hPfzrN6v5+DOndlH0zSIwHjacuaZr+C6629hbnA0MbVoDN0wjVkLFszVNtvGHQF1CELbLlI1X+SSS5/PpZe9kKqa0tSz+8jI0oqWVTObPJ97XGf3sOWgZDptOOeci9h9/UdZmNuaL6m1zJfkzi5l14oF87A4lMtNxTlo2ilVcwcX7/wFrrj8BeRweBwNypQ8mX1WYW8t5JbSOaGq9nHuORdxw3WfYG5uMyotSYf5mKTu9vU0a8GC+U1TcJOuwHNXj0fSciePBNQJOCXGhrq9g8sv+wVec9mLuml2UBQFvgjLS8lW+bYyz+SJxNjQRhgMSsaTmnPPvpj3vOcWhoNjUIUYycckCUTRVW3FzUp20/BNW55Sh/ocUJlNSAdci7iAJEfV3MXll/0il+58ASlVedK3C92F5H2n2K1mOh2qStQa7z2TaeSM01/OjTf+HXODrSgNpEE3Kb1rJS2Ua8pq/hwOuqIwlcyGRLplXT4S/AL79+/he089no9+9BpUW9o6UpQB59b+hI9xNiE9MK0qzjr9FVy3+2McMbeZmGpUh1jv6/qyS9nDQbpSHtJ13OCBIneYJM/+/Xdy8knHc+21V+JESRrxPqDfVEmSRy5qg7iW8XjK2WddxHW7P8r8cEsumaIlFsr1Z5eyh4PMquQpIgERT0qCOM94uodTnrSN6298EyfuOB5FCb5A3NqtxlBV2rbFOYcIeJ/Yt6/mgvMuYffuf2BUHpdr9KRA3tjeOnnWm7WY3zTtLl+bPECvgoijKJTx9Euc8qTt3PTet3Lijq20qUaQvG5RdK1yubSmEgARvIz4X1ddze7dtzJfbgVpUS1zgTEeaf0iczhZMA/ZA6VIuo4fR56knieq79t/Oyefcgw33fxmtm0/hul0gsbZpS6s5UufW0rp1lQ6du36AG/5rT9hWByDumkuMLZ0j7xmh2UehAXzkMyGP2D5zJ1VzVOQbj6s5KpwB8Z38N3f/Tiu3/37bNt2DKo1ZTGP90X+XktW715OVbu1lJA0obSEEHjXtTdz/nlvYDL2hDJ2x+9Q14CIDYn0hN1jPqRuE1ppQefIg+0tUJNrwQXwAZJHFMb1F3nqk3ew+/rfYduOrd1ay7KraHffl3t1mqd8TxkRcYiLqDQEN+Kdu97HheddRYqBwaAktsCsSq56Vk7VM+vLWsyHpF3v6lweFlHILWj3VVVEhSIMGU++zimnPJ7rrn8r23YcS10391M1bm04l0OJTAgyYteuD3DB+TtRbRgMZm8QFsK+shbzkPhurFKXh0TUd9XsPERl3+IdnHTS8eze/RZO2LGVuvk6qnNrtUDkICLSVXCfEGQTu3a9nwsveC2SjiQUs0tpC2WfWTAPSex23er2LxGPqpB3ARPG1Rd40pNO4IYb3sKOHVtJOqUsFlANaxZKVSXG2E1YyPeUhWxi17tu5oLzX09sj2AwII+5qoWy7+xS9iHN7jGrpfFKweFdwAcY11/mKafs4Oabf4cTT3wMiQlOhqBFV5R5bUIQY+zWVebtEgo34p3v/ADnn/daYjvHoBwBgWS1eTYEC+ZD0hUVHQWd1X91yoHF/+CUpx7HTTf9Ltu2Hce0OsDSjlZLO2+tTQicczjn0JQQCVz7rvdz4YWXos0cw2FApSHNxk9N79ml7CHpxii7XlhNsO/Al/muJ23nz9/zFo7fdgyxTXiZ7VGZWJr8vUYvca5mB84Hrt31Xs6/4EpIJYOBIyXphkMSmkqUZFXTe86COSOzIElXyc7lDwV1inqHU4dTz+LkTp588jauu+F/52l2mvDBsTwCqCy/tKt3k9k0bb6ndEqSKYWb59pr/4ILzruKlArKMoC4bjgEUGeh3CDsUvZB5WlzQui2lEssTvbx5Cc9gRve+1ZOPPF4UkyI3PdllBUfqyPG2P3cFpEJhZvnmmtu5sILXo0ilOUA8F0/z6xrWCyUG4QFc8n9hWlWlTwi6mmqxJNPOYHdN/0620/YynQ6Ia7TfG/nPOIiiTGOea699gP8/PNfR9uMKIqVu4aZjciCOaPdJexsNwLyPVv+iMSmoU37ufJNL+aEE44laUtRDPGhYT0CoCQSFYXfzK5r38/5572W1MwzGMyhOljz4zGHlwVziVv6cC6X94gpdgWQW6rmHt786y/lx370aSgTHB7vBefWp8lUWgq3wLve9UEuPP8KYrtAUc6hKqjYTPSNzoK5ZPkyVnWp2aRtG6bVAd7yGy/jl371DBI1wpDl7c4HrNksghW8lLxz13t53rk7Se0Cg4HrLl49KraecqOzYM4s9cTmgIYy97FW1Zjf+PVf4aW/chYp1cRmNkA/W22yPqsxbrrh77jw/CsQSorS53UubppDqau1Rd+hshb7m2XBXJLyyS0JxFNPI1X9Bd78Gy/ll3/1Z5kNgYQw7B4/G9tcRQdtVZmIKdd13XvPPl598e/RtEN8KPOyrdnk+m5Xar3PP1+rD1xLYrbGc/YkWLfJ/BuVjWPOSF4srCRiUoIX3vqb/4MXvfiMfL47wbnZybUWJ5mCTJjVD1LNVfe+9IWv8Nyf+hX+/pO3AVuZVhUwvc9xrVdv7Fx3LA1ONjMsBygV+U3P2oCHw6rkrZDvz1qqacV/ecZTueXWq/L/jwnx63Fi1d0Uv1zbVUl87jO3c8ut/8jmIx+TJxmtw1E9kDYFkEghyh/8nz/jphtupSyPgjTbv6WlX0fcX9ZiLlkehIeEapUvxmLd1ctZj2CW+XDyNSIxVnzHE0/gO574hHU4lofnQ7f8Nbuv34/oUai4rjPNQnmoLJgrqUA3iyelmGM6W9i/9gdDviwMXekSwbshKeWtFvo4gUCTQyXixBOrAMyDetS1IGrz5x8GC+aMdEMkutwzm9/fPazLuKCArhiKWTHZIZc1Kelb351I7JbGjXCzotd06z/FWsyHw4K5ZNaL2O0forL89/U6p75hDq4jb/ledG1lv5ogUdftdZI/z6+dAzfbXezhnm6z5/etF2gL5kFmZRzX657yPg56Q1hxD6zkTX56dsLmvXlnYeqOV1Z+VVGRpYccPLU+dZcEbmnt69JjhFzUDEGSghNSdynvlr7X8puUCqC5H7hvr9GhsmAu8bl8iDR04yPrfUD3aSjkoE+ljyODLqEMcvdZt+9mci1JhBADIi2VE7wqLkFygqijTELt266UpkeTIlqgdUuk7XYNbSndCOfyHOYY8sZIZfRIgiZEfOq+1q0HL6ISZWOup7FgmjWgRPGIloTY4OjuPyVPxm8E1Dl8SsTxAVQqwoIyf+qJzJ+wnVpqUOHev/00cseEthKKtAkdBKLmTjoVRZ3iE4ToSRS06kCmD3VwvWTBNGtAUfL+nyE1IErrQJLgFAr16EQYy70snHo0J13wg2x/5mO599uHTDdt5msoj8Wz+TN3UX8x8vE//Qj7r/0Y1Z6KQbkZkQRRluYIh5RbyigBtzzetKFYMM2aECJBW4SGViLiCooY0JiYtouMNiWe8pIfYvvFP8Le+SlfYRHFs0hDGYeMtYInLhCfGHnyD/8M6cJn84W3fJjPX3MLwW+mcIEUPK1UBG3xKsv9dxuQBdOsAUGICDXqWprgCCngxLMY91J8Z8mpb7uAhWeexF00jGkpGVDgGKgyFxsmAfYRmGuFvW5CfPqxnPz0M+AJiX99zS14twWvA2rvaZlStgmPbth9yyyYZk2oKMklooNIoFRP1Y4Zfmfg2X/4MqbPOI674l4kCSPniT6RSAw00YaaIIB6psFRqGPQVtwZ4NsvP48FXeCTV72PhfRYVDyteLxTckG0jbkXSw+6Hs2jXZ7kKLQuEKUADUgSqniAp73kx6ifsYNJuw8fBZWEc4lScyeOpAGVFNTdFCyvEWkSXpUjas8exjzulf+Nbd+znWk7xqVAkoLWB+I67NZ9uFgwzarL45WaW7LkGUSYtGOOPmkBf+5/4gB7IURikdAASUBFSC7R+Jin8wHgcotYKNMQqYopTqd8dRQ47gVPJ+oeVGHUCElzudGNyoJp1oRXcCSii6hG0IanvugnCUfPoW2bJwLIbMKBoqR8+SvL5TZVuuJooqgorSioULV7OfGnn8GOZ3w3sVkkuUhyCdnAW0FYMM3aUEWIND4SJaIhsv/ZT8DR5rWmj4BDaEkMY2S8+Qjq791O0kUaryTXIpo2bJtpwTRrIjkhScKpom3N8U/Zhj9hE5M4pfXxEY80qlNaadjPhK1PP5FhWUBUnEaS6AYcwcwsmGbVCRDzhFcGLWiMHHXyVo4+ap5FV3+Tq3eUpvA0jNn+PTsIcwVlI5QJWu8smMY8GBWPEPApl0qp24oBEaHEq+9m6DzM7wl4dWhyDCihnhBRXCpwycEG7gCyYH6D2QLkjfkL7SsfHZICiUDCM5gqE60RfL68Ja0oICr3+bjv/1vxmSZKDUxIyLSGVogEVAM+hg37W7QJBp280igtvcu6bpVJLoIV2IjzLddaXm3VIi50a19yr2lySuju+drQUsQRt//VZ2m/8CWOedxRRIWaQCJ3EAVaQtejGmV5YZhTRQUaHAkPeJzAUBvGlHzi5o/TLra4UomhpWhmvbnr9Yo8chbMThIFibiUtxcQV5EU0AoR39X9MQ8mxUTSBucCMeWZN7q0trVBXaT1Fc4PiXscR96RKB4Hqg3KiFGMiCpNSLQCQQWnXTBFu11kEiGBT47aCSK5PtORbGbP51tES5KviL6hbNsNu3m2Xcp28mXRbCVCixJx4nBu3kJ5iJz3hDACIBSBPOaYEIXULcnyMSA+MtaGvb//YZRNBAdzqe5KiHqKNCDpiKmMUEocBQ0Dahni0oigJSqOgpb5VBPLI4ifupu7P/APpFCiQNHk3bN1gxYashZzyWx+iuKcY3Ex8aEPf5y8jYlj43a8r6EkRI0UheP22+/FuSG5hkC+BPURQnIoLYQB//7u2xi87HY2P20Lmhr2O4c4YVMU5pNS+ZZGIg3gcIyip0iOcQGLKCMUHxXPHJ/9vZsZ3zGhLAtcVHzy1D7v0rYRWV3ZTnJN/kQHOC1QHTOtv4aT1BXFsvvMh5IrDYwR8RR+C86PUGlQyYuZQ8yFzpJrQUvaasKOnzuJ73nb8/kCexg1LaKBRUnMOWEYE3sLZSqwOcIgOfY7IAojUcY+MnJHsnDbV/nLH34r6WslUtT5TSAFksQNW2jaWsyD5EvZJC1CwaA8nqUaOxu2f28NaSC4mlyapeyuMnJvq0tCEkftHdE3hNgyHGzmzqs/xvxjC7a99iz2FxOqNMWrkpxnIoEiBYquJtDUtzhpqTUx9p55OZLwma/wsfPfin5VYOCYhoRKoGg9IT2yGUV9YMFcIl3pygRSoeJQLcklMFrbifkQaBJydSxFNJJfu3zfmMThY97iUDUvy0qxYsAWPvWGvwQKdrz6PPaOGpQ9tNTUIgyjUiqMfSJKyxBlGDZRchSjv/8if/OLv834kxNGxVHUrsYjtOryShUcG7WYrV3KdtKs7qlEVKru/5bQdeJLyvdL5oGptCBN15FWdNcYebhJ8ZRREBWQGldEwDFxATeFpl1ky1MewxNe+kxGZz6FYtOAyJQDQAPMA0M8MGD66Tu55y238rlrPwV7QeZHOG0YSCQ1StQBRXJMiwgbdL6sBdOsq/x2KEQtaOv9JPbx2FOOR1TJAAACV0lEQVQfz3GnPpbq+x+PP+XbmEjNwlSY3vR3DP5pH//4gX+k+WpFEbbgfQHUrCh2uZ5P57CxYJpeWNogKQltXdHSEBgSQtk9IFHHKYnIwA+R4PNQiD5aongwu8c0veBViQIxKCkUeA2EJARtceQiIaEoiQKtA5cSPnU7WzwKx5ktmKYXpkFwqoSUEE155FgS7VKpdaXAE6KgyRGdo/H5njVs3M7XB2TBNOtOBUTzbmCiPq8O0Ty8snIUUlQREklAJCGSJy/Io7DP3IJp1p0olFFIAq2Ahq4nnLQ82iGzdT/d7FtVQsr7oDzaQgkWTNMDKtC63GK6JLjULeoSAe1aQ9Guho90tYCglbxXiU92j2nMYZcDefDqy0zvd8mW6PJ+bD3cWumwsGCaXnArEphXhKzczg9yS7n8eIE8WeFRyoJpeu7RG74HszGn3hvzKGfBNKaHLJjG9JAF05gesmAa00MWTGN6yIJpTA9ZMI3pIQumMT1kwTSmhyyYxvSQBdOYHrJgGtNDFkxjesiCaUwPWTCN6SELpjE9ZME0pocsmMb0kAXTmB6yYBrTQxZMY3rIgmlMD1kwjekhC6YxPWTBNKaHLJjG9JAF05gesmAa00MWTGN6yIJpTA9ZMI3pIQumMT1kwTSmhyyYxvSQBdOYHrJgGtNDFkxjesiCaUwPWTCN6SELpjE9ZME0pocsmMb0kAXTmB6yYBrTQxZMY3rIgmlMD1kwjekhC6YxPWTBNKaHLJjG9JAF05gesmAa00MWTGN6yIJpTA9ZMI3pIQumMT1kwTSmh/4/QxRrrnn1NzwAAAAASUVORK5CYII=",
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "title": "Zero Networks",
                    "description": "Zero Networks Rest API",
                    "version": "1.0"
                  },
                  "host": "[[variables('urlHost')]",
                  "basePath": "[[variables('apiPath')]",
                  "schemes": [
                    "https"
                  ],
                  "consumes": [
                    "application/json"
                  ],
                  "produces": [
                    "application/json"
                  ],
                  "paths": {
                    "/assets": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "$ref": "#/definitions/assetList"
                            }
                          }
                        },
                        "operationId": "[[variables('_operationId-Search for an Asset')]",
                        "parameters": [
                          {
                            "name": "_limit",
                            "in": "query",
                            "required": true,
                            "type": "integer",
                            "default": 400,
                            "format": "int32",
                            "x-ms-visibility": "internal"
                          },
                          {
                            "name": "_search",
                            "in": "query",
                            "required": true,
                            "type": "string",
                            "format": "[variables('blanks')]"
                          }
                        ]
                      }
                    },
                    "/entities/encode-ip": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "id": {
                                  "type": "string"
                                }
                              }
                            }
                          }
                        },
                        "operationId": "[variables('_operationId-Encode IP Address to AssetId')]",
                        "parameters": [
                          {
                            "name": "ip",
                            "in": "query",
                            "required": true,
                            "type": "string",
                            "description": "IP Address to encode"
                          }
                        ]
                      }
                    },
                    "/assets/searchId": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "assetId": {
                                  "type": "string",
                                  "description": "assetId"
                                }
                              }
                            }
                          }
                        },
                        "operationId": "[[variables('_operationId-Get AssetId by FQDN')]",
                        "parameters": [
                          {
                            "name": "fqdn",
                            "in": "query",
                            "required": true,
                            "type": "string",
                            "format": "[variables('blanks')]"
                          }
                        ]
                      }
                    },
                    "/assets/protect": {
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default"
                          }
                        },
                        "operationId": "[[variables('_operationId-Add asset to protection')]",
                        "parameters": [
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "items": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "List of AssetIDs"
                                },
                                "protectAt": {
                                  "type": "integer",
                                  "format": "int64",
                                  "description": "epoch(ms) when to move from learning to protection, 0 means protectNow"
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "/assets/unprotect": {
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object"
                            }
                          }
                        },
                        "operationId": "[[variables('_operationId-Remove asset from protection')]",
                        "parameters": [
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "items": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "List of AssetIDs"
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "/protection/rules/inbound-block": {
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "$ref": "#/definitions/ruleResponse"
                            }
                          }
                        },
                        "operationId": "[[variables('_operationId-Create Inbound Block rule')]",
                        "parameters": [
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "$ref": "#/definitions/ruleBody"
                            }
                          }
                        ]
                      }
                    },
                    "/protection/rules/outbound-block": {
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "$ref": "#/definitions/ruleResponse"
                            }
                          }
                        },
                        "operationId": "[[variables('_operationId-Create Outbound Block rule')]",
                        "parameters": [
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "$ref": "#/definitions/ruleBody"
                            }
                          }
                        ]
                      }
                    }
                  },
                  "definitions": {
                    "assetList": {
                      "properties": {
                        "items": {
                          "items": {
                            "$ref": "#/definitions/asset"
                          },
                          "type": "array"
                        }
                      },
                      "type": "object"
                    },
                    "asset": {
                      "properties": {
                        "assetType": {
                          "enum": [
                            0,
                            1,
                            2
                          ],
                          "format": "int32",
                          "type": "integer"
                        },
                        "domain": {
                          "example": "domain.local",
                          "type": "string"
                        },
                        "fqdn": {
                          "example": "laptoppc.domain.local",
                          "type": "string"
                        },
                        "id": {
                          "example": "a:a:6d020055",
                          "type": "string"
                        },
                        "ipAddresses": {
                          "items": {
                            "example": "1.1.1.1",
                            "type": "string"
                          },
                          "type": "array"
                        },
                        "isAccessible": {
                          "type": "boolean"
                        },
                        "managers": {
                          "items": {
                            "$ref": "#/definitions/manager"
                          },
                          "type": "array"
                        },
                        "name": {
                          "example": "laptoppc",
                          "type": "string"
                        },
                        "operatingSystem": {
                          "example": "Windows 10 Pro",
                          "type": "string"
                        },
                        "protectionState": {
                          "enum": [
                            0,
                            1,
                            2,
                            3,
                            4
                          ],
                          "format": "int32",
                          "type": "integer"
                        },
                        "source": {
                          "enum": [
                            0,
                            1,
                            2,
                            3
                          ],
                          "format": "int32",
                          "type": "integer"
                        },
                        "state": {
                          "$ref": "#/definitions/state"
                        }
                      },
                      "type": "object"
                    },
                    "manager": {
                      "properties": {
                        "entityType": {
                          "enum": [
                            "user"
                          ],
                          "type": "string"
                        },
                        "id": {
                          "type": "string"
                        },
                        "name": {
                          "example": "User Name",
                          "type": "string"
                        },
                        "permission": {
                          "format": "int32",
                          "type": "integer"
                        }
                      },
                      "type": "object"
                    },
                    "rule": {
                      "properties": {
                        "action": {
                          "format": "int32",
                          "type": "integer"
                        },
                        "createdAt": {
                          "description": "epoch timestamp",
                          "format": "int32",
                          "type": "integer"
                        },
                        "createdBy": {
                          "properties": {
                            "createdBy": {
                              "properties": {
                                "id": {
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "enforcementSource": {
                              "format": "int32",
                              "type": "integer"
                            },
                            "userRole": {
                              "format": "int32",
                              "type": "integer"
                            }
                          },
                          "type": "object"
                        },
                        "description": {
                          "type": "string"
                        },
                        "direction": {
                          "format": "int32",
                          "type": "integer"
                        },
                        "expiresAt": {
                          "format": "int32",
                          "type": "integer"
                        },
                        "id": {
                          "type": "string"
                        },
                        "localEntityId": {
                          "type": "string"
                        },
                        "localEntityInfo": {
                          "properties": {
                            "id": {
                              "type": "string"
                            },
                            "name": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "localProcessesList": {
                          "items": {
                            "type": "string"
                          },
                          "type": "array"
                        },
                        "parentId": {
                          "type": "string"
                        },
                        "parentType": {
                          "format": "int32",
                          "type": "integer"
                        },
                        "portsList": {
                          "items": {
                            "properties": {
                              "ports": {
                                "type": "string"
                              },
                              "protocolType": {
                                "type": "string"
                              }
                            },
                            "type": "object"
                          },
                          "type": "array"
                        },
                        "remoteEntityIdsList": {
                          "items": {
                            "type": "string"
                          },
                          "type": "array"
                        },
                        "remoteEntityInfos": {
                          "items": {
                            "properties": {
                              "id": {
                                "type": "string"
                              },
                              "name": {
                                "type": "string"
                              }
                            },
                            "type": "object"
                          },
                          "type": "array"
                        },
                        "state": {
                          "format": "int32",
                          "type": "integer"
                        },
                        "updatedAt": {
                          "description": "epoch timestamp",
                          "format": "int32",
                          "type": "integer"
                        }
                      },
                      "type": "object"
                    },
                    "ruleBody": {
                      "properties": {
                        "description": {
                          "type": "string"
                        },
                        "expiresAt": {
                          "example": 0,
                          "format": "int32",
                          "type": "integer"
                        },
                        "localEntityId": {
                          "type": "string"
                        },
                        "localProcessesList": {
                          "items": {
                            "type": "string"
                          },
                          "type": "array"
                        },
                        "portsList": {
                          "items": {
                            "properties": {
                              "ports": {
                                "type": "string"
                              },
                              "protocolType": {
                                "format": "int32",
                                "type": "integer"
                              }
                            },
                            "type": "object"
                          },
                          "type": "array"
                        },
                        "remoteEntityIdsList": {
                          "items": {
                            "type": "string"
                          },
                          "type": "array"
                        },
                        "state": {
                          "example": 1,
                          "format": "int32",
                          "type": "integer"
                        }
                      },
                      "required": [
                        "expiresAt",
                        "localEntityId",
                        "localProcessesList",
                        "portsList",
                        "remoteEntityIdsList",
                        "state"
                      ],
                      "type": "object"
                    },
                    "ruleResponse": {
                      "properties": {
                        "item": {
                          "$ref": "#/definitions/rule"
                        }
                      },
                      "type": "object"
                    },
                    "state": {
                      "properties": {
                        "assetId": {
                          "type": "string"
                        },
                        "isAssetConnected": {
                          "type": "boolean"
                        },
                        "lasDisconnectedAt": {
                          "description": "epoch timestamp",
                          "type": "integer"
                        },
                        "protectAt": {
                          "description": "epoch timestamp",
                          "format": "int64",
                          "type": "integer"
                        },
                        "protectionState": {
                          "enum": [
                            1,
                            3,
                            5
                          ],
                          "format": "int32",
                          "type": "integer"
                        }
                      },
                      "type": "object"
                    }
                  },
                  "securityDefinitions": {
                    "API Key": {
                      "type": "apiKey",
                      "in": "header",
                      "name": "Authorization"
                    }
                  },
                  "security": [
                    {}
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('LogicAppsCustomConnector-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "LogicAppsCustomConnector",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "ZNSegment-AddAssettoProtection playbook",
        "displayName": "ZNSegment-AddAssettoProtection playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName2'),'/',variables('playbookVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "ZNSegment-AddAssettoProtection Playbook with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "ZNSegment-AddAssettoProtection",
              "type": "String",
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "ConnectorName": {
              "defaultValue": "ZeroNetworksConnector",
              "type": "String",
              "metadata": {
                "description": "Custom Connector name"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZeroNetworksConnectionName": "[[concat('ZeroNetworksConnector-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('ZeroNetworksConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('ZeroNetworksConnectionName'))]"
              ],
              "tags": {
                "hidden-SentinelTemplateName": "ZeroNetworksSegment-AddAssettoProtection",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Add_comment_to_incident_(V3)": {
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "message": "<p><strong>Zero Networks:</strong><br>\nThe following assets were added to protection:<br>\n@{body('Create_HTML_table')}</p>"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/Incidents/Comment"
                      },
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Create_HTML_table": {
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('AssetstoAddtoProtection')"
                      },
                      "runAfter": {
                        "For_each": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table"
                    },
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "type": "ApiConnection"
                    },
                    "For_each": {
                      "actions": {
                        "For_each_2": {
                          "actions": {
                            "Add_asset_to_protection": {
                              "inputs": {
                                "body": {
                                  "items": [
                                    "@items('For_each_2')?['state']?['assetId']"
                                  ],
                                  "protectAt": "@div(sub(ticks(utcNow()),ticks('1970-01-01')),10000000)"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['ZeroNetworksConnector']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/assets/protect"
                              },
                              "runAfter": {
                                "Append_to_array_variable": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection"
                            },
                            "Append_to_array_variable": {
                              "inputs": {
                                "name": "AssetstoAddtoProtection",
                                "value": {
                                  "AssetId": "@{items('For_each_2')?['state']?['assetId']}",
                                  "FQDN": "@{items('For_each_2')?['fqdn']}"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Search_for_an_Asset')?['items']",
                          "runAfter": {
                            "Search_for_an_Asset": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Search_for_an_Asset": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['ZeroNetworksConnector']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/assets",
                            "queries": {
                              "_limit": 400,
                              "_search": "@items('For_each')?['HostName']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Initialize_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Initialize_variable": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "AssetstoAddtoProtection",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident_2": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "ZeroNetworksConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('ZeroNetworksConnectionName'))]",
                        "connectionName": "[[variables('ZeroNetworksConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_ZeroNetworksConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Add Asset to Protection - Zero Networks Segment",
            "description": "This playbook takes a host from a Microsoft Sentinel incident and adds it to protection.  The playbook is configured to add the machine to protection(learning).  If you want to have it go straight to protection, remove the protectAt property in the action.",
            "mainSteps": [
              "1. For the hosts in the incident, each host is added to protection (learning).",
              "2. A comment is added to Microsoft Sentinel incident."
            ],
            "postDeployment": [
              "**a. Authorize connections**",
              "Once deployment is complete, you will need to authorize each connection.",
              "1. Click the Microsoft Sentinel connection resource",
              "2. Click edit API connection",
              "3. Click Authorize",
              "4. Sign in",
              "5. Click Save",
              "6. Repeat steps for other connections such as Zero Networks"
            ],
            "prerequisites": [
              "1. Zero Networks custom connector needs to be deployed prior to the deployment of this playbook, in the same resource group and region. Relevant instructions can be found in the connector doc page."
            ],
            "lastUpdateTime": "2022-03-16T00:00:00Z",
            "entities": [
              "Host"
            ],
            "tags": [
              "Mitigation"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "ZNSegment-AddBlockOutboundRule playbook",
        "displayName": "ZNSegment-AddBlockOutboundRule playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName3'),'/',variables('playbookVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "ZNSegment-AddBlockOutboundRule Playbook with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "ZNSegment-AddBlockOutboundRule",
              "type": "String",
              "metadata": {
                "description": "Name of the Logic App/Playbook"
              }
            },
            "ConnectorName": {
              "defaultValue": "ZeroNetworksConnector",
              "type": "String",
              "metadata": {
                "description": "Custom Connector name"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZeroNetworksConnectionName": "[[concat('ZeroNetworksConnector-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('ZeroNetworksConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('ZeroNetworksConnectionName'))]"
              ],
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Add_comment_to_incident_(V3)": {
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "message": "<p>Zero Networks:<br>\nOutbound block rule was created for:<br>\n<br>\n@{variables('IPstoAdd')}</p>"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/Incidents/Comment"
                      },
                      "runAfter": {
                        "Create_Outbound_Block_rule": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Create_Outbound_Block_rule": {
                      "inputs": {
                        "body": {
                          "description": "Microsoft Sentinel: @{triggerBody()?['object']?['properties']?['incidentNumber']}-@{triggerBody()?['object']?['properties']?['title']}",
                          "expiresAt": 0,
                          "localEntityId": "b:110002",
                          "localProcessesList": [
                            "*"
                          ],
                          "portsList": [
                            {
                              "protocolType": 256
                            }
                          ],
                          "remoteEntityIdsList": "@variables('IPstoAdd')",
                          "state": 1
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['ZeroNetworksConnector']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/protection/rules/outbound-block"
                      },
                      "runAfter": {
                        "For_each": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "type": "ApiConnection"
                    },
                    "For_each": {
                      "actions": {
                        "Append_to_array_variable": {
                          "inputs": {
                            "name": "IPstoAdd",
                            "value": "@body('Encode_IP_Address_to_AssetId')?['id']"
                          },
                          "runAfter": {
                            "Encode_IP_Address_to_AssetId": [
                              "Succeeded"
                            ]
                          },
                          "type": "AppendToArrayVariable"
                        },
                        "Encode_IP_Address_to_AssetId": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['ZeroNetworksConnector']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/entities/encode-ip",
                            "queries": {
                              "ip": "@items('For_each')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Initialize_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Initialize_variable": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "IPstoAdd",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "ZeroNetworksConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('ZeroNetworksConnectionName'))]",
                        "connectionName": "[[variables('ZeroNetworksConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_ZeroNetworksConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Add Block Outbound Rule - Zero Networks Acccess Orchestrator",
            "description": "This playbook allows blocking an IP outbound from protected assets in Zero Networks Segment.",
            "mainSteps": [
              "1. For the IPs, we add them to a new outbound block rule in Segment.",
              "2. A comment is added to Microsoft Sentinel incident."
            ],
            "prerequisites": [
              "1. Zero Networks custom connector needs to be deployed prior to the deployment of this playbook, in the same resource group and region. Relevant instructions can be found in the connector doc page."
            ],
            "postDeployment": [
              "**a. Authorize connections**",
              "Once deployment is complete, you will need to authorize each connection.",
              "1. Click the Microsoft Sentinel connection resource",
              "2. Click edit API connection",
              "3. Click Authorize",
              "4. Sign in",
              "5. Click Save",
              "6. Repeat steps for other connections such as Zero Networks"
            ],
            "lastUpdateTime": "2022-03-16T00:00:00Z",
            "entities": [
              "Ip"
            ],
            "tags": [
              "Remediation"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "ZeroNetworksSegment-EnrichIncident playbook",
        "displayName": "ZeroNetworksSegment-EnrichIncident playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName4'),'/',variables('playbookVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "ZeroNetworksSegment-EnrichIncident Playbook with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "ZeroNetworksSegment-EnrichIncident",
              "type": "String",
              "metadata": {
                "description": "Name of the Logic Apps resource to be created"
              }
            },
            "ConnectorName": {
              "defaultValue": "ZeroNetworksConnector",
              "type": "String",
              "metadata": {
                "description": "Custom Connector name"
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ZeroNetworksConnectionName": "[[concat('ZeroNetworksConnector-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('ZeroNetworksConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('ZeroNetworksConnectionName'))]"
              ],
              "tags": {
                "hidden-SentinelTemplateName": "ZeroNetworksSegment-EnrichIncident",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Add_comment_to_incident_(V3)": {
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "message": "<p>Zero Networks Asset Protection Status:<br>\n@{body('Create_HTML_table')}<br>\n1 = Not Protected, 2 = Learning, 3 &nbsp;= Protected</p>"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/Incidents/Comment"
                      },
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Create_HTML_table": {
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Assets')"
                      },
                      "runAfter": {
                        "For_each": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table"
                    },
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "runAfter": {
                        "Initialize_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each": {
                      "actions": {
                        "For_each_2": {
                          "actions": {
                            "Append_to_array_variable": {
                              "inputs": {
                                "name": "Assets",
                                "value": {
                                  "AssetId": "@{items('For_each_2')?['name']}",
                                  "ProtectionStatus": "@{items('For_each_2')?['protectionState']}"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Search_Asset')?['items']",
                          "runAfter": {
                            "Search_Asset": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Search_Asset": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['ZeroNetworksConnector']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/assets",
                            "queries": {
                              "_limit": 400,
                              "_search": "@items('For_each')?['HostName']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Initialize_variable": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "Assets",
                            "type": "array"
                          }
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "ZeroNetworksConnector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('ZeroNetworksConnectionName'))]",
                        "connectionName": "[[variables('ZeroNetworksConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "ZeroNetworks",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Nicholas DiCola",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Zero Networks",
                  "email": "support@zeronetworks.zendesk.com",
                  "tier": "Partner",
                  "link": "https://zeronetworks.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_ZeroNetworksConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Enrich Incident - Zero Networks Acccess Orchestrator",
            "description": "This playbook will take each Host entity and get its Asset status from Zero Network Segment. The playbook will then write a comment to the Microsoft Sentinel incident with a table of assets and protection statuses.",
            "mainSteps": [
              "1. For the hosts, we get their asset satus from the REST API.",
              "2. A comment is added to Microsoft Sentinel incident."
            ],
            "postDeployment": [
              "**a. Authorize connections**",
              "Once deployment is complete, you will need to authorize each connection.",
              "1. Click the Microsoft Sentinel connection resource",
              "2. Click edit API connection",
              "3. Click Authorize",
              "4. Sign in",
              "5. Click Save",
              "6. Repeat steps for other connections such as Zero Networks"
            ],
            "prerequisites": [
              "1. Zero Networks custom connector needs to be deployed prior to the deployment of this playbook, in the same resource group and region. Relevant instructions can be found in the connector doc page."
            ],
            "lastUpdateTime": "2022-03-15T00:00:00Z",
            "entities": [
              "Host"
            ],
            "tags": [
              "Enrichment"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "2.0.4",
        "kind": "Solution",
        "contentSchemaVersion": "2.0.0",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "ZeroNetworks",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Nicholas DiCola",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Zero Networks",
          "email": "support@zeronetworks.zendesk.com",
          "tier": "Partner",
          "link": "https://zeronetworks.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId1')]",
              "version": "[variables('analyticRuleVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId2')]",
              "version": "[variables('analyticRuleVersion2')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId3')]",
              "version": "[variables('analyticRuleVersion3')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_parserContentId1')]",
              "version": "[variables('parserVersion1')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId1')]",
              "version": "[variables('huntingQueryVersion1')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId2')]",
              "version": "[variables('huntingQueryVersion2')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId3')]",
              "version": "[variables('huntingQueryVersion3')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId4')]",
              "version": "[variables('huntingQueryVersion4')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId2')]",
              "version": "[variables('dataConnectorVersion2')]"
            },
            {
              "kind": "LogicAppsCustomConnector",
              "contentId": "[variables('_ZeroNetworksConnector')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_ZeroNetworksSegment-AddAssettoProtection')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_ZeroNetworksSegment-AddBlockOutboundRule')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_ZeroNetworksSegment-EnrichIncident')]",
              "version": "[variables('playbookVersion4')]"
            }
          ]
        },
        "firstPublishDate": "2022-06-06",
        "lastPublishDate": "2023-04-12",
        "providers": [
          "Zero Networks"
        ],
        "categories": {
          "domains": [
            "Security - Network"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
