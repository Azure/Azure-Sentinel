{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "SecurityBridge - support@securitybridge.com",
    "comments": "Solution template for SecurityBridge App"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "SecurityBridge App",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is setup"
      }
    },
    "subscription": {
      "type": "string",
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "email": "support@securitybridge.com",
    "_email": "[variables('email')]",
    "_solutionName": "SecurityBridge App",
    "_solutionVersion": "3.2.1",
    "solutionId": "securitybridge1647511278080.securitybridge-sentinel-app-1",
    "_solutionId": "[variables('solutionId')]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "SecurityBridgeWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "analyticRuleObject1": {
      "analyticRuleVersion1": "1.0.4",
      "_analyticRulecontentId1": "8c5c766a-ce9b-4112-b6ed-1b8fe33733b7",
      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '8c5c766a-ce9b-4112-b6ed-1b8fe33733b7')]",
      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('8c5c766a-ce9b-4112-b6ed-1b8fe33733b7')))]",
      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','8c5c766a-ce9b-4112-b6ed-1b8fe33733b7','-', '1.0.4')))]"
    },
    "dataConnectorCCPVersion": "1.0.0",
    "_dataConnectorContentIdConnectorDefinition1": "SecurityBridge",
    "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
    "_dataConnectorContentIdConnections1": "SecurityBridgeConnections",
    "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
    "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
    "blanks": "[replace('b', 'b', '')]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SecurityBridgeThreatDetectionforSAP Workbook with template version 3.2.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Sets the time name for analysis"
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Gain insights into SecurityBridge logs.\\n---\\n\\nSecurityBridge is the first and only holistic, natively integrated security platform, addressing all aspects needed to protect organizations running SAP from internal and external threats against their core business applications. The SecurityBridge platform is an SAP-certified add-on, used by organizations around the globe, and addresses the clients’ need for advanced cybersecurity, real-time monitoring, compliance, code security, and patching to protect against internal and external threats.This Microsoft Sentinel Solution allows you to integrate SecurityBridge Threat Detection events from all your on-premise and cloud based SAP instances into your security monitoring.Use this Microsoft Sentinel Solution to receive normalized and speaking security events, pre-built dashboards and out-of-the-box templates for your SAP security monitoring.\\nThis data connector depends on a parser based on a Kusto Function to work as expected. [Follow these steps](https://aka.ms/sentinel-SecurityBridgeLogs-parser) to create the Kusto Functions alias, SecurityBridgeLogs\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"961f51be-788f-4f9a-b2a0-0a596216d59f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":5184000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"e49c1a95-361b-4a51-8207-1dda7041d855\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Help\",\"label\":\"Show Help\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"showDefault\":false},\"jsonData\":\"[{ \\\"value\\\": \\\"Yes\\\", \\\"label\\\": \\\"Yes\\\"},\\r\\n {\\\"value\\\": \\\"No\\\", \\\"label\\\": \\\"No\\\", \\\"selected\\\":true }]\",\"value\":\"Yes\"},{\"id\":\"51cb8cb1-3d50-47f4-9485-2519a992c735\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"urlprefix\",\"label\":\"URL Prefix\",\"type\":1,\"description\":\"Add the url prefix of the system to view the links for events\",\"isRequired\":true,\"value\":\"\\\"http://abex3.abap-experts.com:8003/sap/bc/ui5_ui5/abex/sefwmd/#/events/details/\\\"\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"38cf22e5-8dc6-477e-8e6c-c8107de22596\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Events Monitor\",\"subTarget\":\"monitor\",\"style\":\"link\"},{\"id\":\"2e2baa8d-3b34-4818-a3c7-df5c179f6385\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Events Analyze\",\"subTarget\":\"analyze\",\"style\":\"link\"}]},\"name\":\"links - 22\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityBridgeLogs\\r\\n| extend Severity = tostring(Severity)\\r\\n| summarize Count = count() by Severity\\r\\n| extend SeverityNumber = case(Severity == \\\"Low\\\", 3, Severity == \\\"Medium\\\", 7, Severity == \\\"High\\\", 9, Severity == \\\"Critical\\\", 10, 0)\\r\\n| sort by SeverityNumber\",\"size\":4,\"title\":\"Events by Severity\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"Sev3\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"Sev2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"Sev1\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Critical\",\"representation\":\"Sev0\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"Sev4\",\"text\":\"{0}{1}\"}]}},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":1},\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Severity\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"name\":\"query - 3\"},{\"type\":1,\"content\":{\"json\":\"Select the filters below to display relevant events\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 3\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"63aff516-725f-4c6c-bb0a-b2bb484176d1\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Severity\",\"type\":2,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityBridgeLogs\\r\\n| extend Severity = tostring(Severity)\\r\\n| distinct Severity\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"afb7a9f8-5e29-411e-8d9e-99f4bc855b0b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"User\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityBridgeLogs\\r\\n| where Severity in ({Severity})\\r\\n| distinct duser\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"57735ba8-7c80-477c-899c-b0507bacb946\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SAPSID\",\"label\":\"SAP SID\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityBridgeLogs\\r\\n| where Severity in ({Severity})\\r\\n| distinct SAPsid\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"b6d548e0-6685-4bac-9419-25d74a4972d7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Terminal\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityBridgeLogs\\r\\n| where Severity in ({Severity})\\r\\n| distinct shost\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"60ff9487-e9a9-4c08-9207-8d7c8b186f91\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Listener\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityBridgeLogs\\r\\n| where Severity in ({Severity})\\r\\n| distinct DeviceEventClassID\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"1521e9a7-53ea-4737-8e8e-819599655b13\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Action\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityBridgeLogs\\r\\n| where Severity in ({Severity})\\r\\n| distinct Name\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityBridgeLogs\\r\\n| where Severity in ({Severity})\\r\\n| where duser in ({User}) or \\\"*\\\" in ({User})\\r\\n| where SAPsid in ({SAPSID}) or \\\"*\\\" in ({SAPSID})\\r\\n| where shost in ({Terminal}) or \\\"*\\\" in ({Terminal})\\r\\n| where DeviceEventClassID in ({Listener}) or \\\"*\\\" in ({Listener})\\r\\n| where Name in ({Action}) or \\\"*\\\" in ({Action})\\r\\n| project TimeGenerated, Severity, DeviceEventClassID, Name, msg, [\\\"Link to Event\\\"]= strcat(({urlprefix}), externalid), shost, duser, SAPsid, SAPclient\\r\\n| sort by TimeGenerated\",\"size\":0,\"title\":\"Event by Selected Filters\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Link to Event\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Link to the Event\"}}],\"sortBy\":[{\"itemKey\":\"shost\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"shost\",\"sortOrder\":2}]},\"name\":\"query - 1\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"analyze\"},\"name\":\"group - 23\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"This tab helps in analyzing events.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 10\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a0a31cee-67ce-43c1-b0e5-a4f744edf81e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SAPSID\",\"label\":\"SAP SID\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityBridgeLogs\\r\\n| distinct SAPsid\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 0\"},{\"type\":1,\"content\":{\"json\":\"This bar chart shows the events by event name.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityBridgeLogs\\r\\n| where SAPsid in ({SAPSID}) or \\\"*\\\" in ({SAPSID})\\r\\n| summarize count() by Name\",\"size\":0,\"title\":\"Events by Event Name\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"name\":\"query - 1\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"This barchart shows the events ingestion with respect to time\",\"style\":\"info\"},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityBridgeLogs\\r\\n| where SAPsid in ({SAPSID}) or \\\"*\\\" in ({SAPSID})\\r\\n| summarize [\\\"Number of Events\\\"] = count() by bin(todatetime(rt), 1d)\",\"size\":1,\"title\":\"Events Ingestion by Time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"showLegend\":true}},\"customWidth\":\"100\",\"name\":\"query - 1 - Copy - Copy\"}]},\"customWidth\":\"50\",\"name\":\"group - 13\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"This barchart shows the events ingestion with respect to severity and time\",\"style\":\"info\"},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityBridgeLogs\\r\\n| where SAPsid in ({SAPSID}) or \\\"*\\\" in ({SAPSID})\\r\\n| summarize count() by bin(todatetime(rt), 1h), Severity\",\"size\":1,\"title\":\"Events by Time with respect to Severity\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true,\"seriesLabelSettings\":[{\"seriesName\":\"Medium\",\"color\":\"yellow\"},{\"seriesName\":\"High\",\"color\":\"redBright\"},{\"seriesName\":\"Critical\",\"color\":\"red\"},{\"seriesName\":\"Low\",\"color\":\"blueDark\"}]}},\"customWidth\":\"100\",\"name\":\"query - 1 - Copy\"}]},\"customWidth\":\"50\",\"name\":\"group - 13 - Copy\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"This barchart shows the events ingestion with respect to SAPsid\",\"style\":\"info\"},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityBridgeLogs\\r\\n| where SAPsid in ({SAPSID}) or \\\"*\\\" in ({SAPSID})\\r\\n| summarize count() by SAPsid\",\"size\":1,\"title\":\"Events Ingestion by Time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"showLegend\":true}},\"customWidth\":\"100\",\"name\":\"query - 1 - Copy - Copy\"}]},\"customWidth\":\"50\",\"name\":\"group - 13 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityBridgeLogs\\r\\n| where SAPsid in ({SAPSID}) or \\\"*\\\" in ({SAPSID})\\r\\n| summarize count() by Severity\",\"size\":0,\"title\":\"Events by Severity\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"customWidth\":\"30\",\"name\":\"query - 1 - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityBridgeLogs\\r\\n| where SAPsid in ({SAPSID}) or \\\"*\\\" in ({SAPSID})\\r\\n| summarize count() by duser\\r\\n| sort by count_\\r\\n| take 5\",\"size\":0,\"title\":\"Top 5 Users\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"customWidth\":\"30\",\"name\":\"query - 1 - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityBridgeLogs\\r\\n| where SAPsid in ({SAPSID}) or \\\"*\\\" in ({SAPSID})\\r\\n| summarize count() by dhost\\r\\n| sort by count_\\r\\n| take 5\",\"size\":0,\"title\":\"Top 5 Workstations\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"customWidth\":\"30\",\"name\":\"query - 1 - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityBridgeLogs\\r\\n| where SAPsid in ({SAPSID}) or \\\"*\\\" in ({SAPSID})\\r\\n| summarize count() by duser\\r\\n| join (\\r\\nSecurityBridgeLogs\\r\\n| where SAPsid in ({SAPSID}) or \\\"*\\\" in ({SAPSID})\\r\\n| extend user = duser\\r\\n| make-series TrendList = count() on todatetime(rt) in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by duser ) on duser\\r\\n| project duser, [\\\"Total events\\\"] = count_, TrendLine = TrendList\\r\\n| top 10 by [\\\"Total events\\\"] desc\",\"size\":0,\"title\":\"Event Stats by Users\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TrendLine\",\"formatter\":9,\"formatOptions\":{\"palette\":\"green\"}}]},\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"customWidth\":\"50\",\"name\":\"query - 1 - Copy - Copy - Copy - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityBridgeLogs\\r\\n| where SAPsid in ({SAPSID}) or \\\"*\\\" in ({SAPSID})\\r\\n| summarize count() by dhost\\r\\n| join (\\r\\nSecurityBridgeLogs\\r\\n| where SAPsid in ({SAPSID}) or \\\"*\\\" in ({SAPSID})\\r\\n| extend user = dhost\\r\\n| make-series TrendList = count() on todatetime(rt) in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by dhost ) on dhost\\r\\n| project dhost, [\\\"Total events\\\"] = count_, TrendLine = TrendList\\r\\n| top 10 by [\\\"Total events\\\"] desc\",\"size\":0,\"title\":\"Event Stats by Host\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TrendLine\",\"formatter\":9,\"formatOptions\":{\"palette\":\"green\"}}]},\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"customWidth\":\"50\",\"name\":\"query - 1 - Copy - Copy - Copy - Copy - Copy - Copy - Copy\"}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"monitor\"},\"name\":\"group - 24\"}],\"fromTemplateId\":\"sentinel-SecurityBridge\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=SecurityBridgeWorkbook; logoFileName=SecurityBridgeLogo-Vector-TM_75x75.svg; description=Sets the time name for analysis; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=SecurityBridge App; templateRelativePath=SecurityBridgeThreatDetectionforSAP.json; subtitle=; provider=SecurityBridge}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "SecurityBridge App",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "SecurityBridge",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "SecurityBridge",
                  "email": "support@securitybridge.com",
                  "link": "https://securitybridge.com/contact/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "SecurityBridgeLogs",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "CustomLogsAma",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CriticalEventTriggered_AnalyticalRules Analytics Rule with template version 3.2.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This rule alerts if there is any critical event occured in the SAP system",
                "displayName": "SecurityBridge: A critical event occured",
                "enabled": false,
                "query": "SecurityBridgeLogs\n| where Severity contains \"Critical\"\n",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "datatypes": [
                      "SecurityBridgeLogs_CL"
                    ],
                    "connectorId": "CustomLogsAma"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1189"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "maincontact"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "identifier": "HostName",
                        "columnName": "dhost"
                      }
                    ],
                    "entityType": "Host"
                  },
                  {
                    "fieldMappings": [
                      {
                        "identifier": "HostName",
                        "columnName": "dvchost"
                      }
                    ],
                    "entityType": "Host"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
              "properties": {
                "description": "SecurityBridge App Analytics Rule 1",
                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "SecurityBridge App",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "SecurityBridge",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "SecurityBridge",
                  "email": "support@securitybridge.com",
                  "link": "https://securitybridge.com/contact/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
        "contentKind": "AnalyticsRule",
        "displayName": "SecurityBridge: A critical event occured",
        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "displayName": "SecurityBridge Solution for SAP",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "apiVersion": "2022-09-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "SecurityBridge",
                  "title": "SecurityBridge Solution for SAP",
                  "publisher": "SecurityBridge Group GmbH",
                  "logo": "SecurityBridge.svg",
                  "descriptionMarkdown": "SecurityBridge enhances SAP security by integrating seamlessly with Microsoft Sentinel, enabling real-time monitoring and threat detection across SAP environments. This integration allows Security Operations Centers (SOCs) to consolidate SAP security events with other organizational data, providing a unified view of the threat landscape . Leveraging AI-powered analytics and Microsoft’s Security Copilot, SecurityBridge identifies sophisticated attack patterns and vulnerabilities within SAP applications, including ABAP code scanning and configuration assessments . The solution supports scalable deployments across complex SAP landscapes, whether on-premises, in the cloud, or hybrid environments . By bridging the gap between IT and SAP security teams, SecurityBridge empowers organizations to proactively detect, investigate, and respond to threats, enhancing overall security posture.",
                  "graphQueriesTableName": "ABAPAuditLog",
                  "graphQueries": [
                    {
                      "metricName": "Total events received",
                      "legend": "SAP_SID",
                      "baseQuery": "{{graphQueriesTableName}} | project TimeGenerated, SAP_SID= SystemUniqueId"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Get Sample Events",
                      "query": "{{graphQueriesTableName}}\n | take 10"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "{{graphQueriesTableName}}",
                      "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "HasDataConnectors"
                    }
                  ],
                  "availability": {
                    "isPreview": true
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rules. Typically requires Azure RBAC Owner or User Access Administrator role."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "We will create data collection rule (DCR) and data collection endpoint (DCE) resources. We will also create a Microsoft Entra app registration and assign the required permissions to it.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated deployment of Azure resources\nClicking on \"Deploy push connector resources\" will trigger the creation of DCR and DCE resources.\nIt will then create a Microsoft Entra app registration with client secret and grant permissions on the DCR. This setup enables data to be sent securely to the DCR using a OAuth v2 client credentials."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy push connector resources",
                            "applicationDisplayName": "SecurityBridge Solution for SAP"
                          },
                          "type": "DeployPushConnectorButton_test"
                        }
                      ]
                    },
                    {
                      "title": "2. Maintain the data collection endpoint details and authentication info in SecurityBridge",
                      "description": "Share the data collection endpoint URL and authentication info with the SecurityBridge administrator to configure the Securitybridge to send data to the data collection endpoint.\n\nLearn more from our KB Page https://abap-experts.atlassian.net/wiki/spaces/SB/pages/4099309579/REST+Push+Interface",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Use this value to configure as Tenant ID in the LogIngestionAPI credential.",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra Application Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the Application Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Use this value to configure the LogsIngestionURL parameter when deploying the IFlow.",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the DCE URI"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "DCR Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the DCR ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Sentinel for SAP Stream ID",
                            "value": "SAP_ABAPAUDITLOG"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "SecurityBridge_CL Stream ID",
                            "value": "Custom-SecurityBridge_CL"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "SecurityBridge",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "SecurityBridge",
                  "email": "support@securitybridge.com",
                  "link": "https://securitybridge.com/contact/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "SecurityBridge-DCR",
              "apiVersion": "2022-06-01",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]",
                "streamDeclarations": {
                  "Custom-SecurityBridge_CL": {
                    "columns": [
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "BusinessEvent",
                        "type": "string"
                      },
                      {
                        "name": "action",
                        "type": "string"
                      },
                      {
                        "name": "attribute1",
                        "type": "string"
                      },
                      {
                        "name": "attribute2",
                        "type": "string"
                      },
                      {
                        "name": "attribute3",
                        "type": "string"
                      },
                      {
                        "name": "attribute4",
                        "type": "string"
                      },
                      {
                        "name": "attribute5",
                        "type": "string"
                      },
                      {
                        "name": "client",
                        "type": "string"
                      },
                      {
                        "name": "EventdateISO8601",
                        "type": "datetime"
                      },
                      {
                        "name": "Eventdatetimestamp",
                        "type": "string"
                      },
                      {
                        "name": "Eventtime",
                        "type": "string"
                      },
                      {
                        "name": "Eventdate",
                        "type": "string"
                      },
                      {
                        "name": "RecdateISO8601",
                        "type": "datetime"
                      },
                      {
                        "name": "message",
                        "type": "string"
                      },
                      {
                        "name": "Listener",
                        "type": "string"
                      },
                      {
                        "name": "Program",
                        "type": "string"
                      },
                      {
                        "name": "severity",
                        "type": "string"
                      },
                      {
                        "name": "DataSource",
                        "type": "string"
                      },
                      {
                        "name": "RawDatastructure",
                        "type": "string"
                      },
                      {
                        "name": "Agent",
                        "type": "string"
                      },
                      {
                        "name": "triggeringTA",
                        "type": "string"
                      },
                      {
                        "name": "triggeringTerminal",
                        "type": "string"
                      },
                      {
                        "name": "Terminal",
                        "type": "string"
                      },
                      {
                        "name": "User",
                        "type": "string"
                      },
                      {
                        "name": "UserGroup",
                        "type": "string"
                      },
                      {
                        "name": "UserType",
                        "type": "string"
                      },
                      {
                        "name": "User_Full",
                        "type": "string"
                      },
                      {
                        "name": "UPN",
                        "type": "string"
                      },
                      {
                        "name": "IP",
                        "type": "string"
                      },
                      {
                        "name": "FQDN",
                        "type": "string"
                      },
                      {
                        "name": "AppServerName",
                        "type": "string"
                      },
                      {
                        "name": "PGUID",
                        "type": "string"
                      },
                      {
                        "name": "ReferenceUser",
                        "type": "string"
                      },
                      {
                        "name": "StagingLevel",
                        "type": "string"
                      },
                      {
                        "name": "BContact_Mail",
                        "type": "string"
                      },
                      {
                        "name": "BContact_name",
                        "type": "string"
                      },
                      {
                        "name": "PContact_Mail",
                        "type": "string"
                      },
                      {
                        "name": "PContact_name",
                        "type": "string"
                      },
                      {
                        "name": "guid",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Microsoft-ABAPAuditLog"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source\n",
                    "outputStream": "Microsoft-ABAPAuditLog"
                  },
                  {
                    "streams": [
                      "Custom-SecurityBridge_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source\n| extend TimeGenerated = now()\n| project\n    TimeGenerated,\n    BusinessEvent,\n    action,\n    attribute1,\n    attribute2,\n    attribute3,\n    attribute4,\n    attribute5,\n    client,\n    EventdateISO8601,\n    Eventdatetimestamp,\n    Eventtime,\n    Eventdate,\n    RecdateISO8601,\n    message,\n    Listener,\n    Program,\n    severity,\n    DataSource,\n    RawDatastructure,\n    Agent,\n    triggeringTA,\n    triggeringTerminal,\n    Terminal,\n    User,\n    UserGroup,\n    UserType,\n    User_Full,\n    UPN,\n    IP,\n    FQDN,\n    AppServerName,\n    PGUID,\n    ReferenceUser,\n    StagingLevel,\n    BContact_Mail,\n    BContact_name,\n    PContact_Mail,\n    PContact_name,\n    guid",
                    "outputStream": "Custom-SecurityBridge_CL"
                  }
                ]
              }
            },
            {
              "name": "SecurityBridge_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "schema": {
                  "name": "SecurityBridge_CL",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    },
                    {
                      "name": "BusinessEvent",
                      "type": "string"
                    },
                    {
                      "name": "action",
                      "type": "string"
                    },
                    {
                      "name": "attribute1",
                      "type": "string"
                    },
                    {
                      "name": "attribute2",
                      "type": "string"
                    },
                    {
                      "name": "attribute3",
                      "type": "string"
                    },
                    {
                      "name": "attribute4",
                      "type": "string"
                    },
                    {
                      "name": "attribute5",
                      "type": "string"
                    },
                    {
                      "name": "client",
                      "type": "string"
                    },
                    {
                      "name": "EventdateISO8601",
                      "type": "datetime"
                    },
                    {
                      "name": "Eventdatetimestamp",
                      "type": "string"
                    },
                    {
                      "name": "Eventtime",
                      "type": "string"
                    },
                    {
                      "name": "Eventdate",
                      "type": "string"
                    },
                    {
                      "name": "RecdateISO8601",
                      "type": "datetime"
                    },
                    {
                      "name": "message",
                      "type": "string"
                    },
                    {
                      "name": "Listener",
                      "type": "string"
                    },
                    {
                      "name": "Program",
                      "type": "string"
                    },
                    {
                      "name": "severity",
                      "type": "string"
                    },
                    {
                      "name": "DataSource",
                      "type": "string"
                    },
                    {
                      "name": "RawDatastructure",
                      "type": "string"
                    },
                    {
                      "name": "Agent",
                      "type": "string"
                    },
                    {
                      "name": "triggeringTA",
                      "type": "string"
                    },
                    {
                      "name": "triggeringTerminal",
                      "type": "string"
                    },
                    {
                      "name": "Terminal",
                      "type": "string"
                    },
                    {
                      "name": "User",
                      "type": "string"
                    },
                    {
                      "name": "UserGroup",
                      "type": "string"
                    },
                    {
                      "name": "UserType",
                      "type": "string"
                    },
                    {
                      "name": "User_Full",
                      "type": "string"
                    },
                    {
                      "name": "UPN",
                      "type": "string"
                    },
                    {
                      "name": "IP",
                      "type": "string"
                    },
                    {
                      "name": "FQDN",
                      "type": "string"
                    },
                    {
                      "name": "AppServerName",
                      "type": "string"
                    },
                    {
                      "name": "PGUID",
                      "type": "string"
                    },
                    {
                      "name": "ReferenceUser",
                      "type": "string"
                    },
                    {
                      "name": "StagingLevel",
                      "type": "string"
                    },
                    {
                      "name": "BContact_Mail",
                      "type": "string"
                    },
                    {
                      "name": "BContact_name",
                      "type": "string"
                    },
                    {
                      "name": "PContact_Mail",
                      "type": "string"
                    },
                    {
                      "name": "PContact_name",
                      "type": "string"
                    },
                    {
                      "name": "guid",
                      "type": "string"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
      "apiVersion": "2022-09-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "SecurityBridge",
          "title": "SecurityBridge Solution for SAP",
          "publisher": "SecurityBridge Group GmbH",
          "logo": "SecurityBridge.svg",
          "descriptionMarkdown": "SecurityBridge enhances SAP security by integrating seamlessly with Microsoft Sentinel, enabling real-time monitoring and threat detection across SAP environments. This integration allows Security Operations Centers (SOCs) to consolidate SAP security events with other organizational data, providing a unified view of the threat landscape . Leveraging AI-powered analytics and Microsoft’s Security Copilot, SecurityBridge identifies sophisticated attack patterns and vulnerabilities within SAP applications, including ABAP code scanning and configuration assessments . The solution supports scalable deployments across complex SAP landscapes, whether on-premises, in the cloud, or hybrid environments . By bridging the gap between IT and SAP security teams, SecurityBridge empowers organizations to proactively detect, investigate, and respond to threats, enhancing overall security posture.",
          "graphQueriesTableName": "ABAPAuditLog",
          "graphQueries": [
            {
              "metricName": "Total events received",
              "legend": "SAP_SID",
              "baseQuery": "{{graphQueriesTableName}} | project TimeGenerated, SAP_SID= SystemUniqueId"
            }
          ],
          "sampleQueries": [
            {
              "description": "Get Sample Events",
              "query": "{{graphQueriesTableName}}\n | take 10"
            }
          ],
          "dataTypes": [
            {
              "name": "{{graphQueriesTableName}}",
              "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "HasDataConnectors"
            }
          ],
          "availability": {
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "Read and Write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rules. Typically requires Azure RBAC Owner or User Access Administrator role."
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "We will create data collection rule (DCR) and data collection endpoint (DCE) resources. We will also create a Microsoft Entra app registration and assign the required permissions to it.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated deployment of Azure resources\nClicking on \"Deploy push connector resources\" will trigger the creation of DCR and DCE resources.\nIt will then create a Microsoft Entra app registration with client secret and grant permissions on the DCR. This setup enables data to be sent securely to the DCR using a OAuth v2 client credentials."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy push connector resources",
                    "applicationDisplayName": "SecurityBridge Solution for SAP"
                  },
                  "type": "DeployPushConnectorButton_test"
                }
              ]
            },
            {
              "title": "2. Maintain the data collection endpoint details and authentication info in SecurityBridge",
              "description": "Share the data collection endpoint URL and authentication info with the SecurityBridge administrator to configure the Securitybridge to send data to the data collection endpoint.\n\nLearn more from our KB Page https://abap-experts.atlassian.net/wiki/spaces/SB/pages/4099309579/REST+Push+Interface",
              "instructions": [
                {
                  "parameters": {
                    "label": "Use this value to configure as Tenant ID in the LogIngestionAPI credential.",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra Application Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the Application Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Use this value to configure the LogsIngestionURL parameter when deploying the IFlow.",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the DCE URI"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "DCR Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the DCR ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Sentinel for SAP Stream ID",
                    "value": "SAP_ABAPAUDITLOG"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "SecurityBridge_CL Stream ID",
                    "value": "Custom-SecurityBridge_CL"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "SecurityBridge",
          "email": "[variables('_email')]"
        },
        "support": {
          "tier": "Partner",
          "name": "SecurityBridge",
          "email": "support@securitybridge.com",
          "link": "https://securitybridge.com/contact/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections1')]",
        "displayName": "SecurityBridge Solution for SAP",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "SecurityBridge Solution for SAP",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "SecurityBridge",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "SecurityBridge",
                  "email": "support@securitybridge.com",
                  "link": "https://securitybridge.com/contact/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'SecurityBridgePolling', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "SecurityBridge",
                "dcrConfig": {
                  "dataCollectionRuleId": "{{dataCollectionRuleId}}",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]",
                  "streamName": "Custom-SecurityBridge_CL"
                },
                "auth": {
                  "type": "Push",
                  "appId": "[[parameters('auth').appId]",
                  "servicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.2.1",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "SecurityBridge App",
        "publisherDisplayName": "SecurityBridge",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>• Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/SecurityBridge%20App/ReleaseNotes.md\">Release Notes</a></p>\n<p>• There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href=\"https://securitybridge.com/\">SecurityBridge App</a> solution provides the capability to ingest SecurityBridge Threat Detection events from all on-premise and cloud based SAP instances into Microsoft Sentinel.</p>\n<p>This solution is dependent on the Custom logs via AMA connector to collect the logs. The Custom logs solution will be installed as part of this solution installation.</p>\n<p><strong>NOTE</strong>: Microsoft recommends installation of Custom logs via AMA Connector. Legacy connector uses the Log Analytics agent which were deprecated on <strong>Aug 31, 2024.</strong> Using MMA and AMA on same machine can cause log duplication and extra ingestion cost <a href=\"https://learn.microsoft.com/azure/sentinel/ama-migrate?WT.mc_id=Portal-fx\">more details</a>.</p>\n<p><strong>Data Connectors:</strong> 1, <strong>Workbooks:</strong> 1, <strong>Analytic Rules:</strong> 1</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/SecurityBridgeLogo-Vector-TM_75x75.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "SecurityBridge App",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "SecurityBridge",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "SecurityBridge",
          "email": "support@securitybridge.com",
          "tier": "Partner",
          "link": "https://securitybridge.com/contact/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            }
          ]
        },
        "firstPublishDate": "2022-02-17",
        "providers": [
          "SecurityBridge"
        ],
        "categories": {
          "domains": [
            "Security - Network"
          ],
          "verticals": [
            "Finance"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
